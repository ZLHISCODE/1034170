--[连续升级]1
--[管理工具版本号]10.34.110
--本脚本支持从ZLHIS+ v10.34.120 升级到 v10.34.130
--请以系统所有者登录PLSQL并执行下列脚本
--脚本执行后，请手工升级导出报表
Define n_System=100;
-------------------------------------------------------------------------------
--结构修正部份
-------------------------------------------------------------------------------
--114577:刘鹏飞,2017-10-16,病人标记设置处理
Alter Table 病区标记内容 Add 是否特殊 number(1);

Alter table 病区标记记录 add 主题病区ID number(18);

Alter table 病区标记记录 add 标记顺序 number(1);

Alter table 病区标记内容 Drop Constraint 病区标记内容_PK Cascade Drop Index;

Alter Table 病区标记内容 Add Constraint 病区标记内容_UQ_病区ID Unique(病区ID, 主题序号, 标记序号) Using Index Tablespace zl9IndexCis;

Alter Table 病区标记内容 Modify 主题序号 Constraint 病区标记内容_NN_主题序号 Not Null;

Alter table 病区标记记录 Drop Constraint 病区标记记录_PK Cascade Drop Index;

Alter Table 病区标记记录 Add Constraint 病区标记记录_UQ_病区ID Unique(病区ID,病人ID,主页ID,主题病区ID,主题序号) Using Index Tablespace zl9IndexCis;

Alter Table 病区标记记录 Modify 病区ID Constraint 病区标记记录_NN_病区ID Not Null;

--101301:刘鹏飞,2017-09-22,输血申请记录添加字段
alter table 输血申请记录 add 输血类型 varchar2(100);
alter table 输血申请记录 add 输血目的 varchar2(100);

--101301:刘鹏飞,2017-09-22,增加字典表输血类型
Create Table 输血类型(
    编码 VARCHAR2(2),
    名称 VARCHAR2(20),
    简码 VARCHAR2(10),
    缺省标志 NUMBER(1) Default 0)
    TABLESPACE zl9BaseItem;

Alter Table 输血类型 Add Constraint 输血类型_PK Primary Key (编码) Using Index Tablespace zl9Indexhis;
Alter Table 输血类型 Add Constraint 输血类型_UQ_名称 Unique (名称) Using Index Tablespace zl9Indexhis;

--101301:刘鹏飞,2017-08-31,一次备血申请多个项目
Create table 输血申请项目
(
医嘱ID NUMBER(18),
诊疗项目ID number(18),
申请量 number(16,5),
申请血型 varchar2(10),
申请RH  varchar2(10),
待转出       NUMBER(3)
)tablespace ZL9CISREC;

Alter table 输血申请项目 add constraint 输血申请项目_PK primary key (医嘱ID,诊疗项目ID) using index tablespace ZL9INDEXCIS;
Alter table 输血申请项目 add constraint 输血申请项目_FK_医嘱ID foreign key (医嘱ID) references 病人医嘱记录(ID) on delete cascade;
Create index 输血申请项目_IX_待转出 on 输血申请项目 (待转出) tablespace ZL9INDEXCIS;
Alter table 输血申请项目 add constraint 输血申请项目_FK_诊疗项目ID foreign key (诊疗项目ID) references 诊疗项目目录(ID);
Create index 输血申请项目_IX_诊疗项目ID on 输血申请项目 (诊疗项目ID) tablespace ZL9INDEXCIS;


--101301:陈龙，2017-08-10,Zl_输血申请记录_Insert增加既往输血反应史和输血禁忌及过敏史
alter table 输血申请记录 add 既往输血反应史 number(2);
alter table 输血申请记录 add 输血禁忌及过敏史 number(2);


--107991:刘尔旋,2017-09-27,退卡时缺省退现处理
Alter Table 医疗卡类别 Add 是否缺省退现 Number(1);

--112243:秦龙,2017-09-26,药品规格增加字段“本位码”
Alter table 药品规格 add (本位码 varchar2(20)); 

--112953:梁唐彬,2017-09-11,药品说明书知识库
create table 药品说明书
(
  ID    VARCHAR2(100),
  通用名称  VARCHAR2(4000),
  商品名   VARCHAR2(4000),
  汉语拼音  VARCHAR2(4000),
  英文名称  VARCHAR2(4000),
  药物规格  VARCHAR2(4000),
  药物剂型  VARCHAR2(4000),
  主要成分  VARCHAR2(4000),
  生产企业  VARCHAR2(4000),
  批准文号  VARCHAR2(4000),
  化学名称  CLOB,
  性状    CLOB,
  药理毒理  CLOB,
  药代动力学 CLOB,
  适应症   CLOB,
  用法用量  CLOB,
  不良反应  CLOB,
  禁忌症   CLOB,
  注意事项  CLOB,
  孕妇用药  CLOB,
  儿童用药  CLOB,
  老年人用药 CLOB,
  相互作用  CLOB,
  药物过量  CLOB,
  贮藏条件  CLOB
)
tablespace ZL9BASEITEM;

alter table 药品说明书 add constraint 药品说明书_PK primary key (ID) using index tablespace zl9Indexhis;

--113742:秦龙,2017-09-19,增加字段“别名”
Alter table 部门表 add (别名 varchar2(100));

--113591:刘尔旋,2017-09-18,自动计算过程处理医疗小组
Create Or Replace View 在院病人自动记帐 As
Select p.病人id, p.主页id, Nvl(a.姓名, i.姓名) As 姓名, Nvl(a.性别, i.性别) As 性别, Nvl(a.年龄, i.年龄) As 年龄, i.住院号, a.费别, p.科室id, p.病区id,
       p.床号, p.附加床位, p.收费细目id, p.收入项目id, 1 As 标志, p.现价 As 标准单价, p.开始日期, p.终止日期, p.终止日期 - p.开始日期 As 天数, p.数量, p.经治医师,
       p.责任护士, p.操作员编号, p.操作员姓名, p.医疗小组id
From 病人信息 I, 病案主页 A,
     (Select b.病人id, b.主页id, b.科室id, b.病区id, b.床号, b.附加床位, p.收费细目id, p.收入项目id, p.现价, b.经治医师, b.责任护士, b.操作员编号, b.操作员姓名,
              Zl_Date_Half(Greatest(Least(Nvl(b.上次计算时间, b.开始时间), Nvl(b.终止时间, Greatest(Nvl(b.上次计算时间, b.开始时间))),
                                           Greatest(Nvl(b.上次计算时间, b.开始时间))), p.执行日期, Nvl(a.启用日期, Add_Months(Sysdate, -2)))) As 开始日期,
              Zl_Date_Half(Least(Nvl(b.终止时间, Greatest(b.开始时间, Sysdate)), Nvl(p.终止日期, Sysdate + 30) + 1)) As 终止日期, b.数量,
              b.医疗小组id
       From 自动计价项目 A,
            (Select a.病人id, a.主页id, a.开始时间, a.附加床位, a.病区id, a.科室id, a.床号, a.床位等级id, 1 As 数量, a.责任护士, a.经治医师, a.终止时间,
                     a.操作员编号, a.操作员姓名, a.上次计算时间, a.医疗小组id
              From 病人变动记录 A, 病人信息 B
              Where a.开始原因 <> 10 And a.病人id = b.病人id And a.主页id = b.主页id And b.在院 = 1
              Union All
              Select b.病人id, b.主页id, 开始时间, 附加床位, b.病区id, b.科室id, 床号, i.从项id As 床位等级id, i.从项数次 As 数量, 责任护士, 经治医师, 终止时间, 操作员编号,
                     操作员姓名, 上次计算时间, b.医疗小组id
              From 病人变动记录 B, 收费从属项目 I, 病人信息 C
              Where b.病人id = c.病人id And b.主页id = c.主页id And c.在院 = 1 And b.床位等级id = i.主项id And b.开始原因 <> 10 And i.固有从属 > 0) B,
            收费价目 P
       Where a.病区id = b.病区id And Zl_Date_Half(Nvl(b.上次计算时间, b.开始时间)) <> Zl_Date_Half(Nvl(b.终止时间, Sysdate)) And p.现价 <> 0 And
             a.计算标志 = 1 And b.床位等级id = p.收费细目id And Zl_Date_Half(Nvl(b.终止时间, Sysdate)) >= Zl_Date_Half(p.执行日期) And
             Zl_Date_Half(b.开始时间) <= Zl_Date_Half(Nvl(p.终止日期, Sysdate) + 1) And
             Zl_Date_Half(Least(Nvl(b.终止时间, Sysdate), Nvl(p.终止日期, Sysdate + 30) + 1)) >=
             Zl_Date_Half(Nvl(a.启用日期, Add_Months(Sysdate, -2)))
       Union All
       Select b.病人id, b.主页id, b.科室id, b.病区id, b.床号, b.附加床位, p.收费细目id, p.收入项目id, p.现价, b.经治医师, b.责任护士, b.操作员编号, b.操作员姓名,
              Zl_Date_Half(Greatest(Least(Nvl(b.上次计算时间, b.开始时间), Nvl(b.终止时间, Greatest(Nvl(b.上次计算时间, b.开始时间))),
                                           Greatest(Nvl(b.上次计算时间, b.开始时间))), p.执行日期, Nvl(a.启用日期, Add_Months(Sysdate, -2)))) As 开始日期,
              Zl_Date_Half(Least(Nvl(b.终止时间, Greatest(b.开始时间, Sysdate)), Nvl(p.终止日期, Sysdate + 30) + 1)) As 终止日期, b.数量,
              b.医疗小组id
       From 自动计价项目 A,
            (Select a.病人id, a.主页id, 开始时间, 附加床位, a.病区id, a.科室id, 床号, 护理等级id, 1 As 数量, 责任护士, 经治医师, 终止时间, 操作员编号, 操作员姓名, 上次计算时间,
                     a.医疗小组id
              From 病人变动记录 A, 病人信息 B
              Where 开始原因 <> 10 And a.病人id = b.病人id And a.主页id = b.主页id And b.在院 = 1
              Union All
              Select b.病人id, b.主页id, 开始时间, 附加床位, b.病区id, b.科室id, 床号, i.从项id As 护理等级id, i.从项数次 As 数量, 责任护士, 经治医师, 终止时间, 操作员编号,
                     操作员姓名, 上次计算时间, b.医疗小组id
              From 病人变动记录 B, 收费从属项目 I, 病人信息 C
              Where b.护理等级id = i.主项id And b.病人id = c.病人id And b.主页id = c.主页id And c.在院 = 1 And b.开始原因 <> 10 And i.固有从属 > 0) B,
            收费价目 P, 收费项目目录 C
       Where a.病区id = b.病区id And b.附加床位 <> 1 And
             Zl_Date_Half(Nvl(b.上次计算时间, b.开始时间)) <> Zl_Date_Half(Nvl(b.终止时间, Sysdate)) And p.现价 <> 0 And a.计算标志 = 2 And
             b.护理等级id = p.收费细目id And b.护理等级id = c.Id And Nvl(c.计算方式, 0) <> 1 And
             Zl_Date_Half(Nvl(b.终止时间, Sysdate)) >= Zl_Date_Half(p.执行日期) And
             Zl_Date_Half(b.开始时间) <= Zl_Date_Half(Nvl(p.终止日期, Sysdate) + 1) And
             Zl_Date_Half(Least(Nvl(b.终止时间, Sysdate), Nvl(p.终止日期, Sysdate + 30) + 1)) >=
             Zl_Date_Half(Nvl(a.启用日期, Add_Months(Sysdate, -2)))
       Union All
       Select b.病人id, b.主页id, b.科室id, b.病区id, b.床号, b.附加床位, p.收费细目id, p.收入项目id, p.现价, b.经治医师, b.责任护士, b.操作员编号, b.操作员姓名,
              Zl_Date_Half(Greatest(Least(Nvl(b.上次计算时间, b.开始时间), Nvl(b.终止时间, Greatest(Nvl(b.上次计算时间, b.开始时间))),
                                           Greatest(Nvl(b.上次计算时间, b.开始时间))), p.执行日期, Nvl(a.启用日期, Add_Months(Sysdate, -2)))) As 开始日期,
              Zl_Date_Half(Least(Nvl(b.终止时间, Greatest(b.开始时间, Sysdate)), Nvl(p.终止日期, Sysdate + 30) + 1)) As 终止日期, a.数量,
              b.医疗小组id
       From (Select 病区id, 计算标志, 收费细目id, 1 As 数量, 启用日期
              From 自动计价项目
              Union All
              Select 病区id, 计算标志, 从项id, i.从项数次 As 数量, 启用日期
              From 自动计价项目 A, 收费从属项目 I
              Where a.收费细目id = i.主项id And i.固有从属 > 0) A, 病人变动记录 B, 收费价目 P, 病人信息 C
       Where a.病区id = b.病区id And b.病人id = c.病人id And b.主页id = c.主页id And c.在院 = 1 And b.附加床位 <> 1 And b.开始原因 <> 10 And
             Zl_Date_Half(Nvl(b.上次计算时间, b.开始时间)) <> Zl_Date_Half(Nvl(b.终止时间, Sysdate)) And p.现价 <> 0 And
             a.收费细目id = p.收费细目id And (a.计算标志 = 6 And b.床位等级id Is Not Null Or a.计算标志 = 7) And
             Zl_Date_Half(Nvl(b.终止时间, Sysdate)) >= Zl_Date_Half(p.执行日期) And
             Zl_Date_Half(b.开始时间) <= Zl_Date_Half(Nvl(p.终止日期, Sysdate) + 1) And
             Zl_Date_Half(Least(Nvl(b.终止时间, Sysdate), Nvl(p.终止日期, Sysdate + 30) + 1)) >=
             Zl_Date_Half(Nvl(a.启用日期, Add_Months(Sysdate, -2)))) P
Where i.病人id = p.病人id And a.病人id = p.病人id And a.主页id = p.主页id;


Create Or Replace View 出院病人自动记帐 As
Select p.病人id, p.主页id, Nvl(a.姓名, i.姓名) As 姓名, Nvl(a.性别, i.性别) As 性别, Nvl(a.年龄, i.年龄) As 年龄, i.住院号, a.费别, p.科室id, p.病区id,
       p.床号, p.附加床位, p.收费细目id, p.收入项目id, 1 As 标志, p.现价 As 标准单价, p.开始日期, p.终止日期, p.终止日期 - p.开始日期 As 天数, p.数量, p.经治医师,
       p.责任护士, p.操作员编号, p.操作员姓名, p.医疗小组id
From 病人信息 I, 病案主页 A,
     (Select b.病人id, b.主页id, b.科室id, b.病区id, b.床号, b.附加床位, p.收费细目id, p.收入项目id, p.现价, b.经治医师, b.责任护士, b.操作员编号, b.操作员姓名,
              Zl_Date_Half(Greatest(Least(Nvl(b.上次计算时间, b.开始时间), Nvl(b.终止时间, Greatest(Nvl(b.上次计算时间, b.开始时间))),
                                           Greatest(Nvl(b.上次计算时间, b.开始时间))), p.执行日期, Nvl(a.启用日期, Add_Months(Sysdate, -2)))) As 开始日期,
              Zl_Date_Half(Least(Nvl(b.终止时间, Greatest(b.开始时间, Sysdate)), Nvl(p.终止日期, Sysdate + 30) + 1)) As 终止日期, b.数量,
              b.医疗小组id
       From 自动计价项目 A,
            (Select 病人id, 主页id, 开始时间, 附加床位, 病区id, 科室id, 床号, 床位等级id, 1 As 数量, 责任护士, 经治医师, 终止时间, 操作员编号, 操作员姓名, 上次计算时间,
                     a.医疗小组id
              From 病人变动记录 A
              Where 开始原因 <> 10
              Union All
              Select 病人id, 主页id, 开始时间, 附加床位, 病区id, 科室id, 床号, i.从项id As 床位等级id, i.从项数次 As 数量, 责任护士, 经治医师, 终止时间, 操作员编号, 操作员姓名,
                     上次计算时间, b.医疗小组id
              From 病人变动记录 B, 收费从属项目 I
              Where b.床位等级id = i.主项id And b.开始原因 <> 10 And i.固有从属 > 0) B, 收费价目 P
       Where a.病区id = b.病区id And Zl_Date_Half(Nvl(b.上次计算时间, b.开始时间)) <> Zl_Date_Half(Nvl(b.终止时间, Sysdate)) And p.现价 <> 0 And
             a.计算标志 = 1 And b.床位等级id = p.收费细目id And Zl_Date_Half(Nvl(b.终止时间, Sysdate)) >= Zl_Date_Half(p.执行日期) And
             Zl_Date_Half(b.开始时间) <= Zl_Date_Half(Nvl(p.终止日期, Sysdate) + 1) And
             Zl_Date_Half(Least(Nvl(b.终止时间, Sysdate), Nvl(p.终止日期, Sysdate + 30) + 1)) >=
             Zl_Date_Half(Nvl(a.启用日期, Add_Months(Sysdate, -2)))
       Union All
       Select b.病人id, b.主页id, b.科室id, b.病区id, b.床号, b.附加床位, p.收费细目id, p.收入项目id, p.现价, b.经治医师, b.责任护士, b.操作员编号, b.操作员姓名,
              Zl_Date_Half(Greatest(Least(Nvl(b.上次计算时间, b.开始时间), Nvl(b.终止时间, Greatest(Nvl(b.上次计算时间, b.开始时间))),
                                           Greatest(Nvl(b.上次计算时间, b.开始时间))), p.执行日期, Nvl(a.启用日期, Add_Months(Sysdate, -2)))) As 开始日期,
              Zl_Date_Half(Least(Nvl(b.终止时间, Greatest(b.开始时间, Sysdate)), Nvl(p.终止日期, Sysdate + 30) + 1)) As 终止日期, b.数量,
              b.医疗小组id
       From 自动计价项目 A,
            (Select 病人id, 主页id, 开始时间, 附加床位, 病区id, 科室id, 床号, 护理等级id, 1 As 数量, 责任护士, 经治医师, 终止时间, 操作员编号, 操作员姓名, 上次计算时间, 医疗小组id
              From 病人变动记录
              Where 开始原因 <> 10
              Union All
              Select 病人id, 主页id, 开始时间, 附加床位, 病区id, 科室id, 床号, i.从项id As 护理等级id, i.从项数次 As 数量, 责任护士, 经治医师, 终止时间, 操作员编号, 操作员姓名,
                     上次计算时间, b.医疗小组id
              From 病人变动记录 B, 收费从属项目 I
              Where b.护理等级id = i.主项id And b.开始原因 <> 10 And i.固有从属 > 0) B, 收费价目 P, 收费项目目录 C
       Where a.病区id = b.病区id And b.附加床位 <> 1 And
             Zl_Date_Half(Nvl(b.上次计算时间, b.开始时间)) <> Zl_Date_Half(Nvl(b.终止时间, Sysdate)) And p.现价 <> 0 And a.计算标志 = 2 And
             b.护理等级id = p.收费细目id And b.护理等级id = c.Id And Nvl(c.计算方式, 0) <> 1 And
             Zl_Date_Half(Nvl(b.终止时间, Sysdate)) >= Zl_Date_Half(p.执行日期) And
             Zl_Date_Half(b.开始时间) <= Zl_Date_Half(Nvl(p.终止日期, Sysdate) + 1) And
             Zl_Date_Half(Least(Nvl(b.终止时间, Sysdate), Nvl(p.终止日期, Sysdate + 30) + 1)) >=
             Zl_Date_Half(Nvl(a.启用日期, Add_Months(Sysdate, -2)))
       Union All
       Select b.病人id, b.主页id, b.科室id, b.病区id, b.床号, b.附加床位, p.收费细目id, p.收入项目id, p.现价, b.经治医师, b.责任护士, b.操作员编号, b.操作员姓名,
              Zl_Date_Half(Greatest(Least(Nvl(b.上次计算时间, b.开始时间), Nvl(b.终止时间, Greatest(Nvl(b.上次计算时间, b.开始时间))),
                                           Greatest(Nvl(b.上次计算时间, b.开始时间))), p.执行日期, Nvl(a.启用日期, Add_Months(Sysdate, -2)))) As 开始日期,
              Zl_Date_Half(Least(Nvl(b.终止时间, Greatest(b.开始时间, Sysdate)), Nvl(p.终止日期, Sysdate + 30) + 1)) As 终止日期, a.数量,
              b.医疗小组id
       From (Select 病区id, 计算标志, 收费细目id, 1 As 数量, 启用日期
              From 自动计价项目
              Union All
              Select 病区id, 计算标志, 从项id, i.从项数次 As 数量, 启用日期
              From 自动计价项目 A, 收费从属项目 I
              Where a.收费细目id = i.主项id And i.固有从属 > 0) A, 病人变动记录 B, 收费价目 P
       Where a.病区id = b.病区id And b.附加床位 <> 1 And b.开始原因 <> 10 And
             Zl_Date_Half(Nvl(b.上次计算时间, b.开始时间)) <> Zl_Date_Half(Nvl(b.终止时间, Sysdate)) And p.现价 <> 0 And
             a.收费细目id = p.收费细目id And (a.计算标志 = 6 And b.床位等级id Is Not Null Or a.计算标志 = 7) And
             Zl_Date_Half(Nvl(b.终止时间, Sysdate)) >= Zl_Date_Half(p.执行日期) And
             Zl_Date_Half(b.开始时间) <= Zl_Date_Half(Nvl(p.终止日期, Sysdate) + 1) And
             Zl_Date_Half(Least(Nvl(b.终止时间, Sysdate), Nvl(p.终止日期, Sysdate + 30) + 1)) >=
             Zl_Date_Half(Nvl(a.启用日期, Add_Months(Sysdate, -2)))) P
Where i.病人id = p.病人id And a.病人id = p.病人id And a.主页id = p.主页id;

--00000:刘鹏飞,2017-09-07,唯一键名命不符合规范调整
alter table 护理项目模板 rename constraint 护理项目模板_UQ to 护理项目模板_UQ_科室ID;
alter index 护理项目模板_UQ rename to 护理项目模板_UQ_科室ID;
alter table 体温部位 rename constraint 体温部位_UQ to 体温部位_UQ_项目序号;
alter index 体温部位_UQ rename to 体温部位_UQ_项目序号;
alter table 产程部件 rename constraint 产程部件_UQ to 产程部件_UQ_部件;
alter index 产程部件_UQ rename to 产程部件_UQ_部件;

--00000:蔡青松,2017-09-07,脚本检查
Alter Table 检验合并规则 Add Constraint 检验合并规则_UQ_主项目ID Unique (主项目ID,合并项目ID) Using Index Pctfree 5 Tablespace zl9Indexhis;

--00000:蔡青松,2017-09-07,脚本检查
Alter Table 检验弃用报告 Add Constraint 检验弃用报告_UQ_结果ID Unique (结果ID, 报告时间) Using Index Pctfree 5 Tablespace zl9Indexhis;

--112382:黄捷,2017-08-18,增加RIS预约调整标记
alter table RIS检查预约 add 是否调整 NUMBER(1);

--110281:焦博,2017-08-18,人员收缴记录中的摘要从50个字符改完500个字符
alter table 人员收缴记录 modify (摘要 varchar2(500));


-------------------------------------------------------------------------------
--数据修正部份
-------------------------------------------------------------------------------
--000000:刘鹏飞,2017-10-23,脚本检查处理
Insert into zlTables(系统,表名,表空间,分类) Values(&n_System,'输血类型','ZL9BASEITEM','A1');
Insert into zlTables(系统,表名,表空间,分类) Values(&n_System,'输血申请项目','ZL9CISREC','B1');

--107991:刘兴洪,2017-10-23,退卡时缺省退现处理
UPDATE 医疗卡类别 SET 是否缺省退现 =1  WHERE  nvl(是否退现,0) =1  AND 是否缺省退现 IS NULL ;


--114577:刘鹏飞,2017-10-16,病人标记设置数据修正/数据小数据修正很快
Declare
  n_Count Number;
Begin
  Select Count(*) Into n_Count From Zlupgradeconfig Where 项目 = '病区标记数据更新' And 内容 = '完成';
  If n_Count = 0 Then
    Update 病区标记内容 Set 图形索引 = 图形索引 - 16 Where 图形索引 > 16;
    Update 病区标记记录 Set 主题病区id = 病区id, 标记顺序 = 主题序号;
    Insert Into Zlupgradeconfig (项目, 内容) Values ('病区标记数据更新', '完成');
  End If;
End;
/
--110450:殷瑞,2017-10-13,药品处方发药打印时指定对应的打印格式
Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 参数号, 参数名, 参数值, 缺省值, 参数说明)
  Select Zlparameters_Id.Nextval, &n_System, 1341, 0, 1, 1, 0, 68, '配药单打印格式', Null, Null, '指定配药单打印的格式'
  From Dual
  Where Not Exists (Select 1 From zlParameters Where 系统 = &n_System And 模块 = 1341 And 参数名 = '配药单打印格式');

Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 参数号, 参数名, 参数值, 缺省值, 参数说明)
  Select Zlparameters_Id.Nextval, &n_System, 1341, 0, 1, 1, 0, 69, '处方签打印格式', Null, Null, '指定处方签打印的格式'
  From Dual
  Where Not Exists (Select 1 From zlParameters Where 系统 = &n_System And 模块 = 1341 And 参数名 = '处方签打印格式');

--92026:蒋廷中,2017-10-13,自由录入的医嘱也可以登记执行情况
Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 参数号, 参数名, 参数值, 缺省值, 参数说明)
  Select Zlparameters_Id.Nextval, &n_System, -Null, -Null, -Null, -Null, -Null, 288, '叮嘱需要发送执行', Null, '0',
         '启用参数时：护士站对叮嘱进行校对时自动产生发送记录不产生费用，并支持执行；不启用参数则保持以前规则，0-不启用，1-启用。用于自由录入的医嘱也可以登记执行情况'
  From Dual
  Where Not Exists
   (Select 1 From zlParameters Where 参数号 = 288 And 模块 is Null And Nvl(系统, 0) = &n_System);

--101301:刘鹏飞,2017-10-11,历史数据表处理
Insert Into Zlbaktables
  (系统, 组号, 表名, 序号, 直接转出, 停用触发器)
  Select &n_System, 8, '输血申请项目', 16, 1, -Null From Dual;
--101301:刘鹏飞,2017-10-11,历史数据表处理
Insert Into Zlbaktableindex
  (系统, 表名, 索引名)
  Select &n_System, '输血申请项目', '输血申请项目_PK' From Dual;

--101301:刘鹏飞,2017-09-22,插入字典表数据
Insert Into 输血类型(编码,名称,简码) 
Select '01','急诊备血','JZBX' From Dual Union All
Select '02','择期备血','JQBX' From Dual Union All
Select '03','术中输血','SZSX' From Dual Union All
Select '04','治疗用血','ZLYX' From Dual Union All
Select '05','抢救用血','QJYX' From Dual Union All
Select '06','血浆置换','XJZH' From Dual Union All
Select '07','术前备血','SQBX' From Dual;

Insert Into zlBaseCode (系统,表名,固定,说明,分类) Values (100,'输血类型',0,'填写输血申请单时的申请输血类型','医疗工作');

--101301:刘鹏飞,2017-09-04,输血申请是否显示库存控制
Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 参数号, 参数名, 参数值, 缺省值, 参数说明)
  Select Zlparameters_Id.Nextval, &n_System, -Null, -Null, -Null, -Null, -Null, 286, '输血申请不显示血液库存', Null, '0',
         '启用血库息系统通过申请单下达输血申请时，决定待申请血液列表中是否显示血液库存信息:0-显示血液库存信息,1-不显示血液库存信息。'
  From Dual
  Where Not Exists
   (Select 1 From zlParameters Where 参数号 = 286 And 模块 is Null And Nvl(系统, 0) = &n_System);

--101301:陈龙,2017-08-16,备血完成消息提示医生站
insert into 业务消息类型(编码,名称,说明,保留天数) values ('ZLHIS_BLOOD_001','输血科备血完成提醒','输血科备血完成，提醒医生站',7);

--101301:刘鹏飞,2017-01-04,血库增加单独的电子签名设置
Update Zlparameters
Set 参数值 = Decode(Sign(Length(参数值) - 8), -1, 参数值 || '0', 参数值), 缺省值 = '00000000',
    参数说明 = '对不同场合是否使用电子签名进行控制,数字位数分别为:门诊,住院,医技,护理,药品,LIS,PACS,血库;0-不控制,1-控制'
Where 参数号 = 26 And 模块 Is Null And 系统 = &n_System;

--101301:刘鹏飞,2017-01-04,增加系统参数"用血医嘱发送后才能发血"
Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 参数号, 参数名, 参数值, 缺省值, 参数说明)
  Select Zlparameters_Id.Nextval, &n_System, -Null, -Null, -Null, -Null, -Null, 272, '用血医嘱发送后才能发血', Null, '1',
         '在医生下达用血医嘱后，决定输血科发血时机:0-用血医嘱新开后即可发血,1-用血医嘱发送后才能发血。'
  From Dual
  Where Not Exists
   (Select 1 From zlParameters Where 参数号 = 272 And 模块 is Null And Nvl(系统, 0) = &n_System);

--101301:刘鹏飞,2017-01-04,增加系统参数"输血采集方式默认诊疗检验类型"   
Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 参数号, 参数名, 参数值, 缺省值, 参数说明)
  Select Zlparameters_Id.Nextval, &n_System,  -Null, -Null, -Null, -Null, -Null, 273, '输血采集方式默认诊疗检验类型', Null, '血常规',
         '当号码控制表中检验条码生成规则不为0时，决定备血申请环节在检验医技工作站进行备血前血样采集时，能按照规则生成条码。'
  From Dual
  Where Not Exists
   (Select 1 From zlParameters Where 参数号 = 273 And 模块 is Null And Nvl(系统, 0) = &n_System);

--114826:廖思奇,2017-10-10,申请单存储设备单独保存为一个影像流程参数，并做参数初始化
--114826:廖思奇,2017-10-11,调整处理方式
Insert Into 影像流程参数
  (ID, 科室id, 参数名, 参数值)
  Select 影像流程参数_Id.Nextval, 科室id, '申请单存储设备号', 参数值 From 影像流程参数 Where 参数名 = '存储设备号';


--114583:冉俊明,2017-09-30,修正补结算前一次结算多张单据部分单据已全部退费时退费结帐ID未加入到费用补充记录问题
-- 说明：将补结算前一次结算多张单据部分单据已全部退费时退费结帐ID加入到费用补充记录，以便统计
Begin
  --1.根据费用补充记录找到所有相关的费用单据
  --2.再找出这些单据的结帐ID不在费用补充记录中的
  For c_单据 In (Select Distinct a.结帐id, a.记录性质, a.No
               From 门诊费用记录 A,
                    (Select Distinct a.记录性质, a.No, a.序号
                      From 门诊费用记录 A, 费用补充记录 B
                      Where a.结帐id = b.收费结帐id And b.记录状态 In (1, 3)) B
               Where a.记录性质 = b.记录性质 And a.No = b.No And a.序号 = b.序号 And Not Exists
                (Select 1 From 费用补充记录 Where 收费结帐id = a.结帐id) And Not Exists
                (Select 1
                      From 病人预交记录 M, 费用补充记录 N
                      Where m.结算序号 + 0 = n.结算序号 And m.结帐id = a.结帐id)) Loop
  
    Insert Into 费用补充记录
      (记录性质, NO, 记录状态, 实际票号, 结算id, 病人id, 收费结帐id, 费用状态, 操作员编号, 操作员姓名, 备注, 登记时间, 缴款组id, 结算序号, 附加标志, 待转出)
      Select b.记录性质, b.No, b.记录状态, b.实际票号, b.结算id, b.病人id, c_单据.结帐id, b.费用状态, b.操作员编号, b.操作员姓名, b.备注, b.登记时间, b.缴款组id,
             b.结算序号, b.附加标志, b.待转出
      From 费用补充记录 B,
           (Select 结帐id
             From 门诊费用记录
             Where 记录性质 = c_单据.记录性质 And NO = c_单据.No And 记录状态 In (1, 3) And Rownum < 2) A
      Where b.收费结帐id = a.结帐id;
  End Loop;
End;
/

--112953:梁唐彬,2017-09-11,药品说明书知识库
Insert into zlTables(系统,表名,表空间,分类) Values(100,'药品说明书','ZL9BASEITEM','A1');

--111016:刘鹏飞,2017-09-22,待入科新入院病人显示控制
Insert Into Zlparameters
  (Id, 系统, 模块, 私有, 本机, 授权, 固定, 参数号, 参数名, 参数值, 缺省值, 参数说明)
  Select Zlparameters_Id.Nextval, &n_System, 1265, 1, 0, 0, 0, 10, '入院天数', Null, Null,
         '决定待入科列表默认显示几天内新入院的病人：0-显示所有待入科病人;1-显示指定天数内的新入院待入科病人'
  From Dual
  Where Not Exists (Select 1 From Zlparameters Where 系统 = &n_System And 模块 = 1265 And 参数名 = '入院天数');

--92727:冉俊明,2017-08-31,收费、划价及门诊记帐模块是否允许录入特殊使用的抗生素
Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 参数号, 参数名, 参数值, 缺省值, 参数说明)
  Select Zlparameters_Id.Nextval, &n_System, 1120, 0, 0, 0, 0, 62, '允许录入特殊使用的抗生素', Null, '0',
         '在门诊划价时，是否允许录入特殊使用的抗生素：1-允许录入特殊使用的抗生素，0或NULL-不允许录入特殊使用的抗生素'
  From Dual
  Where Not Exists
   (Select 1 From zlParameters Where 系统 = &n_System And 模块 = 1120 And 参数名 = '允许录入特殊使用的抗生素');

Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 参数号, 参数名, 参数值, 缺省值, 参数说明)
  Select Zlparameters_Id.Nextval, &n_System, 1121, 0, 0, 0, 0, 110, '允许录入特殊使用的抗生素', Null, '0',
         '在门诊收费时，是否允许录入特殊使用的抗生素：1-允许录入特殊使用的抗生素，0或NULL-不允许录入特殊使用的抗生素'
  From Dual
  Where Not Exists
   (Select 1 From zlParameters Where 系统 = &n_System And 模块 = 1121 And 参数名 = '允许录入特殊使用的抗生素');

Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 参数号, 参数名, 参数值, 缺省值, 参数说明)
  Select Zlparameters_Id.Nextval, &n_System, 1122, 0, 0, 0, 0, 30, '允许录入特殊使用的抗生素', Null, '0',
         '在门诊记帐时，是否允许录入特殊使用的抗生素：1-允许录入特殊使用的抗生素，0或NULL-不允许录入特殊使用的抗生素'
  From Dual
  Where Not Exists
   (Select 1 From zlParameters Where 系统 = &n_System And 模块 = 1122 And 参数名 = '允许录入特殊使用的抗生素');

--112862:冉俊明,2017-08-21,支持门诊费用转住院预交票据多单据一次性打印
Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 参数号, 参数名, 参数值, 缺省值, 参数说明)
  Select Zlparameters_Id.Nextval, &n_System, -null, -null, -null, -null, -null, 283, '门诊费用转住院预交票据打印控制', Null, '0',
         '对于门诊费用转住院产生的预交单据,预交票据的打印方式:0-按生成的预交单据分别打印,1-产生的所有预交单据一次性打印'
  From Dual
  Where Not Exists (Select 1 From zlParameters Where 系统 = &n_System And 模块 Is Null And 参数号 = 283);

Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 参数号, 参数名, 参数值, 缺省值, 参数说明)
  Select Zlparameters_Id.Nextval, &n_System, -null, -null, -null, -null, -null, 284, '门诊费用转住院预交发票格式', Null, '0',
         '对于门诊费用转住院产生的预交单据,根据哪种发票格式打印预交票据'
  From Dual
  Where Not Exists (Select 1 From zlParameters Where 系统 = &n_System And 模块 Is Null And 参数号 = 284);

--101544:殷瑞,2017-08-17,新增参数:是否可以销帐拒绝
Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 参数号, 参数名, 参数值, 缺省值,参数说明)
  Select Zlparameters_Id.Nextval, &n_System, 1342, 0, 0, 0, 0, 29, '是否可以销帐拒绝', '1', '1', '0-不可销帐拒绝;1-可销帐拒绝'
  From Dual
  Where Not Exists (Select 1 From zlParameters Where 系统 = &n_System And 模块 = 1342 And 参数名 = '是否可以销帐拒绝');

--105718:李南春,2017-08-16,卡密密文起始和终止都为0表示不启用密文
Update 医疗卡类别 Set 卡号密文 = NULL Where 卡号密文 = '0-0';

--111840:曾杰,2017-08-09,门诊排队叫号的排序方式
Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 参数号, 参数名, 参数值, 缺省值,参数说明)
  Select Zlparameters_Id.Nextval, &n_System, 1160, 0, 0, 0, 0, 16, '使用数据原始顺序排序', '0', '0','排序方式，1-使用数据原始顺序排序，0-不使用数据原始顺序排序'
  From Dual
  Where Not Exists
   (Select 1 From zlParameters Where 系统 = &n_System And 模块 = 1160 And 参数名 = '使用数据原始顺序排序');

--107840:张德婷,2017-08-14,处方签先预览再打印
Insert Into zlParameters
  (ID, 系统, 模块, 私有, 本机, 授权, 固定, 参数号, 参数名, 参数值, 缺省值,参数说明)
  Select Zlparameters_Id.Nextval, &n_System, 1341, 0, 0, 0, 0, 65, '打印处方签时先预览再打印', '0', '0','0-不预览,1-打印处方签的时候预览之后在打印'
  From Dual
  Where not Exists
   (Select 1 From zlParameters Where 系统 = &n_System And 模块 = 1341 And 参数名 = '打印处方签时先预览再打印');
-------------------------------------------------------------------------------
--权限修正部份
-------------------------------------------------------------------------------
--114577:刘鹏飞,2017-10-16,病人标记设置处理
Insert Into zlProgPrivs(系统,序号,功能,所有者,对象,权限)
Select &n_System,1011,'基本',User,A.* From (
Select 对象,权限 From zlProgPrivs Where 1 = 0 Union All 
    Select '病区标记内容','SELECT' From Dual Union All 
    Select '病区标记记录','SELECT' From Dual Union All 
    Select 'Zl_病区标记内容_Update','EXECUTE' From Dual Union All
    Select 'Zl_病区标记内容_Insert','EXECUTE' From Dual Union All
    Select 'Zl_病区标记内容_Delete','EXECUTE' From Dual Union All
Select 对象,权限 From zlProgPrivs Where 1 = 0) A;

--113698:胡俊勇,2017-10-13,病人图标设置
Insert Into zlProgPrivs(系统,序号,功能,所有者,对象,权限)
Select &n_System,1261,'基本',User,A.* From (
Select 对象,权限 From zlProgPrivs Where 1 = 0 Union All
Select '病区标记内容','SELECT' From Dual Union All
Select '病区标记记录','SELECT' From Dual Union All
Select 'ZL_病区标记记录_UPDATE','EXECUTE' From Dual Union All 
Select 对象,权限 From zlProgPrivs Where 1 = 0) A;

--114429:李小东,2017-10-11,检验标本登记模块添加强制记帐权限
Insert Into zlProgFuncs(系统,序号,功能,排列,说明,缺省值)
Select &n_System,1212,A.* From (
Select 功能,排列,说明,缺省值 From zlProgFuncs Where 1 = 0 Union All 
    Select '强制记帐',5,'拥有该权限时，当剩余款不足时可强制记账',1 From Dual Union All 
Select 功能,排列,说明,缺省值 From zlProgFuncs Where 1 = 0) A;

--101301:刘鹏飞,2017-01-04,增加系统参数"输血采集方式默认诊疗检验类型"
Insert Into zlProgPrivs(系统,序号,功能,所有者,对象,权限)
Select &n_System,1011,'基本',User,A.* From (
Select 对象,权限 From zlProgPrivs Where 1 = 0 Union All 
Select '诊疗检验类型','SELECT' From Dual Union All 
Select 对象,权限 From zlProgPrivs Where 1 = 0) A;

--101301:刘鹏飞,2017-01-04,诊疗项目管理增加输血采集方式和采血管对照
Insert Into zlProgPrivs(系统,序号,功能,所有者,对象,权限)
Select &n_System,1054,'基本',User,A.* From (
Select 对象,权限 From zlProgPrivs Where 1 = 0 Union All 
Select '采血管类型','SELECT' From Dual Union All 
Select 对象,权限 From zlProgPrivs Where 1 = 0) A;

--101301:刘鹏飞,2017-03-01,权限增加
--1252:门诊医嘱下达(医嘱下达)
Insert Into zlProgPrivs(系统,序号,所有者,功能,对象,权限)
Select &n_System,1252,User,A.* From (
Select 功能,对象,权限 From zlProgPrivs Where 1 = 0 Union All 
Select '基本','输血申请项目','SELECT' From Dual Union All 
Select '基本','输血类型','SELECT' From Dual Union All
Select '医嘱下达','Zl_输血申请项目_Upate','EXECUTE' From Dual Union All
Select '医嘱下达','Zl_Fun_Bloodapplycode','EXECUTE' From Dual Union All
Select 功能,对象,权限 From zlProgPrivs Where 1 = 0) A;

--1253:住院医嘱下达(医嘱下达)
Insert Into zlProgPrivs(系统,序号,所有者,功能,对象,权限)
Select &n_System,1253,User,A.* From (
Select 功能,对象,权限 From zlProgPrivs Where 1 = 0 Union All 
Select '基本','输血申请项目','SELECT' From Dual Union All
Select '基本','输血类型','SELECT' From Dual Union All 
Select '医嘱下达','Zl_输血申请项目_Upate','EXECUTE' From Dual Union All
Select '医嘱下达','Zl_Fun_Bloodapplycode','EXECUTE' From Dual Union All
Select 功能,对象,权限 From zlProgPrivs Where 1 = 0) A;

--112241:冉俊明,2017-09-20,补充红票打印对象权限脚本
Insert Into zlProgPrivs
  (系统, 序号, 功能, 所有者, 对象, 权限)
  Select &n_System, 1121, '基本', User, 'Zl_门诊退费票据_Insert', 'EXECUTE'
  From Dual
  Where Not Exists (Select 1
         From zlProgPrivs
         Where 系统 = &n_System And 序号 = 1121 And 功能 = '基本' And Upper(对象) = Upper('Zl_门诊退费票据_Insert'));

Insert Into zlProgPrivs
  (系统, 序号, 功能, 所有者, 对象, 权限)
  Select &n_System, 1124, '基本', User, 'Zl_补充结算退费票据_Insert', 'EXECUTE'
  From Dual
  Where Not Exists (Select 1
         From zlProgPrivs
         Where 系统 = &n_System And 序号 = 1124 And 功能 = '基本' And Upper(对象) = Upper('Zl_补充结算退费票据_Insert'));

--110137:黄捷,2017-09-07,RIS调整和取消预约
Insert into zlTables(系统,表名,表空间,分类) Values(100,'RIS预约调整原因','ZL9BASEITEM','A2');

--113238:殷瑞,2017-08-24,补充药品处方发药的权限
Insert Into zlProgPrivs
  (系统, 序号, 功能, 所有者, 对象, 权限)
  Select &n_System, 1341, '基本', User, '输液配药内容', 'SELECT'
  From Dual
  Where Not Exists (Select 1
         From zlProgPrivs
         Where 系统 = &n_System And 序号 = 1341 And 功能 = '基本' And Upper(对象) = Upper('输液配药内容'));

--112913:冉俊明,2017-08-21,修正功能对象执行权限丢失
Insert Into zlProgPrivs
  (系统, 序号, 功能, 所有者, 对象, 权限)
  Select &n_System, 1124, '医保结算', User, 'Zl_补充结算票据_Insert', 'EXECUTE'
  From Dual
  Where Not Exists (Select 1
         From zlProgPrivs
         Where 系统 = &n_System And 序号 = 1124 And 功能 = '医保结算' And Upper(对象) = Upper('Zl_补充结算票据_Insert'));

Insert Into zlProgPrivs
  (系统, 序号, 功能, 所有者, 对象, 权限)
  Select &n_System, 1124, '医保结算', User, 'Zl_补充结算票据_Reprint', 'EXECUTE'
  From Dual
  Where Not Exists (Select 1
         From zlProgPrivs
         Where 系统 = &n_System And 序号 = 1124 And 功能 = '医保结算' And Upper(对象) = Upper('Zl_补充结算票据_Reprint'));

Insert Into zlProgPrivs
  (系统, 序号, 功能, 所有者, 对象, 权限)
  Select &n_System, 1124, '补打票据', User, 'Zl_补充结算票据_Reprint', 'EXECUTE'
  From Dual
  Where Not Exists (Select 1
         From zlProgPrivs
         Where 系统 = &n_System And 序号 = 1124 And 功能 = '补打票据' And Upper(对象) = Upper('Zl_补充结算票据_Reprint'));

Insert Into zlProgPrivs
  (系统, 序号, 功能, 所有者, 对象, 权限)
  Select &n_System, 1124, '重打票据', User, 'Zl_补充结算票据_Reprint', 'EXECUTE'
  From Dual
  Where Not Exists (Select 1
         From zlProgPrivs
         Where 系统 = &n_System And 序号 = 1124 And 功能 = '重打票据' And Upper(对象) = Upper('Zl_补充结算票据_Reprint'));

--100375:董露露,2017-08-10,解决住院医生站在下达医嘱时有“常用医嘱统计”权限时才能使用“常用医嘱统计”功能
Insert Into zlProgFuncs
  (系统, 序号, 功能, 排列, 说明, 缺省值)
  Select &n_System, 1253, '常用医嘱统计', 35, '是否可以使用住院医嘱下达时常用医嘱统计的功能。', 0
  From Dual
  Where Not Exists (Select 1 From zlProgFuncs Where 系统 = &n_System And 序号 = 1253 And 功能 = '常用医嘱统计');


-------------------------------------------------------------------------------
--报表修正部份
-------------------------------------------------------------------------------
--101301:刘鹏飞,2017-10-10,新增报表ZL1_INSIDE_1254_17_1/新输血申请单
Insert Into zlReports(ID,编号,名称,说明,密码,进纸,打印机,票据,系统,程序ID,功能,修改时间,发布时间,打印方式,禁止开始时间,禁止结束时间) Values(zlReports_ID.NextVal,'ZL1_INSIDE_1254_17_1','输血申请单','对病人进行输血治疗的申请单据','L#<l"{qov?$Zz~j T,8[',Null,Null,Null,&n_System,Null,Null,Sysdate,Null,Null,To_Date('2017-10-01 00:00:00','YYYY-MM-DD HH24:MI:SS'),To_Date('2017-10-01 00:00:00','YYYY-MM-DD HH24:MI:SS'));
Insert Into zlRPTFmts(报表ID,序号,说明,图样,W,H,纸张,纸向,动态纸张) Values(zlReports_ID.CurrVal,1,'输血申请单',0,11904,16838,9,1,0);
Insert Into zlRPTDatas(ID,报表ID,名称,字段,对象,类型,说明) Values(zlRPTDatas_ID.NextVal,zlReports_ID.CurrVal,'病人医嘱','住院号,202|姓名,202|性别,202|科室,202|当前床号,202|年龄,202|ID,131|相关ID,131|紧急标志,202|用药理由,202|嘱托,202|预定输血时间,202|开始执行时间,202|执行科室,202|总给予量,131|计算单位,202|项目名称,202|申请序号,131|紧急,202|标签一,202|标签二,130|标签三,130|类型,130|签名一,202|签名二,130',User||'.病人信息,'||User||'.部门表,'||User||'.病人医嘱记录,'||User||'.诊疗项目目录,'||User||'.病人新生儿记录,'||User||'.病人挂号记录',0,Null);
Insert Into zlRPTSQLs(源ID,行号,内容)  Select zlRPTDatas_ID.CurrVal,a.* From (
  Select 1,'Select a.住院号 || '''' As 住院号, Decode(Nvl(c.婴儿, 0), 0, a.姓名, Nvl(q.婴儿姓名, a.姓名 || ''之婴'' || q.序号)) As 姓名,' From Dual Union All
  Select 2,'       Decode(Nvl(c.婴儿, 0), 0, a.性别, q.婴儿性别) As 性别, b.名称 As 科室, a.当前床号 || '''' As 当前床号,' From Dual Union All
  Select 3,'       Decode(Nvl(c.婴儿, 0), 0, a.年龄, (Round(Sysdate - q.出生时间) || ''天'')) As 年龄, c.Id, c.相关id,' From Dual Union All
  Select 4,'       Decode(c.紧急标志, 0, ''普通'', 1, ''急诊'', 2, ''补录'', '''') As 紧急标志, c.用药理由, c.医生嘱托 As 嘱托,' From Dual Union All
  Select 5,'       Nvl(To_Char(c.手术时间, ''yyyy-MM-dd hh24:mi''), c.标本部位) As 预定输血时间, To_Char(c.开始执行时间, ''yyyy-MM-dd hh24:mi'') As 开始执行时间,' From Dual Union All
  Select 6,'       e.名称 As 执行科室, c.总给予量, d.计算单位, d.名称 As 项目名称, c.申请序号, Decode(紧急标志, 1, ''急'', '''') As 紧急, ''床    号:'' As 标签一,' From Dual Union All
  Select 7,'       ''住 院 号:'' As 标签二, ''住院号:'' As 标签三, ''住院'' As 类型, ''申请医师签名:'' As 签名一, ''上级医师签名:'' As 签名二' From Dual Union All
  Select 8,'From 病人信息 A, 部门表 B, 病人医嘱记录 C, 诊疗项目目录 D, 部门表 E, 病人新生儿记录 Q' From Dual Union All
  Select 9,'Where a.当前科室id = b.Id And a.病人id = c.病人id And a.主页ID = c.主页id And c.病人id = q.病人id(+) And c.主页id = q.主页id(+) And' From Dual Union All
  Select 10,'      c.婴儿 = q.序号(+) And c.诊疗项目id = d.Id And c.执行科室id = e.Id And c.Id = [0]' From Dual Union All
  Select 11,'Union All' From Dual Union All
  Select 12,'Select a.No As 住院号, a.姓名, a.性别, b.名称 As 科室, a.门诊号 || '''' As 当前床号, a.年龄, c.Id, c.相关id,' From Dual Union All
  Select 13,'       Decode(c.紧急标志, 0, ''普通'', 1, ''急诊'', 2, ''补录'', '''') As 紧急标志, c.用药理由, c.医生嘱托 As 嘱托,' From Dual Union All
  Select 14,'       Nvl(To_Char(c.手术时间, ''yyyy-MM-dd hh24:mi''), c.标本部位) As 预定输血时间, To_Char(c.开始执行时间, ''yyyy-MM-dd hh24:mi'') As 开始执行时间,' From Dual Union All
  Select 15,'       e.名称 As 执行科室, c.总给予量, d.计算单位, d.名称 As 项目名称, c.申请序号, Decode(紧急标志, 1, ''急'', '''') As 紧急, ''门 诊 号:'' As 标签一,' From Dual Union All
  Select 16,'       ''挂 号 单:'' As 标签二, ''挂号单:'' As 标签三, ''门诊'' As 类型, '''' As 签名一, ''申请医师签名:'' As 签名二' From Dual Union All
  Select 17,'From 病人挂号记录 A, 部门表 B, 病人医嘱记录 C, 诊疗项目目录 D, 部门表 E' From Dual Union All
  Select 18,'Where a.执行部门id = b.Id And c.挂号单 = a.No And c.诊疗项目id = d.Id And c.执行科室id = e.Id And c.Id = [0]' From Dual) a;
Insert Into zlRPTPars(源ID,组名,序号,名称,类型,缺省值,格式,值列表,分类SQL,明细SQL,分类字段,明细字段,对象,锁定) Values(zlRPTDatas_ID.CurrVal,Null,0,'医嘱ID',1,Null,0,Null,Null,Null,Null,Null,Null,0);
Insert Into zlRPTDatas(ID,报表ID,名称,字段,对象,类型,说明) Values(zlRPTDatas_ID.NextVal,zlReports_ID.CurrVal,'申请记录','是否待诊,202|输血性质,202|即往输血史无,202|即往输血史有,202|孕产情况孕,202|孕产情况产,202|受血者属地本市,202|受血者属地外埠,202|输血血型,202|RHD,202|输血类型,202|输血目的,202|既往输血反应史无,202|既往输血反应史有,202|输血禁忌及过敏史无,202|输血禁忌及过敏史有,202',User||'.输血申请记录',0,Null);
Insert Into zlRPTSQLs(源ID,行号,内容)  Select zlRPTDatas_ID.CurrVal,a.* From (
  Select 1,'Select Decode(是否待诊, 1, ''待诊'', '''') As 是否待诊, Decode(输血性质, 1, ''常规'', 2, ''紧急'', 3, ''大量'', 4, ''特殊'', '''') As 输血性质,' From Dual Union All
  Select 2,'       Decode(即往输血史, 0, ''●'', ''○'') As 即往输血史无, Decode(即往输血史, 0, ''○'', ''●'') As 即往输血史有,' From Dual Union All
  Select 3,'       Substr(孕产情况, 1, Instr(孕产情况, ''/'') - 1) 孕产情况孕, Substr(孕产情况, Instr(孕产情况, ''/'') + 1) 孕产情况产,' From Dual Union All
  Select 4,'       Decode(受血者属地, 0, ''●'', ''○'') As 受血者属地本市, Decode(受血者属地, 0, ''○'', ''●'') As 受血者属地外埠,' From Dual Union All
  Select 5,'       Decode(输血血型, 1, ''A'', 2, ''B'', 3, ''O'', 4, ''AB'', '''') As 输血血型, Decode(Rhd, 1, ''-'', 2, ''+'', '''') As Rhd, 输血类型, 输血目的,' From Dual Union All
  Select 6,'       Decode(既往输血反应史, 0, ''●'', ''○'') As 既往输血反应史无, Decode(既往输血反应史, 0, ''○'', ''●'') As 既往输血反应史有,' From Dual Union All
  Select 7,'       Decode(输血禁忌及过敏史, 0, ''●'', ''○'') As 输血禁忌及过敏史无, Decode(输血禁忌及过敏史, 0, ''○'', ''●'') As 输血禁忌及过敏史有' From Dual Union All
  Select 8,'From 输血申请记录' From Dual Union All
  Select 9,'Where 医嘱id = [0]' From Dual Union All
  Select 10,Null From Dual) a;
Insert Into zlRPTPars(源ID,组名,序号,名称,类型,缺省值,格式,值列表,分类SQL,明细SQL,分类字段,明细字段,对象,锁定) Values(zlRPTDatas_ID.CurrVal,Null,0,'医嘱ID',1,Null,0,Null,Null,Null,Null,Null,Null,0);
Insert Into zlRPTDatas(ID,报表ID,名称,字段,对象,类型,说明) Values(zlRPTDatas_ID.NextVal,zlReports_ID.CurrVal,'输血成分','名称,202|数量,202',User||'.病人医嘱记录,'||User||'.输血申请项目,'||User||'.诊疗项目目录',0,Null);
Insert Into zlRPTSQLs(源ID,行号,内容)  Select zlRPTDatas_ID.CurrVal,a.* From (
  Select 1,'Select a.名称, Decode(b.申请量 || a.计算单位, a.计算单位, '''', b.申请量 || a.计算单位) 数量' From Dual Union All
  Select 2,'From 诊疗项目目录 a,' From Dual Union All
  Select 3,'  (Select Decode(Nvl(b.医嘱id, 0), 0, a.诊疗项目id, b.诊疗项目id) 诊疗项目id, Decode(Nvl(b.医嘱id, 0), 0, a.总给予量, b.申请量) 申请量' From Dual Union All
  Select 4,'  From 病人医嘱记录 a, 输血申请项目 b' From Dual Union All
  Select 5,'  Where a.Id = b.医嘱id(+) And a.Id = [0]) b' From Dual Union All
  Select 6,'Where a.Id = b.诊疗项目id' From Dual) a;
Insert Into zlRPTPars(源ID,组名,序号,名称,类型,缺省值,格式,值列表,分类SQL,明细SQL,分类字段,明细字段,对象,锁定) Values(zlRPTDatas_ID.CurrVal,Null,0,'医嘱ID',1,Null,0,Null,Null,Null,Null,Null,Null,0);
Insert Into zlRPTDatas(ID,报表ID,名称,字段,对象,类型,说明) Values(zlRPTDatas_ID.NextVal,zlReports_ID.CurrVal,'输血检验结果','指标中文名1,202|指标结果1,202|结果单位1,202|指标中文名2,202|指标结果2,202|结果单位2,202|指标中文名3,202|指标结果3,202|结果单位3,202|行号,139',User||'.输血检验结果',0,Null);
Insert Into zlRPTSQLs(源ID,行号,内容)  Select zlRPTDatas_ID.CurrVal,a.* From (
  Select 1,'Select *' From Dual Union All
  Select 2,'From (Select Max(Decode(Mod(序号, 3), 1, 指标中文名, Null)) As 指标中文名1, Max(Decode(Mod(序号, 3), 1, 指标结果, Null)) As 指标结果1,' From Dual Union All
  Select 3,'              Max(Decode(Mod(序号, 3), 1, 结果单位, Null)) As 结果单位1, Max(Decode(Mod(序号, 3), 2, 指标中文名, Null)) As 指标中文名2,' From Dual Union All
  Select 4,'              Max(Decode(Mod(序号, 3), 2, 指标结果, Null)) As 指标结果2, Max(Decode(Mod(序号, 3), 2, 结果单位, Null)) As 结果单位2,' From Dual Union All
  Select 5,'              Max(Decode(Mod(序号, 3), 0, 指标中文名, Null)) As 指标中文名3, Max(Decode(Mod(序号, 3), 0, 指标结果, Null)) As 指标结果3,' From Dual Union All
  Select 6,'              Max(Decode(Mod(序号, 3), 0, 结果单位, Null)) As 结果单位3, Trunc((序号 - 1) / 3) + 1 As 行号' From Dual Union All
  Select 7,'       From 输血检验结果' From Dual Union All
  Select 8,'       Where 医嘱id = [0]' From Dual Union All
  Select 9,'       Group By Trunc((序号 - 1) / 3) + 1)' From Dual Union All
  Select 10,'Order By 行号' From Dual Union All
  Select 11,Null From Dual) a;
Insert Into zlRPTPars(源ID,组名,序号,名称,类型,缺省值,格式,值列表,分类SQL,明细SQL,分类字段,明细字段,对象,锁定) Values(zlRPTDatas_ID.CurrVal,Null,0,'医嘱ID',1,Null,0,Null,Null,Null,Null,Null,Null,0);
Insert Into zlRPTDatas(ID,报表ID,名称,字段,对象,类型,说明) Values(zlRPTDatas_ID.NextVal,zlReports_ID.CurrVal,'输血途径','医嘱内容,202|输血执行,202',User||'.诊疗项目目录,'||User||'.病人医嘱记录,'||User||'.部门表',0,Null);
Insert Into zlRPTSQLs(源ID,行号,内容)  Select zlRPTDatas_ID.CurrVal,a.* From (
  Select 1,'Select Nvl(Max(医嘱内容), ''采集方法: '') 医嘱内容, Nvl(Max(输血执行), ''输血执行: '') 输血执行' From Dual Union All
  Select 2,'From (Select Decode(c.操作类型, ''9'', ''采集方法: '', ''输血途径: '') || a.医嘱内容 医嘱内容,' From Dual Union All
  Select 3,'              Decode(c.操作类型, ''9'', ''采集执行: '', ''输血执行: '') || b.名称 As 输血执行' From Dual Union All
  Select 4,'       From 诊疗项目目录 c, 病人医嘱记录 a, 部门表 b' From Dual Union All
  Select 5,'       Where c.Id = a.诊疗项目id And a.执行科室id = b.Id And a.相关id = [0])' From Dual) a;
Insert Into zlRPTPars(源ID,组名,序号,名称,类型,缺省值,格式,值列表,分类SQL,明细SQL,分类字段,明细字段,对象,锁定) Values(zlRPTDatas_ID.CurrVal,Null,0,'医嘱ID',1,Null,0,Null,Null,Null,Null,Null,Null,0);
Insert Into zlRPTDatas(ID,报表ID,名称,字段,对象,类型,说明) Values(zlRPTDatas_ID.NextVal,zlReports_ID.CurrVal,'新开签名','签名一,202|签名二,202|操作类型,131',User||'.病人医嘱状态,'||User||'.医嘱签名记录,'||User||'.病人医嘱记录',0,Null);
Insert Into zlRPTSQLs(源ID,行号,内容)  Select zlRPTDatas_ID.CurrVal,a.* From (
  Select 1,'Select /*+ Rule*/ decode(c.挂号单,null,b.签名人,'''') as 签名一,decode(c.挂号单,null,'''',b.签名人) as 签名二,A.操作类型' From Dual Union All
  Select 2,'From 病人医嘱状态 A, 医嘱签名记录 B,病人医嘱记录 c Where a.签名id = b.Id And a.医嘱id = [0] And 操作类型=1 and c.id=a.医嘱id' From Dual) a;
Insert Into zlRPTPars(源ID,组名,序号,名称,类型,缺省值,格式,值列表,分类SQL,明细SQL,分类字段,明细字段,对象,锁定) Values(zlRPTDatas_ID.CurrVal,Null,0,'医嘱ID',1,Null,0,Null,Null,Null,Null,Null,Null,0);
Insert Into zlRPTDatas(ID,报表ID,名称,字段,对象,类型,说明) Values(zlRPTDatas_ID.NextVal,zlReports_ID.CurrVal,'医嘱诊断','诊断,202',User||'.病人诊断记录,'||User||'.病人诊断医嘱,'||User||'.病人医嘱附件',0,Null);
Insert Into zlRPTSQLs(源ID,行号,内容)  Select zlRPTDatas_ID.CurrVal,a.* From (
  Select 1,'Select 诊断' From Dual Union All
  Select 2,'From (Select 2 序号, 内容 诊断' From Dual Union All
  Select 3,'       From 病人医嘱附件' From Dual Union All
  Select 4,'       Where 医嘱id = [0] And 项目 = ''申请单诊断''' From Dual Union All
  Select 5,'       Union All' From Dual Union All
  Select 6,'       Select 序号, 诊断' From Dual Union All
  Select 7,'       From (Select 1 序号, f_List2str(Cast(Collect(a.诊断描述) As t_Strlist)) As 诊断' From Dual Union All
  Select 8,'              From 病人诊断记录 a, 病人诊断医嘱 b' From Dual Union All
  Select 9,'              Where b.诊断id = a.Id And b.医嘱id = [0]' From Dual Union All
  Select 10,'              Order By a.诊断次序)) where rownum <2' From Dual) a;
Insert Into zlRPTPars(源ID,组名,序号,名称,类型,缺省值,格式,值列表,分类SQL,明细SQL,分类字段,明细字段,对象,锁定) Values(zlRPTDatas_ID.CurrVal,Null,0,'医嘱ID',1,Null,0,Null,Null,Null,Null,Null,Null,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签50',2,Null,0,Null,0,'[病人医嘱.签名一]',Null,8070,12435,1785,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签48',2,Null,0,Null,0,'[病人医嘱.签名二]',Null,8070,12900,1785,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签51',2,Null,0,Null,0,'受 血 者签名:',Null,8070,13325,1365,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签52',2,Null,0,Null,0,'输血申请日期:',Null,8070,13770,1365,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签2',2,Null,0,Null,0,'就诊类型:',Null,9090,2265,945,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签8',2,Null,0,Null,0,'用血安排:',Null,9090,2715,945,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签12',2,Null,0,Null,0,'输血性质:',Null,9090,3680,945,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签54',2,Null,0,Null,0,'NO:',Null,9255,1605,360,225,0,0,1,'隶书',10.5,1,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签28',2,Null,0,Null,0,'[申请记录.受血者属地本市]',Null,9315,4155,315,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签35',2,Null,0,Null,0,'RH(D):',Null,9345,5040,810,240,0,0,1,'宋体',12,1,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签104',2,Null,0,Null,0,'[新开签名.签名一]',Null,9555,12435,1785,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签94',2,Null,0,Null,0,'[新开签名.签名二]',Null,9555,12900,1785,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签95',2,Null,0,Null,0,'[病人医嘱.开始执行时间]',Null,9555,13770,2041,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签26',2,Null,0,Null,0,'本市',Null,9585,4155,420,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签68',2,Null,0,Null,0,'[病人医嘱.申请序号]',Null,9705,1605,2160,225,0,0,1,'宋体',10.5,1,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签117',2,Null,0,Null,0,'[申请记录.输血禁忌及过敏史有]',Null,9855,4545,315,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签63',2,Null,0,Null,0,'[病人医嘱.类型]',Null,10155,2265,420,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签70',2,Null,0,Null,0,'[病人医嘱.紧急标志]',Null,10155,2715,1134,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签75',2,Null,0,Null,0,'[申请记录.输血性质]',Null,10155,3695,915,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签81',2,Null,0,Null,0,'[申请记录.RHD]',Null,10176,5025,1644,240,0,0,1,'宋体',12,1,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签29',2,Null,0,Null,0,'[申请记录.受血者属地外埠]',Null,10215,4155,315,210,0,0,0,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签115',2,Null,0,Null,0,'有',Null,10230,4545,210,225,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签27',2,Null,0,Null,0,'外埠',Null,10545,4155,420,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签118',2,Null,0,Null,0,'[申请记录.输血禁忌及过敏史无]',Null,10605,4560,285,210,0,0,0,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签116',2,Null,0,Null,0,'无',Null,10950,4545,210,225,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'任意表2',4,Null,0,Null,0,'输血成分',Null,795,5910,10715,1545,345,0,0,'宋体',12,1,0,0,0,16777215,0,Null,'16777215',Null,1,16777215,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,Null,6,zlRPTItems_ID.CurrVal-1,0,Null,Null,'[输血成分.名称]','0^30^#',0,0,6552,0,0,0,0,'宋体',0,0,0,0,0,0,0,Null,Null,Null,0,0,Null,Null,Null,Null,Null,Null,Null,Null);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,Null,6,zlRPTItems_ID.CurrVal-2,1,Null,Null,'[输血成分.数量]','0^30^#',0,0,2628,0,0,0,0,'宋体',0,0,0,0,0,0,0,Null,Null,Null,0,0,Null,Null,Null,Null,Null,Null,Null,Null);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'任意表1',4,Null,0,Null,0,'输血检验结果',Null,795,8325,10680,3540,345,0,0,'宋体',10.5,0,0,0,0,16777215,1,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,Null,6,zlRPTItems_ID.CurrVal-1,0,Null,Null,'[输血检验结果.指标中文名1]','4^705^指标名称^0^0',0,0,1740,0,0,0,0,'宋体',0,0,0,0,0,0,0,Null,Null,Null,1,0,Null,Null,Null,Null,Null,Null,Null,Null);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,Null,6,zlRPTItems_ID.CurrVal-2,1,Null,Null,'[输血检验结果.指标结果1]','4^705^结果^0^0',0,0,1176,0,0,0,0,'宋体',0,0,0,0,0,0,0,Null,Null,Null,1,0,Null,Null,Null,Null,Null,Null,Null,Null);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,Null,6,zlRPTItems_ID.CurrVal-3,2,Null,Null,'[输血检验结果.结果单位1]','4^705^单位^0^0',0,0,648,0,0,0,0,'宋体',0,0,0,0,0,0,0,Null,Null,Null,1,0,Null,Null,Null,Null,Null,Null,Null,Null);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,Null,6,zlRPTItems_ID.CurrVal-4,3,Null,Null,Null,'4^705^#^0^0',0,0,60,0,0,0,0,'宋体',0,0,0,0,0,0,0,Null,Null,Null,1,0,Null,Null,Null,Null,Null,Null,Null,Null);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,Null,6,zlRPTItems_ID.CurrVal-5,4,Null,Null,'[输血检验结果.指标中文名2]','4^705^指标名称^0^0',0,0,1788,0,0,0,0,'宋体',0,0,0,0,0,0,0,Null,Null,Null,1,0,Null,Null,Null,Null,Null,Null,Null,Null);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,Null,6,zlRPTItems_ID.CurrVal-6,5,Null,Null,'[输血检验结果.指标结果2]','4^705^结果^0^0',0,0,1080,0,0,0,0,'宋体',0,0,0,0,0,0,0,Null,Null,Null,1,0,Null,Null,Null,Null,Null,Null,Null,Null);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,Null,6,zlRPTItems_ID.CurrVal-7,6,Null,Null,'[输血检验结果.结果单位2]','4^705^单位^0^0',0,0,660,0,0,0,0,'宋体',0,0,0,0,0,0,0,Null,Null,Null,1,0,Null,Null,Null,Null,Null,Null,Null,Null);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,Null,6,zlRPTItems_ID.CurrVal-8,7,Null,Null,Null,'4^705^#^0^0',0,0,72,0,0,0,0,'宋体',0,0,0,0,0,0,0,Null,Null,Null,1,0,Null,Null,Null,Null,Null,Null,Null,Null);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,Null,6,zlRPTItems_ID.CurrVal-9,8,Null,Null,'[输血检验结果.指标中文名3]','4^705^指标名称^0^0',0,0,1788,0,0,0,0,'宋体',0,0,0,0,0,0,0,Null,Null,Null,1,0,Null,Null,Null,Null,Null,Null,Null,Null);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,Null,6,zlRPTItems_ID.CurrVal-10,9,Null,Null,'[输血检验结果.指标结果3]','4^705^结果^0^0',0,0,972,0,0,0,0,'宋体',0,0,0,0,0,0,0,Null,Null,Null,1,0,Null,Null,Null,Null,Null,Null,Null,Null);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,Null,6,zlRPTItems_ID.CurrVal-11,10,Null,Null,'[输血检验结果.结果单位3]','4^705^单位^0^0',0,0,576,0,0,0,0,'宋体',0,0,0,0,0,0,0,Null,Null,Null,1,0,Null,Null,Null,Null,Null,Null,Null,Null);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条10',1,Null,0,Null,0,Null,Null,1990,3430,9270,0,0,0,1,'宋体',0,0,0,0,6974058,0,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条41',1,Null,0,Null,0,Null,Null,1990,3940,2055,0,0,0,1,'宋体',0,0,0,0,0,0,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条40',1,Null,0,Null,0,Null,Null,1990,4395,585,0,0,0,1,'宋体',0,0,0,0,0,0,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条4',1,Null,0,Null,0,Null,Null,2000,2525,1260,15,0,0,1,'宋体',0,0,0,0,6974058,0,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条7',1,Null,0,Null,0,Null,Null,2005,2965,1230,15,0,0,1,'宋体',0,0,0,0,6974058,0,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条38',1,Null,0,Null,0,Null,Null,2030,12230,3870,0,0,0,1,'宋体',0,0,0,0,6974058,0,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条13',1,Null,0,Null,0,Null,Null,2440,5305,3495,15,0,0,1,'宋体',0,0,0,0,6974058,0,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条16',1,Null,0,Null,0,Null,Null,2440,7870,3525,15,0,0,1,'宋体',0,0,0,0,6974058,0,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条39',1,Null,0,Null,0,Null,Null,2935,4395,585,0,0,0,1,'宋体',0,0,0,0,0,0,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条1',1,Null,0,Null,0,Null,Null,4320,1380,3390,15,0,0,1,'宋体',0,0,0,0,0,0,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条3',1,Null,0,Null,0,Null,Null,4700,2965,1230,15,0,0,1,'宋体',0,0,0,0,6974058,0,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条5',1,Null,0,Null,0,Null,Null,4720,2525,1200,15,0,0,1,'宋体',0,0,0,0,6974058,0,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条11',1,Null,0,Null,0,Null,Null,5740,3940,2490,0,0,0,1,'宋体',0,0,0,0,6974058,0,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条37',1,Null,0,Null,0,Null,Null,5925,14595,15,1650,0,0,1,'宋体',0,0,0,0,0,0,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条9',1,Null,0,Null,0,Null,Null,7410,2525,1275,0,0,0,1,'宋体',0,0,0,0,6974058,0,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条6',1,Null,0,Null,0,Null,Null,7415,2965,1275,15,0,0,1,'宋体',0,0,0,0,6974058,0,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条17',1,Null,0,Null,0,Null,Null,7425,5305,1080,15,0,0,1,'宋体',0,0,0,0,6974058,0,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条19',1,Null,0,Null,0,Null,Null,7445,5840,3815,0,0,0,1,'宋体',0,0,0,0,6974058,0,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条21',1,Null,0,Null,0,Null,Null,7445,7870,3815,0,0,0,1,'宋体',0,0,0,0,6974058,0,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条2',1,Null,0,Null,0,Null,Null,10080,2525,1185,0,0,0,1,'宋体',0,0,0,0,6974058,0,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条8',1,Null,0,Null,0,Null,Null,10090,2965,1186,0,0,0,1,'宋体',0,0,0,0,6974058,0,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条12',1,Null,0,Null,0,Null,Null,10090,3945,1170,0,0,0,1,'宋体',0,0,0,0,6974058,0,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条18',1,Null,0,Null,0,Null,Null,10175,5305,1064,0,0,0,1,'宋体',0,0,0,0,6974058,0,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签53',2,Null,0,Null,0,'D D D D D D D D D D D D D D D D D D D D D D D D D D D D D D D D D D D D D D D D D D D D ',Null,90,14250,11744,180,0,0,1,'宋体',9,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签56',2,Null,0,Null,0,'受血者姓名:',Null,435,15135,1155,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签58',2,Null,0,Null,0,'采血日期:',Null,635,15890,945,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签30',2,Null,0,Null,0,'预定输血日期:',Null,765,5040,1665,240,0,0,1,'宋体',12,1,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签31',2,Null,0,Null,0,'预定输血成分及数量:',Null,765,5550,2430,240,0,0,1,'宋体',12,1,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签13',2,Null,0,Null,0,'既往输血史:',Null,795,4545,1155,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签57',2,Null,0,Null,0,'[病人医嘱.标签三]',Null,840,15510,735,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签100',2,Null,0,Null,0,'[病人医嘱.紧急]',Null,855,900,615,435,0,0,0,'宋体',22,1,0,0,255,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签4',2,Null,0,Null,0,'姓    名:',Null,1005,2265,945,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签7',2,Null,0,Null,0,'[病人医嘱.标签一]',Null,1005,2715,630,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签10',2,Null,0,Null,0,'临床诊断:',Null,1005,3200,945,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签107',2,Null,0,Null,0,'申请类型:',Null,1005,3695,945,225,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签18',2,Null,0,Null,0,'孕产情况:',Null,1005,4155,945,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签41',2,Null,0,Null,0,'受 血 者:',Null,1005,8020,945,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签55',2,Null,0,Null,0,'NO:',Null,1215,14760,360,210,0,0,1,'隶书',10.5,1,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签79',2,Null,0,Null,0,'[输血途径.医嘱内容]',Null,1275,7560,2445,240,0,0,1,'宋体',12,1,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签102',2,Null,0,Null,0,'备注:',Null,1425,11970,525,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签97',2,Null,0,Null,0,'[病人医嘱.住院号]',Null,1665,15510,1785,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签96',2,Null,0,Null,0,'[病人医嘱.申请序号]',Null,1695,14760,2160,225,0,0,1,'宋体',10.5,1,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签103',2,Null,0,Null,0,'[病人医嘱.嘱托]',Null,2030,11970,1575,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签66',2,Null,0,Null,0,'[病人医嘱.姓名]',Null,2055,2265,1575,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签71',2,Null,0,Null,0,'[病人医嘱.当前床号]',Null,2055,2715,1245,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签73',2,Null,0,Null,0,'[申请记录.是否待诊]',Null,2055,3185,1995,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签101',2,Null,0,Null,0,'[医嘱诊断.诊断]',Null,2055,3200,1575,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签108',2,Null,0,Null,0,'[申请记录.输血类型]',Null,2055,3695,1995,225,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签105',2,Null,0,Null,0,'[申请记录.孕产情况孕]',Null,2055,4155,2205,225,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签16',2,Null,0,Null,0,'[申请记录.即往输血史有]',Null,2055,4560,300,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签14',2,Null,0,Null,0,'有',Null,2415,4560,210,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签76',2,Null,0,Null,0,'[病人医嘱.预定输血时间]',Null,2520,5025,2955,240,0,0,1,'宋体',12,1,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签20',2,Null,0,Null,0,'孕',Null,2675,4155,210,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签17',2,Null,0,Null,0,'[申请记录.即往输血史无]',Null,2850,4560,270,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签106',2,Null,0,Null,0,'[申请记录.孕产情况产]',Null,2985,4155,2205,225,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签15',2,Null,0,Null,0,'无',Null,3210,4545,210,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签23',2,Null,0,Null,0,'产',Null,3640,4155,210,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签3',2,Null,0,Null,0,'[病人医嘱.标签二]',Null,3705,2715,945,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签5',2,Null,0,Null,0,'性    别:',Null,3725,2265,945,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签109',2,Null,0,Null,0,'既往输血反应史:',Null,4335,4545,1575,225,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签1',2,Null,0,Null,0,'临床输血申请单',Null,4440,897,3150,450,0,0,1,'宋体',22,1,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签11',2,Null,0,Null,0,'输血目的:',Null,4725,3695,945,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签67',2,Null,0,Null,0,'[病人医嘱.性别]',Null,4755,2265,1575,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签65',2,Null,0,Null,0,'[病人医嘱.住院号]',Null,4755,2715,1785,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签74',2,Null,0,Null,0,'[病人医嘱.用药理由]',Null,5775,3695,1995,225,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签110',2,Null,0,Null,0,'[申请记录.既往输血反应史有]',Null,5985,4545,345,210,0,0,0,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签36',2,Null,0,Null,0,'执行科室:',Null,6225,5550,1155,240,0,0,1,'宋体',12,1,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签84',2,Null,0,Null,0,'[输血途径.输血执行]',Null,6225,7560,2445,240,0,0,1,'宋体',12,1,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签113',2,Null,0,Null,0,'有',Null,6345,4545,210,225,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签60',2,Null,0,Null,0,'受血者姓名:',Null,6395,15155,1155,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签9',2,Null,0,Null,0,'年    龄:',Null,6415,2265,945,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签6',2,Null,0,Null,0,'科    别:',Null,6415,2715,945,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签62',2,Null,0,Null,0,'采血日期:',Null,6595,15910,945,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签111',2,Null,0,Null,0,'[申请记录.既往输血反应史无]',Null,6690,4545,345,225,0,0,0,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签34',2,Null,0,Null,0,'血型:',Null,6735,5040,645,240,0,0,1,'宋体',12,1,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签61',2,Null,0,Null,0,'[病人医嘱.标签三]',Null,6800,15530,735,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签114',2,Null,0,Null,0,'无',Null,7035,4530,210,225,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签59',2,Null,0,Null,0,'NO:',Null,7175,14780,360,210,0,0,1,'隶书',10.5,1,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签69',2,Null,0,Null,0,'[病人医嘱.年龄]',Null,7455,2265,1575,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签72',2,Null,0,Null,0,'[病人医嘱.科室]',Null,7455,2715,1575,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签80',2,Null,0,Null,0,'[申请记录.输血血型]',Null,7500,5025,2445,240,0,0,1,'宋体',12,1,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签82',2,Null,0,Null,0,'[病人医嘱.执行科室]',Null,7512,5526,2445,240,0,0,1,'宋体',12,1,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签99',2,Null,0,Null,0,'[病人医嘱.住院号]',Null,7665,15525,1785,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签98',2,Null,0,Null,0,'[病人医嘱.申请序号]',Null,7695,14775,2160,225,0,0,1,'宋体',10.5,1,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签112',2,Null,0,Null,0,'输血禁忌及过敏史:',Null,7920,4545,1785,225,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签25',2,Null,0,Null,0,'受血者属地:',Null,7980,4155,1155,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,Null,Null,Null,0,0,0,0,0);


--101301:刘鹏飞,2017-10-10,新增报表ZL1_INSIDE_1254_17_2/取血通知单
Insert Into zlReports(ID,编号,名称,说明,密码,进纸,打印机,票据,系统,程序ID,功能,修改时间,发布时间,打印方式,禁止开始时间,禁止结束时间) Values(zlReports_ID.NextVal,'ZL1_INSIDE_1254_17_2','取血通知单','对病人进行输血治疗的申请单据','M#;g"yqh}?'||CHR(38)||'Z}uj"T+3X',1,'发送至 OneNote 2007',0,&n_System,Null,Null,Sysdate,Null,0,To_Date('2017-10-01 00:00:00','YYYY-MM-DD HH24:MI:SS'),To_Date('2017-10-01 00:00:00','YYYY-MM-DD HH24:MI:SS'));
Insert Into zlRPTFmts(报表ID,序号,说明,图样,W,H,纸张,纸向,动态纸张) Values(zlReports_ID.CurrVal,1,'取血通知单',0,11904,11798,256,1,0);
Insert Into zlRPTDatas(ID,报表ID,名称,字段,对象,类型,说明) Values(zlRPTDatas_ID.NextVal,zlReports_ID.CurrVal,'病人医嘱','住院号,202|姓名,202|性别,202|科室,202|当前床号,202|年龄,202|ID,131|相关ID,131|紧急标志,202|用药理由,202|预定输血时间,202|开始执行时间,202|执行科室,202|总给予量,131|计算单位,202|项目名称,202|申请序号,131|紧急,202|标签一,202|标签二,130|标签三,130|类型,130',User||'.病人信息,'||User||'.部门表,'||User||'.病人医嘱记录,'||User||'.诊疗项目目录,'||User||'.病人挂号记录',0,Null);
Insert Into zlRPTSQLs(源ID,行号,内容)  Select zlRPTDatas_ID.CurrVal,a.* From (
  Select 1,'Select a.住院号||'''' as 住院号, a.姓名, a.性别, b.名称 As 科室, a.当前床号||'''' as 当前床号, a.年龄, c.Id, c.相关id, Decode(c.紧急标志,0,''普通'',1,''急诊'',2,''补录'','''') as 紧急标志, c.用药理由,' From Dual Union All
  Select 2,'       Nvl(To_Char(c.手术时间, ''yyyy-MM-dd hh24:mi''), c.标本部位) As 预定输血时间, To_Char(c.开始执行时间, ''yyyy-MM-dd hh24:mi'') as 开始执行时间, e.名称 As 执行科室, c.总给予量, d.计算单位,' From Dual Union All
  Select 3,'       d.名称 As 项目名称, c.申请序号,Decode(紧急标志,1,''急'','''') as 紧急,''床    号:'' as 标签一,''住 院 号:'' as 标签二,''住院号:'' as 标签三,''住院'' as 类型' From Dual Union All
  Select 4,Null From Dual Union All
  Select 5,'From 病人信息 A, 部门表 B, 病人医嘱记录 C, 诊疗项目目录 D, 部门表 E' From Dual Union All
  Select 6,'Where a.当前科室id = b.Id And a.病人id = c.病人id And a.主页ID = c.主页id And c.诊疗项目id = d.Id And c.执行科室id = e.Id And c.Id =[0]' From Dual Union All
  Select 7,'union all ' From Dual Union All
  Select 8,'Select a.no as 住院号, a.姓名, a.性别, b.名称 As 科室, a.门诊号||'''' as 当前床号, a.年龄, c.Id, c.相关id, Decode(c.紧急标志,0,''普通'',1,''急诊'',2,''补录'','''') as 紧急标志, c.用药理由,' From Dual Union All
  Select 9,'       Nvl(To_Char(c.手术时间, ''yyyy-MM-dd hh24:mi''), c.标本部位) As 预定输血时间, To_Char(c.开始执行时间, ''yyyy-MM-dd hh24:mi'') as 开始执行时间, e.名称 As 执行科室, c.总给予量, d.计算单位,' From Dual Union All
  Select 10,'       d.名称 As 项目名称, c.申请序号,Decode(紧急标志,1,''急'','''') as 紧急,''门 诊 号:'' as 标签一,''挂 号 单:'' as 标签二,''挂号单:'' as 标签三,''门诊'' as 类型' From Dual Union All
  Select 11,Null From Dual Union All
  Select 12,'From 病人挂号记录 A, 部门表 B, 病人医嘱记录 C, 诊疗项目目录 D, 部门表 E' From Dual Union All
  Select 13,'Where a.执行部门id = b.Id And c.挂号单=a.no And c.诊疗项目id = d.Id And c.执行科室id = e.Id And c.Id =[0]' From Dual) a;
Insert Into zlRPTPars(源ID,组名,序号,名称,类型,缺省值,格式,值列表,分类SQL,明细SQL,分类字段,明细字段,对象,锁定) Values(zlRPTDatas_ID.CurrVal,Null,0,'医嘱ID',1,Null,0,Null,Null,Null,Null,Null,Null,0);
Insert Into zlRPTDatas(ID,报表ID,名称,字段,对象,类型,说明) Values(zlRPTDatas_ID.NextVal,zlReports_ID.CurrVal,'申请记录','是否待诊,202|输血性质,202|即往输血史无,202|即往输血史有,202|孕产情况孕,202|孕产情况产,202|受血者属地本市,202|受血者属地外埠,202|输血血型,202|RHD,202|输血类型,202|输血目的,202|既往输血反应史无,202|既往输血反应史有,202|输血禁忌及过敏史无,202|输血禁忌及过敏史有,202',User||'.输血申请记录',0,Null);
Insert Into zlRPTSQLs(源ID,行号,内容)  Select zlRPTDatas_ID.CurrVal,a.* From (
  Select 1,'Select Decode(是否待诊, 1, ''待诊'', '''') As 是否待诊, Decode(输血性质, 1, ''常规'', 2, ''紧急'', 3, ''大量'', 4, ''特殊'', '''') As 输血性质,' From Dual Union All
  Select 2,'       Decode(即往输血史, 0, ''●'', ''○'') As 即往输血史无, Decode(即往输血史, 0, ''○'', ''●'') As 即往输血史有,' From Dual Union All
  Select 3,'       Substr(孕产情况, 1, Instr(孕产情况, ''/'') - 1) 孕产情况孕, Substr(孕产情况, Instr(孕产情况, ''/'') + 1) 孕产情况产,' From Dual Union All
  Select 4,'       Decode(受血者属地, 0, ''●'', ''○'') As 受血者属地本市, Decode(受血者属地, 0, ''○'', ''●'') As 受血者属地外埠,' From Dual Union All
  Select 5,'       Decode(输血血型, 1, ''A'', 2, ''B'', 3, ''O'', 4, ''AB'', '''') As 输血血型, Decode(Rhd, 1, ''-'', 2, ''+'', '''') As Rhd, 输血类型, 输血目的,' From Dual Union All
  Select 6,'       Decode(既往输血反应史, 0, ''●'', ''○'') As 既往输血反应史无, Decode(既往输血反应史, 0, ''○'', ''●'') As 既往输血反应史有,' From Dual Union All
  Select 7,'       Decode(输血禁忌及过敏史, 0, ''●'', ''○'') As 输血禁忌及过敏史无, Decode(输血禁忌及过敏史, 0, ''○'', ''●'') As 输血禁忌及过敏史有' From Dual Union All
  Select 8,'From 输血申请记录' From Dual Union All
  Select 9,'Where 医嘱id = [0]' From Dual Union All
  Select 10,Null From Dual) a;
Insert Into zlRPTPars(源ID,组名,序号,名称,类型,缺省值,格式,值列表,分类SQL,明细SQL,分类字段,明细字段,对象,锁定) Values(zlRPTDatas_ID.CurrVal,Null,0,'医嘱ID',1,Null,0,Null,Null,Null,Null,Null,Null,0);
Insert Into zlRPTDatas(ID,报表ID,名称,字段,对象,类型,说明) Values(zlRPTDatas_ID.NextVal,zlReports_ID.CurrVal,'输血成分','名称,202|数量,202',User||'.病人医嘱记录,'||User||'.输血申请项目,'||User||'.诊疗项目目录',0,Null);
Insert Into zlRPTSQLs(源ID,行号,内容)  Select zlRPTDatas_ID.CurrVal,a.* From (
  Select 1,'Select a.名称, Decode(b.申请量 || a.计算单位, a.计算单位, '''', b.申请量 || a.计算单位) 数量' From Dual Union All
  Select 2,'From 诊疗项目目录 a,' From Dual Union All
  Select 3,'  (Select Decode(Nvl(b.医嘱id, 0), 0, a.诊疗项目id, b.诊疗项目id) 诊疗项目id, Decode(Nvl(b.医嘱id, 0), 0, a.总给予量, b.申请量) 申请量' From Dual Union All
  Select 4,'  From 病人医嘱记录 a, 输血申请项目 b' From Dual Union All
  Select 5,'  Where a.Id = b.医嘱id(+) And a.Id = [0]) b' From Dual Union All
  Select 6,'Where a.Id = b.诊疗项目id' From Dual) a;
Insert Into zlRPTPars(源ID,组名,序号,名称,类型,缺省值,格式,值列表,分类SQL,明细SQL,分类字段,明细字段,对象,锁定) Values(zlRPTDatas_ID.CurrVal,Null,0,'医嘱ID',1,Null,0,Null,Null,Null,Null,Null,Null,0);
Insert Into zlRPTDatas(ID,报表ID,名称,字段,对象,类型,说明) Values(zlRPTDatas_ID.NextVal,zlReports_ID.CurrVal,'输血途径','医嘱内容,202|输血执行,202',User||'.病人医嘱记录,'||User||'.部门表',0,Null);
Insert Into zlRPTSQLs(源ID,行号,内容)  Select zlRPTDatas_ID.CurrVal,a.* From (
  Select 1,' Select a.医嘱内容, b.名称 As 输血执行 From 病人医嘱记录 A, 部门表 B Where a.执行科室id = b.Id And a.相关id = [0]' From Dual Union All
  Select 2,Null From Dual) a;
Insert Into zlRPTPars(源ID,组名,序号,名称,类型,缺省值,格式,值列表,分类SQL,明细SQL,分类字段,明细字段,对象,锁定) Values(zlRPTDatas_ID.CurrVal,Null,0,'医嘱ID',1,Null,0,Null,Null,Null,Null,Null,Null,0);
Insert Into zlRPTDatas(ID,报表ID,名称,字段,对象,类型,说明) Values(zlRPTDatas_ID.NextVal,zlReports_ID.CurrVal,'新开签名','签名人,202|操作类型,131',User||'.病人医嘱状态,'||User||'.医嘱签名记录',0,Null);
Insert Into zlRPTSQLs(源ID,行号,内容)  Select zlRPTDatas_ID.CurrVal,a.* From (
  Select 1,'Select b.签名人,A.操作类型 From 病人医嘱状态 A, 医嘱签名记录 B Where a.签名id = b.Id And a.医嘱id = [0] And 操作类型=1' From Dual) a;
Insert Into zlRPTPars(源ID,组名,序号,名称,类型,缺省值,格式,值列表,分类SQL,明细SQL,分类字段,明细字段,对象,锁定) Values(zlRPTDatas_ID.CurrVal,Null,0,'医嘱ID',1,Null,0,Null,Null,Null,Null,Null,Null,0);
Insert Into zlRPTDatas(ID,报表ID,名称,字段,对象,类型,说明) Values(zlRPTDatas_ID.NextVal,zlReports_ID.CurrVal,'医嘱诊断','诊断,202',User||'.病人诊断记录,'||User||'.病人诊断医嘱',0,'医嘱诊断');
Insert Into zlRPTSQLs(源ID,行号,内容)  Select zlRPTDatas_ID.CurrVal,a.* From (
  Select 1,'Select /*+rule+*/ f_List2str(Cast(Collect(a.诊断描述) As t_Strlist)) As 诊断' From Dual Union All
  Select 2,'From 病人诊断记录 A, 病人诊断医嘱 B Where b.诊断id=a.id And b.医嘱ID=[0] Order By a.诊断次序' From Dual) a;
Insert Into zlRPTPars(源ID,组名,序号,名称,类型,缺省值,格式,值列表,分类SQL,明细SQL,分类字段,明细字段,对象,锁定) Values(zlRPTDatas_ID.CurrVal,Null,0,'医嘱ID',1,Null,0,Null,Null,Null,Null,Null,Null,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签63',2,Null,0,Null,0,'[病人医嘱.类型]',Null,10155,2190,1575,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签70',2,Null,0,Null,0,'[病人医嘱.紧急标志]',Null,10155,2670,1134,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签81',2,Null,0,Null,0,'[申请记录.RHD]',Null,10185,4200,1644,240,0,0,1,'宋体',12,1,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'任意表1',4,Null,0,Null,0,'输血成分',Null,765,5145,10160,1545,345,0,0,'宋体',12,1,0,0,0,16777215,0,Null,'16777215',Null,1,16777215,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,Null,6,zlRPTItems_ID.CurrVal-1,1,Null,Null,'[输血成分.数量]','4^30^#',0,0,2115,0,0,0,0,Null,0,0,0,0,0,0,0,Null,Null,Null,0,0,0,Null,Null,Null,Null,Null,Null,Null);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,Null,6,zlRPTItems_ID.CurrVal-2,0,Null,Null,'[输血成分.名称]','4^30^#',0,0,7530,0,0,0,0,Null,0,0,0,0,0,0,0,Null,Null,Null,0,0,0,Null,Null,Null,Null,Null,Null,Null);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条10',1,Null,0,Null,0,Null,Null,1990,3445,8970,0,0,0,1,'宋体',0,0,0,0,6974058,0,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条38',1,Null,0,Null,0,Null,Null,1990,3940,1965,0,0,0,1,'宋体',0,0,0,0,0,0,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条4',1,Null,0,Null,0,Null,Null,2000,2525,1260,15,0,0,1,'宋体',0,0,0,0,6974058,0,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条7',1,Null,0,Null,0,Null,Null,2005,2980,1230,15,0,0,1,'宋体',0,0,0,0,6974058,0,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条13',1,Null,0,Null,0,Null,Null,2455,4495,3495,15,0,0,1,'宋体',0,0,0,0,6974058,0,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条16',1,Null,0,Null,0,Null,Null,2455,7240,3525,15,0,0,1,'宋体',0,0,0,0,6974058,0,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条1',1,Null,0,Null,0,Null,Null,4320,1380,3390,15,0,0,1,'宋体',0,0,0,0,0,0,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条3',1,Null,0,Null,0,Null,Null,4700,2990,1230,15,0,0,1,'宋体',0,0,0,0,6974058,0,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条5',1,Null,0,Null,0,Null,Null,4720,2515,1200,15,0,0,1,'宋体',0,0,0,0,6974058,0,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条11',1,Null,0,Null,0,Null,Null,5890,3940,1965,0,0,0,1,'宋体',0,0,0,0,6974058,0,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条37',1,Null,0,Null,0,Null,Null,5925,9825,15,1650,0,0,1,'宋体',0,0,0,0,0,0,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条9',1,Null,0,Null,0,Null,Null,7410,2505,1275,0,0,0,1,'宋体',0,0,0,0,6974058,0,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条6',1,Null,0,Null,0,Null,Null,7415,2990,1275,15,0,0,1,'宋体',0,0,0,0,6974058,0,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条17',1,Null,0,Null,0,Null,Null,7425,4495,1080,15,0,0,1,'宋体',0,0,0,0,6974058,0,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条19',1,Null,0,Null,0,Null,Null,7445,5010,3515,15,0,0,1,'宋体',0,0,0,0,6974058,0,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条21',1,Null,0,Null,0,Null,Null,7465,7240,3515,15,0,0,1,'宋体',0,0,0,0,6974058,0,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条30',1,Null,0,Null,0,Null,Null,9130,7960,1785,15,0,0,1,'宋体',0,0,0,0,6974058,0,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条33',1,Null,0,Null,0,Null,Null,9165,8460,1785,15,0,0,1,'宋体',0,0,0,0,6974058,0,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条34',1,Null,0,Null,0,Null,Null,9170,8990,1785,15,0,0,1,'宋体',0,0,0,0,6974058,0,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条12',1,Null,0,Null,0,Null,Null,9520,3960,1440,0,0,0,1,'宋体',0,0,0,0,6974058,0,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条2',1,Null,0,Null,0,Null,Null,10080,2475,870,0,0,0,1,'宋体',0,0,0,0,6974058,0,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条8',1,Null,0,Null,0,Null,Null,10090,2950,856,15,0,0,1,'宋体',0,0,0,0,6974058,0,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'线条18',1,Null,0,Null,0,Null,Null,10175,4495,794,15,0,0,1,'宋体',0,0,0,0,6974058,0,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签53',2,Null,0,Null,0,'D D D D D D D D D D D D D D D D D D D D D D D D D D D D D D D D D D D D D D D D D D D D ',Null,90,9480,11744,180,0,0,1,'宋体',9,0,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签56',2,Null,0,Null,0,'受血者姓名:',Null,435,10365,1155,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签58',2,Null,0,Null,0,'取血日期:',Null,635,11120,945,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签30',2,Null,0,Null,0,'预定输血日期:',Null,765,4215,1665,240,0,0,1,'宋体',12,1,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签31',2,Null,0,Null,0,'预定输血成分及数量:',Null,765,4725,2430,240,0,0,1,'宋体',12,1,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签57',2,Null,0,Null,0,'[病人医嘱.标签三]',Null,840,10740,1785,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签100',2,Null,0,Null,0,'[病人医嘱.紧急]',Null,855,900,615,435,0,0,0,'宋体',22,1,0,0,255,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签10',2,Null,0,Null,0,'临床诊断:',Null,995,3185,945,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签102',2,Null,0,Null,0,'申请类型:',Null,995,3680,945,225,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签4',2,Null,0,Null,0,'姓    名:',Null,1005,2265,945,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签7',2,Null,0,Null,0,'[病人医嘱.标签一]',Null,1010,2720,1785,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签55',2,Null,0,Null,0,'NO:',Null,1215,9990,360,210,0,0,1,'隶书',10.5,1,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签33',2,Null,0,Null,0,'输血途径:',Null,1275,6930,1155,240,0,0,1,'宋体',12,1,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签97',2,Null,0,Null,0,'[病人医嘱.住院号]',Null,1665,10740,1785,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签96',2,Null,0,Null,0,'[病人医嘱.申请序号]',Null,1695,9990,2160,225,0,0,1,'宋体',10.5,1,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签66',2,Null,0,Null,0,'[病人医嘱.姓名]',Null,2055,2235,1575,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签101',2,Null,0,Null,0,'[医嘱诊断.诊断]',Null,2055,3165,1575,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签73',2,Null,0,Null,0,'[申请记录.是否待诊]',Null,2055,3165,1995,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签103',2,Null,0,Null,0,'[申请记录.输血类型]',Null,2055,3675,1995,225,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签71',2,Null,0,Null,0,'[病人医嘱.当前床号]',Null,2070,2715,1245,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签76',2,Null,0,Null,0,'[病人医嘱.预定输血时间]',Null,2535,4200,2955,240,0,0,1,'宋体',12,1,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签79',2,Null,0,Null,0,'[输血途径.医嘱内容]',Null,2565,6900,2445,240,0,0,1,'宋体',12,1,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签3',2,Null,0,Null,0,'[病人医嘱.标签二]',Null,3705,2730,1785,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签5',2,Null,0,Null,0,'性    别:',Null,3725,2255,945,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签1',2,Null,0,Null,0,'临床取血通知单',Null,4440,915,3150,450,0,0,1,'宋体',22,1,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签67',2,Null,0,Null,0,'[病人医嘱.性别]',Null,4755,2235,1575,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签65',2,Null,0,Null,0,'[病人医嘱.住院号]',Null,4770,2700,1785,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签11',2,Null,0,Null,0,'输血目的:',Null,4865,3680,945,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签74',2,Null,0,Null,0,'[病人医嘱.用药理由]',Null,5940,3675,1995,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签36',2,Null,0,Null,0,'执行科室:',Null,6245,4725,1155,240,0,0,1,'宋体',12,1,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签38',2,Null,0,Null,0,'输血执行:',Null,6265,6930,1155,240,0,0,1,'宋体',12,1,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签60',2,Null,0,Null,0,'受血者姓名:',Null,6395,10385,1155,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签9',2,Null,0,Null,0,'年    龄:',Null,6415,2245,945,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签6',2,Null,0,Null,0,'科    别:',Null,6420,2730,945,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签62',2,Null,0,Null,0,'取血日期:',Null,6595,11140,945,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签34',2,Null,0,Null,0,'血型:',Null,6735,4215,645,240,0,0,1,'宋体',12,1,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签61',2,Null,0,Null,0,'[病人医嘱.标签三]',Null,6800,10760,1785,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签59',2,Null,0,Null,0,'NO:',Null,7175,9990,360,210,0,0,1,'隶书',10.5,1,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签69',2,Null,0,Null,0,'[病人医嘱.年龄]',Null,7455,2205,1575,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签72',2,Null,0,Null,0,'[病人医嘱.科室]',Null,7500,2700,1575,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签80',2,Null,0,Null,0,'[申请记录.输血血型]',Null,7515,4200,2445,240,0,0,1,'宋体',12,1,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签82',2,Null,0,Null,0,'[病人医嘱.执行科室]',Null,7515,4695,2445,240,0,0,1,'宋体',12,1,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签84',2,Null,0,Null,0,'[输血途径.输血执行]',Null,7515,6900,2445,240,0,0,1,'宋体',12,1,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签99',2,Null,0,Null,0,'[病人医嘱.住院号]',Null,7665,10755,1785,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签48',2,Null,0,Null,0,'申请医师签名:',Null,7680,7710,1365,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签98',2,Null,0,Null,0,'[病人医嘱.申请序号]',Null,7695,9990,2160,225,0,0,1,'宋体',10.5,1,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签51',2,Null,0,Null,0,'取 血 者签名:',Null,7715,8195,1365,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签52',2,Null,0,Null,0,'输血申请日期:',Null,7725,8745,1365,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签12',2,Null,0,Null,0,'输血性质:',Null,8485,3700,945,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签2',2,Null,0,Null,0,'就诊类型:',Null,9090,2220,945,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签8',2,Null,0,Null,0,'用血安排:',Null,9095,2690,945,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签94',2,Null,0,Null,0,'[新开签名.签名人]',Null,9195,7665,1785,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签95',2,Null,0,Null,0,'[病人医嘱.开始执行时间]',Null,9210,8715,2415,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签54',2,Null,0,Null,0,'NO:',Null,9255,1605,360,225,0,0,1,'隶书',10.5,1,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签35',2,Null,0,Null,0,'RH(D):',Null,9345,4215,810,240,0,0,1,'宋体',12,1,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签75',2,Null,0,Null,0,'[申请记录.输血性质]',Null,9525,3690,1995,210,0,0,1,'宋体',10.5,0,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);
Insert Into zlRPTItems(ID,报表ID,格式号,名称,类型,上级ID,序号,参照,性质,内容,表头,X,Y,W,H,行高,对齐,自调,字体,字号,粗体,斜体,下线,前景,背景,边框,排序,格式,汇总,分栏,网格,系统,父ID,源ID,上下间距,左右间距,纵向分栏,横向分栏,源行号) Values(zlRPTItems_ID.NextVal,zlReports_ID.CurrVal,1,'标签68',2,Null,0,Null,0,'[病人医嘱.申请序号]',Null,9705,1605,2160,225,0,0,1,'宋体',10.5,1,0,0,0,16777215,0,Null,Null,Null,1,0,0,Null,Null,0,0,0,0,0);

--101301:刘鹏飞,2017-10-10,取血通知单权限使用[输血申请单]权限
Insert into zlProgPrivs(系统,序号,功能,所有者,对象,权限)
  Select 100,1253,'输血申请单',User,'输血申请项目','SELECT' From Dual Union All
  Select 100,1254,'输血申请单',User,'输血申请项目','SELECT' From Dual;



-------------------------------------------------------------------------------
--过程修正部份
-------------------------------------------------------------------------------
--115098:张险华,2017-10-24,接收前检查是否已签名
CREATE OR REPLACE Procedure Zl_疾病申报记录_Incept
(
  文件id_In     In 疾病申报记录.文件id%Type,
  Incept_In     In Number, --接收还是拒绝
  说明_In       In 疾病申报记录.收拒说明%Type,
  文档id_In     In Varchar2,
  病人id_In     In 疾病申报记录.病人ID%Type,
  主页ID_In     In 疾病申报记录.主页ID%Type,
  病人来源_In   In 疾病申报记录.病人来源%Type,
  Emrcontent_In In Varchar2  --新病历诊断串
) Is
  v_收拒人   人员表.姓名%Type;

  v_姓名      疾病申报记录.姓名%Type;
  v_性别      疾病申报记录.性别%Type;
  v_年龄      疾病申报记录.年龄%Type;
  v_职业      疾病申报记录.职业%Type;
  v_家庭地址  疾病申报记录.家庭地址%Type;
  v_家庭电话  疾病申报记录.家庭电话%Type;
  v_发病日期  疾病申报记录.发病日期%Type;
  v_确诊日期  疾病申报记录.确诊日期%Type;
  v_诊断描述1 疾病申报记录.诊断描述1%Type;
  v_诊断描述2 疾病申报记录.诊断描述2%Type;
  v_填报备注  疾病申报记录.填报备注%Type;
  v_内容文本  电子病历内容.内容文本%Type;
  v_报卡类型  疾病申报记录.报卡类型%Type;
  v_报告医生  疾病申报记录.报告医生%Type;

  v_Count Number;
  e_Changed Exception;

  Function Trimlen
  (
    Str_In Varchar2,
    Len_In Number
  ) Return Varchar2 Is
    v_Temp Varchar2(4000);
  Begin
    If Str_In Is Not Null Then
      For I In 1 .. Length(Str_In) Loop
        If Lengthb(v_Temp || Substr(Str_In, I, 1)) <= Len_In Then
          v_Temp := v_Temp || Substr(Str_In, I, 1);
        Else
          Exit;
        End If;
      End Loop;
    End If;
    Return v_Temp;
  End Trimlen;
Begin

  Select 姓名 Into v_收拒人 From 人员表 P, 上机人员表 U Where p.Id = u.人员id And u.用户名 = User And Rownum < 2;

  If Length(文档id_In) <> 32 Then
    --新病历ID是32位GUID
    Update 电子病历记录 Set 处理状态 = Decode(Incept_In, 1, 1, -1) Where ID = 文件id_In And 完成时间 Is Not Null;
    If Sql%RowCount = 0 Then
      Raise e_Changed;
    End If;
  End If;

  --自动提取申报病历中的项目内容
  If Incept_In = 1 Then
    If Length(文档id_In) <> 32 Then
      --固定对应要素
      v_Count := 0;
      For r_Item In (Select 要素名称, 要素类型, 内容行次, 内容文本
                     From 电子病历内容
                     Where (对象类型 = 4 or 对象类型 = 8 )And 文件id = 文件id_In
                     Order By 对象序号, 内容行次) Loop

        If r_Item.要素名称 = '姓名' Then
          v_姓名 := Trimlen(r_Item.内容文本, 20);
        Elsif r_Item.要素名称 = '性别' Then
          v_性别 := Trimlen(r_Item.内容文本, 4);
        Elsif r_Item.要素名称 = '年龄' Then
          v_年龄 := Trimlen(r_Item.内容文本, 10);
        Elsif r_Item.要素名称 = '职业'  Then
          v_职业 := Trimlen(r_Item.内容文本, 80);
        Elsif r_Item.要素名称 = '家庭地址' Then
          v_家庭地址 := Trimlen(r_Item.内容文本, 100);
        Elsif r_Item.要素名称 = '家庭电话'  Then
          v_家庭电话 := Trimlen(r_Item.内容文本, 20);
        Elsif r_Item.要素名称 = '当前日期'  Then
          v_Count := v_Count + 1;
          If v_Count = 1  Then
            --病历中第1个"当前日期"作为发病日期
            Begin
              v_发病日期 := To_Date(Replace(Replace(Replace(r_Item.内容文本, '年', '-'), '月', '-'), '日', ''), 'YYYY-MM-DD');
            Exception
              When Others Then
                Null;
            End;
          Elsif v_Count = 2  Then
            --病历中第2个"当前日期"作为确诊日期
            Begin
              v_确诊日期 := To_Date(Replace(Replace(Replace(r_Item.内容文本, '年', '-'), '月', '-'), '日', ''), 'YYYY-MM-DD');
            Exception
              When Others Then
                Null;
            End;
          End If;
        Elsif r_Item.要素名称 = '常见传染病' Then
          v_诊断描述1 := Trimlen(r_Item.内容文本, 150);
        End If;
      End Loop;

        --其他临时要素对应
      For r_Item In (Select 申报项目, 对应要素 From 疾病申报对应) Loop
        Begin
          Select 内容文本
          Into v_内容文本
          From 电子病历内容
          Where 对象类型 = 4 And 诊治要素id Is Null And 要素名称 = r_Item.对应要素 And 文件id = 文件id_In;
        Exception
          When Others Then
            v_内容文本 := Null;
        End;

        If r_Item.申报项目 = '诊断描述2' Then
          v_诊断描述2 := Trimlen(v_内容文本, 150);
        Elsif r_Item.申报项目 = '填报备注' Then
          v_填报备注 := Trimlen(v_内容文本, 100);
        End If;
      End Loop;
    Else
      Select 姓名, 性别, 年龄, 职业, 家庭地址, 家庭电话, 家庭电话
      Into v_姓名, v_性别, v_年龄, v_职业, v_家庭地址, v_家庭电话, v_家庭电话
      From 病人信息
      Where 病人id = 病人id_In;
      v_发病日期  := '';
      v_确诊日期  := '';
      v_诊断描述1 := Substr(Emrcontent_In, 1, Instr(Emrcontent_In, '|') - 1);
      v_诊断描述2 := '';
      v_填报备注  := Substr(Emrcontent_In, Instr(Emrcontent_In, '|') + 1,Instr(Emrcontent_In, '|',1,2)-1-Instr(Emrcontent_In, '|'));
      v_报卡类型  := '1 初次报告';
      v_报告医生  := Substr(Emrcontent_In, Instr(Emrcontent_In, '|',1,2) + 1);
    End If;
  End If;

  --接收数据
  Update 疾病申报记录
  Set 处理状态 = Decode(Incept_In, 1, 1, -1), 收拒人 = v_收拒人, 收拒时间 = Sysdate, 收拒说明 = 说明_In, 姓名 = v_姓名, 性别 = v_性别, 年龄 = v_年龄,
      职业 = v_职业, 家庭地址 = v_家庭地址, 家庭电话 = v_家庭电话, 发病日期 = v_发病日期, 确诊日期 = v_确诊日期, 诊断描述1 = v_诊断描述1, 诊断描述2 = v_诊断描述1,
      填报备注 = v_填报备注, 报告医生 = v_报告医生,报卡类型 = v_报卡类型,病人id= 病人id_In,主页ID = 主页ID_In,病人来源 = 病人来源_In
  Where 文件id = 文件id_In;
  If Sql%RowCount = 0 Then
    Insert Into 疾病申报记录
      (文件id, 处理状态, 收拒人, 收拒时间, 收拒说明, 姓名, 性别, 年龄, 职业, 家庭地址, 家庭电话, 发病日期, 确诊日期, 诊断描述1, 诊断描述2, 填报备注, 文档id, 报告医生, 报卡类型,病人id,主页ID,病人来源)
    Values
      (文件id_In, Decode(Incept_In, 1, 1, -1), v_收拒人, Sysdate, 说明_In, v_姓名, v_性别, v_年龄, v_职业, v_家庭地址, v_家庭电话, v_发病日期,
       v_确诊日期, v_诊断描述1, v_诊断描述2, v_填报备注, 文档id_In, v_报告医生, v_报卡类型,病人id_In,主页ID_In,病人来源_In);
  End If;
 
Exception
  When No_Data_Found Then
    Raise_Application_Error(-20101, '[ZLSOFT]用户身份不明确！[ZLSOFT]');
  When e_Changed Then
    Raise_Application_Error(-20101, '[ZLSOFT]疾病报告已经被其他用户改变！[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_疾病申报记录_Incept;
/

--112526:陈刘,2017-10-24,婴儿体温单同步
CREATE OR REPLACE Procedure Zl_病人护理数据_Update
(
  文件id_In   In 病人护理数据.文件id%Type,
  发生时间_In In 病人护理数据.发生时间%Type,
  记录类型_In In 病人护理明细.记录类型%Type, --护理项目=1，签名记录=5，审签记录=15
  项目序号_In In 病人护理明细.项目序号%Type, --护理项目的序号，非护理项目固定为0
  记录内容_In In 病人护理明细.记录内容%Type := Null, --记录内容，如果内容为空，即清除以前的内容；37或38/37
  体温部位_In In 病人护理明细.体温部位%Type := Null,
  他人记录_In In Number := 1,
  数据来源_In In 病人护理明细.数据来源%Type := 0,
  审签_In     In Number := 0,
  操作员_In   In 病人护理数据.保存人%Type := Null,
  记录组号_In In 病人护理明细.记录组号%Type := Null, --适用分类汇总(一条数据对应多条相同项目的明细)
  相关序号_In In 病人护理明细.相关序号%Type := Null, --适用分类汇总(记录汇总项目关联的名称项目序号)
  未记说明_In In 病人护理明细.未记说明%Type := Null --入量导入存储医嘱ID:发送号
) Is
  Intins      Number(18);
  Int共用     Number(1);
  n_Newid     病人护理数据.Id%Type;
  n_Oldid     病人护理数据.Id%Type;
  n_行数      病人护理打印.行数%Type;
  n_Mutilbill Number(1);
  n_Syntend   Number(1);
  n_Synchro   Number(1);
  n_未记说明  Number(1);
  n_曲线      Number(1);
  n_Num       Number(18);

  n_汇总类别     病人护理数据.汇总类别%Type;
  v_科室id       部门表.Id%Type;
  v_保存人       人员表.姓名%Type;
  v_记录人       人员表.姓名%Type;
  n_文件id       病人护理数据.文件id%Type;
  n_记录id       病人护理数据.Id%Type;
  n_明细id       病人护理明细.Id%Type;
  n_来源id       病人护理明细.来源id%Type;
  v_数据来源     病人护理明细.数据来源%Type;
  n_最高版本     病人护理明细.开始版本%Type;
  n_项目性质     护理记录项目.项目性质%Type;
  n_病人id       病人护理文件.病人id%Type;
  n_主页id       病人护理文件.主页id%Type;
  n_婴儿         病人护理文件.婴儿%Type;
  d_婴儿出院时间 病人医嘱记录.开始执行时间%Type;
  d_文件开始时间 病人护理文件.开始时间%Type;
  v_Name         体温记录项目.记录名%Type; 
  --提取该病人当前科室所有未结束的护理文件，且文件开始时间小于等于记录发生时间的文件列表供同步数据使用
  Cursor Cur_Fileformats Is
    Select a.Id As 格式id, b.Id As 文件id, a.保留, a.子类, b.婴儿
    From 病历文件列表 A, 病人护理文件 B, 病人护理文件 C, 病人护理数据 D
    Where a.种类 = 3 And a.保留 <> 1 And a.Id = b.格式id And b.Id <> c.Id And b.结束时间 Is Null And b.开始时间 <= d.发生时间 And
          (a.通用 = 1 Or (a.通用 = 2 And b.科室id = c.科室id)) And c.病人id = b.病人id And c.主页id = b.主页id And c.婴儿 = b.婴儿 And
          c.Id = d.文件id And d.Id = n_记录id And c.Id = 文件id_In
    Order By a.编号;

  v_Error Varchar2(255);
  Err_Custom Exception;
Begin
  --取记录ID
  Int共用     := 0;
  n_记录id    := 0;
  n_Mutilbill := 0;
  n_Syntend   := 0;
  n_未记说明  := 0;
  n_曲线      := 0;

  If 操作员_In Is Null Then
    v_保存人 := Zl_Username;
  Else
    v_保存人 := 操作员_In;
  End If;

  --如果是对应多份护理文件值为1，表示需同步其它护理文件；否则不处理文件同步
  n_Mutilbill := Zl_To_Number(zl_GetSysParameter('对应多份护理文件', 1255));
  --如果允许多份护理文件之间数据同步,则自动同步,否则不同步
  n_Syntend := Zl_To_Number(zl_GetSysParameter('允许数据同步', 1255));

  Begin
    Select ID, 汇总类别
    Into n_记录id, n_汇总类别
    From 病人护理数据
    Where 文件id = 文件id_In And 发生时间 = 发生时间_In;
  Exception
    When Others Then
      n_记录id := 0;
  End;

  Begin
    Select 记录名 Into v_Name From 体温记录项目 Where 项目序号 = 项目序号_In;
  Exception
    When Others Then
      v_Name := '';
  End;

  --检查是不是本人的记录
  ---------------------------------------------------------------------------------------------------------------------
  If 他人记录_In = 0 And n_记录id > 0 And 审签_In = 0 Then
    v_记录人 := '';
    Begin
      Select 记录人
      Into v_记录人
      From 病人护理明细
      Where 记录id = n_记录id And 项目序号 = 项目序号_In And Nvl(体温部位, 'TWBW') = Nvl(体温部位_In, 'TWBW') And
            Nvl(记录组号, 0) = Nvl(记录组号_In, 0) And 终止版本 Is Null;
    Exception
      When Others Then
        v_记录人 := '';
    End;
    If v_记录人 Is Not Null And v_记录人 <> v_保存人 Then
      v_Error := '你无权修改他人登记的护理数据！';
      Raise Err_Custom;
    End If;
  End If;

  --检查是否入科
  Select 病人id, 主页id, Nvl(婴儿, 0), 开始时间
  Into n_病人id, n_主页id, n_婴儿, d_文件开始时间
  From 病人护理文件
  Where ID = 文件id_In;
  d_婴儿出院时间 := Null;
  If n_婴儿 <> 0 Then
    Begin
      Select 开始执行时间
      Into d_婴儿出院时间
      From 病人医嘱记录 B, 诊疗项目目录 C
      Where b.诊疗项目id + 0 = c.Id And b.医嘱状态 = 8 And Nvl(b.婴儿, 0) <> 0 And c.类别 = 'Z' And
            Instr(',3,5,11,', ',' || c.操作类型 || ',', 1) > 0 And b.病人id = n_病人id And b.主页id = n_主页id And b.婴儿 = n_婴儿;
    Exception
      When Others Then
        d_婴儿出院时间 := Null;
    End;
  End If;
  If d_婴儿出院时间 Is Null Then
    v_科室id := 0;
    Begin
      Select a.科室id
      Into v_科室id
      From 病人变动记录 A, 病人护理文件 B
      Where a.科室id Is Not Null And a.病人id = b.病人id And a.主页id = b.主页id And b.Id = 文件id_In And
            (To_Date(To_Char(发生时间_In, 'YYYY-MM-DD HH24:MI') || '59', 'YYYY-MM-DD HH24:MI:SS') >= a.开始时间 And
            (To_Date(To_Char(发生时间_In, 'YYYY-MM-DD HH24:MI') || '00', 'YYYY-MM-DD HH24:MI:SS') < = Nvl(a.终止时间, Sysdate) Or
            a.终止时间 Is Null)) And Rownum < 2;
    Exception
      When Others Then
        v_科室id := 0;
    End;
    If v_科室id = 0 Then
      v_Error := '数据发生时间 ' || To_Char(发生时间_In, 'YYYY-MM-DD HH24:MI:SS') || ' 不在病人有效变动时间范围内，不能操作！';
      Raise Err_Custom;
    End If;
  Else
    If 发生时间_In < d_文件开始时间 Or 发生时间_In > d_婴儿出院时间 Then
      v_Error := '数据发生时间 ' || To_Char(发生时间_In, 'YYYY-MM-DD HH24:MI:SS') || ' 不在病人有效变动时间范围内，不能操作！';
      Raise Err_Custom;
    End If;
  End If;

  --如果数据来源<>0则退出
  n_来源id := 0;
  If n_记录id > 0 Then
    Begin
      Select 数据来源, Nvl(来源id, 0)
      Into v_数据来源, n_来源id
      From 病人护理明细
      Where 记录id = n_记录id And Nvl(项目序号, 0) = 项目序号_In And Nvl(体温部位, 'TWBW') = Nvl(体温部位_In, 'TWBW') And
            Nvl(记录组号, 0) = Nvl(记录组号_In, 0);
    Exception
      When Others Then
        v_数据来源 := 0;
    End;
    If v_数据来源 > 0 And n_来源id > 0 Then
      Return;
    End If;
  End If;

  --取最高版本
  Select Nvl(Max(Nvl(a.开始版本, 1)), 0) + 1, Count(b.Id)
  Into n_最高版本, Intins
  From 病人护理明细 A, 病人护理数据 B
  Where b.Id = n_记录id And a.记录id = b.Id And Mod(a.记录类型, 10) = 5;

  --目前已经签名的数据不能修改，只有在审签模式下进行修改，即审签_In=1
  If 审签_In <> 1 And Intins > 0 Then
    v_Error := '发生时间 ' || To_Char(发生时间_In, 'YYYY-MM-DD HH24:MI:SS') || ' 所对应的数据已经签名或审签，不能继续操作！' || Chr(13) || Chr(10) ||
               '这可能是由于网络并发操作引起的，请刷新后再试！';
    Raise Err_Custom;
  End If;
  Intins := 0;

  --无内容时,要清除数据（审签回退时会自动清除审签过程中修改的数据，所以此处只需考虑普签即可）
  If 记录内容_In Is Null Then
    Begin
      Select ID
      Into n_明细id
      From 病人护理明细
      Where 记录id = n_记录id And Nvl(项目序号, 0) = 项目序号_In And Nvl(体温部位, 'TWBW') = Nvl(体温部位_In, 'TWBW') And
            Nvl(记录组号, 0) = Nvl(记录组号_In, 0) And 终止版本 Is Null;
    Exception
      --无数据退出
      When Others Then
        Return;
    End;

    --查找除了本条要删除的数据，是否还存其他有效的数据，如果存在只删除本条数据，否则删除此发生时间对应的所有数据。
    Select Count(ID)
    Into Intins
    From 病人护理明细
    Where 记录id = n_记录id And Mod(记录类型, 10) <> 5 And 终止版本 Is Null And ID <> n_明细id;
    If Intins = 0 Then
      Delete From 病人护理明细 Where 记录id = n_记录id;
    Else
      Delete From 病人护理明细 Where ID = n_明细id;
    End If;

    Delete From 病人护理数据 A
    Where a.Id = n_记录id And Not Exists (Select 1 From 病人护理明细 B Where b.记录id = a.Id);

    --如果是删除签名后修改产生的最后一条数据,则应将签名记录的终止版本清为空
    Begin
      Select 1
      Into Intins
      From 病人护理明细
      Where 开始版本 = n_最高版本 And 终止版本 Is Null And 记录类型 = 1 And 记录id = n_记录id;
    Exception
      When Others Then
        Intins := 0;
    End;
    If Intins = 0 Then
      Update 病人护理明细 Set 终止版本 = Null Where 记录类型 = 5 And 开始版本 = n_最高版本 - 1 And 记录id = n_记录id;
    End If;
    If Nvl(n_汇总类别, 0) <> 0 Then
      Return;
    End If;

    --############
    --清除共用数据
    --############
    For Rsdel In (Select Distinct 记录id From 病人护理明细 Where 来源id = n_明细id) Loop

      Delete 病人护理明细 Where 来源id = n_明细id And 记录id = Rsdel.记录id;
      --删除对应的打印数据
      Begin
        Select Count(*) Into Intins From 病人护理明细 Where 记录id = Rsdel.记录id;
      Exception
        When Others Then
          Intins := 0;
      End;
      If Intins = 0 Then
        --提取清除数据对应的文件ID
        Begin
          Select b.Id, a.保留
          Into n_文件id, Intins
          From 病历文件列表 A, 病人护理文件 B, 病人护理数据 C
          Where a.Id = b.格式id And b.Id = c.文件id And c.Id = Rsdel.记录id;
        Exception
          When Others Then
            n_文件id := 0;
        End;
        Delete 病人护理数据 Where ID = Rsdel.记录id;
        If Intins <> -1 Then
          Zl_病人护理打印_Update(n_文件id, 发生时间_In, 1, 1);
        End If;
      End If;
    End Loop;
  Else
    --检查录入的项目是否属于该记录单
    Begin
      Select 1
      Into Intins
      From (Select b.项目序号
             From 病历文件结构 A, 护理记录项目 B
             Where a.要素名称 = b.项目名称 And b.项目序号 = 项目序号_In And
                   父id = (Select b.Id
                          From 病人护理文件 A, 病历文件结构 B
                          Where a.Id = 文件id_In And a.格式id = b.文件id And b.父id Is Null And b.对象序号 = 4)
             Union
             Select 项目序号
             From 护理记录项目
             Where 项目性质 = 2 And 项目序号 = 项目序号_In);
    Exception
      When Others Then
        Intins := 0;
    End;
    If Intins = 0 Then
      Return;
    End If;
    If n_记录id = 0 Then
      Select 病人护理数据_Id.Nextval Into n_记录id From Dual;

      Insert Into 病人护理数据
        (ID, 文件id, 发生时间, 最后版本, 保存人, 保存时间)
      Values
        (n_记录id, 文件id_In, 发生时间_In, n_最高版本, v_保存人, Sysdate);
    End If;

    --插入本次登记的病人护理明细
    Update 病人护理明细
    Set 记录内容 = 记录内容_In, 数据来源 = 数据来源_In, 未记说明 = 未记说明_In, 记录人 = v_保存人, 记录时间 = Sysdate
    Where 记录id = n_记录id And 项目序号 = 项目序号_In And Nvl(体温部位, 'TWBW') = Nvl(体温部位_In, 'TWBW') And
          Nvl(记录组号, 0) = Nvl(记录组号_In, 0) And 开始版本 = n_最高版本 And 终止版本 Is Null;
    If Sql%RowCount = 0 Then
      Select 病人护理明细_Id.Nextval Into n_明细id From Dual;
      Insert Into 病人护理明细
        (ID, 记录id, 记录类型, 项目分组, 项目id, 相关序号, 项目序号, 项目名称, 项目类型, 记录内容, 项目单位, 记录标记, 记录组号, 体温部位, 数据来源, 共用, 未记说明, 开始版本, 终止版本,
         记录人, 记录时间)
        Select n_明细id, n_记录id, 记录类型_In, a.分组名, a.项目id, 相关序号_In, a.项目序号, Upper(a.项目名称), a.项目类型, 记录内容_In, a.项目单位, 0,
               记录组号_In, 体温部位_In, 数据来源_In, Nvl(b.共用, 0), 未记说明_In, n_最高版本, Null, v_保存人, Sysdate
        From 护理记录项目 A, 病人护理明细 B
        Where a.项目序号 = b.项目序号(+) And b.终止版本(+) Is Null And b.记录id(+) = n_记录id And a.项目序号 = 项目序号_In And Rownum < 2;
    End If;
    Select ID
    Into n_明细id
    From 病人护理明细
    Where 记录id = n_记录id And 项目序号 = 项目序号_In And Nvl(体温部位, 'TWBW') = Nvl(体温部位_In, 'TWBW') And
          Nvl(记录组号, 0) = Nvl(记录组号_In, 0) And 开始版本 = n_最高版本 And 终止版本 Is Null;
    --填写历史数据及签名记录的终止版本
    Update 病人护理明细
    Set 终止版本 = n_最高版本
    Where 记录id = n_记录id And ((Mod(记录类型, 10) <> 5 And 项目序号 = 项目序号_In And Nvl(体温部位, 'TWBW') = Nvl(体温部位_In, 'TWBW') And
          Nvl(记录组号, 0) = Nvl(记录组号_In, 0)) Or 记录类型 = Decode(审签_In, 1, 15, 5)) And 开始版本 <= n_最高版本 - 1 And 终止版本 Is Null;

    --如果是未签名数据，最后修改操作员做为该记录的保存人更新
    If n_最高版本 = 1 Then
      Update 病人护理数据 Set 保存人 = v_保存人, 保存时间 = Sysdate Where ID = n_记录id;
    End If;

    If Nvl(n_汇总类别, 0) <> 0 Then
      Return;
    End If;

    --############
    --同步共用数据
    --############
    --1\先处理体温单（一个病人始终只存在一份有效的体温单文件）
    --如果体温表存在相同发生时间的数据，使用它的ID
    --CL,2015-12-30,记录单同步文字项目到体温单
    For Row_Format In Cur_Fileformats Loop
      If Row_Format.保留 = -1 Then
        If Row_Format.子类 = '1' Then
          Begin
            Select 1, h.项目性质
            Into Intins, n_项目性质
            From (Select To_Char(f.记录名) As 项目名称, g.项目性质
                   From 体温记录项目 F, 护理记录项目 G
                   Where f.项目序号 = g.项目序号 And g.项目性质 = 2 And
                         (g.适用科室 = 1 Or
                         (g.适用科室 = 2 And Exists
                          (Select 1 From 护理适用科室 D Where g.项目序号 = d.项目序号 And d.科室id = v_科室id))) And Nvl(g.应用方式, 0) <> 0 And
                         (Nvl(g.适用病人, 0) = 0 Or Nvl(g.适用病人, 0) = Decode(Nvl(Row_Format.婴儿, 0), 0, 1, 2))
                   Union All
                   Select b.要素名称 As 项目名称, 1 As 项目性质
                   From 病历文件结构 A, 病历文件结构 B
                   Where a.文件id = Row_Format.格式id And a.父id Is Null And a.对象序号 In (2, 3) And b.父id = a.Id) H
            Where Instr(',' || h.项目名称 || ',', ',' || v_Name || ',', 1) > 0;
          Exception
            When Others Then
              Intins := 0;
          End;
        Else
          Begin
            Select 1, g.项目性质
            Into Intins, n_项目性质
            From 体温记录项目 F, 护理记录项目 G
            Where f.项目序号 = g.项目序号 And Nvl(g.应用方式, 0) <> 0 And g.护理等级 >= 0 And
                  (Nvl(g.适用病人, 0) = 0 Or Nvl(g.适用病人, 0) = Decode(Nvl(Row_Format.婴儿, 0), 0, 1, 2)) And f.项目序号 = 项目序号_In And
                  (g.适用科室 = 1 Or (g.适用科室 = 2 And Exists
                   (Select 1 From 护理适用科室 D Where g.项目序号 = d.项目序号 And d.科室id = v_科室id)));
          Exception
            When Others Then
              Intins := 0;
          End;
        End If;

        If Intins > 0 Then
          --LPF,2013-01-23,检查此项目是否需要进行同步(对于以前已经同步过的数据，为了保证记录单和体温单数据一直将不根据此函数判断。)
          n_Synchro := Zl_Temperatureprogram(文件id_In, v_科室id, 项目序号_In, 发生时间_In);
          Begin
            Select b.Id
            Into n_Newid
            From 病人护理文件 A, 病人护理数据 B
            Where a.Id = Row_Format.文件id And b.文件id = a.Id And b.发生时间 = 发生时间_In;
          Exception
            When Others Then
              n_Newid := 0;
          End;
          n_Oldid := n_Newid;
          If n_Newid = 0 And n_Synchro = 1 Then
            Select 病人护理数据_Id.Nextval Into n_Newid From Dual;
            --产生体温单主记录
            Insert Into 病人护理数据
              (ID, 文件id, 保存人, 保存时间, 发生时间, 最后版本)
            Values
              (n_Newid, Row_Format.文件id, v_保存人, Sysdate, 发生时间_In, 1);
          End If;

          Begin
            Select To_Number(记录内容_In) Into n_Num From Dual;
          Exception
            When Invalid_Number Then
              Begin
                Select 1 Into n_曲线 From 体温记录项目 Where 项目序号 = 项目序号_In And 记录法 = 1;
              Exception
                When Others Then
                  n_曲线 := 0;
              End;
              Begin
                Select 1 Into n_未记说明 From 常用体温说明 Where 名称 = 记录内容_In;
              Exception
                When Others Then
                  n_未记说明 := 0;
              End;
          End;

          If n_Newid > 0 Then
            --插入未同步的体温单数据(仍然要联接多表查询)
            Select Count(*)
            Into v_数据来源
            From 病人护理明细
            Where 记录id = n_Newid And 项目序号 = 项目序号_In And
                  Decode(n_项目性质, 2, Nvl(体温部位, '无'), Nvl(体温部位_In, '无')) = Nvl(体温部位_In, '无');
            If v_数据来源 = 0 Then
              --说明在同步开始已经进行过检查
              If n_Synchro = 1 Then
                --没有检查此项目是否需要同步
                If n_曲线 = 1 And n_未记说明 = 1 Then
                  Insert Into 病人护理明细
                    (ID, 记录id, 记录类型, 项目分组, 项目id, 项目序号, 项目名称, 项目类型, 记录内容, 项目单位, 记录标记, 体温部位, 数据来源, 来源id, 未记说明, 开始版本, 终止版本,
                     记录人, 记录时间, 记录组号)
                    Select 病人护理明细_Id.Nextval, n_Newid, b.记录类型, b.项目分组, b.项目id, b.项目序号, b.项目名称, b.项目类型, Null, b.项目单位,
                           b.记录标记, b.体温部位, 1, b.Id, b.记录内容, 1, Null, b.记录人, Sysdate, 1
                    From (Select 项目序号_In As 项目序号, Nvl(体温部位_In, '无') As 体温部位
                           From Dual
                           Minus
                           Select f.项目序号, Decode(Nvl(f.项目性质, 1), 2, Nvl(体温部位, '无'), Nvl(体温部位_In, '无'))
                           From 病人护理明细 E, 护理记录项目 F
                           Where e.记录id = n_Newid And e.项目序号 = f.项目序号) A, 病人护理明细 B
                    Where a.项目序号 = b.项目序号 And b.记录id = n_记录id And b.Id = n_明细id;
                  If Sql%RowCount > 0 Then
                    Int共用 := 1;
                  End If;
                Else
                  Insert Into 病人护理明细
                    (ID, 记录id, 记录类型, 项目分组, 项目id, 项目序号, 项目名称, 项目类型, 记录内容, 项目单位, 记录标记, 体温部位, 数据来源, 来源id, 开始版本, 终止版本, 记录人,
                     记录时间, 记录组号)
                    Select 病人护理明细_Id.Nextval, n_Newid, b.记录类型, b.项目分组, b.项目id, b.项目序号, b.项目名称, b.项目类型, b.记录内容, b.项目单位,
                           b.记录标记, b.体温部位, 1, b.Id, 1, Null, b.记录人, Sysdate, 1
                    From (Select 项目序号_In As 项目序号, Nvl(体温部位_In, '无') As 体温部位
                           From Dual
                           Minus
                           Select f.项目序号, Decode(Nvl(f.项目性质, 1), 2, Nvl(体温部位, '无'), Nvl(体温部位_In, '无'))
                           From 病人护理明细 E, 护理记录项目 F
                           Where e.记录id = n_Newid And e.项目序号 = f.项目序号) A, 病人护理明细 B
                    Where a.项目序号 = b.项目序号 And b.记录id = n_记录id And b.Id = n_明细id;
                  If Sql%RowCount > 0 Then
                    Int共用 := 1;
                  End If;
                end if;
              End If;
            Else
              If n_曲线 = 1 And n_未记说明 = 1 Then
                Update 病人护理明细
                Set 未记说明 = 记录内容_In, 来源id = n_明细id, 记录内容 = Null
                Where 记录id = n_Newid And 项目序号 = 项目序号_In And
                      Decode(n_项目性质, 2, Nvl(体温部位, '无'), Nvl(体温部位_In, '无')) = Nvl(体温部位_In, '无') And 数据来源 > 0;
                If Sql%RowCount > 0 Then
                  Int共用 := 1;
                End If;
              Else
                Update 病人护理明细
                Set 记录内容 = 记录内容_In, 来源id = n_明细id
                Where 记录id = n_Newid And 项目序号 = 项目序号_In And
                      Decode(n_项目性质, 2, Nvl(体温部位, '无'), Nvl(体温部位_In, '无')) = Nvl(体温部位_In, '无') And 数据来源 > 0;
                If Sql%RowCount > 0 Then
                  Int共用 := 1;
                End If;
              End If;
            End If;
          End If;
        End If;
        --2\再循环处理记录单
      Else
        If n_Mutilbill = 1 And n_Syntend = 1 Then
          --提取记录单与当前记录单存在重叠的且有数据的固定项目
          Select Count(*)
          Into Intins
          From (Select b.项目序号
                 From 病历文件结构 A, 护理记录项目 B
                 Where a.要素名称 = b.项目名称 And b.项目表示 In (0, 4, 5) And
                       父id =
                       (Select ID From 病历文件结构 Where 文件id = Row_Format.格式id And 父id Is Null And 对象序号 = 4)
                 Intersect
                 Select b.项目序号
                 From 病历文件结构 A, 护理记录项目 B, 病人护理文件 C, 病人护理数据 D, 病人护理明细 G
                 Where c.Id = d.文件id And a.文件id = c.格式id And d.Id = g.记录id And d.Id = n_记录id And g.Id = n_明细id And
                       b.项目序号 = g.项目序号 And b.项目表示 In (0, 4, 5) And g.记录类型 = 1 And a.要素名称 = b.项目名称 And
                       a.父id = (Select ID From 病历文件结构 E Where e.文件id = c.格式id And 父id Is Null And 对象序号 = 4));

          If Intins > 0 Then
            n_Newid := 0;
            --可能指定文件已经存在相同发生时间的数据，直接用它的ID即可
            Begin
              Select c.Id
              Into n_Newid
              From 病人护理数据 C
              Where c.文件id = Row_Format.文件id And c.发生时间 = 发生时间_In;
            Exception
              When Others Then
                n_Newid := 0;
            End;

            If n_Newid = 0 Then
              --产生记录单主记录
              Select 病人护理数据_Id.Nextval Into n_Newid From Dual;

              Insert Into 病人护理数据
                (ID, 文件id, 保存人, 保存时间, 发生时间, 最后版本)
                Select n_Newid, Row_Format.文件id, c.保存人, c.保存时间, c.发生时间, 1
                From 病人护理数据 C
                Where c.Id = n_记录id;
            End If;

            If n_Newid > 0 Then
              --插入未同步的记录单数据
              Select Count(*) Into v_数据来源 From 病人护理明细 Where 记录id = n_Newid And 项目序号 = 项目序号_In;
              If v_数据来源 = 0 Then
                Insert Into 病人护理明细
                  (ID, 记录id, 记录类型, 项目分组, 项目id, 项目序号, 项目名称, 项目类型, 记录内容, 项目单位, 记录标记, 体温部位, 数据来源, 来源id, 未记说明, 开始版本, 终止版本,
                   记录人, 记录时间)
                  Select 病人护理明细_Id.Nextval, n_Newid, b.记录类型, b.项目分组, b.项目id, b.项目序号, b.项目名称, b.项目类型, b.记录内容, b.项目单位,
                         b.记录标记, b.体温部位, 1, b.Id, b.未记说明, 1, Null, b.记录人, Sysdate
                  From (Select b.项目序号
                         From 病历文件结构 A, 护理记录项目 B
                         Where a.要素名称 = b.项目名称 And b.项目表示 In (0, 4, 5) And
                               父id = (Select ID
                                      From 病历文件结构
                                      Where 文件id = Row_Format.格式id And 父id Is Null And 对象序号 = 4)
                         Intersect
                         Select b.项目序号
                         From 病历文件结构 A, 护理记录项目 B, 病人护理文件 C, 病人护理数据 D, 病人护理明细 G
                         Where c.Id = d.文件id And a.文件id = c.格式id And d.Id = g.记录id And d.Id = n_记录id And g.Id = n_明细id And
                               b.项目序号 = g.项目序号 And b.项目表示 In (0, 4, 5) And g.记录类型 = 1 And a.要素名称 = b.项目名称 And
                               a.父id =
                               (Select ID From 病历文件结构 E Where e.文件id = c.格式id And 父id Is Null And 对象序号 = 4)) A, 病人护理明细 B
                  Where a.项目序号 = b.项目序号 And b.记录id = n_记录id And b.Id = n_明细id;
                If Sql%RowCount > 0 Then
                  Int共用 := 1;
                  --原行数不要动
                  Begin
                    Select 行数 Into n_行数 From 病人护理打印 Where 文件id = Row_Format.文件id And 记录id = n_Newid;
                  Exception
                    When Others Then
                      n_行数 := 1;
                  End;
                  Zl_病人护理打印_Update(Row_Format.文件id, 发生时间_In, n_行数, 0);
                End If;
              Else
                Update 病人护理明细
                Set 记录内容 = 记录内容_In, 未记说明 = 未记说明_In, 来源id = n_明细id
                Where 记录id = n_Newid And 项目序号 = 项目序号_In And 数据来源 > 0;
                If Sql%RowCount > 0 Then
                  Int共用 := 1;
                End If;
              End If;
            End If;
          End If;
        End If;
      End If;
    End Loop;

    If Int共用 = 1 Then
      Update 病人护理明细 Set 共用 = 1 Where ID = n_明细id;
      --将历史数据的共用标志设置为NULL
      Update 病人护理明细 Set 共用 = Null Where 记录id = n_记录id And 项目序号 = 项目序号_In And ID <> n_明细id;
    End If;
  End If;
Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_病人护理数据_Update;
/

--114073:蔡青松,2017-10-24,检验报告不能审核
Create Or Replace Procedure Zl_检验报告单_Apply
(
  v_Strval      In Varchar2,
  n_Type        In Number,
  n_Begin       In Number := 0, --开始为0
  v_Lisiteminto In Varchar2 := Null
  --功能           把检验结果回写入HIS病历中,
  --               v_Lisiteminto     采样人<S>采样时间<S>样本条码<S>标本序号<S>标本类型<S>核收人<S>核收时间<S>检验人<S>检验时间<S>审核人<S>审核时间<S>检验评语<S>检验备注
  --参数           v_Strval 专入的标本结果内容，单条申请结果
  --               格式:
  --               类型(1=普通)<split2>申请ID<split2>病人来源<split2>报告时间<split2>报告人<split2>审核人<split2>审核时间<split2>检项目名称<split2>标本类型<split2>婴儿序号<split2> 
  --                   指标1<split4>检验结果1<split4>单位1<split4>结果标志1<split4>结果参数1<split4>排列序号1<split4>隐私项目1<split4>指标代码1<split3>
  --                   指标2<split4>检验结果2<split4>单位2<split4>结果标志2<split4>结果参数2<split4>排列序号2<split4>隐私项目2<split4>指标代码2<split3>
  --                   指标3<split4>检验结果3<split4>单位3<split4>结果标志3<split4>结果参数3<split4>排列序号3<split4>隐私项目3<split4>指标代码3<split2>
  
  --
  --               类型(2=微生物)<split2>申请ID<split2>病人来源<split2>报告时间<split2>报告人<split2>审核人<split2>审核时间<split2>检项目名称<split2>标本类型<split2>婴儿序号
  --               <split2> 采样人<S>采样时间<S>样本条码<S>标本序号<S>标本类型<S>核收人<S>核收时间<S>检验人<S>检验时间<S>审核人<S>审核时间<S>检验评语<S>检验备注<split2>
  --               细菌名1<split3>描述1<split3>耐药机制1<split3>
  --                   抗生素1<split4>抗生素结果1<split4>耐药性1<split4>药敏方法1<split4>用法用量11<split4>用法用量21<split4>血药浓度11<split4>血药浓度21<split4>尿药浓度11<split4>尿药浓度21<split3>
  --                   抗生素2<split4>抗生素结果2<split4>耐药性2<split4>药敏方法2<split4>用法用量12<split4>用法用量22<split4>血药浓度12<split4>血药浓度22<split4>尿药浓度12<split4>尿药浓度22<split2>
  --               细菌名2<split3>描述2<split3>耐药机制2<split3>
  --                   抗生素1<split4>抗生素结果1<split4>耐药性1<split4>药敏方法1<split4>用法用量11<split4>用法用量21<split4>血药浓度11<split4>血药浓度21<split4>尿药浓度11<split4>尿药浓度21<split3>
  --                   抗生素2<split4>抗生素结果2<split4>耐药性2<split4>药敏方法2<split4>用法用量12<split4>用法用量22<split4>血药浓度12<split4>血药浓度22<split4>尿药浓度12<split4>尿药浓度22
  --               intType 0=审核 1=取消审核
) Is
  n_Patiid     病人医嘱记录.病人id%Type;
  n_Pageid     电子病历记录.主页id%Type;
  n_Orderid    病人医嘱记录.Id%Type;
  n_Deptid     病人医嘱记录.开嘱科室id%Type;
  n_Patifrom   病人医嘱记录.病人来源%Type;
  n_Babytag    病人医嘱记录.婴儿%Type;
  v_Creator    电子病历记录.创建人%Type;
  d_Creator    电子病历记录.创建时间%Type;
  v_Speaker    电子病历记录.保存人%Type;
  d_Speaker    电子病历记录.完成时间%Type;
  n_Fileid     病历文件列表.Id%Type;
  v_Filename   病历文件列表.名称%Type;
  n_父id       电子病历内容.父id%Type;
  n_Recordid   电子病历内容.文件id%Type;
  n_Nextid     电子病历内容.Id%Type;
  n_l          Number := 0;
  n_No         Number := 0;
  v_Content    电子病历内容.内容文本%Type;
  v_Reporttag  Number;
  n_Reporttype Number;
  v_Stritems   Varchar2(4000);
  v_List       Varchar2(4000);
  n_i          Number;
  v_Listtype   Varchar2(6);
  v_Lisitem    Varchar2(4000);
  v_Newlis     Varchar2(4000);
  Cursor v_Source Is
    Select ID, 文件id, Nvl(父id, 0) As 父id, 对象序号, 对象类型, 对象标记, 保留对象, 对象属性, 内容行次, 内容文本, 是否换行, 替换域, 要素名称
    From 病历文件结构
    Where 文件id = n_Fileid
    Order By 对象序号;
  Function v_Split
  (
    p_String    Varchar2,
    p_Separator Varchar2,
    p_Element   Integer
  ) Return Varchar2 As
    --实现VB的Split功能
    --返回在p_String中以p_Separator为分隔的第p_Element个元素串
    --第N个是从第一个开始计
    v_String Varchar2(32767);
  Begin
    v_String := p_String || p_Separator;
    For I In 1 .. p_Element - 1 Loop
      v_String := Substr(v_String, Instr(v_String, p_Separator) + Length(p_Separator));
    End Loop;
    Return Substr(v_String, 1, Instr(v_String, p_Separator) - 1);
  Exception
    When Others Then
      Return Null;
  End v_Split;
Begin

  v_Lisitem := '采样人,采样时间,样本条码,标本序号,标本类型,核收人,核收时间,检验人,检验时间,审核人,审核时间,检验评语,检验备注,单位名称';
  --               类型(1=普通)<split2>申请ID<split2>病人来源<split2>报告时间<split2>报告人<split2>审核人<split2>审核时间<split2>检项目名称<split2>标本类型<split2>婴儿序号
  --                   <split2> 采样人<S>采样时间<S>样本条码<S>标本序号<S>标本类型<S>核收人<S>核收时间<S>检验人<S>检验时间<S>审核人<S>审核时间<S>检验评语<S>检验备注<split2>
  --类型(2=微生物)<split2>申请ID<split2>病人来源<split2>报告时间<split2>报告人<split2>审核人<split2>审核时间<split2>检项目名称<split2>标本类型
  n_Reporttype := v_Split(v_Strval, '<split2>', 1);
  n_Orderid    := v_Split(v_Strval, '<split2>', 2);
  n_Patifrom   := v_Split(v_Strval, '<split2>', 3);
  v_Creator    := v_Split(v_Strval, '<split2>', 5);
  v_Speaker    := v_Split(v_Strval, '<split2>', 6);
  d_Creator    := To_Date(v_Split(v_Strval, '<split2>', 4), 'yyyy-mm-dd HH24:mi:ss');
  d_Speaker    := To_Date(v_Split(v_Strval, '<split2>', 7), 'yyyy-mm-dd HH24:mi:ss');
  --读取病人相关信息
  Select Nvl(主页id, 0), Nvl(病人id, 0), Nvl(开嘱科室id, 0), Nvl(婴儿, 0)
  Into n_Pageid, n_Patiid, n_Deptid, n_Babytag
  From 病人医嘱记录
  Where ID = n_Orderid;
  If n_Patifrom = 1 Then
    --主页ID： 门诊病人填挂号ID
    Select Nvl(b.Id, 0)
    Into n_Pageid
    From 病人挂号记录 B, 病人医嘱记录 A
    Where a.挂号单 = b.No(+) And a.Id = n_Orderid  And b.记录状态 = 1;
  End If;

  Begin
    Select 病历文件id, c.名称
    Into n_Fileid, v_Filename
    From 病人医嘱记录 A, 病历单据应用 B, 病历文件列表 C
    Where a.诊疗项目id = b.诊疗项目id And b.病历文件id = c.Id And a.相关id = n_Orderid And b.应用场合 = n_Patifrom And Rownum <= 1;
  Exception
    When Others Then
      Return;
  End;

  --删除以前的报告记录
  --删除以前的报告记录
  Select Nvl(Max(病历id), 0) Into n_Recordid From 病人医嘱报告 Where 医嘱id = n_Orderid;

  If n_Begin = 0 Then
    If n_Recordid > 0 Then
      Delete 报告查阅记录 Where 医嘱id = n_Orderid;
      Delete 病人医嘱报告 Where 医嘱id = n_Orderid;
      Delete 电子病历记录 Where ID = n_Recordid;
      Delete 电子病历内容 Where 文件id = n_Recordid;
    End If;
  Else
    For r_Source In v_Source Loop
    
      v_Reporttag := 0;
    
      If r_Source.对象类型 = 1 And r_Source.内容文本 = '检验结果' Then
        Select ID
        Into n_Nextid
        From 电子病历内容
        Where 文件id = n_Recordid And 内容文本 = '检验结果' And 对象标记 = r_Source.对象标记 And 对象类型 = r_Source.对象类型;
      
        Select Max(对象序号) Into n_No From 电子病历内容 Where 文件id = n_Recordid;
      
        v_Reporttag := 1;
      
      End If;
    
      If v_Reporttag = 1 Then
        --在 '检验结果' 提纲下插入检验结果
        n_父id := n_Nextid;
        If n_Reporttype = 1 Then
          --取出每组指标集,直到为空时退出循环
          v_Stritems := v_Split(v_Strval, '<split2>', 11);
          For n_l In 1 .. 999 Loop
            v_List := v_Split(v_Stritems, '<split3>', n_l);
            Exit When v_List Is Null;
            n_No := n_No + 1;
            Select 电子病历内容_Id.Nextval Into n_Nextid From Dual;
            v_Content := RPad(Nvl(v_Split(v_List, '<split4>', 1), ' '), 35) ||
                         RPad(Nvl(v_Split(v_List, '<split4>', 2), ' '), 10) ||
                         LPad(Nvl(v_Split(v_List, '<split4>', 3), ' '), 8) ||
                         LPad(Nvl(v_Split(v_List, '<split4>', 4), ' '), 10) ||
                         LPad(Nvl(v_Split(v_List, '<split4>', 5), ' '), 13);
            Insert Into 电子病历内容
              (ID, 文件id, 开始版, 终止版, 父id, 对象序号, 对象类型, 对象标记, 保留对象, 对象属性, 内容行次, 内容文本, 是否换行)
            Values
              (n_Nextid, n_Recordid, 1, 0, n_父id, n_No, 2, n_No, Null, 0, Null, v_Content, 1);
          End Loop;
        Else
          --微生物标本
          n_父id := n_Nextid;
        
          --取得每组细菌指标结果集,直到为空时退出循环,位于第10个开始
          For n_i In 10 .. 999 Loop
            v_Stritems := v_Split(v_Strval, '<split2>', n_i);
            Exit When v_Stritems Is Null;
            --取出每组抗生素指标结果串,直到为空时退出循环,位于第4个开始
            For n_l In 4 .. 999 Loop
              v_List := v_Split(v_Stritems, '<split3>', n_l);
              Exit When v_List Is Null;
              n_No      := n_No + 1;
              v_Content := RPad(Nvl(v_Split(v_List, '<split4>', 1), ' '), 20) ||
                           RPad(Nvl(v_Split(v_List, '<split4>', 2), ' '), 5) ||
                           RPad(Nvl(v_Split(v_List, '<split4>', 3), ' '), 12) ||
                           RPad(Nvl(v_Split(v_List, '<split4>', 5), ' '), 12) ||
                           RPad(Nvl(v_Split(v_List, '<split4>', 7), ' '), 7) ||
                           RPad(Nvl(v_Split(v_List, '<split4>', 9), ' '), 7);
              Select 电子病历内容_Id.Nextval Into n_Nextid From Dual;
              Insert Into 电子病历内容
                (ID, 文件id, 开始版, 终止版, 父id, 对象序号, 对象类型, 对象标记, 保留对象, 对象属性, 内容行次, 内容文本, 是否换行)
              Values
                (n_Nextid, n_Recordid, 1, 0, n_父id, n_No, 2, n_No, Null, 0, Null, v_Content, 1);
            End Loop;
          End Loop;
        End If;
      End If;
    End Loop;
  End If;

  If n_Type = 1 Or n_Begin > 0 Then
    --取消审核
    Return;
  End If;

  ----生成新电子病历记录、医嘱报告关联
  Select 电子病历记录_Id.Nextval Into n_Recordid From Dual;
  Insert Into 电子病历记录
    (ID, 病人来源, 病人id, 主页id, 婴儿, 科室id, 病历种类, 文件id, 病历名称, 创建人, 创建时间, 完成时间, 保存人, 保存时间, 最后版本, 签名级别)
  Values
    (n_Recordid, n_Patifrom, n_Patiid, n_Pageid, n_Babytag, n_Deptid, 7, n_Fileid, v_Filename, v_Creator, d_Creator,
     d_Speaker, v_Speaker, Sysdate, 1, 0);
  Insert Into 病人医嘱报告 (医嘱id, 病历id) Values (n_Orderid, n_Recordid);

  For r_Source In v_Source Loop
    n_No := n_No + 1;
    Select 电子病历内容_Id.Nextval Into n_Nextid From Dual;
    v_Reporttag := 0;
  
    If r_Source.对象类型 = 4 And Instr(v_Lisitem, r_Source.要素名称) > 0 Then
      If r_Source.要素名称 = '采样人' Then
        v_Newlis := v_Split(v_Lisiteminto, '<S>', 1);
      Elsif r_Source.要素名称 = '采样时间' Then
        v_Newlis := v_Split(v_Lisiteminto, '<S>', 2);
      Elsif r_Source.要素名称 = '样本条码' Then
        v_Newlis := v_Split(v_Lisiteminto, '<S>', 3);
      Elsif r_Source.要素名称 = '标本序号' Then
        v_Newlis := v_Split(v_Lisiteminto, '<S>', 4);
      Elsif r_Source.要素名称 = '标本类型' Then
        v_Newlis := v_Split(v_Lisiteminto, '<S>', 5);
      Elsif r_Source.要素名称 = '核收人' Then
        v_Newlis := v_Split(v_Lisiteminto, '<S>', 6);
      Elsif r_Source.要素名称 = '核收时间' Then
        v_Newlis := v_Split(v_Lisiteminto, '<S>', 7);
      Elsif r_Source.要素名称 = '检验人' Then
        v_Newlis := v_Split(v_Lisiteminto, '<S>', 8);
      Elsif r_Source.要素名称 = '检验时间' Then
        v_Newlis := v_Split(v_Lisiteminto, '<S>', 9);
      Elsif r_Source.要素名称 = '审核人' Then
        v_Newlis := v_Split(v_Lisiteminto, '<S>', 10);
      Elsif r_Source.要素名称 = '审核时间' Then
        v_Newlis := v_Split(v_Lisiteminto, '<S>', 11);
      Elsif r_Source.要素名称 = '检验评语' Then
        v_Newlis := v_Split(v_Lisiteminto, '<S>', 12);
      Elsif r_Source.要素名称 = '检验备注' Then
        v_Newlis := v_Split(v_Lisiteminto, '<S>', 13);
      Else
        v_Newlis := Null;
      End If;
      Insert Into 电子病历内容
        (ID, 文件id, 开始版, 终止版, 父id, 对象序号, 对象类型, 对象标记, 保留对象, 对象属性, 内容行次, 内容文本, 是否换行)
      Values
        (n_Nextid, n_Recordid, 1, 0, Null, n_No, 2, r_Source.对象标记, r_Source.保留对象, r_Source.对象属性, r_Source.内容行次,
         v_Newlis, r_Source.是否换行);
    
    Elsif r_Source.对象类型 = 4 And r_Source.替换域 = 1 Then
      Select Zl_Replace_Element_Value(r_Source.要素名称, n_Patiid, n_Pageid, n_Patifrom, n_Orderid)
      Into v_Content
      From Dual;
      Insert Into 电子病历内容
        (ID, 文件id, 开始版, 终止版, 父id, 对象序号, 对象类型, 对象标记, 保留对象, 对象属性, 内容行次, 内容文本, 是否换行)
      Values
        (n_Nextid, n_Recordid, 1, 0, Null, n_No, r_Source.对象类型, r_Source.对象标记, r_Source.保留对象, r_Source.对象属性,
         r_Source.内容行次, v_Content, r_Source.是否换行);
    
    Elsif r_Source.对象类型 = 1 And r_Source.内容文本 = '检验结果' Then
      Insert Into 电子病历内容
        (ID, 文件id, 开始版, 终止版, 父id, 对象序号, 对象类型, 对象标记, 保留对象, 对象属性, 内容行次, 内容文本, 是否换行)
      Values
        (n_Nextid, n_Recordid, 1, 0, Null, n_No, r_Source.对象类型, r_Source.对象标记, r_Source.保留对象, r_Source.对象属性,
         r_Source.内容行次, r_Source.内容文本, r_Source.是否换行);
      v_Reporttag := 1;
    Else
      Insert Into 电子病历内容
        (ID, 文件id, 开始版, 终止版, 父id, 对象序号, 对象类型, 对象标记, 保留对象, 对象属性, 内容行次, 内容文本, 是否换行)
      Values
        (n_Nextid, n_Recordid, 1, 0, Null, n_No, r_Source.对象类型, r_Source.对象标记, r_Source.保留对象, r_Source.对象属性,
         r_Source.内容行次, r_Source.内容文本, r_Source.是否换行);
    End If;
  
    If v_Reporttag = 1 Then
      --在 '检验结果' 提纲下插入检验结果
      n_父id := n_Nextid;
      If n_Reporttype = 1 Then
        --普通标本
        n_No := n_No + 1;
        Select 电子病历内容_Id.Nextval Into n_Nextid From Dual;
        v_Content := RPad('检验项目', 35) || RPad('检验结果', 10) || LPad('单位', 8) || LPad('结果标志', 10) || LPad('结果参考', 13);
        Insert Into 电子病历内容
          (ID, 文件id, 开始版, 终止版, 父id, 对象序号, 对象类型, 对象标记, 保留对象, 对象属性, 内容行次, 内容文本, 是否换行)
        Values
          (n_Nextid, n_Recordid, 1, 0, n_父id, n_No, 2, n_No, Null, 0, Null, v_Content, 1);
        --取出每组指标集,直到为空时退出循环
        v_Stritems := v_Split(v_Strval, '<split2>', 11);
        For n_l In 1 .. 999 Loop
          v_List := v_Split(v_Stritems, '<split3>', n_l);
          Exit When v_List Is Null;
          n_No := n_No + 1;
          Select 电子病历内容_Id.Nextval Into n_Nextid From Dual;
          v_Content := RPad(Nvl(v_Split(v_List, '<split4>', 1), ' '), 35) ||
                       RPad(Nvl(v_Split(v_List, '<split4>', 2), ' '), 10) ||
                       LPad(Nvl(v_Split(v_List, '<split4>', 3), ' '), 8) ||
                       LPad(Nvl(v_Split(v_List, '<split4>', 4), ' '), 10) ||
                       LPad(Nvl(v_Split(v_List, '<split4>', 5), ' '), 13);
          Insert Into 电子病历内容
            (ID, 文件id, 开始版, 终止版, 父id, 对象序号, 对象类型, 对象标记, 保留对象, 对象属性, 内容行次, 内容文本, 是否换行)
          Values
            (n_Nextid, n_Recordid, 1, 0, n_父id, n_No, 2, n_No, Null, 0, Null, v_Content, 1);
        End Loop;
      Else
        --微生物标本
        n_父id := n_Nextid;
      
        --取得每组细菌指标结果集,直到为空时退出循环,位于第10个开始
        For n_i In 10 .. 999 Loop
          v_Stritems := v_Split(v_Strval, '<split2>', n_i);
          Exit When v_Stritems Is Null;
          n_No := n_No + 1;
        
          v_Content  := '       鉴定结果：' || v_Split(v_Stritems, '<split3>', 1) || v_Split(v_Stritems, '<split3>', 2) ||
                        v_Split(v_Stritems, '<split3>', 3) || Chr(13) || Chr(10);
          v_Content  := v_Content || '       抗生素          ';
          v_Listtype := v_Split(v_Stritems, '<split4>', 4);
          Select v_Content || RPad(Decode(v_Listtype, '1-MIC', '  MIC', '2-Disk', ' Disk', '3-K-B', '  K-B', ' '), 5)
          Into v_Content
          From Dual;
          v_Content := v_Content || RPad('耐药性', 12) || RPad('用法用量', 12) || RPad('血药浓度', 7) || RPad('尿药浓度', 7) ||
                       Chr(13) || Chr(10);
          v_Content := v_Content || Replace(RPad(' ', 47, '￣'), ' ', '￣');
          Select 电子病历内容_Id.Nextval Into n_Nextid From Dual;
          Insert Into 电子病历内容
            (ID, 文件id, 开始版, 终止版, 父id, 对象序号, 对象类型, 对象标记, 保留对象, 对象属性, 内容行次, 内容文本, 是否换行)
          Values
            (n_Nextid, n_Recordid, 1, 0, n_父id, n_No, 2, n_No, Null, 0, Null, v_Content, 1);
        
          --取出每组抗生素指标结果串,直到为空时退出循环,位于第4个开始
          For n_l In 4 .. 999 Loop
            v_List := v_Split(v_Stritems, '<split3>', n_l);
            Exit When v_List Is Null;
            n_No      := n_No + 1;
            v_Content := RPad(Nvl(v_Split(v_List, '<split4>', 1), ' '), 20) ||
                         RPad(Nvl(v_Split(v_List, '<split4>', 2), ' '), 5) ||
                         RPad(Nvl(v_Split(v_List, '<split4>', 3), ' '), 12) ||
                         RPad(Nvl(v_Split(v_List, '<split4>', 5), ' '), 12) ||
                         RPad(Nvl(v_Split(v_List, '<split4>', 7), ' '), 7) ||
                         RPad(Nvl(v_Split(v_List, '<split4>', 9), ' '), 7);
            Select 电子病历内容_Id.Nextval Into n_Nextid From Dual;
            Insert Into 电子病历内容
              (ID, 文件id, 开始版, 终止版, 父id, 对象序号, 对象类型, 对象标记, 保留对象, 对象属性, 内容行次, 内容文本, 是否换行)
            Values
              (n_Nextid, n_Recordid, 1, 0, n_父id, n_No, 2, n_No, Null, 0, Null, v_Content, 1);
          End Loop;
        End Loop;
      End If;
    End If;
  End Loop;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_检验报告单_Apply;
/

--113698:胡俊勇,2017-10-19,病人图标设置
Create Or Replace Procedure Zl_病区自动标记_Update
(
  病人id_In In 病案主页.病人id%Type,
  主页id_In In 病案主页.当前病区id%Type
) Is
  v_Sex      Varchar2(10);
  n_Index    Number(2);
  n_Cnt      Number;
  n_病区id   病人信息.当前病区id%Type;
  d_日期     Date;
  n_标记顺序 病区标记记录.标记顺序%Type;
  n_主题序号 病区标记内容.主题序号%Type;
  n_标记序号 病区标记内容.标记序号%Type;
Begin
  Select 当前病区id Into n_病区id From 病案主页 A Where a.病人id = 病人id_In And a.主页id = 主页id_In;
  --没有设定婴儿图标的，说明不需要自动更新 
  Begin
    Select Count(*) Into n_Index From 病区标记内容 Where 病区id = n_病区id And 图形索引 In (1, 2);
  Exception
    When Others Then
      Return;
  End;
  If n_Index = 0 Then
    Return;
  End If;

  Select Count(*)
  Into n_Index
  From 病人新生儿记录 A
  Where a.主页id = 主页id_In And a.病人id = 病人id_In And Trunc(a.出生时间) = Trunc(Sysdate);
  If n_Index > 1 Then
    --多于1个婴儿，不更新标记 
    Return;
  Elsif n_Index = 0 Then
    --无婴儿，删除病区标记 
    Delete 病区标记记录
    Where 病区id = n_病区id And 病人id = 病人id_In And 主页id = 主页id_In And
          (病区id, 主题序号, 标记序号) In
          (Select 病区id, 主题序号, 标记序号 From 病区标记内容 Where 病区id = n_病区id And 图形索引 In (1, 2));
  Else
    Select a.婴儿性别, a.出生时间
    Into v_Sex, d_日期
    From 病人新生儿记录 A
    Where a.病人id = 病人id_In And a.主页id = 主页id_In And Trunc(a.出生时间) = Trunc(Sysdate);
  
    If v_Sex = '男' Then
      n_Index := 1;
    Else
      n_Index := 2;
    End If;
  
    Begin
      Select a.主题序号, a.标记序号
      Into n_主题序号, n_标记序号
      From 病区标记内容 A
      Where a.病区id = n_病区id And a.图形索引 = n_Index;
    Exception
      When Others Then
        Return;
    End;
  
    --如果3个图标已用完则不标记
    n_标记顺序 := 1;
    n_Cnt      := 0;
    For R In (Select a.标记顺序
              From 病区标记记录 A
              Where a.病人id = 病人id_In And a.主页id = 主页id_In And a.病区id = n_病区id) Loop
      n_Cnt := n_Cnt + 1;
      If n_标记顺序 = r.标记顺序 Then
        n_标记顺序 := n_标记顺序 + 1;
      End If;
    End Loop;
    If n_Cnt = 3 Then
      Return;
    End If;
  
    --标记录应该先删除再标记   
    Delete 病区标记记录
    Where 病区id = n_病区id And 病人id = 病人id_In And 主页id = 主页id_In And Nvl(主题病区id, 0) = n_病区id And 主题序号 = n_主题序号;
  
    --取一个顺序号  
    Insert Into 病区标记记录
      (病区id, 病人id, 主页id, 主题序号, 标记序号, 日期, 主题病区id, 标记顺序)
    Values
      (n_病区id, 病人id_In, 主页id_In, n_主题序号, n_标记序号, d_日期, n_病区id, n_标记顺序);
  End If;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_病区自动标记_Update;
/

--113698:胡俊勇,2017-10-19,病人图标设置
Create Or Replace Procedure Zl_病人新生儿记录_Insert
(
  病人id_In   病人新生儿记录.病人id%Type,
  主页id_In   病人新生儿记录.主页id%Type,
  序号_In     病人新生儿记录.序号%Type,
  婴儿姓名_In 病人新生儿记录.婴儿姓名%Type,
  婴儿性别_In 病人新生儿记录.婴儿性别%Type,
  分娩次数_In 病人新生儿记录.分娩次数%Type,
  分娩方式_In 病人新生儿记录.分娩方式%Type,
  胎儿状况_In 病人新生儿记录.胎儿状况%Type,
  出生时间_In 病人新生儿记录.出生时间%Type,
  身长_In     病人新生儿记录.身长%Type,
  体重_In     病人新生儿记录.体重%Type,
  血型_In     病人新生儿记录.血型%Type,
  备注说明_In 病人新生儿记录.备注说明%Type := Null
) Is
Begin
  Insert Into 病人新生儿记录
    (病人id, 主页id, 序号, 婴儿姓名, 婴儿性别, 分娩次数, 分娩方式, 胎儿状况, 身长, 体重, 血型, 出生时间, 备注说明)
  Values
    (病人id_In, 主页id_In, 序号_In, 婴儿姓名_In, 婴儿性别_In, 分娩次数_In, 分娩方式_In, 胎儿状况_In, 身长_In, 体重_In, 血型_In, 出生时间_In, 备注说明_In);

  Zl_病区自动标记_Update(病人id_In, 主页id_In);
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_病人新生儿记录_Insert;
/
--113698:胡俊勇,2017-10-19,病人图标设置
Create Or Replace Procedure Zl_病人新生儿记录_Delete
(
  病人id_In 病人新生儿记录.病人id%Type,
  主页id_In 病人新生儿记录.主页id%Type,
  序号_In   In 病人新生儿记录.序号%Type := Null
) Is
Begin
  If 序号_In Is Null Then
    Delete From 病人新生儿记录 Where 病人id = 病人id_In And 主页id = 主页id_In;
  Else
    Delete From 病人新生儿记录 Where 病人id = 病人id_In And 主页id = 主页id_In And 序号 = 序号_In;
  End If;
  Zl_病区自动标记_Update(病人id_In, 主页id_In);
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_病人新生儿记录_Delete;
/
--113698:胡俊勇,2017-10-19,病人图标设置
Create Or Replace Procedure Zl_病人变动记录_Inunit
(
  病人id_In     病案主页.病人id%Type,
  主页id_In     病案主页.主页id%Type,
  床号_In       Varchar2,
  病区id_In     病案主页.当前病区id%Type,
  护理等级id_In 病案主页.护理等级id%Type,
  当前病况_In   病案主页.当前病况%Type,
  是否陪伴_In   病案主页.是否陪伴%Type,
  责任护士_In   病案主页.责任护士%Type,
  入病区时间_In 病人变动记录.开始时间%Type,
  操作员编号_In 人员表.编号%Type,
  操作员姓名_In 人员表.姓名%Type,
  主床位_In     病案主页.出院病床%Type
) As
  -----------------------------------------------------------
  --说明：完成病人入病区处理
  --参数：
  --       床号_IN:为空表示家庭病床,否则为"床号1,床号2,...床号n",多个床号时,表示包房。
  -----------------------------------------------------------
  Cursor c_Oldinfo Is
    Select b.*
    From (Select c.*
           From 病人变动记录 C
           Where c.病人id = 病人id_In And c.主页id = 主页id_In And
                 c.开始时间 = (Select Min(开始时间)
                           From 病人变动记录
                           Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 入病区时间_In)) A, 病人变动记录 B
    
    Where b.病人id = 病人id_In And b.主页id = 主页id_In And a.开始时间 = b.终止时间 And a.开始原因 = b.终止原因 And a.附加床位 = b.附加床位
    Union
    Select *
    From 病人变动记录
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null And 开始时间 <= 入病区时间_In;
  Cursor c_Endinfo Is
    Select * From 病人变动记录 Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null;
  Cursor c_Futureinfo Is
    Select *
    From 病人变动记录
    Where 病人id = 病人id_In And 主页id = 主页id_In And 附加床位 = 0 And 开始时间 > 入病区时间_In;

  r_Futureinfo   c_Futureinfo %RowType;
  b_Isdel        Boolean;
  r_Endinfo      c_Endinfo%RowType;
  r_Oldinfo      c_Oldinfo%RowType;
  v_变动终止原因 病人变动记录.终止原因%Type;
  v_变动终止时间 病人变动记录.终止时间%Type;
  v_变动终止人员 病人变动记录.终止人员%Type;

  Cursor c_Bedinfo Is
    Select 病区id, 床号 From 床位状况记录 Where 病人id = 病人id_In;
  v_床号      Varchar2(255);
  v_当前床号  床位状况记录.床号%Type;
  v_等级id    床位状况记录.等级id%Type;
  v_病区id    病案主页.当前病区id%Type;
  v_科室id    病案主页.出院科室id%Type;
  v_终止人员  病人变动记录.终止人员%Type;
  n_Old病区id 病案主页.当前病区id%Type;
  v_Count     Number;
  Err_Custom Exception;
  v_Error Varchar2(255);
Begin
  Open c_Oldinfo; --必须先打开

  --入病区
  Select Count(*), Max(当前病区id)
  Into v_Count, n_Old病区id
  From 病案主页
  Where 病人id = 病人id_In And 主页id = 主页id_In And 状态 = 2;

  If v_Count = 0 Then
    v_Error := '病人当前不处于转病区状态,可能已经撤转病区，操作不能继续！' || Chr(13) || Chr(10) || '这可能是由于网络并发操作引起的，请刷新病人状态后再试！';
    Raise Err_Custom;
  End If;

  Begin
    Select 病区id, 操作员姓名
    Into v_病区id, v_终止人员
    From 病人变动记录
    Where 病人id = 病人id_In And 主页id = 主页id_In And 开始原因 = 15 And 开始时间 Is Null And 终止时间 Is Null;
  Exception
    When Others Then
      v_病区id := 0;
  End;
  --v_病区id=0说明病人可能是转科状态
  If v_病区id = 0 Then
    v_Error := '病人当前不处于转病区状态，而是处于转科状态，操作不能继续！' || Chr(13) || Chr(10) || '这可能是由于网络并发操作引起的，请刷新病人状态后再试！';
    Raise Err_Custom;
  End If;
  If v_病区id <> 病区id_In Then
    v_Error := '当前该病人即将入住的病区和变动记录中实际要入住病区不符,操作不能继续！' || Chr(13) || Chr(10) || '这可能是由于网络并发操作引起的，请刷新病人状态后再试！';
    Raise Err_Custom;
  End If;

  --产生新变动
  Fetch c_Oldinfo
    Into r_Oldinfo;
  Open c_Endinfo;
  Fetch c_Endinfo
    Into r_Endinfo;
  If c_Endinfo%RowCount = 0 Then
    Close c_Endinfo;
    v_Error := '未发现该病人当前有效的变动记录！';
    Raise Err_Custom;
  End If;

  --病案主页
  Update 病案主页
  Set 状态 = 0, 出院病床 = Decode(床号_In, Null, Null, 主床位_In), 当前病区id = 病区id_In, 护理等级id = Decode(护理等级id_In, 0, Null, 护理等级id_In),
      当前病况 = 当前病况_In, 责任护士 = 责任护士_In, 是否陪伴 = 是否陪伴_In
  Where 病人id = 病人id_In And 主页id = 主页id_In;

  --更新病人信息
  Update 病人信息
  Set 当前病区id = 病区id_In, 当前床号 = Decode(床号_In, Null, Null, 主床位_In)
  Where 病人id = 病人id_In;

  --更新在院病人
  v_科室id := 0;
  Begin
    Update 在院病人 Set 病区id = Nvl(病区id_In, 0) Where 病人id = 病人id_In;
    If Sql%RowCount = 0 Then
      Select 出院科室id Into v_科室id From 病案主页 Where 病人id = 病人id_In And 主页id = 主页id_In;
    End If;
  Exception
    When Others Then
      v_科室id := 0;
  End;
  If v_科室id > 0 Then
    Insert Into 在院病人 (病人id, 科室id, 病区id) Values (病人id_In, v_科室id, Nvl(病区id_In, 0));
  End If;

  --公共类型的图标复制一分
  For R In (Select a.病人id, a.主页id, a.主题序号, a.标记序号, a.标记顺序
            From 病区标记记录 A
            Where a.病区id = n_Old病区id And Nvl(a.主题病区id, 0) = 0 And a.病人id = 病人id_In And a.主页id = 主页id_In) Loop
    --标记录应该先删除再标记   
    Delete 病区标记记录
    Where 病区id = 病区id_In And 病人id = r.病人id And 主页id = r.主页id And Nvl(主题病区id, 0) = 0 And 主题序号 = r.主题序号;
    --取一个顺序号  
    Insert Into 病区标记记录
      (病区id, 病人id, 主页id, 主题序号, 标记序号, 日期, 主题病区id, 标记顺序)
    Values
      (病区id_In, r.病人id, r.主页id, r.主题序号, r.标记序号, Sysdate, Null, r.标记顺序);
  End Loop;

  --退除病人当前床位
  For r_Bedrow In c_Bedinfo Loop
    Update 床位状况记录
    Set 状态 = '空床', 病人id = Null, 科室id = Decode(共用, 1, Null, 科室id)
    Where 病区id = r_Bedrow.病区id And 床号 = r_Bedrow.床号;
  End Loop;

  --记录上一步的终止操作人员
  If r_Oldinfo.终止时间 Is Not Null Then
    v_变动终止时间 := r_Oldinfo.终止时间;
    v_变动终止原因 := r_Oldinfo.终止原因;
    v_变动终止人员 := r_Oldinfo.终止人员;
    --取消上次变动
    Update 病人变动记录
    Set 终止时间 = 入病区时间_In, 终止原因 = 15, 终止人员 = v_终止人员, 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 = v_变动终止时间 And 终止原因 = v_变动终止原因;
    --更新将来的记录如果有停止到将来的则删除上次计算时间
    Update 病人变动记录
    Set 上次计算时间 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 入病区时间_In;
  Else
    Update 病人变动记录
    Set 终止时间 = 入病区时间_In, 终止原因 = 15, 终止人员 = v_终止人员,
        上次计算时间 = Decode(Sign(Nvl(上次计算时间, 入病区时间_In) - 入病区时间_In), 1, Null, 上次计算时间)
    Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 Is Not Null And 终止时间 Is Null;
  End If;

  Delete From 病人变动记录
  Where 病人id = 病人id_In And 主页id = 主页id_In And 开始原因 = 15 And 开始时间 Is Null And 终止时间 Is Null;

  --新的床位记录
  If 床号_In Is Null Then
    --仅家庭病床
    Insert Into 病人变动记录
      (ID, 病人id, 主页id, 开始时间, 开始原因, 附加床位, 病区id, 科室id, 医疗小组id, 护理等级id, 床位等级id, 床号, 责任护士, 经治医师, 主治医师, 主任医师, 病情, 操作员编号,
       操作员姓名, 终止时间, 终止原因, 终止人员)
    Values
      (病人变动记录_Id.Nextval, 病人id_In, 主页id_In, 入病区时间_In, 15, 0, 病区id_In, r_Oldinfo.科室id, r_Oldinfo.医疗小组id,
       Decode(护理等级id_In, 0, Null, 护理等级id_In), Null, Null, 责任护士_In, r_Oldinfo.经治医师, r_Oldinfo.主治医师, r_Oldinfo.主任医师,
       当前病况_In, 操作员编号_In, 操作员姓名_In, v_变动终止时间, v_变动终止原因, v_变动终止人员);
    --如果修改了床位，则必须修改停止到将来的变动数
    If c_Oldinfo%RowCount <> 1 Then
      --删除所有将来的附加床位的变动
      Delete From 病人变动记录
      Where 病人id = 病人id_In And 主页id = 主页id_In And 附加床位 = 1 And 开始时间 > 入病区时间_In;
    End If;
    --如果有停到将来的情况，将将来的变动信息同步更新(附加床位和主床位记录不相同的字段。)
    Update 病人变动记录
    Set 床位等级id = Null, 床号 = Null
    Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 入病区时间_In;
  Else
    v_床号  := 床号_In || ',';
    v_Count := 0;
    While v_床号 Is Not Null Loop
      v_Count := v_Count + 1;
      v_床号  := Substr(v_床号, Instr(v_床号, ',') + 1);
    End Loop;
    --如果修改了床位，则必须修改停止到将来的变动数
    b_Isdel := False;
    If c_Oldinfo%RowCount <> v_Count Then
      --删除所有将来的附加床位的变动
      Delete From 病人变动记录
      Where 病人id = 病人id_In And 主页id = 主页id_In And 附加床位 = 1 And 开始时间 > 入病区时间_In;
      b_Isdel := True;
    End If;
  
    v_Count := 0;
    v_床号  := 床号_In || ',';
  
    While v_床号 Is Not Null Loop
      v_当前床号 := Substr(v_床号, 1, Instr(v_床号, ',') - 1);
      Select 等级id Into v_等级id From 床位状况记录 Where 病区id = 病区id_In And 床号 = v_当前床号;
    
      Insert Into 病人变动记录
        (ID, 病人id, 主页id, 开始时间, 开始原因, 附加床位, 病区id, 科室id, 医疗小组id, 护理等级id, 床位等级id, 床号, 责任护士, 经治医师, 主治医师, 主任医师, 病情, 操作员编号,
         操作员姓名, 终止时间, 终止原因, 终止人员)
      Values
        (病人变动记录_Id.Nextval, 病人id_In, 主页id_In, 入病区时间_In, 15, Decode(主床位_In, v_当前床号, 0, 1), 病区id_In, r_Oldinfo.科室id,
         r_Oldinfo.医疗小组id, Decode(护理等级id_In, 0, Null, 护理等级id_In), v_等级id, v_当前床号, 责任护士_In, r_Oldinfo.经治医师,
         r_Oldinfo.主治医师, r_Oldinfo.主任医师, 当前病况_In, 操作员编号_In, 操作员姓名_In, v_变动终止时间, v_变动终止原因, v_变动终止人员);
    
      Select Count(*) Into v_Count From 床位状况记录 Where 病区id = 病区id_In And 床号 = v_当前床号 And 状态 = '空床';
    
      If v_Count = 0 Then
        v_Error := '操作失败,床位 ' || v_当前床号 || ' 不是空床！';
        Raise Err_Custom;
      End If;
    
      Update 床位状况记录
      Set 状态 = '占用', 病人id = 病人id_In, 科室id = Decode(共用, 1, r_Oldinfo.科室id, 科室id)
      Where 病区id = 病区id_In And 床号 = v_当前床号;
    
      If b_Isdel = True Then
        --如果有停到将来的情况且有床位数变动,将将来的变动信息同步更新(附加床位和主床位记录不相同的字段。)和插入附加床位数据。
        If 主床位_In = v_当前床号 Then
          --如果是主床位则修改将来的主记录信息，如果不是主床位，就新插入数据
          Update 病人变动记录
          Set 床位等级id = v_等级id, 床号 = v_当前床号
          Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 入病区时间_In And 附加床位 = 0;
        Else
          Open c_Futureinfo; --必须先打开
          Fetch c_Futureinfo
            Into r_Futureinfo;
          --循环停到将来的数据，进行附加床位插入
          While c_Futureinfo%Found Loop
            Insert Into 病人变动记录
              (ID, 病人id, 主页id, 开始时间, 开始原因, 附加床位, 科室id, 医疗小组id, 床位等级id, 床号, 经治医师, 主治医师, 主任医师, 操作员编号, 操作员姓名, 终止时间, 终止原因,
               终止人员)
            Values
              (病人变动记录_Id.Nextval, r_Futureinfo.病人id, r_Futureinfo.主页id, r_Futureinfo.开始时间, r_Futureinfo.开始原因, 1,
               r_Futureinfo.科室id, r_Futureinfo.医疗小组id, v_等级id, v_当前床号, r_Futureinfo.经治医师, r_Futureinfo.主治医师,
               r_Futureinfo.主任医师, r_Futureinfo.操作员编号, r_Futureinfo.操作员姓名, r_Futureinfo.终止时间, r_Futureinfo.终止原因,
               r_Futureinfo.终止人员);
            Fetch c_Futureinfo
              Into r_Futureinfo;
          End Loop;
          Close c_Futureinfo;
        End If;
      End If;
    
      v_床号  := Substr(v_床号, Instr(v_床号, ',') + 1);
      v_Count := v_Count + 1;
    End Loop;
  End If;
  --如果有停到将来的情况，将将来的变动信息同步更新（附加床位的记录和主记录相同的字段）
  Update 病人变动记录
  Set 病区id = 病区id_In, 责任护士 = 责任护士_In, 护理等级id = Decode(护理等级id_In, 0, Null, 护理等级id_In), 病情 = 当前病况_In
  Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > 入病区时间_In;
  Close c_Oldinfo;
  Close c_Endinfo;
  --对有效的医嘱(未停止、作废的长嘱，未发送的临嘱)，为原病区执行的，将执行科室自动更换为新的病区
  Update 病人医嘱记录
  Set 执行科室id = 病区id_In
  Where 病人id = 病人id_In And 主页id = 主页id_In And 执行科室id = r_Oldinfo.病区id And 医嘱状态 Not In (4, 8, 9);
  --对未审核的记帐划价单，为原病区执行的，将执行科室自动更换为新的病区
  Update 住院费用记录
  Set 执行部门id = 病区id_In
  Where 病人id = 病人id_In And 主页id = 主页id_In And 执行部门id = r_Oldinfo.病区id And 记录状态 = 0;
  --已发送且未执行且未记帐审核或未收费的医嘱发送记录，如果执行科室是原病区的，应更新为当前病区
  Update 病人医嘱发送 A
  Set a.执行部门id = 病区id_In
  Where a.执行部门id = r_Oldinfo.病区id And a.执行状态 = 0 And Exists
   (Select 1
         From 住院费用记录 B
         Where a.No = b.No And a.记录性质 = b.记录性质 And b.记录状态 = 0 And 病人id = 病人id_In And 主页id = 主页id_In);

  --并发操作检查
  Select Count(*)
  Into v_Count
  From 病人变动记录
  Where 病人id = 病人id_In And 主页id = 主页id_In And Nvl(附加床位, 0) = 0 And 开始时间 Is Not Null And 终止时间 Is Null;

  If v_Count > 1 Then
    v_Error := '发现病人存在非法的变动记录,当前操作不能继续！' || Chr(13) || Chr(10) || '这可能是由于网络并发操作引起的,请刷新病人状态后再试！';
    Raise Err_Custom;
  End If;

Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_病人变动记录_Inunit;
/

--109972:黄捷,2017-10-18,报告文档编辑器锁定报告
Create Or Replace Package b_Pacs_Rptpluginoriginal Is
  Type t_Refcur Is Ref Cursor;

  -- 1、功    能：获取历史报告记录
  Procedure p_Getreporthistory
  (
    Val                   Out t_Refcur,
    医嘱id_In             In 病人医嘱记录.Id%Type,
    人员id_In             In 部门人员.人员id%Type,
    当前科室id_In         In 部门人员.部门id%Type,
    查看其他科历史报告_In In Number := 0
  );

  --2、功    能：获取对应报告内容
  Procedure p_Getreportcontent
  (
    Val           Out t_Refcur,
    报告id_In     In Varchar2,
    Editortype_In Number := 0 --0:PACS报告编辑器，1--电子病历编辑器，2--报告文档编辑器
  );

  --3、功    能：根据医嘱ID获取检查信息
  Procedure p_Getstudyinfobyadviceid
  (
    Val       Out t_Refcur,
    医嘱id_In In 影像检查记录.医嘱id%Type
  );

  --4、功    能：获取报告图像总数
  Procedure p_Getreportimagecount
  (
    Val         Out t_Refcur,
    查询条件_In In Varchar2
  );

  --5、功    能：获取报告图像数据
  Procedure p_Getreportimagedata
  (
    Val         Out t_Refcur,
    查询条件_In In Varchar2,
    开始位置_In In Number,
    结束位置_In In Number
  );

  --6、功    能：获取预览图像总数
  Procedure p_Getstudyimagecount
  (
    Val         Out t_Refcur,
    查询条件_In In Varchar2,
    是否临时_In In Number := 0
  );

  --7、功    能：获取预览图像数据
  Procedure p_Getstudyimagedata
  (
    Val         Out t_Refcur,
    查询方式_In In Varchar2,
    查询条件_In In Varchar2,
    开始位置_In In Number,
    结束位置_In In Number,
    是否临时_In In Number
  );

  --8、功能：获取临时图像序列
  Procedure p_Get_Tempimageseries
  (
    Val         Out t_Refcur,
    时间范围_In In Number,
    姓名_In     In 影像临时记录.姓名%Type := Null
  );

  --9、功能;获取图像备注
  Procedure p_Get_Normalnote(Val Out t_Refcur);

  --10、功能：插入常用图像备注
  Procedure p_Insert_Normalnote
  (
    Note_In In 影像字典内容.名称%Type,
    Code_In 影像字典内容.简码%Type
  );

  --11、功能：修改常用图像备注
  Procedure p_Edit_Normalnote
  (
    Note_In In 影像字典内容.名称%Type,
    Num_In  影像字典内容.编号%Type
  );

  --12、功能：删除常用图像备注
  Procedure p_Del_Normalnote(Num_In 影像字典内容.编号%Type);

  --13、功能：获取备注的下一个编码
  Procedure p_Get_Normalnum(Val Out t_Refcur);
  --14、功能：获取插件ID
  Procedure p_Get_Plugid
  (
    Val     Out t_Refcur,
    类名_In In 影像报告插件.类名%Type
  );

  --15、功能：插入编辑器字体参数
  Procedure p_Setfontparam
  (
    Font_In Nvarchar2,
    User_In Nvarchar2
  );

  --16、功能：获取编辑器字体参数
  Procedure p_Getfontparam
  (
    Val     Out t_Refcur,
    User_In Nvarchar2
  );

  --17、功能：插入编辑器窗体参数
  Procedure p_Setformparam
  (
    Form_In Nvarchar2,
    User_In Nvarchar2
  );

  --18、功能：获取编辑器字体参数
  Procedure p_Getformparam
  (
    Val     Out t_Refcur,
    User_In Nvarchar2
  );

  --19、功能：根据图像UID获取检查信息
  Procedure p_Getstudyinfobyimageuid
  (
    Val        Out t_Refcur,
    医嘱id_In  In 影像检查记录.医嘱id%Type,
    图像uid_In In 影像检查图象.图像uid%Type
  );

  --20、功能：根据检查UID获取FTP信息
  Procedure p_Getftpinfobystudyuid
  (
    Val        Out t_Refcur,
    检查uid_In In 影像检查记录.检查uid%Type
  );

  --21、功能：根据科室ID获取FTP信息
  Procedure p_Getftpinfobydeptid
  (
    Val       Out t_Refcur,
    科室id_In In 影像流程参数.科室id%Type
  );

  --22、功能：根据医嘱ID获取FTP信息
  Procedure p_Getftpinfobyadvicetid
  (
    Val       Out t_Refcur,
    医嘱id_In In 影像检查记录.医嘱id%Type
  );

  --23、功能：获取检查UID
  Procedure p_Getstudyuid
  (
    Val        Out t_Refcur,
    检查uid_In In 影像检查记录.检查uid%Type
  );

  --24、功能：获取序列UID
  Procedure p_Getseriesuid
  (
    Val        Out t_Refcur,
    序列uid_In In 影像检查序列.序列uid%Type
  );

  --25、功能：根据设备号获取设备信息
  Procedure p_Getdeviceinfo
  (
    Val       Out t_Refcur,
    设备号_In In 影像设备目录.设备号%Type
  );

  --26、获取医技站存储设备号
  Procedure p_Getdeviceidbyadviceid
  (
    Val       Out t_Refcur,
    医嘱id_In In 病人医嘱发送.医嘱id%Type
  );
End b_Pacs_Rptpluginoriginal;

/

--影像报告范文管理(---实现部分---)***************************************************
Create Or Replace Package Body b_Pacs_Rptpluginoriginal Is

  --1、功    能：获取历史报告记录
  Procedure p_Getreporthistory
  (
    Val                   Out t_Refcur,
    医嘱id_In             In 病人医嘱记录.Id%Type,
    人员id_In             In 部门人员.人员id%Type,
    当前科室id_In         In 部门人员.部门id%Type,
    查看其他科历史报告_In In Number := 0
  ) Is
    Strsql     Varchar2(4000);
    Strsqlback Varchar2(4000);
    Strfilter  Varchar2(400);
  Begin
    If 查看其他科历史报告_In = 1 Then
      Strfilter := ' ';
    Else
      Strfilter := ' And c.执行科室id+0 in (select 部门id from 部门人员 where 人员id = ' || 人员id_In ||
                   ' union all select to_Number(' || 当前科室id_In || ') from dual) ';
    End If;
  
    Strsql := 'Select 2 as 报告类型, f.编码' || '||''-''||' || 'f.名称 As 科室名称, c.Id As 医嘱id, a.影像类别 as 类别,b.创建人 as 报告人,' ||
              'to_char(b.创建时间,''yyyy-mm-dd hh24:mi:ss'') as 创建时间,b.文档标题 报告名称, c.医嘱内容, TO_CHAR(RAWTOHEX(b.id)) 报告ID ' ||
              'From 影像检查记录 A, 影像报告记录 B, 病人医嘱记录 C, 影像检查记录 D, 病人医嘱记录 E, 部门表 F ' ||
              'Where a.医嘱id = b.医嘱id And d.医嘱id = e.Id And e.Id =' || 医嘱id_In ||
              ' And e.执行科室ID = F.ID And b.医嘱id = c.Id And ' ||
              '(c.病人id = e.病人id Or a.关联id = d.关联id) And c.相关id Is Null ' || Strfilter || ' union all ' ||
              'Select 1 as 报告类型, g.编码' || '||''-''||' || 'g.名称 As 科室名称, c.Id As 医嘱id, a.影像类别 as 类别, a.报告人, ' ||
              'to_char(f.创建时间,''yyyy-mm-dd hh24:mi:ss'') as 创建时间, a.影像类别||''报告'' 报告名称, c.医嘱内容,TO_CHAR( b.病历id) as 报告ID ' ||
              'From 影像检查记录 A, 病人医嘱报告 B, 病人医嘱记录 C, 影像检查记录 D, 病人医嘱记录 E, 电子病历记录 F, 部门表 G ' ||
              'Where a.医嘱id = b.医嘱id And d.医嘱id = e.Id And e.Id = ' || 医嘱id_In ||
              ' And e.执行科室ID = g.ID And b.医嘱id = c.Id And b.病历ID Is Not Null And ' ||
              '(c.病人id = e.病人id Or a.关联id = d.关联id) And c.相关id Is Null And b.病历id = f.id ' || Strfilter;
  
    Strsqlback := Strsql;
    Strsqlback := Replace(Strsqlback, '影像检查记录', 'H影像检查记录');
    Strsqlback := Replace(Strsqlback, '病人医嘱报告', 'H病人医嘱报告');
    Strsqlback := Replace(Strsqlback, '病人医嘱记录', 'H病人医嘱记录');
  
    Strsql := Strsql || ' UNION ALL ' || Strsqlback || ' Order By 创建时间 Asc';
  
    Open Val For Strsql;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Getreporthistory;

  --2、功    能：获取对应报告内容
  Procedure p_Getreportcontent
  (
    Val           Out t_Refcur,
    报告id_In     Varchar2,
    Editortype_In Number := 0 --0:电子病历编辑器，1--PACS报告编辑器，2--报告文档编辑器
  ) Is
    Strsql Varchar2(1000);
  Begin
    If Editortype_In = 1 Then
      Strsql := 'Select a.内容文本 As 标题, b.对象属性, b.内容文本 As 正文,b.开始版 as 版本 From 电子病历内容 a,电子病历内容 b ' || 'Where a.文件id = ' ||
                报告id_In || ' And a.对象类型 = 3 And a.Id = b.父ID And b.对象类型 = 2 and b.终止版=0 ';
    Elsif Editortype_In = 0 Then
      Strsql := 'select 内容 from 电子病历格式 where 文件ID=' || 报告id_In;
    Else
      Strsql := 'Select 报告内容 As 内容 From 影像报告记录 Where ID=HexToRaw(''' || 报告id_In || ''')';
    End If;
  
    Open Val For Strsql;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Getreportcontent;

  --3、功    能：根据医嘱ID获取检查信息
  Procedure p_Getstudyinfobyadviceid
  (
    Val       Out t_Refcur,
    医嘱id_In In 影像检查记录.医嘱id%Type
  ) Is
    Strsql Varchar2(100);
  Begin
    Strsql := 'Select 检查UID,报告图象,接收日期,检查号,姓名,性别,年龄 from 影像检查记录 where 医嘱ID =' || 医嘱id_In;
    Open Val For Strsql;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Getstudyinfobyadviceid;

  --4、功    能：获取报告图像总数
  Procedure p_Getreportimagecount
  (
    Val         Out t_Refcur,
    查询条件_In In Varchar2
  ) Is
  Begin
    Open Val For
      Select Count(b.Column_Value) 返回值
      From 影像检查记录 a, Table(Cast(f_Str2list(Replace(a.报告图象, ';', ',')) As Zltools.t_Strlist)) b
      Where 医嘱id = 查询条件_In;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Getreportimagecount;

  --5、功    能：获取报告图像数据
  Procedure p_Getreportimagedata
  (
    Val         Out t_Refcur,
    查询条件_In In Varchar2,
    开始位置_In In Number,
    结束位置_In In Number
  ) Is
  Begin
    Open Val For
      Select *
      From (Select Rownum As 顺序号, Rownum As 图像号, b.Ftp用户名 As User1, b.Ftp密码 As Pwd1, b.Ip地址 As Host1,
                    '/' || b.Ftp目录 || '/' As Root1,
                    Decode(a.接收日期, Null, '', To_Char(a.接收日期, 'YYYYMMDD') || '/') || a.检查uid || '/' ||
                     Replace(Trim(d.Column_Value), '.jpg', '') As Url, b.设备号 As 设备号1, c.Ftp用户名 As User2, c.Ftp密码 As Pwd2,
                    c.Ip地址 As Host2, '/' || c.Ftp目录 || '/' As Root2, c.设备号 As 设备号2,
                    Replace(Trim(d.Column_Value), '.jpg', '') As 图像uid, a.检查uid, '' 序列uid, 0 动态图, '' 编码名称, '' 采集时间,
                    '' 录制长度, '' 报告图
             From 影像检查记录 a, 影像设备目录 b, 影像设备目录 c, Table(Cast(f_Str2list(Replace(a.报告图象, ';', ',')) As Zltools.t_Strlist)) d
             Where a.位置一 = b.设备号(+)
             And a.位置二 = c.设备号(+)
             And a.医嘱id = 查询条件_In)
      Where 顺序号 >= 开始位置_In
      And 顺序号 <= 结束位置_In;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Getreportimagedata;

  --6、功    能：获取预览图像总数
  Procedure p_Getstudyimagecount
  (
    Val         Out t_Refcur,
    查询条件_In In Varchar2,
    是否临时_In In Number := 0
  ) Is
    Strsql Varchar2(2000);
  Begin
    If 是否临时_In = 0 Then
      Strsql := 'select T1.返回值+T2.返回值 as 返回值 from ' || '(select count(1) as 返回值 from 影像检查图象 a, 影像检查序列 b, 影像检查记录 c ' ||
                'where a.序列UID=b.序列UID and b.检查UID=c.检查UID and c.医嘱ID=''' || 查询条件_In || ''') T1,' ||
                '(select count(1) as 返回值 from H影像检查图象 a, H影像检查序列 b, 影像检查记录 c ' ||
                'where a.序列UID=b.序列UID and b.检查UID=c.检查UID and c.医嘱ID=''' || 查询条件_In || ''') T2';
    Else
      Strsql := 'select count(1)  as 返回值 from 影像临时图象  where  序列UID=''' || 查询条件_In || '''';
    End If;
  
    Open Val For Strsql;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Getstudyimagecount;

  --7、功    能：获取预览图像数据
  Procedure p_Getstudyimagedata
  (
    Val         Out t_Refcur,
    查询方式_In In Varchar2,
    查询条件_In In Varchar2,
    开始位置_In In Number,
    结束位置_In In Number,
    是否临时_In In Number
  ) Is
    Strsql    Varchar2(2000);
    Strsql2   Varchar2(2000);
    Strfilter Varchar2(100);
    No_Column Exception;
    Pragma Exception_Init(No_Column, -00904);
  Begin
    If 查询方式_In = 0 Then
      Strfilter := 'and c.医嘱ID=''' || 查询条件_In || '''';
    Elsif 查询方式_In = 1 Then
      Strfilter := 'and B.序列UID=''' || 查询条件_In || '''';
    Else
      Strfilter := 'and A.图像UID=''' || 查询条件_In || '''';
    End If;
  
    Strsql := 'Select * from (Select rownum as 顺序号, T.* from(' ||
              'Select A.图像号,D.FTP用户名 As User1,D.FTP密码 As Pwd1,D.IP地址 As Host1,''/''||D.Ftp目录||''/'' As Root1,' ||
              'Decode(C.接收日期,Null,'''',to_Char(C.接收日期,''YYYYMMDD'')||''/'')||C.检查UID||''/''||A.图像UID As URL,d.设备号 as 设备号1,' ||
              'E.FTP用户名 As User2,E.FTP密码 As Pwd2,E.IP地址 As Host2,''/''||E.Ftp目录||''/'' As Root2,' ||
              'e.设备号 as 设备号2, A.图像UID,C.检查UID,B.序列UID,A.动态图,A.编码名称,A.采集时间, A.录制长度,A.报告图 ' ||
              'From 影像检查图象 A,影像检查序列 B,影像检查记录 C,影像设备目录 D,影像设备目录 E ' ||
              'Where A.序列UID=B.序列UID And B.检查UID=C.检查UID And C.位置一=D.设备号(+) And C.位置二=E.设备号(+) ' || Strfilter || ' ' ||
              'Order by 序列UID, 图像号) T ) ' || 'Where 顺序号>=' || 开始位置_In || ' and 顺序号<=' || 结束位置_In || '';
  
    Strsql2 := 'Select * from (Select rownum as 顺序号, T.* from(' ||
               'Select A.图像号,D.FTP用户名 As User1,D.FTP密码 As Pwd1,D.IP地址 As Host1,''/''||D.Ftp目录||''/'' As Root1,' ||
               'Decode(C.接收日期,Null,'''',to_Char(C.接收日期,''YYYYMMDD'')||''/'')||C.检查UID||''/''||A.图像UID As URL,d.设备号 as 设备号1,' ||
               'E.FTP用户名 As User2,E.FTP密码 As Pwd2,E.IP地址 As Host2,''/''||E.Ftp目录||''/'' As Root2,' ||
               'e.设备号 as 设备号2, A.图像UID,C.检查UID,B.序列UID,A.动态图,A.编码名称,A.采集时间, A.录制长度 ' ||
               'From 影像检查图象 A,影像检查序列 B,影像检查记录 C,影像设备目录 D,影像设备目录 E ' ||
               'Where A.序列UID=B.序列UID And B.检查UID=C.检查UID And C.位置一=D.设备号(+) And C.位置二=E.设备号(+) ' || Strfilter || ' ' ||
               'Order by 序列UID, 图像号) T ) ' || 'Where 顺序号>=' || 开始位置_In || ' and 顺序号<=' || 结束位置_In || '';
  
    If 是否临时_In = 1 Then
      Strsql  := Replace(Strsql, '影像检查', '影像临时');
      Strsql2 := Replace(Strsql2, '影像检查', '影像临时');
    End If;
  
    Begin
      Open Val For Strsql;
    Exception
      When No_Column Then
        --兼容处理，10.36新增加 报告图 字段，问题号 103996
        Open Val For Strsql2;
    End;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Getstudyimagedata;

  --8、功能：获取临时图像序列
  Procedure p_Get_Tempimageseries
  (
    Val         Out t_Refcur,
    时间范围_In In Number,
    姓名_In     In 影像临时记录.姓名%Type := Null
  ) As
  Begin
    If 姓名_In Is Null Then
      Open Val For
        Select b.序列uid, a.姓名, a.检查号 As 序号, a.接收日期
        From 影像临时记录 a, 影像临时序列 b
        Where a.检查uid = b.检查uid
        And a.接收日期 Between Sysdate - 时间范围_In And Sysdate
        Order By 序号;
    Else
      Open Val For
        Select b.序列uid, a.姓名, a.检查号 As 序号, a.接收日期
        From 影像临时记录 a, 影像临时序列 b
        Where a.检查uid = b.检查uid
        And a.接收日期 Between Sysdate - 时间范围_In And Sysdate
        And a.姓名 = 姓名_In
        Order By 序号;
    End If;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End;

  --9、功能：获取图像备注
  Procedure p_Get_Normalnote(Val Out t_Refcur) As
  Begin
    Open Val For
      Select b.编号 As 编号, b.名称 As 名称
      From 影像字典清单 a, 影像字典内容 b
      Where a.Id = b.字典id
      And a.名称 = '影像图像备注';
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End;

  --10、功能：插入常用图像备注
  Procedure p_Insert_Normalnote
  (
    Note_In In 影像字典内容.名称%Type,
    Code_In 影像字典内容.简码%Type
  ) As
    n_Num         Number;
    Dictionary_Id Varchar2(36);
  Begin
    Select Id Into Dictionary_Id From 影像字典清单 Where 说明 = '影像图像备注';
    Select Decode(Max(To_Number(编号)), Null, 0, Max(To_Number(编号)))
    Into n_Num
    From 影像字典内容
    Where 字典id = Dictionary_Id;
    n_Num := n_Num + 1;
    Insert Into 影像字典内容
      (字典id, 编号, 名称, 说明)
    Values
      (Dictionary_Id, To_Char(n_Num), Note_In, '影像图像备注');
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Insert_Normalnote;

  --11、功能：修改常用图像备注
  Procedure p_Edit_Normalnote
  (
    Note_In In 影像字典内容.名称%Type,
    Num_In  影像字典内容.编号%Type
  ) As
    Dictionary_Id Varchar2(36);
  Begin
    Select Id Into Dictionary_Id From 影像字典清单 Where 说明 = '影像图像备注';
    Update 影像字典内容 t
    Set t.名称 = Note_In
    Where t.字典id = Dictionary_Id
    And t.编号 = Num_In;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Edit_Normalnote;

  --12、功能：删除常用图像备注
  Procedure p_Del_Normalnote(Num_In 影像字典内容.编号%Type) As
    Dictionary_Id Varchar2(36);
  Begin
    Select Id Into Dictionary_Id From 影像字典清单 Where 说明 = '影像图像备注';
    Delete 影像字典内容 t
    Where t.字典id = Dictionary_Id
    And t.编号 = Num_In;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Del_Normalnote;

  --13、功能：获取备注的下一个编码
  Procedure p_Get_Normalnum(Val Out t_Refcur) As
    Dictionary_Id Varchar2(36);
  Begin
    Select Id Into Dictionary_Id From 影像字典清单 Where 说明 = '影像图像备注';
    Open Val For
      Select Decode(Max(To_Number(编号)), Null, 1, Max(To_Number(编号) + 1)) 编号
      From 影像字典内容 t
      Where t.字典id = Dictionary_Id;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Get_Normalnum;

  --14、功能：获取插件ID
  Procedure p_Get_Plugid
  (
    Val     Out t_Refcur,
    类名_In In 影像报告插件.类名%Type
  ) Is
  Begin
    Open Val For
      Select Rawtohex(Id) Id From 影像报告插件 Where 类名 = 类名_In;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Get_Plugid;

  --15、功能：插入编辑器字体参数
  Procedure p_Setfontparam
  (
    Font_In Nvarchar2,
    User_In Nvarchar2
  ) As
    m_Id     Nvarchar2(36);
    Numcount Int;
  Begin
    Select Rawtohex(Id)
    Into m_Id
    From 影像参数说明
    Where 模块 = 'ImageEditor'
    And 参数名 = '字体设置';
    Select Count(*)
    Into Numcount
    From 影像参数取值 t
    Where t.参数id = m_Id
    And t.参数标识 = User_In;
    If Numcount > 0 Then
      Update 影像参数取值 a
      Set a.参数值 = Font_In
      Where a.参数标识 = User_In
      And a.参数id = m_Id;
    Else
      Insert Into 影像参数取值 a (Id, 参数id, 参数标识, 参数值) Values (Sys_Guid(), m_Id, User_In, Font_In);
    End If;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Setfontparam;

  --16、功能：获取编辑器字体参数
  Procedure p_Getfontparam
  (
    Val     Out t_Refcur,
    User_In Nvarchar2
  ) As
    m_Id Nvarchar2(36);
  Begin
    Select Rawtohex(Id)
    Into m_Id
    From 影像参数说明
    Where 模块 = 'ImageEditor'
    And 参数名 = '字体设置';
    Open Val For
      Select a.参数值
      From 影像参数取值 a
      Where a.参数id = m_Id
      And a.参数标识 = User_In;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Getfontparam;

  --17、功能：插入编辑器窗体参数
  Procedure p_Setformparam
  (
    Form_In Nvarchar2,
    User_In Nvarchar2
  ) As
    m_Id     Nvarchar2(36);
    Numcount Int;
  Begin
    Select Rawtohex(Id)
    Into m_Id
    From 影像参数说明
    Where 模块 = 'ImageEditor'
    And 参数名 = '窗口设置';
    Select Count(*)
    Into Numcount
    From 影像参数取值 t
    Where t.参数id = m_Id
    And t.参数标识 = User_In;
    If Numcount > 0 Then
      Update 影像参数取值 a
      Set a.参数值 = Form_In
      Where a.参数标识 = User_In
      And a.参数id = m_Id;
    Else
      Insert Into 影像参数取值 a (Id, 参数id, 参数标识, 参数值) Values (Sys_Guid(), m_Id, User_In, Form_In);
    End If;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Setformparam;

  --18、功能：获取编辑器字体参数
  Procedure p_Getformparam
  (
    Val     Out t_Refcur,
    User_In Nvarchar2
  ) As
    m_Id Nvarchar2(36);
  Begin
    Select Rawtohex(Id)
    Into m_Id
    From 影像参数说明
    Where 模块 = 'ImageEditor'
    And 参数名 = '窗口设置';
    Open Val For
      Select a.参数值
      From 影像参数取值 a
      Where a.参数id = m_Id
      And a.参数标识 = User_In;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Getformparam;

  --19、功能：根据图像UID获取检查信息
  Procedure p_Getstudyinfobyimageuid
  (
    Val        Out t_Refcur,
    医嘱id_In  In 影像检查记录.医嘱id%Type,
    图像uid_In In 影像检查图象.图像uid%Type
  ) As
  Begin
    Open Val For
      Select d.检查uid
      From 影像检查图象 a, 影像检查序列 b, 影像检查记录 c, 影像临时序列 d
      Where c.医嘱id = 医嘱id_In
      And a.图像uid = 图像uid_In
      And a.序列uid = b.序列uid
      And b.检查uid = c.检查uid
      And a.序列uid = d.序列uid;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Getstudyinfobyimageuid;

  --20、功能：根据检查UID获取FTP信息
  Procedure p_Getftpinfobystudyuid
  (
    Val        Out t_Refcur,
    检查uid_In In 影像检查记录.检查uid%Type
  ) As
  Begin
    Open Val For
      Select d.Ftp用户名 As Ftpuser, d.Ftp密码 As Ftppwd, c.位置一, c.位置二, c.位置三, c.接收日期, d.Ip地址 As Host,
             '/' || d.Ftp目录 || '/' As Root,
             Decode(c.接收日期, Null, '', To_Char(c.接收日期, 'YYYYMMDD') || '/') || c.检查uid As Url
      From 影像检查记录 c, 影像设备目录 d
      Where Decode(c.位置一, Null, c.位置二, c.位置一) = d.设备号(+)
      And c.检查uid = 检查uid_In
      Union All
      Select d.Ftp用户名 As Ftpuser, d.Ftp密码 As Ftppwd, c.位置一, c.位置二, c.位置三, c.接收日期, d.Ip地址 As Host,
             '/' || d.Ftp目录 || '/' As Root,
             Decode(c.接收日期, Null, '', To_Char(c.接收日期, 'YYYYMMDD') || '/') || c.检查uid As Url
      From 影像临时记录 c, 影像设备目录 d
      Where Decode(c.位置一, Null, c.位置二, c.位置一) = d.设备号(+)
      And c.检查uid = 检查uid_In;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Getftpinfobystudyuid;

  --21、功能：根据科室ID获取FTP信息
  Procedure p_Getftpinfobydeptid
  (
    Val       Out t_Refcur,
    科室id_In In 影像流程参数.科室id%Type
  ) As
  Begin
    Open Val For
      Select a.设备号, a.Ip地址, a.Ftp用户名, a.Ftp密码
      From 影像设备目录 a, 影像流程参数 b
      Where a.设备号 = b.参数值
      And b.参数名 = '存储设备号'
      And b.科室id = 科室id_In;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Getftpinfobydeptid;

  --22、功能：根据医嘱ID获取FTP信息
  Procedure p_Getftpinfobyadvicetid
  (
    Val       Out t_Refcur,
    医嘱id_In In 影像检查记录.医嘱id%Type
  ) As
  Begin
    Open Val For
      Select a.设备号, a.Ip地址, a.Ftp用户名, a.Ftp密码
      From 影像设备目录 a, 影像检查记录 b
      Where b.位置一 = a.设备号(+)
      And b.医嘱id = 医嘱id_In;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Getftpinfobyadvicetid;

  --23、功能：获取检查UID
  Procedure p_Getstudyuid
  (
    Val        Out t_Refcur,
    检查uid_In In 影像检查记录.检查uid%Type
  ) As
  Begin
    Open Val For
      Select 检查uid
      From 影像检查记录
      Where 检查uid = 检查uid_In
      Union All
      Select 检查uid
      From 影像临时记录
      Where 检查uid = 检查uid_In;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Getstudyuid;

  --24、功能：获取序列UID
  Procedure p_Getseriesuid
  (
    Val        Out t_Refcur,
    序列uid_In In 影像检查序列.序列uid%Type
  ) As
  Begin
    Open Val For
      Select 序列uid
      From 影像检查序列
      Where 序列uid = 序列uid_In
      Union All
      Select 序列uid
      From 影像临时序列
      Where 序列uid = 序列uid_In;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Getseriesuid;

  --25、功能：根据设备号获取设备信息
  Procedure p_Getdeviceinfo
  (
    Val       Out t_Refcur,
    设备号_In In 影像设备目录.设备号%Type
  ) As
  Begin
    Open Val For
      Select 设备号, 设备名, '/' || Decode(Ftp目录, Null, '', Ftp目录 || '/') As Url, Ftp用户名, Ftp密码, Ip地址
      From 影像设备目录
      Where 类型 = 1
      And 设备号 = 设备号_In
      And Nvl(状态, 0) = 1;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Getdeviceinfo;

  --26、获取医技站存储设备号
  Procedure p_Getdeviceidbyadviceid
  (
    Val       Out t_Refcur,
    医嘱id_In In 病人医嘱发送.医嘱id%Type
  ) As
  Begin
    Open Val For
      Select d.参数值
      From 医技执行房间 a, 病人医嘱发送 b, 影像dicom服务对 c, 影像dicom服务参数 d
      Where a.科室id = b.执行部门id
      And a.执行间 = b.执行间
      And a.检查设备 = c.设备号
      And c.服务功能 = '图像接收'
      And c.服务id = d.服务id
      And d.参数名称 = '存储设备'
      And b.医嘱id = 医嘱id_In;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Getdeviceidbyadviceid;
End b_Pacs_Rptpluginoriginal;

/

--109972:黄捷,2017-10-18,报告文档编辑器锁定报告
Create Or Replace Package b_Pacs_Rptmanage Is
  Type t_Refcur Is Ref Cursor;

  --1、锁定报告人
  Procedure p_Edit_Doc_Lockinfo
  (
    报告_Id_In 影像报告记录.Id%Type,
    锁定人_In  影像报告记录.锁定人%Type
  );

  --2、评定报告质量
  Procedure p_Edit_Doc_Evaluatrptquality
  (
    报告id_In   影像报告记录.Id%Type,
    质量等级_In 影像报告记录.报告质量%Type
  );

  --3、评定阴阳性
  Procedure p_Edit_Doc_Evaluatresult
  (
    报告id_In   影像报告记录.Id%Type,
    检查结果_In 影像报告记录.结果阳性%Type
  );

  --4、报告发放/回收
  Procedure p_Edit_Doc_Reportrelease
  (
    报告id_In     影像报告记录.Id%Type,
    当前操作人_In 影像报告记录.报告发放人%Type
  );

  --5、新增，修改报告
  Procedure p_影像报告记录_新增
  (
    原型id_In     影像报告记录.原型id%Type,
    报告内容_In   影像报告记录.报告内容%Type,
    记录人_In     影像报告记录.记录人%Type,
    最后编辑人_In 影像报告记录.最后编辑人%Type,
    Id_In         影像报告记录.Id%Type,
    医嘱id_In     影像报告记录.医嘱id%Type
  );

  --6、获取书写的文档内容
  Procedure p_Get_Doc_Content
  (
    Val      Out t_Refcur,
    Docid_In 影像报告记录.Id%Type
  );

  --7、设置报告打印作废信息
  Procedure p_Checkrejectsignature
  (
    Signdate_In Date,
    报告id_In   影像报告操作记录.报告id%Type,
    作废人_In   影像报告操作记录.作废人%Type,
    作废说明_In 影像报告操作记录.作废说明%Type,
    Val         Out Sys_Refcursor
  );

  --8、查询相应原型下的最大序号
  Procedure p_Get_Samplelist_Maxseqnum
  (
    Val       Out t_Refcur,
    原型id_In 影像报告范文清单.原型id%Type
  );

  --9、删除文档范文
  Procedure p_Del_影像报告范文清单(Id_In 影像报告范文清单.Id%Type);

  --10、添加文档的操作日志
  Procedure p_影像报告操作记录_Add
  (
    Id_In       影像报告操作记录.Id%Type,
    报告id_In   影像报告操作记录.报告id%Type,
    操作人_In   影像报告操作记录.操作人%Type,
    操作类型_In 影像报告操作记录.操作类型%Type
  );

  --11、删除报告
  Procedure p_影像报告记录_删除(报告_Id_In 影像报告记录.Id%Type);

  --12、获取签名类型
  Procedure p_Get_Sysconfigsignature
  (
    Val       Out t_Refcur,
    科室id_In In 部门表.Id%Type
  );

  --13、获取账户签名印章
  Procedure p_Get_Personsignimg
  (
    Val   Out t_Refcur,
    Id_In In 人员表.Id%Type
  );

  --14、获取签名的证书信息
  Procedure p_Get_Signcertinfo
  (
    Val       Out t_Refcur,
    证书id_In 人员证书记录.Id%Type
  );

  --15、更新报告状态
  Procedure p_Update_Reportstate
  (
    报告id_In   影像报告记录.Id%Type,
    报告状态_In 影像报告记录.报告状态%Type,
    审核人_In   影像报告记录.最后审核人%Type
  );

  --16、获取报告状态
  Procedure p_Get_Reportstate
  (
    Val       Out t_Refcur,
    报告id_In 影像报告记录.Id%Type
  );

  --17、报告驳回
  Procedure p_Reject_Report
  (
    医嘱id_In   影像报告驳回.医嘱id%Type,
    报告id_In   影像报告驳回.检查报告id%Type,
    驳回理由_In 影像报告驳回.驳回理由%Type,
    驳回时间_In 影像报告驳回.驳回时间%Type,
    驳回人_In   影像报告驳回.驳回人%Type,
    待处理人_In 影像报告记录.待处理人%Type,
    报告状态_In 影像报告记录.报告状态%Type
  );

  --17.1、撤销报告驳回
  Procedure p_Reject_Cancel
  (
    Id_In       影像报告驳回.Id%Type,
    报告id_In   影像报告驳回.检查报告id%Type,
    报告状态_In 影像报告记录.报告状态%Type
  );

  --18、获取报告驳回信息
  Procedure p_Get_Rejectinfo
  (
    Val       Out t_Refcur,
    报告id_In 影像报告驳回.检查报告id%Type
  );

  --19、获取原型动作
  Procedure p_Get_Doc_Process
  (
    Val       Out t_Refcur,
    原型id_In 影像报告动作.原型id%Type
  );

  --20、通过学科筛选获得相应的范文信息
  Procedure p_Get_Samplelist_By_Conditions
  (
    Val          Out t_Refcur,
    原型id_In    Varchar2,
    学科_In      Varchar2,
    Condition_In Varchar2, --过滤筛选
    作者_In      Varchar2
  );

  --21、通过部门ID获取部门名称
  Procedure p_Get_部门名称_By_Id
  (
    Val   Out t_Refcur,
    Id_In 部门表.Id%Type
  );

  --22、提取所有预备提纲
  Procedure p_Get_Allpreoutlines(Val Out t_Refcur);

  --23、提取文档标题
  Procedure p_Get_Reporttitle_By_Id
  (
    Val   Out t_Refcur,
    Id_In 影像报告记录.Id%Type
  );

  --24、提取报告锁定人
  Procedure p_Get_报告锁定人_By_Id
  (
    Val   Out t_Refcur,
    Id_In 影像报告记录.Id%Type
  );

  --25、通过医嘱ID获取报告列表
  Procedure p_Get_影像报告记录_By_医嘱id
  (
    Val       Out t_Refcur,
    医嘱id_In 影像报告记录.医嘱id%Type
  );

  --26、查询影像流程参数值
  Procedure p_Get_影像流程参数值
  (
    Val       Out t_Refcur,
    科室id_In 影像流程参数.科室id%Type
  );

  --27、根据医嘱ID，查询对应的原型列表
  Procedure p_Get_影像原型列表_By_医嘱id
  (
    Val     Out t_Refcur,
    医嘱_In 影像检查记录.医嘱id%Type
  );

  --28、根据报告ID查询打印记录
  Procedure p_Get_Reportprintlog_By_报告id
  (
    Val     Out Sys_Refcursor,
    报告_In 影像报告操作记录.报告id%Type
  );

  --29、根据医嘱ID查询报告发放列表
  Procedure p_Get_Reportreleaselist
  (
    Val     Out t_Refcur,
    医嘱_In 影像报告记录.医嘱id%Type
  );

  --30、根据报告ID查询驳回记录数量
  Procedure p_Get_Rejectedcount
  (
    Val     Out t_Refcur,
    报告_In 影像报告驳回.检查报告id%Type
  );

  --31、根据医嘱ID查询报告动作需要的一些ID们
  Procedure p_Get_Docprocess_Ids
  (
    Val     Out t_Refcur,
    医嘱_In 病人医嘱记录.Id%Type
  );

  --32、根据医嘱ID和报告ID查询报告的一些参数
  Procedure p_Get_Docinfo
  (
    Val       Out t_Refcur,
    医嘱id_In 影像检查记录.医嘱id%Type,
    报告id_In 影像报告记录.Id%Type
  );

  --33、查询一个检查中相同原型ID的报告数量
  Procedure p_Get_Sameantetypedoccounts
  (
    Val       Out t_Refcur,
    医嘱id_In 影像报告记录.医嘱id%Type,
    原型id_In 影像报告记录.原型id%Type
  );

  --34、提取报告图存储信息
  Procedure p_Get_Docimagesaveinof_By_Id
  (
    Val   Out t_Refcur,
    Id_In 影像报告记录.Id%Type
  );

  --35、修改原型使用次数
  Procedure p_Update_Antetypeusecount(Id_In 影像报告原型清单.Id%Type);

  --36、更新影像检查图像的报告图标记
  Procedure p_Update_Rptimage
  (
    Uid_In        影像检查图象.图像uid%Type,
    Actiontype_In Number
  );

  --37、提取打印控制信息
  Procedure p_Get_Printcontrol
  (
    Val       Out t_Refcur,
    报告id_In 影像报告记录.Id%Type
  );

End b_Pacs_Rptmanage;

/

--影像报告业务(---实现部分---)***************************************************

Create Or Replace Package Body b_Pacs_Rptmanage Is

  --1、锁定报告人
  Procedure p_Edit_Doc_Lockinfo
  (
    报告_Id_In 影像报告记录.Id%Type,
    锁定人_In  影像报告记录.锁定人%Type
  ) Is
  Begin
  
    --  报告ID为空，则清空所有“锁定人_In”正在锁定的标记
    If 报告_Id_In Is Null Then
      Update 影像报告记录 a Set a.锁定人 = '' Where a.锁定人 = 锁定人_In;
    Else
      Update 影像报告记录 a Set a.锁定人 = 锁定人_In Where a.Id = 报告_Id_In;
    End If;
  
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Edit_Doc_Lockinfo;

  --2、评定报告质量
  Procedure p_Edit_Doc_Evaluatrptquality
  (
    报告id_In   影像报告记录.Id%Type,
    质量等级_In 影像报告记录.报告质量%Type
  ) Is
  Begin
    Update 影像报告记录 Set 报告质量 = 质量等级_In Where Id = 报告id_In;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Edit_Doc_Evaluatrptquality;

  --3、评定阴阳性
  Procedure p_Edit_Doc_Evaluatresult
  (
    报告id_In   影像报告记录.Id%Type,
    检查结果_In 影像报告记录.结果阳性%Type
  ) Is
  Begin
    Update 影像报告记录 Set 结果阳性 = 检查结果_In Where Id = 报告id_In;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Edit_Doc_Evaluatresult;

  --4、报告发放/回收
  Procedure p_Edit_Doc_Reportrelease
  (
    报告id_In     影像报告记录.Id%Type,
    当前操作人_In 影像报告记录.报告发放人%Type
  ) Is
    v_报告发放 影像报告记录.报告发放%Type;
  Begin
  
    Begin
      Select Nvl(报告发放, 0) Into v_报告发放 From 影像报告记录 Where Id = 报告id_In;
    Exception
      When Others Then
        v_报告发放 := 0;
    End;
  
    Update 影像报告记录
    Set 报告发放 = Decode(v_报告发放, 0, 1, 0), 报告发放人 = Decode(v_报告发放, 0, 当前操作人_In, '')
    Where Id = 报告id_In;
  
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Edit_Doc_Reportrelease;

  --5、新增，修改报告
  Procedure p_影像报告记录_新增
  (
    原型id_In     影像报告记录.原型id%Type,
    报告内容_In   影像报告记录.报告内容%Type,
    记录人_In     影像报告记录.记录人%Type,
    最后编辑人_In 影像报告记录.最后编辑人%Type,
    Id_In         影像报告记录.Id%Type,
    医嘱id_In     影像报告记录.医嘱id%Type
  ) As
    --原型ID_In 原型ID
    --保存文档书写记录
    --1 处理匿名数据
    --2 保存文档书写记录、状态
    --3 处理编辑日志
    --4 更新文档任务
    v_报告id    影像报告记录.Id%Type;
    v_原型名称  影像报告原型清单.名称%Type;
    v_设备号    影像报告原型清单.设备号%Type;
    v_报告序号  Number;
    x_Editlog   Xmltype;
    Cur_Time    Date;
    To_Editlist t_Editlist;
    Tn_Editlist t_Editlist;
    v_Msg       Varchar2(200);
    v_New       Number;
    Err_Custom Exception;
    v_Result 影像报告记录.诊断意见%Type;
    v_操作id 影像报告操作记录.Id%Type;
  
    Function Elist_Filter(Source_t t_Editlist) Return t_Editlist Is
      Target_t t_Editlist := t_Editlist();
    Begin
    
      --对独立文档来说，这个函数只是将 Source_t按照编辑时间排序后输出
      For Rs In (Select /*+rule*/
                  *
                 From Table(Cast(Source_t As t_Editlist)) a
                 Order By a.编辑时间) Loop
        Target_t.Extend;
        Target_t(Target_t.Count) := t_Edits(Rs.编辑人, Rs.编辑时间, Rs.签名, Rs.审订签名);
      End Loop;
      Return Target_t;
    End;
  
    Function Build_Editlog
    (
      Tn_Edit t_Editlist,
      To_Edit t_Editlist,
      v_Did   影像报告记录.Id%Type
    ) Return Xmltype Is
      --Tn_Edit 本次保存的新编辑记录；To_Edit上次保存的旧编辑记录
      --将两次编辑记录，组合成一个编辑记录
    
      x_Return Xmltype;
      r_Saveid Raw(16);
      n_Class  Number;
      --n_Class 编辑日志中的操作类别： 1-创建、2-删除、3-编辑、4-签名、5-审订、6-审签、7-撤签
      v_Signor  影像报告记录.创建人%Type;
      v_Adjunct 影像报告记录.创建人%Type;
      Tns_Edit  t_Editlist;
      Tos_Edit  t_Editlist;
    
      Function Atitle(原型id 影像报告原型清单.Id%Type) Return Varchar2 Is
        v_原型名称 影像报告原型清单.名称%Type;
      Begin
        --根据原型ID，返回原型名称
        If 原型id Is Null Then
          Return Null;
        Else
          Select 名称 Into v_原型名称 From 影像报告原型清单 Where Id = 原型id;
          Return v_原型名称;
        End If;
      End;
    
    Begin
      x_Return := Xmltype('<root></root>');
      If v_Did Is Null Then
        --表明是新增文档，新增文档传null进来
        Select Sys_Guid() Into r_Saveid From Dual;
      
        --PACS报告没有子文档，但是下面构造XML的语句保留成跟EMR相同，这里的v_Subiid赋值为空
        Tns_Edit := Elist_Filter(Tn_Edit);
        Select Decode(Tns_Edit(Tns_Edit.Count).签名, 0, 1, 4) Into n_Class From Dual;
        Select Appendchildxml(x_Return,
                               '/root',
                               Xmlelement("operate",
                                          Xmlforest(r_Saveid As "saving_id",
                                                    n_Class As "class",
                                                    To_Char(Cur_Time, 'yyyy-mm-dd hh24:mi:ss') As "cur_time",
                                                    最后编辑人_In As "operator",
                                                    Decode(n_Class, 4, Tns_Edit(Tns_Edit.Count).编辑人, '') As "signer",
                                                    '' As Adjunct)))
        Into x_Return
        From Dual;
      Else
        --不是新增的文档？
        Select Sys_Guid() Into r_Saveid From Dual;
      
        v_Signor  := '';
        v_Adjunct := '';
        Tns_Edit  := Elist_Filter(Tn_Edit);
        Tos_Edit  := Elist_Filter(To_Edit);
        If Tns_Edit(Tns_Edit.Count).签名 = 1 And Tns_Edit(Tns_Edit.Count).审订签名 = 0 Then
          --最近一次是签名
          If Tos_Edit.Count = 0 Then
            --新增子文档直接签名
            n_Class  := 4;
            v_Signor := Tns_Edit(Tns_Edit.Count).编辑人;
          Elsif Tos_Edit(Tos_Edit.Count).编辑人 Is Null Then
            --之前没签名
            n_Class  := 4;
            v_Signor := Tns_Edit(Tns_Edit.Count).编辑人;
          Elsif Tos_Edit(Tos_Edit.Count).签名 = 1 And Tns_Edit(Tns_Edit.Count).编辑时间 > Tos_Edit(Tos_Edit.Count).编辑时间 Then
            --多次普通签名
            n_Class  := 4;
            v_Signor := Tns_Edit(Tns_Edit.Count).编辑人;
          Elsif Tos_Edit(Tos_Edit.Count).签名 = 1 And Tns_Edit(Tns_Edit.Count).编辑时间 < Tos_Edit(Tos_Edit.Count).编辑时间 Then
            --撤消多次签名
            n_Class   := 7;
            v_Adjunct := Tos_Edit(Tos_Edit.Count).编辑人;
          Elsif Tos_Edit(Tos_Edit.Count).签名 = 1 And Tns_Edit(Tns_Edit.Count).编辑时间 = Tos_Edit(Tos_Edit.Count).编辑时间 Then
            --无变化
            n_Class := -1;
          End If;
        Elsif Tns_Edit(Tns_Edit.Count).签名 = 1 And Tns_Edit(Tns_Edit.Count).审订签名 = 1 Then
          --审订签名
          If Tos_Edit(Tos_Edit.Count).审订签名 = 0 Then
            --之前没审签，可能是已签名或已审订
            n_Class  := 6;
            v_Signor := Tns_Edit(Tns_Edit.Count).编辑人;
          Elsif Tos_Edit(Tos_Edit.Count).审订签名 = 1 And Tns_Edit(Tns_Edit.Count).编辑时间 > Tos_Edit(Tos_Edit.Count).编辑时间 Then
            --多次审签
            n_Class  := 6;
            v_Signor := Tns_Edit(Tns_Edit.Count).编辑人;
          Elsif Tos_Edit(Tos_Edit.Count).审订签名 = 1 And Tns_Edit(Tns_Edit.Count).编辑时间 < Tos_Edit(Tos_Edit.Count).编辑时间 Then
            --撤消多次审签
            n_Class   := 7;
            v_Adjunct := Tos_Edit(Tos_Edit.Count).编辑人;
          Elsif Tos_Edit(Tos_Edit.Count).审订签名 = 1 And Tns_Edit(Tns_Edit.Count).编辑时间 = Tos_Edit(Tos_Edit.Count).编辑时间 Then
            --无变化
            n_Class := -1;
          End If;
        Elsif Tns_Edit(Tns_Edit.Count).编辑人 Is Null And Tos_Edit.Count = 0 Then
          n_Class := 1;
        Elsif Tns_Edit(Tns_Edit.Count).编辑人 Is Null And Tos_Edit(Tos_Edit.Count).签名 = 1 Then
          n_Class   := 7;
          v_Adjunct := Tos_Edit(Tos_Edit.Count).编辑人;
        Elsif Tns_Edit(Tns_Edit.Count).编辑人 Is Null And Tos_Edit(Tos_Edit.Count).编辑人 Is Null Then
          n_Class := 3;
        Elsif Tns_Edit(Tns_Edit.Count).审订签名 = 0 And Tos_Edit(Tos_Edit.Count).审订签名 = 0 Then
          n_Class := 5;
        Elsif Tns_Edit(Tns_Edit.Count).审订签名 = 0 And Tos_Edit(Tos_Edit.Count).审订签名 = 1 Then
          n_Class   := 7;
          v_Adjunct := Tos_Edit(Tos_Edit.Count).编辑人;
        End If;
      
        If n_Class <> -1 Then
          Select Appendchildxml(x_Return,
                                 '/root',
                                 Xmlelement("operate",
                                            Xmlforest(r_Saveid As "saving_id",
                                                      n_Class As "class",
                                                      To_Char(Cur_Time, 'yyyy-mm-dd hh24:mi:ss') As "cur_time",
                                                      最后编辑人_In As "operator",
                                                      Decode(n_Class, 4, v_Signor, 6, v_Signor, '') As "signer",
                                                      v_Adjunct As Adjunct)))
          Into x_Return
          From Dual;
        End If;
      
      End If;
      Return x_Return;
    End Build_Editlog;
  
    Function Get_Nextrptnum
    (
      Antetypename 影像报告原型清单.名称%Type,
      Order_Id     影像报告记录.医嘱id%Type
    ) Return Number Is
      v_序号  Number;
      v_Count Number;
      v_Num   Number;
    Begin
    
      v_Count := 0;
      v_Num   := 1;
      Loop
        Select Count(*) + v_Num Into v_序号 From 影像报告记录 Where 医嘱id = Order_Id;
        Select Count(*)
        Into v_Count
        From 影像报告记录
        Where 医嘱id = Order_Id
        And 文档标题 = Antetypename || '_' || v_序号;
      
        If v_Count = 0 Then
          Exit;
        End If;
      
        v_Num := v_Num + 1;
      End Loop;
    
      Return v_序号;
    End;
  
  Begin
  
    Select 名称, 设备号, Sysdate Into v_原型名称, v_设备号, Cur_Time From 影像报告原型清单 Where Id = 原型id_In;
  
    --------------------1 保存文档书写记录、状态--------------------
    --提取文档的签名和编辑（新增、修改）记录
    Tn_Editlist := b_Pacs_Rptpublic.f_Geteditlist(报告内容_In);
  
    --------------------2 处理编辑日志--------------------
    Select Count(*) Into v_New From 影像报告记录 Where Id = Id_In;
  
    v_报告id := Id_In;
    Select Zlpub_Pacs_取提纲内容byxml(报告内容_In, '诊断意见') Into v_Result From Dual;
    If v_New = 0 Then
      --新增报告
      To_Editlist := t_Editlist();
      x_Editlog   := Build_Editlog(Tn_Editlist, To_Editlist, Null);
    
      --取报告序号
      v_报告序号 := Get_Nextrptnum(v_原型名称, 医嘱id_In);
    
      Insert Into 影像报告记录
        (Id, 原型id, 文档标题, 报告内容, 创建时间, 创建人, 报告状态, 最后编辑时间, 最后编辑人, 编辑日志, 医嘱id, 记录人, 诊断意见, 设备号)
      Values
        (v_报告id, 原型id_In, v_原型名称 || '_' || v_报告序号, 报告内容_In, Cur_Time, 最后编辑人_In, 1, Cur_Time, 最后编辑人_In, x_Editlog,
         医嘱id_In, 记录人_In, v_Result, v_设备号);
      Insert Into 病人医嘱报告 (医嘱id, 检查报告id) Values (医嘱id_In, v_报告id);
    
      Select Sys_Guid() Into v_操作id From Dual;
      Insert Into 影像报告操作记录
        (Id, 报告id, 医嘱id, 文档标题, 操作人, 操作时间, 操作类型)
      Values
        (v_操作id, v_报告id, 医嘱id_In, v_原型名称 || '_' || v_报告序号, 最后编辑人_In, Sysdate, 6);
    
    Else
      --提取文件原始编辑记录,必需在更新之前提取
      Select b_Pacs_Rptpublic.f_Geteditlist(报告内容) Into To_Editlist From 影像报告记录 Where Id = v_报告id;
    
      x_Editlog := Build_Editlog(Tn_Editlist, To_Editlist, v_报告id);
      Select Appendchildxml(编辑日志, '/root', Extract(x_Editlog, '/root/*'))
      Into x_Editlog
      From 影像报告记录
      Where Id = v_报告id;
    
      Update 影像报告记录
      Set 报告内容 = 报告内容_In, 最后编辑时间 = Cur_Time, 最后编辑人 = 最后编辑人_In, 编辑日志 = x_Editlog, 记录人 = 记录人_In, 诊断意见 = v_Result
      Where Id = v_报告id;
    End If;
  
  Exception
    When Err_Custom Then
      Raise_Application_Error(-20101, v_Msg);
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_影像报告记录_新增;

  --6、获取书写的文档内容
  Procedure p_Get_Doc_Content
  (
    Val      Out t_Refcur,
    Docid_In 影像报告记录.Id%Type
  ) As
  Begin
    Open Val For
      Select (Nvl(a.报告内容, Xmltype('<ZLXML/>'))).Getclobval() As 报告内容 From 影像报告记录 a Where a.Id = Docid_In;
  End;

  --7、设置报告打印作废信息
  Procedure p_Checkrejectsignature
  (
    Signdate_In Date,
    报告id_In   影像报告操作记录.报告id%Type,
    作废人_In   影像报告操作记录.作废人%Type,
    作废说明_In 影像报告操作记录.作废说明%Type,
    Val         Out Sys_Refcursor
  ) As
  Begin
    Open Val For
      Select 操作人, 操作时间
      From 影像报告操作记录
      Where 报告id = 报告id_In
      And 操作类型 = 1
      And 操作时间 >= Signdate_In
      And 作废时间 Is Null
      Order By 操作时间 Asc;
    --作废打印记录
    Update 影像报告操作记录 b
    Set 作废人 = 作废人_In, 作废时间 = Sysdate, b.作废说明 = 作废说明_In
    Where 报告id = 报告id_In
    And 操作类型 = 1
    And 操作时间 >= Signdate_In;
  
  End p_Checkrejectsignature;

  --8、查询相应原型下的最大序号
  Procedure p_Get_Samplelist_Maxseqnum
  (
    Val       Out t_Refcur,
    原型id_In 影像报告范文清单.原型id%Type
  ) As
  Begin
    Open Val For
      Select Nvl(Max(a.编号), 0) + 1 As Num From 影像报告范文清单 a Where a.原型id = 原型id_In;
  End;

  --9、删除文档范文
  Procedure p_Del_影像报告范文清单(Id_In 影像报告范文清单.Id%Type) As
  Begin
    Delete From 影像报告范文清单 Where Id = Id_In;
  End;

  --10、添加文档的操作日志
  Procedure p_影像报告操作记录_Add
  (
    Id_In       影像报告操作记录.Id%Type,
    报告id_In   影像报告操作记录.报告id%Type,
    操作人_In   影像报告操作记录.操作人%Type,
    操作类型_In 影像报告操作记录.操作类型%Type
  ) As
    n_医嘱id   影像报告操作记录.医嘱id%Type;
    n_文档标题 影像报告记录.文档标题%Type;
  Begin
  
    Begin
      Select 医嘱id, 文档标题 Into n_医嘱id, n_文档标题 From 影像报告记录 Where Id = 报告id_In;
    Exception
      When Others Then
        Null;
    End;
    If n_医嘱id Is Not Null Then
      Insert Into 影像报告操作记录
        (Id, 报告id, 医嘱id, 文档标题, 操作人, 操作时间, 操作类型)
      Values
        (Id_In, 报告id_In, n_医嘱id, n_文档标题, 操作人_In, Sysdate, 操作类型_In);
      If 操作类型_In = 1 Then
        Update 影像报告记录 Set 报告打印 = 1 Where Id = 报告id_In;
      End If;
    End If;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End;

  --11、删除报告
  Procedure p_影像报告记录_删除(报告_Id_In 影像报告记录.Id%Type) As
  Begin
  
    Delete From 影像报告记录 Where 影像报告记录.Id = Hextoraw(报告_Id_In);
  
    Delete From 病人医嘱报告 Where 检查报告id = Hextoraw(报告_Id_In);
  
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_影像报告记录_删除;

  --12、获取签名类型
  Procedure p_Get_Sysconfigsignature
  (
    Val       Out t_Refcur,
    科室id_In In 部门表.Id%Type
  ) Is
  Begin
    --返回用户, 模块号,功能
    Open Val For
      Select Zl_Fun_Getsignpar(7, 科室id_In) As 签名类型 From Dual;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End;

  --13、获取账户签名印章
  Procedure p_Get_Personsignimg
  (
    Val   Out t_Refcur,
    Id_In In 人员表.Id%Type
  ) Is
    v_sql Varchar2(1000);
    n_count Number(5);
  Begin
    Select Count(*) Into n_Count From user_tables Where table_name =Upper('影像签名图片');
  
    If n_Count > 0 Then
       v_sql := 'Truncate Table 影像签名图片';
       Execute Immediate v_sql;
  
       v_sql := 'Insert Into 影像签名图片 Select a.id, to_lob(a.签名图片) as 签名图片 From 人员表 a Where a.ID=' || ID_In;
       Execute Immediate v_sql;
    Else
       v_sql := 'Create GLOBAL TEMPORARY TABLE 影像签名图片 ON COMMIT PRESERVE ROWS AS Select a.id, to_lob(a.签名图片) as 签名图片 From 人员表 a Where a.ID=' || ID_In;
       Execute Immediate v_sql;
    End If;
  
    v_sql := 'Select 签名图片 From 影像签名图片 Where Id=:ID';
  
    --返回用户, 模块号,功能
    Open  Val For v_sql Using ID_In;
  
    --Open Val For
    --  Select To_Blob(签名图片) As 签名图片 From 人员表 Where Id = Id_In;
  
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End;

  --14、获取签名的证书信息
  Procedure p_Get_Signcertinfo
  (
    Val       Out t_Refcur,
    证书id_In 人员证书记录.Id%Type
  ) Is
  Begin
    Open Val For
      Select Id, Certdn, Certsn, Signcert, Enccert From 人员证书记录 Where Id = 证书id_In;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End;

  --15、更新报告状态
  Procedure p_Update_Reportstate
  (
    报告id_In   影像报告记录.Id%Type,
    报告状态_In 影像报告记录.报告状态%Type,
    审核人_In   影像报告记录.最后审核人%Type
  ) Is
  Begin
    --报告状态1-未签名；2-已诊断；3-已审核；4-已终审；5-诊断驳回；6-审核驳回
    --如果报告状态是1-未签名；2-已诊断;5-诊断驳回，此时是没有审核人的
    If (报告状态_In = 1) Or (报告状态_In = 2) Or (报告状态_In = 5) Then
      Update 影像报告记录 Set 报告状态 = 报告状态_In, 最后审核人 = Null, 最后审核时间 = Null Where Id = 报告id_In;
    Elsif (报告状态_In = 3) Or (报告状态_In = 4) Then
      Update 影像报告记录
      Set 报告状态 = 报告状态_In, 最后审核人 = 审核人_In, 最后审核时间 = Sysdate
      Where Id = 报告id_In;
    Else
      Update 影像报告记录 Set 报告状态 = 报告状态_In Where Id = 报告id_In;
    End If;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End;

  --16、获取报告状态
  Procedure p_Get_Reportstate
  (
    Val       Out t_Refcur,
    报告id_In 影像报告记录.Id%Type
  ) Is
  Begin
    Open Val For
      Select 报告状态 From 影像报告记录 Where Id = 报告id_In;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End;

  --17、报告驳回
  Procedure p_Reject_Report
  (
    医嘱id_In   影像报告驳回.医嘱id%Type,
    报告id_In   影像报告驳回.检查报告id%Type,
    驳回理由_In 影像报告驳回.驳回理由%Type,
    驳回时间_In 影像报告驳回.驳回时间%Type,
    驳回人_In   影像报告驳回.驳回人%Type,
    待处理人_In 影像报告记录.待处理人%Type,
    报告状态_In 影像报告记录.报告状态%Type
  ) Is
  Begin
    Insert Into 影像报告驳回
      (Id, 医嘱id, 检查报告id, 驳回理由, 驳回时间, 驳回人)
    Values
      (影像报告驳回_Id.Nextval, 医嘱id_In, 报告id_In, 驳回理由_In, 驳回时间_In, 驳回人_In);
  
    Update 影像报告记录 Set 报告状态 = 报告状态_In, 待处理人 = 待处理人_In Where Id = 报告id_In;
  
    --Update 病人医嘱发送 Set 执行过程=-1 Where 医嘱ID= 医嘱ID_IN;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End;

  --17.1、撤销报告驳回
  Procedure p_Reject_Cancel
  (
    Id_In       影像报告驳回.Id%Type,
    报告id_In   影像报告驳回.检查报告id%Type,
    报告状态_In 影像报告记录.报告状态%Type
  ) Is
  Begin
    Update 影像报告驳回 Set 是否撤销 = 1 Where Id = Id_In;
    Update 影像报告记录 Set 报告状态 = 报告状态_In, 待处理人 = '' Where Id = 报告id_In;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End;

  --18、获取报告驳回信息
  Procedure p_Get_Rejectinfo
  (
    Val       Out t_Refcur,
    报告id_In 影像报告驳回.检查报告id%Type
  ) Is
  Begin
    Open Val For
      Select a.Id, a.驳回理由, a.驳回时间, a.驳回人, Nvl(a.是否撤销, 0) As 驳回状态, b.报告状态
      From 影像报告驳回 a, 影像报告记录 b
      Where a.检查报告id = 报告id_In
      And a.检查报告id = b.Id
      Order By 驳回时间;
  End;

  --19、获取原型动作
  Procedure p_Get_Doc_Process
  (
    Val       Out t_Refcur,
    原型id_In 影像报告动作.原型id%Type
  ) As
  Begin
    Open Val For
      Select Rawtohex(p.Id) Id, p.名称 As 动作名称, e.名称 As 事件名称, e.种类 As 事件种类, e.元素iid As 元素iid, p.动作类型, p.序号, p.说明, p.可否手工执行,
             (Nvl(p.内容, Xmltype('<NULL/>'))).Getclobval() As 内容, Rawtohex(p.事件id) 事件id
      From 影像报告动作 p, 影像报告事件 e
      Where p.事件id = e.Id(+)
      And p.原型id = 原型id_In
      Order By 动作类型, 序号;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Get_Doc_Process;

  --20、通过学科筛选获得相应的范文信息
  Procedure p_Get_Samplelist_By_Conditions
  (
    Val          Out t_Refcur,
    原型id_In    Varchar2,
    学科_In      Varchar2,
    Condition_In Varchar2, --过滤筛选
    作者_In      Varchar2
  ) As
  Begin
  
    Open Val For
      Select /*+ rule*/
       Rawtohex(a.Id) Id, a.名称, a.作者, a.说明, Nvl2(a.说明, a.说明 || '作者:' || a.作者, '作者:' || a.作者) Content, a.标签, a.学科
      From 影像报告范文清单 a
      Where a.原型id = Hextoraw(原型id_In)
      And ((a.学科 Is Null And a.是否私有 = 0) Or 学科_In Is Null Or a.作者 = 作者_In Or
            (a.学科 Is Not Null And b_Pacs_Rptpublic.f_If_Intersect(a.学科, 学科_In) > 0 And a.是否私有 = 0))
      And (Condition_In Is Null Or
            (a.标签 Is Not Null And Condition_In Is Not Null And b_Pacs_Rptpublic.f_If_Intersect(a.标签, Condition_In) > 0))
      Order By a.编号;
  
  End p_Get_Samplelist_By_Conditions;

  --21、通过部门ID获取部门名称
  Procedure p_Get_部门名称_By_Id
  (
    Val   Out t_Refcur,
    Id_In 部门表.Id%Type
  ) Is
  Begin
    Open Val For
      Select 名称 From 部门表 Where Id = Id_In;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Get_部门名称_By_Id;

  --22、提取所有预备提纲
  Procedure p_Get_Allpreoutlines(Val Out t_Refcur) Is
  Begin
    Open Val For
      Select Rawtohex(Id) Id, a.编码, a.名称 From 影像报告预备提纲 a Order By a.编码;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Get_Allpreoutlines;

  --23、提取文档标题
  Procedure p_Get_Reporttitle_By_Id
  (
    Val   Out t_Refcur,
    Id_In 影像报告记录.Id%Type
  ) Is
  Begin
    Open Val For
      Select 文档标题 From 影像报告记录 Where Id = Id_In;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Get_Reporttitle_By_Id;

  --24、提取报告锁定人
  Procedure p_Get_报告锁定人_By_Id
  (
    Val   Out t_Refcur,
    Id_In 影像报告记录.Id%Type
  ) Is
  Begin
    Open Val For
      Select 锁定人 From 影像报告记录 Where Id = Id_In;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Get_报告锁定人_By_Id;

  --25、通过医嘱ID获取报告列表
  Procedure p_Get_影像报告记录_By_医嘱id
  (
    Val       Out t_Refcur,
    医嘱id_In 影像报告记录.医嘱id%Type
  ) Is
  Begin
    Open Val For
      Select Rawtohex(Id) As Reportid, Rawtohex(原型id) As Antetypeid, 医嘱id As Orderid, 文档标题 As Reportname,
             创建时间 As Reportdate,
             Decode(Nvl(报告状态, 0), 1, '编辑中', 2, '已诊断', 3, '已审核', 4, '已终审', 5, '诊断驳回', '审核驳回') As Reportstate,
             创建人 As Createuser, 最后审核时间 As Examineydate, 最后审核人 As Examineyuser,
             Decode(Nvl(结果阳性, 0), 1, '阳性', '') As Resultpositive, Nvl(报告质量, 0) As Innerquality, ' ' As Reportquality,
             Decode(Nvl(报告打印, 0), 0, '未打印', '已打印') As Reportprint,
             Decode(Nvl(报告发放, 0), 0, '未发放', '已发放') As Reportrelease, 记录人 As Recdoctor, 锁定人 As RecLocker, ' ' As Locked
      From 影像报告记录
      Where 医嘱id = 医嘱id_In
      Order By Reportdate Desc;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Get_影像报告记录_By_医嘱id;

  --26、查询影像流程参数值
  Procedure p_Get_影像流程参数值
  (
    Val       Out t_Refcur,
    科室id_In 影像流程参数.科室id%Type
  ) Is
  Begin
    Open Val For
      Select 参数名, 参数值 From 影像流程参数 Where 科室id = 科室id_In;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Get_影像流程参数值;

  --27、根据医嘱ID，查询对应的原型列表
  Procedure p_Get_影像原型列表_By_医嘱id
  (
    Val     Out t_Refcur,
    医嘱_In 影像检查记录.医嘱id%Type
  ) Is
  Begin
    Open Val For
      Select Rawtohex(c.Id) As Antetypeid, c.名称 As Antetypename, c.说明
      From 病人医嘱记录 a, 影像报告原型应用 b, 影像报告原型清单 c
      Where a.Id = 医嘱_In
      And a.诊疗项目id = b.诊疗项目id
      And b.报告原型id = c.Id
      And a.病人来源 = b.应用场合
      Order By c.使用次数 Desc;
  
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Get_影像原型列表_By_医嘱id;

  --28、根据报告ID查询打印记录
  Procedure p_Get_Reportprintlog_By_报告id
  (
    Val     Out Sys_Refcursor,
    报告_In 影像报告操作记录.报告id%Type
  ) Is
  Begin
    Open Val For
      Select c.文档标题, b.操作人, To_Char(b.操作时间, 'yyyy-MM-dd HH24:mi') 打印时间, b.作废人,
             To_Char(b.作废时间, 'yyyy-MM-dd HH24:mi') 作废时间, b.作废说明
      From 影像报告操作记录 b, 影像报告记录 c
      Where c.Id = 报告_In
      And b.报告id = c.Id
      And 操作类型 = 1
      Order By b.操作时间;
  
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Get_Reportprintlog_By_报告id;

  --29、根据医嘱ID查询报告发放列表
  Procedure p_Get_Reportreleaselist
  (
    Val     Out t_Refcur,
    医嘱_In 影像报告记录.医嘱id%Type
  ) Is
  Begin
    Open Val For
      Select Rawtohex(Id) As 报告id, 文档标题 As 报告名称, 最后编辑时间 As 报告日期, Decode(Nvl(报告发放, 0), 0, '未发放', '已发放') As 报告发放
      From 影像报告记录
      Where 报告状态 Between 2 And 4
      And 医嘱id = 医嘱_In;
  
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Get_Reportreleaselist;

  --30、根据报告ID查询驳回记录数量
  Procedure p_Get_Rejectedcount
  (
    Val     Out t_Refcur,
    报告_In 影像报告驳回.检查报告id%Type
  ) Is
  Begin
    Open Val For
      Select Count(*) As 驳回数量 From 影像报告驳回 Where 检查报告id = 报告_In;
  
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Get_Rejectedcount;

  --31、根据医嘱ID查询报告动作需要的一些ID们
  Procedure p_Get_Docprocess_Ids
  (
    Val     Out t_Refcur,
    医嘱_In 病人医嘱记录.Id%Type
  ) Is
  Begin
    Open Val For
      Select Id As 医嘱id, 主页id, 挂号单 From 病人医嘱记录 Where Id = 医嘱_In;
  
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Get_Docprocess_Ids;

  --32、根据医嘱ID和报告ID查询报告的一些参数
  Procedure p_Get_Docinfo
  (
    Val       Out t_Refcur,
    医嘱id_In 影像检查记录.医嘱id%Type,
    报告id_In 影像报告记录.Id%Type
  ) Is
  Begin
    If 报告id_In Is Null Then
      Open Val For
        Select 执行科室id, '创建人' As 创建人 From 影像检查记录 Where 医嘱id = 医嘱id_In;
    Else
      Open Val For
        Select 执行科室id, 创建人
        From 影像检查记录 a, 影像报告记录 b
        Where a.医嘱id = b.医嘱id
        And b.Id = 报告id_In;
    End If;
  
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Get_Docinfo;

  --33、查询一个检查中相同原型ID的报告数量
  Procedure p_Get_Sameantetypedoccounts
  (
    Val       Out t_Refcur,
    医嘱id_In 影像报告记录.医嘱id%Type,
    原型id_In 影像报告记录.原型id%Type
  ) Is
  Begin
    Open Val For
      Select Count(Id) As Doccounts
      From 影像报告记录
      Where 医嘱id = 医嘱id_In
      And 原型id = 原型id_In;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Get_Sameantetypedoccounts;

  --34、提取报告图存储信息
  Procedure p_Get_Docimagesaveinof_By_Id
  (
    Val   Out t_Refcur,
    Id_In 影像报告记录.Id%Type
  ) Is
  Begin
    Open Val For
      Select 设备号, 创建时间 From 影像报告记录 Where Id = Id_In;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Get_Docimagesaveinof_By_Id;

  --35、修改原型使用次数
  Procedure p_Update_Antetypeusecount(Id_In 影像报告原型清单.Id%Type) Is
  Begin
    Update 影像报告原型清单 Set 使用次数 = 使用次数 + 1 Where Id = Id_In;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Update_Antetypeusecount;

  --36、更新影像检查图像的报告图标记
  Procedure p_Update_Rptimage
  (
    Uid_In        影像检查图象.图像uid%Type,
    Actiontype_In Number
  ) Is
    v_Sql Varchar2(4000);
    No_Column Exception;
    Pragma Exception_Init(No_Column, -00904);
  Begin
    If Actiontype_In = 1 Then
      v_Sql := 'Update 影像检查图象 Set 报告图 = Nvl(报告图, 0) + 1 Where 图像uid = :1';
    Else
      v_Sql := 'Update 影像检查图象
      Set 报告图 = Decode(报告图, Null, Null, Decode(Nvl(报告图, 0) - 1, 0, Null, Nvl(报告图, 0) - 1))
      Where 图像uid = :1';
    End If;
    Execute Immediate v_Sql
      Using Uid_In;
  Exception
    When No_Column Then
      --兼容处理，10.36新增加 报告图 字段，问题号 103996
      Null;
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Update_Rptimage;

  --37、提取打印控制信息
  Procedure p_Get_Printcontrol
  (
    Val       Out t_Refcur,
    报告id_In 影像报告记录.Id%Type
  ) Is
    v_紧急     Number;
    v_打印控制 Number;
  Begin
  
    Select Nvl(Decode(a.急诊, 1, 1, b.紧急标志), 0) As 紧急
    Into v_紧急
    From 病人挂号记录 a, 病人医嘱记录 b
    Where a.No(+) = b.挂号单
    And b.Id = (Select c.医嘱id From 影像报告记录 c Where c.Id = 报告id_In);
  
    Select Nvl(Extractvalue(b.Column_Value, '/root/print_limit'), 0) Printlimit
    Into v_打印控制
    From 影像报告原型清单 a, Table(Xmlsequence(Extract(a.控制选项, '/root'))) b, 影像报告记录 c
    Where a.Id = c.原型id
    And c.Id = 报告id_In;
  
    Open Val For
      Select v_紧急 As 紧急, v_打印控制 As 打印控制 From Dual;
  Exception
    When Others Then
      Zl_Errorcenter(Sqlcode, Sqlerrm);
  End p_Get_Printcontrol;

End b_Pacs_Rptmanage;
/

--114577:刘鹏飞,2017-10-16,病人标记设置处理
Create Or Replace Procedure Zl_病区标记内容_Update
(
  病区id_In   病区标记内容.病区id%Type,
  主题序号_In 病区标记内容.病区id%Type,
  标记序号_In 病区标记内容.病区id%Type,
  说明_In     病区标记内容.说明%Type,
  图形索引_In 病区标记内容.图形索引%Type,
  有效天数_In 病区标记内容.有效天数%Type,
  是否特殊_In 病区标记内容.是否特殊%Type := NULL
) As
Begin
  If 病区id_In = 0 Then
    Update 病区标记内容
    Set 说明 = 说明_In, 图形索引 = 图形索引_In, 有效天数 = 有效天数_In, 是否特殊 = 是否特殊_In
    Where 病区id Is Null And 主题序号 = 主题序号_In And 标记序号 = 标记序号_In;
  Else
    Update 病区标记内容
    Set 说明 = 说明_In, 图形索引 = 图形索引_In, 有效天数 = 有效天数_In, 是否特殊 = 是否特殊_In
    Where 病区id = 病区id_In And 主题序号 = 主题序号_In And 标记序号 = 标记序号_In;
  End If;
Exception
  When Others Then
    Zl_Errorcenter(Sqlcode, Sqlerrm);
End Zl_病区标记内容_Update;
/

--114577:刘鹏飞,2017-10-16,病人标记设置处理
Create Or Replace Procedure Zl_病区标记内容_Insert
(
  病区id_In   病区标记内容.病区id%Type,
  主题序号_In 病区标记内容.病区id%Type,
  标记序号_In 病区标记内容.病区id%Type,
  说明_In     病区标记内容.说明%Type,
  图形索引_In 病区标记内容.图形索引%Type,
  有效天数_In 病区标记内容.有效天数%Type,
  是否特殊_In 病区标记内容.是否特殊%Type :=NULL
) As
Begin
  Insert Into 病区标记内容
    (病区id, 主题序号, 标记序号, 说明, 图形索引, 有效天数, 是否特殊)
  Values
    (Decode(病区id_In, 0, Null, 病区id_In), 主题序号_In, 标记序号_In, 说明_In, 图形索引_In, 有效天数_In, 是否特殊_In);
Exception
  When Others Then
    Zl_Errorcenter(Sqlcode, Sqlerrm);
End Zl_病区标记内容_Insert;
/

--114577:刘鹏飞,2017-10-16,病人标记设置处理
Create Or Replace Procedure Zl_病区标记内容_Delete
(
  病区id_In   病区标记内容.病区id%Type,
  主题序号_In 病区标记内容.病区id%Type,
  标记序号_In 病区标记内容.病区id%Type
) As
Begin
  --标记序号=0 删除改标记下的所有信息。
  If 标记序号_In = 0 Then
    If 病区id_In = 0 Then
      Delete From 病区标记内容 Where 病区id Is Null And 主题序号 = 主题序号_In;
    Else
      Delete From 病区标记内容 Where 病区id = 病区id_In And 主题序号 = 主题序号_In;
    End If;
  Else
    If 病区id_In = 0 Then
      Delete From 病区标记内容 Where 病区id Is Null And 主题序号 = 主题序号_In And 标记序号 = 标记序号_In;
    Else
      Delete From 病区标记内容 Where 病区id = 病区id_In And 主题序号 = 主题序号_In And 标记序号 = 标记序号_In;
    End If;
  End If;
Exception
  When Others Then
    Zl_Errorcenter(Sqlcode, Sqlerrm);
End Zl_病区标记内容_Delete;
/

--114577:刘鹏飞,2017-10-16,病人标记设置处理
Create Or Replace Procedure Zl_病区标记记录_Update
(
  病区id_In     In 病区标记记录.病区id%Type,
  病人id_In     In 病区标记记录.病人id%Type,
  主页id_In     In 病区标记记录.主页id%Type,
  主题序号_In   In 病区标记记录.主题序号%Type,
  标记序号_In   In 病区标记记录.标记序号%Type,
  标记顺序_In   In 病区标记记录.标记顺序%Type,
  主题病区id_In In 病区标记记录.主题病区id%Type := Null
) Is
Begin
  --删除本病区已失效的数据
  Delete 病区标记记录 a
  Where 病区id = 病区id_In And
        (Floor(Sysdate - 日期)) >=
        (Select Nvl(b.有效天数, 0)
         From 病区标记内容 b
         Where Nvl(b.病区id, 0) = Nvl(a.主题病区id, 0) And b.主题序号 = a.主题序号 And b.标记序号 = a.标记序号 And Nvl(有效天数, 0) <> 0);
  --删除本病区一周内出院病人的数据
  Delete 病区标记记录 a
  Where (病区id, 病人id, 主页id) In
        (Select 当前病区id, 病人id, 主页id
         From 病案主页
         Where 当前病区id + 0 = 病区id_In And 出院日期 Between Sysdate - 7 And Sysdate);

  If 标记序号_In = 0 Then
    --清除本主题标注
    Delete 病区标记记录
    Where 病区id = 病区id_In And 病人id = 病人id_In And 主页id = 主页id_In And Nvl(主题病区id, 0) = Nvl(主题病区id_In, 0) And
          主题序号 = 主题序号_In;
  Else
    --更新有效记录
    Update 病区标记记录
    Set 标记序号 = 标记序号_In, 标记顺序 = 标记顺序_In
    Where 病区id = 病区id_In And 病人id = 病人id_In And 主页id = 主页id_In And Nvl(主题病区id, 0) = Nvl(主题病区id_In, 0) And
          主题序号 = 主题序号_In;
    --没有则插入一条有效记录
    If Sql%Rowcount = 0 Then
      Insert Into 病区标记记录
        (病区id, 病人id, 主页id, 主题病区id, 主题序号, 标记序号, 标记顺序, 日期)
      Values
        (病区id_In, 病人id_In, 主页id_In, 主题病区id_In, 主题序号_In, 标记序号_In, 标记顺序_In, Sysdate);
    End If;
  End If;
Exception
  When Others Then
    Zl_Errorcenter(Sqlcode, Sqlerrm);
End Zl_病区标记记录_Update;
/

--112801:焦博,2017-10-19,修正过程zl_费用审核记录_delete取消审核已经销账的门诊费用时报错
Create Or Replace Procedure Zl_费用审核记录_Delete
(
  费用id_In In 费用审核记录.费用id%Type,
  性质_In   In 费用审核记录.性质%Type
) Is
  v_Err_Msg Varchar2(100);
  Err_Item Exception;
  n_Count Number(4);
  v_No    门诊费用记录.No%Type;
Begin
  Select Count(a.Id), Max(a.No)
  Into n_Count, v_No
  From (Select a.No, a.Id
         From 门诊费用记录 A, (Select Mod(记录性质, 10) As 记录性质, NO, 序号 From 门诊费用记录 Where ID = 费用id_In) B
         Where a.No = b.No And Mod(a.记录性质, 10) = b.记录性质 And a.序号 = b.序号
         Group By a.No, Mod(a.记录性质, 10), a.序号,a.id
         Having Sum(a.数次) <> 0 Or Sum(a.实收金额) <> 0) A;
  If n_Count = 0 Then
    v_Err_Msg := '[ZLSOFT]单据『' || v_No || '』可能因并发原因,已经被他人转出或退费,不能取消审核![ZLSOFT]';
    Raise Err_Item;
  End If;
  Delete From 费用审核记录 Where 费用id = 费用id_In And 性质 = 性质_In;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, v_Err_Msg);
  
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_费用审核记录_Delete;
/

--114403:谢荣,2017-10-13,具有加号权限的预留号挂号问题。
CREATE OR REPLACE Procedure Zl_病人挂号记录_Insert
( 
  病人id_In       门诊费用记录.病人id%Type, 
  门诊号_In       门诊费用记录.标识号%Type, 
  姓名_In         门诊费用记录.姓名%Type, 
  性别_In         门诊费用记录.性别%Type, 
  年龄_In         门诊费用记录.年龄%Type, 
  付款方式_In     门诊费用记录.付款方式%Type, --用于存放病人的医疗付款方式编号 
  费别_In         门诊费用记录.费别%Type, 
  单据号_In       门诊费用记录.No%Type, 
  票据号_In       门诊费用记录.实际票号%Type, 
  序号_In         门诊费用记录.序号%Type, 
  价格父号_In     门诊费用记录.价格父号%Type, 
  从属父号_In     门诊费用记录.从属父号%Type, 
  收费类别_In     门诊费用记录.收费类别%Type, 
  收费细目id_In   门诊费用记录.收费细目id%Type, 
  数次_In         门诊费用记录.数次%Type, 
  标准单价_In     门诊费用记录.标准单价%Type, 
  收入项目id_In   门诊费用记录.收入项目id%Type, 
  收据费目_In     门诊费用记录.收据费目%Type, 
  结算方式_In     病人预交记录.结算方式%Type, --现金的结算名称 
  应收金额_In     门诊费用记录.应收金额%Type, 
  实收金额_In     门诊费用记录.实收金额%Type, 
  病人科室id_In   门诊费用记录.病人科室id%Type, 
  开单部门id_In   门诊费用记录.开单部门id%Type, 
  执行部门id_In   门诊费用记录.执行部门id%Type, 
  操作员编号_In   门诊费用记录.操作员编号%Type, 
  操作员姓名_In   门诊费用记录.操作员姓名%Type, 
  发生时间_In     门诊费用记录.发生时间%Type, 
  登记时间_In     门诊费用记录.登记时间%Type, 
  医生姓名_In     挂号安排.医生姓名%Type, 
  医生id_In       挂号安排.医生id%Type, 
  病历费_In       Number, --该条记录是否病历工本费 
  急诊_In         Number, 
  号别_In         挂号安排.号码%Type, 
  诊室_In         门诊费用记录.发药窗口%Type, 
  结帐id_In       门诊费用记录.结帐id%Type, 
  领用id_In       票据使用明细.领用id%Type, 
  预交支付_In     病人预交记录.冲预交%Type, --刷卡挂号时使用的预交金额,序号为1传入. 
  现金支付_In     病人预交记录.冲预交%Type, --挂号时现金支付部份金额,序号为1传入. 
  个帐支付_In     病人预交记录.冲预交%Type, --挂号时个人帐户支付金额,,序号为1传入. 
  保险大类id_In   门诊费用记录.保险大类id%Type, 
  保险项目否_In   门诊费用记录.保险项目否%Type, 
  统筹金额_In     门诊费用记录.统筹金额%Type, 
  摘要_In         门诊费用记录.摘要%Type, --预约挂号摘要信息 
  预约挂号_In     Number := 0, --预约挂号时用(记录状态=0,发生时间为预约时间),此时不需要传入结算相关参数 
  收费票据_In     Number := 0, --挂号是否使用收费票据 
  保险编码_In     门诊费用记录.保险编码%Type, 
  复诊_In         病人挂号记录.复诊%Type := 0, 
  号序_In         挂号序号状态.序号%Type := Null, --预约时填入费用记录的发药窗口字段,挂号时填入挂号记录 
  社区_In         病人挂号记录.社区%Type := Null, 
  预约接收_In     Number := 0, 
  预约方式_In     预约方式.名称%Type := Null, 
  生成队列_In     Number := 0, 
  卡类别id_In     病人预交记录.卡类别id%Type := Null, 
  结算卡序号_In   病人预交记录.结算卡序号%Type := Null, 
  卡号_In         病人预交记录.卡号%Type := Null, 
  交易流水号_In   病人预交记录.交易流水号%Type := Null, 
  交易说明_In     病人预交记录.交易说明%Type := Null, 
  合作单位_In     病人预交记录.合作单位%Type := Null, 
  操作类型_In     Number := 0, 
  险类_In         病人挂号记录.险类%Type := Null, 
  结算模式_In     Number := 0, 
  记帐费用_In     Number := 0, 
  退号重用_In     Number := 1, 
  修正病人费别_In Number := 0, 
  更新交款余额_In Number := 0, --是否更新人员交款余额，主要是处理统一操作员登录多台自助机的情况 
  修正病人年龄_In Number := 0, 
  收费单_In       病人挂号记录.收费单%Type := Null 
) As 
  --------------------------------------------------------------------------- 
  -- 
  --参数: 
  --     操作类型_in:0-正常挂号或者预约 1-操作员拥有加号权限加号 
  --     修正病人费别_In:0-不修改病人费别 1-修改病人费别 
  ---------------------------------------------------------------------------- 
  --该游标用于收费冲预交的可用预交列表 
  --以ID排序，优先冲上次未冲完的。 
  Cursor c_Deposit(v_病人id 病人信息.病人id%Type) Is 
    Select NO, Sum(Nvl(金额, 0) - Nvl(冲预交, 0)) As 金额, Min(记录状态) As 记录状态, Nvl(Max(结帐id), 0) As 结帐id, 
           Max(Decode(记录性质, 1, ID, 0) * Decode(记录状态, 2, 0, 1)) As 原预交id 
    From 病人预交记录 
    Where 记录性质 In (1, 11) And 病人id = v_病人id And Nvl(预交类别, 2) = 1 Having Sum(Nvl(金额, 0) - Nvl(冲预交, 0)) <> 0 
    Group By NO 
    Order By 结帐id, NO; 
  --功能：新增一行病人挂号费用，并将结算汇总到病人预交记录 
  --       同时汇总相关的汇总表(病人挂号汇总、费用汇总) 
  --       第一行费用处理票据使用情况(领用ID_IN>0) 
 
  v_Err_Msg Varchar2(255); 
  Err_Item Exception; 
 
  v_排队号码 排队叫号队列.排队号码%Type; 
  v_现金     结算方式.名称%Type; 
  v_个人帐户 结算方式.名称%Type; 
  v_队列名称 排队叫号队列.队列名称%Type; 
 
  n_分时段       Number; 
  n_时段限号     Number; 
  n_时段限约     Number; 
  d_时段时间     Date; 
  d_最大序号时间 Date; 
  n_追加号       Number := 0; --处理时段过期 追加挂号的情况 
  n_已约数       病人挂号汇总.已约数%Type; 
  n_已接收       病人挂号汇总.其中已接收%Type; 
  n_预约有效时间 Number; 
  n_失效数       Number; 
  n_失约挂号     Number := 0; 
  n_已用数量     Number; 
  n_锁定         Number := 0; 
 
  n_打印id   票据打印内容.Id%Type; 
  n_费用id   门诊费用记录.Id%Type; 
  n_预交金额 病人预交记录.金额%Type; 
  n_当前金额 病人预交记录.金额%Type; 
  n_返回值   病人预交记录.金额%Type; 
  n_预交id   病人预交记录.Id%Type; 
  n_消费卡id 消费卡目录.Id%Type; 
  n_挂号id   病人挂号记录.Id%Type; 
 
  n_组id           财务缴款分组.Id%Type; 
  n_序号           挂号序号状态.序号%Type; 
  n_已用序号       挂号序号状态.序号%Type; 
  n_序号控制       挂号安排.序号控制%Type; 
  n_分诊台签到排队 Number; 
  n_Count          Number; 
  n_限号数         Number(18); 
  n_自制卡         Number; 
  d_排队时间       Date; 
  d_序号时间       Date; 
  v_费别           费别.名称%Type; 
  n_时段序号       Number := -1; 
  n_预约生成队列   Number; 
  n_安排id         挂号安排.Id%Type; 
  n_计划id         挂号安排计划.Id%Type := 0; 
  v_星期           挂号安排限制.限制项目%Type; 
  n_限约数         Number(18); 
  n_已挂数         Number(4) := 0; 
 
  n_挂出的最大序号 Number(4) := 0; 
  n_结算模式       病人信息.结算模式%Type; 
  v_排队序号       排队叫号队列.排队序号%Type; 
  v_机器名         挂号序号状态.机器名%Type; 
  v_序号操作员     挂号序号状态.操作员姓名%Type; 
  v_序号机器名     挂号序号状态.机器名%Type; 
  v_付款方式       病人挂号记录.医疗付款方式%Type; 
  v_Temp           Varchar2(3000); 
  n_分时点显示     Number(3); 
  n_号序使用否     Number(3); 
  d_启用时间       Date; 
Begin 
  --获取当前机器名称 
  Select Terminal Into v_机器名 From V$session Where Audsid = Userenv('sessionid'); 
  n_组id := Zl_Get组id(操作员姓名_In); 
  If 费别_In Is Null Then 
    Begin 
      Select 名称 Into v_费别 From 费别 Where 缺省标志 = 1 And Rownum < 2; 
      Update 病人信息 Set 费别 = v_费别 Where 病人id = 病人id_In; 
    Exception 
      When Others Then 
        v_Err_Msg := '无法确定病人费别，请检查缺省费别是否正确设置！'; 
        Raise Err_Item; 
    End; 
  Else 
    v_费别 := 费别_In; 
    If Nvl(修正病人费别_In, 0) = 1 Then 
      Begin 
        Update 病人信息 Set 费别 = v_费别 Where 病人id = 病人id_In; 
      Exception 
        When Others Then 
          v_Err_Msg := '没有找到对应的病人！'; 
          Raise Err_Item; 
      End; 
    End If; 
  End If; 
 
  If Nvl(修正病人年龄_In, 0) = 1 Then 
    Begin 
      Update 病人信息 Set 年龄 = 年龄_In Where 病人id = 病人id_In; 
    Exception 
      When Others Then 
        v_Err_Msg := '没有找到对应的病人！'; 
        Raise Err_Item; 
    End; 
  End If; 
 
  Begin 
    Delete From 挂号序号状态 
    Where 号码 = 号别_In And 日期 = 发生时间_In And 序号 = 号序_In And 状态 = 3 And 操作员姓名 = 操作员姓名_In; 
  Exception 
    When Others Then 
      Null; 
  End; 
  v_Temp := zl_GetSysParameter(256); 
  If v_Temp Is Null Or Substr(v_Temp, 1, 1) = '0' Then 
    Null; 
  Else 
    Begin 
      d_启用时间 := To_Date(Substr(v_Temp, 3), 'YYYY-MM-DD hh24:mi:ss'); 
    Exception 
      When Others Then 
        d_启用时间 := Null; 
    End; 
    If d_启用时间 Is Not Null Then 
      If 发生时间_In > d_启用时间 Then 
        v_Err_Msg := '当前挂号的发生时间' || To_Char(发生时间_In, 'yyyy-mm-dd hh24:mi:ss') || '已经启用了出诊表排班模式,不能再使用计划排班模式挂号!'; 
        Raise Err_Item; 
      End If; 
    End If; 
  End If; 
 
  If Nvl(预约挂号_In, 0) = 0 Then 
    --挂号或者预约接收 
    --因为现在有按日编单据号规则,日挂号量不能超过10000次,所以要检查唯一约束。 
    Select Count(*) 
    Into n_Count 
    From 门诊费用记录 
    Where 记录性质 = 4 And 记录状态 In (1, 3) And 序号 = 序号_In And NO = 单据号_In; 
    If n_Count <> 0 Then 
      v_Err_Msg := '挂号单据号重复,不能保存！' || Chr(13) || '如果使用了按日顺序编号,当日挂号量不能超过10000人次。'; 
      Raise Err_Item; 
    End If; 
 
    --获取结算方式名称 
    Begin 
      Select 名称 Into v_现金 From 结算方式 Where 性质 = 1; 
    Exception 
      When Others Then 
        v_现金 := '现金'; 
    End; 
    Begin 
      Select 名称 Into v_个人帐户 From 结算方式 Where 性质 = 3; 
    Exception 
      When Others Then 
        v_个人帐户 := '个人帐户'; 
    End; 
  End If; 
 
  n_序号 := 号序_In; 
  Select Decode(To_Char(发生时间_In, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五', '7', '周六', Null) 
  Into v_星期 
  From Dual; 
 
  --挂号获取安排 
  Begin 
    Select a.Id, a.序号控制, Nvl(b.限号数, 0), Nvl(b.限约数, 0) 
    Into n_安排id, n_序号控制, n_限号数, n_限约数 
    From 挂号安排 A, 挂号安排限制 B 
    Where a.Id = b.安排id(+) And b.限制项目(+) = v_星期 And a.号码 = 号别_In; 
 
  Exception 
    When Others Then 
      n_安排id := -1; 
  End; 
 
  --如果是病历费或者号别为空时不检查 
  If Nvl(病历费_In, 0) = 0 Or 号别_In Is Not Null Then 
    If n_安排id = -1 Then 
      v_Err_Msg := '不存在相应的挂号安排数据,请检查'; 
      Raise Err_Item; 
    End If; 
  End If; 
 
  If Nvl(预约挂号_In, 0) = 1 Then 
    --首先获取计划 
    Begin 
      Select ID 
      Into n_计划id 
      From 挂号安排计划 
      Where 安排id = n_安排id And 审核时间 Is Not Null And 
            Nvl(生效时间, To_Date('1900-01-01', 'yyyy-mm-dd')) = 
            (Select Max(a.生效时间) As 生效 
             From 挂号安排计划 A 
             Where a.审核时间 Is Not Null And 发生时间_In Between Nvl(a.生效时间, To_Date('1900-01-01', 'yyyy-mm-dd')) And 
                   Nvl(a.失效时间, To_Date('3000-01-01', 'yyyy-mm-dd')) And a.安排id = n_安排id) And 
            发生时间_In Between Nvl(生效时间, To_Date('1900-01-01', 'yyyy-mm-dd')) And 
            Nvl(失效时间, To_Date('3000-01-01', 'yyyy-mm-dd')); 
 
    Exception 
      When Others Then 
        n_计划id := 0; 
    End; 
    If Nvl(n_计划id, 0) <> 0 Then 
      Begin 
        --获取计划的限制 
        Select a.Id, a.序号控制, Nvl(b.限号数, 0) As 限号数, Nvl(b.限约数, 0) As 限约数 
        Into n_计划id, n_序号控制, n_限号数, n_限约数 
        From 挂号安排计划 A, 挂号计划限制 B 
        Where a.号码 = 号别_In And a.Id = n_计划id And a.审核时间 Is Not Null And a.Id = b.计划id(+) And b.限制项目(+) = v_星期; 
      Exception 
        When Others Then 
          v_Err_Msg := '不存相应的挂号安排或计划数据,请检查'; 
          Raise Err_Item; 
      End; 
    End If; 
  End If; 
 
  --获取是否分时段 
  If Nvl(n_计划id, 0) = 0 Then 
    Select Count(Rownum) Into n_分时段 From 挂号安排时段 Where 星期 = v_星期 And 安排id = n_安排id And Rownum <= 1; 
  Else 
    Select Count(Rownum) Into n_分时段 From 挂号计划时段 Where 星期 = v_星期 And 计划id = n_计划id And Rownum <= 1; 
  End If; 
 
  --分时段挂号时判断是否是过期挂号 也就是追加号的情况 目前只针对专家号分时段进行处理 
  If Nvl(预约挂号_In, 0) = 0 And n_分时段 > 0 And Nvl(n_序号控制, 0) = 1 And 号序_In Is Null And Nvl(操作类型_In, 0) = 0 Then 
    --发生时间_in>Sysdate 发生时间>最大的时段时间--号序_in is null 
    Begin 
      Select Max(To_Date(To_Char(发生时间_In, 'yyyy-mm-dd') || ' ' || To_Char(开始时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss')) 
      Into d_最大序号时间 
      From 挂号安排时段 
      Where 安排id = n_安排id And 星期 = v_星期 And Nvl(限制数量, 0) <> 0; 
      n_追加号 := Case Sign(发生时间_In - d_最大序号时间) 
                 When -1 Then 
                  0 
                 Else 
                  1 
               End; 
    Exception 
      When Others Then 
        n_追加号 := 0; 
    End; 
  End If; 
  d_时段时间 := 发生时间_In; 
 
  If 序号_In = 1 And Nvl(预约挂号_In, 0) = 0 And n_分时段 > 0 Then 
    --挂号时检查 是否分了时段,分了时段,把时段的限制条件给取出来 
    Begin 
      Select Nvl(序号, 0), 
             To_Date(To_Char(发生时间_In, 'yyyy-mm-dd') || ' ' || To_Char(开始时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss'), 
             限制数量, Decode(Nvl(是否预约, 0), 0, 0, 限制数量) 
      Into n_时段序号, d_时段时间, n_时段限号, n_时段限约 
      From 挂号安排时段 
      Where 安排id = n_安排id And 星期 = v_星期 And 
            (序号, 安排id, 星期) In (Select Nvl(Max(序号), -1), 安排id, 星期 
                               From 挂号安排时段 
                               Where 安排id = n_安排id And 星期 = v_星期 And 
                                     Decode(操作类型_In + n_追加号, 0, To_Char(发生时间_In, 'hh24:mi'), 
                                            To_Char(Nvl(开始时间, To_Date('1900-01-01', 'yyyy-mm-dd')), 'hh24:mi')) = 
                                     To_Char(Nvl(开始时间, To_Date('1900-01-01', 'yyyy-mm-dd')), 'hh24:mi') 
                               Group By 安排id, 星期); 
    Exception 
      When Others Then 
        n_时段序号 := -1; 
        n_分时段   := 0; 
        d_时段时间 := 发生时间_In; 
        n_时段限号 := 0; 
        n_时段限约 := 0; 
    End; 
  End If; 
 
  If 序号_In = 1 And Nvl(预约挂号_In, 0) = 1 And n_分时段 > 0 Then 
    --预约号,取计划 
    Begin 
      If Nvl(n_计划id, 0) = 0 Then 
        --没计划生效,取安排的数据 
        Select Nvl(序号, 0), 
               To_Date(To_Char(发生时间_In, 'yyyy-mm-dd') || ' ' || To_Char(c.开始时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss') As 时段时间, 
               限制数量, Decode(Nvl(是否预约, 0), 0, 0, 限制数量) 
        Into n_时段序号, d_时段时间, n_时段限号, n_时段限约 
        From 挂号安排时段 C 
        Where 安排id = n_安排id And 星期 = v_星期 And 
              (序号, 安排id, 星期) In 
              (Select Nvl(Max(c.序号), -1), 安排id, 星期 
               From 挂号安排时段 C 
               Where 安排id = n_安排id And c.星期 = v_星期 And 
                     Decode(操作类型_In, 1, To_Char(Nvl(c.开始时间, To_Date('1900-01-01', 'yyyy-mm-dd')), 'hh24:mi'), 
                            To_Char(发生时间_In, 'hh24:mi')) = 
                     To_Char(Nvl(c.开始时间, To_Date('1900-01-01', 'yyyy-mm-dd')), 'hh24:mi') 
               Group By 安排id, 星期); 
      Else 
        --有计划生效取计划 
        --没生效，代表是从挂号计划时段查询 
        Select Nvl(序号, -1), 
               To_Date(To_Char(发生时间_In, 'yyyy-mm-dd') || ' ' || To_Char(c.开始时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss') As 时段时间, 
               限制数量, Decode(Nvl(是否预约, 0), 0, 0, 限制数量) 
        Into n_时段序号, d_时段时间, n_时段限号, n_时段限约 
        From 挂号计划时段 C 
        Where 计划id = n_计划id And 星期 = v_星期 And 
              (序号, 计划id, 星期) In 
              (Select Nvl(Max(c.序号), -1), 计划id, 星期 
               From 挂号计划时段 C 
               Where 计划id = n_计划id And c.星期 = v_星期 And 
                     Decode(操作类型_In, 1, To_Char(Nvl(c.开始时间, To_Date('1900-01-01', 'yyyy-mm-dd')), 'hh24:mi'), 
                            To_Char(发生时间_In, 'hh24:mi')) = 
                     To_Char(Nvl(c.开始时间, To_Date('1900-01-01', 'yyyy-mm-dd')), 'hh24:mi') 
               Group By 计划id, 星期); 
      End If; 
    Exception 
      When Others Then 
        n_时段序号 := -1; 
        n_分时段   := 0; 
        d_时段时间 := 发生时间_In; 
        n_时段限号 := 0; 
        n_时段限约 := 0; 
    End; 
  End If; 
 
  If 序号_In = 1 Then 
 
    --获取当前未使用的序号 
    If Nvl(n_序号控制, 0) = 1 And n_分时段 = 0 Then 
      --<序号控制 未设置时段 获取可用的最大序号,以及已经使用的数量> 
      Begin 
        --最大序号 
        If 退号重用_In = 1 Then 
          Select Max(Nvl(序号, 0)), Sum(Decode(序号, Nvl(号序_In, 0), 0, 1)), Sum(Nvl(预约, 0)) 
          Into n_已用序号, n_已用数量, n_已约数 
          From 挂号序号状态 
          Where 号码 = 号别_In And 日期 Between Trunc(发生时间_In) And Trunc(发生时间_In) + 1 - 1 / 24 / 60 / 60 And 状态 Not In (4, 5); 
        Else 
          Select Max(Nvl(序号, 0)), Sum(Decode(序号, Nvl(号序_In, 0), 0, 1)), Sum(Nvl(预约, 0)) 
          Into n_已用序号, n_已用数量, n_已约数 
          From 挂号序号状态 
          Where 号码 = 号别_In And 日期 Between Trunc(发生时间_In) And Trunc(发生时间_In) + 1 - 1 / 24 / 60 / 60 And 状态 <> 5; 
        End If; 
      Exception 
        When Others Then 
          n_已用序号 := 0; 
          n_已用数量 := 0; 
      End; 
      If n_序号 Is Null Then 
        n_序号 := Nvl(n_已用序号, 0) + 1; 
      End If; 
      --<序号控制 未设置时段 获取可用的最大序号 以及已经使用的数量 --end> 
 
      --非加号的情况需要检查是否超过了限制 
      If 操作类型_In = 0 Then 
        If Nvl(预约挂号_In, 0) = 0 Then 
          --挂号时检查 ，非加号的情况下，检测当前号序是否被使用，防止并发情况下导致序号重复的可能。
          --启用序号控制未分时段 达到了限制 
          --检测挂号记录中当前序号是否已经使用，若未使用则不检测挂号数量
          Select Count(1)
          Into n_号序使用否
          From 挂号序号状态 
          Where 号码 = 号别_In And 序号= nvl(序号_In,0) And 日期 Between Trunc(发生时间_In) And Trunc(发生时间_In) + 1 - 1 / 24 / 60 / 60 And 操作员姓名 <> 操作员姓名_In; 
          if nvl(号序_In,0)>0 And n_号序使用否=1 then
              v_Err_Msg := '号别' || 号别_In || '号序' || to_char(n_号序使用否) || '在' || To_Char(Trunc(发生时间_In), 'yyyy-mm-dd ') || '已被其它用户使用！'; 
              Raise Err_Item; 
          end if;
        Else 
          --预约时检查 
          If n_限约数 = 0 Then 
            n_限约数 := n_限号数; 
          End If; 
 
          If n_限约数 <= n_已约数 And n_限约数 > 0 Then 
            v_Err_Msg := '号别' || 号别_In || '在' || To_Char(Trunc(发生时间_In), 'yyyy-mm-dd') || '已达到最大限约数！'; 
            Raise Err_Item; 
          End If; 
        End If; 
 
      Else 
        Null; 
        --启用序号控制,未分时段 加号情况   不处理,如果以后有限制条件以后补充 
      End If; 
 
    Elsif Nvl(n_分时段, 0) > 0 And Nvl(n_序号控制, 0) = 0 Then 
      --<--普通号分时段 这里只有预约一种情况--> 
      If 操作类型_In = 0 Then 
        --<正常预约挂号--> 
        Begin 
          Select Count(0) As 已挂数, Nvl(Sum(Decode(Nvl(Sign(a.日期 - d_时段时间), 0), 0, 1, 0)), 0) As 已约数 
          Into n_已挂数, n_已约数 
          From 挂号序号状态 A 
          Where a.号码 = 号别_In And 日期 Between Trunc(发生时间_In) And Trunc(发生时间_In) + 1 - 1 / 24 / 60 / 60 And 
                状态 Not In (4, 5); 
        Exception 
          When Others Then 
            n_已挂数 := 0; 
            n_已约数 := 0; 
        End; 
 
        n_时段限约 := n_时段限号; --普通号分时段的情况,29中n_时段限约始终是0 这里特殊处理 
        --检查限制数量 
        If n_限约数 = 0 Then 
          n_限约数 := n_限号数; 
        End If; 
        If n_时段限约 <= n_已约数 Or n_限约数 <= n_已约数 Then 
          v_Err_Msg := '号别' || 号别_In || '在时段' || To_Char(d_时段时间, 'hh24:mi') || '已达到最大限约数！'; 
          Raise Err_Item; 
        End If; 
        If n_限号数 <= n_已挂数 Then 
          v_Err_Msg := '号别' || 号别_In || To_Char(发生时间_In, 'yyyy-mm-dd') || '已达到最大限制数！'; 
          Raise Err_Item; 
        End If; 
      End If; 
 
      --没有达到时段的限号数 号码在当前时段往后追加 
 
      --获取当天挂出的最大号序 
      If 退号重用_In = 1 Then 
        Select Nvl(Max(序号), 0) 
        Into n_挂出的最大序号 
        From 挂号序号状态 A 
        Where a.日期 = d_时段时间 And 号码 = 号别_In And 状态 Not In (4, 5); 
      Else 
        Select Nvl(Max(序号), 0) 
        Into n_挂出的最大序号 
        From 挂号序号状态 A 
        Where a.日期 = d_时段时间 And 号码 = 号别_In And 状态 <> 5; 
      End If; 
 
      --设置序号 
      n_序号 := RPad(Nvl(n_时段序号, 0), Length(n_限号数) + Length(Nvl(n_时段序号, 0)), 0) + n_已约数 + 1; 
      If n_序号 <= Nvl(n_挂出的最大序号, 0) Then 
        n_序号 := Nvl(n_挂出的最大序号, 0) + 1; 
      End If; 
 
      --<--普通号分时段--End> 
    Elsif Nvl(n_分时段, 0) > 0 And Nvl(n_序号控制, 0) = 1 Then 
      --<启用序号控制 设置时段 
      --专家号分时段 
      Begin 
        If 退号重用_In = 1 Then 
          Select Max(序号), Sum(Decode(序号, Nvl(号序_In, 0), 0, 1)), Sum(Decode(Sign(日期 - d_时段时间), 0, 1, 0)) 
          Into n_已用序号, n_已挂数, n_已用数量 
          From 挂号序号状态 
          Where 号码 = 号别_In And 日期 Between Trunc(发生时间_In) And Trunc(发生时间_In) + 1 - 1 / 24 / 60 / 60 And 状态 Not In (4, 5); 
        Else 
          Select Max(序号), Sum(Decode(序号, Nvl(号序_In, 0), 0, 1)), Sum(Decode(Sign(日期 - d_时段时间), 0, 1, 0)) 
          Into n_已用序号, n_已挂数, n_已用数量 
          From 挂号序号状态 
          Where 号码 = 号别_In And 日期 Between Trunc(发生时间_In) And Trunc(发生时间_In) + 1 - 1 / 24 / 60 / 60 And 状态 <> 5; 
        End If; 
      Exception 
        When Others Then 
          n_已用序号 := 0; 
          n_已用数量 := 0; 
          n_已挂数   := 0; 
      End; 
 
      n_失效数 := 0; 
      If Nvl(预约挂号_In, 0) = 0 Then 
        n_预约有效时间 := Zl_To_Number(zl_GetSysParameter('预约有效时间', 1111)); 
        n_失约挂号     := Zl_To_Number(zl_GetSysParameter('失约用于挂号', 1111)); 
        If Nvl(n_预约有效时间, 0) <> 0 And Nvl(n_失约挂号, 0) > 0 Then 
          Begin 
            Select Sum(Decode(Sign((Sysdate - n_预约有效时间 / 24 / 60) - 日期), 1, 1, 0)) 
            Into n_失效数 
            From 挂号序号状态 
            Where 号码 = 号别_In And 日期 Between Trunc(Sysdate) And Sysdate And Nvl(预约, 0) = 1 And 状态 = 2; 
          Exception 
            When Others Then 
              n_失效数 := 0; 
          End; 
        End If; 
      End If; 
 
      If 操作类型_In = 0 Then 
        If Nvl(预约挂号_In, 0) = 0 Then 
 
          --挂号 追加号码时不检查时段限号数 
          If n_时段限号 <= n_已用数量 And Nvl(n_追加号, 0) = 0 Then 
            v_Err_Msg := '号别' || 号别_In || '在时段' || To_Char(d_时段时间, 'hh24:mi') || '已达到最大限制数！'; 
            Raise Err_Item; 
          End If; 
          If n_限号数 <= n_已挂数 - n_失效数 Then 
            v_Err_Msg := '号别' || 号别_In || '在' || To_Char(发生时间_In, 'yyyy-mm-dd') || '已达到最大限制数！'; 
            Raise Err_Item; 
          End If; 
 
        Else 
          --挂号 
          If n_限约数 = 0 Then 
            n_限约数 := n_限号数; 
          End If; 
          If n_限约数 <= n_已用数量 Then 
            v_Err_Msg := '号别' || 号别_In || '在时段' || To_Char(d_时段时间, 'hh24:mi') || '已达到最大限制数！'; 
            Raise Err_Item; 
          End If; 
          If n_限号数 <= n_已挂数 Then 
            v_Err_Msg := '号别' || 号别_In || '在' || To_Char(发生时间_In, 'yyyy-mm-dd') || '已达到最大限制数！'; 
            Raise Err_Item; 
          End If; 
        End If; 
      End If; 
      If n_序号 Is Null Then 
        --设置序号 
        If Nvl(n_已用序号, 0) < Nvl(n_时段序号, 0) Then 
          n_已用序号 := Nvl(n_时段序号, 0); 
        End If; 
        n_序号 := Nvl(n_已用序号, 0) + 1; 
      End If; 
    Elsif Nvl(n_分时段, 0) = 0 And Nvl(n_序号控制, 0) = 0 And Nvl(病历费_In, 0) = 0 And Nvl(号别_In, 0) > 0 Then 
      ---<--普通号  --> 
      Begin 
        Select 已挂数, 已约数 
        Into n_已用数量, n_已约数 
        From 病人挂号汇总 
        Where 日期 = Trunc(发生时间_In) And 号码 = 号别_In; 
      Exception 
        When Others Then 
          n_已用数量 := 0; 
          n_已约数   := 0; 
      End; 
      If Nvl(操作类型_In, 0) = 0 Then 
        If Nvl(预约挂号_In, 0) = 0 Then 
          --挂号 
          If Nvl(n_已用数量, 0) >= Nvl(n_限号数, 0) And Nvl(n_限号数, 0) > 0 Then 
            v_Err_Msg := '号别' || 号别_In || '在' || To_Char(发生时间_In, 'yyyy-mm-dd') || '已达到最大限制数！'; 
            Raise Err_Item; 
          End If; 
        Else 
          --预约 
          If (Nvl(n_限约数, 0) > 0 And Nvl(n_已约数, 0) >= Nvl(n_限约数, 0)) Or 
             (Nvl(n_已用数量, 0) >= Nvl(n_限号数, 0) And Nvl(n_限号数, 0) > 0) Then 
            v_Err_Msg := '号别' || 号别_In || '在' || To_Char(发生时间_In, 'yyyy-mm-dd') || '已达到最大限制数！'; 
            Raise Err_Item; 
          End If; 
        End If; 
      End If; 
      ---<--普通号  --> 
    End If; 
  End If; 
 
  --更新挂号序号状态 
  If 序号_In = 1 And Not n_序号 Is Null Then 
    If n_分时段 = 1 Then 
      d_序号时间 := 发生时间_In; 
    Else 
      d_序号时间 := Trunc(发生时间_In); 
    End If; 
    --锁定序号的处理 
    Begin 
      Select 操作员姓名, 机器名 
      Into v_序号操作员, v_序号机器名 
      From 挂号序号状态 
      Where 状态 = 5 And 号码 = 号别_In And 日期 = d_序号时间 And 序号 = n_序号; 
      n_锁定 := 1; 
    Exception 
      When Others Then 
        v_序号操作员 := Null; 
        v_序号机器名 := Null; 
        n_锁定       := 0; 
    End; 
    If n_锁定 = 0 Then 
      Update 挂号序号状态 
      Set 状态 = Decode(预约挂号_In, 1, 2, 1), 预约 = Decode(预约接收_In, 1, 1, 0), 登记时间 = Sysdate 
      Where 号码 = 号别_In And 日期 = d_序号时间 And 序号 = n_序号 And 状态 = 3 And 操作员姓名 = 操作员姓名_In; 
      If Sql%RowCount = 0 Then 
        Begin 
          If Nvl(n_分时段, 0) = 0 Or Nvl(预约挂号_In, 0) = 1 Or (Nvl(n_序号控制, 0) = 0 And Nvl(号序_In, 0) = 0) Then 
            Insert Into 挂号序号状态 
              (号码, 日期, 序号, 状态, 操作员姓名, 预约, 登记时间) 
            Values 
              (号别_In, d_序号时间, n_序号, Decode(预约挂号_In, 1, 2, 1), 操作员姓名_In, Decode(预约接收_In, 1, 1, 0), Sysdate); 
            If Nvl(预约挂号_In, 0) = 0 And 预约方式_In Is Not Null Then 
              Update 挂号序号状态 Set 预约 = 1 Where 号码 = 号别_In And 日期 = d_序号时间 And 序号 = n_序号; 
            End If; 
          Elsif Nvl(n_分时段, 0) > 0 Then 
            --分时段后专家号 失约的预约号允许挂号 
            Update 挂号序号状态 
            Set 状态 = Decode(预约挂号_In, 1, 2, 1), 操作员姓名 = 操作员姓名_In, 预约 = Decode(预约接收_In, 1, 1, 0), 登记时间 = Sysdate 
            Where 号码 = 号别_In And 日期 = d_序号时间 And 序号 = n_序号 And 状态 = 2; 
            If Sql%NotFound Then 
              Insert Into 挂号序号状态 
                (号码, 日期, 序号, 状态, 操作员姓名, 预约, 登记时间) 
              Values 
                (号别_In, d_序号时间, n_序号, Decode(预约挂号_In, 1, 2, 1), 操作员姓名_In, Decode(预约接收_In, 1, 1, 0), Sysdate); 
            End If; 
            If Nvl(预约挂号_In, 0) = 0 And 预约方式_In Is Not Null Then 
              Update 挂号序号状态 Set 预约 = 1 Where 号码 = 号别_In And 日期 = d_序号时间 And 序号 = n_序号; 
            End If; 
          End If; 
        Exception 
          When Others Then 
            v_Err_Msg := '序号' || n_序号 || '已被使用,请重新选择一个序号.'; 
            Raise Err_Item; 
        End; 
      End If; 
    Else 
      If 操作员姓名_In <> v_序号操作员 Or v_机器名 <> v_序号机器名 Then 
        v_Err_Msg := '序号' || n_序号 || '已被自助机' || v_机器名 || '锁定,请重新选择一个序号.'; 
        Raise Err_Item; 
      Else 
        Update 挂号序号状态 
        Set 状态 = Decode(预约挂号_In, 1, 2, 1), 预约 = Decode(预约接收_In, 1, 1, 0), 登记时间 = Sysdate 
        Where 号码 = 号别_In And 日期 = d_序号时间 And 序号 = n_序号 And 状态 = 5 And 操作员姓名 = 操作员姓名_In And 机器名 = v_机器名; 
        If Nvl(预约挂号_In, 0) = 0 And 预约方式_In Is Not Null Then 
          Update 挂号序号状态 Set 预约 = 1 Where 号码 = 号别_In And 日期 = d_序号时间 And 序号 = n_序号; 
        End If; 
      End If; 
    End If; 
  End If; 
 
  --产生病人挂号费用(可能单独是或包括病历费用) 
  Select 病人费用记录_Id.Nextval Into n_费用id From Dual; --应该通过程序得到 
 
  Insert Into 门诊费用记录 
    (ID, 记录性质, 记录状态, 序号, 价格父号, 从属父号, NO, 实际票号, 门诊标志, 加班标志, 附加标志, 发药窗口, 病人id, 标识号, 付款方式, 姓名, 性别, 年龄, 费别, 病人科室id, 收费类别, 
     计算单位, 收费细目id, 收入项目id, 收据费目, 付数, 数次, 标准单价, 应收金额, 实收金额, 结帐金额, 结帐id, 记帐费用, 开单部门id, 开单人, 划价人, 执行部门id, 执行人, 操作员编号, 操作员姓名, 
     发生时间, 登记时间, 保险大类id, 保险项目否, 保险编码, 统筹金额, 摘要, 结论, 缴款组id) 
  Values 
    (n_费用id, 4, Decode(预约挂号_In, 1, 0, 1), 序号_In, Decode(价格父号_In, 0, Null, 价格父号_In), 从属父号_In, 单据号_In, 票据号_In, 1, 急诊_In, 
     病历费_In, Decode(预约挂号_In, 1, To_Char(n_序号), 诊室_In), Decode(病人id_In, 0, Null, 病人id_In), 
     Decode(门诊号_In, 0, Null, 门诊号_In), 付款方式_In, 姓名_In, Decode(姓名_In, Null, Null, 性别_In), Decode(姓名_In, Null, Null, 年龄_In), 
     v_费别, 病人科室id_In, 收费类别_In, 号别_In, 收费细目id_In, 收入项目id_In, 收据费目_In, 1, 数次_In, 标准单价_In, 应收金额_In, 实收金额_In, 
     Decode(预约挂号_In, 1, Null, Decode(Nvl(记帐费用_In, 0), 1, Null, 实收金额_In)), 
     Decode(预约挂号_In, 1, Null, Decode(Nvl(记帐费用_In, 0), 1, Null, 结帐id_In)), Decode(Nvl(记帐费用_In, 0), 1, 1, 0), 开单部门id_In, 
     操作员姓名_In, Decode(预约挂号_In, 1, 操作员姓名_In, Null), 执行部门id_In, 医生姓名_In, 操作员编号_In, 操作员姓名_In, 发生时间_In, 登记时间_In, 保险大类id_In, 
     保险项目否_In, 保险编码_In, 统筹金额_In, 摘要_In, 预约方式_In, Decode(预约挂号_In, 1, Null, n_组id)); 
 
  --汇总结算到病人预交记录 
  If Nvl(预约挂号_In, 0) = 0 And Nvl(记帐费用_In, 0) = 0 Then 
 
    If (Nvl(现金支付_In, 0) <> 0 Or (Nvl(现金支付_In, 0) = 0 And Nvl(个帐支付_In, 0) = 0 And Nvl(预交支付_In, 0) = 0)) And 序号_In = 1 Then 
      Select 病人预交记录_Id.Nextval Into n_预交id From Dual; 
      Insert Into 病人预交记录 
        (ID, 记录性质, 记录状态, NO, 病人id, 结算方式, 冲预交, 收款时间, 操作员编号, 操作员姓名, 结帐id, 摘要, 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 
         结算性质) 
      Values 
        (n_预交id, 4, 1, 单据号_In, Decode(病人id_In, 0, Null, 病人id_In), Nvl(结算方式_In, v_现金), Nvl(现金支付_In, 0), 登记时间_In, 
         操作员编号_In, 操作员姓名_In, 结帐id_In, '挂号收费', n_组id, 卡类别id_In, 结算卡序号_In, 卡号_In, 交易流水号_In, 交易说明_In, 合作单位_In, 4); 
 
      If Nvl(结算卡序号_In, 0) <> 0 And Nvl(现金支付_In, 0) <> 0 Then 
 
        n_消费卡id := Null; 
        Begin 
          Select Nvl(自制卡, 0), 1 Into n_自制卡, n_Count From 卡消费接口目录 Where 编号 = 结算卡序号_In; 
        Exception 
          When Others Then 
            n_Count := 0; 
        End; 
        If n_Count = 0 Then 
          v_Err_Msg := '没有发现原结算卡的相应类别,不能继续操作！'; 
          Raise Err_Item; 
        End If; 
        If n_自制卡 = 1 Then 
          Select ID 
          Into n_消费卡id 
          From 消费卡目录 
          Where 接口编号 = 结算卡序号_In And 卡号 = 卡号_In And 
                序号 = (Select Max(序号) From 消费卡目录 Where 接口编号 = 结算卡序号_In And 卡号 = 卡号_In); 
        End If; 
        Zl_病人卡结算记录_Insert(结算卡序号_In, n_消费卡id, 结算方式_In, 现金支付_In, 卡号_In, Null, 登记时间_In, Null, 结帐id_In, n_预交id); 
      End If; 
 
    End If; 
 
    --对于医保挂号 
    If Nvl(个帐支付_In, 0) <> 0 And 序号_In = 1 Then 
      Insert Into 病人预交记录 
        (ID, 记录性质, 记录状态, NO, 病人id, 结算方式, 冲预交, 收款时间, 操作员编号, 操作员姓名, 结帐id, 摘要, 缴款组id, 结算性质) 
      Values 
        (病人预交记录_Id.Nextval, 4, 1, 单据号_In, Decode(病人id_In, 0, Null, 病人id_In), v_个人帐户, 个帐支付_In, 登记时间_In, 操作员编号_In, 
         操作员姓名_In, 结帐id_In, '医保挂号', n_组id, 4); 
    End If; 
 
    --对于就诊卡通过预交金挂号 
    If Nvl(预交支付_In, 0) <> 0 And 序号_In = 1 Then 
      n_预交金额 := 预交支付_In; 
      For r_Deposit In c_Deposit(病人id_In) Loop 
        n_当前金额 := Case 
                    When r_Deposit.金额 - n_预交金额 < 0 Then 
                     r_Deposit.金额 
                    Else 
                     n_预交金额 
                  End; 
 
        If r_Deposit.结帐id = 0 Then 
          --第一次冲预交(82592,将第一次标上结帐ID,冲预交标记为0) 
          Update 病人预交记录 Set 冲预交 = 0, 结帐id = 结帐id_In, 结算性质 = 4 Where ID = r_Deposit.原预交id; 
        End If; 
        --冲上次剩余额 
        Insert Into 病人预交记录 
          (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 预交类别, 科室id, 金额, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, 收款时间, 操作员姓名, 操作员编号, 
           冲预交, 结帐id, 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算性质) 
          Select 病人预交记录_Id.Nextval, NO, 实际票号, 11, 记录状态, 病人id, 主页id, 预交类别, 科室id, Null, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, 
                 登记时间_In, 操作员姓名_In, 操作员编号_In, n_当前金额, 结帐id_In, n_组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 4 
          From 病人预交记录 
          Where NO = r_Deposit.No And 记录状态 = r_Deposit.记录状态 And 记录性质 In (1, 11) And Rownum = 1; 
 
        --更新病人预交余额 
        Update 病人余额 
        Set 预交余额 = Nvl(预交余额, 0) - n_当前金额 
        Where 病人id = 病人id_In And 性质 = 1 And 类型 = Nvl(1, 2); 
        --检查是否已经处理完 
        If r_Deposit.金额 < n_预交金额 Then 
          n_预交金额 := n_预交金额 - r_Deposit.金额; 
        Else 
          n_预交金额 := 0; 
        End If; 
 
        If n_预交金额 = 0 Then 
          Exit; 
        End If; 
      End Loop; 
      If n_预交金额 > 0 Then 
        v_Err_Msg := '预交余不够支付本次支付金额,不能继续操作！'; 
        Raise Err_Item; 
      End If; 
      Delete From 病人余额 Where 病人id = 病人id_In And 性质 = 1 And Nvl(费用余额, 0) = 0 And Nvl(预交余额, 0) = 0; 
    End If; 
 
    --相关汇总表的处理 
    --人员缴款余额 
    If 序号_In = 1 And Nvl(更新交款余额_In, 0) = 0 Then 
      If Nvl(现金支付_In, 0) <> 0 Then 
        Update 人员缴款余额 
        Set 余额 = Nvl(余额, 0) + 现金支付_In 
        Where 性质 = 1 And 收款员 = 操作员姓名_In And 结算方式 = Nvl(结算方式_In, v_现金) 
        Returning 余额 Into n_返回值; 
 
        If Sql%RowCount = 0 Then 
          Insert Into 人员缴款余额 
            (收款员, 结算方式, 性质, 余额) 
          Values 
            (操作员姓名_In, Nvl(结算方式_In, v_现金), 1, 现金支付_In); 
          n_返回值 := 现金支付_In; 
        End If; 
        If Nvl(n_返回值, 0) = 0 Then 
          Delete From 人员缴款余额 
          Where 收款员 = 操作员姓名_In And 结算方式 = Nvl(结算方式_In, v_现金) And 性质 = 1 And Nvl(余额, 0) = 0; 
        End If; 
      End If; 
 
      If Nvl(个帐支付_In, 0) <> 0 Then 
        Update 人员缴款余额 
        Set 余额 = Nvl(余额, 0) + 个帐支付_In 
        Where 性质 = 1 And 收款员 = 操作员姓名_In And 结算方式 = v_个人帐户 
        Returning 余额 Into n_返回值; 
 
        If Sql%RowCount = 0 Then 
          Insert Into 人员缴款余额 (收款员, 结算方式, 性质, 余额) Values (操作员姓名_In, v_个人帐户, 1, 个帐支付_In); 
          n_返回值 := 个帐支付_In; 
        End If; 
        If Nvl(n_返回值, 0) = 0 Then 
          Delete From 人员缴款余额 
          Where 收款员 = 操作员姓名_In And 性质 = 1 And 结算方式 = v_个人帐户 And Nvl(余额, 0) = 0; 
        End If; 
      End If; 
    End If; 
  End If; 
 
  --病人挂号汇总(只处理一次,且单独收取病历费不处理) 
  If Nvl(预约挂号_In, 0) = 0 Then 
    --病人本次就诊(以发生时间为准) 
    If Nvl(病人id_In, 0) <> 0 And 序号_In = 1 Then 
      Update 病人信息 Set 就诊时间 = 发生时间_In, 就诊状态 = 1, 就诊诊室 = 诊室_In Where 病人id = 病人id_In; 
    End If; 
  End If; 
 
  If Nvl(预约挂号_In, 0) = 0 And Nvl(记帐费用_In, 0) = 1 Then 
    --记帐 
    If Nvl(病人id_In, 0) = 0 Then 
      v_Err_Msg := '要针对病人的挂号费进行记帐，必须是建档病人才能记帐挂号。'; 
      Raise Err_Item; 
    End If; 
 
    --病人余额 
    Update 病人余额 
    Set 费用余额 = Nvl(费用余额, 0) + Nvl(实收金额_In, 0) 
    Where 病人id = Nvl(病人id_In, 0) And 性质 = 1 And 类型 = 1; 
 
    If Sql%RowCount = 0 Then 
      Insert Into 病人余额 (病人id, 性质, 类型, 费用余额, 预交余额) Values (病人id_In, 1, 1, Nvl(实收金额_In, 0), 0); 
    End If; 
 
    --病人未结费用 
    Update 病人未结费用 
    Set 金额 = Nvl(金额, 0) + Nvl(实收金额_In, 0) 
    Where 病人id = 病人id_In And Nvl(主页id, 0) = 0 And Nvl(病人病区id, 0) = 0 And Nvl(病人科室id, 0) = Nvl(病人科室id_In, 0) And 
          Nvl(开单部门id, 0) = Nvl(开单部门id_In, 0) And Nvl(执行部门id, 0) = Nvl(执行部门id_In, 0) And 收入项目id + 0 = 收入项目id_In And 
          来源途径 + 0 = 1; 
 
    If Sql%RowCount = 0 Then 
      Insert Into 病人未结费用 
        (病人id, 主页id, 病人病区id, 病人科室id, 开单部门id, 执行部门id, 收入项目id, 来源途径, 金额) 
      Values 
        (病人id_In, Null, Null, 病人科室id_In, 开单部门id_In, 执行部门id_In, 收入项目id_In, 1, Nvl(实收金额_In, 0)); 
    End If; 
  End If; 
 
  --病人挂号记录 
  If 号别_In Is Not Null And 序号_In = 1 Then 
    --And Nvl(预约挂号_In, 0) = 0 
    Select 病人挂号记录_Id.Nextval Into n_挂号id From Dual; 
    Begin 
      Select 名称 Into v_付款方式 From 医疗付款方式 Where 编码 = 付款方式_In And Rownum < 2; 
    Exception 
      When Others Then 
        v_付款方式 := Null; 
    End; 
    Insert Into 病人挂号记录 
      (ID, NO, 记录性质, 记录状态, 病人id, 门诊号, 姓名, 性别, 年龄, 号别, 急诊, 诊室, 附加标志, 执行部门id, 执行人, 执行状态, 执行时间, 登记时间, 发生时间, 预约时间, 操作员编号, 
       操作员姓名, 复诊, 号序, 社区, 预约, 预约方式, 摘要, 交易流水号, 交易说明, 合作单位, 接收时间, 接收人, 预约操作员, 预约操作员编号, 险类, 医疗付款方式, 收费单) 
    Values 
      (n_挂号id, 单据号_In, Decode(Nvl(预约挂号_In, 0), 1, 2, 1), 1, 病人id_In, 门诊号_In, 姓名_In, 性别_In, 年龄_In, 号别_In, 急诊_In, 诊室_In, 
       Null, 执行部门id_In, 医生姓名_In, 0, Null, 登记时间_In, 发生时间_In, Decode(Nvl(预约挂号_In, 0), 1, 发生时间_In, Null), 操作员编号_In, 
       操作员姓名_In, 复诊_In, n_序号, 社区_In, Decode(预约接收_In, 1, 1, 0), 预约方式_In, 摘要_In, 交易流水号_In, 交易说明_In, 合作单位_In, 
       Decode(Nvl(预约挂号_In, 0), 0, 登记时间_In, Null), Decode(Nvl(预约挂号_In, 0), 0, 操作员姓名_In, Null), 
       Decode(Nvl(预约挂号_In, 0), 1, 操作员姓名_In, Null), Decode(Nvl(预约挂号_In, 0), 1, 操作员编号_In, Null), 
       Decode(Nvl(险类_In, 0), 0, Null, 险类_In), v_付款方式, 收费单_In); 
    If Nvl(预约挂号_In, 0) = 0 And 预约方式_In Is Not Null Then 
      Update 病人挂号记录 
      Set 预约 = 1, 预约时间 = 发生时间_In, 预约操作员 = 操作员姓名_In, 预约操作员编号 = 操作员编号_In 
      Where ID = n_挂号id; 
    End If; 
    n_预约生成队列 := 0; 
    If Nvl(预约挂号_In, 0) = 1 Then 
      n_预约生成队列 := Zl_To_Number(zl_GetSysParameter('预约生成队列', 1113)); 
    End If; 
 
    --0-不产生队列;1-按医生或分诊台排队;2-先分诊,后医生站 
    If Nvl(生成队列_In, 0) <> 0 And Nvl(预约挂号_In, 0) = 0 Or n_预约生成队列 = 1 Then 
      n_分诊台签到排队 := Zl_To_Number(zl_GetSysParameter('分诊台签到排队', 1113)); 
      If Nvl(n_分诊台签到排队, 0) = 0 Or n_预约生成队列 = 1 Then 
        n_分时点显示 := Nvl(Zl_To_Number(zl_GetSysParameter(270)), 0); 
        If Nvl(预约挂号_In, 0) = 1 And n_分时点显示 = 1 And n_分时段 = 1 Then 
          n_分时点显示 := 1; 
        Else 
          n_分时点显示 := Null; 
        End If; 
        --产生队列 
        --.按”执行部门” 的方式生成队列 
        v_队列名称 := 执行部门id_In; 
        v_排队号码 := Zlgetnextqueue(执行部门id_In, n_挂号id, 号别_In || '|' || n_序号); 
        v_排队序号 := Zlgetsequencenum(0, n_挂号id, 0); 
        d_排队时间 := Zl_Get_Queuedate(n_挂号id, 号别_In, n_序号, 发生时间_In); 
        --  队列名称_In , 业务类型_In, 业务id_In,科室id_In,排队号码_In,排队标记_In,患者姓名_In,病人ID_IN, 诊室_In, 医生姓名_In, 排队时间_In 
        Zl_排队叫号队列_Insert(v_队列名称, 0, n_挂号id, 执行部门id_In, v_排队号码, Null, 姓名_In, 病人id_In, 诊室_In, 医生姓名_In, d_排队时间, 预约方式_In, 
                         n_分时点显示, v_排队序号); 
      End If; 
    End If; 
  End If; 
  --病人担保信息 
  If 病人id_In Is Not Null And 序号_In = 1 Then 
    --取参数: 
    If Nvl(n_结算模式, 0) <> Nvl(结算模式_In, 0) Then 
      --结算模式的确定 
 
      v_Err_Msg := Null; 
      Begin 
        Select Nvl(结算模式, 0) Into n_结算模式 From 病人信息 Where 病人id = 病人id_In; 
      Exception 
        When Others Then 
          v_Err_Msg := '未找到指定的病人信息,不允许挂号'; 
      End; 
 
      If v_Err_Msg Is Not Null Then 
        Raise Err_Item; 
      End If; 
      If n_结算模式 = 1 And Nvl(结算模式_In, 0) = 0 Then 
        --病人已经是"先诊疗后结算的",本次是"先结算后诊疗的",则检查是否存在未结数据 
        Select Count(1) 
        Into n_Count 
        From 病人未结费用 
        Where 病人id = 病人id_In And (来源途径 In (1, 4) Or 来源途径 = 3 And Nvl(主页id, 0) = 0) And Nvl(金额, 0) <> 0 And Rownum < 2; 
        If Nvl(n_Count, 0) <> 0 Then 
          --存在未结算数据，必须先结算后才允许执行 
          v_Err_Msg := '当前病人的就诊模式为先诊疗后结算且存在未结费用，不允许调整该病人的就诊模式,你可以先对未结费用结帐后再挂号或不调整病人的就诊模式!'; 
          Raise Err_Item; 
        End If; 
        --检查 
        --未发生医嘱业务的（即当时就挂号的,需要保证同一次的就诊模式是一至的(程序已经检查，不用再处理) 
      End If; 
      Update 病人信息 Set 结算模式 = 结算模式_In Where 病人id = 病人id_In; 
    End If; 
 
    Update 病人信息 
    Set 担保人 = Null, 担保额 = Null, 担保性质 = Null 
    Where 病人id = 病人id_In And Nvl(在院, 0) = 0 And Exists 
     (Select 1 
           From 病人担保记录 
           Where 病人id = 病人id_In And 主页id Is Not Null And 
                 登记时间 = (Select Max(登记时间) From 病人担保记录 Where 病人id = 病人id_In)); 
 
    If Sql%RowCount > 0 Then 
      Update 病人担保记录 
      Set 到期时间 = Sysdate 
      Where 病人id = 病人id_In And 主页id Is Not Null And Nvl(到期时间, Sysdate) >= Sysdate; 
    End If; 
  End If; 
  If 序号_In = 1 Then 
    --消息推送 
    Begin 
      Execute Immediate 'Begin ZL_服务窗消息_发送(:1,:2); End;' 
        Using 1, n_挂号id; 
    Exception 
      When Others Then 
        Null; 
    End; 
  End If; 
Exception 
  When Err_Item Then 
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]'); 
  When Others Then 
    zl_ErrorCenter(SQLCode, SQLErrM); 
End Zl_病人挂号记录_Insert;
/

--92026:蒋廷中,2017-10-13,自由录入的医嘱也可以登记执行情况
Create Or Replace Procedure Zl_病人医嘱执行_Cancel
(
  医嘱id_In     病人医嘱执行.医嘱id%Type,
  发送号_In     病人医嘱执行.发送号%Type,
  取消皮试_In   Number := Null,
  单独执行_In   Number := 0,
  执行部门id_In 门诊费用记录.执行部门id%Type := 0,
  操作员编号_In 人员表.编号%Type := Null,
  操作员姓名_In 人员表.姓名%Type := Null
  --参数：医嘱ID_IN=单独执行的医嘱ID，检验组合为显示的检验项目的ID。
  --      单独执行_In=检验或检查医嘱组合是否采用对每个项目分散单独执行的方式
  --执行部门id_In=仅处理指定执行部门的费用，不传或传入0时不限制执行部门
) Is
  Cursor C_Advice Is
    Select A.Id, A.相关id, Nvl(A.相关id, A.Id) As 组id, A.病人id, Decode(A.病人来源, 1, C.Id, A.主页id) As 就诊id, A.诊疗类别, B.操作类型,
           A.病人来源
    From 病人医嘱记录 A, 诊疗项目目录 B, 病人挂号记录 C
    Where A.诊疗项目id = B.Id(+) And A.Id = 医嘱id_In And A.挂号单 = C.No(+);
  R_Advice C_Advice%RowType;

  V_Temp     Varchar2(255);
  V_人员编号 人员表.编号%Type;
  V_人员姓名 人员表.姓名%Type;
  V_费用性质 病人医嘱发送.记录性质%Type;
  V_操作人员 人员表.姓名%Type;
  D_完成时间 病人医嘱发送.完成时间%Type;
  N_取消执行 Number;
  N_Diffday  Number(18, 3);
  V_Date     Date;
  V_Count    Number;
  Err_Custom Exception;
  V_Error Varchar2(2000);
Begin
  --当前操作人员
  If 操作员编号_In Is Not Null And 操作员姓名_In Is Not Null Then
    V_人员编号 := 操作员编号_In;
    V_人员姓名 := 操作员姓名_In;
  Else
    V_Temp     := Zl_Identity;
    V_Temp     := Substr(V_Temp, Instr(V_Temp, ';') + 1);
    V_Temp     := Substr(V_Temp, Instr(V_Temp, ',') + 1);
    V_人员编号 := Substr(V_Temp, 1, Instr(V_Temp, ',') - 1);
    V_人员姓名 := Substr(V_Temp, Instr(V_Temp, ',') + 1);
  End If;

  Open C_Advice;
  Fetch C_Advice
    Into R_Advice;
  Close C_Advice;
  --医嘱取消执行天数限制，会诊医嘱不做限制
  If Not (R_Advice.诊疗类别 = 'Z' And R_Advice.操作类型 = 7) Then
    --父医嘱不需要发送，没有发送记录，此时取子医嘱的完成时间
    If Nvl(单独执行_In, 0) <> 1 Then
      Select Count(1) Into V_Count From 病人医嘱发送 Where 发送号 + 0 = 发送号_In And 医嘱id = R_Advice.组id;
    End If;
  
    If Nvl(单独执行_In, 0) = 1 Or V_Count = 0 Then
      Select 完成时间 Into D_完成时间 From 病人医嘱发送 Where 发送号 + 0 = 发送号_In And 医嘱id = 医嘱id_In;
    Else
      Select 完成时间 Into D_完成时间 From 病人医嘱发送 Where 发送号 + 0 = 发送号_In And 医嘱id = R_Advice.组id;
    End If;
    If Not D_完成时间 Is Null Then
      Select Zl_To_Number(Nvl(zl_GetSysParameter(220), '999')) Into N_取消执行 From Dual;
      Select Sysdate - D_完成时间 Into N_Diffday From Dual;
      --完成时间超过取消执行天数的记录，不允许取消执行
      If N_Diffday > N_取消执行 Then
        V_Error := '医嘱执行完成时间超过了取消执行有效天数，不能取消执行！';
        Raise Err_Custom;
      End If;
    End If;
  End If;

  --叮嘱运行执行参数
  v_Temp := zl_GetSysParameter(288);
  If (R_Advice.诊疗类别 = 'C' And R_Advice.相关id Is Not Null) Or R_Advice.诊疗类别 = 'D' Then
    If Nvl(单独执行_In, 0) = 1 Then
      Select Count(*)
      Into V_Count
      From 病人医嘱执行
      Where 医嘱id = 医嘱id_In And 发送号 + 0 = 发送号_In And Nvl(执行结果, 1) <> 0;
      Update 病人医嘱发送
      Set 执行状态 = Decode(V_Count, 0, 0, 3), 完成人 = Null, 完成时间 = Null
      Where 发送号 + 0 = 发送号_In And 医嘱id = 医嘱id_In;
    Else
      Select Count(*)
      Into V_Count
      From 病人医嘱执行
      Where 发送号 + 0 = 发送号_In And 医嘱id In (Select ID From 病人医嘱记录 Where 相关id = R_Advice.相关id) And Nvl(执行结果, 1) <> 0;
    
      If R_Advice.诊疗类别 = 'D' Then
        Update 病人医嘱发送
        Set 执行状态 = Decode(V_Count, 0, 0, 3), 完成人 = Null, 完成时间 = Null
        Where 发送号 + 0 = 发送号_In And
              医嘱id In (Select ID From 病人医嘱记录 Where (ID = R_Advice.组id Or 相关id = R_Advice.组id));
      Else
        Update 病人医嘱发送
        Set 执行状态 = Decode(V_Count, 0, 0, 3), 完成人 = Null, 完成时间 = Null
        Where 发送号 + 0 = 发送号_In And 医嘱id In (Select ID From 病人医嘱记录 Where 相关id = R_Advice.相关id);
      End If;
    End If;
  Else
    Select Count(*) Into V_Count From 病人医嘱执行 Where 医嘱id = 医嘱id_In And 发送号 + 0 = 发送号_In;
  
   --包含附加手术,检验部位,以及其它独立医嘱;麻醉和中药煎法是单独安排
    If r_Advice.诊疗类别 = 'E' And (r_Advice.操作类型 = '4' Or r_Advice.操作类型 = '3') Then
      Update 病人医嘱发送
      Set 执行状态 = Decode(v_Count, 0, 0, 3), 完成人 = Null, 完成时间 = Null
      Where 发送号 + 0 = 发送号_In And 医嘱id = 医嘱id_In;
    Else
      Update 病人医嘱发送
      Set 执行状态 = Decode(v_Count, 0, 0, 3), 完成人 = Null, 完成时间 = Null
      Where 发送号 + 0 = 发送号_In And
            医嘱id In (Select ID
                     From 病人医嘱记录
                     Where (ID = r_Advice.组id Or 相关id = r_Advice.组id) And 诊疗类别 = r_Advice.诊疗类别);
    End If;
  End If;
  if v_Temp=1 and r_Advice.诊疗类别 is null then
    Update 病人医嘱发送
    Set 执行状态 = Decode(V_Count, 0, 0, 3), 完成人 = Null, 完成时间 = Null
    Where 发送号 + 0 = 发送号_In And
          医嘱id In (Select ID From 病人医嘱记录 Where (ID = R_Advice.组id Or 相关id = R_Advice.组id));
  end if;
  --更新对应的费用执行状态为未执行，在Zl_门诊医嘱执行_Cancel和Zl_住院医嘱执行_Cancel中进行

  --删除过敏登记记录(当前人员登记的)
  If R_Advice.诊疗类别 = 'E' And R_Advice.操作类型 = '1' Then
    Select Max(操作时间), Max(操作人员)
    Into V_Date, V_操作人员
    From (Select 操作时间, 操作人员 From 病人医嘱状态 Where 医嘱id = 医嘱id_In And 操作类型 = 10 Order By 操作时间 Desc)
    Where Rownum < 2;
    If V_Date Is Not Null And (V_操作人员 = V_人员姓名 Or Nvl(取消皮试_In, 0) = 1) Then
      --可能因为未设置对应过敏药物而未填写过敏记录
      --删除状态，以便标记未用时回退发送记录
      Update 病人医嘱记录 Set 皮试结果 = Null Where ID = 医嘱id_In;
      For R_Date In (Select 操作时间 From 病人医嘱状态 Where 医嘱id = 医嘱id_In And 操作类型 = 10) Loop
        Delete From 病人过敏记录
        Where 病人id = R_Advice.病人id And 记录来源 = 2 And Nvl(主页id, 0) = Nvl(R_Advice.就诊id, 0) And 记录时间 = R_Date.操作时间;
        Delete 病人医嘱状态 Where 医嘱id = 医嘱id_In And 操作类型 = 10 And 操作时间 = R_Date.操作时间;
      End Loop;
    End If;
  End If;
  --检验自动采集，没有采集方式的医嘱执行记录，则清空采样人与采样时间
  Select Count(*) Into V_Count From 病人医嘱执行 Where 发送号 = 发送号_In And 医嘱id = R_Advice.组id;
  If V_Count = 0 And R_Advice.诊疗类别 = 'E' And R_Advice.操作类型 = '6' Then
    Update 病人医嘱发送 A
    Set A.采样人 = Null, A.采样时间 = Null
    Where 医嘱id In (Select ID From 病人医嘱记录 Where (ID = R_Advice.组id Or 相关id = R_Advice.组id)) And 发送号 = 发送号_In;
  End If;

  If R_Advice.病人来源 = 2 Then
    Select Decode(记录性质, 1, 1, Decode(门诊记帐, 1, 1, 2))
    Into V_费用性质
    From 病人医嘱发送
    Where 发送号 = 发送号_In And 医嘱id = 医嘱id_In;
  Else
    V_费用性质 := 1;
  End If;

  If V_费用性质 = 1 Then
    Zl_门诊医嘱执行_Cancel(医嘱id_In, 发送号_In, 单独执行_In, V_人员编号, V_人员姓名, R_Advice.组id, R_Advice.诊疗类别, 执行部门id_In);
  Else
    Zl_住院医嘱执行_Cancel(医嘱id_In, 发送号_In, 单独执行_In, V_人员编号, V_人员姓名, R_Advice.组id, R_Advice.诊疗类别, 执行部门id_In);
  End If;

Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || V_Error || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_病人医嘱执行_Cancel;
/

--92026:蒋廷中,2017-10-13,自由录入的医嘱也可以登记执行情况
Create Or Replace Procedure Zl_病人医嘱执行_Finish
(
  医嘱id_In       病人医嘱执行.医嘱id%Type,
  发送号_In       病人医嘱执行.发送号%Type,
  阳性_In         病人医嘱发送.结果阳性%Type := Null,
  单独执行_In     Number := 0,
  操作员编号_In   人员表.编号%Type := Null,
  操作员姓名_In   人员表.姓名%Type := Null,
  执行部门id_In   门诊费用记录.执行部门id%Type := 0,
  检验项目记帐_In Number := 0
  --参数：医嘱ID_IN=单独执行的医嘱ID，检验组合为显示的检验项目的ID。
  --      单独执行_In=检验或检查医嘱组合是否采用对每个项目分散单独执行的方式
  --执行部门id_In=仅处理指定执行部门的费用，不传或传入0时不限制执行部门
  --检验项目记帐_In=如果是检验项目时，需要记帐但不完成医嘱发送状态
) Is
  Cursor c_Advice Is
    Select a.Id, a.相关id, Nvl(a.相关id, a.Id) As 组id, a.诊疗类别, a.病人来源, a.标本部位, a.开始执行时间, a.病人id, a.主页id, a.执行科室id, b.操作类型
    From 病人医嘱记录 A, 诊疗项目目录 B
    Where a.Id = 医嘱id_In And a.诊疗项目id = b.Id(+);
  r_Advice c_Advice%RowType;

  v_Date     Date;
  v_开始时间 Date;
  v_诊疗类别 诊疗项目目录.类别%Type;
  v_操作类型 诊疗项目目录.操作类型%Type;
  v_Temp     Varchar2(255);
  v_费用性质 病人医嘱发送.记录性质%Type;
  v_人员编号 人员表.编号%Type;
  v_人员姓名 人员表.姓名%Type;
  n_Cnt      Number;

Begin

  --如果启用了参数：输血和皮试医嘱执行后需要核对，则输血和皮试医嘱不自动完成
  Select b.类别, b.操作类型
  Into v_诊疗类别, v_操作类型
  From 病人医嘱记录 A, 诊疗项目目录 B
  Where a.诊疗项目id = b.Id(+) And a.Id = 医嘱id_In;

  v_Temp := zl_GetSysParameter(186);
  If v_Temp = '11' Then
    Select Count(1)
    Into n_Cnt
    From 病人医嘱执行
    Where 医嘱id = 医嘱id_In And 发送号 = 发送号_In And 核对人 Is Null And (v_诊疗类别 = 'E' And v_操作类型 In ('1', '8') Or v_诊疗类别 = 'K');
  Elsif v_Temp = '01' Then
    Select Count(1)
    Into n_Cnt
    From 病人医嘱执行
    Where 医嘱id = 医嘱id_In And 发送号 = 发送号_In And 核对人 Is Null And v_诊疗类别 = 'E' And v_操作类型 = '1';
  Elsif v_Temp = '10' Then
    Select Count(1)
    Into n_Cnt
    From 病人医嘱执行
    Where 医嘱id = 医嘱id_In And 发送号 = 发送号_In And 核对人 Is Null And (v_诊疗类别 = 'E' And v_操作类型 = '8' Or v_诊疗类别 = 'K');
  End If;

  If n_Cnt > 0 Then
    Return;
  End If;

  --当前操作人员
  If 操作员编号_In Is Not Null And 操作员姓名_In Is Not Null Then
    v_人员编号 := 操作员编号_In;
    v_人员姓名 := 操作员姓名_In;
  Else
    v_Temp     := Zl_Identity;
    v_Temp     := Substr(v_Temp, Instr(v_Temp, ';') + 1);
    v_Temp     := Substr(v_Temp, Instr(v_Temp, ',') + 1);
    v_人员编号 := Substr(v_Temp, 1, Instr(v_Temp, ',') - 1);
    v_人员姓名 := Substr(v_Temp, Instr(v_Temp, ',') + 1);
  End If;
  Select Sysdate Into v_Date From Dual;

  --执行状态
  Open c_Advice;
  Fetch c_Advice
    Into r_Advice;
  Close c_Advice;

  --叮嘱运行执行参数
  v_Temp := zl_GetSysParameter(288);

  If 检验项目记帐_In = 0 Then
    If (r_Advice.诊疗类别 = 'C' And r_Advice.相关id Is Not Null) Or r_Advice.诊疗类别 = 'D' Then
      If Nvl(单独执行_In, 0) = 1 Then
        --单个检验或检查项目
        Update 病人医嘱发送
        Set 执行状态 = 1, 完成人 = v_人员姓名, 完成时间 = v_Date, 结果阳性 = Decode(阳性_In, Null, 结果阳性, 阳性_In)
        Where 发送号 = 发送号_In And 医嘱id = 医嘱id_In;
      Else
        --一并的检验项目或多部位的检查项目
        If r_Advice.诊疗类别 = 'D' Then
          Update 病人医嘱发送
          Set 执行状态 = 1, 完成人 = v_人员姓名, 完成时间 = v_Date, 结果阳性 = Decode(阳性_In, Null, 结果阳性, 阳性_In)
          Where 发送号 + 0 = 发送号_In And
                医嘱id In (Select ID From 病人医嘱记录 Where (ID = r_Advice.组id Or 相关id = r_Advice.组id));
        Else
          Update 病人医嘱发送
          Set 执行状态 = 1, 完成人 = v_人员姓名, 完成时间 = v_Date, 结果阳性 = Decode(阳性_In, Null, 结果阳性, 阳性_In)
          Where 发送号 + 0 = 发送号_In And 医嘱id In (Select ID From 病人医嘱记录 Where 相关id = r_Advice.相关id);
        End If;
      End If;
    Else
      --包含附加手术,检查部位,以及其它独立医嘱;麻醉和中药煎法是单独安排 
      If r_Advice.诊疗类别 = 'E' And (r_Advice.操作类型 = '4' Or r_Advice.操作类型 = '3') Then
        Update 病人医嘱发送
        Set 执行状态 = 1, 完成人 = v_人员姓名, 完成时间 = v_Date, 结果阳性 = Decode(阳性_In, Null, 结果阳性, 阳性_In)
        Where 发送号 + 0 = 发送号_In And 医嘱id = 医嘱id_In;
      Else
        Update 病人医嘱发送
        Set 执行状态 = 1, 完成人 = v_人员姓名, 完成时间 = v_Date, 结果阳性 = Decode(阳性_In, Null, 结果阳性, 阳性_In)
        Where 发送号 + 0 = 发送号_In And
              医嘱id In (Select ID
                       From 病人医嘱记录
                       Where (ID = r_Advice.组id Or 相关id = r_Advice.组id) And 诊疗类别 = r_Advice.诊疗类别);
      End If;
    End If;
    If v_Temp = 1 And r_Advice.诊疗类别 Is Null Then
      Update 病人医嘱发送
      Set 执行状态 = 1, 完成人 = v_人员姓名, 完成时间 = v_Date, 结果阳性 = Decode(阳性_In, Null, 结果阳性, 阳性_In)
      Where 发送号 + 0 = 发送号_In And
            医嘱id In (Select ID From 病人医嘱记录 Where (ID = r_Advice.组id Or 相关id = r_Advice.组id));
    End If;
  End If;
  If r_Advice.病人来源 = 2 Then
    Select Decode(记录性质, 1, 1, Decode(门诊记帐, 1, 1, 2))
    Into v_费用性质
    From 病人医嘱发送
    Where 发送号 = 发送号_In And 医嘱id = 医嘱id_In;
  Else
    v_费用性质 := 1;
  End If;
  --检验自动完成采集
  If v_诊疗类别 = 'E' And v_操作类型 = '6' Then
    Update 病人医嘱发送 A
    Set a.采样人 = Nvl(a.采样人, v_人员姓名), a.采样时间 = Nvl(a.采样时间, v_Date)
    Where 医嘱id In (Select ID From 病人医嘱记录 Where (ID = r_Advice.组id Or 相关id = r_Advice.组id)) And 发送号 = 发送号_In;
  End If;

  If v_费用性质 = 1 Then
    Zl_门诊医嘱执行_Finish(医嘱id_In, 发送号_In, 单独执行_In, v_人员编号, v_人员姓名, r_Advice.组id, r_Advice.诊疗类别, 执行部门id_In);
  Else
    Zl_住院医嘱执行_Finish(医嘱id_In, 发送号_In, 单独执行_In, v_人员编号, v_人员姓名, r_Advice.组id, r_Advice.诊疗类别, 执行部门id_In);
  End If;

  If r_Advice.诊疗类别 = 'F' Then
    If Not r_Advice.标本部位 Is Null Then
      v_开始时间 := To_Date(r_Advice.标本部位, 'yyyy-mm-dd hh24:mi:ss');
    Else
      v_开始时间 := r_Advice.开始执行时间;
    End If;
    Zl_电子病历时机_Insert(r_Advice.病人id, r_Advice.主页id, 2, '手术', r_Advice.执行科室id, v_人员姓名, v_开始时间, v_Date);
  End If;

Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_病人医嘱执行_Finish;
/

--92026:蒋廷中,2017-10-16,更新自由医嘱发送记录的执行状态
CREATE OR REPLACE Procedure Zl_病人医嘱执行_Delete
( 
  医嘱id_In     病人医嘱执行.医嘱id%Type, 
  发送号_In     病人医嘱执行.发送号%Type, 
  执行时间_In   病人医嘱执行.执行时间%Type, 
  单独执行_In   Number := 0, 
  自动取消_In   Number := 0, 
  执行部门id_In 门诊费用记录.执行部门id%Type := 0 
  --参数：医嘱ID_IN=单独执行的医嘱ID，检验组合为显示的检验项目的ID。 
  --执行部门id_In=仅处理指定执行部门的费用，不传或传入0时不限制执行部门 
) Is 
  --除了要执行的主记录,还包含了附加手术,检查部位的记录 
  --手术麻醉,中药煎法,采集方法单独控制,检验组合只填写在第一个项目上，但执行状态相同 
  V_组id     病人医嘱记录.Id%Type; 
  V_诊疗类别 病人医嘱记录.诊疗类别%Type; 
  V_病人来源 病人医嘱记录.病人来源%Type; 
  V_费用性质 病人医嘱发送.记录性质%Type; 
  V_操作类型 诊疗项目目录.操作类型%Type; 
 
  V_自动取消 Number; 
  V_执行状态 Number; 
 
  N_执行次数 Number; 
  N_剩余次数 Number; 
  N_执行状态 Number; 
  N_执行结果 Number; 
  
  n_发送数次 Number;
  n_单次数次 Number;
  v_Count    Number;
  n_登记数次 Number;
  d_要求时间 date;
  
  D_登记时间 病人医嘱执行.登记时间%Type; 
  N_取消执行 Number; 
  N_Diffday  Number(18, 3); 
  Err_Custom Exception; 
  V_Error Varchar2(2000); 
Begin 
  Select A.病人来源, Nvl(A.相关id, A.Id), Nvl(A.诊疗类别, '*'), Nvl(B.操作类型, '0') 操作类型
  Into V_病人来源, V_组id, V_诊疗类别,V_操作类型
  From 病人医嘱记录 A, 诊疗项目目录 B
  Where A.Id = 医嘱id_In And A.诊疗项目id = B.Id(+);

  Select Nvl(执行结果, 1), 登记时间 
  Into N_执行结果, D_登记时间 
  From 病人医嘱执行 
  Where 医嘱id = 医嘱id_In And 发送号 + 0 = 发送号_In And 执行时间 = 执行时间_In; 
  -----取消执行有效天数限制 
  Select Zl_To_Number(Nvl(zl_GetSysParameter(220), '999')) Into N_取消执行 From Dual; 
  Select Sysdate - D_登记时间 Into N_Diffday From Dual; 
  --登记时间超过取消执行天数的记录，不允许删除医嘱执行记录 
  If N_Diffday > N_取消执行 Then 
    V_Error := '医嘱执行登记时间超过了取消执行有效天数，不能删除医嘱执行记录！'; 
    Raise Err_Custom; 
  End If; 
 
  If V_病人来源 = 2 Then 
    Select Decode(记录性质, 1, 1, Decode(门诊记帐, 1, 1, 2)) 
    Into V_费用性质 
    From 病人医嘱发送 
    Where 发送号 = 发送号_In And 医嘱id = 医嘱id_In; 
  Else 
    V_费用性质 := 1; 
  End If; 
 
  --病人医嘱执行 
  Delete From 病人医嘱执行 Where 医嘱id = 医嘱id_In And 发送号 + 0 = 发送号_In And 执行时间 = 执行时间_In; 
  --对于未执行的医嘱执行记录的删除，不更新医嘱发送以及费用信息的执行状态 
  If N_执行结果 <> 0 Then 
    Select Decode(A.执行状态, 1, A.发送数次, C.登记次数), Decode(A.执行状态, 1, 0, A.发送数次 - C.登记次数)  ,A.发送数次,C.登记次数




    Into N_执行次数, N_剩余次数  ,n_发送数次,n_登记数次
    From 病人医嘱发送 A, 
         (Select 医嘱id_In 医嘱id, 发送号_In 发送号, Nvl(Sum(B.本次数次), 0) As 登记次数 
           From 病人医嘱执行 B 
           Where B.医嘱id = 医嘱id_In And B.发送号 = 发送号_In And Nvl(B.执行结果, 1) <> 0) C 
    Where A.医嘱id = C.医嘱id And A.发送号 = C.发送号 And A.医嘱id = 医嘱id_In And A.发送号 = 发送号_In; 
   
    --如果全部执行则状态为1，未执行状态为0，部分执行状态为2 
    Select Decode(N_剩余次数, 0, 1, Decode(N_执行次数, 0, 0, 2)) Into N_执行状态 From Dual; 
    
    --更新医嘱执行计价.执行状态
    If n_发送数次 > 0 Then
      if n_登记数次>0 Then
        Select Count(distinct 要求时间) Into v_Count From 医嘱执行计价 Where 医嘱ID = 医嘱ID_IN And 发送号 = 发送号_IN;
        If v_Count > 0 Then
          n_单次数次 := n_发送数次 / v_Count;
          --已执行数量+本次数次 总共能够执行多少个时间点,取最大整数
          v_Count := ceil((n_登记数次 ) / n_单次数次);
          --获取执行截至要求时间 
          Select 要求时间 Into d_要求时间
          From (Select 要求时间, Rownum As 次数
                 From (Select Distinct 要求时间 From 医嘱执行计价 Where 医嘱id = 医嘱ID_IN And 发送号 = 发送号_IN Order By 要求时间))
          Where 次数 = v_Count;
          
          If Not d_要求时间 Is Null Then
            --先检查是否已经退费
            Select Max(NVL(执行状态,0)) Into v_Count From 医嘱执行计价 Where 医嘱id = 医嘱ID_IN And 发送号 = 发送号_IN And 要求时间 <= d_要求时间;
            If v_Count = 2 Then
              v_Error := '您指定的执行时间段的医嘱费用已经被退费，不允许再执行。'; 
              Raise Err_Custom; 
            End If;
            --更新截至要求时间之前(含)的记录执行状态；
            Update 医嘱执行计价 Set 执行状态 = 1 Where 医嘱id = 医嘱ID_IN And 发送号 = 发送号_IN And 要求时间 <= d_要求时间 And NVL(执行状态,0) <> 2;
            Update 医嘱执行计价 Set 执行状态 = 0 Where 医嘱id = 医嘱ID_IN And 发送号 = 发送号_IN And 要求时间 > d_要求时间 And NVL(执行状态,0) <> 2;
          End If;
        End If;
      else
        Update 医嘱执行计价 Set 执行状态 = 0 Where 医嘱id = 医嘱ID_IN And 发送号 = 发送号_IN And NVL(执行状态,0) <> 2;
      end if;
    End If;
    
    --如果执行情况删除了就更新执行状态 
    If Nvl(单独执行_In, 0) = 1 Then 
      Update 病人医嘱发送 
      Set 执行状态 = Decode(N_执行次数, 0, 0, 3), 完成人 = Null, 完成时间 = Null 
      Where 执行状态 = 3 And 医嘱id = 医嘱id_In And 发送号 + 0 = 发送号_In; 
    Else 
      Update 病人医嘱发送 A 
      Set 执行状态 = Decode(N_执行次数, 0, 0, 3), 完成人 = Null, 完成时间 = Null 
      Where 执行状态 = 3 And 发送号 + 0 = 发送号_In And 
            医嘱id In (Select ID From 病人医嘱记录 Where (ID = V_组id Or 相关id = V_组id) And Nvl(诊疗类别,'*') = V_诊疗类别) And Not Exists 
       (Select 1 From 病人医嘱执行 Where 发送号 + 0 = 发送号_In And 医嘱id = A.医嘱id); 
    End If; 
    --更新对应的费用执行状态为未执行 
    --不应该处理药品和跟踪在用的卫材 
    If V_费用性质 = 2 Then 
      If Nvl(单独执行_In, 0) = 1 Then 
        Update 住院费用记录 A 
        Set 执行状态 = N_执行状态, 执行人 = Decode(N_执行状态, 0, Null, 执行人), 执行时间 = Decode(N_执行状态, 0, Null, 执行时间) 
        Where 收费类别 Not In ('5', '6', '7') And (执行部门id_In = 0 Or A.执行部门id = 执行部门id_In) And Not Exists 
         (Select 1 From 材料特性 Where 材料id = A.收费细目id And 跟踪在用 = 1) And A.记录状态 In (0, 1, 3) And 
              (医嘱序号, NO, 记录性质) In 
              (Select 医嘱id, NO, 记录性质 
               From 病人医嘱发送 
               Where 执行状态 = Decode(N_执行次数, 0, 0, 3) And 医嘱id = 医嘱id_In And 发送号 + 0 = 发送号_In); 
      Else 
        Update 住院费用记录 A 
        Set 执行状态 = N_执行状态, 执行人 = Decode(N_执行状态, 0, Null, 执行人), 执行时间 = Decode(N_执行状态, 0, Null, 执行时间) 
        Where 收费类别 Not In ('5', '6', '7') And (执行部门id_In = 0 Or A.执行部门id = 执行部门id_In) And Not Exists 
         (Select 1 From 材料特性 Where 材料id = A.收费细目id And 跟踪在用 = 1) And A.记录状态 In (0, 1, 3) And 
              (医嘱序号, NO, 记录性质) In 
              (Select 医嘱id, NO, 记录性质 
               From 病人医嘱发送 
               Where 执行状态 = Decode(N_执行次数, 0, 0, 3) And 发送号 + 0 = 发送号_In And 
                     医嘱id In 
                     (Select ID From 病人医嘱记录 Where (ID = V_组id Or 相关id = V_组id) And 诊疗类别 = V_诊疗类别)); 
      End If; 
    Else 
      If Nvl(单独执行_In, 0) = 1 Then 
        Update 门诊费用记录 A 
        Set 执行状态 = N_执行状态, 执行人 = Decode(N_执行状态, 0, Null, 执行人), 执行时间 = Decode(N_执行状态, 0, Null, 执行时间) 
        Where 收费类别 Not In ('5', '6', '7') And (执行部门id_In = 0 Or A.执行部门id = 执行部门id_In) And Not Exists 
         (Select 1 From 材料特性 Where 材料id = A.收费细目id And 跟踪在用 = 1) And A.记录状态 In (0, 1, 3) And 
              (医嘱序号, NO, 记录性质) In 
              (Select 医嘱id, NO, 记录性质 
               From 病人医嘱发送 
               Where 执行状态 = Decode(N_执行次数, 0, 0, 3) And 医嘱id = 医嘱id_In And 发送号 + 0 = 发送号_In); 
      Else 
        Update 门诊费用记录 A 
        Set 执行状态 = N_执行状态, 执行人 = Decode(N_执行状态, 0, Null, 执行人), 执行时间 = Decode(N_执行状态, 0, Null, 执行时间) 
        Where 收费类别 Not In ('5', '6', '7') And (执行部门id_In = 0 Or A.执行部门id = 执行部门id_In) And Not Exists 
         (Select 1 From 材料特性 Where 材料id = A.收费细目id And 跟踪在用 = 1) And A.记录状态 In (0, 1, 3) And 
              (医嘱序号, NO, 记录性质) In 
              (Select 医嘱id, NO, 记录性质 
               From 病人医嘱发送 
               Where 执行状态 = Decode(N_执行次数, 0, 0, 3) And 发送号 + 0 = 发送号_In And 
                     医嘱id In 
                     (Select ID From 病人医嘱记录 Where (ID = V_组id Or 相关id = V_组id) And 诊疗类别 = V_诊疗类别)); 
      End If; 
    End If; 
    --检验采集自动取消采集人采集时间 
    If V_诊疗类别 = 'E' And V_操作类型 = '6' Then 
      Update 病人医嘱发送 A  
      Set A.采样人 = Null, A.采样时间 = Null  
      Where 医嘱id In (Select ID From 病人医嘱记录 Where (ID = V_组id Or 相关id = V_组id)) And 发送号 = 发送号_In; 
    End If; 
   
    --已完成执行的，执行数次减少之后自动取消执行完成为正在执行或未执行(主要用于PDA自动执行) 
    If Nvl(自动取消_In, 0) = 1 Then 
      Begin 
        Select Decode(Sign(Nvl(Sum(B.本次数次), 0) - A.发送数次), -1, 1, 0), Decode(Sign(Nvl(Sum(B.本次数次), 0)), 0, 0, 3) 
        Into V_自动取消, V_执行状态 
        From 病人医嘱发送 A, 病人医嘱执行 B 
        Where A.医嘱id = B.医嘱id(+) And A.发送号 = B.发送号(+) And A.执行状态 = 1 And A.医嘱id = 医嘱id_In And A.发送号 = 发送号_In 
        Group By A.发送数次; 
      Exception 
        When Others Then 
          Null; 
      End; 
     
      If Nvl(V_自动取消, 0) = 1 Then 
        Zl_病人医嘱执行_Cancel(医嘱id_In, 发送号_In, Null, 单独执行_In, 执行部门id_In); 
       
        If V_执行状态 = 3 Then 
          Select Nvl(相关id, ID), 诊疗类别 Into V_组id, V_诊疗类别 From 病人医嘱记录 Where ID = 医嘱id_In; 
          Update 病人医嘱发送 
          Set 执行状态 = 3, 完成人 = Null, 完成时间 = Null 
          Where 发送号 + 0 = 发送号_In And 
                医嘱id In (Select ID From 病人医嘱记录 Where (ID = V_组id Or 相关id = V_组id) And 诊疗类别 = V_诊疗类别); 
        End If; 
       
      End If; 
    End If; 
  End If; 
Exception 
  When Err_Custom Then 
    Raise_Application_Error(-20101, '[ZLSOFT]' || V_Error || '[ZLSOFT]'); 
  When Others Then 
    zl_ErrorCenter(SQLCode, SQLErrM); 
End Zl_病人医嘱执行_Delete;
/

--115133:冉俊明,2017-10-13,使用消费卡或银行卡缴的预交款，门诊费用退费时预交记录没有填写原卡类别id和结算卡序号
Create Or Replace Procedure Zl_门诊退费结算_Modify
(
  操作类型_In     Number,
  病人id_In       门诊费用记录.病人id%Type,
  冲销id_In       病人预交记录.结帐id%Type,
  结算方式_In     Varchar2,
  冲预交_In       病人预交记录.冲预交%Type := Null,
  卡类别id_In     病人预交记录.卡类别id%Type := Null,
  卡号_In         病人预交记录.卡号%Type := Null,
  交易流水号_In   病人预交记录.交易流水号%Type := Null,
  交易说明_In     病人预交记录.交易说明%Type := Null,
  缴款_In         病人预交记录.缴款%Type := Null,
  找补_In         病人预交记录.找补%Type := Null,
  误差金额_In     门诊费用记录.实收金额%Type := Null,
  完成退费_In     Number := 0,
  原结帐id_In     病人预交记录.结帐id%Type := Null,
  剩余转预交_In   Number := 0,
  缺省结算方式_In 结算方式.名称%Type := Null
) As
  ------------------------------------------------------------------------------------------------------------------------------
  --功能:收费结算时,修改结算的相关信息
  --操作类型_In:
  --   0-原样退
  --      原样结算一起全退,所有校对标志都为1,医保调用成功后,调整为2,完成后变成0
  --   1-普通退费方式:
  --     ①结算方式_IN:允许传入多个,格式为:"结算方式|结算金额|结算号码|结算摘要||.." ;也允许传入空.
  --   2.三方卡退费结算:
  --     ①结算方式_IN:只能传入一个结算方式,但允许包含一些辅助信息,格式为:"结算方式|结算金额|结算号码|结算摘要"
  --     ②卡类别ID_IN,卡号_IN,交易流水号_IN,交易说明_In:需要传入
  --   3-医保结算(如果存在医保的结算,则要先删除原医保结算,后按新传入的更新)
  --     ①结算方式_IN:允许传入多个,格式为:结算方式|结算金额||.."
  --     ②退支票额_In:传入零
  --   4-消费卡结算:
  --     ①结算方式_IN:允许一次刷多张卡,格式为:卡类别ID|卡号|消费卡ID|消费金额||."
  --     ②退支票额_In:传入零

  -- 冲预交_In:如果涉及预交款,则传入本次的退预交 传入零<0时 表示退预交款或充值;>0 时:表示冲预交款
  -- 剩余转预交_In: 1表示将剩余退款额转换为充值金额;0表示退预交
  -- 误差金额_In:存在误差费时,传入
  -- 完成退费_In:0-未完成退费;1-异常完成退费;2-完成退费
  -- 原结帐ID_IN:原样退时,传入(如果原样退未传入时,则以最后一次结帐为准)
  ------------------------------------------------------------------------------------------------------------------------------
  v_Err_Msg Varchar2(255);
  Err_Item Exception;

  v_结算内容 Varchar2(500);
  v_当前结算 Varchar2(50);
  v_卡号     病人医疗卡信息.卡号%Type;
  n_消费卡id 消费卡目录.Id%Type;
  n_卡类别id 病人预交记录.结算卡序号%Type;
  v_名称     Varchar2(100);
  n_自制卡   卡消费接口目录.自制卡%Type;
  n_序号     病人卡结算记录.序号%Type;
  n_Id       病人卡结算记录.Id%Type;
  n_预交id   病人预交记录.Id%Type;
  v_结算方式 病人预交记录.结算方式%Type;
  n_结算金额 病人预交记录.冲预交%Type;
  n_返回值   人员缴款余额.余额%Type;
  n_预交金额 病人预交记录.冲预交%Type;
  n_冲预交   病人预交记录.冲预交%Type;
  v_结算号码 病人预交记录.结算号码%Type;
  v_结算摘要 病人预交记录.摘要%Type;
  v_误差费   结算方式.名称%Type;
  n_记录状态 病人预交记录.记录状态%Type;

  v_退费结算 结算方式.名称%Type;
  v_No       病人预交记录.No%Type;
  n_Dec      Number; --金额小数位数

  n_Count    Number;
  n_Havenull Number;
  l_预交id   t_Numlist := t_Numlist();
  n_原结帐id 病人预交记录.结帐id%Type;
  n_重结id   病人预交记录.结帐id%Type;
  n_结帐id   病人预交记录.结帐id%Type;
  n_结算序号 病人预交记录.结帐id%Type;
  v_Msg      Varchar2(5000);
  n_会话号   病人预交记录.会话号%Type; --格式：SID+'_'+SERIAL#

  Cursor c_Feedata Is
    Select Max(NO) As NO, Max(m.病人id) As 病人id, Max(m.登记时间) As 登记时间, Max(m.操作员编号) As 操作员编号, Max(m.操作员姓名) As 操作员姓名,
           Sum(结帐金额) As 结算金额, Max(m.缴款组id) As 缴款组id
    From 门诊费用记录 M
    Where m.结帐id = 冲销id_In;
  r_Feedata c_Feedata%RowType;

  Cursor c_Balancedata Is
    Select 记录性质, NO, 记录状态, 病人id, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号
    From 病人预交记录
    Where 结帐id = 冲销id_In And 结算方式 Is Null;
  r_Balancedata c_Balancedata%RowType;

  Procedure Zl_Square_Update
  (
    原结帐id_In 病人预交记录.结帐id%Type,
    现结帐id_In 病人预交记录.结帐id%Type,
    缴款组id_In 病人预交记录.缴款组id%Type,
    退款时间_In 病人预交记录.收款时间%Type,
    结算序号_In 病人预交记录.结算序号%Type,
    结算内容_In Varchar2 := Null
  ) As
    n_记录状态 病人卡结算记录.记录状态%Type;
    n_预交id   病人预交记录.Id%Type;
    v_卡号     病人卡结算记录.卡号%Type;
    n_存在卡片 Number;
    d_停用日期 消费卡目录.停用日期%Type;
    n_最大序号 病人卡结算记录.序号%Type;
    n_序号     病人卡结算记录.序号%Type;
    n_余额     消费卡目录.余额%Type;
    n_接口编号 病人卡结算记录.接口编号%Type;
    d_回收时间 消费卡目录.回收时间%Type;
    n_Id       病人预交记录.Id%Type;
  Begin
    n_预交id := 0;
  
    --处理消费卡,结算卡在上面就已经处理了
    For v_校对 In (Select a.Id As 预交id, c.消费卡id, c.结算金额, c.接口编号, c.卡号, c.序号, c.Id
                 From 病人预交记录 A, 病人卡结算对照 B, 病人卡结算记录 C
                 Where a.Id = b.预交id And b.卡结算id = c.Id And a.记录性质 = 3 And a.记录状态 In (1, 3) And
                       Instr(Nvl(结算内容_In, '_LXH'), ',' || a.结算方式 || ',') = 0 And a.结帐id = 原结帐id_In) Loop
    
      If Nvl(v_校对.消费卡id, 0) <> 0 Then
        Select Max(记录状态)
        Into n_记录状态
        From 病人卡结算记录
        Where 接口编号 = v_校对.接口编号 And 消费卡id = Nvl(v_校对.消费卡id, 0) And 卡号 = v_校对.卡号 And Nvl(序号, 0) = Nvl(v_校对.序号, 0);
      Else
        Select Max(记录状态)
        Into n_记录状态
        From 病人卡结算记录
        Where 接口编号 = v_校对.接口编号 And 消费卡id Is Null And 卡号 = v_校对.卡号 And Nvl(序号, 0) = Nvl(v_校对.序号, 0);
      End If;
    
      If n_记录状态 = 1 Then
        n_记录状态 := 2;
      Else
        n_记录状态 := n_记录状态 + 2;
      End If;
      --多条时,只更新一条
      If n_预交id = 0 Then
        Select 病人预交记录_Id.Nextval Into n_预交id From Dual;
      
        Insert Into 病人预交记录
          (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 结算号码, 收款时间, 缴款单位, 单位开户行, 单位帐号, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id,
           预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 校对标志, 结算序号, 结算性质, 会话号)
          Select n_预交id, 记录性质, NO, 2, 病人id, 主页id, 摘要, 结算方式, 结算号码, 退款时间_In, 缴款单位, 单位开户行, 单位帐号, r_Balancedata.操作员编号,
                 r_Balancedata.操作员姓名, -1 * 冲预交, 现结帐id_In, 缴款组id_In, 预交类别, 卡类别id, Nvl(结算卡序号, v_校对.接口编号), 卡号, 交易流水号, 交易说明,
                 合作单位, 2, 结算序号_In, Mod(记录性质, 10), n_会话号
          From 病人预交记录 A
          Where ID = v_校对.预交id;
      End If;
    
      If Nvl(v_校对.消费卡id, 0) <> 0 Then
        --消费卡,直接退回卡数据中
        Begin
          Select 卡号, 1, 停用日期, (Select Max(序号) From 消费卡目录 B Where a.卡号 = b.卡号 And a.接口编号 = b.接口编号), 序号, 余额, 接口编号, 回收时间
          Into v_卡号, n_存在卡片, d_停用日期, n_最大序号, n_序号, n_余额, n_接口编号, d_回收时间
          From 消费卡目录 A
          Where ID = v_校对.消费卡id;
        Exception
          When Others Then
            n_存在卡片 := 0;
        End;
      
        --取消停用
        If n_存在卡片 = 0 Then
          v_Err_Msg := '卡号为"' || v_卡号 || '"的消费卡被他人删除，不能再启用该卡片,请检查！';
          Raise Err_Item;
        End If;
        If Nvl(n_序号, 0) < Nvl(n_最大序号, 0) Then
          v_Err_Msg := '不能启用历史发卡记录(卡号为"' || v_卡号 || '"),请检查！';
          Raise Err_Item;
        End If;
        If Nvl(d_停用日期, To_Date('3000-01-01', 'yyyy-mm-dd')) < To_Date('3000-01-01', 'yyyy-mm-dd') Then
          v_Err_Msg := '卡号为"' || v_卡号 || '"的消费卡已经被他人停用，不能再进行退费,请检查！';
          Raise Err_Item;
        End If;
      
        If d_回收时间 < To_Date('3000-01-01', 'yyyy-mm-dd') Then
          v_Err_Msg := '卡号为"' || v_卡号 || '"的消费卡已经回收，不能退费,请检查！';
          Raise Err_Item;
        End If;
        Update 消费卡目录 Set 余额 = Nvl(余额, 0) + v_校对.结算金额 Where ID = Nvl(v_校对.消费卡id, 0);
      End If;
    
      Select 病人卡结算记录_Id.Nextval Into n_Id From Dual;
      Insert Into 病人卡结算记录
        (ID, 接口编号, 消费卡id, 序号, 记录状态, 结算方式, 结算金额, 卡号, 交易流水号, 交易时间, 备注, 结算标志)
        Select n_Id, 接口编号, 消费卡id, 序号, n_记录状态, 结算方式, -1 * v_校对.结算金额, 卡号, 交易流水号, 交易时间, 备注,
               Decode(消费卡id, Null, 0, 0, 0, 1) As 标志
        From 病人卡结算记录
        Where ID = v_校对.Id;
      Insert Into 病人卡结算对照 (预交id, 卡结算id) Values (n_预交id, n_Id);
    
      If n_记录状态 <> 2 And n_记录状态 <> 1 Then
        Update 病人卡结算记录 Set 记录状态 = 3 Where ID = v_校对.Id;
      End If;
    End Loop;
  End;

Begin
  Begin
    Select Sid || '_' || Serial# Into n_会话号 From V$session Where Audsid = Userenv('sessionid');
  Exception
    When Others Then
      n_会话号 := Null;
  End;

  Begin
    Select 名称 Into v_退费结算 From 结算方式 Where 性质 = 1;
  Exception
    When Others Then
      v_退费结算 := '现金';
  End;

  Open c_Feedata;
  Fetch c_Feedata
    Into r_Feedata;

  If r_Feedata.No Is Null Then
    v_Err_Msg := '未找到指定的退费记录！';
    Raise Err_Item;
  End If;

  --金额小数位数
  Select Zl_To_Number(Nvl(zl_GetSysParameter(9), '2')) Into n_Dec From Dual;

  --0.正式结算
  Select Count(1), Max(Decode(结算方式, Null, 1, 0)), Max(结算序号)
  Into n_Count, n_Havenull, n_结算序号
  From 病人预交记录
  Where 结帐id = 冲销id_In;

  If Nvl(n_Count, 0) = 0 Or Nvl(误差金额_In, 0) <> 0 Then
    --增加结算方式为NULL的记录
    Begin
      Select 名称 Into v_误差费 From 结算方式 Where Nvl(性质, 0) = 9;
    Exception
      When Others Then
        v_误差费 := '误差费';
    End;
  End If;

  --1.增加结算方式为空的结算数据
  If Nvl(n_Havenull, 0) = 0 Then
    n_Count := 0;
    Begin
      n_结算金额 := Round(Nvl(r_Feedata.结算金额, 0), n_Dec);
    
      Insert Into 病人预交记录
        (ID, 记录性质, NO, 记录状态, 病人id, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 结算性质, 会话号)
      Values
        (病人预交记录_Id.Nextval, 3, Null, 2, Decode(病人id_In, 0, Null, 病人id_In), Null, r_Feedata.登记时间, r_Feedata.操作员编号,
         r_Feedata.操作员姓名, n_结算金额, 冲销id_In, r_Feedata.缴款组id, -1 * 冲销id_In, 1, 3, n_会话号);
      --误差费(先汇总后生成误差费
      If n_结算金额 <> Nvl(r_Feedata.结算金额, 0) Then
        Insert Into 病人预交记录
          (ID, 记录性质, NO, 记录状态, 病人id, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 结算性质, 会话号)
        Values
          (病人预交记录_Id.Nextval, 3, Null, 1, Decode(病人id_In, 0, Null, 病人id_In), v_误差费, r_Feedata.登记时间, r_Feedata.操作员编号,
           r_Feedata.操作员姓名, Nvl(r_Feedata.结算金额, 0) - n_结算金额, 冲销id_In, r_Feedata.缴款组id, -1 * 冲销id_In, 1, 3, n_会话号);
      End If;
      n_结算序号 := -1 * 冲销id_In;
    Exception
      When Others Then
        n_Count := 1;
    End;
    If n_Count = 1 Then
      v_Err_Msg := '未找到指定的退费明细数据,结算操作失败！';
      Raise Err_Item;
    End If;
  End If;

  Open c_Balancedata;
  Fetch c_Balancedata
    Into r_Balancedata;

  If 操作类型_In = 0 Then
    --0.原样退
    n_原结帐id := 原结帐id_In;
    If Nvl(n_原结帐id, 0) = 0 Then
      Select Max(结帐id)
      Into n_原结帐id
      From 门诊费用记录 A,
           (Select 登记时间 From 门诊费用记录 Where NO = r_Feedata.No And Mod(记录性质, 10) = 1 And 记录状态 In (1, 3)) B
      Where a.No = r_Feedata.No And Mod(a.记录性质, 10) = 1 And a.登记时间 = b.登记时间;
    End If;
    If Nvl(n_原结帐id, 0) = 0 Then
      v_Err_Msg := '未找到原结帐数据,不能原样退！';
      Raise Err_Item;
    End If;
  
    --1.先处理预交款
    n_结算金额 := 0;
    For v_退预交 In (Select a.Id, Nvl(a.冲预交, 0) As 金额
                  From 病人预交记录 A
                  Where Mod(记录性质, 10) = 1 And 结帐id = n_原结帐id And Nvl(冲预交, 0) <> 0
                  Order By 收款时间 Desc) Loop
    
      n_结算金额 := n_结算金额 + v_退预交.金额;
    
      Insert Into 病人预交记录
        (ID, 记录性质, NO, 实际票号, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 卡类别id, 结算卡序号,
         卡号, 交易流水号, 交易说明, 结算号码, 预交类别, 结算性质, 会话号)
        Select 病人预交记录_Id.Nextval, 11, NO, 实际票号, 记录状态, 病人id, Null, 摘要, 结算方式, r_Balancedata.收款时间, r_Balancedata.操作员编号,
               r_Balancedata.操作员姓名, -1 * v_退预交.金额, r_Balancedata.结帐id, r_Balancedata.缴款组id, r_Balancedata.结算序号, 2, 卡类别id,
               结算卡序号, 卡号, 交易流水号, 交易说明, 结算号码, 预交类别, 3, n_会话号
        From 病人预交记录
        Where ID = v_退预交.Id;
    
      Update 病人预交记录 Set 冲预交 = 冲预交 - v_退预交.金额 Where 结帐id = 冲销id_In And 结算方式 Is Null;
      If Sql%NotFound Then
        v_Err_Msg := '结算信息错误,可能因为并发原因造成结算信息错误,请在[收费结算窗口]中重新收费！';
        Raise Err_Item;
      End If;
    End Loop;
    If Nvl(n_结算金额, 0) <> 0 Then
    
      Update 病人余额
      Set 预交余额 = Nvl(预交余额, 0) + (-1 * n_结算金额)
      Where 病人id = 病人id_In And 性质 = 1 And 类型 = 1
      Returning 预交余额 Into n_返回值;
      If Sql%RowCount = 0 Then
        Insert Into 病人余额 (病人id, 类型, 预交余额, 性质) Values (病人id_In, 1, (-1 * n_结算金额), 1);
        n_返回值 := (-1 * n_结算金额);
      End If;
      If Nvl(n_返回值, 0) = 0 Then
        Delete From 病人余额
        Where 病人id = r_Balancedata.病人id And 性质 = 1 And Nvl(费用余额, 0) = 0 And Nvl(预交余额, 0) = 0;
      End If;
    End If;
    --2.处理消费卡部分
    Zl_Square_Update(n_原结帐id, r_Balancedata.结帐id, r_Balancedata.缴款组id, r_Balancedata.收款时间, r_Balancedata.结算序号, v_结算内容);
    --3.处理其他结算部分
    Insert Into 病人预交记录
      (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 结算号码, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 预交类别, 卡类别id, 结算卡序号, 卡号,
       交易流水号, 交易说明, 合作单位, 校对标志, 结算序号, 结算性质, 会话号)
      Select 病人预交记录_Id.Nextval, 记录性质, NO, 2, 病人id, 主页id, 摘要, 结算方式, 结算号码, r_Balancedata.收款时间, r_Balancedata.操作员编号,
             r_Balancedata.操作员姓名, -1 * 冲预交, r_Balancedata.结帐id, r_Balancedata.缴款组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明,
             合作单位,
             Case
               When Nvl(a.卡类别id, 0) <> 0 Then
                1
               When Nvl(a.结算卡序号, 0) <> 0 Then
                1
               When Nvl(q.预交id, 0) <> 0 Then
                1
               When Nvl(j.名称, '-') <> '-' Then
               --医保
                1
               Else
                2
             End As 校对标志, r_Balancedata.结算序号, 3, n_会话号
      From 病人预交记录 A, (Select 名称 From 结算方式 Where 性质 In (3, 4)) J,
           (Select m.Id As 预交id
             From 病人预交记录 M, 一卡通目录 C
             Where m.结帐id = n_原结帐id And m.结算方式 = c.结算方式 And m.记录性质 = 3 And m.记录状态 In (1, 3)) Q
      Where Mod(a.记录性质, 10) <> 1 And a.记录状态 In (1, 3) And a.结算方式 = j.名称(+) And a.结算方式 Is Not Null And a.结帐id = n_原结帐id And
            a.Id = q.预交id(+) And (Not Exists (Select 1 From 病人卡结算对照 Where a.Id = 预交id) Or Nvl(结算卡序号, 0) = 0);
  
    --更新结算方式为NULL 的记录
    Select Sum(冲预交) Into n_返回值 From 病人预交记录 Where 结帐id = r_Balancedata.结帐id And 结算方式 Is Not Null;
    Select Sum(结帐金额)
    Into n_结算金额
    From 门诊费用记录
    Where 结帐id = r_Balancedata.结帐id And Mod(记录性质, 10) = 1;
  
    Update 病人预交记录
    Set 冲预交 = Nvl(n_结算金额, 0) - Nvl(n_返回值, 0)
    Where 结帐id = 冲销id_In And 结算方式 Is Null;
    If Sql%NotFound Then
      v_Err_Msg := '结算信息错误,可能因为并发原因造成结算信息错误,请在[收费结算窗口]中重新收费！';
      Raise Err_Item;
    End If;
  
  End If;

  n_重结id := 0;
  If 操作类型_In <> 0 Then
    --不是全退时,检查是否产生了重新收费数据的
    Begin
      Select 结帐id Into n_重结id From 病人预交记录 Where 结算序号 = n_结算序号 And 结帐id <> 冲销id_In And Rownum < 2;
    Exception
      When Others Then
        n_重结id := 0;
    End;
  End If;

  --需要处理误差金额
  If Nvl(误差金额_In, 0) <> 0 Then
    --误差费放在重收的结算记录中
    n_结帐id   := 冲销id_In;
    n_记录状态 := 2;
    If Nvl(n_重结id, 0) <> 0 Then
      n_结帐id   := n_重结id;
      n_记录状态 := 1;
    End If;
  
    Update 病人预交记录
    Set 冲预交 = Nvl(冲预交, 0) + Nvl(误差金额_In, 0)
    Where 结帐id = n_结帐id And 结算方式 = v_误差费;
    If Sql%NotFound Then
      Insert Into 病人预交记录
        (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 卡类别id, 结算卡序号, 卡号,
         交易流水号, 交易说明, 结算号码, 结算性质, 会话号)
      Values
        (病人预交记录_Id.Nextval, 3, Null, n_记录状态, r_Balancedata.病人id, Null, Null, v_误差费, r_Balancedata.收款时间,
         r_Balancedata.操作员编号, r_Balancedata.操作员姓名, 误差金额_In, n_结帐id, r_Balancedata.缴款组id, r_Balancedata.结算序号, 2, Null,
         Null, 卡号_In, 交易流水号_In, 交易说明_In, Null, 3, n_会话号);
    End If;
  
    Update 病人预交记录 Set 冲预交 = 冲预交 - Nvl(误差金额_In, 0) Where 结帐id = n_结帐id And 结算方式 Is Null;
    If Sql%NotFound Then
      v_Err_Msg := '结算信息错误,可能因为并发原因造成结算信息错误,请在[收费结算窗口]中重新收费！';
      Raise Err_Item;
    End If;
  End If;

  --预交款处理:如果是冲预交,需要先处理冲预交款
  If Nvl(冲预交_In, 0) <> 0 Then
    If Nvl(r_Balancedata.病人id, 0) = 0 Then
      v_Err_Msg := '不能确定病人信息,不能使用预交款结算！';
      Raise Err_Item;
    End If;
  
    n_预交金额 := 冲预交_In;
    If n_预交金额 < 0 And Nvl(剩余转预交_In, 0) = 1 Then
    
      --     ②冲预交_In:如果涉及预交款,则传入本次的退预交 传入零<0时 表示退预交款或充值;>0 时:表示冲预交款
      --     ③剩余转预交_In: 1表示将剩余退款额转换为充值金额;0表示退预交
    
      --1.先生成冲值预交:
      v_No := Nextno(11);
      Insert Into 病人预交记录
        (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 金额, 结帐id, 缴款组id, 结算序号, 校对标志, 卡类别id, 结算卡序号, 卡号,
         交易流水号, 交易说明, 结算号码, 预交类别, 结算性质, 会话号)
      Values
        (病人预交记录_Id.Nextval, 1, v_No, 1, r_Balancedata.病人id, Null, '退费生成预交', v_退费结算, r_Balancedata.收款时间,
         r_Balancedata.操作员编号, r_Balancedata.操作员姓名, -1 * n_预交金额, r_Balancedata.结帐id, r_Balancedata.缴款组id,
         r_Balancedata.结算序号, 0, Null, Null, 卡号_In, 交易流水号_In, 交易说明_In, Null, 1, Null, n_会话号);
    
      --更新病人余额
      Update 病人余额
      Set 预交余额 = Nvl(预交余额, 0) + n_预交金额
      Where 病人id = 病人id_In And 性质 = 1 And 类型 = 1
      Returning 预交余额 Into n_返回值;
      If Sql%RowCount = 0 Then
        Insert Into 病人余额 (病人id, 类型, 预交余额, 性质) Values (病人id_In, 1, n_预交金额, 1);
        n_返回值 := n_预交金额;
      End If;
      If Nvl(n_返回值, 0) = 0 Then
        Delete From 病人余额
        Where 病人id = r_Balancedata.病人id And 性质 = 1 And Nvl(费用余额, 0) = 0 And Nvl(预交余额, 0) = 0;
      End If;
    
      --2.生成退费记录
      If Nvl(n_重结id, 0) <> 0 Then
        Select Sum(冲预交)
        Into n_返回值
        From 病人预交记录
        Where 结帐id = 冲销id_In And 结算方式 Is Null And Nvl(冲预交, 0) <> 0;
        If Nvl(n_返回值, 0) <> 0 Then
          Insert Into 病人预交记录
            (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 卡类别id, 结算卡序号,
             卡号, 交易流水号, 交易说明, 结算号码, 结算性质, 会话号)
          Values
            (病人预交记录_Id.Nextval, 3, Null, 2, r_Balancedata.病人id, Null, v_结算摘要, v_退费结算, r_Balancedata.收款时间,
             r_Balancedata.操作员编号, r_Balancedata.操作员姓名, n_返回值, 冲销id_In, r_Balancedata.缴款组id, r_Balancedata.结算序号, 2, Null,
             Null, 卡号_In, 交易流水号_In, 交易说明_In, Null, 3, n_会话号);
        
          Update 病人预交记录 Set 冲预交 = 冲预交 - Nvl(n_返回值, 0) Where 结帐id = 冲销id_In And 结算方式 Is Null;
        End If;
        n_结算金额 := n_结算金额 - Nvl(n_返回值, 0);
      
        Insert Into 病人预交记录
          (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 卡类别id, 结算卡序号, 卡号,
           交易流水号, 交易说明, 结算号码, 结算性质, 会话号)
        Values
          (病人预交记录_Id.Nextval, 3, Null, 1, r_Balancedata.病人id, Null, v_结算摘要, v_退费结算, r_Balancedata.收款时间,
           r_Balancedata.操作员编号, r_Balancedata.操作员姓名, n_结算金额, n_重结id, r_Balancedata.缴款组id, r_Balancedata.结算序号, 2, Null,
           Null, 卡号_In, 交易流水号_In, 交易说明_In, Null, 3, n_会话号);
        Update 病人预交记录 Set 冲预交 = 冲预交 + n_预交金额 Where 结帐id = 冲销id_In And 结算方式 Is Null;
        If Sql%NotFound Then
          v_Err_Msg := '结算信息错误,可能因为并发原因造成结算信息错误,请在[收费结算窗口]中重新收费！';
          Raise Err_Item;
        End If;
      Else
      
        Insert Into 病人预交记录
          (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 卡类别id, 结算卡序号, 卡号,
           交易流水号, 交易说明, 结算号码, 结算性质, 会话号)
        Values
          (病人预交记录_Id.Nextval, 3, Null, 2, r_Balancedata.病人id, Null, v_结算摘要, v_结算方式, r_Balancedata.收款时间,
           r_Balancedata.操作员编号, r_Balancedata.操作员姓名, -1 * n_预交金额, r_Balancedata.结帐id, r_Balancedata.缴款组id,
           r_Balancedata.结算序号, 2, Null, Null, 卡号_In, 交易流水号_In, 交易说明_In, Null, 3, n_会话号);
        Update 病人预交记录 Set 冲预交 = 冲预交 + n_预交金额 Where 结帐id = 冲销id_In And 结算方式 Is Null;
        If Sql%NotFound Then
          v_Err_Msg := '结算信息错误,可能因为并发原因造成结算信息错误,请在[收费结算窗口]中重新收费！';
          Raise Err_Item;
        End If;
      End If;
    End If;
  
    If Nvl(n_预交金额, 0) < 0 And Nvl(剩余转预交_In, 0) = 0 Then
    
      n_原结帐id := 原结帐id_In;
      If Nvl(n_原结帐id, 0) = 0 Then
        Select Max(b.结帐id)
        Into n_原结帐id
        From 门诊费用记录 A, 门诊费用记录 B
        Where a.结帐id = 冲销id_In And a.No = b.No And b.记录性质 = 1 And b.记录状态 In (1, 3);
      End If;
    
      If Nvl(n_原结帐id, 0) = 0 Then
        v_Err_Msg := '未找到原结帐数据,不能原样退！';
        Raise Err_Item;
      End If;
      If Nvl(n_重结id, 0) <> 0 Then
        Select Sum(冲预交)
        Into n_返回值
        From 病人预交记录
        Where 结帐id = 冲销id_In And 结算方式 Is Null And Nvl(冲预交, 0) <> 0;
        If Nvl(n_返回值, 0) <> 0 Then
          For v_退预交 In (Select a.Id, Nvl(a.冲预交, 0) As 金额
                        From 病人预交记录 A
                        Where Mod(记录性质, 10) = 1 And 结帐id = n_原结帐id And Nvl(冲预交, 0) <> 0
                        Order By 收款时间 Desc) Loop
            Insert Into 病人预交记录
              (ID, 记录性质, NO, 实际票号, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 卡类别id,
               结算卡序号, 卡号, 交易流水号, 交易说明, 结算号码, 预交类别, 结算性质, 会话号)
              Select 病人预交记录_Id.Nextval, 11, NO, 实际票号, 记录状态, 病人id, Null, 摘要, 结算方式, r_Balancedata.收款时间,
                     r_Balancedata.操作员编号, r_Balancedata.操作员姓名, Nvl(n_返回值, 0), r_Balancedata.结帐id, r_Balancedata.缴款组id,
                     r_Balancedata.结算序号, 2, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 结算号码, 预交类别, 3, n_会话号

              From 病人预交记录
              Where ID = v_退预交.Id;
            Update 病人预交记录 Set 冲预交 = 冲预交 - Nvl(n_返回值, 0) Where 结帐id = 冲销id_In And 结算方式 Is Null;
            If Sql%NotFound Then
              v_Err_Msg := '结算信息错误,可能因为并发原因造成结算信息错误,请在[收费结算窗口]中重新收费！';
              Raise Err_Item;
            End If;
            n_预交金额 := n_预交金额 - Nvl(n_返回值, 0);
          End Loop;
        End If;
        n_返回值 := 0;
        --2.退预交款
        For v_退预交 In (Select Max(a.Id) As ID, Max(a.收款时间) As 收款时间, Sum(Nvl(a.冲预交, 0)) As 金额
                      From 病人预交记录 A,
                           (Select Distinct a.结帐id
                             From 门诊费用记录 A, 门诊费用记录 B
                             Where a.No = b.No And Mod(b.记录性质, 10) = 1 And b.结帐id = n_原结帐id) B
                      Where a.结帐id = b.结帐id And Mod(a.记录性质, 10) = 1 And Nvl(a.预交类别, 0) = 1 And a.结帐id <> 冲销id_In
                      Group By NO
                      Order By 收款时间 Desc) Loop
        
          If v_退预交.金额 + n_预交金额 < 0 Then
            n_结算金额 := v_退预交.金额;
            n_预交金额 := n_预交金额 + v_退预交.金额;
          Else
            n_结算金额 := n_预交金额;
            n_预交金额 := 0;
          End If;
        
          Insert Into 病人预交记录
            (ID, 记录性质, NO, 实际票号, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 卡类别id,
             结算卡序号, 卡号, 交易流水号, 交易说明, 结算号码, 预交类别, 结算性质, 会话号)
            Select 病人预交记录_Id.Nextval, 11, NO, 实际票号, 记录状态, 病人id, Null, 摘要, 结算方式, r_Balancedata.收款时间, r_Balancedata.操作员编号,
                   r_Balancedata.操作员姓名, n_结算金额, n_重结id, r_Balancedata.缴款组id, r_Balancedata.结算序号, 2, 卡类别id, 结算卡序号, 卡号,
                   交易流水号, 交易说明, 结算号码, 预交类别, 3, n_会话号
            From 病人预交记录
            Where ID = v_退预交.Id;
          Update 病人预交记录 Set 冲预交 = 冲预交 - n_结算金额 Where 结帐id = n_重结id And 结算方式 Is Null;
          n_返回值 := 1;
          If Sql%NotFound Then
            v_Err_Msg := '结算信息错误,可能因为并发原因造成结算信息错误,请在[收费结算窗口]中重新收费！';
            Raise Err_Item;
          End If;
          If n_预交金额 = 0 Then
            Exit;
          End If;
        End Loop;
      Else
        --退预交款
        n_返回值   := 0;
        n_预交金额 := -1 * n_预交金额;
      
        For v_退预交 In (Select Max(a.Id) As ID, Max(a.收款时间) As 收款时间, Sum(Nvl(a.冲预交, 0)) As 金额
                      From 病人预交记录 A,
                           (Select Distinct a.结帐id
                             From 门诊费用记录 A, 门诊费用记录 B
                             Where a.No = b.No And Mod(b.记录性质, 10) = 1 And b.结帐id = n_原结帐id) B
                      Where a.结帐id = b.结帐id And Mod(a.记录性质, 10) = 1 And Nvl(a.预交类别, 0) = 1
                      Group By NO
                      Having Sum(Nvl(a.冲预交, 0)) > 0
                      Order By 收款时间 Desc) Loop
        
          If v_退预交.金额 - n_预交金额 < 0 Then
            n_结算金额 := -1 * v_退预交.金额;
            n_预交金额 := n_预交金额 - v_退预交.金额;
          Else
            n_结算金额 := -1 * n_预交金额;
            n_预交金额 := 0;
          End If;
        
          Insert Into 病人预交记录
            (ID, 记录性质, NO, 实际票号, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 卡类别id,
             结算卡序号, 卡号, 交易流水号, 交易说明, 结算号码, 预交类别, 结算性质, 会话号)
            Select 病人预交记录_Id.Nextval, 11, NO, 实际票号, 记录状态, 病人id, 主页id, 摘要, 结算方式, r_Balancedata.收款时间, r_Balancedata.操作员编号,
                   r_Balancedata.操作员姓名, n_结算金额, r_Balancedata.结帐id, r_Balancedata.缴款组id, r_Balancedata.结算序号, 2, 卡类别id,
                   结算卡序号, 卡号, 交易流水号, 交易说明, 结算号码, 预交类别, 3, n_会话号
            From 病人预交记录
            Where ID = v_退预交.Id;
        
          Update 病人预交记录 Set 冲预交 = 冲预交 - n_结算金额 Where 结帐id = 冲销id_In And 结算方式 Is Null;
          n_返回值 := 1;
          If Sql%NotFound Then
            v_Err_Msg := '结算信息错误,可能因为并发原因造成结算信息错误,请在[收费结算窗口]中重新收费！';
            Raise Err_Item;
          End If;
          If n_预交金额 = 0 Then
            Exit;
          End If;
        End Loop;
      End If;
      If Nvl(n_返回值, 0) = 0 Then
        v_Err_Msg := '未找到原始的冲预交记录,不能回退预交款！';
        Raise Err_Item;
      End If;
    
      If Nvl(n_预交金额, 0) <> 0 Then
        v_Err_Msg := '当前退预交超过了收费结算中的冲预交款,不能回退预交款！';
        Raise Err_Item;
      End If;
    
      Update 病人余额
      Set 预交余额 = Nvl(预交余额, 0) + (-1 * 冲预交_In)
      Where 病人id = 病人id_In And 性质 = 1 And 类型 = 1
      Returning 预交余额 Into n_返回值;
      If Sql%RowCount = 0 Then
        Insert Into 病人余额 (病人id, 类型, 预交余额, 性质) Values (病人id_In, 1, (-1 * 冲预交_In), 1);
        n_返回值 := (-1 * 冲预交_In);
      End If;
      If Nvl(n_返回值, 0) = 0 Then
        Delete From 病人余额
        Where 病人id = r_Balancedata.病人id And 性质 = 1 And Nvl(费用余额, 0) = 0 And Nvl(预交余额, 0) = 0;
      End If;
    
    End If;
  
    n_预交金额 := 冲预交_In;
    If Nvl(n_预交金额, 0) > 0 Then
      --冲预交款
      --病人余额检查
      Begin
        Select Nvl(预交余额, 0) - Nvl(费用余额, 0)
        Into n_预交金额
        From 病人余额
        Where 病人id = 病人id_In And Nvl(性质, 0) = 1 And 类型 = 1;
      Exception
        When Others Then
          n_预交金额 := 0;
      End;
      If n_预交金额 < 冲预交_In Then
        v_Err_Msg := '病人的当前预交余额为 ' || LTrim(To_Char(n_预交金额, '9999999990.00')) || '，小于本次支付金额 ' ||
                     LTrim(To_Char(冲预交_In, '9999999990.00')) || ' ！';
        Raise Err_Item;
      End If;
    
      n_预交金额 := 冲预交_In;
      n_结帐id   := 冲销id_In;
      If Nvl(n_重结id, 0) <> 0 Then
        n_结帐id := n_重结id;
        --总的冲预交金额 = 本次冲预交金额 + 未冲销金额
        --因为在后面会将未冲销金额全部退为预交款
        Select Sum(冲预交)
        Into n_返回值
        From 病人预交记录
        Where 结帐id = 冲销id_In And 结算方式 Is Null And Nvl(冲预交, 0) <> 0;
        If Nvl(n_返回值, 0) <> 0 Then
          n_预交金额 := n_预交金额 - Nvl(n_返回值, 0);
        End If;
      End If;
    
      --先缴先用
      --不包含结算方式为代收款项的预交款。
      For c_冲预交 In (Select a.No, Sum(Nvl(a.金额, 0) - Nvl(a.冲预交, 0)) As 金额, Nvl(Max(a.结帐id), 0) As 结帐id,
                           Max(Decode(a.记录性质, 1, a.记录状态, 1)) As 记录状态,
                           Max(Decode(a.记录性质, 1, Decode(a.记录状态, 1, a.Id, 3, a.Id, 0), 0)) As ID,
                           Max(Decode(a.记录性质, 1, Decode(a.记录状态, 1, a.收款时间, 3, a.收款时间, Null, Null))) As 收款时间
                    From 病人预交记录 A
                    Where a.记录性质 In (1, 11) And a.病人id = 病人id_In And Nvl(a.预交类别, 2) = 1 And
                          a.结算方式 Not In (Select 名称 From 结算方式 Where 性质 = 5)
                    Group By a.No
                    Having Sum(Nvl(a.金额, 0) - Nvl(a.冲预交, 0)) <> 0
                    Order By 收款时间) Loop
      
        If c_冲预交.金额 - n_预交金额 < 0 Then
          n_冲预交 := c_冲预交.金额;
        Else
          n_冲预交 := n_预交金额;
        End If;
      
        If c_冲预交.结帐id = 0 Then
          --第一次冲预交(将第一次标上结帐ID,冲预交标记为0)
          Update 病人预交记录
          Set 冲预交 = 0, 结帐id = n_结帐id, 结算序号 = n_结算序号, 结算性质 = 3, 会话号 = n_会话号
          Where ID = c_冲预交.Id;
        End If;
        --冲上次剩余额
        Insert Into 病人预交记录
          (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 金额, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, 收款时间, 操作员姓名, 操作员编号, 冲预交,
           结帐id, 缴款组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算序号, 结算性质, 会话号)
          Select 病人预交记录_Id.Nextval, NO, 实际票号, 11, 记录状态, 病人id, 主页id, 科室id, Null, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号,
                 r_Balancedata.收款时间, r_Balancedata.操作员姓名, r_Balancedata.操作员编号, n_冲预交, n_结帐id, r_Balancedata.缴款组id, 预交类别,
                 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, n_结算序号, 3, n_会话号
          From 病人预交记录
          Where NO = c_冲预交.No And 记录状态 = c_冲预交.记录状态 And 记录性质 In (1, 11) And Rownum = 1;
      
        --更新数据(结算方式为NULL的)
        Update 病人预交记录
        Set 冲预交 = 冲预交 - n_冲预交
        Where 结帐id = n_结帐id And 结算方式 Is Null
        Returning Nvl(冲预交, 0) Into n_返回值;
      
        --检查是否已经处理完
        If c_冲预交.金额 < n_预交金额 Then
          n_预交金额 := n_预交金额 - c_冲预交.金额;
        Else
          n_预交金额 := 0;
        End If;
        If n_预交金额 = 0 Then
          Exit;
        End If;
      End Loop;
    
      --检查金额是否足够
      If Abs(n_预交金额) > 0 Then
        v_Err_Msg := '病人的当前预交余额小于本次支付金额 ' || LTrim(To_Char(冲预交_In, '9999999990.00')) || ' ！';
        Raise Err_Item;
      End If;
    
      If Nvl(n_重结id, 0) <> 0 Then
        Select Sum(冲预交)
        Into n_返回值
        From 病人预交记录
        Where 结帐id = 冲销id_In And 结算方式 Is Null And Nvl(冲预交, 0) <> 0;
        If Nvl(n_返回值, 0) <> 0 Then
          Insert Into 病人预交记录
            (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 金额, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, 收款时间, 操作员姓名, 操作员编号, 冲预交,
             结帐id, 缴款组id, 预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算序号, 结算性质, 会话号)
            Select 病人预交记录_Id.Nextval, NO, 实际票号, 11, 记录状态, 病人id, 主页id, 科室id, Null, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号,
                   r_Balancedata.收款时间, r_Balancedata.操作员姓名, r_Balancedata.操作员编号, n_返回值, 冲销id_In, r_Balancedata.缴款组id,
                   预交类别, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, n_结算序号, 3, n_会话号
            From 病人预交记录
            Where 结帐id = n_重结id And 记录性质 In (1, 11) And Rownum = 1;
        
          Update 病人预交记录 Set 冲预交 = 冲预交 - Nvl(n_返回值, 0) Where 结帐id = 冲销id_In And 结算方式 Is Null;
          If Sql%NotFound Then
            v_Err_Msg := '结算信息错误,可能因为并发原因造成结算信息错误,请在[收费结算窗口]中重新收费！';
            Raise Err_Item;
          End If;
        End If;
      
      End If;
      --更新病人预交余额
      Update 病人余额
      Set 预交余额 = Nvl(预交余额, 0) - 冲预交_In
      Where 病人id = 病人id_In And 性质 = 1 And 类型 = 1
      Returning 预交余额 Into n_返回值;
      If Sql%RowCount = 0 Then
        Insert Into 病人余额 (病人id, 类型, 预交余额, 性质) Values (病人id_In, 1, -1 * 冲预交_In, 1);
        n_返回值 := -1 * 冲预交_In;
      End If;
      If Nvl(n_返回值, 0) = 0 Then
        Delete From 病人余额 Where 病人id = 病人id_In And 性质 = 1 And Nvl(费用余额, 0) = 0 And Nvl(预交余额, 0) = 0;
      End If;
    End If;
  End If;

  If 操作类型_In = 1 Then
    --   1-普通退费方式:
    --各个收费结算 :格式为:"结算方式|结算金额|结算号码|结算摘要||.."
    v_结算内容 := 结算方式_In || '||';
    While v_结算内容 Is Not Null Loop
      v_当前结算 := Substr(v_结算内容, 1, Instr(v_结算内容, '||') - 1);
    
      v_结算方式 := Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1);
    
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
      n_结算金额 := To_Number(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
    
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
      v_结算号码 := LTrim(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
      v_结算摘要 := LTrim(Substr(v_当前结算, Instr(v_当前结算, '|') + 1));
    
      --不判断“结算金额”是否为零，有可能已经退完，但这时结算方式为空的重结和冲销记录的冲预交之和为零
      If v_结算方式 Is Null Then
        v_结算方式 := 缺省结算方式_In;
      End If;
      --If Nvl(n_结算金额, 0) <> 0 Then
      n_结算金额 := Nvl(n_结算金额, 0);
      If Nvl(n_重结id, 0) <> 0 Then
        --肯定是收款
        --1.先按此种方式全退
        --2.再按此种方式收款
        --3:1+2=本次退款
        --1.先将退费的全部作废掉
        Select Sum(冲预交)
        Into n_返回值
        From 病人预交记录
        Where 结帐id = 冲销id_In And 结算方式 Is Null And Nvl(冲预交, 0) <> 0;
      
        If Nvl(n_返回值, 0) <> 0 Then
        
          Insert Into 病人预交记录
            (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 卡类别id, 结算卡序号,
             卡号, 交易流水号, 交易说明, 结算号码, 结算性质, 会话号)
          Values
            (病人预交记录_Id.Nextval, 3, Null, 2, r_Balancedata.病人id, Null, v_结算摘要, v_结算方式, r_Balancedata.收款时间,
             r_Balancedata.操作员编号, r_Balancedata.操作员姓名, n_返回值, 冲销id_In, r_Balancedata.缴款组id, r_Balancedata.结算序号, 2, Null,
             Null, 卡号_In, 交易流水号_In, 交易说明_In, Null, 3, n_会话号);
          Update 病人预交记录 Set 冲预交 = 冲预交 - Nvl(n_返回值, 0) Where 结帐id = 冲销id_In And 结算方式 Is Null;
        End If;
        n_结算金额 := n_结算金额 - Nvl(n_返回值, 0);
        --2.退款
        If Nvl(n_结算金额, 0) <> 0 Then
          Insert Into 病人预交记录
            (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 卡类别id, 结算卡序号,
             卡号, 交易流水号, 交易说明, 结算号码, 结算性质, 会话号)
          Values
            (病人预交记录_Id.Nextval, 3, Null, 1, r_Balancedata.病人id, Null, v_结算摘要, v_结算方式, r_Balancedata.收款时间,
             r_Balancedata.操作员编号, r_Balancedata.操作员姓名, n_结算金额, n_重结id, r_Balancedata.缴款组id, r_Balancedata.结算序号, 2, Null,
             Null, 卡号_In, 交易流水号_In, 交易说明_In, Null, 3, n_会话号);
          Update 病人预交记录 Set 冲预交 = 冲预交 - n_结算金额 Where 结帐id = n_重结id And 结算方式 Is Null;
        End If;
      Else
        --:>退款
        If Nvl(n_结算金额, 0) <> 0 Then
          Insert Into 病人预交记录
            (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 卡类别id, 结算卡序号,
             卡号, 交易流水号, 交易说明, 结算号码, 结算性质, 会话号)
          Values
            (病人预交记录_Id.Nextval, 3, Null, 2, r_Balancedata.病人id, Null, v_结算摘要, v_结算方式, r_Balancedata.收款时间,
             r_Balancedata.操作员编号, r_Balancedata.操作员姓名, n_结算金额, r_Balancedata.结帐id, r_Balancedata.缴款组id,
             r_Balancedata.结算序号, 2, Null, Null, 卡号_In, 交易流水号_In, 交易说明_In, Null, 3, n_会话号);
        
          Update 病人预交记录 Set 冲预交 = 冲预交 - n_结算金额 Where 结帐id = 冲销id_In And 结算方式 Is Null;
          If Sql%NotFound Then
            v_Err_Msg := '结算信息错误,可能因为并发原因造成结算信息错误,请在[收费结算窗口]中重新收费！';
            Raise Err_Item;
          End If;
        End If;
      End If;
      v_结算内容 := Substr(v_结算内容, Instr(v_结算内容, '||') + 2);
    End Loop;
  
  End If;

  If 操作类型_In = 2 Then
    --   2.三方卡退费结算:
  
    v_当前结算 := 结算方式_In;
    v_结算方式 := Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1);
    v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
    n_结算金额 := To_Number(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
    v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
    v_结算号码 := LTrim(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
    v_结算摘要 := LTrim(Substr(v_当前结算, Instr(v_当前结算, '|') + 1));
  
    If Nvl(n_结算金额, 0) <> 0 Then
    
      If Nvl(n_重结id, 0) <> 0 Then
        --1.先按此种方式全退
        --2.再按此种方式收款
        --3:1+2=本次退款
        --1.先将退费的全部作废掉
        Select Sum(冲预交)
        Into n_返回值
        From 病人预交记录
        Where 结帐id = 冲销id_In And 结算方式 Is Null And Nvl(冲预交, 0) <> 0;
        If Nvl(n_返回值, 0) <> 0 Then
          Insert Into 病人预交记录
            (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 卡类别id, 结算卡序号,
             卡号, 交易流水号, 交易说明, 结算号码, 结算性质, 会话号)
          Values
            (病人预交记录_Id.Nextval, 3, Null, 2, r_Balancedata.病人id, Null, v_结算摘要, v_结算方式, r_Balancedata.收款时间,
             r_Balancedata.操作员编号, r_Balancedata.操作员姓名, n_返回值, 冲销id_In, r_Balancedata.缴款组id, r_Balancedata.结算序号, 2,
             卡类别id_In, Null, 卡号_In, 交易流水号_In, 交易说明_In, Null, 3, n_会话号);
          Update 病人预交记录 Set 冲预交 = 冲预交 - Nvl(n_返回值, 0) Where 结帐id = 冲销id_In And 结算方式 Is Null;
        End If;
        n_结算金额 := n_结算金额 - Nvl(n_返回值, 0);
      
        --2.退款
        Insert Into 病人预交记录
          (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 卡类别id, 结算卡序号, 卡号,
           交易流水号, 交易说明, 结算号码, 结算性质, 会话号)
        Values
          (病人预交记录_Id.Nextval, 3, Null, 1, r_Balancedata.病人id, Null, v_结算摘要, v_结算方式, r_Balancedata.收款时间,
           r_Balancedata.操作员编号, r_Balancedata.操作员姓名, n_结算金额, n_重结id, r_Balancedata.缴款组id, r_Balancedata.结算序号, 2,
           卡类别id_In, Null, 卡号_In, 交易流水号_In, 交易说明_In, Null, 3, n_会话号);
        Update 病人预交记录 Set 冲预交 = 冲预交 - n_结算金额 Where 结帐id = n_重结id And 结算方式 Is Null;
      
      Else
        Insert Into 病人预交记录
          (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 卡类别id, 结算卡序号, 卡号,
           交易流水号, 交易说明, 结算号码, 结算性质, 会话号)
        Values
          (病人预交记录_Id.Nextval, 3, Null, 2, r_Balancedata.病人id, Null, v_结算摘要, v_结算方式, r_Balancedata.收款时间,
           r_Balancedata.操作员编号, r_Balancedata.操作员姓名, n_结算金额, r_Balancedata.结帐id, r_Balancedata.缴款组id, r_Balancedata.结算序号,
           2, 卡类别id_In, Null, 卡号_In, 交易流水号_In, 交易说明_In, v_结算号码, 3, n_会话号);
      
        Update 病人预交记录 Set 冲预交 = 冲预交 - n_结算金额 Where 结帐id = 冲销id_In And 结算方式 Is Null;
        If Sql%NotFound Then
          v_Err_Msg := '结算信息错误,可能因为并发原因造成结算信息错误,请在[收费结算窗口]中重新收费！';
          Raise Err_Item;
        End If;
      End If;
    End If;
  End If;

  If 操作类型_In = 3 Then
    --   3-医保结算(如果存在医保的结算,则要先删除原医保结算,后按新传入的更新)
    --3.1检查是否已经存在医保结算数据,存在先删除
    n_结算金额 := 0;
    For v_医保 In (Select ID, 结算方式, 冲预交
                 From 病人预交记录 A
                 Where 结帐id = 冲销id_In And Exists
                  (Select 1 From 结算方式 Where a.结算方式 = 名称 And 性质 In (3, 4)) And Mod(记录性质, 10) <> 1) Loop
      n_结算金额 := n_结算金额 + Nvl(v_医保.冲预交, 0);
      l_预交id.Extend;
      l_预交id(l_预交id.Count) := v_医保.Id;
    End Loop;
    If Nvl(n_结算金额, 0) <> 0 Then
      Update 病人预交记录
      Set 冲预交 = Nvl(冲预交, 0) + Nvl(n_结算金额, 0)
      Where 结帐id = 冲销id_In And 结算方式 Is Null;
      If Sql%NotFound Then
        v_Err_Msg := '结算信息错误,可能因为并发原因造成结算信息错误,请在[收费结算窗口]中重新收费！';
        Raise Err_Item;
      End If;
    End If;
    If l_预交id.Count <> 0 Then
      Forall I In 1 .. l_预交id.Count
        Delete 病人预交记录 Where ID = l_预交id(I);
    End If;
  
    If 结算方式_In Is Not Null Then
      v_结算内容 := 结算方式_In || '||';
    End If;
  
    While v_结算内容 Is Not Null Loop
      v_当前结算 := Substr(v_结算内容, 1, Instr(v_结算内容, '||') - 1);
      v_结算方式 := Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1);
      n_结算金额 := To_Number(Substr(v_当前结算, Instr(v_当前结算, '|') + 1));
    
      For c_结算信息 In (Select 记录性质, NO, 记录状态, 病人id, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号
                     From 病人预交记录
                     Where 结帐id = 冲销id_In And 结算方式 Is Null) Loop
      
        Insert Into 病人预交记录
          (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 结算性质, 会话号)
        Values
          (病人预交记录_Id.Nextval, 3, Null, 2, c_结算信息.病人id, Null, '保险结算', v_结算方式, c_结算信息.收款时间, c_结算信息.操作员编号, c_结算信息.操作员姓名,
           n_结算金额, c_结算信息.结帐id, c_结算信息.缴款组id, c_结算信息.结算序号, 1, 3, n_会话号);
      End Loop;
      --更新数据(结算方式为NULL的)
      Update 病人预交记录
      Set 冲预交 = 冲预交 - n_结算金额
      Where 结帐id = 冲销id_In And 结算方式 Is Null
      Returning Nvl(冲预交, 0) Into n_返回值;
    
      v_结算内容 := Substr(v_结算内容, Instr(v_结算内容, '||') + 2);
    End Loop;
  End If;

  --4-消费卡批量结算
  If 操作类型_In = 4 Then
    v_结算内容 := 结算方式_In || '||';
    While v_结算内容 Is Not Null Loop
      v_当前结算 := Substr(v_结算内容, 1, Instr(v_结算内容, '||') - 1);
      --卡类别ID|卡号|消费卡ID|消费金额
      n_卡类别id := To_Number(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
      v_卡号     := Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1);
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
      n_消费卡id := To_Number(Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1));
      v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, '|') + 1);
      n_结算金额 := To_Number(v_当前结算);
      Begin
        Select 名称, 自制卡, 结算方式 Into v_名称, n_自制卡, v_结算方式 From 卡消费接口目录 Where 编号 = n_卡类别id;
      Exception
        When Others Then
          v_名称 := Null;
      End;
      If v_名称 Is Null Then
        v_Err_Msg := '未找到对应的结算卡接口,本次刷卡消费失败!';
        Raise Err_Item;
      End If;
      If v_结算方式 Is Null Then
        v_Err_Msg := v_名称 || '未设置对应的结算方式,本次刷卡消费失败!';
        Raise Err_Item;
      End If;
      If Nvl(n_结算金额, 0) <> 0 Then
        n_结帐id := 冲销id_In;
      
        If Nvl(n_重结id, 0) <> 0 Then
        
          Select Sum(冲预交)
          Into n_返回值
          From 病人预交记录
          Where 结帐id = 冲销id_In And 结算方式 Is Null And Nvl(冲预交, 0) <> 0;
          If Nvl(n_返回值, 0) <> 0 Then
          
            Update 病人预交记录
            Set 冲预交 = Nvl(冲预交, 0) + Nvl(n_返回值, 0)
            Where 结帐id = 冲销id_In And 结算方式 = v_结算方式 And 结算卡序号 = n_卡类别id
            Returning ID Into n_预交id;
          
            If Sql%NotFound Then
              Select 病人预交记录_Id.Nextval Into n_预交id From Dual;
              Insert Into 病人预交记录
                (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 结算卡序号, 校对标志,
                 结算性质, 会话号)
              Values
                (n_预交id, 3, Null, 2, r_Balancedata. 病人id, Null, Null, v_结算方式, r_Balancedata.收款时间, r_Balancedata.操作员编号,
                 r_Balancedata. 操作员姓名, n_返回值, r_Balancedata.结帐id, r_Balancedata. 缴款组id, r_Balancedata.结算序号, n_卡类别id, 2,
                 3, n_会话号);
            End If;
            Update 病人预交记录 Set 冲预交 = 冲预交 - Nvl(n_返回值, 0) Where 结帐id = 冲销id_In And 结算方式 Is Null;
          
            --插入卡结算记录
            --检查消费卡是否正确
            n_序号 := Zl_消费卡目录_Check(n_卡类别id, v_卡号, n_消费卡id, v_Err_Msg);
            If Nvl(n_序号, 0) = 0 Then
              Raise Err_Item;
            End If;
            Begin
              Select Nvl(Max(Nvl(序号, 0)), 0) + 1
              Into n_序号
              From 病人卡结算记录
              Where 接口编号 = n_卡类别id And Nvl(消费卡id, 0) = Nvl(n_消费卡id, 0) And 卡号 = v_卡号;
            Exception
              When Others Then
                n_序号 := 1;
            End;
          
            Select 病人卡结算记录_Id.Nextval Into n_Id From Dual;
          
            Insert Into 病人卡结算记录
              (ID, 接口编号, 消费卡id, 序号, 记录状态, 结算方式, 结算金额, 卡号, 交易流水号, 交易时间, 备注, 结算标志)
            Values
              (n_Id, n_卡类别id, n_消费卡id, n_序号, 1, v_结算方式, n_返回值, v_卡号, Null, r_Balancedata.收款时间, Null, 0);
          
            --如果消费卡,需同时更改其余额
            If Nvl(n_消费卡id, 0) <> 0 Then
              Update 消费卡目录 Set 余额 = 余额 - n_返回值 Where ID = n_消费卡id;
              If Sql%NotFound Then
                v_Err_Msg := '卡号为' || v_卡号 || '的' || v_名称 || '未找到!';
                Raise Err_Item;
              End If;
            End If;
            Insert Into 病人卡结算对照 (预交id, 卡结算id) Values (n_预交id, n_Id);
            n_结算金额 := n_结算金额 - Nvl(n_返回值, 0);
          End If;
          n_结帐id := n_重结id;
        
        End If;
      
        Update 病人预交记录
        Set 冲预交 = Nvl(冲预交, 0) + n_结算金额
        Where 结帐id = n_结帐id And 结算方式 = v_结算方式 And 结算卡序号 = n_卡类别id
        Returning ID Into n_预交id;
      
        If Sql%NotFound Then
          Select 病人预交记录_Id.Nextval Into n_预交id From Dual;
          Insert Into 病人预交记录
            (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 结算卡序号, 校对标志, 结算性质,
             会话号)
          Values
            (n_预交id, 3, Null, Decode(Nvl(n_重结id, 0), 0, 2, 1), r_Balancedata. 病人id, Null, Null, v_结算方式,
             r_Balancedata. 收款时间, r_Balancedata. 操作员编号, r_Balancedata. 操作员姓名, n_结算金额, n_结帐id, r_Balancedata. 缴款组id,
             r_Balancedata. 结算序号, n_卡类别id, 2, 3, n_会话号);
        End If;
      
        --插入卡结算记录
        n_序号 := Zl_消费卡目录_Check(n_卡类别id, v_卡号, n_消费卡id, v_Err_Msg);
        If Nvl(n_序号, 0) = 0 Then
          Raise Err_Item;
        End If;
      
        Begin
          Select Nvl(Max(Nvl(序号, 0)), 0) + 1
          Into n_序号
          From 病人卡结算记录
          Where 接口编号 = n_卡类别id And Nvl(消费卡id, 0) = Nvl(n_消费卡id, 0) And 卡号 = v_卡号;
        Exception
          When Others Then
            n_序号 := 1;
        End;
      
        Select 病人卡结算记录_Id.Nextval Into n_Id From Dual;
      
        Insert Into 病人卡结算记录
          (ID, 接口编号, 消费卡id, 序号, 记录状态, 结算方式, 结算金额, 卡号, 交易流水号, 交易时间, 备注, 结算标志)
        Values
          (n_Id, n_卡类别id, n_消费卡id, n_序号, 1, v_结算方式, n_结算金额, v_卡号, Null, r_Balancedata.收款时间, Null, 0);
        --如果消费卡,需同时更改其余额
        If Nvl(n_消费卡id, 0) <> 0 Then
          Update 消费卡目录 Set 余额 = 余额 - n_结算金额 Where ID = n_消费卡id;
          If Sql%NotFound Then
            v_Err_Msg := '卡号为' || v_卡号 || '的' || v_名称 || '未找到!';
            Raise Err_Item;
          End If;
        End If;
        Insert Into 病人卡结算对照 (预交id, 卡结算id) Values (n_预交id, n_Id);
      
        --更新数据(结算方式为NULL的)
        Update 病人预交记录
        Set 冲预交 = 冲预交 - n_结算金额
        Where 结帐id = n_结帐id And 结算方式 Is Null
        Returning Nvl(冲预交, 0) Into n_返回值;
      End If;
      v_结算内容 := Substr(v_结算内容, Instr(v_结算内容, '||') + 2);
    End Loop;
  End If;

  If Nvl(完成退费_In, 0) = 0 Then
    Return;
  End If;

  -----------------------------------------------------------------------------------------
  --完成收费,需要处理人员缴款余额,预交记录(结算方式=NULL)
  If Nvl(完成退费_In, 0) = 1 Then
    Update 病人预交记录 Set 缴款 = 缴款_In, 找补 = 找补_In, 校对标志 = 0, 会话号 = Null Where 结帐id = 冲销id_In;
    Return;
  End If;

  --1.删除结算方式为NULL的预交记录
  Delete 病人预交记录 Where 结帐id = 冲销id_In And 结算方式 Is Null And Nvl(冲预交, 0) = 0;
  If Sql%NotFound Then
    Select Count(*) Into n_Count From 病人预交记录 A Where 结帐id = 冲销id_In And 结算方式 Is Null;
    If n_Count <> 0 Then
      v_Err_Msg := '还存在未缴款的数据,不能完成结算!';
    Else
      v_Err_Msg := '结算信息错误,可能因为并发原因造成结算信息错误,请在[收费结算窗口]中重新收费！!';
    End If;
    Raise Err_Item;
  End If;
  If Nvl(n_重结id, 0) <> 0 Then
    Delete 病人预交记录 Where 结帐id = n_重结id And 结算方式 Is Null And Nvl(冲预交, 0) = 0;
    If Sql%NotFound Then
      Select Count(*) Into n_Count From 病人预交记录 A Where 结帐id = n_重结id And 结算方式 Is Null;
      If n_Count <> 0 Then
        v_Err_Msg := '还存在未缴款的数据,不能完成结算!';
      Else
        v_Err_Msg := '结算信息错误,可能因为并发原因造成结算信息错误,请在[收费结算窗口]中重新收费！!';
      End If;
      Raise Err_Item;
    End If;
    Update 病人预交记录 Set 缴款 = 缴款_In, 找补 = 找补_In, 校对标志 = 0 Where 结帐id = n_重结id;
  
  End If;

  --结算金额为零时，增加一条金额为0的病人预交记录
  Select Count(*) Into n_Count From 病人预交记录 A Where 结帐id = 冲销id_In;

  If n_Count = 0 Then
    v_结算方式 := 缺省结算方式_In;
    If v_结算方式 Is Null Then
      Begin
        Select 结算方式 Into v_结算方式 From 结算方式应用 Where 应用场合 = '收费' And Nvl(缺省标志, 0) = 1;
      Exception
        When Others Then
          v_结算方式 := Null;
      End;
      If v_结算方式 Is Null Then
        Begin
          Select 名称 Into v_结算方式 From 结算方式 Where Nvl(性质, 0) = 1;
        Exception
          When Others Then
            v_结算方式 := '现金';
        End;
      End If;
    End If;
    Insert Into 病人预交记录
      (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 卡类别id, 结算卡序号, 卡号,
       交易流水号, 交易说明, 结算号码, 结算性质, 会话号)
    Values
      (病人预交记录_Id.Nextval, 3, Null, 1, r_Balancedata.病人id, Null, Null, v_结算方式, r_Balancedata.收款时间, r_Balancedata.操作员编号,
       r_Balancedata.操作员姓名, 0, r_Balancedata.结帐id, r_Balancedata.缴款组id, r_Balancedata.结算序号, 2, Null, Null, Null, Null,
       交易说明_In, Null, 3, n_会话号);
  End If;

  --2.处理缴款数据和找补数据及校对标志更新为0，会话号更新为NULL
  Update 病人预交记录 Set 缴款 = 缴款_In, 找补 = 找补_In, 校对标志 = 0, 会话号 = Null Where 结帐id = 冲销id_In;
  If Nvl(n_重结id, 0) <> 0 Then
    Update 病人预交记录 Set 缴款 = 缴款_In, 找补 = 找补_In, 校对标志 = 0, 会话号 = Null Where 结帐id = n_重结id;
  End If;

  --3.更新费用状态
  Update 门诊费用记录 Set 费用状态 = 0 Where 结帐id = 冲销id_In;
  If Nvl(n_重结id, 0) <> 0 Then
    Update 门诊费用记录 Set 费用状态 = 0 Where 结帐id = n_重结id;
  End If;

  --4.更新人员缴款数据
  If n_重结id <> 0 Then
    For c_缴款 In (Select 结算方式, 操作员姓名, Sum(Nvl(a.冲预交, 0)) As 冲预交
                 From 病人预交记录 A
                 Where a.结帐id In (冲销id_In, n_重结id) And Mod(a.记录性质, 10) <> 1
                 Group By 结算方式, 操作员姓名) Loop
    
      Update 人员缴款余额
      Set 余额 = Nvl(余额, 0) + Nvl(c_缴款.冲预交, 0)
      Where 收款员 = c_缴款.操作员姓名 And 性质 = 1 And 结算方式 = c_缴款.结算方式;
      If Sql%RowCount = 0 Then
        Insert Into 人员缴款余额
          (收款员, 结算方式, 性质, 余额)
        Values
          (c_缴款.操作员姓名, c_缴款.结算方式, 1, Nvl(c_缴款.冲预交, 0));
      End If;
    End Loop;
  
  Else
    For c_缴款 In (Select 结算方式, 操作员姓名, Sum(Nvl(a.冲预交, 0)) As 冲预交
                 From 病人预交记录 A
                 Where a.结帐id = 冲销id_In And Mod(a.记录性质, 10) <> 1
                 Group By 结算方式, 操作员姓名) Loop
    
      Update 人员缴款余额
      Set 余额 = Nvl(余额, 0) + Nvl(c_缴款.冲预交, 0)
      Where 收款员 = c_缴款.操作员姓名 And 性质 = 1 And 结算方式 = c_缴款.结算方式;
      If Sql%RowCount = 0 Then
        Insert Into 人员缴款余额
          (收款员, 结算方式, 性质, 余额)
        Values
          (c_缴款.操作员姓名, c_缴款.结算方式, 1, Nvl(c_缴款.冲预交, 0));
      End If;
    End Loop;
  End If;
  --消息推送
  Select 病人id_In || ',' || 冲销id_In || ',' || Decode(完成退费_In, 2, 0, 0, 0, 1) Into v_Msg From Dual;
  Begin
    Execute Immediate 'Begin ZL_服务窗消息_发送(:1,:2); End;'
      Using 5, v_Msg;
  Exception
    When Others Then
      Null;
  End;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_门诊退费结算_Modify;
/

--92026:蒋廷中,2017-10-13,自由录入的医嘱也可以登记执行情况 
CREATE OR REPLACE Procedure Zl_病人医嘱执行_Insert
( 
  医嘱id_In       病人医嘱执行.医嘱id%Type, 
  发送号_In       病人医嘱执行.发送号%Type, 
  要求时间_In     病人医嘱执行.要求时间%Type, 
  本次数次_In     病人医嘱执行.本次数次%Type, 
  执行摘要_In     病人医嘱执行.执行摘要%Type, 
  执行人_In       病人医嘱执行.执行人%Type, 
  执行时间_In     病人医嘱执行.执行时间%Type, 
  单独执行_In     Number := 0, 
  自动完成_In     Number := 0, 
  执行结果_In     病人医嘱执行.执行结果%Type := 1, 
  未执行原因_In   病人医嘱执行.说明%Type := Null, 
  操作员编号_In   人员表.编号%Type := Null, 
  操作员姓名_In   人员表.姓名%Type := Null, 
  执行部门id_In   门诊费用记录.执行部门id%Type := 0, 
  配液检查_In     Number := 0, 
  检验项目记帐_In Number := 0, 
  输液通道_In     病人医嘱执行.输液通道%Type := Null 
  --参数：医嘱ID_IN=单独执行的医嘱ID，检验组合为显示的检验项目的ID。 
  --      执行结果_In=1- 完成   =0  -未执行 
  --      如果是台式机调用 操作员编号_In 操作员姓名_In 这两个参数必须传入 
  --执行部门id_In=仅处理指定执行部门的费用，不传或传入0时不限制执行部门 
  --配液检查_In=移动工作站调用时，是否检查配液信息。 
  --检验项目记帐_In=如果是检验项目时，需要记帐但不完成医嘱发送状态 
) Is 
  --除了要执行的主记录,还包含了附加手术,检查部位的记录 
  --手术麻醉,中药煎法,采集方法单独控制,检验组合只填写在第一个项目上，但执行状态相同 
  v_组id     病人医嘱记录.Id%Type; 
  v_诊疗类别 病人医嘱记录.诊疗类别%Type; 
  v_自动完成 Number; 
  v_病人来源 病人医嘱记录.病人来源%Type; 
  v_费用性质 病人医嘱发送.记录性质%Type; 
  v_操作类型 诊疗项目目录.操作类型%Type; 
  v_病区id   病案主页.当前病区id%Type; 
  v_配液病区 Varchar2(200); 
  v_Count    Number; 
  v_Temp     Varchar2(255); 
  v_人员编号 人员表.编号%Type; 
  v_人员姓名 人员表.姓名%Type; 
  n_期效     病人医嘱记录.医嘱期效%Type; 
  n_诊疗项目id 病人医嘱记录.诊疗项目id%Type;
  v_叮嘱执行   Varchar2(5);
 
  n_执行次数 Number; 
  n_剩余次数 Number; 
  n_执行状态 Number; 
  d_终止时间 Date; 
  d_开始时间 Date; 
  n_发送数次 Number;
  n_登记数次 Number;
  n_单次数次 Number;
  d_要求时间 Date;
 
  v_Date  Date; 
  v_Error Varchar2(255); 
  Err_Custom Exception; 
Begin 
  --并发查检，防止产生多条执行记录 
  Begin 
    Select (a.发送数次 - c.登记次数) As 剩余数次, a.发送数次, Nvl(n_诊疗项目id, 0)
    Into v_Count, n_发送数次, n_诊疗项目id
    From 病人医嘱发送 A, 
         (Select 医嘱id_In As 医嘱id, 发送号_In As 发送号, Nvl(Sum(b.本次数次), 0) As 登记次数 
           From 病人医嘱执行 B 
           Where b.医嘱id = 医嘱id_In And b.发送号 = 发送号_In) C, 病人医嘱记录 D
    Where a.医嘱id = c.医嘱id And a.发送号 = c.发送号 And a.医嘱id = 医嘱id_In And a.医嘱id = d.Id And a.发送号 = 发送号_In;
  Exception 
    When Others Then 
      v_Count := 本次数次_In; 
  End; 
  v_叮嘱执行 := zl_GetSysParameter(288);
  If 本次数次_In > v_Count And (Not (n_诊疗项目id = 0 And v_叮嘱执行 = 1)) Then
    v_Error := '由于并发操作可能已经被他人登记，请刷新后再试。'; 
    Raise Err_Custom; 
  End If; 
  --当前操作人员 
  If 操作员编号_In Is Not Null And 操作员姓名_In Is Not Null Then 
    v_人员编号 := 操作员编号_In; 
    v_人员姓名 := 操作员姓名_In; 
  Else 
    Begin 
      Select 姓名, 编号 Into v_人员姓名, v_人员编号 From 人员表 Where 姓名 = 执行人_In; 
    Exception 
      When Others Then 
        v_Temp     := Zl_Identity; 
        v_Temp     := Substr(v_Temp, Instr(v_Temp, ';') + 1); 
        v_Temp     := Substr(v_Temp, Instr(v_Temp, ',') + 1); 
        v_人员编号 := Substr(v_Temp, 1, Instr(v_Temp, ',') - 1); 
        v_人员姓名 := Substr(v_Temp, Instr(v_Temp, ',') + 1); 
    End; 
  End If; 
  --对医嘱终止时间进行检查 
  Select a.执行终止时间, a.开始执行时间, a.医嘱期效 
  Into d_终止时间, d_开始时间, n_期效 
  From 病人医嘱记录 A 
  Where a.Id = 医嘱id_In; 
  If Not d_终止时间 Is Null And n_期效 = 0 Then 
    If 要求时间_In > d_终止时间 Then 
      v_Error := '要求时间超过了医嘱终止时间，请确认医嘱是否提前停止！'; 
      Raise Err_Custom; 
    End If; 
  End If; 
  If Not d_开始时间 Is Null Then 
    If 执行时间_In < d_开始时间 Then 
      v_Error := '执行时间必须大于医嘱的开始执行时间''' || To_Char(d_开始时间, 'yyyy-mm-dd HH24:mi:ss') || '''！'; 
      Raise Err_Custom; 
    End If; 
  End If; 
  Select Sysdate Into v_Date From Dual; 
  Select a.病人来源, 执行科室id, Nvl(a.相关id, a.Id), Nvl(a.诊疗类别, '*'), Nvl(b.操作类型, '0') 操作类型
  Into v_病人来源, v_病区id, v_组id, v_诊疗类别, v_操作类型
  From 病人医嘱记录 A, 诊疗项目目录 B
  Where a.Id = 医嘱id_In And a.诊疗项目id = b.Id(+);

  If v_病人来源 = 2 Then 
    Select Decode(记录性质, 1, 1, Decode(门诊记帐, 1, 1, 2)) 
    Into v_费用性质 
    From 病人医嘱发送 
    Where 发送号 = 发送号_In And 医嘱id = 医嘱id_In; 
  Else 
    v_费用性质 := 1; 
  End If; 
 
  --移动系统配液检查 
  If 配液检查_In = 1 Then 
    --检查当前病人所属病区是否进行配液登记管理 
    Select Nvl(Zl_Getsysparameter(184), '') Into v_配液病区 From Dual; 
 
    If v_配液病区 Is Not Null And 执行结果_In <> 0 Then 
      If Instr(',' || v_配液病区 || ',', ',' || v_病区id || ',') > 0 Then 
        v_病区id   := 0; 
        v_配液病区 := 'Select 1 From 病区配液记录 where 医嘱ID=:YZID AND 发送号=:FSH AND 要求时间=:YQSJ'; 
        Begin 
          Execute Immediate v_配液病区 
            Into v_病区id 
            Using 医嘱id_In, 发送号_In, 要求时间_In; 
        Exception 
          When Others Then 
            Null; 
        End; 
        If v_病区id = 0 Then 
          v_Error := '当前医嘱还未进行配液，不允许进行执行登记！'; 
          Raise Err_Custom; 
        End If; 
      End If; 
    End If; 
    --检查当前医嘱是否已配液 
  End If; 
 
  --病人医嘱执行 
  Select Count(1) 
  Into v_Count 
  From 病人医嘱执行 
  Where 医嘱id = 医嘱id_In And 发送号 = 发送号_In And 执行时间 = 执行时间_In; 
  If v_Count > 0 Then 
    v_Error := '您指定的执行时间，已经执行过本条医嘱，请更改一个执行时间。'; 
    Raise Err_Custom; 
  End If; 
  Insert Into 病人医嘱执行 
    (医嘱id, 发送号, 要求时间, 本次数次, 执行摘要, 执行人, 执行时间, 登记时间, 登记人, 执行结果, 说明, 输液通道) 
  Values 
    (医嘱id_In, 发送号_In, 要求时间_In, 本次数次_In, 执行摘要_In, 执行人_In, 执行时间_In, v_Date, v_人员姓名, 执行结果_In, 未执行原因_In, 输液通道_In); 
 
  --费用记录的执行状态进行更新 
  Select Decode(a.执行状态, 1, a.发送数次, c.登记次数), Decode(a.执行状态, 1, 0, a.发送数次 - c.登记次数) ,c.登记次数
  Into n_执行次数, n_剩余次数 ,n_登记数次
  From 病人医嘱发送 A, 
       (Select 医嘱id_In 医嘱id, 发送号_In 发送号, Nvl(Sum(b.本次数次), 0) As 登记次数 
         From 病人医嘱执行 B 
         Where b.医嘱id = 医嘱id_In And b.发送号 = 发送号_In And Nvl(b.执行结果, 1) <> 0) C 
  Where a.医嘱id = c.医嘱id And a.发送号 = c.发送号 And a.医嘱id = 医嘱id_In And a.发送号 = 发送号_In; 
  --如果全部执行则状态为1，未执行状态为0，部分执行状态为2 
  Select Decode(n_剩余次数, 0, 1, Decode(n_执行次数, 0, 0, 2)) Into n_执行状态 From Dual; 
 
  --填写了执行状态后就标记为正在执行 
  If Nvl(单独执行_In, 0) = 1 Then 
    Update 病人医嘱发送 
    Set 执行状态 = Decode(n_执行次数, 0, 0, 3) 
    Where 执行状态 In (0, 3) And 医嘱id = 医嘱id_In And 发送号 + 0 = 发送号_In; 
  Else 
    Update 病人医嘱发送 
    Set 执行状态 = Decode(n_执行次数, 0, 0, 3) 
    Where 执行状态 In (0, 3) And 发送号 + 0 = 发送号_In And 
          医嘱id In (Select ID 
                   From 病人医嘱记录 
                   Where ID = v_组id And Nvl(诊疗类别, '*') = v_诊疗类别
                   Union All
                   Select ID
                   From 病人医嘱记录
                   Where 相关id = v_组id And Nvl(诊疗类别, '*') = v_诊疗类别);
  End If; 
 
  --更新对应的费用执行状态为已执行(无正在执行) 
  --不应该处理药品和跟踪在用的卫材 
  If 执行结果_In = 1 Then 
    If v_费用性质 = 2 Then 
      If Nvl(单独执行_In, 0) = 1 Then 
        Update 住院费用记录 A 
        Set 执行状态 = n_执行状态, 执行人 = Decode(n_执行状态, 0, Null, 执行人_In), 执行时间 = Decode(n_执行状态, 0, Null, 执行时间_In) 
        Where 收费类别 Not In ('5', '6', '7') And (执行部门id_In = 0 Or a.执行部门id = 执行部门id_In) And Not Exists 
         (Select 1 From 材料特性 Where 材料id = a.收费细目id And 跟踪在用 = 1) And a.记录状态 In (0, 1, 3) And 
              (医嘱序号, NO, 记录性质) In 
              (Select 医嘱id, NO, 记录性质 
               From 病人医嘱发送 
               Where 执行状态 = Decode(n_执行次数, 0, 0, 3) And 医嘱id = 医嘱id_In And 发送号 + 0 = 发送号_In); 
      Else 
        Update 住院费用记录 A 
        Set 执行状态 = n_执行状态, 执行人 = Decode(n_执行状态, 0, Null, 执行人_In), 执行时间 = Decode(n_执行状态, 0, Null, 执行时间_In) 
        Where 收费类别 Not In ('5', '6', '7') And (执行部门id_In = 0 Or a.执行部门id = 执行部门id_In) And Not Exists 
         (Select 1 From 材料特性 Where 材料id = a.收费细目id And 跟踪在用 = 1) And a.记录状态 In (0, 1, 3) And 
              (医嘱序号, NO, 记录性质) In 
              (Select 医嘱id, NO, 记录性质 
               From 病人医嘱发送 
               Where 执行状态 = Decode(n_执行次数, 0, 0, 3) And 发送号 + 0 = 发送号_In And 
                     医嘱id In (Select ID 
                              From 病人医嘱记录 
                              Where ID = v_组id And 诊疗类别 = v_诊疗类别 
                              Union All 
                              Select ID From 病人医嘱记录 Where 相关id = v_组id And 诊疗类别 = v_诊疗类别)); 
      End If; 
    Else 
      If Nvl(单独执行_In, 0) = 1 Then 
        --对于门诊单据n_执行状态可能为0（登记执行情况，选择执行结果为未执行），因此需判断 
        Update 门诊费用记录 A 
        Set 执行状态 = n_执行状态, 执行人 = Decode(n_执行状态, 0, Null, 执行人_In), 执行时间 = Decode(n_执行状态, 0, Null, 执行时间_In) 
        Where 收费类别 Not In ('5', '6', '7') And (执行部门id_In = 0 Or a.执行部门id = 执行部门id_In) And Not Exists 
         (Select 1 From 材料特性 Where 材料id = a.收费细目id And 跟踪在用 = 1) And a.记录状态 In (0, 1, 3) And 
              (医嘱序号, NO, 记录性质) In 
              (Select 医嘱id, NO, 记录性质 
               From 病人医嘱发送 
               Where 执行状态 = Decode(n_执行次数, 0, 0, 3) And 医嘱id = 医嘱id_In And 发送号 + 0 = 发送号_In); 
      Else 
        Update 门诊费用记录 A 
        Set 执行状态 = n_执行状态, 执行人 = Decode(n_执行状态, 0, Null, 执行人_In), 执行时间 = Decode(n_执行状态, 0, Null, 执行时间_In) 
        Where 收费类别 Not In ('5', '6', '7') And (执行部门id_In = 0 Or a.执行部门id = 执行部门id_In) And Not Exists 
         (Select 1 From 材料特性 Where 材料id = a.收费细目id And 跟踪在用 = 1) And a.记录状态 In (0, 1, 3) And 
              (医嘱序号, NO, 记录性质) In 
              (Select 医嘱id, NO, 记录性质 
               From 病人医嘱发送 
               Where 执行状态 = Decode(n_执行次数, 0, 0, 3) And 发送号 + 0 = 发送号_In And 
                     医嘱id In (Select ID 
                              From 病人医嘱记录 
                              Where ID = v_组id And 诊疗类别 = v_诊疗类别 
                              Union All 
                              Select ID From 病人医嘱记录 Where 相关id = v_组id And 诊疗类别 = v_诊疗类别)); 
      End If; 
    End If; 
    --检验自动完成采集 
    If v_诊疗类别 = 'E' And v_操作类型 = '6' Then 
      Update 病人医嘱发送 A 
      Set a.采样人 = 执行人_In, a.采样时间 = 执行时间_In 
      Where 医嘱id In (Select ID 
                     From 病人医嘱记录 
                     Where ID = v_组id 
                     Union All 
                     Select ID From 病人医嘱记录 Where 相关id = v_组id) And 发送号 = 发送号_In; 
    End If; 
 
    --执行数次达到之后自动完成执行(主要用于PDA自动执行)，如果启用了移动临床，则护士站和PDA一致。 
    v_自动完成 := 自动完成_In; 
    If Nvl(v_自动完成, 0) = 0 And v_病人来源 = 2 And Instr('C,D', v_诊疗类别) = 0 Then 
      Begin 
        Execute Immediate 'Select Count(1) From ZLMBSYSTEMS' 
          Into v_Count; 
      Exception 
        When Others Then 
          Null; 
      End; 
      If v_Count > 0 Then 
        v_自动完成 := 1; 
      End If; 
    End If; 
 
    If Nvl(v_自动完成, 0) = 1 Or 检验项目记帐_In = 1 Then 
      Begin 
        Select Decode(Sign(Nvl(Sum(b.本次数次), 0) - a.发送数次), 1, 1, 0, 1, 0) 
        Into v_自动完成 
        From 病人医嘱发送 A, 病人医嘱执行 B 
        Where a.医嘱id = b.医嘱id And a.发送号 = b.发送号 And a.执行状态 In (0, 3) And a.医嘱id = 医嘱id_In And a.发送号 = 发送号_In 
        Group By a.发送数次; 
      Exception 
        When Others Then 
          Null; 
      End; 
 
      If Nvl(v_自动完成, 0) = 1 Or 检验项目记帐_In = 1 Then 
        Zl_病人医嘱执行_Finish(医嘱id_In, 发送号_In, Null, 单独执行_In, v_人员编号, v_人员姓名, 执行部门id_In, 检验项目记帐_In); 
      End If; 
    End If; 
    --更新医嘱执行计价.执行状态
    If n_发送数次 > 0 Then
      Select Count(distinct 要求时间) Into v_Count From 医嘱执行计价 Where 医嘱ID = 医嘱ID_IN And 发送号 = 发送号_IN;
      If v_Count > 0 Then
        n_单次数次 := n_发送数次 / v_Count;
        --已执行数量+本次数次 总共能够执行多少个时间点,取最大整数
        v_Count := ceil((n_登记数次) / n_单次数次);
        --获取执行截至要求时间 
        Select 要求时间 Into d_要求时间
        From (Select 要求时间, Rownum As 次数
               From (Select Distinct 要求时间 From 医嘱执行计价 Where 医嘱id = 医嘱ID_IN And 发送号 = 发送号_IN Order By 要求时间))
        Where 次数 = v_Count;
        
        If Not d_要求时间 Is Null Then
          --先检查是否已经退费
          Select Max(NVL(执行状态,0)) Into v_Count From 医嘱执行计价 Where 医嘱id = 医嘱ID_IN And 发送号 = 发送号_IN And 要求时间 <= d_要求时间;
          If v_Count = 2 Then
            v_Error := '您指定的执行时间段的医嘱费用已经被退费，不允许再执行。'; 
            Raise Err_Custom; 
          End If;
          --更新截至要求时间之前(含)的记录执行状态；
          Update 医嘱执行计价 Set 执行状态 = 1 Where 医嘱id = 医嘱ID_IN And 发送号 = 发送号_IN And 要求时间 <= d_要求时间 And NVL(执行状态,0) <> 2;
        End If;
      End If;
    End If;
  End If; 
Exception 
  When Err_Custom Then 
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]'); 
  When Others Then 
    Zl_Errorcenter(Sqlcode, Sqlerrm); 
End Zl_病人医嘱执行_Insert;
/

--92026:蒋廷中,2017-10-13,自由录入的医嘱也可以登记执行情况 
Create Or Replace Procedure Zl_病人医嘱记录_校对
(
  --功能：校对指定的医嘱
  --参数：医嘱ID_IN=Nvl(相关ID,ID)
  --      状态_IN=校对通过3或校对疑问2
  --      自动校对_IN=保存之后调用自动校对,自动填写计价内容
  --说明：一组医嘱只能调用一次,过程同时完成处理一组医嘱的校对
  医嘱id_In     病人医嘱记录.Id%Type,
  状态_In       病人医嘱记录.医嘱状态%Type,
  校对时间_In   病人医嘱状态.操作时间%Type,
  校对说明_In   病人医嘱状态.操作说明%Type := Null,
  自动校对_In   Number := Null,
  操作员编号_In 人员表.编号%Type := Null,
  操作员姓名_In 人员表.姓名%Type := Null
) Is
  --用于医嘱检查
  v_状态       病人医嘱记录.医嘱状态%Type;
  v_期效       病人医嘱记录.医嘱期效%Type;
  v_病人id     病人医嘱记录.病人id%Type;
  v_主页id     病人医嘱记录.主页id%Type;
  v_婴儿       病人医嘱记录.婴儿%Type;
  v_医嘱内容   病人医嘱记录.医嘱内容%Type;
  v_开嘱时间   病人医嘱记录.开嘱时间%Type;
  v_开始时间   病人医嘱记录.开始执行时间%Type;
  v_开嘱医生   病人医嘱记录.开嘱医生%Type;
  v_前提id     病人医嘱记录.前提id%Type;
  v_执行标记   病人医嘱记录.执行标记%Type;
  v_执行科室id 病人医嘱记录.执行科室id%Type;
  v_标本部位   病人医嘱记录.标本部位%Type;
  v_停止时间   病人医嘱记录.开嘱时间%Type;
  v_开嘱科室id 病人医嘱记录.开嘱科室id%Type;

  --用于变更护理等级
  v_诊疗类别   病人医嘱记录.诊疗类别%Type;
  v_诊疗项目id 病人医嘱记录.诊疗项目id%Type;
  v_操作类型   诊疗项目目录.操作类型%Type;
  v_护理等级id 病案主页.护理等级id%Type;
  v_紧急标志   病人医嘱记录.紧急标志%Type;
  v_入院方式   入院方式.名称%Type;

  v_Stopadviceids 病人医嘱记录.医嘱内容%Type;
  n_Adviceid      病人医嘱记录.病人id%Type;
  n_标记          Number(18);
  --与该项目同一自动停止互斥组的项目:组中应该都是长嘱(包括当前医嘱),程序应已检查。
  --注意应加婴儿条件,同时也应停止除当前医嘱外的其它相同诊疗项目的医嘱。
  Cursor c_Exclude Is
    Select Distinct b.Id As 医嘱id, b.开始执行时间, b.执行终止时间, b.上次执行时间, b.开嘱医生, b.执行时间方案, b.频率间隔, b.频率次数, b.间隔单位
    From 诊疗互斥项目 A, 病人医嘱记录 B
    Where a.类型 = 3 And a.项目id = b.诊疗项目id And b.Id <> 医嘱id_In And Nvl(b.医嘱期效, 0) = 0 And b.医嘱状态 In (3, 5, 6, 7) And
          b.病人id = v_病人id And Nvl(b.主页id, 0) = Nvl(v_主页id, 0) And Nvl(b.婴儿, 0) = Nvl(v_婴儿, 0) And
          a.组编号 In (Select Distinct 组编号 From 诊疗互斥项目 Where 类型 = 3 And 项目id = v_诊疗项目id)
    Order By b.Id;
  v_终止时间 病人医嘱记录.执行终止时间%Type;

  --护理等级互斥
  Cursor c_Nurse Is
    Select a.Id As 医嘱id, a.开始执行时间, a.执行终止时间, a.上次执行时间, a.开嘱医生
    From 病人医嘱记录 A, 诊疗项目目录 B
    Where a.诊疗项目id = b.Id And a.诊疗类别 = 'H' And b.操作类型 = '1' And a.病人id = v_病人id And Nvl(a.主页id, 0) = Nvl(v_主页id, 0) And
          Nvl(a.婴儿, 0) = Nvl(v_婴儿, 0) And Nvl(a.医嘱期效, 0) = 0 And a.医嘱状态 In (3, 5, 6, 7) And a.Id <> 医嘱id_In;

  --记录入出量互斥
  Cursor c_Patiio Is
    Select a.Id As 医嘱id, a.开始执行时间, a.执行终止时间, a.上次执行时间, a.开嘱医生
    From 病人医嘱记录 A, 诊疗项目目录 B
    Where a.诊疗项目id = b.Id And a.诊疗类别 = 'Z' And b.操作类型 = '12' And a.病人id = v_病人id And Nvl(a.主页id, 0) = Nvl(v_主页id, 0) And
          Nvl(a.婴儿, 0) = Nvl(v_婴儿, 0) And Nvl(a.医嘱期效, 0) = 0 And a.医嘱状态 In (3, 5, 6, 7) And a.Id <> 医嘱id_In;

  --记录病情互斥
  Cursor c_Patistate Is
    Select a.Id As 医嘱id, a.开始执行时间, a.执行终止时间, a.上次执行时间, a.开嘱医生
    From 病人医嘱记录 A, 诊疗项目目录 B
    Where a.诊疗项目id = b.Id And a.诊疗类别 = 'Z' And b.操作类型 In ('9', '10') And a.病人id = v_病人id And
          Nvl(a.主页id, 0) = Nvl(v_主页id, 0) And Nvl(a.婴儿, 0) = Nvl(v_婴儿, 0) And Nvl(a.医嘱期效, 0) = 0 And
          a.医嘱状态 In (3, 5, 6, 7) And a.Id <> 医嘱id_In;
  --变动有效记录
  Cursor c_Oldinfo Is
    Select b.*
    From (Select c.*
           From 病人变动记录 C
           Where c.病人id = v_病人id And c.主页id = v_主页id And
                 c.开始时间 = (Select Min(开始时间)
                           From 病人变动记录
                           Where 病人id = v_病人id And 主页id = v_主页id And 开始时间 > v_开始时间) And
                 NVL(c.终止时间|| '','空') = (Select  NVL(Min(终止时间)|| '','空')
                           From 病人变动记录
                           Where 病人id = v_病人id And 主页id = v_主页id And 开始时间 > v_开始时间)) A, 病人变动记录 B
    
    Where b.病人id = v_病人id And b.主页id = v_主页id And a.开始时间 = b.终止时间 And a.开始原因 = b.终止原因 And a.附加床位 = b.附加床位
    Union
    Select *
    From 病人变动记录
    Where 病人id = v_病人id And 主页id = v_主页id And 终止时间 Is Null And 开始时间 <= v_开始时间;

  Cursor c_Endinfo Is
    Select * From 病人变动记录 Where 病人id = v_病人id And 主页id = v_主页id And 终止时间 Is Null;
  r_Oldinfo      c_Oldinfo%RowType;
  r_Endinfo      c_Endinfo%RowType;
  v_变动终止原因 病人变动记录.终止原因%Type;
  v_变动终止时间 病人变动记录.终止时间%Type;
  v_变动终止人员 病人变动记录.终止人员%Type;

  --包含病人(婴儿)的所有未停长嘱(含配方长嘱)
  Cursor c_Needstop
  (
    v_病人id   病人医嘱记录.病人id%Type,
    v_主页id   病人医嘱记录.主页id%Type,
    v_婴儿     病人医嘱记录.婴儿%Type,
    v_Stoptime Date
  ) Is
    Select a.Id, a.诊疗类别, b.操作类型, b.执行频率
    From 病人医嘱记录 A, 诊疗项目目录 B
    Where a.诊疗项目id = b.Id(+) And a.病人id = v_病人id And a.主页id = v_主页id And (v_婴儿 = -1 Or Nvl(a.婴儿, 0) = Nvl(v_婴儿, 0)) And
          Nvl(a.医嘱期效, 0) = 0 And a.医嘱状态 Not In (1, 2, 4, 8, 9) And a.开始执行时间 < v_Stoptime
    Order By a.序号;
  --包含病人(婴儿)的已停但未确认的长嘱,终止执行时间在指定时间之后
  Cursor c_Havestop
  (
    v_病人id   病人医嘱记录.病人id%Type,
    v_主页id   病人医嘱记录.主页id%Type,
    v_婴儿     病人医嘱记录.婴儿%Type,
    v_Stoptime Date
  ) Is
    Select ID
    From 病人医嘱记录
    Where 病人id = v_病人id And 主页id = v_主页id And (v_婴儿 = -1 Or Nvl(婴儿, 0) = Nvl(v_婴儿, 0)) And Nvl(医嘱期效, 0) = 0 And
          医嘱状态 = 8 And 执行终止时间 > v_Stoptime And 开始执行时间 < v_Stoptime
    Order By 序号;

  --取一组医嘱的计价内容
  Cursor c_Price Is
    Select a.Id, b.收费项目id, b.收费数量, b.从属项目, b.费用性质, b.收费方式, c.类别 As 收费类别, a.诊疗类别, e.操作类型, e.试管编码,
           Sum(Decode(Nvl(c.是否变价, 0), 1, Nvl(d.缺省价格, d.原价), Null)) As 单价
    From 病人医嘱记录 A, 诊疗收费关系 B, 收费项目目录 C, 收费价目 D, 诊疗项目目录 E
    Where a.诊疗项目id = b.诊疗项目id And b.收费项目id = c.Id And c.Id = d.收费细目id And
          (a.相关id Is Null And a.执行标记 In (1, 2) And b.费用性质 = 1 Or
          a.标本部位 = b.检查部位 And a.检查方法 = b.检查方法 And Nvl(b.费用性质, 0) = 0 Or
          a.检查方法 Is Null And Nvl(b.费用性质, 0) = 0 And b.检查部位 Is Null And b.检查方法 Is Null) And
          a.诊疗类别 Not In ('5', '6', '7') And Nvl(a.计价特性, 0) = 0 And Nvl(a.执行性质, 0) Not In (0, 5) And c.服务对象 In (2, 3) And
          (c.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD') Or c.撤档时间 Is Null) And Sysdate Between d.执行日期 And
          Nvl(d.终止日期, To_Date('3000-01-01', 'YYYY-MM-DD')) And Nvl(b.收费数量, 0) <> 0 And
          Not (Nvl(c.是否变价, 0) = 1 And Nvl(Nvl(d.缺省价格, d.原价), 0) = 0) And a.诊疗项目id = e.Id And
          (a.Id = 医嘱id_In Or a.相关id = 医嘱id_In)
    Group By a.Id, b.收费项目id, b.收费数量, b.从属项目, b.费用性质, b.收费方式, c.类别, a.诊疗类别, e.操作类型, e.试管编码;

  Cursor c_Pati(v_病人id 病人信息.病人id%Type) Is
    Select * From 病人信息 Where 病人id = v_病人id;
  r_Pati c_Pati%RowType;

  v_材料id 采血管类型.材料id%Type;

  --其它临时变量
  v_Count    Number;
  v_Date     Date;
  v_Temp     Varchar2(255);
  v_人员编号 人员表.编号%Type;
  v_人员姓名 人员表.姓名%Type;
  v_叮嘱执行 Varchar2(5);

  v_Error Varchar2(255);
  Err_Custom Exception;

  Function Getadvicetext(v_医嘱id 病人医嘱记录.Id%Type) Return Varchar2 Is
    v_Text 病人医嘱记录.医嘱内容%Type;
    v_类别 病人医嘱记录.诊疗类别%Type;
    v_配方 Number;
  Begin
    Select 诊疗类别, 医嘱内容 Into v_类别, v_Text From 病人医嘱记录 Where ID = v_医嘱id;
    If v_类别 = 'E' Then
      --西药，中成药的医嘱内容
      Begin
        Select 诊疗类别, Decode(诊疗类别, '7', v_Text, 医嘱内容)
        Into v_类别, v_Text
        From 病人医嘱记录
        Where 相关id = v_医嘱id And 诊疗类别 In ('5', '6', '7') And Rownum = 1;
      Exception
        When Others Then
          Null;
      End;
      If v_类别 = '7' Then
        v_配方 := 1;
      End If;
    End If;
    If Length(v_Text) > 30 Then
      v_Text := Substr(v_Text, 1, 30) || '...';
    End If;
    If Length(v_Text) > 20 Then
      v_Text := '"' || v_Text || '"' || Chr(13) || Chr(10);
    Else
      v_Text := '"' || v_Text || '"';
    End If;
    If v_配方 = 1 Then
      v_Text := '中药配方' || v_Text;
    End If;
    Return(v_Text);
  End;
Begin
  --检查医嘱状态是否正确:并发操作
  Begin
    Select a.医嘱期效, a.医嘱状态, a.开嘱时间, a.开嘱医生, a.开始执行时间, a.病人id, a.主页id, a.婴儿, a.医嘱内容, a.诊疗类别, a.诊疗项目id, a.前提id,
           Nvl(b.操作类型, '0'), Nvl(a.执行标记, 0), a.执行科室id, a.标本部位, a.开嘱科室id, Nvl(a.紧急标志, 0) As 紧急标志
    Into v_期效, v_状态, v_开嘱时间, v_开嘱医生, v_开始时间, v_病人id, v_主页id, v_婴儿, v_医嘱内容, v_诊疗类别, v_诊疗项目id, v_前提id, v_操作类型, v_执行标记,
         v_执行科室id, v_标本部位, v_开嘱科室id, v_紧急标志
    From 病人医嘱记录 A, 诊疗项目目录 B
    Where a.诊疗项目id = b.Id(+) And a.Id = 医嘱id_In;
  Exception
    When Others Then
      Begin
        v_Error := '医嘱已被删除，不能进行校对。' || Chr(13) || Chr(10) || '这可能是并发操作引起的，请重新读取校对数据。';
        Raise Err_Custom;
      End;
  End;
  If v_状态 <> 1 Then
    v_Error := '医嘱"' || Getadvicetext(医嘱id_In) || '"不是新开的医嘱，不能通过校对。' || Chr(13) || Chr(10) || '这可能是并发操作引起的，请重新读取校对数据。';
    Raise Err_Custom;
  End If;
  --再次检查校对时间的有效性:并发操作
  If To_Char(v_开嘱时间, 'YYYY-MM-DD HH24:MI') <= To_Char(v_开始时间, 'YYYY-MM-DD HH24:MI') Then
    If To_Char(校对时间_In, 'YYYY-MM-DD HH24:MI') < To_Char(v_开嘱时间, 'YYYY-MM-DD HH24:MI') Then
      v_Error := '医嘱"' || Getadvicetext(医嘱id_In) || '"的校对时间不能小于开嘱时间 ' || To_Char(v_开嘱时间, 'YYYY-MM-DD HH24:MI') || '。' ||
                 Chr(13) || Chr(10) || '这可能是并发操作引起的，请重新读取校对数据。';
      Raise Err_Custom;
    End If;
  Else
    If To_Char(校对时间_In, 'YYYY-MM-DD HH24:MI') < To_Char(v_开始时间, 'YYYY-MM-DD HH24:MI') Then
      v_Error := '医嘱"' || Getadvicetext(医嘱id_In) || '"的校对时间不能小于开始执行时间 ' || To_Char(v_开始时间, 'YYYY-MM-DD HH24:MI') || '。' ||
                 Chr(13) || Chr(10) || '这可能是并发操作引起的，请重新读取校对数据。';
      Raise Err_Custom;
    End If;
  End If;

  --如果要求签名，检查校对时是否有签名(并发取消签名)
  If 状态_In = 3 Then
    Select Zl_Fun_Getsignpar(Decode(v_前提id, Null, 1, 3), v_开嘱科室id) Into v_Count From Dual;
    If v_Count = 1 Then
      --证书停用或未注册证书不进入签名环节只判断一条数据即可
      For C In (Select a.是否停用
                From 人员证书记录 A, 人员表 B
                Where a.人员id = b.Id And b.姓名 = v_开嘱医生
                Order By a.注册时间 Desc) Loop
        If Nvl(c.是否停用, 0) = 0 Then
          Select Count(*)
          Into v_Count
          From 病人医嘱状态 A
          Where 操作类型 = 1 And 医嘱id = 医嘱id_In And
                (签名id Is Null And Exists
                 (Select 1
                  From 人员表 R, 人员性质说明 X
                  Where r.Id = x.人员id And r.姓名 = a.操作人员 And x.人员性质 = '护士') And Not Exists
                 (Select 1
                  From 人员表 R, 人员性质说明 Y
                  Where r.Id = y.人员id And r.姓名 = a.操作人员 And y.人员性质 = '医生') Or 签名id Is Not Null Or a.操作人员 <> v_开嘱医生);
          If Nvl(v_Count, 0) = 0 Then
            v_Error := '医嘱"' || Getadvicetext(医嘱id_In) || '"还没有电子签名，不能通过校对。';
            Raise Err_Custom;
          End If;
        End If;
        Exit;
      End Loop;
    End If;
  End If;

  --当前操作人员
  If 操作员编号_In Is Not Null And 操作员姓名_In Is Not Null Then
    v_人员编号 := 操作员编号_In;
    v_人员姓名 := 操作员姓名_In;
  Else
    v_Temp     := Zl_Identity;
    v_Temp     := Substr(v_Temp, Instr(v_Temp, ';') + 1);
    v_Temp     := Substr(v_Temp, Instr(v_Temp, ',') + 1);
    v_人员编号 := Substr(v_Temp, 1, Instr(v_Temp, ',') - 1);
    v_人员姓名 := Substr(v_Temp, Instr(v_Temp, ',') + 1);
  End If;

  --因为可能同时：新开->自动校对->互斥自动停止,因此分别-2,-1秒
  Select Sysdate - 1 / 60 / 60 / 24 Into v_Date From Dual;

  Update 病人医嘱记录
  Set 医嘱状态 = 状态_In, 校对护士 = v_人员姓名, 校对时间 = 校对时间_In
  Where ID = 医嘱id_In Or 相关id = 医嘱id_In;

  Insert Into 病人医嘱状态
    (医嘱id, 操作类型, 操作人员, 操作时间, 操作说明)
    Select ID, 状态_In, v_人员姓名, v_Date, 校对说明_In From 病人医嘱记录 Where ID = 医嘱id_In Or 相关id = 医嘱id_In;

  --校对通过时的其它处理
  If 状态_In = 3 Then
    --自动校对时，自动填写缺省的计价内容
    If Nvl(自动校对_In, 0) = 1 Then
      --1.变价的计价项目,如果最低限价不为0,则缺省为最低限价,否则不加入;可再手工计价.
      --2.对于非药嘱药品和在用卫材未定执行科室,发送时会取缺省的,可再手工设置。
      For r_Price In c_Price Loop
        --取(检验)医嘱的管码和材料,采集方式以检验项目的为准
        v_材料id := Null;
        If r_Price.诊疗类别 = 'E' And r_Price.操作类型 = '6' Then
          Begin
            Select c.材料id
            Into v_材料id
            From 病人医嘱记录 A, 诊疗项目目录 B, 采血管类型 C
            Where a.诊疗项目id = b.Id And b.试管编码 = c.编码 And a.相关id = r_Price.Id And Rownum = 1;
          Exception
            When Others Then
              Null;
          End;
        Elsif r_Price.诊疗类别 = 'C' And r_Price.试管编码 Is Not Null Then
          Begin
            Select 材料id Into v_材料id From 采血管类型 Where 编码 = r_Price.试管编码;
          Exception
            When Others Then
              Null;
          End;
        End If;
      
        --判断处理检验试管费用的收取
        If (Nvl(r_Price.收费方式, 0) = 1 And r_Price.收费类别 = '4' And r_Price.收费项目id = Nvl(v_材料id, 0) Or
           Not (Nvl(r_Price.收费方式, 0) = 1 And r_Price.收费类别 = '4' And Nvl(v_材料id, 0) <> 0)) Then
          Insert Into 病人医嘱计价
            (医嘱id, 收费细目id, 数量, 单价, 从项, 执行科室id, 费用性质, 收费方式)
          Values
            (r_Price.Id, r_Price.收费项目id, r_Price.收费数量, r_Price.单价, r_Price.从属项目, Null, r_Price.费用性质, r_Price.收费方式);
        End If;
      End Loop;
    End If;
  
    --自由录入的临嘱医嘱标记为停止
    If Nvl(v_期效, 0) = 1 And v_诊疗项目id Is Null Then
      Update 病人医嘱记录
      Set 医嘱状态 = 8, 停嘱时间 = 校对时间_In, 停嘱医生 = v_开嘱医生
      Where ID = 医嘱id_In Or 相关id = 医嘱id_In;
    
      Insert Into 病人医嘱状态
        (医嘱id, 操作类型, 操作人员, 操作时间)
        Select ID, 8, v_人员姓名, Sysdate From 病人医嘱记录 Where ID = 医嘱id_In Or 相关id = 医嘱id_In;
      End If;  
      
    --判断是否开启叮嘱需要执行
    v_叮嘱执行:= zl_GetSysParameter(288);
    if v_叮嘱执行=1 and v_诊疗项目id Is Null then
        Insert Into 病人医嘱发送
          (医嘱id, 发送号, 记录性质, NO, 记录序号, 发送数次, 发送人, 发送时间, 执行状态, 执行部门id, 计费状态, 首次时间, 末次时间)
        Values
          (医嘱id_In, NextNO('10','0','','1'), '2',NextNO('14','0','','1'), '1', '1', v_人员姓名, 校对时间_In, '0', v_执行科室id,'0',
           Nvl(校对时间_In, sysdate), Nvl(校对时间_In, sysdate));     
     End If;

    --将同一自动停止互斥组中的病人其它医嘱停止(如果尚未停止)
    For r_Exclude In c_Exclude Loop
      Select Decode(Sign(r_Exclude.开始执行时间 - v_开始时间), 1, r_Exclude.开始执行时间, v_开始时间)
      Into v_终止时间
      From Dual;
      Select Decode(Sign(r_Exclude.执行终止时间 - v_开始时间), -1, r_Exclude.执行终止时间, v_开始时间)
      Into v_终止时间
      From Dual;
      Zl_病人医嘱记录_停止(r_Exclude.医嘱id, v_终止时间, v_开嘱医生, 1);
      v_Stopadviceids := v_Stopadviceids || ',' || r_Exclude.医嘱id;
    End Loop;
  
    --对一些特殊医嘱的处理
    If v_诊疗类别 = 'H' And v_操作类型 = '1' And Nvl(v_期效, 0) = 0 Then
      --校对护理等级时,同步更改病人护理等级
      If Nvl(v_婴儿, 0) = 0 Then
        --病人当前应处于正常住院状态
        v_Temp := Null;
        Begin
          Select Decode(状态, 1, '等待入科', 2, '正在转科', 3, '已预出院', Null)
          Into v_Temp
          From 病案主页
          Where 病人id = v_病人id And 主页id = v_主页id;
        Exception
          When Others Then
            Null;
        End;
        If v_Temp Is Not Null Then
          v_Error := '病人当前处于' || v_Temp || '状态,医嘱"' || v_医嘱内容 || '"不能通过校对。';
          Raise Err_Custom;
        End If;
      
        Begin
          --根据收费对照处理，当前医嘱计价表还没有填写
          --未设置时,不处理；相同时,不处理；有多个时,只取一个。
          Select a.收费项目id
          Into v_护理等级id
          From 诊疗收费关系 A, 收费项目目录 B
          Where a.收费项目id = b.Id And b.类别 = 'H' And Nvl(b.项目特性, 0) <> 0 And a.诊疗项目id = v_诊疗项目id And Rownum = 1 And
                Not Exists
           (Select 1 From 病案主页 Where 病人id = v_病人id And 主页id = v_主页id And 护理等级id = a.收费项目id);
        Exception
          When Others Then
            Null;
        End;
      End If;
    
      --变动记录的时间加上秒，以便回退操作时区分同一分种的校对、停止等操作
      v_开始时间 := To_Date(To_Char(v_开始时间, 'yyyy-mm-dd hh24:mi') || To_Char(Sysdate, 'ss'), 'yyyy-mm-dd hh24:mi:ss');
      If v_护理等级id Is Not Null Then
        Zl_病人变动记录_Nurse(v_病人id, v_主页id, v_护理等级id, v_开始时间, v_人员编号, v_人员姓名);
      End If;
    
      --并停止其它护理等级医嘱(护理等级应该都为"持续性"长嘱,且只有一个未停)
      For r_Nurse In c_Nurse Loop
        Select Decode(Sign(r_Nurse.开始执行时间 - v_开始时间), 1, r_Nurse.开始执行时间, v_开始时间)
        Into v_终止时间
        From Dual;
        Select Decode(Sign(r_Nurse.执行终止时间 - v_开始时间), -1, r_Nurse.执行终止时间, v_开始时间)
        Into v_终止时间
        From Dual;
        Zl_病人医嘱记录_停止(r_Nurse.医嘱id, v_终止时间, v_开嘱医生, 1);
        v_Stopadviceids := v_Stopadviceids || ',' || r_Nurse.医嘱id;
      End Loop;
    Elsif v_诊疗类别 = 'Z' And v_操作类型 In ('9', '10') And Nvl(v_期效, 0) = 0 And Nvl(v_婴儿, 0) = 0 Then
      --病重病危医嘱：9-病重;10-病危
      --停止相同医嘱
      For r_Patistate In c_Patistate Loop
        Select Decode(Sign(r_Patistate.开始执行时间 - v_开始时间), 1, r_Patistate.开始执行时间, v_开始时间)
        Into v_终止时间
        From Dual;
        Select Decode(Sign(r_Patistate.执行终止时间 - v_开始时间), -1, r_Patistate.执行终止时间, v_开始时间)
        Into v_终止时间
        From Dual;
        Zl_病人医嘱记录_停止(r_Patistate.医嘱id, v_终止时间, v_开嘱医生, 1);
        v_Stopadviceids := v_Stopadviceids || ',' || r_Patistate.医嘱id;
      End Loop;
    
      --产生病情变动
      Open c_Oldinfo; --必须在处理之前先打开
      Fetch c_Oldinfo
        Into r_Oldinfo;
      Open c_Endinfo;
      Fetch c_Endinfo
        Into r_Endinfo;
      If c_Endinfo%RowCount = 0 Then
        Close c_Endinfo;
        v_Error := '未发现该病人当前有效的变动记录！';
        Raise Err_Custom;
      End If;
      Select Count(*)
      Into v_Count
      From 病人变动记录
      Where 病人id = v_病人id And 主页id = v_主页id And 开始时间 Is Null And 终止时间 Is Null;
      If v_Count > 0 Then
        v_Error := '病人当前处于转科状态，请先办理转科确认或者取消转科状态。';
        Raise Err_Custom;
      End If;
    
      Update 病案主页
      Set 当前病况 = Decode(v_操作类型, '9', '重', '10', '危')
      Where 病人id = v_病人id And 主页id = v_主页id;
    
      --取消上次变动
      If r_Oldinfo.终止时间 Is Not Null Then
        v_变动终止时间 := r_Oldinfo.终止时间;
        v_变动终止原因 := r_Oldinfo.终止原因;
        v_变动终止人员 := r_Oldinfo.终止人员;
        --取消上次变动
        Update 病人变动记录
        Set 终止时间 = v_开始时间, 终止原因 = 13, 终止人员 = v_人员姓名, 上次计算时间 = Null
        Where 病人id = v_病人id And 主页id = v_主页id And 终止时间 = v_变动终止时间 And 终止原因 = v_变动终止原因;
        --更新将来的记录如果有停止到将来的则删除上次计算时间
        Update 病人变动记录
        Set 病情 = Decode(v_操作类型, '9', '重', '10', '危'), 上次计算时间 = Null
        Where 病人id = v_病人id And 主页id = v_主页id And 开始时间 > v_开始时间;
      Else
        Update 病人变动记录
        Set 终止时间 = v_开始时间, 终止原因 = 13, 终止人员 = v_人员姓名,
            上次计算时间 = Decode(Sign(Nvl(上次计算时间, v_开始时间) - v_开始时间), 1, Null, 上次计算时间)
        Where 病人id = v_病人id And 主页id = v_主页id And 终止时间 Is Null;
      End If;
    
      While c_Oldinfo%Found Loop
        Insert Into 病人变动记录
          (ID, 病人id, 主页id, 开始时间, 开始原因, 附加床位, 病区id, 科室id, 护理等级id, 床位等级id, 床号, 责任护士, 经治医师, 主治医师, 主任医师, 病情, 操作员编号, 操作员姓名,
           终止时间, 终止原因, 终止人员)
        Values
          (病人变动记录_Id.Nextval, v_病人id, v_主页id, v_开始时间, 13, r_Oldinfo.附加床位, r_Oldinfo.病区id, r_Oldinfo.科室id,
           r_Oldinfo.护理等级id, r_Oldinfo.床位等级id, r_Oldinfo.床号, r_Oldinfo.责任护士, r_Oldinfo.经治医师, r_Oldinfo.主治医师,
           r_Oldinfo.主任医师, Decode(v_操作类型, '9', '重', '10', '危'), v_人员编号, v_人员姓名, v_变动终止时间, v_变动终止原因, v_变动终止人员);
      
        Fetch c_Oldinfo
          Into r_Oldinfo;
      End Loop;
    
      Close c_Oldinfo;
      Close c_Endinfo;
    Elsif v_诊疗类别 = 'Z' And v_操作类型 = '12' And Nvl(v_期效, 0) = 0 And Nvl(v_婴儿, 0) = 0 Then
      --记录入出量的医嘱，互斥
      For r_Patiio In c_Patiio Loop
        Select Decode(Sign(r_Patiio.开始执行时间 - v_开始时间), 1, r_Patiio.开始执行时间, v_开始时间)
        Into v_终止时间
        From Dual;
        Select Decode(Sign(r_Patiio.执行终止时间 - v_开始时间), -1, r_Patiio.执行终止时间, v_开始时间)
        Into v_终止时间
        From Dual;
        Zl_病人医嘱记录_停止(r_Patiio.医嘱id, v_终止时间, v_开嘱医生, 1);
        v_Stopadviceids := v_Stopadviceids || ',' || r_Patiio.医嘱id;
      End Loop;
    Elsif (v_诊疗类别 = 'Z' And v_操作类型 In ('3', '4', '5', '6', '11', '14') And
          (v_操作类型 <> '14' Or v_操作类型 = '14' And v_执行标记 = 1)) Or (v_诊疗类别 = 'F' And v_执行标记 = 1) Then
      v_Count := 0;
      If v_操作类型 = '4' Or v_操作类型 = '14' Or v_诊疗类别 = 'F' Then
        --保持与以前校对时相同的处理
        If Nvl(v_婴儿, 0) = 0 Then
          v_Count := 1;
        End If;
      Else
        --这几个特殊医嘱在校对中停止医嘱是新加的内容，保持与发送中相同的处理
        v_Count := 1;
        If Nvl(v_婴儿, 0) = 0 Then
          v_婴儿 := -1;
        Else
          v_婴儿 := Nvl(v_婴儿, 0);
        End If;
      End If;
      If v_Count = 1 Then
        If v_诊疗类别 = 'F' And v_执行标记 = 1 Then
          --在手术当天(取整)停止
          v_开始时间 := Trunc(To_Date(v_标本部位, 'yyyy-mm-dd hh24:mi:ss'));
        End If;
      
        --几个特殊医嘱校对时停止前面的长嘱,在医嘱开始时终止：3-转科;4-术后;5-出院;6-转院,11-死亡,14-术前
        For r_Needstop In c_Needstop(v_病人id, v_主页id, v_婴儿, v_开始时间) Loop
          Select Decode(Sign(开始执行时间 - v_开始时间), 1, 开始执行时间, v_开始时间)
          Into v_停止时间
          From 病人医嘱记录
          Where ID = r_Needstop.Id;
          Update 病人医嘱记录
          Set 医嘱状态 = 8, 执行终止时间 = v_停止时间, 停嘱时间 = 校对时间_In, 停嘱医生 = v_开嘱医生
          Where ID = r_Needstop.Id;
        
          Insert Into 病人医嘱状态
            (医嘱id, 操作类型, 操作人员, 操作时间)
            Select ID, 8, v_人员姓名, 校对时间_In From 病人医嘱记录 Where ID = r_Needstop.Id;
          v_Stopadviceids := v_Stopadviceids || ',' || r_Needstop.Id;
        End Loop;
        --已停止未确认的长嘱,终止时间在医嘱开始后的,调前其终止时间(同时多个特殊医嘱的情况)
        For r_Havestop In c_Havestop(v_病人id, v_主页id, v_婴儿, v_开始时间) Loop
          Update 病人医嘱记录
          Set 执行终止时间 = Decode(Sign(开始执行时间 - v_开始时间), 1, 开始执行时间, v_开始时间), 停嘱时间 = 校对时间_In, 停嘱医生 = v_开嘱医生
          Where ID = r_Havestop.Id;
        
          --不修改停止医嘱的操作人员，因为停止时，医生可能已进行电子签名
          Update 病人医嘱状态 Set 操作时间 = 校对时间_In Where 医嘱id = r_Havestop.Id And 操作类型 = 8;
          v_Stopadviceids := v_Stopadviceids || ',' || r_Havestop.Id;
        End Loop;
        --处理长期备用医嘱(没有执行（发送）过的标记未用）
        Update 病人医嘱记录
        Set 执行标记 = -1
        Where 病人id = v_病人id And 主页id = v_主页id And 医嘱期效 = 0 And 执行频次 = '必要时' And 上次执行时间 Is Null And 医嘱状态 In (3, 5, 6, 7) And
              执行标记 <> -1;
        --如果是转院转科死亡出院医嘱同时处理临时备用医嘱。
        If v_操作类型 In ('3', '5', '6', '11') Then
          Update 病人医嘱记录
          Set 执行标记 = -1
          Where 病人id = v_病人id And 主页id = v_主页id And 医嘱期效 = 1 And 执行频次 = '需要时' And 医嘱状态 = 3 And 执行标记 <> -1;
        End If;
      End If;
    Elsif v_诊疗类别 = 'Z' And v_操作类型 = '2' Then
      --对留观病人下达入院通知;
      --预约登记的条件：1.当前无预约,2.当前是门诊留观病人（在院时也允许，因为需要先预约,入院接收时检查了必须出院后才能接收）
      Select Count(*) Into v_Count From 病案主页 Where 病人id = v_病人id And Nvl(主页id, 0) = 0;
      If v_Count = 0 Then
        Select Count(*) Into v_Count From 病案主页 Where 病人id = v_病人id And 主页id = v_主页id And 病人性质 <> 1;
      End If;
      If v_Count = 0 Then
        Open c_Pati(v_病人id);
        Fetch c_Pati
          Into r_Pati;
        Close c_Pati;
      
        v_入院方式 := Null;
        If v_紧急标志 = 1 Then
          v_入院方式 := '急诊';
        End If;
      
        Zl_入院病案主页_Insert(1, 0, r_Pati.病人id, r_Pati.住院号, Null, r_Pati.姓名, r_Pati.性别, r_Pati.年龄, r_Pati.费别, r_Pati.出生日期,
                         r_Pati.国籍, r_Pati.民族, r_Pati.学历, r_Pati.婚姻状况, r_Pati.职业, r_Pati.身份, r_Pati.身份证号, r_Pati.出生地点,
                         r_Pati.家庭地址, r_Pati.家庭地址邮编, r_Pati.家庭电话, r_Pati.户口地址, r_Pati.户口地址邮编, r_Pati.联系人姓名, r_Pati.联系人关系,
                         r_Pati.联系人地址, r_Pati.联系人电话, r_Pati.工作单位, r_Pati.合同单位id, r_Pati.单位电话, r_Pati.单位邮编, r_Pati.单位开户行,
                         r_Pati.单位帐号, r_Pati.担保人, r_Pati.担保额, r_Pati.担保性质, v_执行科室id, Null, Null, v_入院方式, Null, Null,
                         v_开嘱医生, r_Pati.籍贯, r_Pati.区域, v_开始时间, Null, Null, r_Pati.医疗付款方式, Null, Null, Null, Null, Null,
                         Null, r_Pati.险类, v_人员编号, v_人员姓名, 0, Null, Null, 0);
      End If;
    End If;
    --医嘱停止消息的处理
    If v_Stopadviceids Is Not Null Then
      v_Stopadviceids := Substr(v_Stopadviceids, 2);
      Select Max(a.Id)
      Into n_标记
      From 病人医嘱记录 A
      Where a.Id In (Select Column_Value From Table(f_Num2list(v_Stopadviceids))) And a.医嘱期效 = 0 And a.医嘱状态 = 8 And
            Nvl(a.执行标记, 0) <> -1 And a.病人来源 <> 3;
      If n_标记 Is Not Null Then
        Select Max(a.Id)
        Into n_Adviceid
        From 病人医嘱记录 A
        Where a.Id In (Select Column_Value From Table(f_Num2list(v_Stopadviceids))) And a.紧急标志 = 1 And a.医嘱期效 = 0 And
              a.医嘱状态 = 8 And Nvl(a.执行标记, 0) <> -1 And a.病人来源 <> 3;
        If n_Adviceid Is Not Null Then
          n_Adviceid := n_标记;
          Select Nvl(Max(0), 2)
          Into n_标记
          From 业务消息清单 A
          Where a.病人id = v_病人id And a.就诊id = v_主页id And a.类型编码 = 'ZLHIS_CIS_002' And a.优先程度 = 2 And a.是否已阅 = 0;
        Else
          Select Nvl(Max(0), 1)
          Into n_标记
          From 业务消息清单 A
          Where a.病人id = v_病人id And a.就诊id = v_主页id And a.类型编码 = 'ZLHIS_CIS_002' And a.是否已阅 = 0;
        End If;
        If n_标记 > 0 Then
          For R In (Select a.病人性质 As 性质, a.出院科室id As 科室id, a.当前病区id As 病区id
                    From 病案主页 A
                    Where a.病人id = v_病人id And a.主页id = v_主页id) Loop
            Zl_业务消息清单_Insert(v_病人id, v_主页id, r.科室id, r.病区id, r.性质, '有新停止医嘱。', '0010', 'ZLHIS_CIS_002', n_Adviceid, n_标记,
                             0, Null, r.病区id);
          End Loop;
        End If;
      End If;
    End If;
  End If;
Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_病人医嘱记录_校对;
/

--101301:刘鹏飞,2017-10-13,输血申请项目表数据转出处理
Create Or Replace Procedure Zl1_Datamove_Tag
(
  d_End            In Date,
  n_批次           In Number,
  n_System         In Number,
  n_预交剩余款上限 In 病人预交记录.金额%Type := 10 --当病人不存在未结费用，也不是在院病人时，允许未冲完的预交款在指定值以下的数据强制转出，避免大量呆帐未转出从而影响转出速度


) As
  --功能：标记待转出的数据 
  --说明：为避免Undo表空间膨胀过大，分段提交 
  d_Lastend Date; --最终转出截止时间（d_End为本批转出截止时间）

  --递归取消“一张预交款单据中的一部分被标记为待转出”的数据
  Procedure Datamove_Tag_Update
  (
    结帐id_In t_Numlist,
    d_End     In Date,
    n_批次    In Number
  ) As
  
    c_结帐id t_Numlist := t_Numlist();
    c_No     t_Strlist := t_Strlist();
  Begin
    --1.1一张预交单据被多个结帐ID冲了，找出其中的一部分被标记为待转出的数据，如：
    --   NO=A001 记录性质=11 结帐ID=10 待转出=1
    --   NO=A001 记录性质=11 结帐ID=11 待转出=NULL
    If 结帐id_In Is Null Then
      Select Distinct a.No
      Bulk Collect
      Into c_No
      From 病人预交记录 A
      Where a.记录性质 In (1, 11) And a.待转出 = n_批次 And Exists
       (Select 1 From 病人预交记录 Where NO = a.No And 记录性质 In (1, 11) And 待转出 Is Null);
    Else
      Select Distinct a.No
      Bulk Collect
      Into c_No
      From 病人预交记录 A
      Where a.结帐id In (Select /*+cardinality(b,10) */
                        Column_Value
                       From Table(结帐id_In) B) And a.记录性质 In (1, 11) And a.待转出 Is Null And Exists
       (Select 1 From 病人预交记录 Where NO = a.No And 记录性质 In (1, 11) And 待转出 + 0 = n_批次);
    End If;
  
    If c_No.Count = 0 Then
      Return;
    End If;
  
    --1.2取消标记
    Forall I In 1 .. c_No.Count
      Update 病人预交记录 Set 待转出 = Null Where NO = c_No(I) And 记录性质 In (1, 11);
  
    --------------------------------------------------------------------------------------------------------
    --2.1一个结帐ID冲了多张预交单据，找出其中的一部分被标记为待转出的数据，如：
    --   NO=A001 记录性质=11 结帐ID=20 待转出=1
    --   NO=A002 记录性质=11 结帐ID=20 待转出=NULL
    Select Distinct a.结帐id
    Bulk Collect
    Into c_结帐id
    From 病人预交记录 A
    Where a.No In (Select /*+cardinality(b,10) */
                    Column_Value
                   From Table(c_No) B) And a.记录性质 In (1, 11) And a.待转出 Is Null And a.收款时间 + 0 < d_End And Exists
     (Select 1 From 病人预交记录 Where 结帐id = a.结帐id And 待转出 + 0 = n_批次);
  
    If c_结帐id.Count = 0 Then
      Return;
    End If;
  
    --2.2取消标记(包括一次结帐的其他结算方式的记录)
    Forall I In 1 .. c_结帐id.Count
      Update 病人预交记录 Set 待转出 = Null Where 结帐id = c_结帐id(I);
  
    --递归调用
    Datamove_Tag_Update(c_结帐id, d_End, n_批次);
  End Datamove_Tag_Update;
Begin
  Select 本次最终日期 Into d_Lastend From zlDataMove Where 系统 = n_System And 组号 = 1;
  If d_Lastend Is Null Then
    Return;
  End If;
  --新加子查询注意性能优化，把能够将数据过滤到最小的条件放到最后，Exists类条件放前面

  --1.经济核算（费用,药品,收款和票据等）  
  --冲销业务与原始业务的发生时间相同，登记时间不同，所以要按发生时间来查询.
  --以下情况，可能有多个结帐ID，或涉及多个费用单据，这些数据要一起转出或排除转出，否则影响后续判断是否结清
  --1.一张费用单据的一行费用或多行费用可能分多次结帐（有多个不同的结帐ID）
  --2.结帐作废后也可能分多次结清(一张单据多个不同的结帐ID)
  --3.结帐作废后可能与其他费用单据一起结(一张单据的多个结帐ID，涉及多个费用NO，这些NO可能之前结帐作废过，有其他结帐ID)
  --考虑到这情况的复杂性，为简化逻辑，提升查询性能，按病人ID来排除(该病人的结帐数据都不转出)

  Update /*+ rule*/ 病人预交记录 L
  Set 待转出 = n_批次
  Where 结帐id In
        (Select Distinct a.结帐id --1.门诊收费和挂号的收费结算记录
         From 门诊费用记录 A
         Where (a.记录状态 In (1, 2) Or a.记录状态 = 3 And Not Exists
                (Select 1
                 From 门诊费用记录 B
                 Where a.No = b.No And a.记录性质 = b.记录性质 And b.记录状态 = 2 And b.登记时间 >= d_Lastend)) And a.待转出 Is Null And
               a.记录性质 In (1, 4) And a.发生时间 < d_End
         Union All
         Select Distinct b.结算id --2.医保补结算(没有发生时间字段,作废记录的登记时间不同，为了把收费和作废的一次性转出，所以要连接B表)
         From 费用补充记录 A, 费用补充记录 B
         Where a.待转出 Is Null And a.No = b.No And a.记录性质 = b.记录性质 And a.登记时间 < d_End
         Union All
         Select Distinct a.结帐id --3.就诊卡的收费结算记录(排除之后退卡费的,一张单据中只要其中一行退了) 
         From 住院费用记录 A
         Where (a.记录状态 In (1, 2) Or a.记录状态 = 3 And Not Exists
                (Select 1
                 From 住院费用记录 B
                 Where a.No = b.No And a.记录性质 = b.记录性质 And b.记录状态 = 2 And b.登记时间 >= d_Lastend)) And a.待转出 Is Null And
               a.记帐费用 = 0 And a.记录性质 = 5 And a.发生时间 < d_End
         Union All --4.住院记帐费用的结帐结算记录     
         Select 结帐id
         From (With Settle As (Select Distinct c.结帐id
                               From (Select Distinct b.No, b.序号, Mod(b.记录性质, 10) As 记录性质
                                      From (Select Distinct b.Id
                                             From 病人结帐记录 A, 病人结帐记录 B --作废的结帐单的收费时间可能在指定时间之后，所以要连接B表
                                             Where (a.记录状态 In (1, 2) Or a.记录状态 = 3 And Not Exists
                                                    (Select 1
                                                     From 病人结帐记录 C
                                                     Where a.No = c.No And c.记录状态 = 2 And c.收费时间 >= d_Lastend)) And
                                                   a.待转出 Is Null And a.No = b.No And (a.结帐类型 = 2 Or Nvl(a.结帐类型, 0) = 0) And
                                                   a.收费时间 < d_End) A, 住院费用记录 B
                                      Where a.Id = b.结帐id) B, 住院费用记录 C --通过C表找到这些费用单据的所有结帐ID一起转(可能在转出时间之后)
                               Where c.No = b.No And Mod(c.记录性质, 10) = b.记录性质 And c.序号 = b.序号)
                Select 结帐id
                From Settle
                Minus
                Select Distinct a.Id
                From 病人结帐记录 A,
                     (Select Distinct 病人id
                       From (Select c.病人id, c.No, Mod(c.记录性质, 10) As 记录性质, Nvl(Sum(c.实收金额), 0) As 实收金额,
                                     Nvl(Sum(c.结帐金额), 0) As 结帐金额
                              From 住院费用记录 C, Settle S
                              Where c.结帐id = s.结帐id
                              Group By c.No, Mod(c.记录性质, 10), c.病人id) C
                       Where c.实收金额 <> c.结帐金额 And Exists (Select 1 From 在院病人 F Where c.病人id = f.病人id) --出院病人没有结清的也转走（在需要时再抽回），否则排除的数据量太大
                             Or Exists (Select 1
                              From 住院费用记录 E, 病人结帐记录 S
                              Where e.No = c.No And Mod(e.记录性质, 10) = c.记录性质 And e.结帐id = s.Id And
                                    s.待转出 Is Null And s.收费时间 >= d_Lastend)) N --即使是在本批转出时间之后结清，只要不是在最终转出时间之后，就不排除


                Where a.病人id = n.病人id And (a.结帐类型 = 2 Or Nvl(a.结帐类型, 0) = 0))
                Union All --5.门诊记帐费用的结帐结算记录  
                Select 结帐id
                From (With Settle As (Select Distinct c.结帐id
                                      From (Select Distinct b.No, b.序号, Mod(b.记录性质, 10) As 记录性质
                                             From (Select Distinct b.Id
                                                    From 病人结帐记录 A, 病人结帐记录 B
                                                    Where a.待转出 Is Null And a.No = b.No And (a.结帐类型 = 1 Or Nvl(a.结帐类型, 0) = 0) And
                                                          a.收费时间 < d_End) A, 门诊费用记录 B
                                             Where a.Id = b.结帐id) B, 门诊费用记录 C
                                      Where c.No = b.No And Mod(c.记录性质, 10) = b.记录性质 And c.序号 = b.序号)
                       Select 结帐id
                       From Settle
                       Minus
                       Select Distinct a.Id
                       From 病人结帐记录 A,
                            (Select Distinct c.病人id
                              From (Select c.病人id, c.No, Mod(c.记录性质, 10) As 记录性质, Nvl(Sum(c.实收金额), 0) As 实收金额,
                                            Nvl(Sum(c.结帐金额), 0) As 结帐金额
                                     From 门诊费用记录 C, Settle S
                                     Where c.结帐id = s.结帐id
                                     Group By c.No, Mod(c.记录性质, 10), c.病人id) C
                              Where c.实收金额 <> c.结帐金额 --门诊病人没有结清的不转走
                                    Or Exists (Select 1
                                     From 门诊费用记录 E, 病人结帐记录 S
                                     Where e.No = c.No And Mod(e.记录性质, 10) = c.记录性质 And e.结帐id = s.Id And
                                           s.待转出 Is Null And s.收费时间 >= d_Lastend)) N
                       Where a.病人id = n.病人id And (a.结帐类型 = 1 Or Nvl(a.结帐类型, 0) = 0))
         );

  --排除预交款未冲完的
  --为了降低逻辑的复杂性，不排除在转出时间之后发药或未发药的费用记录对应的结帐ID，将这种情况的结算数据和费用数据强制转走 
  --因为前面的SQL查出的结帐ID可能不全是冲预交的(门诊收费和住院结帐补费等)，所以，需要单独一个SQL来排除 
  Update /*+ rule*/ 病人预交记录
  Set 待转出 = Null
  Where 待转出 = n_批次 And
        结帐id In
        (Select Distinct d.结帐id --该单据相关的所有冲预交的结帐ID都不转出
         From 病人预交记录 D,
              (Select Distinct l.No
                From (Select l.No, l.病人id, l.预交类别, Nvl(Sum(l.金额), 0) As 金额, Nvl(Sum(l.冲预交), 0) As 冲预交,
                              Sum(Decode(l.待转出, Null, 1, 0)) As 未转出
                       From 病人预交记录 L --可能按结帐ID确认本次待转出的冲的只是剩余款，所以需要连接L表，查原始交预交的单据，以及记录性质为11的可能还有转出时间之后其他冲剩余款的结帐ID 
                       Where l.记录性质 In (1, 11) And
                             l.No In
                             (Select Distinct p.No From 病人预交记录 P Where p.记录性质 In (1, 11) And p.待转出 = n_批次)
                       Group By l.No, l.病人id, l.预交类别) L --多次住院可以一次结清，所以，不能加主页ID
                Where 未转出 > 0 --只要该预交单据还有未转出的预交或冲预交记录，则不转出，避免转出一部分导致后续判断错误                      
                      Or
                      l.金额 <> l.冲预交 And
                      (Exists (Select 1
                               From 病人预交记录 E --剩的预交款，一般用负数交预交来退款（NO号不同），这种相当于是冲完了，不排除
                               Where e.病人id = l.病人id And e.预交类别 = l.预交类别 And e.记录性质 In (1, 11) And
                                     (e.待转出 = n_批次 Or e.待转出 Is Null And e.结帐id Is Null And e.记录性质 = 1 And 收款时间 < d_End)
                                Having abs(Nvl(Sum(e.金额), 0) - Nvl(Sum(e.冲预交), 0)) > n_预交剩余款上限) --余额小于等于n不排除，与下面第3种结帐ID为空的要保持一致
                       Or l.预交类别 = 2 And Exists (Select 1 From 在院病人 E Where l.病人id = e.病人id) Or Exists
                       (Select 1
                        From 病人未结费用 E
                        Where l.病人id = e.病人id And (l.预交类别 = 1 And e.主页id Is Null Or l.预交类别 = 2 And e.主页id Is Not Null)))) N
         Where d.No = n.No And d.记录性质 In (1, 11));

  --单独处理3种结帐ID为空的预交记录
  --1.预交款没有使用就直接退了的记录(结帐ID为空) 
  Update /*+ rule*/ 病人预交记录
  Set 待转出 = n_批次
  Where 记录性质 = 1 And
        NO In (Select a.No
               From 病人预交记录 A
               Where a.结帐id Is Null And a.记录性质 = 1 And a.记录状态 In (2, 3) And a.待转出 Is Null And a.收款时间 < d_End
               Group By a.No
               Having Sum(a.金额) = 0);

  --2.交预交款后退款的记录（结帐ID为空，记录状态为2）
  Update /*+ rule*/ 病人预交记录
  Set 待转出 = n_批次
  Where 结帐id Is Null And 记录性质 = 1 And 记录状态 = 2 And
        NO In (Select a.No From 病人预交记录 A Where a.记录性质 = 1 And a.记录状态 = 3 And a.待转出 = n_批次);

  --排除同一张预交款单据部分记录被标记为转出的,只要有不转出的，则整张单据都不转出
  --跟第2种有关联影响，所以要放在它之后执行
  --要影响第3种情况的判断，所以要放在它之前执行
  Datamove_Tag_Update(Null, d_End, n_批次);

  --3.预交款未用完时用交负数预交来退款(结帐ID为空，并且跟原始的冲预交的NO没有关联关系)
  --不加条件"金额 < 0"，因为存在预交款没有使用过，就直接用交负数预交来退款的情况
  Update /*+ rule*/ 病人预交记录 L
  Set 待转出 = n_批次
  Where Exists (Select 1
         From 病人预交记录 E
         Where e.病人id = l.病人id And e.预交类别 = l.预交类别 And e.记录性质 In (1, 11) And
               (e.待转出 = n_批次 Or e.待转出 Is Null And e.结帐id Is Null And e.记录性质 = 1 And 记录状态 = 1 And 收款时间 < d_End)
         Group By e.病人id
         Having abs(Nvl(Sum(e.金额), 0) - Nvl(Sum(e.冲预交), 0)) <= n_预交剩余款上限) --余额小于等于n要转出，与前面“排除预交款未冲完的”要保持一致


        And Exists (Select 1
         From 病人预交记录 E
         Where e.病人id = l.病人id And e.预交类别 = l.预交类别 And e.记录性质 In (1, 11) And e.待转出 = n_批次) And
        待转出 Is Null And 结帐id Is Null And 记录性质 = 1 And 记录状态 = 1 And 收款时间 < d_End;

  Update Zldatamovelog
  Set 当前进度 = '(1/10)结算数据标记完成，正在标记费用数据'
  Where 系统 = n_System And 批次 = n_批次;
  Commit;

  Update /*+ rule*/ 病人结帐记录
  Set 待转出 = n_批次
  Where ID In (Select 结帐id From 病人预交记录 Where 待转出 = n_批次);

  --结帐无结算的记录(为了提升性能，不判断费用，只要结了帐且无预交记录就当成是零费用结帐) 
  Update /*+ rule*/ 病人结帐记录 L
  Set 待转出 = n_批次
  Where 收费时间 < d_End And 待转出 Is Null And Not Exists (Select 1 From 病人预交记录 P Where l.Id = p.结帐id);

  Update /*+ rule*/ 病人卡结算对照
  Set 待转出 = n_批次
  Where 预交id In (Select a.Id From 病人预交记录 A Where 待转出 = n_批次);

  Update /*+ rule*/ 病人卡结算记录
  Set 待转出 = n_批次
  Where ID In (Select 卡结算id From 病人卡结算对照 Where 待转出 = n_批次);

  Update /*+ rule*/ 三方结算交易
  Set 待转出 = n_批次
  Where 交易id In (Select a.Id From 病人预交记录 A Where 待转出 = n_批次);

  Update /*+ rule*/ 三方退款信息
  Set 待转出 = n_批次
  Where (记录id, 结帐id) In (Select a.Id, a.结帐id From 病人预交记录 A Where 待转出 = n_批次);

  --1.挂号费用异常数据
  --a.结帐ID为空（实收金额可能不为零）
  --b.结帐ID不为空，打折后实收金额为0（应收金额正负冲销）的挂号费用，没有挂号记录，也没有预交记录
  --按发生时间转出，因为收和退的发生时间相同，登记时间不同。
  Update /*+ rule*/ 门诊费用记录
  Set 待转出 = n_批次
  Where 待转出 Is Null And 发生时间 < d_End And 记录性质 = 4 And (实收金额 = 0 Or 结帐id Is Null);

  --2.直接收费的和结帐无结算（预交）记录的，Union不加all去掉重复以减少in的数量 
  Update /*+ rule*/ 门诊费用记录
  Set 待转出 = n_批次
  Where 结帐id In
        (Select 结帐id From 病人预交记录 Where 待转出 = n_批次 Union Select ID From 病人结帐记录 Where 待转出 = n_批次);

  --3.没有结帐id的数据(按发生时间) 
  --a.未结帐的划价记录
  --b.未收费的零费用
  --加条件"待转出 Is Null"是为了处理连续多次标记转出的情况   
  Update /*+ rule*/ 门诊费用记录 A
  Set 待转出 = n_批次
  Where (记录状态 = 0 Or 记录性质 = 1 And 实收金额 = 0 And 结帐金额 = 0) And 结帐id Is Null And 待转出 Is Null And 发生时间 < d_End;

  --4.没有结帐id的数据(按发生时间) 
  --未结帐的门诊记帐费用(赖账)，该病人没有预交余额，并且病人在最终转出时间之后无未结门诊记帐费用
  Update /*+ rule*/ 门诊费用记录 A
  Set 待转出 = n_批次
  Where Not Exists (Select 1
         From 病人预交记录 B
         Where b.病人id = a.病人id And b.待转出 Is Null And b.预交类别 = 1 And b.记录性质 In (1, 11) Having
          Nvl(Sum(b.金额), 0) <> Nvl(Sum(b.冲预交), 0)) And Not Exists
   (Select 1
         From 门诊费用记录 B
         Where a.病人id = b.病人id And b.记录性质 = 2 And b.结帐id Is Null And b.待转出 Is Null And b.登记时间 > = d_Lastend) And
        记录性质 = 2 And 结帐id Is Null And 待转出 Is Null And 发生时间 < d_End;

  --5.没有结帐id的数据(按发生时间)
  --冲销产生的记帐记录（记录状态为2），登记时间可能在当前指定转出时间之后，而原始记帐记录（记录状态为3），登记时间在指定转出时间之前。前后两者的发生时间是相同的。
  --a.未结帐的零记帐费用或打折后实收金额为零的（结帐模块参数没有勾选对零费用结帐）
  --b.结帐作废后，记帐单销帐的记录（结帐ID为空且记录状态为2的），记录状态为3的且有结帐ID的在最前面已转出. 
  Update /*+ rule*/ 门诊费用记录 A
  Set 待转出 = n_批次
  Where (Exists (Select 1
                 From 门诊费用记录 B
                 Where a.No = b.No And a.记录性质 = b.记录性质 And a.序号 = b.序号 And b.记录状态 = 3 And b.结帐id Is Not Null And
                       b.待转出 + 0 = n_批次) And 记录状态 = 2 Or Exists
         (Select 1
          From 门诊费用记录 B
          Where a.No = b.No And a.记录性质 = b.记录性质 And a.序号 = b.序号 And b.结帐id Is Null
          Group By b.No, b.记录性质, b.序号
          Having Nvl(Sum(b.实收金额), 0) = 0)) And 记录性质 = 2 And 结帐id Is Null And 待转出 Is Null And 发生时间 < d_End;

  --6.有结帐id的零费用(按发生时间)
  --a.按费别打折后结帐金额为零的收费记录,
  --b.一张单据相同结帐ID的结帐金额之和为0(冲销后为零)
  --即使在转出时间之后发药的，也强制转出（为了减少逻辑复杂性，提高查询性能）
  Update /*+ rule*/ 门诊费用记录 A
  Set 待转出 = n_批次
  Where (结帐金额 = 0 Or Exists
         (Select 1 From 门诊费用记录 C Where a.结帐id = c.结帐id Group By c.结帐id, c.No Having Sum(c.结帐金额) = 0)) And Not Exists
   (Select 1 From 病人预交记录 B Where a.结帐id = b.结帐id And b.待转出 Is Null) And 记录性质 = 1 And 结帐id Is Not Null And
        待转出 Is Null And 发生时间 < d_End;

  Update /*+ rule*/ 医保结算明细
  Set 待转出 = n_批次
  Where 结帐id In (Select 结帐id From 病人预交记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 费用补充记录
  Set 待转出 = n_批次
  Where 结算id In (Select 结帐id From 病人预交记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 凭条打印记录
  Set 待转出 = n_批次
  Where (NO, 记录性质) In (Select NO, 记录性质 From 门诊费用记录 Where 待转出 = n_批次);

  --1.从预交记录读是为了取就诊卡直接收费的（无结帐ID）,再加结帐记录是为了取结帐无结算（预交）记录的 
  Update /*+ rule*/ 住院费用记录
  Set 待转出 = n_批次
  Where 结帐id In
        (Select 结帐id From 病人预交记录 Where 待转出 = n_批次 Union Select ID From 病人结帐记录 Where 待转出 = n_批次);

  --2.没有结帐id的数据(按发生时间)
  --冲销产生的记帐记录（记录状态为2），原始记录和冲销记录的发生时间是相同的。
  --1)转出结帐作废后，记帐单销帐的记录（记录状态为2，且没有结帐ID，且(记录状态为3的有结帐ID的)在最前面已转出） 
  --2)未结帐的零费用(已冲销的记帐单或打折后实收金额为零) 
  --3)没有结帐ID的划价记录处理为转出
  Update /*+ rule*/ 住院费用记录 A
  Set 待转出 = n_批次
  Where ((Exists (Select 1
                  From 住院费用记录 B
                  Where a.No = b.No And a.记录性质 = b.记录性质 And a.序号 = b.序号 And b.记录状态 = 3 And b.结帐id Is Not Null And
                        b.待转出 + 0 = n_批次) And 记录状态 = 2 Or Exists
         (Select 1
           From 住院费用记录 B
           Where a.No = b.No And a.记录性质 = b.记录性质 And a.序号 = b.序号 And b.结帐id Is Null
           Group By b.No, b.记录性质, b.序号
           Having Nvl(Sum(b.实收金额), 0) = 0)) And a.记录性质 In (2, 3) Or a.记录状态 = 0) And a.结帐id Is Null And a.待转出 Is Null And
        a.发生时间 < d_End;

  --3.离院未结帐的（赖帐病人），因为是很久以前的这些数据，如果预交已冲完，则处理为要转出 
  Update /*+ rule*/ 住院费用记录 A
  Set 待转出 = n_批次
  Where 待转出 Is Null And 结帐id Is Null And
        (病人id, 主页id) In (Select 病人id, 主页id
                         From 病案主页 C
                         Where 出院日期 < d_End And 待转出 Is Null And 数据转出 Is Null And Not Exists
                          (Select 1
                                From 病人预交记录 B
                                Where b.病人id = c.病人id And b.待转出 Is Null And b.预交类别 = 2 And b.记录性质 In (1, 11) Having
                                 Nvl(Sum(b.金额), 0) <> Nvl(Sum(b.冲预交), 0)));

  Update Zldatamovelog
  Set 当前进度 = '(2/10)费用数据标记完成，正在标记药品数据'
  Where 系统 = n_System And 批次 = n_批次;
  Commit;

  Update /*+ Rule*/ 药品收发记录 A
  Set 待转出 = n_批次
  Where Rowid In (Select m.Rowid
                  From 药品收发记录 M, 门诊费用记录 E
                  Where m.费用id = e.Id And (e.记录性质 = 1 And m.单据 In (8, 24) Or e.记录性质 = 2 And m.单据 In (9, 25)) And
                        e.收费类别 In ('4', '5', '6', '7') And e.待转出 = n_批次
                  Union All
                  Select m.Rowid
                  From 药品收发记录 M, 住院费用记录 E
                  Where m.费用id = e.Id And m.单据 In (9, 10, 25, 26) And e.记录性质 = 2 And e.收费类别 In ('4', '5', '6', '7') And
                        e.待转出 = n_批次);

  Update /*+ rule*/ 收发记录补充信息
  Set 待转出 = n_批次
  Where 收发id In (Select ID From 药品收发记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 输液配药内容
  Set 待转出 = n_批次
  Where 收发id In (Select ID From 药品收发记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 输液配药记录
  Set 待转出 = n_批次
  Where ID In (Select 记录id From 输液配药内容 Where 待转出 = n_批次);

  Update /*+ rule*/ 输液配药附费
  Set 待转出 = n_批次
  Where 配药id In (Select ID From 输液配药记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 输液配药状态
  Set 待转出 = n_批次
  Where 配药id In (Select ID From 输液配药记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 药品留存计划
  Set 待转出 = n_批次
  Where 留存id In (Select ID From 药品收发记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 药品签名明细
  Set 待转出 = n_批次
  Where 收发id In (Select ID From 药品收发记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 药品签名记录
  Set 待转出 = n_批次
  Where ID In (Select 签名id From 药品签名明细 Where 待转出 = n_批次);

  Update /*+ rule*/ 药品收发门诊标志 A
  Set 待转出 = n_批次
  Where (a.处方号, a.单据) In (Select b.No, b.单据 From 药品收发记录 B Where b.待转出 = n_批次);

  Update /*+ rule*/ 药品收发住院标志
  Set 待转出 = n_批次
  Where 收发id In (Select ID From 药品收发记录 Where 待转出 = n_批次);

  Update Zldatamovelog
  Set 当前进度 = '(3/10)药品数据标记完成，正在标记缴款与票据数据'
  Where 系统 = n_System And 批次 = n_批次;
  Commit;

  Update /*+ rule*/ 人员借款记录 Set 待转出 = n_批次 Where 待转出 Is Null And 借出时间 < d_End;

  Update /*+ rule*/ 人员收缴记录 Set 待转出 = n_批次 Where 待转出 Is Null And 登记时间 < d_End;

  Update /*+ rule*/ 人员收缴对照
  Set 待转出 = n_批次
  Where 收缴id In (Select ID From 人员收缴记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 人员收缴明细
  Set 待转出 = n_批次
  Where 收缴id In (Select ID From 人员收缴记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 人员收缴票据
  Set 待转出 = n_批次
  Where 收缴id In (Select ID From 人员收缴记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 人员暂存记录
  Set 待转出 = n_批次
  Where 收缴id In (Select ID From 人员收缴记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 人员暂存记录 Set 待转出 = n_批次 Where 待转出 Is Null And 记录性质 = 1 And 登记时间 < d_End;

  Update /*+ rule*/ 票据领用记录 A
  Set 待转出 = n_批次
  Where Not Exists (Select 1 From 票据使用明细 B Where b.领用id = a.Id And b.使用时间 >= d_Lastend) And 待转出 Is Null And 剩余数量 = 0 And
        登记时间 < d_End;

  Update /*+ rule*/ 票据使用明细
  Set 待转出 = n_批次
  Where 领用id In (Select ID From 票据领用记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 票据打印内容
  Set 待转出 = n_批次
  Where ID In (Select 打印id From 票据使用明细 Where 待转出 = n_批次);

  Update /*+ rule*/ 票据打印明细
  Set 待转出 = n_批次
  Where 使用id In (Select ID From 票据使用明细 Where 待转出 = n_批次);

  Update Zldatamovelog
  Set 当前进度 = '(4/10)缴款与票据数据标记完成，正在标记就诊及诊治数据'
  Where 系统 = n_System And 批次 = n_批次;
  Commit;

  --2.就诊及诊治数据 
  --不转出的条件：挂号费用未转出的，最终转出时间之后存在医嘱（这些医嘱因为时间没有到，不应转出），医嘱对应的费用未转出的 
  --即使正在就诊(r.执行状态 <> 2 )的也强制转出(医生可能没有使用完成就诊功能)
  Update /*+ rule*/ 病人挂号记录 T
  Set 待转出 = n_批次
  Where Rowid In
        (Select Rowid
         From 病人挂号记录 R
         Where Not Exists (Select 1 From 门诊费用记录 A Where r.No = a.No And a.记录性质 = 4 And a.待转出 Is Null) And Not Exists
          (Select 1
                From 病人医嘱记录 A
                Where a.挂号单 = r.No And a.待转出 Is Null And a.病人来源 <> 4 And Nvl(a.停嘱时间, a.开嘱时间) >= d_Lastend) And
               Not Exists (Select 1
                From 门诊费用记录 E, 病人医嘱记录 A
                Where r.No = a.挂号单 And a.Id = e.医嘱序号 And a.病人来源 <> 4 And e.待转出 Is Null) And
               r.待转出 Is Null And r.发生时间 < d_End);

  --由于有一部分挂号数据未转出，所以，汇总表的数据可能与挂号数据不匹配 
  Update 病人挂号汇总 Set 待转出 = n_批次 Where 待转出 Is Null And 日期 < d_End;
  Update /*+ rule*/ 病人转诊记录 Set 待转出 = n_批次 Where NO In (Select NO From 病人挂号记录 Where 待转出 = n_批次);

  --通过"住院费用记录"来查询，而不是"病人结帐记录",因为离院未结的赖帐病人也转出了费用 
  --出院日期条件仍然需要，因为可能某次结帐转出了，但病人在最终转出截止时间之前并未出院(一次住院多次结帐)。 
  --通过指定索引方式进行特殊优化（缺省采用"病案主页IX_出院日期"索引的效率太低） 
  --不加"数据转出 is null"的条件，因为一次住院多次结帐时，如果跨不同的转出批次(转出截止时间)，该字段将会被更新多次。
  Update /*+ rule*/ 病案主页 P
  Set 待转出 = n_批次
  Where Not Exists
   (Select 1 From 住院费用记录 A Where a.病人id = p.病人id And a.主页id = p.主页id And a.待转出 Is Null) And 待转出 Is Null And
        出院日期 < d_Lastend And (病人id, 主页id) In (Select Distinct 病人id, 主页id From 住院费用记录 Where 待转出 = n_批次);

  --已出院，但没有费用的，也标记为转出，以便转出病历数据
  Update /*+ rule*/ 病案主页 P
  Set 待转出 = n_批次
  Where Not Exists (Select 1 From 住院费用记录 A Where a.病人id = p.病人id And a.主页id = p.主页id) And 待转出 Is Null And 数据转出 Is Null And
        出院日期 < d_End;

  Update /*+ rule*/ 病人过敏记录
  Set 待转出 = n_批次
  Where (病人id, 主页id) In (Select 病人id, ID
                         From 病人挂号记录
                         Where 待转出 = n_批次
                         Union All
                         Select 病人id, 主页id
                         From 病案主页
                         Where 待转出 = n_批次);

  Update /*+ rule*/ 病人诊断记录
  Set 待转出 = n_批次
  Where (病人id, 主页id) In (Select 病人id, ID
                         From 病人挂号记录
                         Where 待转出 = n_批次
                         Union All
                         Select 病人id, 主页id
                         From 病案主页
                         Where 待转出 = n_批次);

  Update /*+ rule*/ 病人手麻记录
  Set 待转出 = n_批次
  Where (病人id, 主页id) In (Select 病人id, ID
                         From 病人挂号记录
                         Where 待转出 = n_批次
                         Union All
                         Select 病人id, 主页id
                         From 病案主页
                         Where 待转出 = n_批次);

  Update Zldatamovelog
  Set 当前进度 = '(5/10)就诊及诊治数据标记完成，正在标记护理数据'
  Where 系统 = n_System And 批次 = n_批次;
  Commit;

  --3.护理数据 
  Update /*+ rule*/ 病人护理文件
  Set 待转出 = n_批次
  Where (病人id, 主页id) In (Select 病人id, 主页id From 病案主页 Where 待转出 = n_批次);
  Update /*+ rule*/ 病人护理数据
  Set 待转出 = n_批次
  Where 文件id In (Select ID From 病人护理文件 Where 待转出 = n_批次);
  Update /*+ rule*/ 病人护理明细
  Set 待转出 = n_批次
  Where 记录id In (Select ID From 病人护理数据 Where 待转出 = n_批次);

  Update /*+ rule*/ 病人护理打印
  Set 待转出 = n_批次
  Where 文件id In (Select ID From 病人护理文件 Where 待转出 = n_批次);
  Update /*+ rule*/ 病人护理活动项目
  Set 待转出 = n_批次
  Where 文件id In (Select ID From 病人护理文件 Where 待转出 = n_批次);
  Update /*+ rule*/ 病人护理要素内容
  Set 待转出 = n_批次
  Where 文件id In (Select ID From 病人护理文件 Where 待转出 = n_批次);
  Update /*+ rule*/ 产程要素内容
  Set 待转出 = n_批次
  Where 文件id In (Select ID From 病人护理文件 Where 待转出 = n_批次);

  --老版护理系统数据 
  Update /*+ rule*/ 病人护理记录
  Set 待转出 = n_批次
  Where (病人id, 主页id) In (Select 病人id, 主页id From 病案主页 Where 待转出 = n_批次);
  Update /*+ rule*/ 病人护理内容
  Set 待转出 = n_批次
  Where 记录id In (Select ID From 病人护理记录 Where 待转出 = n_批次);

  Update Zldatamovelog
  Set 当前进度 = '(6/10)护理数据标记完成，正在标记病历数据'
  Where 系统 = n_System And 批次 = n_批次;
  Commit;

  --4.病历数据 
  Update /*+ rule*/ 电子病历记录
  Set 待转出 = n_批次
  Where 病人来源 <> 4 And (病人id, 主页id) In (Select 病人id, ID
                                       From 病人挂号记录
                                       Where 待转出 = n_批次
                                       Union All
                                       Select 病人id, 主页id
                                       From 病案主页
                                       Where 待转出 = n_批次);

  --自登记类病人(无挂号单号) 
  --病历ID可能重复是因为检验报告之类的，如肝功、肾功共打一张报告，即在病人医嘱报告表中，多个医嘱id对应同一报告ID 
  --为提升性能，不从医嘱发送记录的发送时间查询，不采用精确的时间，因为直接登记的检验医嘱，一般开嘱时间与发送时间相差不大
  Update /*+ rule*/ 电子病历记录
  Set 待转出 = n_批次
  Where ID In (Select c.病历id
               From 病人医嘱记录 B, 病人医嘱报告 C
               Where c.医嘱id = b.Id And Nvl(b.主页id, 0) = 0 And b.挂号单 Is Null And b.相关id Is Null And b.待转出 Is Null And
                     b.开嘱时间 < d_End);

  Update /*+ rule*/ 电子病历附件
  Set 待转出 = n_批次
  Where 病历id In (Select ID From 电子病历记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 电子病历格式
  Set 待转出 = n_批次
  Where 文件id In (Select ID From 电子病历记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 电子病历内容
  Set 待转出 = n_批次
  Where 文件id In (Select ID From 电子病历记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 电子病历图形
  Set 待转出 = n_批次
  Where 对象id In (Select ID From 电子病历内容 Where 待转出 = n_批次 And 对象类型 = 5);

  Update /*+ rule*/ 病人医嘱报告
  Set 待转出 = n_批次
  Where 病历id In (Select ID From 电子病历记录 Where 病历种类 = 7 And 待转出 = n_批次);
  Update /*+ rule*/ 影像报告驳回
  Set 待转出 = n_批次
  Where (医嘱id, 病历id) In (Select 医嘱id, 病历id From 病人医嘱报告 Where 待转出 = n_批次);
  Update /*+ rule*/ 医嘱报告内容
  Set 待转出 = n_批次
  Where ID In (Select 报告id From 病人医嘱报告 Where 待转出 = n_批次);

  Update /*+ rule*/ 报告查阅记录
  Set 待转出 = n_批次
  Where 病历id In (Select ID From 电子病历记录 Where 病历种类 = 7 And 待转出 = n_批次);

  Update /*+ rule*/ 疾病申报记录
  Set 待转出 = n_批次
  Where 文件id In (Select ID From 电子病历记录 Where 病历种类 = 5 And 待转出 = n_批次);

  Update /*+ rule*/ 疾病报告反馈
  Set 待转出 = n_批次
  Where 文件id In (Select ID From 电子病历记录 Where 病历种类 = 5 And 待转出 = n_批次);

  Update /*+ rule*/ 疾病申报反馈
  Set 待转出 = n_批次
  Where 申报id In (Select ID From 电子病历记录 Where 病历种类 = 5 And 待转出 = n_批次);

  Update /*+ rule*/ 病人诊断记录
  Set 待转出 = n_批次
  Where 病历id In (Select ID From 电子病历记录 Where 待转出 = n_批次);

  Update Zldatamovelog
  Set 当前进度 = '(7/10)病历数据标记完成，正在标记临床路径数据'
  Where 系统 = n_System And 批次 = n_批次;
  Commit;

  --5.临床路径 
  Update /*+ rule*/ 病人临床路径
  Set 待转出 = n_批次
  Where (病人id, 主页id) In (Select 病人id, 主页id From 病案主页 Where 待转出 = n_批次);
  Update /*+ rule*/ 病人合并路径
  Set 待转出 = n_批次
  Where 首要路径记录id In (Select ID From 病人临床路径 Where 待转出 = n_批次);
  Update /*+ rule*/ 病人合并路径评估
  Set 待转出 = n_批次
  Where 路径记录id In (Select ID From 病人临床路径 Where 待转出 = n_批次);

  Update /*+ rule*/ 病人出径记录
  Set 待转出 = n_批次
  Where 路径记录id In (Select ID From 病人临床路径 Where 待转出 = n_批次);

  Update /*+ rule*/ 病人路径执行
  Set 待转出 = n_批次
  Where 路径记录id In (Select ID From 病人临床路径 Where 待转出 = n_批次);
  Update /*+ rule*/ 病人路径评估
  Set 待转出 = n_批次
  Where 路径记录id In (Select ID From 病人临床路径 Where 待转出 = n_批次);
  Update /*+ rule*/ 病人路径变异
  Set 待转出 = n_批次
  Where 路径记录id In (Select ID From 病人临床路径 Where 待转出 = n_批次);
  Update /*+ rule*/ 病人路径指标
  Set 待转出 = n_批次
  Where 路径记录id In (Select ID From 病人临床路径 Where 待转出 = n_批次);
  Update /*+ rule*/ 病人路径医嘱
  Set 待转出 = n_批次
  Where 路径执行id In (Select ID From 病人路径执行 Where 待转出 = n_批次);

  Update Zldatamovelog
  Set 当前进度 = '(8/10)临床路径数据标记完成，正在标记医嘱数据'
  Where 系统 = n_System And 批次 = n_批次;
  Commit;

  --6.医嘱，检验，检查 
  Update /*+ rule*/ 病人医嘱记录
  Set 待转出 = n_批次
  Where 挂号单 In (Select NO From 病人挂号记录 Where 待转出 = n_批次) And 病人来源 <> 4;
  Update /*+ rule*/ 病人医嘱记录
  Set 待转出 = n_批次
  Where (病人id, 主页id) In (Select 病人id, 主页id From 病案主页 Where 待转出 = n_批次);

  --自登记类病人(无挂号单)，病人医嘱报告在前面转病历时已转出 
  Update /*+ rule*/ 病人医嘱记录
  Set 待转出 = n_批次
  Where Rowid In (Select b.Rowid
                  From 病人医嘱记录 B, 病人医嘱报告 C
                  Where (b.相关id = c.医嘱id Or b.Id = c.医嘱id) And c.待转出 = n_批次);

  --自登记类病人(无挂号单)，没有医嘱报告
  Update /*+ rule*/ 病人医嘱记录 A
  Set 待转出 = n_批次
  Where Not Exists (Select 1 From 病人医嘱报告 B Where a.Id = b.医嘱id) And Not Exists
     (Select 1 From 病人医嘱报告 B Where a.相关id = b.医嘱id) And 挂号单 Is Null And 病人来源 = 3 And 待转出 Is Null And 开嘱时间 < d_End;

  Update /*+ rule*/ 病人医嘱计价
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 病人医嘱附费
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 病人医嘱附件
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 输血申请记录
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 输血检验结果
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 输血申请项目
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 病人医嘱执行
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 病人医嘱打印
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 医嘱执行打印
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 病人诊断医嘱
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 病人诊断记录
  Set 待转出 = n_批次
  Where ID In (Select 诊断id From 病人诊断医嘱 Where 待转出 = n_批次);

  Update /*+ rule*/ 病人医嘱状态
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 医嘱签名记录
  Set 待转出 = n_批次
  Where ID In (Select 签名id From 病人医嘱状态 Where 待转出 = n_批次 And 签名id Is Not Null);

  Update /*+ rule*/ 病人医嘱发送
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 诊疗单据打印
  Set 待转出 = n_批次
  Where (NO, 记录性质) In (Select NO, 记录性质 From 病人医嘱发送 Where 待转出 = n_批次);

  Update /*+ rule*/ 医嘱执行时间
  Set 待转出 = n_批次
  Where (医嘱id, 发送号) In (Select 医嘱id, 发送号 From 病人医嘱发送 Where 待转出 = n_批次);

  Update /*+ rule*/ 医嘱执行计价
  Set 待转出 = n_批次
  Where (医嘱id, 发送号) In (Select 医嘱id, 发送号 From 病人医嘱发送 Where 待转出 = n_批次);

  Update /*+ rule*/ 执行打印记录
  Set 待转出 = n_批次
  Where (医嘱id, 发送号) In (Select 医嘱id, 发送号 From 病人医嘱发送 Where 待转出 = n_批次);

  Update /*+ rule*/ 处方审查明细
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 处方审查记录
  Set 待转出 = n_批次
  Where ID In (Select 审方id From 处方审查明细 Where 待转出 = n_批次);

  Update /*+ rule*/ 处方审查结果
  Set 待转出 = n_批次
  Where 审方id In (Select ID From 处方审查记录 Where 待转出 = n_批次);

  Update /*+ rule*/ Ris检查预约
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 疾病阳性记录
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);

  Update Zldatamovelog
  Set 当前进度 = '(9/10)医嘱数据标记完成，正在标记检查检验数据'
  Where 系统 = n_System And 批次 = n_批次;
  Commit;

  Update /*+ rule*/ 影像检查记录
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 影像报告记录
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 影像报告操作记录
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 影像检查序列
  Set 待转出 = n_批次
  Where 检查uid In (Select 检查uid From 影像检查记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 影像检查图象
  Set 待转出 = n_批次
  Where 序列uid In (Select 序列uid From 影像检查序列 Where 待转出 = n_批次);

  Update /*+ rule*/ 影像申请单图像
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 影像收藏内容
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 影像危急值记录
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);

  Update Zldatamovelog
  Set 当前进度 = '(10/10)影像数据标记完成，正在标记检验数据'
  Where 系统 = n_System And 批次 = n_批次;
  Commit;

  Update /*+ rule*/ 检验标本记录
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 检验申请项目
  Set 待转出 = n_批次
  Where 标本id In (Select ID From 检验标本记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 检验项目分布
  Set 待转出 = n_批次
  Where 标本id In (Select ID From 检验标本记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 检验分析记录
  Set 待转出 = n_批次
  Where 标本id In (Select ID From 检验标本记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 检验质控记录
  Set 待转出 = n_批次
  Where 标本id In (Select ID From 检验标本记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 检验操作记录
  Set 待转出 = n_批次
  Where 标本id In (Select ID From 检验标本记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 检验签名记录
  Set 待转出 = n_批次
  Where 检验标本id In (Select ID From 检验标本记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 检验图像结果
  Set 待转出 = n_批次
  Where 标本id In (Select ID From 检验标本记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 检验试剂记录
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 检验拒收记录
  Set 待转出 = n_批次
  Where 医嘱id In (Select ID From 病人医嘱记录 Where 待转出 = n_批次);

  Update /*+ rule*/ 检验普通结果
  Set 待转出 = n_批次
  Where 检验标本id In (Select ID From 检验标本记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 检验质控报告
  Set 待转出 = n_批次
  Where 结果id In (Select ID From 检验普通结果 Where 待转出 = n_批次);
  Update /*+ rule*/ 检验药敏结果
  Set 待转出 = n_批次
  Where 细菌结果id In (Select ID From 检验普通结果 Where 待转出 = n_批次);
  Update /*+ rule*/ 检验流水线标本
  Set 待转出 = n_批次
  Where 标本id In (Select ID From 检验标本记录 Where 待转出 = n_批次);
  Update /*+ rule*/ 检验流水线指标
  Set 待转出 = n_批次
  Where 标本id In (Select ID From 检验标本记录 Where 待转出 = n_批次);

  Commit;

Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl1_Datamove_Tag;
/

--115464:娄经平,2017-10-25,添加体检健康系统生成检验条码规则
--101301:刘鹏飞,2017-01-14,输血采集方式条码生成处理
Create Or Replace Function Nextno
(
  序号_In     In 号码控制表.项目序号%Type,
  科室id_In   In 部门表.Id%Type := Null,
  v_Tag       In Varchar2 := Null,
  号码个数_In In Integer := 1
) Return Varchar2
--    功能：根据特定规则产生新的号码,规则如下：
  --    一、项目序号：
  --       1   病人ID         数字
  --       2   住院号         数字
  --       3   门诊号         数字
  --       10  医嘱发送号     数字,顺序递增编号
  --       x   其它单据号     字符,根据编号规则顺序递增编号,不自动补缺
  --    二、年度位确定原则：
  --       以1990为基数，随年度增长，按“0～9/A～Z”顺序作为年度编码
  --
  --    说明：最大号码-10存入号码控制表,用于并发情况下补缺号(取了号,但未使用)
  --          For Update在并发情况下锁定行,不用Wait选项以避免向调用者返回空
  --          v_Tag 可用其它未指明的参数,目前 有影像检查类别(编码)
  --    返回：最大号码
 Is
  Pragma Autonomous_Transaction;
  v_No     号码控制表.最大号码%Type;
  v_Maxno  号码控制表.最大号码%Type;
  n_Maxno  Number;
  n_Amt    Number;
  n_Mod    号码控制表.编号规则%Type;
  v_Deptno Varchar2(20);
  v_Year   Varchar2(1);
  v_Tmp    Varchar2(10);

  v_试管编码     Number;
  v_生成条码     Varchar2(20);
  v_编码         Varchar2(10);
  v_医嘱         Varchar2(18);
  v_检验类型名称 诊疗检验类型.名称%Type;
  v_Error        Varchar2(255);
  n_Checkmaxno   Number;

  Err_Custom Exception;
Begin

  --1.病人ID
  If 序号_In = 1 Then
    Select Nvl(编号规则, 0) Into n_Mod From 号码控制表 Where 项目序号 = 序号_In;
  
    --从序列取值，用于不要求病人ID必须连续的用户减少并发争用
    If n_Mod = 1 Then
      Select 病人信息_Id.Nextval Into v_No From Dual;
    Else
      Select Nvl(最大号码, '0') Into v_Maxno From 号码控制表 Where 项目序号 = 序号_In For Update;
    
      Select Nvl(Max(病人id), 0) + 1 Into n_Maxno From 病人信息 Where 病人id >= To_Number(v_Maxno);
    
      Update 号码控制表 Set 最大号码 = Decode(Sign(n_Maxno - 10), 1, n_Maxno - 10, 1) Where 项目序号 = 序号_In;
      v_No := To_Char(n_Maxno);
    End If;
    --2.住院号
  Elsif 序号_In = 2 Then
    Select Nvl(最大号码, '0'), Nvl(编号规则, 0)
    Into v_Maxno, n_Mod
    From 号码控制表
    Where 项目序号 = 序号_In
    For Update;
  
    If n_Mod = 0 Then
      --0.顺序编号
      Select Nvl(Max(住院号), 0) + 1 Into n_Maxno From 病人信息 Where 住院号 >= To_Number(v_Maxno);
    
      Update 号码控制表 Set 最大号码 = Decode(Sign(n_Maxno - 10), 1, n_Maxno - 10, 1) Where 项目序号 = 序号_In;
    Elsif n_Mod = 1 Then
      --1.年月(YYMM)+顺序号(0000)
      v_Tmp := To_Char(Sysdate, 'YYMM');
    
      Select Nvl(Max(住院号), To_Number(v_Tmp || '0000')) + 1
      Into n_Maxno
      From 病人信息
      Where 住院号 Like To_Number(v_Tmp) || '%' And 住院号 >= To_Number(v_Maxno);
      Update 号码控制表
      Set 最大号码 = Decode(Sign(n_Maxno - 10 - To_Number(v_Tmp || '0000')), 1, n_Maxno - 10, To_Number(v_Tmp || '0001'))
      Where 项目序号 = 序号_In;
    
    Elsif n_Mod = 2 Then
      --2.年(YYYY)+顺序号(00000)
      v_Tmp := To_Char(Sysdate, 'YYYY');
    
      Select Nvl(Max(住院号), To_Number(v_Tmp || '00000')) + 1
      Into n_Maxno
      From 病人信息
      Where 住院号 Like To_Number(v_Tmp) || '%' And 住院号 >= To_Number(v_Maxno);
      Update 号码控制表
      Set 最大号码 = Decode(Sign(n_Maxno - 10 - To_Number(v_Tmp || '00000')), 1, n_Maxno - 10, To_Number(v_Tmp || '00001'))
      Where 项目序号 = 序号_In;
    
    End If;
    v_No := To_Char(n_Maxno);
  
    --3.门诊号
  Elsif 序号_In = 3 Then
    Select Nvl(最大号码, '0'), Nvl(编号规则, 0)
    Into v_Maxno, n_Mod
    From 号码控制表
    Where 项目序号 = 序号_In
    For Update;
  
    If n_Mod = 0 Then
      --0.顺序编号
    
      Select Nvl(Max(门诊号), 0) + 1 Into n_Maxno From 病人信息 Where 门诊号 >= To_Number(v_Maxno);
    
      Update 号码控制表 Set 最大号码 = Decode(Sign(n_Maxno - 10), 1, n_Maxno - 10, 1) Where 项目序号 = 序号_In;
    Elsif n_Mod = 1 Then
      --1.日期编号YYMMDD
      v_Tmp := To_Char(Sysdate, 'YYMMDD');
    
      Select Nvl(Max(门诊号), To_Number(v_Tmp || '0000')) + 1
      Into n_Maxno
      From 病人信息
      Where 门诊号 Like To_Number(v_Tmp) || '%' And 门诊号 >= To_Number(v_Maxno);
      Update 号码控制表
      Set 最大号码 = Decode(Sign(n_Maxno - 10 - To_Number(v_Tmp || '0000')), 1, n_Maxno - 10, To_Number(v_Tmp || '0001'))
      Where 项目序号 = 序号_In;
    
    End If;
    v_No := To_Char(n_Maxno);
  
    --10.医嘱发送号
  Elsif 序号_In = 10 Then
    Select Nvl(最大号码, '0') Into v_Maxno From 号码控制表 Where 项目序号 = 序号_In For Update;
    v_Maxno := To_Char(To_Number(v_Maxno) + 1);
    Update 号码控制表 Set 最大号码 = v_Maxno Where 项目序号 = 序号_In;
    v_No := v_Maxno;
  
    --汇总发药号
  Elsif 序号_In = 20 Then
    --YYYYMMDD+5位顺序号(00000)
    Select To_Char(Sysdate, 'yyyymmdd') Into v_Tmp From Dual;
    Select Nvl(最大号码, '0') Into v_Maxno From 号码控制表 Where 项目序号 = 序号_In For Update;
  
    If v_Maxno = '0' Then
      v_Maxno := v_Tmp || '00001';
    Else
      If Substr(v_Maxno, 1, 8) = v_Tmp Then
        If To_Number(Substr(v_Maxno, 9, 5)) = 99999 Then
          v_Maxno := v_Tmp || '00001';
        Else
          v_Maxno := v_Tmp || Trim(To_Char(To_Number(Substr(v_Maxno, 9, 5)) + 1, '00000'));
        End If;
      Else
        v_Maxno := v_Tmp || '00001';
      End If;
    End If;
    Update 号码控制表 Set 最大号码 = v_Maxno Where 项目序号 = 序号_In;
  
    v_No := v_Maxno;
  
  Elsif 序号_In = 123 Then
  
    Select Nvl(Max(参数值), 0) Into n_Mod From 影像流程参数 Where 科室id = 科室id_In And 参数名 = '检查号生成方式';
    Select Nvl(Max(参数值), 1)
    Into n_Checkmaxno
    From 影像流程参数
    Where 科室id = 科室id_In And 参数名 = '提取实际最大号码';
  
    If n_Mod = 1 Then
      --影像检查号按科室递增
      --从号码表提取最大号码
      Select Count(*) Into n_Maxno From 科室号码表 Where 项目序号 = 序号_In And 科室id = 科室id_In;
      If Nvl(n_Maxno, 0) = 0 Then
        --没有记录，则自动增加科室号码表
        Insert Into 科室号码表 (项目序号, 科室id, 编号, 最大号码) Values (序号_In, 科室id_In, 'A', '1');
        Commit;
      End If;
    
      Select Nvl(最大号码, 0) Into n_Maxno From 科室号码表 Where 项目序号 = 序号_In And 科室id = 科室id_In For Update;
    
      --提取实际最大号码,如果有实际最大号码，这个号码会比号码表中的大10
      If n_Checkmaxno = 1 Then
        Select Nvl(Max(检查号), 0) + 1 Into n_Amt From 影像检查记录 Where 执行科室id = 科室id_In And 检查号 >= n_Maxno;
      
        If n_Amt > n_Maxno Then
          n_Maxno := n_Amt;
        End If;
      Else
        -- 如果不提取实际最大号码，加上10
        n_Maxno := n_Maxno + 10 + 1;
      End If;
    
      -- 回填最大号码
      Update 科室号码表
      Set 最大号码 = Decode(Sign(n_Maxno - 10), 1, n_Maxno - 10, 1)
      Where 项目序号 = 序号_In And 科室id = 科室id_In;
    Else
      --影像检查号按类别递增
      Select Nvl(最大号码, 0) Into n_Maxno From 影像检查类别 Where 编码 = v_Tag For Update;
      --提取实际最大号码，如果有实际最大号码，这个号码会比号码表中的大10
      If n_Checkmaxno = 1 Then
        Select Nvl(Max(检查号), 0) + 1 Into n_Amt From 影像检查记录 Where 影像类别 = v_Tag And 检查号 >= n_Maxno;
      
        If n_Amt > n_Maxno Then
          n_Maxno := n_Amt;
        End If;
      Else
        -- 如果不提取实际最大号码，加上10
        n_Maxno := n_Maxno + 10 + 1;
      End If;
    
      -- 回填最大号码
      Update 影像检查类别 Set 最大号码 = Decode(Sign(n_Maxno - 10), 1, n_Maxno - 10, 1) Where 编码 = v_Tag;
    End If;
    v_No := To_Char(n_Maxno);
  
  Elsif 序号_In = 124 Then
    ----------------------------------------------------------------------------------------------------------------------------
    --体检健康号
  
    Begin
      Select Nvl(编号规则, 0) Into n_Mod From 号码控制表 Where 项目序号 = 序号_In;
    Exception
      When Others Then
        v_Error := '号码控制表中不存在序号为' || 序号_In || '的号码';
        Raise Err_Custom;
    End;
  
    If n_Mod = 0 Then
      --顺序编号
      Select Nvl(Zl_To_Number(最大号码), 0) + 号码个数_In
      Into v_Maxno
      From 号码控制表
      Where 项目序号 = 序号_In
      For Update;
      Update 号码控制表 Set 最大号码 = v_Maxno Where 项目序号 = 序号_In;
    Else
      --前缀+顺序号
      Update 号码编号表 Set 最大号码 = 最大号码 Where 项目序号 = 序号_In And 号码前缀 = v_Tag;
      If Sql%Rowcount = 0 Then
        Insert Into 号码编号表
          (项目序号, 号码前缀, 日期, 最大号码)
          Select 序号_In, v_Tag, Sysdate, '' From Dual;
      End If;
    
      Select Nvl(Zl_To_Number(最大号码), 0) + 号码个数_In
      Into n_Maxno
      From 号码编号表 a
      Where a.项目序号 = 序号_In And a.号码前缀 = v_Tag;
    
      If Substr(n_Maxno, 1, Length(v_Tag)) <> v_Tag Then
        --进位了
        Select Nvl(Zl_To_Number(Substr(最大号码, Length(v_Tag) + 1)), 0) + 号码个数_In
        Into n_Maxno
        From 号码编号表 a
        Where a.项目序号 = 序号_In And a.号码前缀 = v_Tag;
        Select v_Tag || n_Maxno Into v_Maxno From Dual;
      Else
        If n_Maxno = 号码个数_In Then
          v_Maxno := v_Tag || To_Char(号码个数_In);
        Else
          v_Maxno := n_Maxno;
        End If;
      End If;
    
      Update 号码编号表 Set 最大号码 = v_Maxno Where 项目序号 = 序号_In And 号码前缀 = v_Tag;
    End If;
    v_No := v_Maxno;
  
  Elsif 序号_In = 125 Then
    --这里是为了减少号码控制表的锁定时间
    Begin
      Select 试管编码, a.诊疗类别 || b.操作类型 诊疗类型
      Into v_试管编码, v_Tmp
      From 病人医嘱记录 a, 诊疗项目目录 b
      Where a.诊疗项目id = b.Id And a.Id = 科室id_In And 试管编码 Is Not Null;
    Exception
      When Others Then
        v_Error := '没有找到检验项目对应的管码！';
        Raise Err_Custom;
    End;
    If n_Mod <> 0 Then
      If v_Tmp = 'E9' Then
        --输血医嘱的采集方式
        v_检验类型名称 := Zl_Getsysparameter(273);
        Select Nvl(Max(编码), '') Into v_编码 From 诊疗检验类型 Where 名称 = v_检验类型名称;
        If v_编码 Is Null Then
          v_Error := '请先在基础参数设置中设置输血采集方式默认诊疗检验类型！';
          Raise Err_Custom;
        End If;
      Else
        Begin
          Select 试管编码, c.编码
          Into v_试管编码, v_编码
          From 病人医嘱记录 a, 诊疗项目目录 b, 诊疗检验类型 c
          Where a.诊疗项目id = b.Id And a.Id = 科室id_In And b.操作类型 = c.名称 And 试管编码 Is Not Null;
        Exception
          When Others Then
            v_Error := '没有找到检验项目对应的管码和编码！';
            Raise Err_Custom;
        End;
      End If;
    End If;
  
    Select Nvl(最大号码, '0'), Nvl(编号规则, 0)
    Into v_Maxno, n_Mod
    From 号码控制表
    Where 项目序号 = 序号_In
    For Update;
  
    If n_Mod = 0 Then
      --按医嘱生成
      v_医嘱 := 科室id_In;
      If Length(v_医嘱) > 12 Then
        v_医嘱 := Substr(v_医嘱, Length(v_医嘱) - 11);
      Else
        v_医嘱 := Lpad(v_医嘱, 12, '0');
      End If;
      If Length(Ltrim(v_医嘱, '0')) > 8 Then
        Select v_试管编码 ||
                Lpad(Substr(v_医嘱, Length(v_医嘱) - (13 - Length(v_试管编码) - 2)), (13 - Length(v_试管编码)), '0')
        Into v_生成条码
        From Dual;
      Else
        Select v_试管编码 ||
                Lpad(Substr(v_医嘱, Length(v_医嘱) - (12 - Length(v_试管编码) - 2)), (12 - Length(v_试管编码)), '0')
        Into v_生成条码
        From Dual;
      End If;
      v_No := v_生成条码;
    Else
      --按"小组编号（1位）+管码(2位)+日期(6位)+顺序号(3)位"生成条码
      Begin
        Select 最大号码
        Into v_Maxno
        From 号码编号表
        Where 项目序号 = 序号_In And 号码前缀 = v_编码 || v_试管编码 And Trunc(日期) = Trunc(Sysdate)
        For Update;
        v_Maxno := v_Maxno + 1;
        If Length(v_Maxno) <= 3 Then
          v_Maxno := Lpad(v_Maxno, 3, '0');
        End If;
        v_No := v_编码 || v_试管编码 || To_Char(Trunc(Sysdate), 'yymmdd') || v_Maxno;
        Update 号码编号表
        Set 日期 = Trunc(Sysdate), 最大号码 = v_Maxno
        Where 号码前缀 = v_编码 || v_试管编码 And Trunc(日期) = Trunc(Sysdate);
      Exception
        When Others Then
          Update 号码编号表 Set 日期 = Trunc(Sysdate), 最大号码 = 1 Where 号码前缀 = v_编码 || v_试管编码;
          If Sql%Rowcount = 0 Then
            Insert Into 号码编号表
              (项目序号, 号码前缀, 日期, 最大号码)
            Values
              (序号_In, v_编码 || v_试管编码, Trunc(Sysdate), 1);
          End If;
          v_No := v_编码 || v_试管编码 || To_Char(Trunc(Sysdate), 'yymmdd') || '001';
      End;
    End If;
    --卫材条码序号
  Elsif 序号_In = 126 Then
    --12位顺序号
    Select Nvl(最大号码, '0') Into v_Maxno From 号码控制表 Where 项目序号 = 序号_In For Update;
  
    If v_Maxno = '0' Then
      v_Maxno := '000000000001';
    Else
      v_Maxno := Trim(To_Char(To_Number(v_Maxno) + 1, '000000000000'));
    End If;
    Update 号码控制表 Set 最大号码 = v_Maxno Where 项目序号 = 序号_In;
  
    v_No := v_Maxno;
  Elsif 序号_In = 135 Then
    --药品卫材调价
    Begin
      Select Nvl(编号规则, 0) Into n_Mod From 号码控制表 Where 项目序号 = 序号_In;
    Exception
      When Others Then
        v_Error := '号码控制表中不存在序号为' || 序号_In || '的号码';
        Raise Err_Custom;
    End;
    --1.年月(YYYYMM)+顺序号(0000)
    v_Tmp := To_Char(Sysdate, 'YYYYMM');
    Select Nvl(最大号码, '0') Into v_Maxno From 号码控制表 Where 项目序号 = 序号_In For Update;
  
    If v_Maxno = '0' Then
      v_Maxno := v_Tmp || '0001';
    Else
      If Substr(v_Maxno, 1, 6) = v_Tmp Then
        v_Maxno := v_Tmp || Trim(To_Char(To_Number(Substr(v_Maxno, 7, 4)) + 1, '0000'));
      Else
        v_Maxno := v_Tmp || '0001';
      End If;
    End If;
    Update 号码控制表 Set 最大号码 = v_Maxno Where 项目序号 = 序号_In;
    v_No := v_Maxno;
  Elsif 序号_In = 136 Then
    --YYMMDD+5位顺序号(00000)
    Select To_Char(Sysdate, 'yymmdd') Into v_Tmp From Dual;
    Select Nvl(最大号码, '0') Into v_Maxno From 号码控制表 Where 项目序号 = 序号_In For Update;
  
    If v_Maxno = '0' Then
      v_Maxno := v_Tmp || '00001';
    Else
      If Substr(v_Maxno, 1, 6) = v_Tmp Then
        If To_Number(Substr(v_Maxno, 7, 5)) = 99999 Then
          v_Maxno := v_Tmp || '00001';
        Else
          v_Maxno := v_Tmp || Trim(To_Char(To_Number(Substr(v_Maxno, 7, 5)) + 1, '00000'));
        End If;
      Else
        v_Maxno := v_Tmp || '00001';
      End If;
    End If;
    Update 号码控制表 Set 最大号码 = v_Maxno Where 项目序号 = 序号_In;
    v_No := v_Maxno;
  Elsif 序号_In = 131 Then
    --体检报到号
    Select Nvl(最大号码, '0') Into v_Maxno From 号码控制表 Where 项目序号 = 序号_In For Update;
    v_Maxno := To_Char(To_Number(v_Maxno) + 1);
    Update 号码控制表 Set 最大号码 = v_Maxno Where 项目序号 = 序号_In;
    v_No := v_Maxno;
  Elsif 序号_In = 149 Then 
    --这里是为了减少号码控制表的锁定时间
    Begin
      v_试管编码:=to_Number(substr(v_Tag,1,instr(v_Tag,'r_List')-1));
    Exception
      When Others Then  v_试管编码:=Null;
    End;
    IF v_试管编码 IS NOT NULL THEN 

      Select Nvl(最大号码, '0'), Nvl(编号规则, 0)
      Into v_Maxno, n_Mod
      From 号码控制表
      Where 项目序号 = 序号_In
      For Update;

      If n_Mod = 0 Then
        --按医嘱生成

        Select 病人医嘱记录_Id.Nextval Into v_医嘱 From Dual;
        If Length(v_医嘱) > 12 Then
          v_医嘱 := Substr(v_医嘱, Length(v_医嘱) - 11);
        Else
          v_医嘱 := Lpad(v_医嘱, 12, '0');
        End If;
        if Length(ltrim(v_医嘱,'0'))>8 then
           Select v_试管编码 || LPad(Substr(v_医嘱, Length(v_医嘱) - (13 - Length(v_试管编码) - 2)), (13 - Length(v_试管编码)), '0')
            Into v_生成条码
           From Dual;
        else
           Select v_试管编码 || LPad(Substr(v_医嘱, Length(v_医嘱) - (12 - Length(v_试管编码) - 2)), (12 - Length(v_试管编码)), '0')
           Into v_生成条码
           From Dual;
        end if;
        v_No := v_生成条码;
      Else
        
	v_编码 := Substr(v_Tag, Instr(v_Tag, 'r_List') + 6);
        If v_编码 Is Not Null Then
          --按"小组编号（1位）+管码(2位)+日期(6位)+顺序号(3)位"生成条码
          Begin
            Select 最大号码
            Into v_Maxno
            From 号码编号表
            Where 项目序号 = 序号_In And 号码前缀 = v_编码 || v_试管编码 And Trunc(日期) = Trunc(Sysdate)
            For Update;
            v_Maxno := v_Maxno + 1;
            If Length(v_Maxno) <= 3 Then
              v_Maxno := Lpad(v_Maxno, 3, '0');
            End If;
            v_No := v_编码 || v_试管编码 || To_Char(Trunc(Sysdate), 'yymmdd') || v_Maxno;
            Update 号码编号表
            Set 日期 = Trunc(Sysdate), 最大号码 = v_Maxno
            Where 号码前缀 = v_编码 || v_试管编码 And Trunc(日期) = Trunc(Sysdate);
          Exception
            When Others Then
              Update 号码编号表 Set 日期 = Trunc(Sysdate), 最大号码 = 1 Where 号码前缀 = v_编码 || v_试管编码;
              If Sql%Rowcount = 0 Then
                Insert Into 号码编号表
                  (项目序号, 号码前缀, 日期, 最大号码)
                Values
                  (序号_In, v_编码 || v_试管编码, Trunc(Sysdate), 1);
              End If;
              v_No := v_编码 || v_试管编码 || To_Char(Trunc(Sysdate), 'yymmdd') || '001';
          End;
        End If;
      End If;
    end if;
    --其它单据号
  Else
    Begin
      Select Nvl(编号规则, 0) Into n_Mod From 号码控制表 Where 项目序号 = 序号_In;
    Exception
      When Others Then
        v_Error := '号码控制表中不存在序号为' || 序号_In || '的号码';
        Raise Err_Custom;
    End;
  
    --如果规则是按科室编号顺序产生，但又未设置科室编码，则采取按年顺序编号
    If n_Mod = 2 And 序号_In <> 122 Then
      Begin
        Select 编号 Into v_Deptno From 科室号码表 Where 科室id = 科室id_In And 项目序号 = 序号_In;
      Exception
        When Others Then
          Null;
      End;
      If v_Deptno Is Null Then
        n_Mod := 0;
      End If;
    End If;
  
    Select Decode(Sign(Intyear - 10), -1, To_Char(Intyear, '9'), Chr(55 + Intyear))
    Into v_Year
    From (Select To_Number(To_Char(Sysdate, 'yyyy'), '9999') - 1990 As Intyear From Dual);
  
    If n_Mod = 0 Then
      --0.按年顺序编号
      Select Nvl(最大号码, '0') Into v_No From 号码控制表 Where 项目序号 = 序号_In For Update;
    
      --第2位增长方式:0-9,A-Z
      Select Bit1 || Decode(Sign(Ascii(Bit2) - Ascii('9')),
                             -1,
                             Lpad(To_Number(Bit28) + 1, 7, '0'),
                             Decode(Bit38,
                                    '999999',
                                    Decode(Bit2, '9', 'A', Chr(Ascii(Bit2) + 1)) || '000000',
                                    Bit2 || Lpad(To_Number(Bit38) + 1, 6, '0')))
      Into v_No
      From (Select Substr(Maxno, 1, 1) As Bit1, Substr(Maxno, 2, 1) As Bit2, Substr(Maxno, 2) As Bit28,
                    Substr(Maxno, 3) As Bit38
             From (Select Decode(v_No,
                                   '0',
                                   v_Year || '0000000',
                                   Decode(Sign(Ascii(Substr(v_No, 1, 1)) - Ascii(v_Year)), -1, v_Year || '0000000', v_No)) As Maxno
                    From Dual));
    
      Update 号码控制表 Set 最大号码 = v_No Where 项目序号 = 序号_In;
    
    Elsif n_Mod = 1 Then
      --1.按年+日顺序编号:YDDD0000
      Select Nvl(最大号码, '0') Into v_No From 号码控制表 Where 项目序号 = 序号_In For Update;
      Select v_Year || Lpad(Trunc(Sysdate - Trunc(Sysdate, 'YYYY') + 1, 0), 3, '0') || '0000' Into v_Maxno From Dual;
      If v_No < v_Maxno Then
        v_No := v_Maxno;
      End If;
      v_No := Substr(v_No, 1, 4) || Lpad(To_Number(Substr(v_No, 5, 4)) + 1, 4, '0');
      Update 号码控制表 Set 最大号码 = v_No Where 项目序号 = 序号_In;
    
    Elsif n_Mod = 2 Then
      If 序号_In = 122 Then
        --2.按科室编码+YYMMDD+3位顺序号:2201090728001
        Select Count(*) Into n_Maxno From 科室号码表 Where 项目序号 = 序号_In And 科室id = 科室id_In;
        If Nvl(n_Maxno, 0) = 0 Then
          Insert Into 科室号码表 (项目序号, 科室id, 最大号码, 编号) Values (序号_In, 科室id_In, Null, Null);
          Commit;
        End If;
      
        Select 编码 Into v_Deptno From 部门表 Where Id = 科室id_In;
        Select Nvl(最大号码, '-') Into v_No From 科室号码表 Where 项目序号 = 序号_In And 科室id = 科室id_In For Update;
        v_Tmp := To_Char(Sysdate, 'YYMMDD');
      
        If Substr(v_No, 1, Length(v_Deptno || v_Tmp)) = v_Deptno || v_Tmp Then
          v_No := v_Deptno || v_Tmp || Lpad(To_Number(Substr(v_No, Length(v_Deptno || v_Tmp) + 1)) + 1, 3, '0');
        Else
          v_No := v_Deptno || v_Tmp || Lpad('1', 3, '0');
        End If;
        Update 科室号码表 Set 最大号码 = v_No Where 项目序号 = 序号_In And 科室id = 科室id_In;
      
      Else
        --2.按年+科室编号+月+顺序号:YKDD0000
        Begin
          --符号-的asscii为45,用于和year比较(0的ascii为48)
          Select 编号, Nvl(最大号码, '-')
          Into v_Deptno, v_No
          From 科室号码表
          Where 项目序号 = 序号_In And Nvl(科室id, 0) = Nvl(科室id_In, 0)
          For Update;
        Exception
          When Others Then
            Null;
        End;
        If v_Deptno Is Null Then
          v_Error := '科室未设置编号，无法产生号码！';
          Raise Err_Custom;
        Else
          v_Tmp := To_Char(Sysdate, 'MM');
          Select Substr(Maxno, 1, 4) || Lpad(To_Number(Substr(Maxno, 5, 4)) + 1, 4, '0')
          Into v_No
          From (Select Decode(Sign(Ascii(Substr(v_No, 1, 1)) - Ascii(v_Year)),
                                -1,
                                v_Year || v_Deptno || v_Tmp || '0000',
                                Decode(Sign(To_Number(Substr(v_No, 3, 2)) - To_Number(v_Tmp)),
                                       -1,
                                       v_Year || v_Deptno || v_Tmp || '0000',
                                       v_No)) As Maxno
                 From Dual);
          Update 科室号码表 Set 最大号码 = v_No Where 项目序号 = 序号_In And Nvl(科室id, 0) = Nvl(科室id_In, 0);
        
        End If;
      End If;
    Elsif n_Mod = 3 Then
    
      --按年月日+000001生成
      Select Substr(To_Char(Sysdate, 'yyyymmdd'), 3, 6) Into v_Tmp From Dual;
      Select Nvl(最大号码, '0') Into v_Maxno From 号码控制表 Where 项目序号 = 序号_In For Update;
    
      If v_Maxno = '0' Then
        v_Maxno := v_Tmp || '000001';
      Else
        If Substr(v_Maxno, 1, 6) = v_Tmp Then
          v_Maxno := v_Tmp || Trim(To_Char(To_Number(Substr(v_Maxno, 7, 6)) + 1, '000000'));
        Else
          v_Maxno := v_Tmp || '000001';
        End If;
      End If;
      Update 号码控制表 Set 最大号码 = v_Maxno Where 项目序号 = 序号_In;
      v_No := v_Maxno;
    
    Elsif n_Mod = 5 Then
      --1.年月(YYYYMM)+顺序号(000000)
      v_Tmp := To_Char(Sysdate, 'YYYYMM');
      Select Nvl(最大号码, '0') Into v_Maxno From 号码控制表 Where 项目序号 = 序号_In For Update;
    
      If v_Maxno = '0' Then
        v_Maxno := v_Tmp || '000001';
      Else
        If Substr(v_Maxno, 1, 6) = v_Tmp Then
          v_Maxno := v_Tmp || Trim(To_Char(To_Number(Substr(v_Maxno, 7, 6)) + 1, '000000'));
        Else
          v_Maxno := v_Tmp || '000001';
        End If;
      End If;
      Update 号码控制表 Set 最大号码 = v_Maxno Where 项目序号 = 序号_In;
      v_No := v_Maxno;
    Else
      v_Error := '序号为' || 序号_In || '的号码,其规则值:' || n_Mod || ',当前系统不支持！';
      Raise Err_Custom;
    End If;
  End If;

  Commit;
  Return v_No;
Exception
  When Err_Custom Then
    Rollback;
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    Rollback;
    Zl_Errorcenter(Sqlcode, Sqlerrm);
End Nextno;
/

--101301:刘鹏飞,2017-08-31,一次备血申请多个项目
Create Or Replace Procedure Zl_输血申请项目_Upate
(
  医嘱id_In In 输血申请记录.医嘱id%Type,
  Para_In   In Varchar2
) Is
  Strdata      Varchar2(1000);
  Intpos       Number(5);
  Strtext      Varchar2(100);
  n_诊疗项目id 输血申请项目.诊疗项目id%Type;
  n_申请量     输血申请项目.申请量%Type;
  v_申请血型   输血申请项目.申请血型%Type;
  v_申请rh     输血申请项目.申请rh%Type;
Begin
  --删除所有体温部位 
  Delete 输血申请项目 Where 医嘱id = 医嘱id_In;
  --参数格式为 诊疗项目ID,申请量,申请血型,申请RH;诊疗项目ID,申请量,申请血型,申请RH..... 
  Strdata := Para_In;
  Intpos  := Instr(Strdata, ';', 1);
  If Intpos > 0 Then
    Strtext := Substr(Strdata, 1, Instr(Strdata, ';', 1) - 1);
    Strdata := Substr(Strdata, Instr(Strdata, ';', 1) + 1);
  Else
    Strtext := Strdata;
    Strdata := '';
  End If;

  While Strtext Is Not Null Loop
    n_诊疗项目id := Substr(Strtext, 1, Instr(Strtext, ',', 1) - 1);
    Strtext      := Substr(Strtext, Instr(Strtext, ',', 1) + 1);
    n_申请量     := Substr(Strtext, 1, Instr(Strtext, ',', 1) - 1);
    Strtext      := Substr(Strtext, Instr(Strtext, ',', 1) + 1);
    v_申请血型   := Substr(Strtext, 1, Instr(Strtext, ',', 1) - 1);
    Strtext      := Substr(Strtext, Instr(Strtext, ',', 1) + 1);
    v_申请rh     := Strtext;
  
    Insert Into 输血申请项目
      (医嘱id, 诊疗项目id, 申请量, 申请血型, 申请rh)
    Values
      (医嘱id_In, n_诊疗项目id, n_申请量, v_申请血型, v_申请rh);
  
    Intpos := Instr(Strdata, ';', 1);
    If Intpos > 0 Then
      Strtext := Substr(Strdata, 1, Instr(Strdata, ';', 1) - 1);
      Strdata := Substr(Strdata, Instr(Strdata, ';', 1) + 1);
    Else
      Strtext := Strdata;
      Strdata := '';
    End If;
  End Loop;

Exception
  When Others Then
    Zl_Errorcenter(Sqlcode, Sqlerrm);
End Zl_输血申请项目_Upate;
/




--113841:陈刘,2017-10-10,程里面sql写法有问题,导致语句执行时间过长
Create Or Replace Procedure Zl_病人护理打印_Batchretrypage
(
  文件id_In In 病人护理打印.文件id%Type,
  标识_In   In Varchar2 := '0;0',
  重算_In   In Number := 0
) As
  n_Startpage Number; --开始页
  n_Startrow  Number; --开始行
  n_Endpage   Number; --结束页
  n_Endrow    Number; --结束行
  n_Pagerows  Number; --每页有效数据行
  n_Filerule  Number; --护理文件页码规则
  n_Count     Number;
  n_标志      Number; --是否要重算该文件的页码
  n_Firstadd  Number; --检查之前的编码规则是否不包含此文件(一般适用于首次新增记录的文件)
  n_病人id    病人护理文件.病人id%Type;
  n_主页id    病人护理文件.主页id%Type;
  n_婴儿      病人护理文件.婴儿%Type;
  n_格式id    病人护理文件.格式id%Type;
  n_Fileid    病人护理文件.Id%Type;
  d_开始时间  病人护理文件.开始时间%Type;
  d_创建时间  病人护理文件.创建时间%Type;

  Err_Item Exception;
  v_Err_Msg Varchar2(500);

  Cursor c_File1
  (
    病人id_In 病人护理文件.病人id%Type,
    主页id_In 病人护理文件.主页id%Type,
    婴儿_In   病人护理文件.婴儿%Type
  ) Is
    With 病人护理文件_F1 As
     (Select a.Id, a.续打id, 开始时间, 创建时间
      From 病人护理文件 a, 病历文件列表 b
      Where a.格式id = b.Id And b.种类 = 3 And b.保留 <> 1 And b.保留 <> -1 And a.病人id = 病人id_In And a.主页id = 主页id_In And
            Nvl(a.婴儿, 0) = 婴儿_In)
    Select a.Id
    From 病人护理文件_F1 a
    Where Not Exists (Select 1 From 病人护理文件_F1 Where a.Id = 续打id)
    Order By a.开始时间, 创建时间;

  Cursor c_File2(Id_In 病人护理文件.Id%Type) Is
    Select Id From 病人护理文件 Where Id = Id_In;
  t_Id t_Numlist;
Begin
  If Nvl(标识_In, '') = '' Then
    n_标志     := 0;
    n_Firstadd := 0;
  Else
    n_标志     := Substr(标识_In, 1, 1);
    n_Firstadd := Substr(标识_In, 3, 1);
  End If;
  If n_标志 <> 1 Then
    n_Firstadd := 0;
  End If;
  n_Fileid := 文件id_In;

  Select 病人id, 主页id, Nvl(婴儿, 0), 格式id
  Into n_病人id, n_主页id, n_婴儿, n_格式id
  From 病人护理文件
  Where Id = 文件id_In;

  If 重算_In = 1 Then
    n_标志 := 1;
    Open c_File1(n_病人id, n_主页id, n_婴儿);
    Fetch c_File1 Bulk Collect
      Into t_Id;
    Close c_File1;
  Else
    Open c_File2(文件id_In);
    Fetch c_File2 Bulk Collect
      Into t_Id;
    Close c_File2;
  End If;
  If t_Id.Count <= 0 Then
    Return;
  End If;

  --读取护理文件编码规则
  Begin
    Select Nvl(参数值, 0) Into n_Filerule From Zlparameters Where 模块 = 1255 And 参数名 = '护理文件页码规则';
  Exception
    When Others Then
      n_Filerule := 0;
  End;

  Select To_Number(内容文本)
  Into n_Pagerows
  From 病历文件结构
  Where 对象属性 = '有效数据行' And 父id = (Select Id From 病历文件结构 Where 文件id = n_格式id And 对象序号 = 1 And 父id Is Null);

  If 重算_In = 0 Then
    --文件页码编号规则可以随便更改，此处需要根据文件页码情况，获知之前的文件页码规则
    If n_Filerule <> 0 Then
      --文件顺序编号，如果存在1份以上的文件最小开始页码=1(合并文件只检查父文件)，则按照文件页码独立编号处理(之前老数据)
      With 病人护理文件_F1 As
       (Select a.Id, a.续打id, 开始时间, 创建时间
        From 病人护理文件 a, 病历文件列表 b
        Where a.格式id = b.Id And b.种类 = 3 And b.保留 <> 1 And b.保留 <> -1 And a.病人id = n_病人id And a.主页id = n_主页id And
              Nvl(a.婴儿, 0) = n_婴儿)
      Select Count(1)
      Into n_Count
      From (Select Min(b.开始页号) 开始页号, a.Id
             From 病人护理文件_F1 a, 病人护理打印 b
             Where a.Id = b.文件id And Not Exists (Select 1 From 病人护理文件_F1 Where a.Id = 续打id)
             Group By a.Id)
      Where 开始页号 = 1 And Decode(n_Firstadd, 0, 1, Decode(Id, 文件id_In, 0, 1)) = 1;
      If n_Count > 1 Then
        n_Filerule := 0;
      End If;
    Else
      --文件独立编号，如果存在文件最小开始页码>1(合并文件只检查父文件)，则按照文件页码顺序编号处理(之前老数据)
      With 病人护理文件_F1 As
       (Select a.Id, a.续打id, 开始时间, 创建时间
        From 病人护理文件 a, 病历文件列表 b
        Where a.格式id = b.Id And b.种类 = 3 And b.保留 <> 1 And b.保留 <> -1 And a.病人id = n_病人id And a.主页id = n_主页id And
              Nvl(a.婴儿, 0) = n_婴儿)
      Select Count(1)
      Into n_Count
      From (Select Min(b.开始页号) 开始页号, a.Id
             From 病人护理文件_F1 a, 病人护理打印 b
             Where a.Id = b.文件id And Not Exists (Select 1 From 病人护理文件_F1 Where a.Id = 续打id)
             Group By a.Id)
      Where 开始页号 > 1 And Decode(n_Firstadd, 0, 1, Decode(Id, 文件id_In, 0, 1)) = 1;
      If n_Count >= 1 Then
        n_Filerule := 1;
      End If;
    End If;
  End If;

  If n_Filerule <> 0 Then
    n_Fileid := t_Id(1);
    --文件顺序编号
    --提取文件开始时间大于改文件父文件的所有父文件列表以及改文件(因为病人文件列表可能包含：独立文件和合并文件，而合并的文件有可能存在时间交叉的情况)
    For r_List In (With 病人护理文件_F1 As
                      (Select a.Id, a.续打id, 开始时间, 创建时间
                      From 病人护理文件 a, 病历文件列表 b
                      Where a.格式id = b.Id And b.种类 = 3 And b.保留 <> 1 And b.保留 <> -1 And a.病人id = n_病人id And
                            a.主页id = n_主页id And Nvl(a.婴儿, 0) = n_婴儿)
                     Select Id, 续打id, 开始时间, 创建时间
                     From 病人护理文件_F1
                     Where Id = n_Fileid
                     Union All
                     Select Id, 续打id, 开始时间, 创建时间
                     From (Select Id, 续打id, 开始时间, 创建时间
                             From (Select a.Id, a.续打id, a.开始时间, a.创建时间
                                    From 病人护理文件_F1 a
                                    Where Not Exists (Select 1 From 病人护理文件_F1 Where a.Id = 续打id)) a
                             Where Exists (Select Id, 续打id, 开始时间, 创建时间
                                    From (Select Id, 续打id, 开始时间, 创建时间
                                           From (Select Id, 续打id, 开始时间, 创建时间
                                                  From 病人护理文件_F1
                                                  Start With Id = n_Fileid
                                                  Connect By Prior Id = 续打id
                                                  Order By Level Desc)
                                           Where Rownum < 2)
                                    Where a.Id <> Id And (a.开始时间 > 开始时间 Or (a.开始时间 = 开始时间 And a.创建时间 > 创建时间)))
                             Order By a.开始时间, a.创建时间)) Loop
      n_Endpage  := 0;
      d_开始时间 := r_List.开始时间;
      d_创建时间 := r_List.创建时间;
      --如果要重算该文件，需要注意该文件可能是子文件的情况
      If n_标志 = 1 And n_Fileid = r_List.Id Then
        Select Nvl(Max(a.结束页号), 0) 结束页号, Nvl(Max(a.结束行号), 0) 结束行号
        Into n_Endpage, n_Endrow
        From 病人护理打印 a,
             (Select 文件id, 结束页号
               From (Select 文件id, Max(a.结束页号) 结束页号
                      From 病人护理打印 a,
                           (Select Id, Rownum 序号
                             From 病人护理文件
                             Where 病人id = n_病人id And 主页id = n_主页id And 婴儿 = n_婴儿
                             Start With 续打id = r_List.Id
                             Connect By Prior Id = 续打id) b
                      Where a.文件id = b.Id
                      Group By 文件id, b.序号
                      Order By 序号)
               Where Rownum < 2) b		

        Where a.文件id = b.文件id And a.结束页号 = b.结束页号;
        If n_Endpage = 0 Then
          Select 开始时间, 创建时间
          Into d_开始时间, d_创建时间
          From (Select * From 病人护理文件 Start With Id = r_List.Id Connect By Prior Id = 续打id Order By Level Desc)
          Where Rownum < 2;
        Else
          n_Endrow := n_Endrow + 1;
          If n_Endrow > n_Pagerows Then
            n_Endpage := n_Endpage + 1;
            n_Endrow  := 1;
          End If;
          Zl_病人护理打印_Retrypage(r_List.Id, n_Endpage, n_Endrow, 重算_In);
        End If;
      End If;
      If n_Fileid <> r_List.Id Or (n_Endpage = 0 And n_标志 = 1 And n_Fileid = r_List.Id) Then
        --提取父文件的最大开始页码和开始行号
        With 病人护理文件_F1 As
         (Select a.Id, a.续打id, 开始时间, 创建时间
          From 病人护理文件 a, 病历文件列表 b
          Where a.格式id = b.Id And b.种类 = 3 And b.保留 <> 1 And b.保留 <> -1 And a.病人id = n_病人id And a.主页id = n_主页id And
                Nvl(a.婴儿, 0) = n_婴儿)
        Select Nvl(Max(结束页号), 0)
        Into n_Endpage
        From (Select Id
               From 病人护理文件_F1
               Start With Id In (Select Id
                                 From (Select a.Id
                                        From 病人护理文件_F1 a
                                        Where Not Exists (Select 1 From 病人护理文件_F1 Where a.Id = 续打id))
                                 Where (开始时间 < d_开始时间 Or (开始时间 = d_开始时间 And 创建时间 < d_创建时间)))
               Connect By Prior 续打id = Id) a, 病人护理打印 b
        Where a.Id = b.文件id;
      
        n_Endpage := n_Endpage + 1;
        n_Endrow  := 1;
        Zl_病人护理打印_Retrypage(r_List.Id, n_Endpage, n_Endrow, 重算_In);
      End If;
      For r_File In (Select a.Id
                     From 病人护理文件 a, 病历文件列表 b
                     Where a.格式id = b.Id And b.种类 = 3 And b.保留 <> 1 And b.保留 <> -1 And a.病人id = n_病人id And
                           a.主页id = n_主页id And a.婴儿 = n_婴儿 And a.Id <> r_List.Id
                     Start With a.Id = r_List.Id
                     Connect By Prior a.续打id = a.Id) Loop  

        --提取子文件开始页号和行号            
        Select Nvl(Max(a.结束页号), n_Endpage) 结束页号, Nvl(Max(a.结束行号), 0) 结束行号
        Into n_Startpage, n_Startrow
        From 病人护理打印 a,
             (Select 文件id, 结束页号
               From (Select 文件id, Max(a.结束页号) 结束页号
                      From 病人护理打印 a,
                           (Select Id, Rownum 序号
                             From 病人护理文件
                             Where 病人id = n_病人id And 主页id = n_主页id And 婴儿 = n_婴儿
                             Start With 续打id = r_File.Id
                             Connect By Prior Id = 续打id) b
                      Where a.文件id = b.Id
                      Group By 文件id, b.序号
                      Order By 序号)
               Where Rownum < 2) b		 

        Where a.文件id = b.文件id And a.结束页号 = b.结束页号;
        n_Startrow := n_Startrow + 1;
        If n_Startrow > n_Pagerows Then
          n_Startpage := n_Startpage + 1;
          n_Startrow  := 1;
        End If;
        Zl_病人护理打印_Retrypage(r_File.Id, n_Startpage, n_Startrow, 重算_In);
      End Loop;
    End Loop;
  Elsif n_Filerule = 0 Then
    For i In 1 .. t_Id.Count Loop
      n_Fileid := t_Id(i);
      --文件独立编号
      For r_File In (Select a.Id
                     From 病人护理文件 a, 病历文件列表 b
                     Where a.格式id = b.Id And b.种类 = 3 And b.保留 <> 1 And b.保留 <> -1 And a.病人id = n_病人id And
                           a.主页id = n_主页id And a.婴儿 = n_婴儿
                     Start With a.Id = n_Fileid
                     Connect By Prior a.续打id = a.Id) Loop 

        --提取子文件开始页号和行号            
        If n_Fileid <> r_File.Id Or (n_标志 = 1 And n_Fileid = r_File.Id) Then
          Select Nvl(Max(a.结束页号), 1) 结束页号, Nvl(Max(a.结束行号), 0) 结束行号
          Into n_Startpage, n_Startrow
          From 病人护理打印 a,
               (Select 文件id, 结束页号
                 From (Select 文件id, Max(a.结束页号) 结束页号
                        From 病人护理打印 a,
                             (Select Id, Rownum 序号
                               From 病人护理文件
                               Where 病人id = n_病人id And 主页id = n_主页id And 婴儿 = n_婴儿
                               Start With 续打id = r_File.Id
                               Connect By Prior Id = 续打id) b
                        Where a.文件id = b.Id
                        Group By 文件id, b.序号
                        Order By 序号)
                 Where Rownum < 2) b	   

          Where a.文件id = b.文件id And a.结束页号 = b.结束页号;
          n_Startrow := n_Startrow + 1;
          If n_Startrow > n_Pagerows Then
            n_Startpage := n_Startpage + 1;
            n_Startrow  := 1;
          End If;
          Zl_病人护理打印_Retrypage(r_File.Id, n_Startpage, n_Startrow, 重算_In);
        End If;
      End Loop;
    End Loop;
  End If;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    Zl_Errorcenter(Sqlcode, Sqlerrm);
End Zl_病人护理打印_Batchretrypage;
/

--112759:刘涛,2017-10-10,材料移库审核时成本价为空则重算
Create Or Replace Procedure Zl_材料移库_Verify
(
  序号_In       In 药品收发记录.序号%Type,
  库房id_In     In 药品收发记录.库房id%Type,
  对方部门id_In In 药品收发记录.对方部门id%Type,
  材料id_In     In 药品收发记录.药品id%Type,
  产地_In       In 药品收发记录.产地%Type,
  出批次_In     In 药品收发记录.批次%Type,
  填写数量_In   In 药品收发记录.填写数量%Type,
  实际数量_In   In 药品收发记录.实际数量%Type,
  成本价_In     In 药品收发记录.成本价%Type,
  成本金额_In   In 药品收发记录.成本金额%Type,
  零售金额_In   In 药品收发记录.零售金额%Type,
  差价_In       In 药品收发记录.差价%Type,
  出类别id_In   In 药品收发记录.入出类别id%Type,
  入类别id_In   In 药品收发记录.入出类别id%Type,
  No_In         In 药品收发记录.No%Type,
  审核人_In     In 药品收发记录.审核人%Type,
  批号_In       In 药品收发记录.批号%Type := Null,
  效期_In       In 药品收发记录.效期%Type := Null,
  灭菌效期_In   In 药品收发记录.灭菌效期%Type := Null,
  审核日期_In   In 药品收发记录.审核日期%Type := Null,
  移库单_In     In Number := 1,
  零售价_In     In 药品收发记录.零售价%Type := Null
) Is
  Err_Item Exception;
  v_Err_Msg    Varchar2(500);
  v_编码       收费项目目录.编码%Type;
  v_负成本计算 Zlparameters.参数值%Type;
  v_批准文号   药品库存.批准文号%Type;
  n_实价卫材   收费项目目录.是否变价%Type;

  n_入批次       药品收发记录.批次%Type := Null;
  n_实际库存金额 药品库存.实际金额%Type;
  n_实际库存差价 药品库存.实际差价%Type;
  n_出库差价     药品库存.实际差价%Type;
  n_成本价       药品收发记录.成本价%Type;
  n_成本金额     药品收发记录.成本金额%Type;
  n_实际数量     药品库存.实际数量%Type;
  n_上次供应商id 药品库存.上次供应商id%Type;
  n_上次生产日期 药品库存.上次生产日期%Type;
  n_零售价       药品收发记录.零售价%Type;
  n_小数         Number;
  v_上次扣率     药品库存.上次扣率%Type;
  v_商品条码     药品库存.商品条码%Type;
  v_内部条码     药品库存.内部条码%Type;
  n_平均成本价   药品库存.平均成本价%Type;
Begin
  --获取金额小数位数
  Select Nvl(精度, 2) Into n_小数 From 药品卫材精度 Where 类别 = 2 And 内容 = 4 And 单位 = 5;
  Select zl_GetSysParameter(120) Into v_负成本计算 From Dual;

  --由于移库处理允许在审核时改变实际数量，
  --所以首先对实际数量和其他相应的字段进行更新。
  Begin
    Select Nvl(实际金额, 0), Nvl(实际差价, 0), Nvl(实际数量, 0), Nvl(上次扣率, 100), 商品条码, 内部条码
    Into n_实际库存金额, n_实际库存差价, n_实际数量, v_上次扣率, v_商品条码, v_内部条码
    From 药品库存
    Where 药品id = 材料id_In And Nvl(批次, 0) = 出批次_In And 库房id = 库房id_In And 性质 = 1 And Rownum = 1;
  Exception
    When Others Then
      n_实际库存金额 := 0;
      n_实际数量     := 0;
      v_上次扣率     := 100;
      v_商品条码     := Null;
      v_内部条码     := Null;
  End;
  Select 是否变价 Into n_实价卫材 From 收费项目目录 Where ID = 材料id_In;

  If 成本价_In Is Null Then
    --成本价为空
    n_成本价   := Round(Zl_Fun_Getoutcost(材料id_In, 出批次_In, 库房id_In), 7);
    n_成本金额 := Round(n_成本价 * 实际数量_In, n_小数);
    n_出库差价 := Round(零售金额_In - n_成本金额, n_小数);
  Else
    n_成本价   := 成本价_In;
    n_成本金额 := 成本金额_In;
    n_出库差价 := 差价_In;
  End If;

  Update 药品收发记录
  Set 审核人 = Nvl(审核人_In, 审核人), 审核日期 = 审核日期_In, 实际数量 = 实际数量_In, 成本价 = n_成本价, 成本金额 = n_成本金额, 零售价 = 零售价_In, 零售金额 = 零售金额_In,
      差价 = n_出库差价, 扣率 = v_上次扣率, 商品条码 = v_商品条码, 内部条码 = v_内部条码
  Where NO = No_In And 单据 = 19 And 药品id = 材料id_In And 记录状态 = 1 And 序号 In (序号_In, 序号_In + 1) And 审核人 Is Null;

  If Sql%RowCount = 0 Then
    v_Err_Msg := '[ZLSOFT]该单据已经被他人审核！[ZLSOFT]';
    Raise Err_Item;
  End If;

  If 出批次_In > 0 Then
    If n_实际数量 < 实际数量_In Then
      Select 编码 Into v_编码 From 收费项目目录 Where ID = 材料id_In;
      v_Err_Msg := '[ZLSOFT]编码为' || v_编码 || ',批号为' || 批号_In || '的库房分批材料' || Chr(10) || Chr(13) || '可用库存数量不够！[ZLSOFT]';
      Raise Err_Item;
    End If;
  End If;

  --取入类别的批次和上次供应商
  Select 批次, 供药单位id, 生产日期, 批准文号, 零售价
  Into n_入批次, n_上次供应商id, n_上次生产日期, v_批准文号, n_零售价
  From 药品收发记录
  Where NO = No_In And 单据 = 19 And 记录状态 = 1 And 序号 = 序号_In + 1;

  --更改入类别的材料库存的相应数据

  Update 药品库存
  Set 可用数量 = Nvl(可用数量, 0) + 实际数量_In, 实际数量 = Nvl(实际数量, 0) + 实际数量_In, 实际金额 = Nvl(实际金额, 0) + 零售金额_In,
      实际差价 = Nvl(实际差价, 0) + n_出库差价, 上次采购价 = Decode(上次采购价, Null, n_成本价, 0, n_成本价, 上次采购价), 上次批号 = Nvl(批号_In, 上次批号),
      上次产地 = Nvl(产地_In, 上次产地), 灭菌效期 = Nvl(灭菌效期_In, 灭菌效期), 商品条码 = v_商品条码, 内部条码 = v_内部条码
  Where 库房id = 对方部门id_In And 药品id = 材料id_In And Nvl(批次, 0) = Nvl(n_入批次, 0) And 性质 = 1;

  If Sql%NotFound Then
    Insert Into 药品库存
      (库房id, 药品id, 批次, 性质, 可用数量, 实际数量, 实际金额, 实际差价, 上次采购价, 上次批号, 上次产地, 效期, 灭菌效期, 上次供应商id, 上次生产日期, 批准文号, 零售价, 上次扣率, 商品条码,
       内部条码, 平均成本价)
    Values
      (对方部门id_In, 材料id_In, n_入批次, 1, 实际数量_In, 实际数量_In, 零售金额_In, n_出库差价, n_成本价, 批号_In, 产地_In, 效期_In, 灭菌效期_In, n_上次供应商id,
       n_上次生产日期, v_批准文号, Decode(n_实价卫材, 1, Decode(Nvl(n_入批次, 0), 0, Null, n_零售价), Null), v_上次扣率, v_商品条码, v_内部条码, n_成本价);
  End If;

  Delete From 药品库存
  Where 库房id = 对方部门id_In And 药品id = 材料id_In And Nvl(可用数量, 0) = 0 And Nvl(实际数量, 0) = 0 And Nvl(实际金额, 0) = 0 And
        Nvl(实际差价, 0) = 0;

  --重新计算平均成本价
  Update 药品库存
  Set 平均成本价 = Decode(Nvl(批次, 0),
                      0,
                      Decode((实际金额 - 实际差价) / 实际数量, 0, 上次采购价, (实际金额 - 实际差价) / 实际数量),
                      上次采购价)
  Where 药品id = 材料id_In And Nvl(批次, 0) = Nvl(n_入批次, 0) And 库房id = 对方部门id_In And Nvl(实际数量, 0) <> 0 And 性质 = 1;
  If Sql%NotFound Then
    Select 成本价 Into n_平均成本价 From 材料特性 Where 材料id = 材料id_In;
    Update 药品库存
    Set 平均成本价 = n_平均成本价
    Where 药品id = 材料id_In And 库房id = 对方部门id_In And Nvl(批次, 0) = Nvl(n_入批次, 0) And 性质 = 1;
  End If;

  --更改出类别的材料库存的相应数据

  Update 药品库存
  Set 实际数量 = Nvl(实际数量, 0) - 实际数量_In, 实际金额 = Nvl(实际金额, 0) - 零售金额_In, 实际差价 = Nvl(实际差价, 0) - n_出库差价
  Where 库房id = 库房id_In And 药品id = 材料id_In And Nvl(批次, 0) = Nvl(出批次_In, 0) And 性质 = 1;

  If Sql%NotFound Then
    Insert Into 药品库存
      (库房id, 药品id, 批次, 性质, 可用数量, 实际数量, 实际金额, 实际差价, 上次批号, 上次产地, 效期, 灭菌效期, 上次供应商id, 上次采购价, 上次生产日期, 批准文号, 零售价, 上次扣率, 商品条码,
       内部条码, 平均成本价)
    Values
      (库房id_In, 材料id_In, 出批次_In, 1, 0, -实际数量_In, -零售金额_In, -n_出库差价, 批号_In, 产地_In, 效期_In, 灭菌效期_In, n_上次供应商id, n_成本价,
       n_上次生产日期, v_批准文号, Decode(n_实价卫材, 1, Decode(Nvl(出批次_In, 0), 0, Null, n_零售价), Null), v_上次扣率, v_商品条码, v_内部条码, n_成本价);
  End If;

  --出库房，平均成本价为空时需要重新计算库存表中的平均成本价
  Update 药品库存
  Set 平均成本价 = Decode(Nvl(批次, 0),
                      0,
                      Decode((实际金额 - 实际差价) / 实际数量, 0, 上次采购价, (实际金额 - 实际差价) / 实际数量),
                      上次采购价)
  Where 药品id = 材料id_In And Nvl(批次, 0) = Nvl(出批次_In, 0) And 库房id = 库房id_In And Nvl(实际数量, 0) <> 0 And 性质 = 1 And
        Nvl(平均成本价, 0) = 0;

  Delete From 药品库存
  Where 库房id = 库房id_In And 药品id = 材料id_In And Nvl(可用数量, 0) = 0 And Nvl(实际数量, 0) = 0 And Nvl(实际金额, 0) = 0 And
        Nvl(实际差价, 0) = 0;

Exception
  When Err_Item Then
    Raise_Application_Error(-20101, v_Err_Msg);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_材料移库_Verify;
/

--101301:刘鹏飞,2017-08-31,一次备血申请多个项目
--101301:陈龙，2017-08-10,Zl_输血申请记录_Insert增加既往输血反应史和输血禁忌及过敏史
Create Or Replace Procedure Zl_输血申请记录_Insert
(
  医嘱id_In           输血申请记录.医嘱id%Type,
  是否待诊_In         输血申请记录.是否待诊%Type,
  输血类型_In         输血申请记录.输血类型%Type,
  输血目的_In         输血申请记录.输血目的%Type,
  输血性质_In         输血申请记录.输血性质%Type,
  即往输血史_In       输血申请记录.即往输血史%Type,
  既往输血反应史_In   输血申请记录.既往输血反应史%Type,
  输血禁忌及过敏史_In 输血申请记录.输血禁忌及过敏史%Type,
  孕产情况_In         输血申请记录.孕产情况%Type,
  受血者属地_In       输血申请记录.受血者属地%Type,
  输血血型_In         输血申请记录.输血血型%Type,
  Rhd_In              输血申请记录.Rhd%Type,
  输血项目_In         Varchar2
) Is

Begin
  --先删除原有的数据 
  Delete From 输血申请记录 Where 医嘱id = 医嘱id_In;
  Insert Into 输血申请记录
    (医嘱id, 是否待诊, 输血类型, 输血目的, 输血性质, 即往输血史, 既往输血反应史, 输血禁忌及过敏史, 孕产情况, 受血者属地, 输血血型, Rhd)
  Values
    (医嘱id_In, 是否待诊_In, 输血类型_In, 输血目的_In, 输血性质_In, 即往输血史_In, 既往输血反应史_In, 输血禁忌及过敏史_In, 孕产情况_In, 受血者属地_In, 输血血型_In, Rhd_In);

  Zl_输血申请项目_Upate(医嘱id_In, 输血项目_In);
Exception
  When Others Then
    Zl_Errorcenter(Sqlcode, Sqlerrm);
End Zl_输血申请记录_Insert;
/

--101301:陈龙,2017-10-20,修改输血审核回退时步骤记录
--101301:陈龙,2017-10-20,修改输血审核回退步骤记录
--101301:陈龙，2017-07-31,Zl_医嘱审核管理_Update
CREATE OR REPLACE PROCEDURE Zl_医嘱审核管理_Update
(
  医嘱id_In   病人医嘱状态.医嘱id%TYPE,
  操作时间_In 病人医嘱状态.操作时间%TYPE,
  操作说明_In 病人医嘱状态.操作说明%TYPE := NULL,
  审核对象_In NUMBER := 1, --1=手术医嘱，2=输血医嘱 
  操作人员_In VARCHAR2 := NULL
) IS
  --修改只适用于审核不通过的医嘱，修改其审核说明 
  Err_Item EXCEPTION;
  v_Err_Msg  VARCHAR2(200);
  n_Count    NUMBER;
  n_审核状态 NUMBER;
BEGIN
  SELECT COUNT(1) INTO n_Count FROM 病人医嘱记录 WHERE Id = 医嘱id_In;
  SELECT 审核状态 INTO n_审核状态 FROM 病人医嘱记录 WHERE Id = 医嘱id_In;
  IF n_Count = 0 THEN
    v_Err_Msg := '有医嘱已经删除,请查证。';
    RAISE Err_Item;
  END IF;

  IF 审核对象_In = 1 THEN
    UPDATE 病人医嘱状态
    SET 操作时间 = 操作时间_In, 操作说明 = 操作说明_In
    WHERE 医嘱id IN (SELECT Id FROM 病人医嘱记录 WHERE Id = 医嘱id_In OR 相关id = 医嘱id_In) AND 操作类型 = 12 AND
          操作时间 = (SELECT MAX(操作时间) FROM 病人医嘱状态 WHERE 医嘱id = 医嘱id_In AND 操作类型 = 12);
  ELSE
    IF n_审核状态 = 1 THEN
      UPDATE 病人医嘱状态
      SET 操作时间 = 操作时间_In, 操作说明 = 操作说明_In
      WHERE 医嘱id IN (SELECT Id FROM 病人医嘱记录 WHERE Id = 医嘱id_In OR 相关id = 医嘱id_In) AND 操作类型 = 19 AND
            操作时间 = (SELECT MAX(操作时间) FROM 病人医嘱状态 WHERE 医嘱id = 医嘱id_In AND 操作类型 = 19);
      IF SQL%NOTFOUND THEN
        INSERT INTO 病人医嘱状态
          (医嘱id, 操作类型, 操作人员, 操作时间, 操作说明)
          SELECT Id, 19, 操作人员_In, 操作时间_In, 操作说明_In
          FROM 病人医嘱记录
          WHERE Id = 医嘱id_In OR 相关id = 医嘱id_In;
      END IF;
    ELSIF n_审核状态 = 7 THEN
      UPDATE 病人医嘱状态
      SET 操作时间 = 操作时间_In, 操作说明 = 操作说明_In
      WHERE 医嘱id IN (SELECT Id FROM 病人医嘱记录 WHERE Id = 医嘱id_In OR 相关id = 医嘱id_In) AND 操作类型 = 18 AND
            操作时间 = (SELECT MAX(操作时间) FROM 病人医嘱状态 WHERE 医嘱id = 医嘱id_In AND 操作类型 = 18);
      IF SQL%NOTFOUND THEN
        INSERT INTO 病人医嘱状态
          (医嘱id, 操作类型, 操作人员, 操作时间, 操作说明)
          SELECT Id, 18, 操作人员_In, 操作时间_In, 操作说明_In
          FROM 病人医嘱记录
          WHERE Id = 医嘱id_In OR 相关id = 医嘱id_In;
      END IF;
    ELSIF n_审核状态 = 3 THEN
      UPDATE 病人医嘱状态
      SET 操作时间 = 操作时间_In, 操作说明 = 操作说明_In
      WHERE 医嘱id IN (SELECT Id FROM 病人医嘱记录 WHERE Id = 医嘱id_In OR 相关id = 医嘱id_In) AND 操作类型 = 12 AND
            操作时间 = (SELECT MAX(操作时间) FROM 病人医嘱状态 WHERE 医嘱id = 医嘱id_In AND 操作类型 = 12);
      IF SQL%NOTFOUND THEN
        INSERT INTO 病人医嘱状态
          (医嘱id, 操作类型, 操作人员, 操作时间, 操作说明)
          SELECT Id, 12, 操作人员_In, 操作时间_In, 操作说明_In
          FROM 病人医嘱记录
          WHERE Id = 医嘱id_In OR 相关id = 医嘱id_In;
      END IF;
	ELSIF n_审核状态 = 4 THEN
      UPDATE 病人医嘱状态
      SET 操作时间 = 操作时间_In, 操作说明 = 操作说明_In
      WHERE 医嘱id IN (SELECT Id FROM 病人医嘱记录 WHERE Id = 医嘱id_In OR 相关id = 医嘱id_In) AND 操作类型 = 11 AND
            操作时间 = (SELECT MAX(操作时间) FROM 病人医嘱状态 WHERE 医嘱id = 医嘱id_In AND 操作类型 = 11);
      IF SQL%NOTFOUND THEN
        INSERT INTO 病人医嘱状态
          (医嘱id, 操作类型, 操作人员, 操作时间, 操作说明)
          SELECT Id, 11, 操作人员_In, 操作时间_In, 操作说明_In
          FROM 病人医嘱记录
          WHERE Id = 医嘱id_In OR 相关id = 医嘱id_In;
      END IF;
    END IF;
  END IF;
EXCEPTION
  WHEN Err_Item THEN
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  WHEN OTHERS THEN
    Zl_Errorcenter(SQLCODE, SQLERRM);
END Zl_医嘱审核管理_Update;
/

--0:陈龙,2017-10-11,更改传入值的默认值
--101301:陈龙,2017-10-20,修改输血审核取消（回退）方式
--101301:陈龙，2017-08-28,Zl_医嘱审核管理_Cancel
CREATE OR REPLACE PROCEDURE Zl_医嘱审核管理_Cancel
(
  医嘱ids_In  VARCHAR2,
  审核对象_In NUMBER := 1, --1=手术医嘱，2=输血医嘱
  执行类别_In NUMBER := 0 --0=老版血库流程；不为0时，则为目标审核状态：1=待审核；7=待签发；4-已签发；3-已拒绝；
) IS
  --取消审核
  CURSOR c_Advice IS
    SELECT * FROM TABLE(CAST(f_Num2list(医嘱ids_In) AS t_Numlist));
  Err_Item EXCEPTION;
  v_Err_Msg  VARCHAR2(200);
  n_Count    NUMBER;
  n_医嘱状态 NUMBER;
  n_审核状态 NUMBER;
  n_操作类型 NUMBER;
BEGIN
  FOR r_Advice IN c_Advice LOOP
    SELECT COUNT(1), MAX(医嘱状态), Nvl(MAX(审核状态), 0)
    INTO n_Count, n_医嘱状态, n_审核状态
    FROM 病人医嘱记录
    WHERE Id = r_Advice.Column_Value;
  
    IF n_Count = 0 THEN
      v_Err_Msg := '有医嘱已经删除,请查证。';
      RAISE Err_Item;
    END IF;
  
    IF n_医嘱状态 <> 1 THEN
      v_Err_Msg := '您选择的医嘱中包含有校对的医嘱，不能取消审核。';
      RAISE Err_Item;
    END IF;
  
    IF n_审核状态 = 1 THEN
      n_操作类型 := 19;
    ELSIF n_审核状态 = 7 THEN
      n_操作类型 := 18;
    ELSIF n_审核状态 = 3 THEN
      n_操作类型 := 12;
    ELSIF n_审核状态 = 4 THEN
      n_操作类型 := 11;
    END IF;
  
    IF 审核对象_In = 1 OR 执行类别_In = 0 THEN
      UPDATE 病人医嘱记录 SET 审核状态 = 1 WHERE Id = r_Advice.Column_Value OR 相关id = r_Advice.Column_Value;
      DELETE FROM 病人医嘱状态
      WHERE 医嘱id IN (SELECT Id FROM 病人医嘱记录 WHERE Id = r_Advice.Column_Value OR 相关id = r_Advice.Column_Value) AND
            操作类型 IN (11, 12) AND
            操作时间 = (SELECT MAX(操作时间) FROM 病人医嘱状态 WHERE 医嘱id = r_Advice.Column_Value AND 操作类型 IN (11, 12));
    ELSIF 审核对象_In = 2 AND 执行类别_In <> 0 THEN
      UPDATE 病人医嘱记录
      SET 审核状态 = 执行类别_In
      WHERE Id = r_Advice.Column_Value OR 相关id = r_Advice.Column_Value;
      DELETE FROM 病人医嘱状态
      WHERE 医嘱id IN (SELECT Id FROM 病人医嘱记录 WHERE Id = r_Advice.Column_Value OR 相关id = r_Advice.Column_Value) AND
            操作类型 = n_操作类型 AND
            操作时间 =
            (SELECT MAX(操作时间) FROM 病人医嘱状态 WHERE 医嘱id = r_Advice.Column_Value AND 操作类型 = n_操作类型);
    END IF;
  
  END LOOP;
EXCEPTION
  WHEN Err_Item THEN
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  WHEN OTHERS THEN
    Zl_Errorcenter(SQLCODE, SQLERRM);
END Zl_医嘱审核管理_Cancel;
/

--101301:陈龙，2017-07-31，Zl_医嘱审核管理_Audit
CREATE OR REPLACE PROCEDURE Zl_医嘱审核管理_Audit
(
  医嘱id_In   病人医嘱状态.医嘱id%TYPE,
  结果_In     NUMBER,
  操作人员_In 病人医嘱状态.操作人员%TYPE,
  操作时间_In 病人医嘱状态.操作时间%TYPE,
  操作说明_In 病人医嘱状态.操作说明%TYPE := NULL,
  审核对象_In NUMBER := 1 --1=手术医嘱，2=输血医嘱 
) IS
  Err_Item EXCEPTION;
  v_Err_Msg  VARCHAR2(200);
  n_审核状态 NUMBER;
  n_Count    NUMBER;
  n_结果     NUMBER;
BEGIN
  SELECT Nvl(MAX(审核状态), 0), COUNT(1) INTO n_审核状态, n_Count FROM 病人医嘱记录 WHERE Id = 医嘱id_In;
  IF n_审核状态 NOT IN (1, 7) AND n_Count <> 0 THEN
    v_Err_Msg := '有医嘱已经审核或不需审核,请查证。';
    RAISE Err_Item;
  ELSIF n_Count = 0 THEN
    v_Err_Msg := '有医嘱已经删除,请查证。';
    RAISE Err_Item;
  END IF;

  UPDATE 病人医嘱记录 SET 审核状态 = 结果_In + 1 WHERE Id = 医嘱id_In OR 相关id = 医嘱id_In;
  IF 审核对象_In = 2 AND 结果_In = 3 THEN
    --启用血库系统时，特殊处理 
    n_结果 := 11;
  ELSIF 审核对象_In = 2 AND 结果_In = 6 THEN
    n_结果 := 18;
  ELSE
    n_结果 := 结果_In + 10;
  END IF;
  INSERT INTO 病人医嘱状态
    (医嘱id, 操作类型, 操作人员, 操作时间, 操作说明)
    SELECT Id, n_结果, 操作人员_In, 操作时间_In, 操作说明_In
    FROM 病人医嘱记录
    WHERE Id = 医嘱id_In OR 相关id = 医嘱id_In;
EXCEPTION
  WHEN Err_Item THEN
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  WHEN OTHERS THEN
    Zl_Errorcenter(SQLCODE, SQLERRM);
END Zl_医嘱审核管理_Audit;
/

--101301:刘鹏飞,2017-07-14,医嘱附件存在相同项目就修改，否则新增
Create Or Replace Procedure Zl_病人医嘱附件_Insert
(
  医嘱id_In 病人医嘱附件.医嘱id%Type,
  项目_In   病人医嘱附件.项目%Type,
  必填_In   病人医嘱附件.必填%Type,
  排列_In   病人医嘱附件.排列%Type,
  要素id_In 病人医嘱附件.要素id%Type,
  内容_In   病人医嘱附件.内容%Type,
  删除_In   Number := 0
) Is
  n_Add Number(1);
Begin
  If Nvl(删除_In, 0) = 1 Then
    Delete From 病人医嘱附件 Where 医嘱id = 医嘱id_In;
    n_Add := 1;
  Else
    Update 病人医嘱附件
    Set 必填 = 必填_In, 排列 = 排列_In, 要素id = 要素id_In, 内容 = 内容_In
    Where 医嘱id = 医嘱id_In And 项目 = 项目_In;
    If Sql%Notfound Then
      n_Add := 1;
    End If;
  End If;

  If n_Add = 1 Then
    Insert Into 病人医嘱附件
      (医嘱id, 项目, 必填, 排列, 要素id, 内容)
    Values
      (医嘱id_In, 项目_In, 必填_In, 排列_In, 要素id_In, 内容_In);
  End If;
Exception
  When Others Then
    Zl_Errorcenter(Sqlcode, Sqlerrm);
End Zl_病人医嘱附件_Insert;
/

--101301:刘鹏飞,2017-03-01,增s加函数返回血型和RH指标代码
Create Or Replace Function Zl_Fun_Bloodapplycode Return Varchar2 As
  v_Return Varchar2(4000);
Begin
  --功能:返回输血申请单上检验指标中的ABO和RH指标代码(也可只返回ABO指标代码)
  --返回值：字符串格式: ABO指标代码,RH指标代码                    
  v_Return := '';
  Return v_Return;
Exception
  When Others Then
    Zl_Errorcenter(Sqlcode, Sqlerrm);
End Zl_Fun_Bloodapplycode;
/

--103106:蔡青松,2017-02-07,单独处理输血医嘱
Create Or Replace Procedure Zl_检验预置条码_采集完成
(
  医嘱内容_In Varchar2, --内容包括多个医嘱ID使用","分隔 
  人员编号_In 人员表.编号%Type := Null,
  人员姓名_In 人员表.姓名%Type := Null, --Null=取消，不为空时完成采集 
  操作_In     Number := 0, --0=完成采集，1=取消采集
  医嘱类别_In Number := 0 --0=检验医嘱,1=输血医嘱 
) Is
  n_自动发料 Number;
  --查找当前标本的相关申请 
  Cursor c_Samplequest(v_医嘱id In Varchar2) Is
    Select /*+ rule */
    Distinct Id As 医嘱id, 病人来源
    From 病人医嘱记录 a, 病人医嘱发送 b
    Where a.Id = b.医嘱id And b.接收人 Is Null And Sign(Nvl(a.相关id, 0)) = 医嘱类别_In And
          a.Id In (Select * From Table(Cast(f_Num2list(v_医嘱id) As Zltools.t_Numlist)));

  --未审核的费用行(不包含药品) 
  Cursor c_Verify(v_医嘱id In Varchar2) Is
    Select /*+ rule */
    Distinct 记录性质, No, 序号, 记录状态, 门诊标志
    From 住院费用记录
    Where 收费类别 Not In ('5', '6', '7') And
          医嘱序号 + 0 In (Select Id
                       From 病人医嘱记录
                       Where Id In (Select * From Table(Cast(f_Num2list(v_医嘱id) As Zltools.t_Numlist))) And
                             Sign(Nvl(相关id, 0)) = 医嘱类别_In) And 记帐费用 = 1 And 记录状态 = 0 And 价格父号 Is Null And
          (记录性质, No) In (Select 记录性质, No
                         From 病人医嘱附费
                         Where 医嘱id In (Select * From Table(Cast(f_Num2list(v_医嘱id) As Zltools.t_Numlist)))
                         Union All
                         Select 记录性质, No
                         From 病人医嘱发送
                         Where 医嘱id In (Select Id
                                        From 病人医嘱记录
                                        Where Id In (Select * From Table(Cast(f_Num2list(v_医嘱id) As Zltools.t_Numlist))) And
                                              Sign(Nvl(相关id, 0)) = 医嘱类别_In) And 接收人 Is Null)
    Union All
    Select /*+ rule */
    Distinct 记录性质, No, 序号, 记录状态, 门诊标志
    From 门诊费用记录
    Where 收费类别 Not In ('5', '6', '7') And
          医嘱序号 + 0 In (Select Id
                       From 病人医嘱记录
                       Where Id In (Select * From Table(Cast(f_Num2list(v_医嘱id) As Zltools.t_Numlist))) And
                             Sign(Nvl(相关id, 0)) = 医嘱类别_In) And 记帐费用 = 1 And 记录状态 = 0 And 价格父号 Is Null And
          (记录性质, No) In (Select 记录性质, No
                         From 病人医嘱附费
                         Where 医嘱id In (Select * From Table(Cast(f_Num2list(v_医嘱id) As Zltools.t_Numlist)))
                         Union All
                         Select 记录性质, No
                         From 病人医嘱发送
                         Where 医嘱id In (Select Id
                                        From 病人医嘱记录
                                        Where Id In (Select * From Table(Cast(f_Num2list(v_医嘱id) As Zltools.t_Numlist))) And
                                              Sign(Nvl(相关id, 0)) = 医嘱类别_In) And 接收人 Is Null)
    Order By 记录性质, No, 序号;

  v_检验标本记录 Number(18);
  v_执行状态     Number(1);
  v_接收人       Varchar2(50);
  v_Error        Varchar2(100);
  v_执行         Number;
  v_No           病人医嘱发送.No%Type;
  v_性质         病人医嘱发送.记录性质%Type;
  v_序号         Varchar2(1000);

  v_收发ids Varchar2(4000);
  n_库房id  Number;
  n_发料号  Number;

  Err_Custom Exception;
  n_Par Number;
Begin
  Select Zl_Getsysparameter('自动发料退料', 1211) Into n_自动发料 From Dual;
  If 人员姓名_In Is Not Null And 操作_In = 0 Then
    --检查标本是否被核收或接收 
    Begin
      Select /*+ rule */
       Nvl(c.Id, 0), b.执行状态, b.接收人
      Into v_检验标本记录, v_执行状态, v_接收人
      From 病人医嘱记录 a, 病人医嘱发送 b, 检验标本记录 c
      Where a.Id = b.医嘱id And a.相关id = c.医嘱id(+) And
            a.Id In (Select * From Table(Cast(f_Num2list(医嘱内容_In) As Zltools.t_Numlist)));
    Exception
      When Others Then
        v_检验标本记录 := 0;
    End;
  
    If v_检验标本记录 <> 0 Then
      v_Error := '标本已被检验科核收不能完成采集!';
      Raise Err_Custom;
    End If;
  
    If v_执行状态 <> 2 And v_接收人 Is Not Null Then
      v_Error := '标本已被检验科签收不能完成采集!';
      Raise Err_Custom;
    End If;
  
    --检查医嘱是否收费
    n_Par := Zl_To_Number(Nvl(Zl_Getsysparameter(163), '0'));
    If n_Par = 1 Then
      For r_Verify In c_Verify(医嘱内容_In) Loop
        If r_Verify.记录状态 = 0 Then
          If r_Verify.门诊标志 = 1 Then
            v_Error := '标本未收费，不允许执行，请联系管理员！';
            Raise Err_Custom;
          Elsif r_Verify.门诊标志 = 2 Then
            v_Error := '标本未记账，不允许执行，请联系管理员！';
            Raise Err_Custom;
          End If;
        End If;
      End Loop;
    End If;
  
    Update /*+ rule */ 检验拒收记录
    Set 重采人 = 人员姓名_In, 重采时间 = Sysdate
    Where 医嘱id In (Select * From Table(Cast(f_Num2list(医嘱内容_In) As Zltools.t_Numlist)));
  
    --更新采集信息(检验和采集） 
    Update /*+ rule */ 病人医嘱发送
    Set 采样人 = 人员姓名_In, 采样时间 = Sysdate, 执行状态 = Decode(执行状态, 2, 0, 执行状态),
        重采标本 = Decode(Nvl(重采标本, 0), 0, Decode(执行状态, 2, 1, 0), 重采标本), 执行说明 = Null
    Where 医嘱id In (Select * From Table(Cast(f_Num2list(医嘱内容_In) As Zltools.t_Numlist)));
  
    --更新医嘱和费用记录 
    For r_Samplequest In c_Samplequest(医嘱内容_In) Loop
      If r_Samplequest.病人来源 = 2 Then
        --2.费用执行处理 
        Update 住院费用记录
        Set 执行状态 = 1, 执行时间 = Sysdate, 执行人 = 人员姓名_In
        Where 收费类别 Not In ('5', '6', '7') And
              (医嘱序号, 记录性质, No) In
              (Select 医嘱id, 记录性质, No
               From 病人医嘱附费
               Where 医嘱id = r_Samplequest.医嘱id
               Union All
               Select 医嘱id, 记录性质, No
               From 病人医嘱发送
               Where 医嘱id In (Select Id
                              From 病人医嘱记录 a, 病人医嘱发送 b
                              Where a.Id = b.医嘱id And r_Samplequest.医嘱id In (a.Id) And Sign(Nvl(a.相关id, 0)) = 医嘱类别_In And
                                    b.执行状态 In (0, 2) And b.接收人 Is Null));
      Else
        --发料
        If n_自动发料 = 1 Then
          For c_Stuff In (Select a.记录性质, a.记录状态, b.Id, b.库房id
                          From 门诊费用记录 a, 药品收发记录 b
                          Where a.Id = b.费用id And a.收费类别 = '4' And b.审核人 Is Null And
                                (a.医嘱序号, a.记录性质, a.No) In
                                (Select 医嘱id, 记录性质, No
                                 From 病人医嘱附费
                                 Where 医嘱id = r_Samplequest.医嘱id
                                 Union All
                                 Select 医嘱id, 记录性质, No
                                 From 病人医嘱发送
                                 Where 医嘱id In (Select Id
                                                From 病人医嘱记录 a, 病人医嘱发送 b
                                                Where a.Id = b.医嘱id And r_Samplequest.医嘱id In (a.Id) And a.相关id Is Null And
                                                      b.执行状态 In (0, 2) And b.接收人 Is Null))) Loop
            If Mod(Nvl(c_Stuff.记录性质, 0), 10) = 1 And Nvl(c_Stuff.记录状态, 0) = 1 Then
              If n_发料号 Is Null Then
                n_发料号 := Nextno(20);
              End If;
            
              If c_Stuff.库房id <> Nvl(n_库房id, 0) Then
                If Nvl(n_库房id, 0) <> 0 And v_收发ids Is Not Null Then
                  v_收发ids := Substr(v_收发ids, 2);
                  Zl_药品收发记录_批量发料(v_收发ids, n_库房id, 人员姓名_In, Sysdate, 1, 人员姓名_In, n_发料号, 人员姓名_In);
                End If;
              
                n_库房id  := c_Stuff.库房id;
                v_收发ids := Null;
              End If;
            
              v_收发ids := v_收发ids || '|' || c_Stuff.Id || ',0';
            End If;
          End Loop;
          If Nvl(n_库房id, 0) <> 0 And v_收发ids Is Not Null Then
            v_收发ids := Substr(v_收发ids, 2);
            Zl_药品收发记录_批量发料(v_收发ids, n_库房id, 人员姓名_In, Sysdate, 1, 人员姓名_In, n_发料号, 人员姓名_In);
          End If;
        End If;
      
        --2.费用执行处理 
        Update 门诊费用记录
        Set 执行状态 = 1, 执行时间 = Sysdate, 执行人 = 人员姓名_In
        Where 收费类别 Not In ('5', '6', '7') And
              (医嘱序号, 记录性质, No) In
              (Select 医嘱id, 记录性质, No
               From 病人医嘱附费
               Where 医嘱id = r_Samplequest.医嘱id
               Union All
               Select 医嘱id, 记录性质, No
               From 病人医嘱发送
               Where 医嘱id In (Select Id
                              From 病人医嘱记录 a, 病人医嘱发送 b
                              Where a.Id = b.医嘱id And r_Samplequest.医嘱id In (a.Id) And Sign(Nvl(a.相关id, 0)) = 医嘱类别_In And
                                    b.执行状态 In (0, 2) And b.接收人 Is Null));
      End If;
    End Loop;
  
    --更新执行状态(只更新采集） 
    Update /*+ rule */ 病人医嘱发送
    Set 执行状态 = 1, 完成人 = 人员姓名_In, 完成时间 = Sysdate
    Where 医嘱id In (Select Id
                   From 病人医嘱记录
                   Where Id In (Select * From Table(Cast(f_Num2list(医嘱内容_In) As Zltools.t_Numlist))) And
                         Sign(Nvl(相关id, 0)) = 医嘱类别_In);
    --执行后自动审核对应的记帐划价单(不包含药品)
    Select Zl_To_Number(Nvl(Zl_Getsysparameter(81), '0')) Into v_执行 From Dual;
    --3.自动审核记帐 
    For r_Verify In c_Verify(医嘱内容_In) Loop
      If r_Verify.No || ',' || r_Verify.记录性质 <> v_No || ',' || v_性质 Then
        If v_序号 Is Not Null Then
          If v_性质 = 1 Then
            Zl_门诊记帐记录_Verify(v_No, 人员编号_In, 人员姓名_In, Substr(v_序号, 2));
          Elsif v_性质 = 2 Then
            Zl_住院记帐记录_Verify(v_No, 人员编号_In, 人员姓名_In, Substr(v_序号, 2));
          End If;
        End If;
        v_序号 := Null;
      End If;
      v_No   := r_Verify.No;
      v_性质 := r_Verify.记录性质;
      v_序号 := v_序号 || ',' || r_Verify.序号;
    End Loop;
    If v_序号 Is Not Null Then
      If v_性质 = 1 Then
        Zl_门诊记帐记录_Verify(v_No, 人员编号_In, 人员姓名_In, Substr(v_序号, 2));
      Elsif v_性质 = 2 Then
        Zl_住院记帐记录_Verify(v_No, 人员编号_In, 人员姓名_In, Substr(v_序号, 2));
      End If;
    End If;
  
  Else
    --检查标本是否被核收或接收 
    Begin
      Select /*+ rule */
       Nvl(c.Id, 0), b.执行状态, b.接收人
      Into v_检验标本记录, v_执行状态, v_接收人
      From 病人医嘱记录 a, 病人医嘱发送 b, 检验标本记录 c
      Where a.Id = b.医嘱id And a.相关id = c.医嘱id(+) And
            a.Id In (Select * From Table(Cast(f_Num2list(医嘱内容_In) As Zltools.t_Numlist)));
    Exception
      When Others Then
        v_检验标本记录 := 0;
    End;
  
    If v_检验标本记录 <> 0 Then
      v_Error := '标本已被检验科核收不能取消完成采集!';
      Raise Err_Custom;
    End If;
  
    If v_执行状态 <> 2 And v_接收人 Is Not Null Then
      v_Error := '标本已被检验科签收不能取消完成采集!';
      Raise Err_Custom;
    End If;
  
    Update /*+ rule */ 病人医嘱发送
    Set 采样人 = Null, 采样时间 = Null, 执行状态 = 0, 执行说明 = Null, 完成人 = Null, 完成时间 = Null
    Where 医嘱id In (Select Id
                   From 病人医嘱记录
                   Where Id In (Select * From Table(Cast(f_Num2list(医嘱内容_In) As Zltools.t_Numlist))));
  
    For r_Samplequest In c_Samplequest(医嘱内容_In) Loop
    
      If r_Samplequest.病人来源 = 2 Then
        --2.费用执行处理 
        Update 住院费用记录
        Set 执行状态 = 0, 执行时间 = Null, 执行人 = 人员姓名_In
        Where 收费类别 Not In ('5', '6', '7') And
              (医嘱序号, 记录性质, No) In
              (Select 医嘱id, 记录性质, No
               From 病人医嘱附费
               Where 医嘱id = r_Samplequest.医嘱id
               Union All
               Select 医嘱id, 记录性质, No
               From 病人医嘱发送
               Where 医嘱id In (Select Id
                              From 病人医嘱记录
                              Where r_Samplequest.医嘱id In (Id) And Sign(Nvl(相关id, 0)) = 医嘱类别_In) And 执行状态 In (0, 2) And
                     接收人 Is Null);
      Else
        --退料
        If n_自动发料 = 1 Then
          For c_Stuff In (Select b.Id, b.实际数量
                          From 门诊费用记录 a, 药品收发记录 b
                          Where a.Id = b.费用id And a.收费类别 = '4' And (b.记录状态 = 1 Or Mod(b.记录状态, 3) = 0) And
                                b.审核人 Is Not Null And
                                (a.医嘱序号, a.记录性质, a.No) In
                                (Select 医嘱id, 记录性质, No
                                 From 病人医嘱附费
                                 Where 医嘱id = r_Samplequest.医嘱id
                                 Union All
                                 Select 医嘱id, 记录性质, No
                                 From 病人医嘱发送
                                 Where 医嘱id In
                                       (Select Id From 病人医嘱记录 Where r_Samplequest.医嘱id In (Id) And 相关id Is Null) And
                                       执行状态 In (0, 2) And 接收人 Is Null)) Loop
          
            Zl_材料收发记录_部门退料(c_Stuff.Id, 人员姓名_In, Sysdate, Null, Null, Null, c_Stuff.实际数量);
          End Loop;
        End If;
        --退费
        Update 门诊费用记录
        Set 执行状态 = 0, 执行时间 = Null, 执行人 = 人员姓名_In
        Where 收费类别 Not In ('5', '6', '7') And
              (医嘱序号, 记录性质, No) In
              (Select 医嘱id, 记录性质, No
               From 病人医嘱附费
               Where 医嘱id = r_Samplequest.医嘱id
               Union All
               Select 医嘱id, 记录性质, No
               From 病人医嘱发送
               Where 医嘱id In (Select Id
                              From 病人医嘱记录
                              Where r_Samplequest.医嘱id In (Id) And Sign(Nvl(相关id, 0)) = 医嘱类别_In) And 执行状态 In (0, 2) And
                     接收人 Is Null);
      End If;
    End Loop;
  End If;

Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    Zl_Errorcenter(Sqlcode, Sqlerrm);
End Zl_检验预置条码_采集完成;
/



--101685:胡俊勇,2017-01-09,输血流程变动
Create Or Replace Procedure Zl_病人医嘱记录_未用
(
  医嘱id_In     病人医嘱记录.Id%Type,
  标记_In       病人医嘱记录.执行标记%Type,
  血库_In       病人医嘱记录.执行标记%Type := Null,
  回退_In       病人医嘱记录.执行标记%Type := Null,
  原因_In       病人医嘱状态.操作说明%Type := Null,
  操作员姓名_In 人员表.姓名%Type := Null
) Is
  --医嘱ID_IN：组医嘱ID
  --血库_In：1－表是输血医嘱经过血库
  --回退_In：是否回退医嘱发送，1－表示不回退医嘱
  --原因_In：标记为未用的原因
  r_Advice   病人医嘱记录%RowType;
  v_操作类型 诊疗项目目录.操作类型%Type;
  v_执行频率 诊疗项目目录.执行频率%Type;
  v_人员姓名 病人医嘱状态.操作人员%Type;
  v_Temp     Varchar2(255);

  v_Error Varchar2(255);
  Err_Custom Exception;
Begin
  Begin
    Select * Into r_Advice From 病人医嘱记录 Where ID = 医嘱id_In;
  Exception
    When Others Then
      v_Error := '没有发现医嘱信息。';
      Raise Err_Custom;
  End;
  If 标记_In = 0 Then
    If Nvl(r_Advice.执行标记, 0) <> -1 Then
      v_Error := '该医嘱没有标记为未用。';
      Raise Err_Custom;
    End If;
  Elsif 标记_In = -1 Then
    If r_Advice.执行标记 = -1 Then
      v_Error := '该医嘱已经标记为未用。';
      Raise Err_Custom;
    End If;
    If r_Advice.医嘱状态 In (1, 2) Then
      v_Error := '当前医嘱还没有校对，不允许设置为未用。';
      Raise Err_Custom;
    End If;
    If r_Advice.医嘱状态 = 4 Then
      v_Error := '当前医嘱已经作废，不允许设置为未用。';
      Raise Err_Custom;
    End If;
    If Nvl(r_Advice.医嘱期效, 0) = 0 And r_Advice.上次执行时间 Is Not Null Then
      v_Error := '当前长期医嘱已经发送，不允许设置为未用。';
      Raise Err_Custom;
    End If;
    If Nvl(r_Advice.医嘱期效, 0) = 0 And r_Advice.医嘱状态 In (8, 9) Then
      If r_Advice.医嘱状态 = 8 Then
        v_Error := '当前长期医嘱已经停止，不允许设置为未用。';
      Else
        v_Error := '当前长期医嘱已经确认停止，不允许设置为未用。';
      End If;
      Raise Err_Custom;
    End If;
    If r_Advice.皮试结果 Is Not Null Then
      v_Error := '当前皮试医嘱已经标注皮试结果，不允许设置为未用。';
      Raise Err_Custom;
    End If;
    --持续性护理等级无须发送，校对后就可能已自动计费，作废及回退作废都应按停止流程处理。
    If r_Advice.诊疗类别 = 'H' Then
      Select 操作类型, 执行频率 Into v_操作类型, v_执行频率 From 诊疗项目目录 Where ID = r_Advice.诊疗项目id;
      If v_操作类型 = '1' And v_执行频率 = '2' Then
        v_Error := '护理等级医嘱校对后即生效，不能被标记未用，请使用停止操作。';
        Raise Err_Custom;
      End If;
    End If;
  
    If r_Advice.医嘱期效 = 1 And r_Advice.医嘱状态 = 8 And 标记_In = -1 And Nvl(回退_In, 0) <> 1 Then
      Zl_病人医嘱记录_回退(医嘱id_In);
    End If;
  End If;

  Update 病人医嘱记录 Set 执行标记 = 标记_In Where ID = 医嘱id_In Or 相关id = 医嘱id_In;
  
  If 血库_In = 1 Then
    If 标记_In = -1 Then
      
      If 操作员姓名_In Is Not Null Then
        v_人员姓名 := 操作员姓名_In;
      Else
        v_Temp     := Zl_Identity;
        v_Temp     := Substr(v_Temp, Instr(v_Temp, ';') + 1);
        v_Temp     := Substr(v_Temp, Instr(v_Temp, ',') + 1);
        v_人员姓名 := Substr(v_Temp, Instr(v_Temp, ',') + 1);
      End If;
    
      Insert Into 病人医嘱状态
        (医嘱id, 操作类型, 操作人员, 操作时间, 操作说明)
      Values
        (医嘱id_In, 20, v_人员姓名, Sysdate - 2 / 60 / 60 / 24, 原因_In);
    Else
      Delete 病人医嘱状态 Where 医嘱id = 医嘱id_In And 操作类型 = 20;
    End If;
  End If;
  
Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_病人医嘱记录_未用;
/

--101301:刘鹏飞,2017-01-04,诊疗项目管理增加输血采集方式
Create Or Replace Procedure Zl_诊疗项目_Insert
(
  类别_In             In 诊疗项目目录.类别%Type := Null,
  分类id_In           In 诊疗项目目录.分类id%Type := Null,
  Id_In               In 诊疗项目目录.Id%Type,
  编码_In             In 诊疗项目目录.编码%Type := Null,
  名称_In             In 诊疗项目目录.名称%Type := Null,
  名称拼音_In         In 诊疗项目别名.简码%Type := Null,
  名称五笔_In         In 诊疗项目别名.简码%Type := Null,
  别名_In             诊疗项目目录.名称%Type := Null,
  别名拼音_In         诊疗项目别名.简码%Type := Null,
  别名五笔_In         诊疗项目别名.简码%Type := Null,
  操作类型_In         In 诊疗项目目录.操作类型%Type := Null,
  执行频率_In         In 诊疗项目目录.执行频率%Type := Null,
  单独应用_In         In 诊疗项目目录.单独应用%Type := Null,
  计算方式_In         In 诊疗项目目录.计算方式%Type := Null,
  计算单位_In         In 诊疗项目目录.计算单位%Type := Null,
  适用性别_In         In 诊疗项目目录.适用性别%Type := Null,
  执行安排_In         In 诊疗项目目录.执行安排%Type := Null,
  服务对象_In         In 诊疗项目目录.服务对象%Type := Null,
  组合项目_In         In 诊疗项目目录.组合项目%Type := Null,
  标本部位_In         In 诊疗项目目录.标本部位%Type := Null,
  手术操作id_In       In 疾病诊断对照.疾病id%Type := Null,
  执行科室_In         In 诊疗项目目录.执行科室%Type := Null,
  门诊执行_In         In 诊疗执行科室.执行科室id%Type := Null,
  住院执行_In         In 诊疗执行科室.执行科室id%Type := Null,
  定向执行_In         In Varchar2, --开单科室定向执行的说明串，以'|'分割，每个定向按'开单科室id^执行科室id'形式组织
  参考目录id_In       In 诊疗项目目录.参考目录id%Type := Null,
  应用范围_In         In Number := 0,
  录入限量_In         In 诊疗项目目录.录入限量%Type := Null,
  限量范围_In         In Number := 0,
  执行标记_In         In Number := 0,
  执行分类_In         In 诊疗项目目录.执行分类%Type := 0,
  站点_In             In 诊疗项目目录.站点%Type := Null,
  项目频率_In         In Varchar2 := Null, --该项目的频率设置串：编码|编码......
  计算规则_In         In 诊疗项目目录.计算规则%Type := Null,
  使用科室_In         In Varchar2 := Null, --使用科室的IDs,用逗号分隔
  使用科室应用范围_In In Number := 0, --使用科室应用的范围  0-本项，1-应用于同级，2-分类下所有，3-应用于当前类别
  First_In            In Number := 1, --First：1-需要删除执行科室，再新增，0-不删除执行科室，直接新增
  计算系数_In         In 诊疗项目目录.计算系数%Type := Null,
  输血检验对照_In     In Varchar2 := Null,
  试管编码_In         In 诊疗项目目录.试管编码%Type := Null
) Is
  Type t_诊疗项目 Is Ref Cursor;
  c_诊疗项目   t_诊疗项目;
  t_Id         t_Numlist;
  v_Id         诊疗项目目录.Id%Type;
  v_Records    Varchar2(4000); --临时记录开单科室定向执行科室的字符串
  v_Currrec    Varchar2(1000); --包含在定向执行科室字符串中的一个定向
  v_Fields     Varchar2(1000);
  v_开单科室id 诊疗执行科室.开单科室id%Type := Null;
  v_执行科室id 诊疗执行科室.执行科室id%Type := Null;
  n_序号       Number;
  v_编号       Varchar2(1000);
  v_Strtmp     Varchar2(1000);
  v_Strinput   Varchar2(1000);
Begin
  If First_In = 1 Then
    Insert Into 诊疗项目目录
      (类别, 分类id, Id, 编码, 名称, 操作类型, 执行频率, 单独应用, 计算方式, 计算单位, 适用性别, 执行安排, 服务对象, 执行科室, 组合项目, 标本部位, 建档时间, 撤档时间, 参考目录id, 录入限量,
       执行标记, 执行分类, 计算规则, 站点, 计算系数, 试管编码)
    Values
      (类别_In, 分类id_In, Id_In, 编码_In, 名称_In, 操作类型_In, 执行频率_In, 单独应用_In, 计算方式_In, 计算单位_In, 适用性别_In, 执行安排_In, 服务对象_In,
       执行科室_In, 组合项目_In, Decode(类别_In, 'D', Decode(组合项目_In, 1, '', 标本部位_In), 标本部位_In), Sysdate,
       To_Date('3000-01-01', 'YYYY-MM-DD'), 参考目录id_In, 录入限量_In, 执行标记_In, 执行分类_In, 计算规则_In, 站点_In, 计算系数_In, 试管编码_In);
    If 手术操作id_In Is Not Null Then
      Insert Into 疾病诊断对照 (疾病id, 诊断id, 手术id) Values (手术操作id_In, Null, Id_In);
    End If;
    If 名称拼音_In Is Not Null Then
      Insert Into 诊疗项目别名 (诊疗项目id, 名称, 性质, 简码, 码类) Values (Id_In, 名称_In, 1, 名称拼音_In, 1);
    End If;
    If 名称五笔_In Is Not Null Then
      Insert Into 诊疗项目别名 (诊疗项目id, 名称, 性质, 简码, 码类) Values (Id_In, 名称_In, 1, 名称五笔_In, 2);
    End If;
    If 别名_In Is Not Null And 别名拼音_In Is Not Null Then
      Insert Into 诊疗项目别名 (诊疗项目id, 名称, 性质, 简码, 码类) Values (Id_In, 别名_In, 9, 别名拼音_In, 1);
    End If;
    If 别名_In Is Not Null And 别名五笔_In Is Not Null Then
      Insert Into 诊疗项目别名 (诊疗项目id, 名称, 性质, 简码, 码类) Values (Id_In, 别名_In, 9, 别名五笔_In, 2);
    End If;
  End If;
  If 应用范围_In = 1 Then
    If 分类id_In Is Null Then
      Open c_诊疗项目 For
        Select Id From 诊疗项目目录 Where 分类id Is Null Order By 编码;
    Else
      Open c_诊疗项目 For
        Select Id From 诊疗项目目录 Where 分类id = 分类id_In Order By 编码;
    End If;
  Elsif 应用范围_In = 2 Then
    If 分类id_In Is Null Then
      Open c_诊疗项目 For
        Select c.Id
        From 诊疗项目目录 c, (Select Id From 诊疗分类目录 Start With 上级id Is Null Connect By Prior Id = 上级id) d
        Where d.Id = c.分类id
        Order By 编码;
    Else
      Open c_诊疗项目 For
        Select c.Id
        From 诊疗项目目录 c, (Select Id From 诊疗分类目录 Start With Id = 分类id_In Connect By Prior Id = 上级id) d
        Where d.Id = c.分类id
        Order By 编码;
    End If;
  Elsif 应用范围_In = 3 Then
    Open c_诊疗项目 For
      Select Id From 诊疗项目目录 Where 类别 = 类别_In Order By 编码;
  Else
    Open c_诊疗项目 For
      Select Id From 诊疗项目目录 Where Id = Id_In;
  End If;

  Loop
    Fetch c_诊疗项目
      Into v_Id;
    Exit When c_诊疗项目%Notfound;
  
    If First_In = 1 Then
      Delete From 诊疗执行科室 Where 诊疗项目id = v_Id;
      If 执行科室_In = 4 And 门诊执行_In Is Not Null Then
        Insert Into 诊疗执行科室 (诊疗项目id, 病人来源, 开单科室id, 执行科室id) Values (v_Id, 1, Null, 门诊执行_In);
      End If;
      If 执行科室_In = 4 And 住院执行_In Is Not Null Then
        Insert Into 诊疗执行科室 (诊疗项目id, 病人来源, 开单科室id, 执行科室id) Values (v_Id, 2, Null, 住院执行_In);
      End If;
    End If;
    If 执行科室_In <> 4 Or 定向执行_In Is Null Then
      v_Records := Null;
    Else
      v_Records := 定向执行_In || '|';
    End If;
  
    While v_Records Is Not Null Loop
      v_Currrec    := Substr(v_Records, 1, Instr(v_Records, '|') - 1);
      v_Fields     := v_Currrec;
      v_开单科室id := To_Number(Substr(v_Fields, 1, Instr(v_Fields, '^') - 1));
      v_Fields     := Substr(v_Fields, Instr(v_Fields, '^') + 1);
      v_执行科室id := To_Number(v_Fields);
      Insert Into 诊疗执行科室
        (诊疗项目id, 病人来源, 开单科室id, 执行科室id)
      Values
        (v_Id, Null, Decode(v_开单科室id, 0, Null, v_开单科室id), v_执行科室id);
      v_Records := Replace('|' || v_Records, '|' || v_Currrec || '|');
    End Loop;
    If 应用范围_In <> 0 Then
      Update 诊疗项目目录 Set 执行科室 = 执行科室_In Where Id = v_Id;
    End If;
  End Loop;
  Close c_诊疗项目;

  If First_In = 1 Then
    If 类别_In = 'C' Or 类别_In = 'F' Or 类别_In = 'K' Then
      Insert Into 病历单据应用
        (病历文件id, 应用场合, 诊疗项目id)
        Select a.病历文件id, 1, Id_In
        From 病历单据应用 a, 诊疗项目目录 i
        Where a.诊疗项目id = i.Id And i.类别 = 类别_In And 应用场合 = 1 And (服务对象_In = 0 Or 服务对象_In = 1) And Rownum < 2;
      Insert Into 病历单据应用
        (病历文件id, 应用场合, 诊疗项目id)
        Select a.病历文件id, 2, Id_In
        From 病历单据应用 a, 诊疗项目目录 i
        Where a.诊疗项目id = i.Id And i.类别 = 类别_In And 应用场合 = 2 And (服务对象_In = 0 Or 服务对象_In = 2) And Rownum < 2;
    Elsif 类别_In = 'D' Or 类别_In = 'E' Then
      Insert Into 病历单据应用
        (病历文件id, 应用场合, 诊疗项目id)
        Select a.病历文件id, 1, Id_In
        From 病历单据应用 a, 诊疗项目目录 i
        Where a.诊疗项目id = i.Id And i.类别 = 类别_In And 操作类型 = 操作类型_In And 应用场合 = 1 And (服务对象_In = 0 Or 服务对象_In = 1) And
              Rownum < 2;
      Insert Into 病历单据应用
        (病历文件id, 应用场合, 诊疗项目id)
        Select a.病历文件id, 2, Id_In
        From 病历单据应用 a, 诊疗项目目录 i
        Where a.诊疗项目id = i.Id And i.类别 = 类别_In And 操作类型 = 操作类型_In And 应用场合 = 2 And (服务对象_In = 0 Or 服务对象_In = 2) And
              Rownum < 2;
    End If;
  End If;

  If 限量范围_In = 1 Then
    If 分类id_In Is Null Then
      Update 诊疗项目目录 Set 录入限量 = 录入限量_In Where 分类id Is Null;
    Else
      Update 诊疗项目目录 Set 录入限量 = 录入限量_In Where 分类id = 分类id_In;
    End If;
  Elsif 限量范围_In = 2 Then
    If 分类id_In Is Null Then
      Update 诊疗项目目录
      Set 录入限量 = 录入限量_In
      Where 分类id In (Select Id From 诊疗分类目录 Start With 上级id Is Null Connect By Prior Id = 上级id);
    Else
      Update 诊疗项目目录
      Set 录入限量 = 录入限量_In
      Where 分类id In (Select Id From 诊疗分类目录 Start With Id = 分类id_In Connect By Prior Id = 上级id);
    End If;
  Elsif 限量范围_In = 3 Then
    Update 诊疗项目目录 Set 录入限量 = 录入限量_In Where 类别 = 类别_In;
  Elsif 限量范围_In = 4 Then
    Update 诊疗项目目录 Set 录入限量 = 录入限量_In;
  End If;

  --该项目的频率设置
  If 类别_In <> 'C' Then
    Delete 诊疗用法用量 Where 项目id = Id_In;
    If 项目频率_In Is Not Null Then
      v_Strinput := 项目频率_In || '|';
      n_序号     := 0;
    
      While v_Strinput Is Not Null Loop
        v_Strtmp := Substr(v_Strinput, 1, Instr(v_Strinput, '|') - 1);
        v_编号   := v_Strtmp;
        n_序号   := n_序号 + 1;
      
        Insert Into 诊疗用法用量 (项目id, 性质, 频次) Values (Id_In, n_序号, v_编号);
        v_Strinput := Replace('|' || v_Strinput, '|' || v_Strtmp || '|');
      End Loop;
    End If;
  End If;
  --使用科室
  If 使用科室应用范围_In = 1 Then
    If 分类id_In Is Null Then
      Open c_诊疗项目 For
        Select Id From 诊疗项目目录 Where 分类id Is Null Order By 编码;
    Else
      Open c_诊疗项目 For
        Select Id From 诊疗项目目录 Where 分类id = 分类id_In Order By 编码;
    End If;
  Elsif 使用科室应用范围_In = 2 Then
    If 分类id_In Is Null Then
      Open c_诊疗项目 For
        Select c.Id
        From 诊疗项目目录 c, (Select Id From 诊疗分类目录 Start With 上级id Is Null Connect By Prior Id = 上级id) d
        Where d.Id = c.分类id
        Order By 编码;
    Else
      Open c_诊疗项目 For
        Select c.Id
        From 诊疗项目目录 c, (Select Id From 诊疗分类目录 Start With Id = 分类id_In Connect By Prior Id = 上级id) d
        Where d.Id = c.分类id
        Order By 编码;
    End If;
  Elsif 使用科室应用范围_In = 3 Then
    Open c_诊疗项目 For
      Select Id From 诊疗项目目录 Where 类别 = 类别_In Order By 编码;
  Else
    Open c_诊疗项目 For
      Select Id From 诊疗项目目录 Where Id = Id_In;
  End If;
  Fetch c_诊疗项目 Bulk Collect
    Into t_Id;
  Close c_诊疗项目;

  Forall i In 1 .. t_Id.Count
    Delete 诊疗适用科室 Where 项目id = t_Id(i) And Instr(',' || 使用科室_In || ',', ',' || 科室id || ',') = 0;

  If 使用科室_In Is Not Null Then
    Forall i In 1 .. t_Id.Count
      Insert Into 诊疗适用科室
        (项目id, 科室id)
        Select t_Id(i), Column_Value
        From Table(f_Num2list(使用科室_In)) a
        Where Not Exists (Select 1 From 诊疗适用科室 Where 科室id = Column_Value And 项目id = t_Id(i));
  End If;
  --输血检验对照
  If 类别_In = 'K' And 输血检验对照_In Is Not Null Then
    v_Strinput := 输血检验对照_In || '|';
  
    While v_Strinput Is Not Null Loop
      v_Strtmp := Substr(v_Strinput, 1, Instr(v_Strinput, '|') - 1);
      v_Id     := v_Strtmp;
    
      Insert Into 输血检验对照 (项目id, 检验项目id) Values (Id_In, v_Id);
      v_Strinput := Replace('|' || v_Strinput, '|' || v_Strtmp || '|');
    End Loop;
  End If;

Exception
  When Others Then
    Zl_Errorcenter(Sqlcode, Sqlerrm);
End Zl_诊疗项目_Insert;
/

--101301:刘鹏飞,2017-01-04,诊疗项目管理增加输血采集方式
Create Or Replace Procedure Zl_诊疗项目_Update
(
  类别_In             In 诊疗项目目录.类别%Type := Null,
  分类id_In           In 诊疗项目目录.分类id%Type := Null,
  Id_In               In 诊疗项目目录.Id%Type,
  编码_In             In 诊疗项目目录.编码%Type := Null,
  名称_In             In 诊疗项目目录.名称%Type := Null,
  名称拼音_In         In 诊疗项目别名.简码%Type := Null,
  名称五笔_In         In 诊疗项目别名.简码%Type := Null,
  别名_In             诊疗项目目录.名称%Type := Null,
  别名拼音_In         诊疗项目别名.简码%Type := Null,
  别名五笔_In         诊疗项目别名.简码%Type := Null,
  操作类型_In         In 诊疗项目目录.操作类型%Type := Null,
  执行频率_In         In 诊疗项目目录.执行频率%Type := Null,
  单独应用_In         In 诊疗项目目录.单独应用%Type := Null,
  计算方式_In         In 诊疗项目目录.计算方式%Type := Null,
  计算单位_In         In 诊疗项目目录.计算单位%Type := Null,
  适用性别_In         In 诊疗项目目录.适用性别%Type := Null,
  执行安排_In         In 诊疗项目目录.执行安排%Type := Null,
  服务对象_In         In 诊疗项目目录.服务对象%Type := Null,
  组合项目_In         In 诊疗项目目录.组合项目%Type := Null,
  标本部位_In         In 诊疗项目目录.标本部位%Type := Null,
  手术操作id_In       In 疾病诊断对照.疾病id%Type := Null,
  执行科室_In         In 诊疗项目目录.执行科室%Type := Null,
  门诊执行_In         In 诊疗执行科室.执行科室id%Type := Null,
  住院执行_In         In 诊疗执行科室.执行科室id%Type := Null,
  定向执行_In         In Varchar2, --开单科室定向执行的说明串，以'|'分割，每个定向按'开单科室id^执行科室id'形式组织
  参考目录id_In       In 诊疗项目目录.参考目录id%Type := Null,
  不处理执行科室_In   In Number := 0,
  应用范围_In         In Number := 0,
  录入限量_In         In 诊疗项目目录.录入限量%Type := Null,
  限量范围_In         In Number := 0,
  执行标记_In         In Number := 0,
  执行分类_In         In 诊疗项目目录.执行分类%Type := 0,
  站点_In             In 诊疗项目目录.站点%Type := Null,
  项目频率_In         In Varchar2 := Null, --该项目的频率设置串：编码|编码......
  计算规则_In         In 诊疗项目目录.计算规则%Type := Null,
  使用科室_In         In Varchar2 := Null, --使用科室的IDs,用逗号分隔
  使用科室应用范围_In In Number := 0, --使用科室应用的范围  0-本项，1-应用于同级，2-分类下所有，3-应用于当前类别
  First_In            In Number := 1, --First：1-需要删除执行科室，再新增，0-不删除执行科室，直接新增
  计算系数_In         In 诊疗项目目录.计算系数%Type := Null,
  输血检验对照_In     In Varchar2 := Null,
  试管编码_In         In 诊疗项目目录.试管编码%Type := Null
) Is
  Type t_诊疗项目 Is Ref Cursor;
  c_诊疗项目   t_诊疗项目;
  v_Id         诊疗项目目录.Id%Type;
  t_Id         t_Numlist;
  v_Records    Varchar2(4000); --临时记录开单科室定向执行科室的字符串
  v_Currrec    Varchar2(1000); --包含在定向执行科室字符串中的一个定向
  v_Fields     Varchar2(1000);
  v_开单科室id 诊疗执行科室.开单科室id%Type := Null;
  v_执行科室id 诊疗执行科室.执行科室id%Type := Null;
  n_序号       Number;
  v_编号       Varchar2(1000);
  v_Strtmp     Varchar2(1000);
  v_Strinput   Varchar2(1000);
  Err_Notfind Exception;
Begin
  If 不处理执行科室_In = 0 Then
  
    Update 路径医嘱内容 Set 执行性质 = 执行科室_In Where 诊疗项目id = Id_In;
    Update 诊疗项目组合 Set 执行性质 = 执行科室_In Where 诊疗项目id = Id_In;
  
    Update 诊疗项目目录
    Set 类别 = 类别_In, 分类id = 分类id_In, 编码 = 编码_In, 名称 = 名称_In, 操作类型 = 操作类型_In, 执行频率 = 执行频率_In, 单独应用 = 单独应用_In,
        计算方式 = 计算方式_In, 计算单位 = 计算单位_In, 适用性别 = 适用性别_In, 执行安排 = 执行安排_In, 服务对象 = 服务对象_In, 执行科室 = 执行科室_In, 组合项目 = 组合项目_In,
        标本部位 = Decode(类别_In, 'D', Decode(组合项目_In, 1, '', 标本部位_In), 标本部位_In), 参考目录id = 参考目录id_In, 录入限量 = 录入限量_In,
        执行标记 = 执行标记_In, 执行分类 = 执行分类_In, 计算规则 = 计算规则_In, 站点 = 站点_In, 计算系数 = 计算系数_In,
        试管编码 = Decode(类别_In, 'E', Decode(操作类型_In, 9, 试管编码_In, 试管编码), 试管编码)
    Where Id = Id_In;
  
  Else
    Update 诊疗项目目录
    Set 分类id = 分类id_In, 编码 = 编码_In, 名称 = 名称_In, 操作类型 = 操作类型_In, 执行频率 = 执行频率_In, 单独应用 = 单独应用_In, 计算方式 = 计算方式_In,
        计算单位 = 计算单位_In, 适用性别 = 适用性别_In, 执行安排 = 执行安排_In, 服务对象 = 服务对象_In, 组合项目 = 组合项目_In, 录入限量 = 录入限量_In,
        标本部位 = Decode(类别_In, 'D', Decode(组合项目_In, 1, '', 标本部位_In), 标本部位_In), 执行分类 = 执行分类_In, 计算规则 = 计算规则_In, 站点 = 站点_In,
        计算系数 = 计算系数_In
    Where Id = Id_In;
  End If;
  If Sql%Rowcount = 0 Then
    Raise Err_Notfind;
  End If;
  If 不处理执行科室_In = 0 Then
    If 手术操作id_In Is Null Then
      Delete 疾病诊断对照 Where 手术id = Id_In;
    Else
      Update 疾病诊断对照 Set 疾病id = 手术操作id_In Where 手术id = Id_In;
      If Sql%Rowcount = 0 Then
        Insert Into 疾病诊断对照 (疾病id, 诊断id, 手术id) Values (手术操作id_In, Null, Id_In);
      End If;
    End If;
  End If;

  If 名称拼音_In Is Null Then
    Delete 诊疗项目别名 Where 诊疗项目id = Id_In And 性质 = 1 And 码类 = 1;
  Else
    Update 诊疗项目别名 Set 名称 = 名称_In, 简码 = 名称拼音_In Where 诊疗项目id = Id_In And 性质 = 1 And 码类 = 1;
    If Sql%Rowcount = 0 Then
      Insert Into 诊疗项目别名 (诊疗项目id, 名称, 性质, 简码, 码类) Values (Id_In, 名称_In, 1, 名称拼音_In, 1);
    End If;
  End If;
  If 名称五笔_In Is Null Then
    Delete 诊疗项目别名 Where 诊疗项目id = Id_In And 性质 = 1 And 码类 = 2;
  Else
    Update 诊疗项目别名 Set 名称 = 名称_In, 简码 = 名称五笔_In Where 诊疗项目id = Id_In And 性质 = 1 And 码类 = 2;
    If Sql%Rowcount = 0 Then
      Insert Into 诊疗项目别名 (诊疗项目id, 名称, 性质, 简码, 码类) Values (Id_In, 名称_In, 1, 名称五笔_In, 2);
    End If;
  End If;

  If 别名_In Is Null Then
    Delete 诊疗项目别名 Where 诊疗项目id = Id_In And 性质 = 9;
  Else
    If 别名拼音_In Is Null Then
      Delete 诊疗项目别名 Where 诊疗项目id = Id_In And 性质 = 9 And 码类 = 1;
    Else
      Update 诊疗项目别名 Set 名称 = 别名_In, 简码 = 别名拼音_In Where 诊疗项目id = Id_In And 性质 = 9 And 码类 = 1;
      If Sql%Rowcount = 0 Then
        Insert Into 诊疗项目别名 (诊疗项目id, 名称, 性质, 简码, 码类) Values (Id_In, 别名_In, 9, 别名拼音_In, 1);
      End If;
    End If;
    If 别名五笔_In Is Null Then
      Delete 诊疗项目别名 Where 诊疗项目id = Id_In And 性质 = 9 And 码类 = 2;
    Else
      Update 诊疗项目别名 Set 名称 = 别名_In, 简码 = 别名五笔_In Where 诊疗项目id = Id_In And 性质 = 9 And 码类 = 2;
      If Sql%Rowcount = 0 Then
        Insert Into 诊疗项目别名 (诊疗项目id, 名称, 性质, 简码, 码类) Values (Id_In, 别名_In, 9, 别名五笔_In, 2);
      End If;
    End If;
  End If;

  If 类别_In = 'D' And 组合项目_In = 1 Then
    Update 诊疗项目目录 Set 名称 = 名称_In Where Id In (Select 诊疗项目id From 诊疗项目组合 Where 诊疗组合id = Id_In);
  
    Update 诊疗项目别名
    Set 名称 = 名称_In, 简码 = Decode(码类, 1, Zlspellcode(名称_In), Zlwbcode(名称_In))
    Where 性质 = 1 And 诊疗项目id In (Select 诊疗项目id From 诊疗项目组合 Where 诊疗组合id = Id_In);
  End If;

  If 不处理执行科室_In = 0 Then
    If 应用范围_In = 1 Then
      If 分类id_In Is Null Then
        Open c_诊疗项目 For
          Select Id From 诊疗项目目录 Where 分类id Is Null Order By 编码;
      Else
        Open c_诊疗项目 For
          Select Id From 诊疗项目目录 Where 分类id = 分类id_In Order By 编码;
      End If;
    Elsif 应用范围_In = 2 Then
      If 分类id_In Is Null Then
        Open c_诊疗项目 For
          Select c.Id
          From 诊疗项目目录 c, (Select Id From 诊疗分类目录 Start With 上级id Is Null Connect By Prior Id = 上级id) d
          Where d.Id = c.分类id
          Order By 编码;
      Else
        Open c_诊疗项目 For
          Select c.Id
          From 诊疗项目目录 c, (Select Id From 诊疗分类目录 Start With Id = 分类id_In Connect By Prior Id = 上级id) d
          Where d.Id = c.分类id
          Order By 编码;
      End If;
    Elsif 应用范围_In = 3 Then
      Open c_诊疗项目 For
        Select Id From 诊疗项目目录 Where 类别 = 类别_In Order By 编码;
    Else
      Open c_诊疗项目 For
        Select Id From 诊疗项目目录 Where Id = Id_In;
    End If;
    Loop
    
      Fetch c_诊疗项目
        Into v_Id;
      Exit When c_诊疗项目%Notfound;
    
      If First_In = 1 Then
        Delete From 诊疗执行科室 Where 诊疗项目id = v_Id;
        If 执行科室_In = 4 And 门诊执行_In Is Not Null Then
          Insert Into 诊疗执行科室 (诊疗项目id, 病人来源, 开单科室id, 执行科室id) Values (v_Id, 1, Null, 门诊执行_In);
        End If;
        If 执行科室_In = 4 And 住院执行_In Is Not Null Then
          Insert Into 诊疗执行科室 (诊疗项目id, 病人来源, 开单科室id, 执行科室id) Values (v_Id, 2, Null, 住院执行_In);
        End If;
      End If;
      If 执行科室_In <> 4 Or 定向执行_In Is Null Then
        v_Records := Null;
      Else
        v_Records := 定向执行_In || '|';
      End If;
      While v_Records Is Not Null Loop
        v_Currrec    := Substr(v_Records, 1, Instr(v_Records, '|') - 1);
        v_Fields     := v_Currrec;
        v_开单科室id := To_Number(Substr(v_Fields, 1, Instr(v_Fields, '^') - 1));
        v_Fields     := Substr(v_Fields, Instr(v_Fields, '^') + 1);
        v_执行科室id := To_Number(v_Fields);
        Insert Into 诊疗执行科室
          (诊疗项目id, 病人来源, 开单科室id, 执行科室id)
        Values
          (v_Id, Null, Decode(v_开单科室id, 0, Null, v_开单科室id), v_执行科室id);
        v_Records := Replace('|' || v_Records, '|' || v_Currrec || '|');
      End Loop;
      If 应用范围_In <> 0 Then
        Update 诊疗项目目录 Set 执行科室 = 执行科室_In Where Id = v_Id;
        Update 路径医嘱内容 Set 执行性质 = 执行科室_In Where 诊疗项目id = v_Id;
        Update 诊疗项目组合 Set 执行性质 = 执行科室_In Where 诊疗项目id = v_Id;
      End If;
    End Loop;
    Close c_诊疗项目;
  End If;

  If 限量范围_In = 1 Then
    If 分类id_In Is Null Then
      Update 诊疗项目目录 Set 录入限量 = 录入限量_In Where 分类id Is Null;
    Else
      Update 诊疗项目目录 Set 录入限量 = 录入限量_In Where 分类id = 分类id_In;
    End If;
  Elsif 限量范围_In = 2 Then
    If 分类id_In Is Null Then
      Update 诊疗项目目录
      Set 录入限量 = 录入限量_In
      Where 分类id In (Select Id From 诊疗分类目录 Start With 上级id Is Null Connect By Prior Id = 上级id);
    Else
      Update 诊疗项目目录
      Set 录入限量 = 录入限量_In
      Where 分类id In (Select Id From 诊疗分类目录 Start With Id = 分类id_In Connect By Prior Id = 上级id);
    End If;
  Elsif 限量范围_In = 3 Then
    Update 诊疗项目目录 Set 录入限量 = 录入限量_In Where 类别 = 类别_In;
  Elsif 限量范围_In = 4 Then
    Update 诊疗项目目录 Set 录入限量 = 录入限量_In;
  End If;

  --该项目的频率设置
  If 类别_In <> 'C' Then
    Delete 诊疗用法用量 Where 项目id = Id_In;
    If 项目频率_In Is Not Null Then
      v_Strinput := 项目频率_In || '|';
      n_序号     := 0;
    
      While v_Strinput Is Not Null Loop
        v_Strtmp := Substr(v_Strinput, 1, Instr(v_Strinput, '|') - 1);
        v_编号   := v_Strtmp;
        n_序号   := n_序号 + 1;
      
        Insert Into 诊疗用法用量 (项目id, 性质, 频次) Values (Id_In, n_序号, v_编号);
        v_Strinput := Replace('|' || v_Strinput, '|' || v_Strtmp || '|');
      End Loop;
    End If;
  End If;

  --使用科室
  If 使用科室应用范围_In = 1 Then
    If 分类id_In Is Null Then
      Open c_诊疗项目 For
        Select Id From 诊疗项目目录 Where 分类id Is Null Order By 编码;
    Else
      Open c_诊疗项目 For
        Select Id From 诊疗项目目录 Where 分类id = 分类id_In Order By 编码;
    End If;
  Elsif 使用科室应用范围_In = 2 Then
    If 分类id_In Is Null Then
      Open c_诊疗项目 For
        Select c.Id
        From 诊疗项目目录 c, (Select Id From 诊疗分类目录 Start With 上级id Is Null Connect By Prior Id = 上级id) d
        Where d.Id = c.分类id
        Order By 编码;
    Else
      Open c_诊疗项目 For
        Select c.Id
        From 诊疗项目目录 c, (Select Id From 诊疗分类目录 Start With Id = 分类id_In Connect By Prior Id = 上级id) d
        Where d.Id = c.分类id
        Order By 编码;
    End If;
  Elsif 使用科室应用范围_In = 3 Then
    Open c_诊疗项目 For
      Select Id From 诊疗项目目录 Where 类别 = 类别_In Order By 编码;
  Else
    Open c_诊疗项目 For
      Select Id From 诊疗项目目录 Where Id = Id_In;
  End If;
  Fetch c_诊疗项目 Bulk Collect
    Into t_Id;
  Close c_诊疗项目;

  Forall i In 1 .. t_Id.Count
    Delete 诊疗适用科室 Where 项目id = t_Id(i) And Instr(',' || 使用科室_In || ',', ',' || 科室id || ',') = 0;

  If 使用科室_In Is Not Null Then
    Forall i In 1 .. t_Id.Count
      Insert Into 诊疗适用科室
        (项目id, 科室id)
        Select t_Id(i), Column_Value
        From Table(f_Num2list(使用科室_In)) a
        Where Not Exists (Select 1 From 诊疗适用科室 Where 科室id = Column_Value And 项目id = t_Id(i));
  End If;
  --输血检验对照
  If 类别_In = 'K' Then
    Delete From 输血检验对照 Where 项目id = Id_In;
    If 输血检验对照_In Is Not Null Then
      v_Strinput := 输血检验对照_In || '|';
    
      While v_Strinput Is Not Null Loop
        v_Strtmp := Substr(v_Strinput, 1, Instr(v_Strinput, '|') - 1);
        v_Id     := v_Strtmp;
      
        Insert Into 输血检验对照 (项目id, 检验项目id) Values (Id_In, v_Id);
        v_Strinput := Replace('|' || v_Strinput, '|' || v_Strtmp || '|');
      End Loop;
    End If;
  End If;
Exception
  When Err_Notfind Then
    Raise_Application_Error(-20101, '[ZLSOFT]该项目不存在，可能已被其他用户删除！[ZLSOFT]');
  When Others Then
    Zl_Errorcenter(Sqlcode, Sqlerrm);
End Zl_诊疗项目_Update;
/

--114886:张险华,2017-09-30,取消不必要的正则表达式使用
CREATE OR REPLACE Procedure Zl_病案评分结果_审核
( 
  Id_In     In 病案评分结果.ID%Type, 
  审核人_In In 病案评分结果.审核人%Type, 
  系统号_In In zlsystems.编号%Type:=100 
) Is 
  n_数目         Number; 
  n_自动写入从表 Number; 
  n_病人id       Number; 
  n_主页id       Number; 
  v_等级         Varchar2(2); 
  v_旧等级值     Varchar2(2); 
  n_参数值 number;
Begin 

  Select 病人id Into n_病人id From 病案评分结果 Where ID = Id_In; 
  Select 主页id Into n_主页id From 病案评分结果 Where ID = Id_In; 
  Select 等级 Into v_等级 From 病案评分结果 Where ID = Id_In; 
 
  Select Count(*) 
    Into n_数目 
    From 病案主页从表 
   Where 病人id = n_病人id 
     And 主页id = n_主页id 
     And 信息名 = '病案质量'; 
 n_参数值:=Zl_Getsysparameter(90, 0, 系统号_In/100);
 
  if n_参数值=1 then 
     n_自动写入从表:=1 ;
   else
     n_自动写入从表:=0;
  end if;
   Update 病案评分结果 
     Set 审核人 = 审核人_In, 审核时间 = Sysdate 
   Where ID = Id_In; 
  If n_数目 = 0 And n_自动写入从表 = 1 And v_等级 <> '否' Then 
    Insert Into 病案主页从表 
      (病人id, 主页id, 信息名, 信息值) 
    Values 
      (n_病人id, n_主页id, '病案质量', v_等级); 
  Else 
    If n_数目 = 1 And n_自动写入从表 = 1 And v_等级 <> '否' Then 
      Select 信息值 
        Into v_旧等级值 
        From 病案主页从表 
       Where 病人id = n_病人id 
         And 主页id = n_主页id 
         And 信息名 = '病案质量'; 
      If v_旧等级值 Is Null Then 
        Update 病案主页从表 
           Set 信息值 = v_等级 
         Where 病人id = n_病人id 
           And 主页id = n_主页id 
           And 信息名 = '病案质量'; 
      End If; 
    End If; 
  End If; 
 
Exception 
  When Others Then 
    zl_ErrorCenter(SQLCode, SQLErrM); 
End Zl_病案评分结果_审核;
/

--114583:冉俊明,2017-10-16,修正补结算前一次结算多张单据部分单据已全部退费时退费结帐ID未加入到费用补充记录问题
Create Or Replace Procedure Zl_费用补充记录_补结算
(
  No_In          In 费用补充记录.No%Type,
  实际票号_In    In 费用补充记录.实际票号%Type,
  结算id_In      In 费用补充记录.结算id%Type,
  结算序号_In    In 病人预交记录.结算序号%Type,
  收费结帐ids_In Varchar2,
  医保结算_In    Varchar2,
  操作员编号_In  In 费用补充记录.操作员编号%Type,
  操作员姓名_In  In 费用补充记录.操作员姓名%Type,
  登记时间_In    In 费用补充记录.登记时间%Type := Null,
  备注_In        In 费用补充记录.备注%Type := Null,
  附加标志_In    In 费用补充记录.备注%Type := Null,
  费用状态_In    In 费用补充记录.费用状态%Type := 0
) Is
  -- 医保结算_IN:允许传入多个,格式为:结算方式,结算金额|..
  Err_Item Exception;
  v_Err_Msg Varchar2(255);

  n_Count  Number(2);
  n_Date   病人预交记录.收款时间%Type;
  n_病人id 门诊费用记录.病人id%Type;
  n_组id   财务缴款分组.Id%Type;
  n_冲预交 病人预交记录.冲预交%Type;
  n_会话号 病人预交记录.会话号%Type; --格式：SID+'_'+SERIAL#
Begin
  Select Count(1), Max(病人id), Max(收款时间), Max(缴款组id)
  Into n_Count, n_病人id, n_Date, n_组id
  From 病人预交记录
  Where 结帐id = 结算id_In And 结算序号 = 结算序号_In And Rownum < 2;

  If n_Count = 0 Then
    --本次结算的数据太多时会多次调用该过程
    n_组id := Zl_Get组id(操作员姓名_In);
  
    Begin
      Select Sid || '_' || Serial# Into n_会话号 From V$session Where Audsid = Userenv('sessionid');
    Exception
      When Others Then
        n_会话号 := Null;
    End;
  
    n_Date := 登记时间_In;
    If 登记时间_In Is Null Then
      n_Date := Sysdate;
    End If;
  
    Begin
      Select 病人id
      Into n_病人id
      From 门诊费用记录
      Where 结帐id In (Select Column_Value From Table(f_Num2list(收费结帐ids_In))) And Rownum < 2;
    Exception
      When Others Then
        n_病人id := Null;
    End;
    If Nvl(n_病人id, 0) = 0 Then
      v_Err_Msg := '费用记录中存在未建档病人的费用,不允许继续操作！';
      Raise Err_Item;
    End If;
  
    If 医保结算_In Is Not Null Then
      Insert Into 病人预交记录
        (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 结算性质, 会话号)
        Select 病人预交记录_Id.Nextval, 6, No_In, 1, n_病人id, Null, Null, 结算方式, n_Date, 操作员编号_In, 操作员姓名_In, 结算金额, 结算id_In,
               n_组id, 结算序号_In, 2, 6, n_会话号
        From (Select C1 As 结算方式, To_Number(C2) As 结算金额 From Table(f_Str2list2(医保结算_In, '|', ',')));
    
      Select Sum(To_Number(C2)) Into n_冲预交 From Table(f_Str2list2(医保结算_In, '|', ','));
    End If;
    --增加结算方式为NULL
    Insert Into 病人预交记录
      (ID, 记录性质, NO, 记录状态, 病人id, 主页id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 校对标志, 结算性质)
    Values
      (病人预交记录_Id.Nextval, 6, No_In, 1, n_病人id, Null, '', Null, n_Date, 操作员编号_In, 操作员姓名_In, -1 * n_冲预交, 结算id_In, n_组id,
       结算序号_In, 1, 6);
  End If;

  --Select Column_Value As 结帐id From Table(f_Num2list(收费结帐ids_In))
  --将结算前的所有收费结帐ID都加入到费用补充记录中(包含结算前的退费结帐ID）
  If Nvl(附加标志_In, 0) = 1 Then
    Insert Into 费用补充记录
      (记录性质, NO, 记录状态, 实际票号, 结算id, 收费结帐id, 费用状态, 操作员编号, 操作员姓名, 登记时间, 缴款组id, 病人id, 结算序号, 备注, 附加标志)
      Select 1, No_In, 1, 实际票号_In, 结算id_In, a.结帐id, 费用状态_In, 操作员编号_In, 操作员姓名_In, n_Date, n_组id, n_病人id, 结算序号_In, 备注_In,
             附加标志_In
      From (Select Distinct d.结帐id
             From 门诊费用记录 D, 门诊费用记录 C
             Where d.记录性质 = c.记录性质 And d.No = c.No And d.序号 = c.序号 And
                   c.结帐id In (Select /*+cardinality(J,10)*/
                               j.Column_Value As 结帐id
                              From Table(f_Num2list(收费结帐ids_In)) J)) A
      Where Not Exists (Select 1 From 费用补充记录 Where 收费结帐id = a.结帐id And 结算id = 结算id_In);
  Else
    Insert Into 费用补充记录
      (记录性质, NO, 记录状态, 实际票号, 结算id, 收费结帐id, 费用状态, 操作员编号, 操作员姓名, 登记时间, 缴款组id, 病人id, 结算序号, 备注, 附加标志)
      Select 1, No_In, 1, 实际票号_In, 结算id_In, a.结帐id, 费用状态_In, 操作员编号_In, 操作员姓名_In, n_Date, n_组id, n_病人id, 结算序号_In, 备注_In,
             附加标志_In
      From (Select Distinct d.结帐id
             From 门诊费用记录 D, 门诊费用记录 C, 病人预交记录 A, 病人预交记录 B
             Where d.记录性质 = c.记录性质 And d.No = c.No And d.序号 = c.序号 And c.结帐id = a.结帐id And a.结算序号 = b.结算序号 + 0 And
                   b.结帐id In (Select /*+cardinality(J,10)*/
                               j.Column_Value As 结帐id
                              From Table(f_Num2list(收费结帐ids_In)) J)) A
      Where Not Exists (Select 1 From 费用补充记录 Where 收费结帐id = a.结帐id And 结算id = 结算id_In);
  End If;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_费用补充记录_补结算;
/

--114712:冉俊明,2017-09-29,一条卫材收费记录如果对应多个批次时，费用销账申请无法审核
Create Or Replace Procedure Zl_病人费用销帐_Audit
(
  Id_In       病人费用销帐.费用id%Type,
  申请时间_In 病人费用销帐.申请时间%Type,
  审核人_In   病人费用销帐.审核人%Type,
  审核时间_In 病人费用销帐.审核时间%Type,
  状态_In     病人费用销帐.状态%Type,
  Int自动退料 Integer := 1,
  申请类别_In 病人费用销帐.申请类别%Type := 1 --对药品和卫材有效,缺省为已执行的药品或卫材
) As
  n_执行状态       住院费用记录.执行状态%Type;
  n_申请类别       病人费用销帐.申请类别%Type;
  v_收费类别       住院费用记录.收费类别%Type;
  v_No             住院费用记录.No%Type;
  n_实际数量       药品收发记录.实际数量%Type;
  n_数量           病人费用销帐.数量%Type;
  n_收发id         药品收发记录.Id%Type;
  n_医嘱id         住院费用记录.Id%Type;
  v_跟踪在用       材料特性.跟踪在用%Type;
  n_收费细目id     住院费用记录.收费细目id%Type;
  n_审核部门id     病人费用销帐.审核部门id%Type;
  n_执行部门id     住院费用记录.执行部门id%Type;
  n_病人id         住院费用记录.病人id%Type;
  n_主页id         住院费用记录.主页id%Type;
  n_审核标志       病案主页.审核标志%Type;
  n_住院状态       病案主页.状态%Type;
  n_病人审核方式   Number(2);
  n_未入科禁止记账 Number(2);

  n_Cnt     Number(18);
  n_Temp    Number(18);
  v_Err_Msg Varchar2(300);
  Err_Item Exception;
Begin

  n_申请类别 := 0;
  Select a.执行状态, a.收费类别, a.收费细目id, a.执行部门id, a.No, Nvl(b.跟踪在用, 0), a.医嘱序号, 病人id, 主页id
  Into n_执行状态, v_收费类别, n_收费细目id, n_执行部门id, v_No, v_跟踪在用, n_医嘱id, n_病人id, n_主页id
  From 住院费用记录 A, 材料特性 B
  Where a.Id = Id_In And a.收费细目id = b.材料id(+);

  If Nvl(n_主页id, 0) <> 0 Then
  
    n_病人审核方式   := Nvl(zl_GetSysParameter(185), 0);
    n_未入科禁止记账 := Nvl(zl_GetSysParameter(215), 0);
    If n_病人审核方式 = 1 Or n_未入科禁止记账 = 1 Then
      Begin
        Select 审核标志, 状态
        Into n_审核标志, n_住院状态
        From 病案主页
        Where 病人id = Nvl(n_病人id, 0) And 主页id = Nvl(n_主页id, 0);
      Exception
        When Others Then
          n_审核标志 := 0;
          n_住院状态 := 0;
      End;
      If n_未入科禁止记账 = 1 And n_住院状态 = 1 Then
        v_Err_Msg := '病人未入科,禁止对病人相关费用的操作!';
        Raise Err_Item;
      End If;
    
      If n_病人审核方式 = 1 Then
        If Nvl(n_审核标志, 0) = 1 Then
          v_Err_Msg := '该病人目前正在审核费用,不能进行费用相关调整!';
          Raise Err_Item;
        End If;
        If Nvl(n_审核标志, 0) = 2 Then
          v_Err_Msg := '该病人目前已经完成了费用审核,不能进行费用相关调整!';
          Raise Err_Item;
        End If;
      End If;
    End If;
  
  End If;
  If Instr(',5,6,7', ',' || v_收费类别) > 0 Or (v_收费类别 = '4' And Nvl(v_跟踪在用, 0) = 1) Then
    n_申请类别 := 申请类别_In;
  End If;

  Update 病人费用销帐
  Set 审核人 = 审核人_In, 审核时间 = 审核时间_In, 状态 = 状态_In
  Where 费用id = Id_In And 申请类别 = n_申请类别 And 申请时间 = 申请时间_In And 状态 = 0
  Returning 数量, 审核部门id Into n_数量, n_审核部门id;

  If Sql%RowCount = 0 Then
    v_Err_Msg := '销帐审核失败,当前操作的记录可能因为并发操作已经被他人处理,请先刷新信息!';
    Raise Err_Item;
  End If;

  If n_申请类别 = 0 And (Instr(',5,6,7', ',' || v_收费类别) > 0 Or (v_收费类别 = '4' And Nvl(v_跟踪在用, 0) = 1)) Then
    --需要检查未执行的数量必须全部申请,才会通过
    Select Sum(Nvl(付数, 0) * Nvl(实际数量, 0))
    Into n_实际数量
    From 药品收发记录
    Where 审核日期 Is Null And 费用id = Id_In And instr( ',8,9,10,21,24,25,26,',','||单据||',')>0;
    If Nvl(n_实际数量, 0) < Nvl(n_数量, 0) Then
      Select '在单据号<<' || v_No || '>>中' || Decode(v_收费类别, '4', '卫材', '药品') || '为:' || Chr(13) || 编码 || '-' || 名称 ||
              Chr(13) || '的申请数量(' || LTrim(To_Char(n_数量, '9999999990.99')) || ')大于了待发' || Decode(v_收费类别, '4', '料', '药') ||
              '数量(' || LTrim(To_Char(Nvl(n_实际数量, 0), '9999999990.99')) || '),不允许审核!'
      Into v_Err_Msg
      From 收费项目目录
      Where ID = n_收费细目id;
      Raise Err_Item;
    End If;
  
    If n_医嘱id <> 0 Then
      Select Nvl(Max(d.Id), 0)
      Into n_Cnt
      From 病人医嘱记录 A, 病人医嘱发送 B, 输液配药记录 D
      Where a.Id = n_医嘱id And a.Id = b.医嘱id And b.No = v_No And a.相关id = d.医嘱id And b.发送号 = d.发送号 And b.记录性质 = 2  And d.操作时间 = 申请时间_In And D.操作状态=9;
      
      If n_Cnt <> 0 Then
        select count(1) into n_Temp from 输液配药状态 where 配药ID=n_Cnt and 操作类型=10 and 操作时间=审核时间_In;
        if n_Temp=0 then
           Insert Into 输液配药状态 (配药id, 操作类型, 操作人员, 操作时间) Values (n_Cnt, 10, 审核人_In, 审核时间_In);
        end if;
        Update 输液配药记录 Set 操作人员 = 审核人_In, 操作时间 = 审核时间_In,操作状态=10 Where ID = n_Cnt;
      End If;
    End If;
  End If;

  If n_执行状态 <> 0 Then
    If Instr(',5,6,7,', ',' || v_收费类别 || ',') > 0 And n_申请类别 = 1 Then
      If n_执行部门id <> n_审核部门id Then
        Begin
          Select '[' || 编码 || ']' || 名称 Into v_Err_Msg From 收费项目目录 Where ID = n_收费细目id;
        Exception
          When Others Then
            v_Err_Msg := '';
        End;
        v_Err_Msg := '在销帐审核时,药品为' || v_Err_Msg || ' 的已经被执行科室执行,不能再进行销帐审核,请取消审核!';
        Raise Err_Item;
      End If;
    End If;
  
    If v_收费类别 = '4' Then
      If v_跟踪在用 = 1 Then
        If n_执行部门id <> n_审核部门id And n_申请类别 = 1 And Int自动退料 <> 1 Then
          Begin
            Select '[' || 编码 || ']' || 名称 Into v_Err_Msg From 收费项目目录 Where ID = n_收费细目id;
          Exception
            When Others Then
              v_Err_Msg := '';
          End;
          v_Err_Msg := '在销帐审核时,卫材为' || v_Err_Msg || ' 的已经被执行科室执行,不能再进行销帐审核,请取消审核!';
          Raise Err_Item;
        End If;
      
        If n_申请类别 = 1 And Int自动退料 = 1 Then
          n_收发id := -1;
          --可能来自于多个批次
          For c_收发记录 In (Select ID, 批号, Nvl(Sum(Nvl(付数, 1) * 实际数量), 0) As 数次
                         From 药品收发记录
                         Where 费用id = Id_In And 单据 In (25, 26) And (记录状态 = 1 Or Mod(记录状态, 3) = 0)) Loop
            n_收发id := c_收发记录.Id;
            If n_数量 = 0 Then
              Exit;
            End If;
          
            If n_数量 > c_收发记录.数次 Then
              n_Temp := c_收发记录.数次;
              n_数量 := n_数量 - c_收发记录.数次;
            Else
              n_Temp := n_数量;
              n_数量 := 0;
            End If;
            Zl_材料收发记录_部门退料(c_收发记录.Id, 审核人_In, 审核时间_In, c_收发记录.批号, Null, Null, n_Temp, 0);
          End Loop;
          If n_收发id = -1 Then
            v_Err_Msg := '在销帐审核时,卫材为' || v_Err_Msg || ' 的未找到相关的药品收发信息,可能是因为中途' || Chr(13) ||
                         '更改了卫材的跟踪属性,不能再进行销帐审核,请取消审核!';
            Raise Err_Item;
          End If;
        End If;
      Else
        --不是跟踪的卫材
        Update 住院费用记录 Set 执行状态 = 0 Where ID = Id_In;
      End If;
    Elsif Instr(',5,6,7,', ',' || v_收费类别 || ',') = 0 Then
      --可能存在部分消帐,所以先将非药品的处理成部分执行,再在销帐审核过程(ZL_住院记帐记录_Delete)中处理,处理规则如下:
      --在调用本过程时:
      --   1.如果是已经执行的,则改为部分执行(执行状态=2);再在销帐过程中处理这部分数据(ZL_住院记帐记录_Delete):即:如果执行状态=2,并且部分销帐的,则改为1(已执行)
      --      原因是因为非药品类只能存在两种状态.已执行;2-未执行
      --   2.如果是未执行的,则执行状态还是为0,而在销帐过程中记录状态保持不变
      Update 住院费用记录 Set 执行状态 = Decode(Nvl(执行状态, 0), 0, 0, 2) Where ID = Id_In; --非药品由于没有取消执行的操作,所以对已执行的要先改状态才能调销帐
    End If;
  End If;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_病人费用销帐_Audit;
/

--107991:刘尔旋,2017-09-27,是否缺省退现
Create Or Replace Procedure Zl_医疗卡类别_Update
(
  Id_In               In 医疗卡类别.Id%Type,
  编码_In             In 医疗卡类别.编码%Type,
  名称_In             In 医疗卡类别.名称%Type,
  短名_In             In 医疗卡类别.短名%Type,
  前缀文本_In         In 医疗卡类别.前缀文本%Type,
  卡号长度_In         In 医疗卡类别.卡号长度%Type,
  缺省标志_In         In 医疗卡类别.缺省标志%Type,
  是否固定_In         In 医疗卡类别.是否固定%Type,
  是否严格控制_In     In 医疗卡类别.是否严格控制%Type,
  是否刷卡_In         In 医疗卡类别.是否刷卡%Type,
  是否自制_In         In 医疗卡类别.是否自制%Type,
  是否存在帐户_In     In 医疗卡类别.是否存在帐户%Type,
  是否全退_In         In 医疗卡类别.是否全退%Type,
  部件_In             In 医疗卡类别.部件%Type,
  备注_In             In 医疗卡类别.备注%Type,
  特定项目_In         In 医疗卡类别.特定项目%Type,
  收费细目id_In       In 收费项目目录.Id%Type,
  结算方式_In         In 医疗卡类别.结算方式%Type,
  是否启用_In         In 医疗卡类别.是否启用%Type,
  卡号密文_In         In 医疗卡类别.卡号密文%Type,
  是否重复使用_In     In 医疗卡类别.是否重复使用%Type,
  密码长度_In         In 医疗卡类别.密码长度%Type,
  密码长度限制_In     In 医疗卡类别.密码长度限制%Type,
  密码规则_In         In 医疗卡类别.密码规则%Type,
  是否退现_In         In 医疗卡类别.是否退现%Type,
  操作方式_In         In Integer := 0,
  是否模糊查找_In     In 医疗卡类别.是否模糊查找%Type := 0,
  密码输入限制_In     In 医疗卡类别.密码输入限制%Type := 0,
  是否缺省密码_In     In 医疗卡类别.是否缺省密码%Type := 0,
  是否制卡_In         In 医疗卡类别.是否制卡%Type := 0,
  是否发卡_In         In 医疗卡类别.是否发卡%Type := 0,
  是否写卡_In         In 医疗卡类别.是否写卡%Type := 0,
  险类_In             In 医疗卡类别.险类%Type := 0,
  发卡性质_In         In 医疗卡类别.发卡性质%Type := 0,
  是否转帐及代扣_In   In 医疗卡类别.是否转帐及代扣%Type := 0,
  是否持卡消费_In     In 医疗卡类别.是否持卡消费%Type := 0,
  发送调用接口_In     In 医疗卡类别.发送调用接口%Type := 0,
  设备是否启用回车_In In 医疗卡类别.设备是否启用回车%Type := 0,
  发卡卡号控制_In     In 医疗卡类别.发卡控制%Type := 0,
  是否退款验卡_In     In 医疗卡类别.是否退款验卡%Type := 0,
  是否缺省退现_In     In 医疗卡类别.是否缺省退现%Type := 0
) Is
  v_Err_Msg Varchar2(200);
  Err_Item Exception;
Begin
  If Nvl(是否自制_In, 0) = 1 And Nvl(是否存在帐户_In, 0) = 1 Then
    v_Err_Msg := '[ZLSOFT]是否存在帐户只有非自制卡才会存在,请检查![ZLSOFT]';
    Raise Err_Item;
  End If;
  If Nvl(是否自制_In, 0) = 0 And Nvl(是否存在帐户_In, 0) = 1 And 结算方式_In Is Null Then
    v_Err_Msg := '[ZLSOFT]第三方机构的卡结算，必须要设置结算方式,请检查![ZLSOFT]';
    Raise Err_Item;
  End If;
  If Nvl(是否自制_In, 0) = 1 And 特定项目_In Is Null Then
    v_Err_Msg := '[ZLSOFT]特定项目必须输入,请检查![ZLSOFT]';
    Raise Err_Item;
  End If;

  If 操作方式_In = 0 Then
    Insert Into 医疗卡类别
      (ID, 编码, 名称, 短名, 前缀文本, 卡号长度, 缺省标志, 是否固定, 是否严格控制, 是否刷卡, 是否自制, 是否存在帐户, 是否全退, 部件, 备注, 特定项目, 结算方式, 是否启用, 卡号密文, 是否重复使用,
       密码长度, 密码长度限制, 密码规则, 是否退现, 是否模糊查找, 密码输入限制, 是否缺省密码, 是否制卡, 是否发卡, 是否写卡, 险类, 发卡性质, 是否转帐及代扣, 是否持卡消费, 发送调用接口, 设备是否启用回车,
       发卡控制, 是否退款验卡, 是否缺省退现)
    Values
      (Id_In, 编码_In, 名称_In, 短名_In, 前缀文本_In, 卡号长度_In, 缺省标志_In, 是否固定_In, 是否严格控制_In, 是否刷卡_In, 是否自制_In, 是否存在帐户_In, 是否全退_In,
       部件_In, 备注_In, 特定项目_In, 结算方式_In, 是否启用_In, 卡号密文_In, 是否重复使用_In, 密码长度_In, 密码长度限制_In, 密码规则_In, 是否退现_In, 是否模糊查找_In,
       密码输入限制_In, 是否缺省密码_In, 是否制卡_In, 是否发卡_In, 是否写卡_In, 险类_In, 发卡性质_In, 是否转帐及代扣_In, 是否持卡消费_In, 发送调用接口_In, 设备是否启用回车_In,
       发卡卡号控制_In, 是否退款验卡_In, 是否缺省退现_In);
  
  Else
  
    Delete 收费特定项目 Where 特定项目 = (Select Max(特定项目) From 医疗卡类别 Where ID = Id_In);
  
    Update 医疗卡类别
    Set 编码 = 编码_In, 名称 = 名称_In, 短名 = 短名_In, 前缀文本 = 前缀文本_In, 卡号长度 = 卡号长度_In, 缺省标志 = 缺省标志_In, 是否严格控制 = 是否严格控制_In,
        是否刷卡 = 是否刷卡_In, 是否自制 = 是否自制_In, 是否存在帐户 = 是否存在帐户_In, 是否全退 = 是否全退_In, 部件 = 部件_In, 备注 = 备注_In, 特定项目 = 特定项目_In,
        结算方式 = 结算方式_In, 是否启用 = 是否启用_In, 卡号密文 = 卡号密文_In, 是否重复使用 = 是否重复使用_In, 密码长度 = 密码长度_In, 密码长度限制 = 密码长度限制_In,
        密码规则 = 密码规则_In, 是否退现 = 是否退现_In, 是否模糊查找 = 是否模糊查找_In, 密码输入限制 = 密码输入限制_In, 是否缺省密码 = 是否缺省密码_In, 是否制卡 = 是否制卡_In,
        是否发卡 = 是否发卡_In, 是否写卡 = 是否写卡_In, 险类 = 险类_In, 发卡性质 = 发卡性质_In, 是否转帐及代扣 = 是否转帐及代扣_In, 是否持卡消费 = 是否持卡消费_In,
        发送调用接口 = 发送调用接口_In, 设备是否启用回车 = 设备是否启用回车_In, 发卡控制 = 发卡卡号控制_In, 是否退款验卡 = 是否退款验卡_In, 是否缺省退现 = 是否缺省退现_In
    Where ID = Id_In;
    If Nvl(缺省标志_In, 0) = 1 Then
      Update 医疗卡类别 Set 缺省标志 = 0 Where ID <> Id_In;
    End If;
  
  End If;
  If Not 特定项目_In Is Null And Nvl(收费细目id_In, 0) <> 0 Then
    Insert Into 收费特定项目 (特定项目, 收费细目id) Values (特定项目_In, 收费细目id_In);
  End If;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, v_Err_Msg);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_医疗卡类别_Update;
/

--114573:冉俊明,2017-09-26,修正分批卫材已执行仍可删费问题
Create Or Replace Procedure Zl_住院记帐记录_Delete
(
  No_In           住院费用记录.No%Type,
  序号_In         Varchar2,
  操作员编号_In   住院费用记录.操作员编号%Type,
  操作员姓名_In   住院费用记录.操作员姓名%Type,
  记录性质_In     住院费用记录.记录性质%Type := 2,
  操作状态_In     Number := 0,
  输液配药检查_In Number := 1,
  登记时间_In     住院费用记录.登记时间%Type := Sysdate
) As
  --功能：冲销一张住院记帐单据中指定序号行
  --序号：格式如"1,3,5,7,8",或"1:2:33456,3:2,5:2,7:2,8:2",冒号前面的数字表示行号,中间的数字表示退的数量,后面的数字表示配药记录的ID,目前仅在销帐审核时才传入
  --      为空表示冲销所有可冲销行
  --记录性质:    2-人工记帐单,3-自动记帐单
  --输液配药检查:    0-医嘱调用，不检查药品是否进入输液配药中心；1-非医嘱调用，检查药品是否进入配药中心
  --该光标用于销帐指定费用行
  --操作状态_In:0-表示直接销帐;1-表示审核销帐(通过销帐申请-->销帐审核流程)
  --该游标为要退费单据的所有原始记录
  Cursor c_Bill Is
    Select a.Id, a.价格父号, a.序号, a.执行状态, a.记录性质, a.收费类别, a.医嘱序号, a.收费细目id, a.病人id, a.主页id, a.收入项目id, a.开单部门id, a.病人科室id,
           a.执行部门id, a.病人病区id, a.付数, a.数次, m.跟踪在用
    From 住院费用记录 A, 材料特性 M
    Where a.No = No_In And a.记录性质 = 记录性质_In And a.记录状态 In (0, 1, 3) And a.门诊标志 = 2 And a.收费细目id + 0 = m.材料id(+)
    Order By 收费细目id, 序号;

  --该游标用于处理药品库存可用数量
  --不要管费用的执行状态,因为先于此步处理
  Cursor c_Stock(v_序号_In Varchar2) Is
    Select ID, 单据, NO, 库房id, 药品id, 批次, 发药方式, 付数, 实际数量, 灭菌效期, 效期, 产地, 批号, 填制日期, 费用id, 商品条码, 内部条码
    From 药品收发记录
    Where NO = No_In And 单据 In (9, 10, 25, 26) And Mod(记录状态, 3) = 1 And 审核人 Is Null And
          费用id In (Select ID
                   From 住院费用记录
                   Where NO = No_In And 记录性质 = 记录性质_In And 记录状态 In (0, 1, 3) And 收费类别 In ('4', '5', '6', '7') And
                         门诊标志 = 2 And (Instr(',' || v_序号_In || ',', ',' || 序号 || ',') > 0 Or v_序号_In Is Null))
    Order By 药品id, 填制日期 Desc;

  r_Stock c_Stock%RowType;
  --该游标用于处理费用记录序号
  Cursor c_Serial Is
    Select 序号, 价格父号
    From 住院费用记录
    Where NO = No_In And 记录性质 = 记录性质_In And 记录状态 In (0, 1, 3)
    Order By 序号;

  Cursor Cr_药品 Is
    Select ID, 单据, NO, 库房id, 药品id, 批次, 发药方式, 0 As 数量, 灭菌效期, 效期, 产地, 批号, 填制日期, 费用id
    From 药品收发记录
    Where Rownum <= 1;
  v_药品 Cr_药品%RowType;

  v_医嘱id     病人医嘱记录.Id%Type;
  n_划价       Number;
  v_父号       住院费用记录.价格父号%Type;
  v_序号       Varchar2(2000);
  v_Tmp        Varchar2(4000);
  v_医嘱ids    Varchar2(4000);
  l_药品收发   t_Numlist := t_Numlist();
  l_划价       t_Numlist := t_Numlist();
  l_费用id     t_Numlist := t_Numlist();
  n_付数       Number;
  n_虚拟库房id 药品收发记录.库房id%Type;
  n_其他出库id 药品收发记录.Id%Type;
  n_库房id     药品收发记录.库房id%Type;
  n_返回值     Number;
  --部分退费计算变量
  v_剩余数量 Number;
  v_剩余应收 Number;
  v_剩余实收 Number;
  v_剩余统筹 Number;

  v_准退数量 Number;
  v_退费次数 Number;
  v_应收金额 Number;
  v_实收金额 Number;
  v_统筹金额 Number;
  n_Temp     Number;
  n_部分销帐 Number;
  v_Dec      Number;
  n_Count    Number;
  v_Curdate  Date;
  Err_Item Exception;
  v_Err_Msg        Varchar2(255);
  n_备货卫材       Number;
  n_病人id         病案主页.病人id%Type;
  n_主页id         病案主页.主页id%Type;
  n_审核标志       病案主页.审核标志%Type;
  n_住院状态       病案主页.状态%Type;
  n_病人审核方式   Number(2);
  n_未入科禁止记账 Number(2);
  v_配药id         Varchar2(4000);
  Type Ty_药品 Is Ref Cursor;
  c_药品 Ty_药品; --游标变量

  n_未执行数量 药品收发记录.实际数量%Type;
  n_已执行数量 药品收发记录.实际数量%Type;
Begin
  --销帐审核时,非药品会传入行号的销帐数量
  If Not 序号_In Is Null Then
    If Instr(序号_In, ':') > 0 Then
      v_Tmp := 序号_In || ',';
      While Not v_Tmp Is Null Loop
        v_序号 := v_序号 || ',' || Substr(v_Tmp, 1, Instr(v_Tmp, ':') - 1);
        If Instr(Substr(v_Tmp, Instr(v_Tmp, ':') + 1, Instr(v_Tmp, ',') - Instr(v_Tmp, ':') - 1), ':') > 0 Then
          v_配药id := v_配药id || ',' ||
                    Substr(v_Tmp, Instr(v_Tmp, ':', 1, 2) + 1, Instr(v_Tmp, ',') - Instr(v_Tmp, ':', 1, 2) - 1);
        End If;
        v_Tmp := Substr(v_Tmp, Instr(v_Tmp, ',') + 1);
      End Loop;
      v_序号 := Substr(v_序号, 2);
      If v_配药id Is Not Null Then
        v_配药id := Substr(v_配药id, 2);
      End If;
    Else
      v_序号 := 序号_In;
    End If;
  End If;

  --是否已经全部完全执行(只是整张单据的检查)
  Select Nvl(Count(*), 0), Nvl(Max(病人id), 0), Nvl(Max(主页id), 0)
  Into n_Count, n_病人id, n_主页id
  From 住院费用记录
  Where NO = No_In And 记录性质 = 记录性质_In And 记录状态 In (0, 1, 3) And Nvl(执行状态, 0) <> 1 And 门诊标志 = 2;
  If n_Count = 0 Then
    v_Err_Msg := '该单据中的项目已经全部完全执行！';
    Raise Err_Item;
  End If;

  n_病人审核方式   := Nvl(zl_GetSysParameter(185), 0);
  n_未入科禁止记账 := Nvl(zl_GetSysParameter(215), 0);
  If n_病人审核方式 = 1 Or n_未入科禁止记账 = 1 Then
  
    Begin
      Select 审核标志, 状态 Into n_审核标志, n_住院状态 From 病案主页 Where 病人id = n_病人id And 主页id = n_主页id;
    Exception
      When Others Then
        n_审核标志 := 0;
        n_住院状态 := 0;
    End;
    If n_未入科禁止记账 = 1 And n_住院状态 = 1 Then
      v_Err_Msg := '病人未入科,禁止对病人相关费用的操作!';
      Raise Err_Item;
    End If;
  
    If n_病人审核方式 = 1 Then
    
      If Nvl(n_审核标志, 0) = 1 Then
        v_Err_Msg := '该病人目前正在审核费用,不能进行费用相关调整!';
        Raise Err_Item;
      End If;
      If Nvl(n_审核标志, 0) = 2 Then
        v_Err_Msg := '该病人目前已经完成了费用审核,不能进行费用相关调整!';
        Raise Err_Item;
      End If;
    End If;
  End If;

  --未完全执行的项目是否有剩余数量(只是整张单据的检查)
  Select Nvl(Count(*), 0)
  Into n_Count
  From (Select 序号, Sum(数量) As 剩余数量
         From (Select 记录状态, Nvl(价格父号, 序号) As 序号, Avg(Nvl(付数, 1) * 数次) As 数量
                From 住院费用记录
                Where NO = No_In And 记录性质 = 记录性质_In And 门诊标志 = 2 And
                      Nvl(价格父号, 序号) In
                      (Select Nvl(价格父号, 序号)
                       From 住院费用记录
                       Where NO = No_In And 记录性质 = 记录性质_In And 记录状态 In (0, 1, 3) And Nvl(执行状态, 0) <> 1)
                Group By 记录状态, Nvl(价格父号, 序号))
         Group By 序号
         Having Sum(数量) <> 0);
  If n_Count = 0 Then
    v_Err_Msg := '该单据中未完全执行部分项目剩余数量为零,没有可以销帐的费用！';
    Raise Err_Item;
  End If;

  --医嘱费用：检查正在执行的医嘱(注意已执行的情况在下面检查,因为不传 序号_IN 这种情况费用界面已限制)
  If Nvl(操作状态_In, 0) <> 1 Then
    --走销帐申请流程的，不检查医保执行状态
    Select Nvl(Count(*), 0)
    Into n_Count
    From 病人医嘱发送
    Where 执行状态 = 3 And (NO, 记录性质, 医嘱id) In
          (Select NO, 记录性质, 医嘱序号
                        From 住院费用记录
                        Where NO = No_In And 记录性质 = 记录性质_In And 记录状态 In (0, 1, 3) And 医嘱序号 Is Not Null And
                              (Instr(',' || v_序号 || ',', ',' || 序号 || ',') > 0 Or v_序号 Is Null));
    If n_Count > 0 Then
      v_Err_Msg := '要销帐的费用中存在对应的医嘱正在执行的情况，不能销帐！';
      Raise Err_Item;
    End If;
  End If;

  ---------------------------------------------------------------------------------
  --先打开药品对应数据集,以确保当前条件下有数据,为了处理并发判断
  --不能在游标条件中取消"审核人 is Null"条件，因为多次退药可能部份又已发
  Open c_Stock(v_序号);

  --公用变量
  Select 登记时间_In Into v_Curdate From Dual;

  --金额小数位数
  Select Zl_To_Number(Nvl(zl_GetSysParameter(9), '2')) Into v_Dec From Dual;

  For c_编目病案 In (Select a.姓名
                 From 病人信息 A, 病案主页 B
                 Where a.病人id = b.病人id And b.编目日期 Is Not Null And
                       (b.病人id, b.主页id) In
                       (Select Distinct 病人id, 主页id
                        From 住院费用记录
                        Where NO = No_In And 记录性质 = 记录性质_In And 记录状态 In (0, 1, 3) And 门诊标志 = 2)) Loop
    v_Err_Msg := '病人『' || c_编目病案.姓名 || '』 已经被病案编目,不能被销帐！';
    Raise Err_Item;
  End Loop;
  v_医嘱ids := Null;
  --循环处理每行费用(收入项目行)
  For r_Bill In c_Bill Loop
    --检查已经存在病案编目的,则不能进行销帐处理
    If Instr(',' || v_序号 || ',', ',' || Nvl(r_Bill.价格父号, r_Bill.序号) || ',') > 0 Or v_序号 Is Null Then
      Select Decode(记录状态, 0, 1, 0) Into n_划价 From 住院费用记录 Where ID = r_Bill.Id;
      If Nvl(r_Bill.执行状态, 0) <> 1 Then
        --求剩余数量,剩余应收,剩余实收
        Select Sum(Nvl(付数, 1) * 数次), Sum(应收金额), Sum(实收金额), Sum(统筹金额)
        Into v_剩余数量, v_剩余应收, v_剩余实收, v_剩余统筹
        From 住院费用记录
        Where NO = No_In And 记录性质 = 记录性质_In And 序号 = r_Bill.序号;
        n_部分销帐 := 0;
        If v_剩余数量 = 0 Then
          If v_序号 Is Not Null Then
            v_Err_Msg := '单据中第' || Nvl(r_Bill.价格父号, r_Bill.序号) || '行费用已经全部销帐！';
            Raise Err_Item;
          End If;
          --情况：未限定行号,原始单据中的该笔已经全部销帐(执行状态=0的一种可能)
        Else
        
          If Instr(序号_In, ':') > 0 Then
            v_Tmp := ',' || 序号_In;
            v_Tmp := Substr(v_Tmp, Instr(v_Tmp, ',' || r_Bill.序号 || ':') + Length(',' || r_Bill.序号 || ':'));
            v_Tmp := Substr(v_Tmp, 1, Instr(v_Tmp || ',', ',') - 1);
            If Instr(v_Tmp, ':') > 0 Then
              v_Tmp := Substr(v_Tmp, 1, Instr(v_Tmp, ':') - 1);
            End If;
            v_准退数量 := v_Tmp;
            n_部分销帐 := 1;
          End If;
        
          --准销数量(非药品项目为剩余数量,原始数量)
          If Instr(',4,5,6,7,', r_Bill.收费类别) = 0 Then
            If Instr(序号_In, ':') = 0 Or 序号_In Is Null Then
              v_准退数量 := v_剩余数量;
            End If;
          Else
            --医嘱超期收回时,卫材可能没有发放,但申请销帐的是部分数量,所以要以申请的为准
            If Instr(序号_In, ':') = 0 Or 序号_In Is Null Then
              Select Nvl(Sum(Nvl(付数, 1) * 实际数量), 0), Count(*)
              Into v_准退数量, n_Count
              From 药品收发记录
              Where NO = No_In And 单据 In (9, 10, 25, 26) And Mod(记录状态, 3) = 1 And 审核人 Is Null And 费用id = r_Bill.Id;
            End If;
          
            --有剩余数量无准退数量的有两种情况：
            --1.不跟踪在用的卫材无对应的收发记录,这时使用剩余数量
            --2.并发操作,此时已发药或发料
            If v_准退数量 = 0 Then
              If r_Bill.收费类别 = '4' Then
                If n_Count > 0 Or Nvl(r_Bill.跟踪在用, 0) = 1 Then
                  v_Err_Msg := '单据中第' || Nvl(r_Bill.价格父号, r_Bill.序号) || '行费用已发料,须退料后再退费！';
                  Raise Err_Item;
                Else
                  v_准退数量 := v_剩余数量;
                End If;
              Else
                v_Err_Msg := '单据中第' || Nvl(r_Bill.价格父号, r_Bill.序号) || '行费用已发药,须退药后再退费！';
                Raise Err_Item;
              End If;
            End If;
          End If;
        
          --处理住院费用记录
          If Nvl(n_划价, 0) = 0 Then
            --划价时,直接更改数量,所以不须查划冲销次数
            --该笔项目第几次销帐
            Select Nvl(Max(Abs(执行状态)), 0) + 1
            Into v_退费次数
            From 住院费用记录
            Where NO = No_In And 记录性质 = 记录性质_In And 记录状态 = 2 And 序号 = r_Bill.序号 And 门诊标志 = 2;
          End If;
        
          --金额=剩余金额*(准退数/剩余数)
          v_应收金额 := Round(v_剩余应收 * (v_准退数量 / v_剩余数量), v_Dec);
          v_实收金额 := Round(v_剩余实收 * (v_准退数量 / v_剩余数量), v_Dec);
          v_统筹金额 := Round(v_剩余统筹 * (v_准退数量 / v_剩余数量), v_Dec);
          If Nvl(n_划价, 0) = 1 Then
            If Nvl(n_部分销帐, 0) = 0 Then
              l_划价.Extend;
              l_划价(l_划价.Count) := r_Bill.Id;
              n_返回值 := 0;
            Else
              --更新数量
              --划价的,先将相关的数据处理在内部表集中
              n_付数 := 0;
              If r_Bill.付数 > 1 Then
                --如果是中药,超期回收肯定是回收的付数,而不是次数.因此,需要检查准退数量是否可以整 除
                If Trunc(v_准退数量 / r_Bill.数次) <> (v_准退数量 / r_Bill.数次) Then
                  v_Err_Msg := '单据中第' || Nvl(r_Bill.价格父号, r_Bill.序号) || '行费用为中药,请按付数进行退费！';
                  Raise Err_Item;
                End If;
                n_付数 := Trunc(v_准退数量 / r_Bill.数次);
                If Nvl(r_Bill.付数, 0) - n_付数 < 0 Then
                  v_准退数量 := r_Bill.数次;
                Else
                  v_准退数量 := 0;
                End If;
              End If;
              Update 住院费用记录
              Set 付数 = 付数 - n_付数, 数次 = 数次 - v_准退数量, 应收金额 = Nvl(应收金额, 0) - v_应收金额, 实收金额 = Nvl(实收金额, 0) - v_实收金额,
                  登记时间 = v_Curdate, 统筹金额 = Nvl(统筹金额, 0) - v_统筹金额
              Where ID = r_Bill.Id
              Returning Nvl(数次, 0) * Nvl(付数, 0) Into n_返回值;
            End If;
            If Nvl(n_返回值, 0) <= 0 Then
              l_划价.Extend;
              l_划价(l_划价.Count) := r_Bill.Id;
            End If;
            If r_Bill.医嘱序号 Is Not Null Then
              If Instr(',' || Nvl(v_医嘱ids, '') || ',', ',' || r_Bill.医嘱序号 || ',') = 0 Then
                v_医嘱ids := Nvl(v_医嘱ids, '') || ',' || r_Bill.医嘱序号;
              End If;
              --记录病人医嘱附费对应的医嘱ID(不是主费用)
              If v_医嘱id Is Null Then
                v_医嘱id := r_Bill.医嘱序号;
              End If;
            End If;
          
          End If;
        
          If Nvl(n_划价, 0) = 0 Then
            --划价时,直接更改数量,所以不须查划冲销次数
            --插入退费记录
            Insert Into 住院费用记录
              (ID, NO, 记录性质, 记录状态, 序号, 从属父号, 价格父号, 主页id, 病人id, 医嘱序号, 门诊标志, 多病人单, 婴儿费, 姓名, 性别, 年龄, 标识号, 床号, 费别, 病人病区id,
               病人科室id, 收费类别, 收费细目id, 计算单位, 付数, 发药窗口, 数次, 加班标志, 附加标志, 收入项目id, 收据费目, 记帐费用, 标准单价, 应收金额, 实收金额, 开单部门id, 开单人,
               执行部门id, 划价人, 执行人, 执行状态, 执行时间, 操作员编号, 操作员姓名, 发生时间, 登记时间, 保险项目否, 保险大类id, 统筹金额, 保险编码, 记帐单id, 摘要, 费用类型, 是否急诊,
               结论, 医疗小组id)
              Select 病人费用记录_Id.Nextval, NO, 记录性质, 2, 序号, 从属父号, 价格父号, 主页id, 病人id, 医嘱序号, 门诊标志, 多病人单, 婴儿费, 姓名, 性别, 年龄, 标识号,
                     床号, 费别, 病人病区id, 病人科室id, 收费类别, 收费细目id, 计算单位, Decode(Sign(v_准退数量 - Nvl(付数, 1) * 数次), 0, 付数, 1), 发药窗口,
                     Decode(Sign(v_准退数量 - Nvl(付数, 1) * 数次), 0, -1 * 数次, -1 * v_准退数量), 加班标志, 附加标志, 收入项目id, 收据费目, 记帐费用,
                     标准单价, -1 * v_应收金额, -1 * v_实收金额, 开单部门id, 开单人, 执行部门id, 划价人, 执行人, -1 * v_退费次数, 执行时间, 操作员编号_In,
                     操作员姓名_In, 发生时间, v_Curdate, 保险项目否, 保险大类id, -1 * v_统筹金额, 保险编码, 记帐单id, 摘要, 费用类型, 是否急诊, 结论, 医疗小组id
              From 住院费用记录
              Where ID = r_Bill.Id;
          
            --记录病人医嘱附费对应的医嘱ID(不是主费用)
            If v_医嘱id Is Null And r_Bill.医嘱序号 Is Not Null Then
              v_医嘱id := r_Bill.医嘱序号;
            End If;
          
            Update 病人审批项目
            Set 已用数量 = Nvl(已用数量, 0) - v_准退数量
            Where 病人id = r_Bill.病人id And 主页id = r_Bill.主页id And 项目id = r_Bill.收费细目id And Nvl(使用限量, 0) <> 0;
          
            --病人余额
            Update 病人余额
            Set 费用余额 = Nvl(费用余额, 0) - v_实收金额
            Where 病人id = r_Bill.病人id And 类型 = 2 And 性质 = 1;
            If Sql%RowCount = 0 Then
              Insert Into 病人余额
                (病人id, 类型, 性质, 费用余额, 预交余额)
              Values
                (r_Bill.病人id, 2, 1, -1 * v_实收金额, 0);
            End If;
          
            --病人未结费用
            Update 病人未结费用
            Set 金额 = Nvl(金额, 0) - v_实收金额
            Where 病人id = r_Bill.病人id And Nvl(主页id, 0) = Nvl(r_Bill.主页id, 0) And Nvl(病人病区id, 0) = Nvl(r_Bill.病人病区id, 0) And
                  Nvl(病人科室id, 0) = Nvl(r_Bill.病人科室id, 0) And Nvl(开单部门id, 0) = Nvl(r_Bill.开单部门id, 0) And
                  Nvl(执行部门id, 0) = Nvl(r_Bill.执行部门id, 0) And 收入项目id + 0 = r_Bill.收入项目id And 来源途径 + 0 = 2;
            If Sql%RowCount = 0 Then
              Insert Into 病人未结费用
                (病人id, 主页id, 病人病区id, 病人科室id, 开单部门id, 执行部门id, 收入项目id, 来源途径, 金额)
              Values
                (r_Bill.病人id, r_Bill.主页id, r_Bill.病人病区id, r_Bill.病人科室id, r_Bill.开单部门id, r_Bill.执行部门id, r_Bill.收入项目id, 2,
                 -1 * v_实收金额);
            End If;
          
            --标记原费用记录
            --执行状态:全部退完(准退数=剩余数)标记为0,否则保持原状态
            If Instr(',4,5,6,7,', r_Bill.收费类别) = 0 Then
              --一般情况非药品和卫材的项目,不存在部分销帐的情况,只有销帐申请和销帐审核时,才会出现部分销帐,所以
              --执行状态只有两种:0.未执行;1已执行;
              --由于在销帐审核过程中将已执行强制改为了2部分执行,因此需要在此处改为1已执行.未执行的不变.
              Update 住院费用记录
              Set 记录状态 = 3, 执行状态 = Decode(Sign(v_准退数量 - v_剩余数量), 0, 0, Decode(执行状态, 2, 1, 执行状态))
              Where ID = r_Bill.Id;
            Else
              Select Nvl(Sum(Decode(审核人, Null, 1, 0) * Nvl(付数, 1) * 实际数量), 0),
                     Nvl(Sum(Decode(审核人, Null, 0, 1) * Nvl(付数, 1) * 实际数量), 0)
              Into n_未执行数量, n_已执行数量
              From 药品收发记录
              Where NO = No_In And 单据 In (9, 10, 25, 26) And 费用id = r_Bill.Id;
            
              Update 住院费用记录
              Set 记录状态 = 3,
                  执行状态 = Decode(Sign(v_准退数量 - v_剩余数量), 0, 0,
                                 Decode(Sign(n_未执行数量 - v_准退数量), 1, Decode(n_已执行数量, 0, 0, 2), 1))
              Where ID = r_Bill.Id;
            End If;
          End If;
        End If;
      Else
        If v_序号 Is Not Null Then
          v_Err_Msg := '单据中第' || Nvl(r_Bill.价格父号, r_Bill.序号) || '行费用已经完全执行,不能销帐！';
          Raise Err_Item;
        End If;
        --情况:没限定行号,原始单据中包括已经完全执行的
      End If;
    End If;
  End Loop;

  --不存在配药ID,检查该药品是否在输液配药中心
  If v_配药id Is Null And 输液配药检查_In = 1 Then
    For v_费用 In (Select ID
                 From 住院费用记录
                 Where NO = No_In And 记录性质 = 记录性质_In And 记录状态 In (0, 1, 3) And 收费类别 In ('4', '5', '6', '7') And 门诊标志 = 2 And
                       (Instr(',' || v_序号 || ',', ',' || 序号 || ',') > 0 Or v_序号 Is Null)) Loop
      Begin
        Select Count(1)
        Into n_Count
        From 输液配药内容 A, 药品收发记录 B
        Where a.收发id = b.Id And b.费用id = v_费用.Id And Instr(',8,9,10,21,24,25,26,', ',' || b.单据 || ',') > 0;
      Exception
        When Others Then
          n_Count := 0;
      End;
      If n_Count <> 0 Then
        v_Err_Msg := '存在已经进入输液配药中心的待销帐药品，无法完成销帐！';
        Raise Err_Item;
      End If;
    End Loop;
  End If;

  n_部分销帐 := 0;
  ---------------------------------------------------------------------------------
  --药品相关处理:主要是对销帐审核有效.(可以是部分)
  For v_费用 In (Select ID, 序号, 收费类别
               From 住院费用记录
               Where NO = No_In And 记录性质 = 记录性质_In And 记录状态 In (0, 1, 3) And 收费类别 In ('4', '5', '6', '7') And 门诊标志 = 2 And
                     (Instr(',' || v_序号 || ',', ',' || 序号 || ',') > 0 Or v_序号 Is Null)
               Order By 收费细目id) Loop
    --根据费用ID来进行相关的处理
    v_准退数量 := 0;
    If Instr(序号_In, ':') > 0 Then
      v_Tmp := ',' || 序号_In;
      v_Tmp := Substr(v_Tmp, Instr(v_Tmp, ',' || v_费用.序号 || ':') + Length(',' || v_费用.序号 || ':'));
      v_Tmp := Substr(v_Tmp, 1, Instr(v_Tmp || ',', ',') - 1);
      If Instr(v_Tmp, ':') > 0 Then
        v_Tmp := Substr(v_Tmp, 1, Instr(v_Tmp, ':') - 1);
      End If;
      v_准退数量 := v_Tmp;
    End If;
    If v_准退数量 <> 0 Then
      n_部分销帐 := 1;
      n_Temp     := 0;
      --------------------------------------------------------------------------------------
      --检查是否备货记帐卫材,规则如下
      -- a.如果存在存在未审核的其他出库且部分销帐时,直接在原来的基础上更改其他出库数量
      -- b.如果存在存在未审核的其他出库且完全销帐时,直接删除
      -- c.库存处理:还原为虚拟库房的可用数量;发料部门不处理
      -- d.如果已经发了料,这个时间由于其他出库单已经审核,因此就按正常情况流转,库存恢复到发料部门中
      n_虚拟库房id := Null;
      n_其他出库id := Null;
      If v_费用.收费类别 = '4' Then
        Begin
          Select 1, 库房id, ID
          Into n_备货卫材, n_虚拟库房id, n_其他出库id
          From 药品收发记录
          Where 费用id = v_费用.Id And 审核日期 Is Null And 单据 = 21 And Rownum = 1;
        Exception
          When Others Then
            n_备货卫材 := 0;
        End;
      Else
        n_备货卫材 := 0;
      End If;
      --------------------------------------------------------------------------------------
      If v_配药id Is Not Null Then
        Open c_药品 For
          Select /*+ rule*/
           a.Id, a.单据, a.No, a.库房id, a.药品id, a.批次, a.发药方式,
           Decode(a.发药方式, Null, 1, -1, 0, 1) * Nvl(a.付数, 1) * Nvl(a.实际数量, 0) As 数量, a.灭菌效期, a.效期, a.产地, a.批号, a.填制日期,
           a.费用id
          From 药品收发记录 A, Table(f_Str2list(v_配药id)) B, 输液配药内容 C
          Where a.No = No_In And a.单据 In (9, 10, 25, 26) And Mod(a.记录状态, 3) = 1 And a.审核人 Is Null And a.费用id = v_费用.Id And
                a.Id = c.收发id And c.记录id = b.Column_Value
          Order By 填制日期;
      Else
        Open c_药品 For
          Select ID, 单据, NO, 库房id, 药品id, 批次, 发药方式, Decode(发药方式, Null, 1, -1, 0, 1) * Nvl(付数, 1) * Nvl(实际数量, 0) As 数量,
                 灭菌效期, 效期, 产地, 批号, 填制日期, 费用id
          From 药品收发记录
          Where NO = No_In And 单据 In (9, 10, 25, 26) And Mod(记录状态, 3) = 1 And 审核人 Is Null And 费用id = v_费用.Id
          Order By 填制日期;
      End If;
      Loop
        Fetch c_药品
          Into v_药品;
        Exit When c_药品%NotFound;
        n_Temp := v_药品.数量;
        If v_准退数量 >= n_Temp Then
          l_药品收发.Extend;
          l_药品收发(l_药品收发.Count) := v_药品.Id;
          If Nvl(n_其他出库id, 0) > 0 Then
            l_药品收发.Extend;
            l_药品收发(l_药品收发.Count) := n_其他出库id;
          End If;
          v_准退数量 := v_准退数量 - n_Temp;
        Else
          If v_费用.收费类别 = '7' Then
            --当前行的数量要大
            Update 药品收发记录
            Set 付数 = 1, 实际数量 = Decode(付数, Null, 1, 0, 1, 付数) * Nvl(实际数量, 0) - v_准退数量,
                填写数量 = Decode(付数, Null, 1, 0, 1, 付数) * Nvl(填写数量, 0) - v_准退数量,
                成本金额 =
                 (Decode(付数, Null, 1, 0, 1, 付数) * Nvl(实际数量, 0) - v_准退数量) * 成本价,
                零售金额 =
                 (Decode(付数, Null, 1, 0, 1, 付数) * Nvl(实际数量, 0) - v_准退数量) * 零售价,
                差价 = Round((Decode(付数, Null, 1, 0, 1, 付数) * Nvl(实际数量, 0) - v_准退数量) * 零售价 -
                            (Decode(付数, Null, 1, 0, 1, 付数) * Nvl(实际数量, 0) - v_准退数量) * 成本价, 5)
            Where ID = v_药品.Id;
          Else
            Update 药品收发记录
            Set 实际数量 = Nvl(实际数量, 0) - v_准退数量, 填写数量 = Nvl(填写数量, 0) - v_准退数量,
                成本金额 =
                 (Nvl(实际数量, 0) - v_准退数量) * 成本价,
                零售金额 =
                 (Nvl(实际数量, 0) - v_准退数量) * 零售价,
                差价 = Round((Nvl(实际数量, 0) - v_准退数量) * 零售价 - (Nvl(实际数量, 0) - v_准退数量) * 成本价, 5)
            Where ID = v_药品.Id;
          End If;
          --更新其他出库单
          If Nvl(n_其他出库id, 0) <> 0 Then
            If v_费用.收费类别 = '7' Then
              Update 药品收发记录
              Set 付数 = 1, 实际数量 = Decode(付数, Null, 1, 0, 1, 付数) * Nvl(实际数量, 0) - v_准退数量,
                  填写数量 = Decode(付数, Null, 1, 0, 1, 付数) * Nvl(实际数量, 0) - v_准退数量,
                  成本金额 =
                   (Decode(付数, Null, 1, 0, 1, 付数) * Nvl(实际数量, 0) - v_准退数量) * 成本价,
                  零售金额 =
                   (Decode(付数, Null, 1, 0, 1, 付数) * Nvl(实际数量, 0) - v_准退数量) * 零售价,
                  差价 = Round((Decode(付数, Null, 1, 0, 1, 付数) * Nvl(实际数量, 0) - v_准退数量) * 零售价 -
                              (Decode(付数, Null, 1, 0, 1, 付数) * Nvl(实际数量, 0) - v_准退数量) * 成本价, 5)
              Where ID = Nvl(n_其他出库id, 0);
            Else
              Update 药品收发记录
              Set 实际数量 = Nvl(实际数量, 0) - v_准退数量, 填写数量 = Nvl(实际数量, 0) - v_准退数量,
                  成本金额 =
                   (Nvl(实际数量, 0) - v_准退数量) * 成本价,
                  零售金额 =
                   (Nvl(实际数量, 0) - v_准退数量) * 零售价,
                  差价 = Round((Nvl(实际数量, 0) - v_准退数量) * 零售价 - (Nvl(实际数量, 0) - v_准退数量) * 成本价, 5)
              Where ID = Nvl(n_其他出库id, 0);
            End If;
          End If;
          n_Temp     := v_准退数量;
          v_准退数量 := 0;
        End If;
        If Nvl(n_备货卫材, 0) = 1 Then
          n_库房id := n_虚拟库房id;
        Else
          n_库房id := v_药品.库房id;
        End If;
      
        If n_库房id Is Not Null Then
          Update 药品库存
          Set 可用数量 = Nvl(可用数量, 0) + n_Temp
          Where 库房id = n_库房id And 药品id = v_药品.药品id And Nvl(批次, 0) = Nvl(v_药品.批次, 0) And 性质 = 1;
          If Sql%RowCount = 0 Then
            Insert Into 药品库存
              (库房id, 药品id, 性质, 批次, 效期, 可用数量, 上次批号, 上次产地, 灭菌效期)
            Values
              (n_库房id, v_药品.药品id, 1, v_药品.批次, v_药品.效期, n_Temp, v_药品.批号, v_药品.产地, v_药品.灭菌效期);
          End If;
          Delete 药品库存
          Where 库房id = n_库房id And 药品id = v_药品.药品id And Nvl(批次, 0) = Nvl(v_药品.批次, 0) And 性质 = 1 And Nvl(可用数量, 0) = 0 And
                Nvl(实际数量, 0) = 0 And Nvl(实际金额, 0) = 0 And Nvl(实际差价, 0) = 0;
        End If;
      
        If Nvl(n_备货卫材, 0) = 1 Then
          Update 药品库存
          Set 可用数量 = Nvl(可用数量, 0) + n_Temp
          Where 库房id = v_药品.库房id And 药品id = v_药品.药品id And Nvl(批次, 0) = Nvl(v_药品.批次, 0) And 性质 = 1;
          If Sql%RowCount = 0 Then
            Insert Into 药品库存
              (库房id, 药品id, 性质, 批次, 效期, 可用数量, 上次批号, 上次产地, 灭菌效期)
            Values
              (v_药品.库房id, v_药品.药品id, 1, v_药品.批次, v_药品.效期, n_Temp, v_药品.批号, v_药品.产地, v_药品.灭菌效期);
          End If;
        End If;
      
        If v_准退数量 = 0 Then
          Exit;
        End If;
      End Loop;
      --不跟踪卫材的,不检查:因为不跟噻的话,不会在药品收发记录中存在
      If Nvl(v_准退数量, 0) <> 0 And Not (v_费用.收费类别 = '4' And n_Temp = 0) Then
        --未分配完成,表示此药品可能已经执行.
        v_Err_Msg := '要销帐的费用中存在已发的药品或卫材，或已被其他人销帐；这可能是并发操作引起的。';
        Raise Err_Item;
      End If;
    End If;
  End Loop;

  If n_部分销帐 = 0 Then
    ------------------------------------------------------------------------------------------------------------------------
    --先处理备货材料
    For v_出库 In (Select ID, 单据, NO, 库房id, 药品id, 批次, 发药方式, 付数, 实际数量, 灭菌效期, 效期, 产地, 批号, 填制日期, 费用id, 商品条码, 内部条码
                 From 药品收发记录
                 Where 单据 = 21 And Mod(记录状态, 3) = 1 And 审核人 Is Null And
                       费用id In (Select ID
                                From 住院费用记录
                                Where NO = No_In And 记录性质 = 记录性质_In And 记录状态 In (0, 1, 3) And 收费类别 = '4' And 门诊标志 = 2 And
                                      (Instr(',' || v_序号 || ',', ',' || 序号 || ',') > 0 Or v_序号 Is Null))
                 Order By 药品id, 填制日期 Desc) Loop
      --处理药品库存
      If v_出库.库房id Is Not Null Then
        Update 药品库存
        Set 可用数量 = Nvl(可用数量, 0) + Decode(v_出库.发药方式, Null, 1, -1, 0, 1) * Nvl(v_出库.付数, 1) * Nvl(v_出库.实际数量, 0)
        Where 库房id = v_出库.库房id And 药品id = v_出库.药品id And Nvl(批次, 0) = Nvl(v_出库.批次, 0) And 性质 = 1;
        If Sql%RowCount = 0 Then
          Insert Into 药品库存
            (库房id, 药品id, 性质, 批次, 效期, 可用数量, 上次批号, 上次产地, 灭菌效期, 商品条码, 内部条码)
          Values
            (v_出库.库房id, v_出库.药品id, 1, v_出库.批次, v_出库.效期,
             Decode(v_出库.发药方式, Null, 1, -1, 0, 1) * Nvl(v_出库.付数, 1) * Nvl(v_出库.实际数量, 0), v_出库.批号, v_出库.产地, v_出库.灭菌效期,
             v_出库.商品条码, v_出库.内部条码);
        End If;
        Delete 药品库存
        Where 库房id = v_出库.库房id And 药品id = v_出库.药品id And Nvl(批次, 0) = Nvl(v_出库.批次, 0) And 性质 = 1 And Nvl(可用数量, 0) = 0 And
              Nvl(实际数量, 0) = 0 And Nvl(实际金额, 0) = 0 And Nvl(实际差价, 0) = 0;
      End If;
      l_费用id.Extend;
      l_费用id(l_费用id.Count) := v_出库.费用id;
      l_药品收发.Extend;
      l_药品收发(l_药品收发.Count) := v_出库.Id;
    End Loop;
  
    --药品相关内容
    Fetch c_Stock
      Into r_Stock;
    While c_Stock%Found Loop
    
      --处理药品库存
      If r_Stock.库房id Is Not Null Then
      
        Select Decode(Count(Column_Value), Null, 0, 0, 0, 1)
        Into n_备货卫材
        From Table(l_费用id)
        Where Column_Value = r_Stock.费用id;
      
        Update 药品库存
        Set 可用数量 = Nvl(可用数量, 0) + Decode(r_Stock.发药方式, Null, 1, -1, 0, 1) * Nvl(r_Stock.付数, 1) * Nvl(r_Stock.实际数量, 0)
        Where 库房id = r_Stock.库房id And 药品id = r_Stock.药品id And Nvl(批次, 0) = Nvl(r_Stock.批次, 0) And 性质 = 1;
        If Sql%RowCount = 0 Then
          Insert Into 药品库存
            (库房id, 药品id, 性质, 批次, 效期, 可用数量, 上次批号, 上次产地, 灭菌效期)
          Values
            (r_Stock.库房id, r_Stock.药品id, 1, r_Stock.批次, r_Stock.效期,
             Decode(r_Stock.发药方式, Null, 1, -1, 0, 1) * Nvl(r_Stock.付数, 1) * Nvl(r_Stock.实际数量, 0), r_Stock.批号, r_Stock.产地,
             r_Stock.灭菌效期);
        End If;
        Delete 药品库存
        Where 库房id = r_Stock.库房id And 药品id = r_Stock.药品id And Nvl(批次, 0) = Nvl(r_Stock.批次, 0) And 性质 = 1 And
              Nvl(可用数量, 0) = 0 And Nvl(实际数量, 0) = 0 And Nvl(实际金额, 0) = 0 And Nvl(实际差价, 0) = 0;
      End If;
    
      --删除药品收发记录(加上并发操作检查:审核人 Is Null)
      --Delete From 药品收发记录 Where ID = r_Stock.ID And 审核人 Is Null;
    
      l_药品收发.Extend;
      l_药品收发(l_药品收发.Count) := r_Stock.Id;
      Fetch c_Stock
        Into r_Stock;
    End Loop;
    Close c_Stock;
  
    --删除药品收发记录
    Forall I In 1 .. l_药品收发.Count
      Delete From 药品收发记录 Where ID = l_药品收发(I) And 审核人 Is Null;
    If Sql%RowCount <> l_药品收发.Count And l_药品收发.Count <> 0 Then
      v_Err_Msg := '要销帐的费用中存在已发的药品或卫材，或已被其他人销帐；这可能是并发操作引起的。';
      Raise Err_Item;
    End If;
  Else
    --删除药品收发记录
    Forall I In 1 .. l_药品收发.Count
      Delete From 药品收发记录 Where ID = l_药品收发(I) And 审核人 Is Null;
  End If;
  --未发药品记录
  Delete From 未发药品记录 A
  Where NO = No_In And 单据 In (9, 10, 25, 26) And Not Exists
   (Select 1
         From 药品收发记录
         Where 单据 = a.单据 And Nvl(库房id, 0) = Nvl(a.库房id, 0) And NO = No_In And Mod(记录状态, 3) = 1 And 审核人 Is Null);

  ---------------------------------------------------------------------------------
  --如果是划价,直接删除费用记录(药品处理后)
  n_Count := l_划价.Count;
  --删除划价记录
  Forall I In 1 .. l_划价.Count
    Delete From 住院费用记录 Where ID = l_划价(I);

  --删除之后再统一调整序号
  If n_Count > 0 Then
    n_Count := 1;
    For r_Serial In c_Serial Loop
      If r_Serial.价格父号 Is Null Then
        v_父号 := n_Count;
      End If;
    
      Update 住院费用记录
      Set 序号 = n_Count, 价格父号 = Decode(价格父号, Null, Null, v_父号)
      Where NO = No_In And 记录性质 = 记录性质_In And 序号 = r_Serial.序号;
    
      Update 住院费用记录
      Set 从属父号 = n_Count
      Where NO = No_In And 记录性质 = 记录性质_In And 从属父号 = r_Serial.序号;
    
      n_Count := n_Count + 1;
    End Loop;
  
  End If;

  --整张单据全部冲完时，删除病人医嘱附费
  For c_医嘱 In (Select Distinct 医嘱序号
               From 住院费用记录
               Where NO = No_In And 记录性质 = 2 And 记录状态 = 3 And 医嘱序号 Is Not Null) Loop
    Select Nvl(Count(*), 0)
    Into n_Count
    From (Select 序号, Sum(数量) As 剩余数量
           From (Select 记录状态, Nvl(价格父号, 序号) As 序号, Avg(Nvl(付数, 1) * 数次) As 数量
                  From 住院费用记录
                  Where 记录性质 = 2 And 医嘱序号 + 0 = c_医嘱.医嘱序号 And NO = No_In
                  Group By 记录状态, Nvl(价格父号, 序号))
           Group By 序号
           Having Sum(数量) <> 0);
  
    If n_Count = 0 Then
      Delete From 病人医嘱附费 Where 医嘱id = c_医嘱.医嘱序号 And 记录性质 = 2 And NO = No_In;
    End If;
  End Loop;

  If v_医嘱ids Is Not Null Then
    --医嘱处理
    --场合_In    Integer:=0, --0:门诊;1-住院
    --性质_In    Integer:=1, --1-收费单;2-记帐单
    --操作_In    Integer:=0, --0:删除划价单;1-收费或记帐;2-退费或销帐
    --No_In      门诊费用记录.No%Type,
    --医嘱ids_In Varchar2 := Null
    v_医嘱ids := Substr(v_医嘱ids, 2);
    Zl_医嘱发送_计费状态_Update(1, 2, 0, No_In, v_医嘱ids);
  Else
    Zl_医嘱发送_计费状态_Update(1, 2, 2, No_In);
  End If;

Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_住院记帐记录_Delete;
/

--112243:秦龙,2017-09-26,增加传参“本位码”
Create Or Replace Procedure Zl_草药规格_Update
(
  药品id_In       In 药品规格.药品id%Type,
  编码_In         In 收费项目目录.编码%Type,
  规格_In         In 收费项目目录.规格%Type,
  产地_In         In 收费项目目录.产地%Type := Null,
  品名_In         In 收费项目别名.名称%Type := Null,
  拼音_In         In 收费项目别名.简码%Type := Null,
  五笔_In         In 收费项目别名.简码%Type := Null,
  数字码_In       In 收费项目别名.简码%Type := Null,
  标识码_In       In 药品规格.标识码%Type := Null,
  药品来源_In     In 药品规格.药品来源%Type := Null,
  批准文号_In     In 药品规格.批准文号%Type := Null,
  注册商标_In     In 药品规格.注册商标%Type := Null,
  售价单位_In     In 收费项目目录.计算单位%Type := Null,
  剂量系数_In     In 药品规格.剂量系数%Type := Null,
  门诊单位_In     In 药品规格.门诊单位%Type := Null,
  门诊包装_In     In 药品规格.门诊包装%Type := Null,
  药库单位_In     In 药品规格.药库单位%Type := Null,
  药库包装_In     In 药品规格.药库包装%Type := Null,
  申领单位_In     In 药品规格.申领单位%Type := 1,
  申领阀值_In     In 药品规格.申领阀值%Type := Null,
  是否变价_In     In 收费项目目录.是否变价%Type := Null,
  指导批发价_In   In 药品规格.指导批发价%Type := Null,
  扣率_In         In 药品规格.扣率%Type := 95,
  指导零售价_In   In 药品规格.指导零售价%Type := Null,
  指导差价率_In   In 药品规格.指导差价率%Type := Null,
  管理费比例_In   In 药品规格.管理费比例%Type := Null,
  药价级别_In     In 药品规格.药价级别%Type := Null,
  费用类型_In     In 收费项目目录.费用类型%Type := Null,
  服务对象_In     In 收费项目目录.服务对象%Type := Null,
  Gmp认证_In      In 药品规格.Gmp认证%Type := 0,
  招标药品_In     In 药品规格.招标药品%Type := 0,
  屏蔽费别_In     In 收费项目目录.屏蔽费别%Type := 0,
  住院可否分零_In In 药品规格.住院可否分零%Type := 0,
  药库分批_In     In 药品规格.药库分批%Type := Null,
  药房分批_In     In 药品规格.药房分批%Type := Null,
  最大效期_In     In 药品规格.最大效期%Type := Null,
  差价让利比_In   In 药品规格.差价让利比%Type := 0,
  成本价_In       In 药品规格.成本价%Type := 0,
  当前售价_In     In 收费价目.现价%Type := 0,
  收入id_In       In 收费价目.收入项目id%Type := Null,
  合同单位id_In   In 药品规格.合同单位id%Type := Null,
  说明_In         In 收费项目目录.说明%Type := Null,
  动态分零_In     In 药品规格.动态分零%Type := 0,
  发药类型_In     In 药品规格.发药类型%Type := Null,
  备选码_In       In 收费项目目录.备选码%Type := Null,
  增值税率_In     In 药品规格.增值税率%Type := Null,
  基本药物_In     In 药品规格.基本药物%Type := Null,
  中药形态_In     In 药品规格.中药形态%Type := Null,
  站点_In         In 收费项目目录.站点%Type := Null,
  是否常备_In     In 药品规格.是否常备%Type := Null,
  病案费目_In     In 收费项目目录.病案费目%Type := Null,
  门诊可否分零_In In 药品规格.门诊可否分零%Type := 0,
  送货单位_In     药品规格.送货单位%Type := Null,
  送货包装_In     药品规格.送货包装%Type := Null,
  本位码_In         In 药品规格.本位码%Type := Null
) Is
  v_药名id   诊疗项目目录.Id%Type;
  v_名称     诊疗项目目录.名称%Type;
  v_是否变价 收费项目目录.是否变价%Type; --允许定价药品随时改为时价，时价药品只能在未发生的情况下修改为定价，其它情况不允许修改定价属性 
  v_发生     Number(2);
  Err_Notfind Exception;
  v_No       收费价目.No%Type;
  v_Temp     收费项目目录.病案费目%Type;
  v_病案费目 收费项目目录.病案费目%Type;
Begin
  v_病案费目 := 病案费目_In;
  --判断病案费目
  If v_病案费目 Is Null Then
    If 收入id_In Is Not Null Then
      Begin
        Select 病案费目 Into v_Temp From 收入项目 Where ID = 收入id_In;
      Exception
        When Others Then
          v_Temp := Null;
      End;
      If v_Temp Is Not Null Then
        v_病案费目 := v_Temp;
      End If;
    End If;
  End If;
  --通用名称
  Select ID, 名称
  Into v_药名id, v_名称
  From 诊疗项目目录
  Where ID = (Select 药名id From 药品规格 Where 药品id = 药品id_In);
  --取原始的定价属性
  Select 是否变价 Into v_是否变价 From 收费项目目录 Where ID = 药品id_In;
  --规格信息
  Update 收费项目目录
  Set 编码 = 编码_In, 名称 = v_名称, 规格 = 规格_In, 产地 = 产地_In, 计算单位 = 售价单位_In, 费用类型 = 费用类型_In, 服务对象 = 服务对象_In, 屏蔽费别 = 屏蔽费别_In,
      病案费目 = v_病案费目, 说明 = 说明_In, 备选码 = 备选码_In, 站点 = 站点_In
  Where ID = 药品id_In;
  If Sql%RowCount = 0 Then
    Raise Err_Notfind;
  End If;
  Update 药品规格
  Set 标识码 = 标识码_In, 药品来源 = 药品来源_In, 批准文号 = 批准文号_In, 注册商标 = 注册商标_In, 剂量系数 = 剂量系数_In, 门诊单位 = 门诊单位_In, 门诊包装 = 门诊包装_In,
      住院单位 = 门诊单位_In, 住院包装 = 门诊包装_In, 药库单位 = 药库单位_In, 药库包装 = 药库包装_In, 申领单位 = 申领单位_In, 申领阀值 = 申领阀值_In, 指导批发价 = 指导批发价_In,
      扣率 = 扣率_In, 指导零售价 = 指导零售价_In, 指导差价率 = 指导差价率_In, 管理费比例 = 管理费比例_In, 药价级别 = 药价级别_In, 住院可否分零 = 住院可否分零_In,
      药库分批 = 药库分批_In, 药房分批 = 药房分批_In, 最大效期 = 最大效期_In, 招标药品 = 招标药品_In, Gmp认证 = Gmp认证_In, 差价让利比 = 差价让利比_In,
      合同单位id = 合同单位id_In, 动态分零 = 动态分零_In, 发药类型 = 发药类型_In, 增值税率 = 增值税率_In, 基本药物 = 基本药物_In, 中药形态 = 中药形态_In, 是否常备 = 是否常备_In,
      门诊可否分零 = 门诊可否分零_In, 送货单位 = 送货单位_In, 送货包装 = 送货包装_In, 本位码=本位码_In
  Where 药品id = 药品id_In;

  --朱玉宝修改：建立药品（西成药、中成药）时，缺省服务对象为门诊和住院，因此修改规格药品时，不再根据规格药品的服务对象更新药品的服务对象
  --诊疗项目服务对象的更改
  --select nvl(sum(distinct I.服务对象),0) into v_对象
  --from 收费项目目录 I,药品规格 S
  --where I.ID=S.药品ID and S.药名ID=v_药名ID;
  --update 诊疗项目目录
  --set 服务对象=decode(v_对象,0,0,1,1,2,2,3)
  --where ID=v_药名ID;

  --别名的处理
  If 数字码_In Is Null Then
    Delete 收费项目别名 Where 收费细目id = 药品id_In And 性质 = 1 And 码类 = 3;
  Else
    Update 收费项目别名 Set 名称 = v_名称, 简码 = 数字码_In Where 收费细目id = 药品id_In And 性质 = 1 And 码类 = 3;
    If Sql%RowCount = 0 Then
      Insert Into 收费项目别名 (收费细目id, 名称, 性质, 简码, 码类) Values (药品id_In, v_名称, 1, 数字码_In, 3);
    End If;
  End If;
  If 品名_In Is Null Then
    Delete 收费项目别名 Where 收费细目id = 药品id_In And 性质 = 3;
  Else
    If 拼音_In Is Null Then
      Delete 收费项目别名 Where 收费细目id = 药品id_In And 性质 = 3 And 码类 = 1;
    Else
      Update 收费项目别名 Set 名称 = 品名_In, 简码 = 拼音_In Where 收费细目id = 药品id_In And 性质 = 3 And 码类 = 1;
      If Sql%RowCount = 0 Then
        Insert Into 收费项目别名 (收费细目id, 名称, 性质, 简码, 码类) Values (药品id_In, 品名_In, 3, 拼音_In, 1);
      End If;
    End If;
    If 五笔_In Is Null Then
      Delete 收费项目别名 Where 收费细目id = 药品id_In And 性质 = 3 And 码类 = 2;
    Else
      Update 收费项目别名 Set 名称 = 品名_In, 简码 = 五笔_In Where 收费细目id = 药品id_In And 性质 = 3 And 码类 = 2;
      If Sql%RowCount = 0 Then
        Insert Into 收费项目别名 (收费细目id, 名称, 性质, 简码, 码类) Values (药品id_In, 品名_In, 3, 五笔_In, 2);
      End If;
    End If;
  End If;

  --定价信息：如果已经有发生，则不允许直接更改这些信息
  Select Nvl(Count(*), 0) Into v_发生 From 药品收发记录 Where 药品id = 药品id_In And Rownum < 2;
  If v_发生 = 0 Then
    Update 收费项目目录 Set 是否变价 = 是否变价_In Where ID = 药品id_In;
    Update 药品规格 Set 成本价 = 成本价_In Where 药品id = 药品id_In;
    If 收入id_In Is Not Null Then
      Update 收费价目
      Set 现价 = 当前售价_In, 收入项目id = 收入id_In, 变动原因 = 1, 调价说明 = '修改定价', 调价人 = User
      Where 收费细目id = 药品id_In And (Sysdate Between 执行日期 And 终止日期 Or Sysdate >= 执行日期 And 终止日期 Is Null) And 变动原因 = 1;
      If Sql%RowCount = 0 Then
        v_No := Nextno(9);
        Insert Into 收费价目
          (ID, 原价id, 收费细目id, 原价, 现价, 收入项目id, 变动原因, 调价说明, 调价人, 执行日期, 终止日期, NO, 序号)
        Values
          (收费价目_Id.Nextval, Null, 药品id_In, 0, 当前售价_In, 收入id_In, 1, '新增定价', User, Sysdate,
           To_Date('3000-01-01', 'YYYY-MM-DD'), v_No, 1);
      End If;
    End If;
  Else
    --定价药品随时可改为时价
    If v_是否变价 = 0 And 是否变价_In = 1 Then
      Update 收费项目目录 Set 是否变价 = 是否变价_In Where ID = 药品id_In;
    End If;
    --发生业务数据时，不能修改价格但是可以修改收入项目
    Update 收费价目
    Set 收入项目id = 收入id_In
    Where 收费细目id = 药品id_In And (Sysdate Between 执行日期 And 终止日期 Or Sysdate >= 执行日期 And 终止日期 Is Null) And 变动原因 = 1;
  End If;

  --药品生产商比较增加
  If 产地_In Is Not Null Then
    Update 药品生产商 Set 名称 = 产地_In Where 名称 = 产地_In;
    If Sql%RowCount = 0 Then
      Insert Into 药品生产商
        (编码, 名称, 简码)
        Select Nvl(Max(To_Number(编码)), 0) + 1, 产地_In, zlSpellCode(产地_In, 10) From 药品生产商;
    End If;
  End If;

Exception
  When Err_Notfind Then
    Raise_Application_Error(-20101, '[ZLSOFT]该规格不存在，可能已被其他用户删除！[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_草药规格_Update;
/

--112243:秦龙,2017-09-26,增加传参“本位码”
CREATE OR REPLACE Procedure Zl_草药规格_Insert
(
  药名id_In     In 药品规格.药名id%Type,
  药品id_In     In 药品规格.药品id%Type,
  编码_In       In 收费项目目录.编码%Type,
  规格_In       In 收费项目目录.规格%Type,
  产地_In       In 收费项目目录.产地%Type := Null,
  品名_In       In 收费项目别名.名称%Type := Null,
  拼音_In       In 收费项目别名.简码%Type := Null,
  五笔_In       In 收费项目别名.简码%Type := Null,
  数字码_In     In 收费项目别名.简码%Type := Null,
  标识码_In     In 药品规格.标识码%Type := Null,
  药品来源_In   In 药品规格.药品来源%Type := Null,
  批准文号_In   In 药品规格.批准文号%Type := Null,
  注册商标_In   In 药品规格.注册商标%Type := Null,
  售价单位_In   In 收费项目目录.计算单位%Type := Null,
  剂量系数_In   In 药品规格.剂量系数%Type := Null,
  门诊单位_In   In 药品规格.门诊单位%Type := Null,
  门诊包装_In   In 药品规格.门诊包装%Type := Null,
  药库单位_In   In 药品规格.药库单位%Type := Null,
  药库包装_In   In 药品规格.药库包装%Type := Null,
  申领单位_In   In 药品规格.申领单位%Type := 1,
  申领阀值_In   In 药品规格.申领阀值%Type := Null,
  是否变价_In   In 收费项目目录.是否变价%Type := Null,
  指导批发价_In In 药品规格.指导批发价%Type := Null,
  扣率_In       In 药品规格.扣率%Type := 95,
  指导零售价_In In 药品规格.指导零售价%Type := Null,
  指导差价率_In In 药品规格.指导差价率%Type := Null,
  管理费比例_In In 药品规格.管理费比例%Type := Null,
  药价级别_In   In 药品规格.药价级别%Type := Null,
  费用类型_In   In 收费项目目录.费用类型%Type := Null,
  服务对象_In   In 收费项目目录.服务对象%Type := Null,
  Gmp认证_In    In 药品规格.Gmp认证%Type := 0,
  招标药品_In   In 药品规格.招标药品%Type := 0,
  屏蔽费别_In   In 收费项目目录.屏蔽费别%Type := 0,
  住院可否分零_In   In 药品规格.住院可否分零%Type := 0,
  药库分批_In   In 药品规格.药库分批%Type := Null,
  药房分批_In   In 药品规格.药房分批%Type := Null,
  最大效期_In   In 药品规格.最大效期%Type := Null,
  差价让利比_In In 药品规格.差价让利比%Type := 0,
  成本价_In     In 药品规格.成本价%Type := 0,
  当前售价_In   In 收费价目.现价%Type := 0,
  收入id_In     In 收费价目.收入项目id%Type := Null,
  合同单位id_In In 药品规格.合同单位id%Type := Null,
  说明_In       In 收费项目目录.说明%Type := Null,
  动态分零_In   In 药品规格.动态分零%Type := 0,
  发药类型_In   In 药品规格.发药类型%Type := Null,
  备选码_In     In 收费项目目录.备选码%Type := Null,
  增值税率_In   In 药品规格.增值税率%Type := Null,
  基本药物_In   In 药品规格.基本药物%Type := Null,
  中药形态_In   In 药品规格.中药形态%Type := Null,
  站点_In       In 收费项目目录.站点%Type := Null,
  是否常备_In   In 药品规格.是否常备%Type := Null ,
  病案费目_in in 收费项目目录.病案费目%type :=Null,
  门诊可否分零_In   In 药品规格.门诊可否分零%Type := 0,
  送货单位_in     in 药品规格.送货单位%type   :=null,
  送货包装_in     in 药品规格.送货包装%type :=null,
  本位码_In         In 药品规格.本位码%Type := Null
) Is

  v_类别 诊疗项目目录.类别%Type;
  v_名称 诊疗项目目录.名称%Type;
  v_Kind Varchar2(20);
  v_No   收费价目.No%Type;
   v_Temp 收费项目目录.病案费目%type;
  v_病案费目 收费项目目录.病案费目%type;
  --盘点库房的工作性质
  Cursor c_Storageid Is
    Select Distinct 部门id From 部门性质说明 Where 工作性质 Like v_Kind Or 工作性质 = '制剂室';
  r_Storageid c_Storageid%RowType;

Begin
  v_病案费目 :=病案费目_in;
  --判断病案费目
    if v_病案费目 is null then
     if 收入id_In is not null  then
        begin
        select 病案费目 into v_Temp from 收入项目 where id=收入id_In;
        exception
          when others then
            v_Temp :=Null;
          end;
        if  v_Temp is not null then
          v_病案费目 :=v_Temp;
        end if;
     end if;
   end if;
  --类别和名称
  Select 类别, 名称 Into v_类别, v_名称 From 诊疗项目目录 Where ID = 药名id_In;
  --规格信息
  Insert Into 收费项目目录
    (类别, ID, 编码, 名称, 规格, 产地, 计算单位, 费用类型, 服务对象, 屏蔽费别, 是否变价, 建档时间, 撤档时间, 说明, 备选码, 站点,病案费目)
  Values
    (v_类别, 药品id_In, 编码_In, v_名称, 规格_In, 产地_In, 售价单位_In, 费用类型_In, 服务对象_In, 屏蔽费别_In, 是否变价_In, Sysdate,
     To_Date('3000-01-01', 'YYYY-MM-DD'), 说明_In, 备选码_In, 站点_In,v_病案费目);
  Insert Into 药品规格
    (药名id, 药品id, 标识码, 药品来源, 批准文号, 注册商标, 剂量系数, 门诊单位, 门诊包装, 住院单位, 住院包装, 药库单位, 药库包装, 申领单位, 申领阀值, 指导批发价, 扣率, 指导零售价, 指导差价率,
     管理费比例, 药价级别, 成本价, Gmp认证, 招标药品, 差价让利比, 住院可否分零, 药库分批, 药房分批, 最大效期, 合同单位id, 动态分零, 发药类型, 增值税率, 基本药物, 中药形态, 是否常备,门诊可否分零,送货单位,送货包装,本位码)
  Values
    (药名id_In, 药品id_In, 标识码_In, 药品来源_In, 批准文号_In, 注册商标_In, 剂量系数_In, 门诊单位_In, 门诊包装_In, 门诊单位_In, 门诊包装_In, 药库单位_In, 药库包装_In,
     申领单位_In, 申领阀值_In, 指导批发价_In, 扣率_In, 指导零售价_In, 指导差价率_In, 管理费比例_In, 药价级别_In, 成本价_In, Gmp认证_In, 招标药品_In, 差价让利比_In,
     住院可否分零_In, 药库分批_In, 药房分批_In, 最大效期_In, 合同单位id_In, 动态分零_In, 发药类型_In, 增值税率_In, 基本药物_In, 中药形态_In, 是否常备_In,门诊可否分零_In,送货单位_in,送货包装_in,本位码_In);

  --朱玉宝修改：建立药品（西成药、中成药）时，缺省服务对象为门诊和住院，因此建立规格药品时，不再根据规格药品的服务对象更新药品的服务对象
  --诊疗项目服务对象的更改
  --select nvl(sum(distinct I.服务对象),0) into v_对象
  --from 收费项目目录 I,药品规格 S
  --where I.ID=S.药品ID and S.药名ID=药名ID_IN;
  --update 诊疗项目目录
  --set 服务对象=decode(v_对象,0,0,1,1,2,2,3)
  --where ID=药名ID_IN;

  --别名的处理
  Insert Into 收费项目别名
    (收费细目id, 名称, 性质, 简码, 码类)
    Select 药品id_In, 名称, 性质, 简码, 码类 From 诊疗项目别名 Where 诊疗项目id = 药名id_In;
  If 数字码_In Is Not Null Then
    Insert Into 收费项目别名 (收费细目id, 名称, 性质, 简码, 码类) Values (药品id_In, v_名称, 1, 数字码_In, 3);
  End If;
  If (品名_In Is Not Null) And (拼音_In Is Not Null) Then
    Insert Into 收费项目别名 (收费细目id, 名称, 性质, 简码, 码类) Values (药品id_In, 品名_In, 3, 拼音_In, 1);
  End If;
  If (品名_In Is Not Null) And (五笔_In Is Not Null) Then
    Insert Into 收费项目别名 (收费细目id, 名称, 性质, 简码, 码类) Values (药品id_In, 品名_In, 3, 五笔_In, 2);
  End If;

  --定价信息
  If 收入id_In Is Not Null Then
    v_No := Nextno(9);
    Insert Into 收费价目
      (ID, 原价id, 收费细目id, 原价, 现价, 收入项目id, 变动原因, 调价说明, 调价人, 执行日期, 终止日期, NO, 序号)
    Values
      (收费价目_Id.Nextval, Null, 药品id_In, 0, 当前售价_In, 收入id_In, 1, '新增定价', User, Sysdate,
       To_Date('3000-01-01', 'YYYY-MM-DD'), v_No, 1);
  End If;

  --药品生产商比较增加
  If 产地_In Is Not Null Then
    Update 药品生产商 Set 名称 = 产地_In Where 名称 = 产地_In;
    If Sql%RowCount = 0 Then
      Insert Into 药品生产商
        (编码, 名称, 简码)
        Select Nvl(Max(To_Number(编码)), 0) + 1, 产地_In, zlSpellCode(产地_In, 10) From 药品生产商;
    End If;
  End If;

  --插入该规格的服务科室
  Insert Into 收费执行科室
    (收费细目id, 病人来源, 开单科室id, 执行科室id)
    Select 药品id_In, 病人来源, 开单科室id, 执行科室id From 诊疗执行科室 Where 诊疗项目id = 药名id_In;

  --插入盘点属性
  v_Kind := '中药%';

  For r_Storageid In c_Storageid Loop
    Insert Into 药品储备限额
      (库房id, 药品id, 上限, 下限, 盘点属性, 库房货位)
    Values
      (r_Storageid.部门id, 药品id_In, 0, 0, '1111', Null);
  End Loop;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_草药规格_Insert;
/

--112243:秦龙,2017-09-26,增加传参“本位码”
Create Or Replace Procedure Zl_成药规格_Update
(
  药品id_In       In 药品规格.药品id%Type,
  编码_In         In 收费项目目录.编码%Type,
  规格_In         In 收费项目目录.规格%Type,
  产地_In         In 收费项目目录.产地%Type := Null,
  品名_In         In 收费项目别名.名称%Type := Null,
  拼音_In         In 收费项目别名.简码%Type := Null,
  五笔_In         In 收费项目别名.简码%Type := Null,
  数字码_In       In 收费项目别名.简码%Type := Null,
  标识码_In       In 药品规格.标识码%Type := Null,
  药品来源_In     In 药品规格.药品来源%Type := Null,
  批准文号_In     In 药品规格.批准文号%Type := Null,
  注册商标_In     In 药品规格.注册商标%Type := Null,
  售价单位_In     In 收费项目目录.计算单位%Type := Null,
  剂量系数_In     In 药品规格.剂量系数%Type := Null,
  门诊单位_In     In 药品规格.门诊单位%Type := Null,
  门诊包装_In     In 药品规格.门诊包装%Type := Null,
  住院单位_In     In 药品规格.住院单位%Type := Null,
  住院包装_In     In 药品规格.住院包装%Type := Null,
  药库单位_In     In 药品规格.药库单位%Type := Null,
  药库包装_In     In 药品规格.药库包装%Type := Null,
  申领单位_In     In 药品规格.申领单位%Type := 1,
  申领阀值_In     In 药品规格.申领阀值%Type := Null,
  是否变价_In     In 收费项目目录.是否变价%Type := Null,
  指导批发价_In   In 药品规格.指导批发价%Type := Null,
  扣率_In         In 药品规格.扣率%Type := 95,
  指导零售价_In   In 药品规格.指导零售价%Type := Null,
  指导差价率_In   In 药品规格.指导差价率%Type := Null,
  管理费比例_In   In 药品规格.管理费比例%Type := Null,
  药价级别_In     In 药品规格.药价级别%Type := Null,
  费用类型_In     In 收费项目目录.费用类型%Type := Null,
  服务对象_In     In 收费项目目录.服务对象%Type := Null,
  Gmp认证_In      In 药品规格.Gmp认证%Type := 0,
  招标药品_In     In 药品规格.招标药品%Type := 0,
  屏蔽费别_In     In 收费项目目录.屏蔽费别%Type := 0,
  住院可否分零_In In 药品规格.住院可否分零%Type := 0,
  药库分批_In     In 药品规格.药库分批%Type := Null,
  药房分批_In     In 药品规格.药房分批%Type := Null,
  最大效期_In     In 药品规格.最大效期%Type := Null,
  差价让利比_In   In 药品规格.差价让利比%Type := 0,
  成本价_In       In 药品规格.成本价%Type := 0,
  当前售价_In     In 收费价目.现价%Type := 0,
  收入id_In       In 收费价目.收入项目id%Type := Null,
  合同单位id_In   In 药品规格.合同单位id%Type := Null,
  说明_In         In 收费项目目录.说明%Type := Null,
  动态分零_In     In 药品规格.动态分零%Type := 0,
  发药类型_In     In 药品规格.发药类型%Type := Null,
  备选码_In       In 收费项目目录.备选码%Type := Null,
  增值税率_In     In 药品规格.增值税率%Type := Null,
  基本药物_In     In 药品规格.基本药物%Type := Null,
  站点_In         In 收费项目目录.站点%Type := Null,
  是否常备_In     In 药品规格.是否常备%Type := Null,
  存储温度_In     In 输液药品属性.存储温度%Type := Null,
  存储条件_In     In 输液药品属性.存储条件%Type := Null,
  配药类型_In     In 输液药品属性.配药类型%Type := Null,
  是否不予配置_In In 输液药品属性.是否不予配置%Type := Null,
  容量_In         In 药品规格.容量%Type := Null,
  病案费目_In     In 收费项目目录.病案费目%Type := Null,
  门诊可否分零_In In 药品规格.门诊可否分零%Type := 0,
  Ddd值_In        In 药品规格.Ddd值%Type := 0,
  高危药品_In     药品规格.高危药品%Type := Null,
  送货单位_In     In 药品规格.送货单位%Type := Null,
  送货包装_In     In 药品规格.送货包装%Type := Null,
  输液注意事项_In In 输液药品属性.输液注意事项%type:=Null,
  本位码_In         In 药品规格.本位码%Type := Null
) Is
  v_药名id   诊疗项目目录.Id%Type;
  v_名称     诊疗项目目录.名称%Type;
  v_是否变价 收费项目目录.是否变价%Type; --允许定价药品随时改为时价，时价药品只能在未发生的情况下修改为定价，其它情况不允许修改定价属性 
  v_发生     Number(2);
  Err_Notfind Exception;
  v_No       收费价目.No%Type;
  v_Temp     收费项目目录.病案费目%Type;
  v_病案费目 收费项目目录.病案费目%Type;
Begin
  v_病案费目 := 病案费目_In;
  --判断病案费目
  If v_病案费目 Is Null Then
    If 收入id_In Is Not Null Then
      Begin
        Select 病案费目 Into v_Temp From 收入项目 Where ID = 收入id_In;
      Exception
        When Others Then
          v_Temp := Null;
      End;
      If v_Temp Is Not Null Then
        v_病案费目 := v_Temp;
      End If;
    End If;
  End If;
  --通用名称
  Select ID, 名称
  Into v_药名id, v_名称
  From 诊疗项目目录
  Where ID = (Select 药名id From 药品规格 Where 药品id = 药品id_In);
  --取原始的定价属性
  Select 是否变价 Into v_是否变价 From 收费项目目录 Where ID = 药品id_In;
  --规格信息
  Update 收费项目目录
  Set 编码 = 编码_In, 名称 = v_名称, 规格 = 规格_In, 产地 = 产地_In, 计算单位 = 售价单位_In, 费用类型 = 费用类型_In, 服务对象 = 服务对象_In, 屏蔽费别 = 屏蔽费别_In,
      病案费目 = v_病案费目, 说明 = 说明_In, 备选码 = 备选码_In, 站点 = 站点_In
  Where ID = 药品id_In;
  If Sql%RowCount = 0 Then
    Raise Err_Notfind;
  End If;
  Update 药品规格
  Set 标识码 = 标识码_In, 药品来源 = 药品来源_In, 批准文号 = 批准文号_In, 注册商标 = 注册商标_In, 剂量系数 = 剂量系数_In, 门诊单位 = 门诊单位_In, 门诊包装 = 门诊包装_In,
      住院单位 = 住院单位_In, 住院包装 = 住院包装_In, 药库单位 = 药库单位_In, 药库包装 = 药库包装_In, 申领单位 = 申领单位_In, 申领阀值 = 申领阀值_In, 指导批发价 = 指导批发价_In,
      扣率 = 扣率_In, 指导零售价 = 指导零售价_In, 指导差价率 = 指导差价率_In, 管理费比例 = 管理费比例_In, 药价级别 = 药价级别_In, 住院可否分零 = 住院可否分零_In,
      药库分批 = 药库分批_In, 药房分批 = 药房分批_In, 最大效期 = 最大效期_In, 招标药品 = 招标药品_In, Gmp认证 = Gmp认证_In, 差价让利比 = 差价让利比_In,
      合同单位id = 合同单位id_In, 动态分零 = 动态分零_In, 发药类型 = 发药类型_In, 增值税率 = 增值税率_In, 基本药物 = 基本药物_In, 是否常备 = 是否常备_In, 容量 = 容量_In,
      门诊可否分零 = 门诊可否分零_In, Ddd值 = Ddd值_In, 高危药品 = 高危药品_In, 送货单位 = 送货单位_In, 送货包装 = 送货包装_In, 本位码=本位码_In
  Where 药品id = 药品id_In;

  --朱玉宝修改：建立药品（西成药、中成药）时，缺省服务对象为门诊和住院，因此修改规格药品时，不再根据规格药品的服务对象更新药品的服务对象
  --诊疗项目服务对象的更改
  --select nvl(sum(distinct I.服务对象),0) into v_对象
  --from 收费项目目录 I,药品规格 S
  --where I.ID=S.药品ID and S.药名ID=v_药名ID;
  --update 诊疗项目目录
  --set 服务对象=decode(v_对象,0,0,1,1,2,2,3)
  --where ID=v_药名ID;

  --别名的处理
  If 数字码_In Is Null Then
    Delete 收费项目别名 Where 收费细目id = 药品id_In And 性质 = 1 And 码类 = 3;
  Else
    Update 收费项目别名 Set 名称 = v_名称, 简码 = 数字码_In Where 收费细目id = 药品id_In And 性质 = 1 And 码类 = 3;
    If Sql%RowCount = 0 Then
      Insert Into 收费项目别名 (收费细目id, 名称, 性质, 简码, 码类) Values (药品id_In, v_名称, 1, 数字码_In, 3);
    End If;
  End If;
  If 品名_In Is Null Then
    Delete 收费项目别名 Where 收费细目id = 药品id_In And 性质 = 3;
  Else
    If 拼音_In Is Null Then
      Delete 收费项目别名 Where 收费细目id = 药品id_In And 性质 = 3 And 码类 = 1;
    Else
      Update 收费项目别名 Set 名称 = 品名_In, 简码 = 拼音_In Where 收费细目id = 药品id_In And 性质 = 3 And 码类 = 1;
      If Sql%RowCount = 0 Then
        Insert Into 收费项目别名 (收费细目id, 名称, 性质, 简码, 码类) Values (药品id_In, 品名_In, 3, 拼音_In, 1);
      End If;
    End If;
    If 五笔_In Is Null Then
      Delete 收费项目别名 Where 收费细目id = 药品id_In And 性质 = 3 And 码类 = 2;
    Else
      Update 收费项目别名 Set 名称 = 品名_In, 简码 = 五笔_In Where 收费细目id = 药品id_In And 性质 = 3 And 码类 = 2;
      If Sql%RowCount = 0 Then
        Insert Into 收费项目别名 (收费细目id, 名称, 性质, 简码, 码类) Values (药品id_In, 品名_In, 3, 五笔_In, 2);
      End If;
    End If;
  End If;

  --定价信息：如果已经有发生，则不允许直接更改这些信息
  Select Nvl(Count(*), 0) Into v_发生 From 药品收发记录 Where 药品id = 药品id_In And Rownum < 2;
  If v_发生 = 0 Then
    Update 收费项目目录 Set 是否变价 = 是否变价_In Where ID = 药品id_In;
    Update 药品规格 Set 成本价 = 成本价_In Where 药品id = 药品id_In;
    If 收入id_In Is Not Null Then
      Update 收费价目
      Set 现价 = 当前售价_In, 收入项目id = 收入id_In, 变动原因 = 1, 调价说明 = '修改定价', 调价人 = User
      Where 收费细目id = 药品id_In And (Sysdate Between 执行日期 And 终止日期 Or Sysdate >= 执行日期 And 终止日期 Is Null) And 变动原因 = 1;
      If Sql%RowCount = 0 Then
        v_No := Nextno(9);
        Insert Into 收费价目
          (ID, 原价id, 收费细目id, 原价, 现价, 收入项目id, 变动原因, 调价说明, 调价人, 执行日期, 终止日期, NO, 序号)
        Values
          (收费价目_Id.Nextval, Null, 药品id_In, 0, 当前售价_In, 收入id_In, 1, '新增定价', User, Sysdate,
           To_Date('3000-01-01', 'YYYY-MM-DD'), v_No, 1);
      End If;
    End If;
  Else
    --定价药品随时可改为时价
    If v_是否变价 = 0 And 是否变价_In = 1 Then
      Update 收费项目目录 Set 是否变价 = 是否变价_In Where ID = 药品id_In;
    End If;
    --发生业务数据时，不能修改价格但是可以修改收入项目
    Update 收费价目
    Set 收入项目id = 收入id_In
    Where 收费细目id = 药品id_In And (Sysdate Between 执行日期 And 终止日期 Or Sysdate >= 执行日期 And 终止日期 Is Null) And 变动原因 = 1;
  End If;

  --药品生产商比较增加
  If 产地_In Is Not Null Then
    Update 药品生产商 Set 名称 = 产地_In Where 名称 = 产地_In;
    If Sql%RowCount = 0 Then
      Insert Into 药品生产商
        (编码, 名称, 简码)
        Select Nvl(Max(To_Number(编码)), 0) + 1, 产地_In, zlSpellCode(产地_In, 10) From 药品生产商;
    End If;
  End If;

  --修改输液药品属性
  Update 输液药品属性
  Set 存储温度 = 存储温度_In, 存储条件 = 存储条件_In, 配药类型 = 配药类型_In, 是否不予配置 = 是否不予配置_In,输液注意事项=输液注意事项_In
  Where 药品id = 药品id_In;

  If Sql%NotFound Then
    Insert Into 输液药品属性
      (药品id, 存储温度, 存储条件, 配药类型, 是否不予配置,输液注意事项)
    Values
      (药品id_In, 存储温度_In, 存储条件_In, 配药类型_In, 是否不予配置_In,输液注意事项_In);
  End If;
Exception
  When Err_Notfind Then
    Raise_Application_Error(-20101, '[ZLSOFT]该规格不存在，可能已被其他用户删除！[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_成药规格_Update;
/

--112243:秦龙,2017-09-26,增加传参“本位码”
Create Or Replace Procedure Zl_成药规格_Insert
(
  药名id_In       In 药品规格.药名id%Type,
  药品id_In       In 药品规格.药品id%Type,
  编码_In         In 收费项目目录.编码%Type,
  规格_In         In 收费项目目录.规格%Type,
  产地_In         In 收费项目目录.产地%Type := Null,
  品名_In         In 收费项目别名.名称%Type := Null,
  拼音_In         In 收费项目别名.简码%Type := Null,
  五笔_In         In 收费项目别名.简码%Type := Null,
  数字码_In       In 收费项目别名.简码%Type := Null,
  标识码_In       In 药品规格.标识码%Type := Null,
  药品来源_In     In 药品规格.药品来源%Type := Null,
  批准文号_In     In 药品规格.批准文号%Type := Null,
  注册商标_In     In 药品规格.注册商标%Type := Null,
  售价单位_In     In 收费项目目录.计算单位%Type := Null,
  剂量系数_In     In 药品规格.剂量系数%Type := Null,
  门诊单位_In     In 药品规格.门诊单位%Type := Null,
  门诊包装_In     In 药品规格.门诊包装%Type := Null,
  住院单位_In     In 药品规格.住院单位%Type := Null,
  住院包装_In     In 药品规格.住院包装%Type := Null,
  药库单位_In     In 药品规格.药库单位%Type := Null,
  药库包装_In     In 药品规格.药库包装%Type := Null,
  申领单位_In     In 药品规格.申领单位%Type := 1,
  申领阀值_In     In 药品规格.申领阀值%Type := Null,
  是否变价_In     In 收费项目目录.是否变价%Type := Null,
  指导批发价_In   In 药品规格.指导批发价%Type := Null,
  扣率_In         In 药品规格.扣率%Type := 95,
  指导零售价_In   In 药品规格.指导零售价%Type := Null,
  指导差价率_In   In 药品规格.指导差价率%Type := Null,
  管理费比例_In   In 药品规格.管理费比例%Type := Null,
  药价级别_In     In 药品规格.药价级别%Type := Null,
  费用类型_In     In 收费项目目录.费用类型%Type := Null,
  服务对象_In     In 收费项目目录.服务对象%Type := Null,
  Gmp认证_In      In 药品规格.Gmp认证%Type := 0,
  招标药品_In     In 药品规格.招标药品%Type := 0,
  屏蔽费别_In     In 收费项目目录.屏蔽费别%Type := 0,
  住院可否分零_In In 药品规格.住院可否分零%Type := 0,
  药库分批_In     In 药品规格.药库分批%Type := Null,
  药房分批_In     In 药品规格.药房分批%Type := Null,
  最大效期_In     In 药品规格.最大效期%Type := Null,
  差价让利比_In   In 药品规格.差价让利比%Type := 0,
  成本价_In       In 药品规格.成本价%Type := 0,
  当前售价_In     In 收费价目.现价%Type := 0,
  收入id_In       In 收费价目.收入项目id%Type := Null,
  合同单位id_In   In 药品规格.合同单位id%Type := Null,
  说明_In         In 收费项目目录.说明%Type := Null,
  动态分零_In     In 药品规格.动态分零%Type := 0,
  发药类型_In     In 药品规格.发药类型%Type := Null,
  备选码_In       In 收费项目目录.备选码%Type := Null,
  增值税率_In     In 药品规格.增值税率%Type := Null,
  基本药物_In     In 药品规格.基本药物%Type := Null,
  站点_In         In 收费项目目录.站点%Type := Null,
  是否常备_In     In 药品规格.是否常备%Type := Null,
  存储温度_In     In 输液药品属性.存储温度%Type := Null,
  存储条件_In     In 输液药品属性.存储条件%Type := Null,
  配药类型_In     In 输液药品属性.配药类型%Type := Null,
  是否不予配置_In In 输液药品属性.是否不予配置%Type := Null,
  容量_In         In 药品规格.容量%Type := Null,
  病案费目_In     In 收费项目目录.病案费目%Type := Null,
  门诊可否分零_In In 药品规格.门诊可否分零%Type := 0,
  Ddd值_In        In 药品规格.Ddd值%Type := 0,
  高危药品_In     In 药品规格.高危药品%Type := Null,
  送货单位_in     In 药品规格.送货单位%type :=null,
  送货包装_in     in 药品规格.送货包装%type :=null,
  输液注意事项_In in 输液药品属性.输液注意事项%type:=null,
  本位码_In         In 药品规格.本位码%Type := Null
) Is

  v_类别     诊疗项目目录.类别%Type;
  v_名称     诊疗项目目录.名称%Type;
  v_Kind     Varchar2(20);
  v_No       收费价目.No%Type;
  v_Temp     收费项目目录.病案费目%Type;
  v_病案费目 收费项目目录.病案费目%Type;

  --盘点库房的工作性质
  Cursor c_Storageid Is
    Select Distinct 部门id From 部门性质说明 Where 工作性质 Like v_Kind Or 工作性质 = '制剂室';
  r_Storageid c_Storageid%RowType;

Begin
  v_病案费目 := 病案费目_In;
  --判断病案费目
  If v_病案费目 Is Null Then
    If 收入id_In Is Not Null Then
      Begin
        Select 病案费目 Into v_Temp From 收入项目 Where ID = 收入id_In;
      Exception
        When Others Then
          v_Temp := Null;
      End;
      If v_Temp Is Not Null Then
        v_病案费目 := v_Temp;
      End If;
    End If;
  End If;
  --类别和名称
  Select 类别, 名称 Into v_类别, v_名称 From 诊疗项目目录 Where ID = 药名id_In;
  --规格信息
  Insert Into 收费项目目录
    (类别, ID, 编码, 名称, 规格, 产地, 计算单位, 费用类型, 服务对象, 屏蔽费别, 是否变价, 建档时间, 撤档时间, 说明, 备选码, 站点, 病案费目)
  Values
    (v_类别, 药品id_In, 编码_In, v_名称, 规格_In, 产地_In, 售价单位_In, 费用类型_In, 服务对象_In, 屏蔽费别_In, 是否变价_In, Sysdate,
     To_Date('3000-01-01', 'YYYY-MM-DD'), 说明_In, 备选码_In, 站点_In, v_病案费目);
  Insert Into 药品规格
    (药名id, 药品id, 标识码, 药品来源, 批准文号, 注册商标, 剂量系数, 门诊单位, 门诊包装, 住院单位, 住院包装, 药库单位, 药库包装, 申领单位, 申领阀值, 指导批发价, 扣率, 指导零售价, 指导差价率,
     管理费比例, 药价级别, 成本价, Gmp认证, 招标药品, 差价让利比, 住院可否分零, 药库分批, 药房分批, 最大效期, 合同单位id, 动态分零, 发药类型, 增值税率, 基本药物, 是否常备, 容量, 门诊可否分零,
     Ddd值, 高危药品,送货单位,送货包装,本位码)
  Values
    (药名id_In, 药品id_In, 标识码_In, 药品来源_In, 批准文号_In, 注册商标_In, 剂量系数_In, 门诊单位_In, 门诊包装_In, 住院单位_In, 住院包装_In, 药库单位_In, 药库包装_In,
     申领单位_In, 申领阀值_In, 指导批发价_In, 扣率_In, 指导零售价_In, 指导差价率_In, 管理费比例_In, 药价级别_In, 成本价_In, Gmp认证_In, 招标药品_In, 差价让利比_In,
     住院可否分零_In, 药库分批_In, 药房分批_In, 最大效期_In, 合同单位id_In, 动态分零_In, 发药类型_In, 增值税率_In, 基本药物_In, 是否常备_In, 容量_In, 门诊可否分零_In,
     Ddd值_In, 高危药品_In,送货单位_in,送货包装_in,本位码_In);

  --朱玉宝修改：建立药品（西成药、中成药）时，缺省服务对象为门诊和住院，因此建立规格药品时，不再根据规格药品的服务对象更新药品的服务对象
  --诊疗项目服务对象的更改
  --select nvl(sum(distinct I.服务对象),0) into v_对象
  --from 收费项目目录 I,药品规格 S
  --where I.ID=S.药品ID and S.药名ID=药名ID_IN;
  --update 诊疗项目目录
  --set 服务对象=decode(v_对象,0,0,1,1,2,2,3)
  --where ID=药名ID_IN;

  --别名的处理
  Insert Into 收费项目别名
    (收费细目id, 名称, 性质, 简码, 码类)
    Select 药品id_In, 名称, 性质, 简码, 码类 From 诊疗项目别名 Where 诊疗项目id = 药名id_In;
  If 数字码_In Is Not Null Then
    Insert Into 收费项目别名 (收费细目id, 名称, 性质, 简码, 码类) Values (药品id_In, v_名称, 1, 数字码_In, 3);
  End If;
  If (品名_In Is Not Null) And (拼音_In Is Not Null) Then
    Insert Into 收费项目别名 (收费细目id, 名称, 性质, 简码, 码类) Values (药品id_In, 品名_In, 3, 拼音_In, 1);
  End If;
  If (品名_In Is Not Null) And (五笔_In Is Not Null) Then
    Insert Into 收费项目别名 (收费细目id, 名称, 性质, 简码, 码类) Values (药品id_In, 品名_In, 3, 五笔_In, 2);
  End If;

  --定价信息
  If 收入id_In Is Not Null Then
    v_No := Nextno(9);
    Insert Into 收费价目
      (ID, 原价id, 收费细目id, 原价, 现价, 收入项目id, 变动原因, 调价说明, 调价人, 执行日期, 终止日期, NO, 序号)
    Values
      (收费价目_Id.Nextval, Null, 药品id_In, 0, 当前售价_In, 收入id_In, 1, '新增定价', User, Sysdate,
       To_Date('3000-01-01', 'YYYY-MM-DD'), v_No, 1);
  End If;

  --药品生产商比较增加
  If 产地_In Is Not Null Then
    Update 药品生产商 Set 名称 = 产地_In Where 名称 = 产地_In;
    If Sql%RowCount = 0 Then
      Insert Into 药品生产商
        (编码, 名称, 简码)
        Select Nvl(Max(To_Number(编码)), 0) + 1, 产地_In, zlSpellCode(产地_In, 10) From 药品生产商;
    End If;
  End If;

  --插入该规格的服务科室
  Insert Into 收费执行科室
    (收费细目id, 病人来源, 开单科室id, 执行科室id)
    Select 药品id_In, 病人来源, 开单科室id, 执行科室id From 诊疗执行科室 Where 诊疗项目id = 药名id_In;

  --插入盘点属性

  If v_类别 = 5 Then
    v_Kind := '西药%';
  Else
    v_Kind := '成药%';
  End If;

  For r_Storageid In c_Storageid Loop
    Insert Into 药品储备限额
      (库房id, 药品id, 上限, 下限, 盘点属性, 库房货位)
    Values
      (r_Storageid.部门id, 药品id_In, 0, 0, '1111', Null);
  End Loop;

  --插入输液药品属性
  Insert Into 输液药品属性
    (药品id, 存储温度, 存储条件, 配药类型, 是否不予配置,输液注意事项)
  Values
    (药品id_In, 存储温度_In, 存储条件_In, 配药类型_In, 是否不予配置_In,输液注意事项_In);
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_成药规格_Insert;
/

--113345:焦博,2017-09-21,调用Oracle过程Zl_病人预交记录_Delete时，没有更新票据打印内容
Create Or Replace Procedure Zl_病人预交记录_Delete
(
  Id_In         病人预交记录.Id%Type,
  摘要_In       病人预交记录.摘要%Type,
  操作员编号_In 病人预交记录.操作员编号%Type,
  操作员姓名_In 病人预交记录.操作员姓名%Type,
  帐户退费_In   Number := 1,
  冲预交id_In   病人预交记录.Id%Type := Null,
  票据号_In     病人预交记录.实际票号%Type := Null,
  领用id_In     票据领用记录.Id%Type := Null
) As
  Cursor c_Moneyinfo Is
    Select ID, NO, 金额, 结算方式, 病人id, 预交类别
    From 病人预交记录
    Where ID = Id_In And 记录性质 = 1 And 记录状态 = 1;
  r_Moneyrow c_Moneyinfo%RowType;

  v_打印id   票据打印内容.Id%Type;
  v_性质     结算方式.性质%Type;
  v_现金     结算方式.名称%Type;
  v_个人帐户 结算方式.名称%Type;
  n_返回值   病人余额.预交余额%Type;
  n_预交id   病人预交记录.Id%Type;
  v_Date     Date;
  Err_Custom Exception;
  n_组id 财务缴款分组.Id%Type;
  v_Msg  Varchar2(500);

Begin
  n_组id := Zl_Get组id(操作员姓名_In);

  --获取结算方式名称
  Begin
    Select 名称 Into v_现金 From 结算方式 Where 性质 = 1;
  Exception
    When Others Then
      v_现金 := '现金';
  End;
  Begin
    Select 名称 Into v_个人帐户 From 结算方式 Where 性质 = 3;
  Exception
    When Others Then
      v_个人帐户 := '个人帐户';
  End;

  Open c_Moneyinfo;
  Fetch c_Moneyinfo
    Into r_Moneyrow;

  --首先判断要退款的记录是否存在
  If c_Moneyinfo%RowCount = 0 Then
    Close c_Moneyinfo;
    Raise Err_Custom;
  Else
    Select Sysdate Into v_Date From Dual;
    If 冲预交id_In Is Not Null Then
      n_预交id := 冲预交id_In;
    Else
      Select 病人预交记录_Id.Nextval Into n_预交id From Dual;
    End If;
  
    --处理票据
    If 票据号_In Is Not Null Then
      Select 票据打印内容_Id.Nextval Into v_打印id From Dual;
    
      --发出票据
	  Insert Into 票据打印内容 (ID, 数据性质, NO) Values (v_打印id, 2, r_Moneyrow.No);

      Insert Into 票据使用明细
        (ID, 票种, 号码, 性质, 原因, 领用id, 打印id, 使用时间, 使用人)
      Values
        (票据使用明细_Id.Nextval, 2, 票据号_In, 1, 6, 领用id_In, v_打印id, v_Date, 操作员姓名_In);
    
      --状态改动
      Update 票据领用记录
      Set 当前号码 = 票据号_In, 剩余数量 = Decode(Sign(剩余数量 - 1), -1, 0, 剩余数量 - 1), 使用时间 = Sysdate
      Where ID = Nvl(领用id_In, 0);
      
      v_打印id := Null;
    End If;
  
    --预交退款
    If Nvl(帐户退费_In, 0) = 1 Then
      --支持个人帐户退费,正常处理
      Insert Into 病人预交记录
        (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 摘要, 金额, 结算方式, 结算号码, 收款时间, 操作员编号, 操作员姓名, 缴款单位, 单位开户行, 单位帐号, 缴款组id,
         预交类别, 卡类别id, 卡号, 交易流水号, 交易说明, 合作单位, 结算卡序号)
        Select n_预交id, NO, 实际票号, 记录性质, 2, 病人id, 主页id, 科室id, 摘要_In, -1 * 金额, 结算方式, 结算号码, v_Date, 操作员编号_In, 操作员姓名_In, 缴款单位,
               单位开户行, 单位帐号, n_组id, 预交类别, 卡类别id, 卡号, 交易流水号, 交易说明, 合作单位, 结算卡序号
        From 病人预交记录
        Where ID = Id_In;
    Else
      --不支持时,处理成现金,记录性质为2的摘要填标志,为3的更新新输入的摘要
      Insert Into 病人预交记录
        (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 摘要, 金额, 结算方式, 结算号码, 收款时间, 操作员编号, 操作员姓名, 缴款单位, 单位开户行, 单位帐号, 缴款组id,
         预交类别, 卡类别id, 卡号, 交易流水号, 交易说明, 合作单位, 结算卡序号)
        Select n_预交id, NO, 实际票号, 记录性质, 2, 病人id, 主页id, 科室id, Nvl(摘要_In, '个人帐户退款'), -1 * 金额,
               Decode(结算方式, v_个人帐户, v_现金, 结算方式), 结算号码, v_Date, 操作员编号_In, 操作员姓名_In, Decode(结算方式, v_个人帐户, Null, 缴款单位),
               Decode(结算方式, v_个人帐户, Null, 单位开户行), Decode(结算方式, v_个人帐户, Null, 单位帐号), n_组id, 预交类别, 卡类别id, 卡号, 交易流水号, 交易说明,
               合作单位, 结算卡序号
        From 病人预交记录
        Where ID = Id_In;
    End If;
  
    Update 病人预交记录 Set 记录状态 = 3, 摘要 = 摘要_In Where ID = Id_In;
  
    --处理相关汇总表
    --人员缴款余额(注意包括处理个人帐户的结算方式)
    If Nvl(帐户退费_In, 0) = 1 Then
      --支持退个人帐户时的处理
      Update 人员缴款余额
      Set 余额 = Nvl(余额, 0) - r_Moneyrow.金额
      Where 性质 = 1 And 收款员 = 操作员姓名_In And 结算方式 = r_Moneyrow.结算方式
      Returning 余额 Into n_返回值;
    
      If Sql%RowCount = 0 Then
        Insert Into 人员缴款余额
          (收款员, 结算方式, 性质, 余额)
        Values
          (操作员姓名_In, r_Moneyrow.结算方式, 1, -r_Moneyrow.金额);
        n_返回值 := -r_Moneyrow.金额;
      
      End If;
      If Nvl(n_返回值, 0) = 0 Then
        Delete From 人员缴款余额
        Where 收款员 = 操作员姓名_In And 性质 = 1 And 结算方式 = r_Moneyrow.结算方式 And Nvl(余额, 0) = 0;
      End If;
    Else
      --不支持时的处理
      Update 人员缴款余额
      Set 余额 = Nvl(余额, 0) - r_Moneyrow.金额
      Where 性质 = 1 And 收款员 = 操作员姓名_In And 结算方式 = Decode(r_Moneyrow.结算方式, v_个人帐户, v_现金, r_Moneyrow.结算方式)
      Returning 余额 Into n_返回值;
    
      If Sql%RowCount = 0 Then
        Insert Into 人员缴款余额
          (收款员, 结算方式, 性质, 余额)
        Values
          (操作员姓名_In, Decode(r_Moneyrow.结算方式, v_个人帐户, v_现金, r_Moneyrow.结算方式), 1, -r_Moneyrow.金额);
        n_返回值 := -r_Moneyrow.金额;
      End If;
      If Nvl(n_返回值, 0) = 0 Then
        Delete From 人员缴款余额
        Where 收款员 = 操作员姓名_In And 性质 = 1 And 结算方式 = Decode(r_Moneyrow.结算方式, v_个人帐户, v_现金, r_Moneyrow.结算方式) And
              Nvl(余额, 0) = 0;
      End If;
    End If;
  
    --病人(预交)余额(不管是退现金还是个人帐户都应该减少)
    --判断要退款的性质
    Select b.性质 Into v_性质 From 病人预交记录 A, 结算方式 B Where a.结算方式 = b.名称(+) And a.Id = Id_In;
    If Nvl(v_性质, 1) <> 5 Then
      Update 病人余额
      Set 预交余额 = Nvl(预交余额, 0) - r_Moneyrow.金额
      Where 性质 = 1 And 病人id = r_Moneyrow.病人id And Nvl(类型, 2) = Nvl(r_Moneyrow.预交类别, 2)
      Returning 预交余额 Into n_返回值;
      If Sql%RowCount = 0 Then
        Insert Into 病人余额
          (病人id, 性质, 类型, 预交余额, 费用余额)
        Values
          (r_Moneyrow.病人id, 1, Nvl(r_Moneyrow.预交类别, 2), -r_Moneyrow.金额, 0);
        n_返回值 := -r_Moneyrow.金额;
      End If;
      If Nvl(n_返回值, 0) = 0 Then
        Delete From 病人余额
        Where 病人id = r_Moneyrow.病人id And 性质 = 1 And Nvl(预交余额, 0) = 0 And Nvl(费用余额, 0) = 0;
      End If;
    End If;
  
    --作废收回票据(可能以前没有使用票据,无法收回)
    Begin
      Select ID
      Into v_打印id
      From (Select b.Id
             From 票据使用明细 A, 票据打印内容 B
             Where a.打印id = b.Id And a.性质 = 1 And b.数据性质 = 2 And b.No = r_Moneyrow.No
             Order By a.使用时间 Desc)
      Where Rownum < 2;
    Exception
      When Others Then
        Null;
    End;
  
    If v_打印id Is Not Null Then
      Insert Into 票据使用明细
        (ID, 票种, 号码, 性质, 原因, 领用id, 打印id, 使用时间, 使用人)
        Select 票据使用明细_Id.Nextval, 票种, 号码, 2, 2, 领用id, 打印id, v_Date, 操作员姓名_In
        From 票据使用明细
        Where 打印id = v_打印id And 票种 = 2 And 性质 = 1;
    End If;
  
    Close c_Moneyinfo;
  End If;
  --消息推送;
  Select Id_In || ',' || 帐户退费_In Into v_Msg From Dual;
  Begin
    Execute Immediate 'Begin ZL_服务窗消息_发送(:1,:2); End;'
      Using 12, v_Msg;
  Exception
    When Others Then
      Null;
  End;
Exception
  When Err_Custom Then
    Raise_Application_Error(-20999, '[ZLSOFT]没有发现要退款的预交记录,该记录可能已经退除！[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_病人预交记录_Delete;
/

--114441:焦博,2017-09-20,ZL_THIRD_LOCKNO进行锁号操作时检查是否已锁，如果已锁，则返回已锁号
Create Or Replace Procedure Zl_Third_Lockno
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:HIS锁号
  --入参:Xml_In:
  --<IN>
  --  <HM>5</HM>           //号码
  --  <CZJLID>1</CZJLID>       //出诊记录ID,出诊表排班模式下传入
  --  <RQ>2013-11-21 09:00</RQ>     //预约时间
  --  <CZ>1</CZ>           //操作
  --  <HX></HX>          //号序
  --  <HZDW>支付宝</HZDW>   //合作单位
  --  <JQM>机器名</JQM>        //机器名
  --  <SJD>时间段</SJD>        //锁号的时间段
  --</IN>

  --出参:Xml_Out
  --<OUTPUT>
  -- <HX>号序</HX>          //锁号操作并且成功时返回
  -- 错误信息  //出错时返回
  --</ OUTPUT>
  --------------------------------------------------------------------------------------------------
  v_号码         挂号安排.号码%Type;
  d_日期         Date;
  n_操作类型     Number(3);
  n_序号控制     Number(3);
  n_存在         Number(3);
  n_分时段       Number(3);
  n_限号数       挂号安排限制.限号数%Type;
  n_安排id       挂号安排.Id%Type;
  n_计划id       挂号安排计划.Id%Type;
  n_号序         挂号序号状态.序号%Type;
  v_星期         挂号安排限制.限制项目%Type;
  v_操作员姓名   挂号序号状态.操作员姓名%Type;
  v_机器名       挂号序号状态.机器名%Type;
  v_验证姓名     挂号序号状态.操作员姓名%Type;
  v_验证机器名   挂号序号状态.机器名%Type;
  n_状态         挂号序号状态.状态%Type;
  v_合作单位     合作单位安排控制.合作单位%Type;
  n_合约模式     Number(3);
  n_启用合作单位 Number(3);
  v_Temp         Varchar2(32767); --临时XML
  v_Optemp       Varchar2(300);
  x_Templet      Xmltype; --模板XML
  n_Exists       Number(2);
  n_记录id       临床出诊记录.Id%Type;
  n_序号         临床出诊序号控制.序号%Type;
  n_挂号状态     临床出诊序号控制.挂号状态%Type;
  n_数量         临床出诊序号控制.数量%Type;
  n_顺序号       临床出诊序号控制.预约顺序号%Type;
  d_启用时间     Date;
  v_时间段       Varchar2(200);
  v_Para         Varchar2(2000);
  n_挂号模式     Number(3);
  d_时段开始     Date;
  d_序号时间     Date;
  d_时段结束     Date;
  n_出诊         Number(3);
  Err_Item Exception;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Select Extractvalue(Value(A), 'IN/HM'), To_Date(Extractvalue(Value(A), 'IN/RQ'), 'YYYY-MM-DD hh24:mi:ss'),
         Extractvalue(Value(A), 'IN/CZ'), Extractvalue(Value(A), 'IN/HX'), Extractvalue(Value(A), 'IN/HZDW'),
         Extractvalue(Value(A), 'IN/JQM'), Extractvalue(Value(A), 'IN/CZJLID'), Extractvalue(Value(A), 'IN/SJD')
  Into v_号码, d_日期, n_操作类型, n_号序, v_合作单位, v_机器名, n_记录id, v_时间段
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  v_Para     := zl_GetSysParameter(256);
  n_挂号模式 := Substr(v_Para, 1, 1);
  Select Max(To_Date(Substr(v_Para, 3), 'yyyy-mm-dd hh24:mi:ss')) Into d_启用时间 From Dual;

  If Sysdate - 10 > Nvl(d_启用时间, Sysdate - 30) Then
    If n_挂号模式 = 1 And Nvl(d_日期, Sysdate) > Nvl(d_启用时间, Sysdate - 30) And n_记录id Is Null Then
      v_Temp := '系统当前处于出诊表排班模式，传入的参数无法确定挂号安排，请重试！';
      Raise Err_Item;
    End If;
  Else
    If n_挂号模式 = 1 And Nvl(d_日期, Sysdate) > Nvl(d_启用时间, Sysdate - 30) And n_记录id Is Null Then
      Begin
        Select a.Id
        Into n_记录id
        From 临床出诊记录 A, 临床出诊号源 B
        Where a.号源id = b.Id And b.号码 = v_号码 And Nvl(d_日期, Sysdate) Between a.开始时间 And a.终止时间;
      Exception
        When Others Then
          v_Temp := '系统当前处于出诊表排班模式，传入的参数无法确定挂号安排，请重试！';
          Raise Err_Item;
      End;
    End If;
  End If;

  If v_时间段 Is Not Null And n_操作类型 = 1 Then
    Begin
      d_时段开始 := To_Date(To_Char(d_日期, 'yyyy-mm-dd') || Substr(v_时间段, 1, Instr(v_时间段, '-') - 1), 'yyyy-mm-dd hh24:mi:ss');
      If Substr(v_时间段, Instr(v_时间段, '-') + 1) Is Null Then
        d_时段结束 := Null;
      Else
        d_时段结束 := To_Date(To_Char(d_日期, 'yyyy-mm-dd') || Substr(v_时间段, Instr(v_时间段, '-') + 1), 'yyyy-mm-dd hh24:mi:ss');
      End If;
    Exception
      When Others Then
        v_Temp := '无法解析传入的时间段格式，请检查！';
        Raise Err_Item;
    End;
  End If;

  If v_机器名 Is Null Then
    Select Terminal Into v_机器名 From V$session Where Audsid = Userenv('sessionid');
  End If;
  v_Optemp := Zl_Identity(1);
  Select Substr(v_Optemp, Instr(v_Optemp, ',') + 1) Into v_Optemp From Dual;
  Select Substr(v_Optemp, Instr(v_Optemp, ',') + 1) Into v_操作员姓名 From Dual;

  If n_记录id Is Null Then
    If n_操作类型 = 0 Then
      --解锁
      Select Nvl(Max(1), 0)
      Into n_Exists
      From 挂号序号状态
      Where 机器名 = v_机器名 And 操作员姓名 = v_操作员姓名 And 状态 = 5 And 序号 = n_号序 And Trunc(日期) = Trunc(d_日期) And 号码 = v_号码 And
            Rownum < 2;
      If n_Exists = 1 Then
        Delete 挂号序号状态
        Where 机器名 = v_机器名 And 操作员姓名 = v_操作员姓名 And 状态 = 5 And 序号 = n_号序 And Trunc(日期) = Trunc(d_日期) And 号码 = v_号码;
        v_Temp := '<HX>' || n_号序 || '</HX>';
        Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
      Else
        v_Temp := '没有发现需要解锁的序号';
        Raise Err_Item;
      End If;
    End If;
  
    If n_操作类型 = 1 Then
      --锁号
      Select Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五', '7', '周六',
                     Null)
      Into v_星期
      From Dual;
      Begin
        Select 序号控制, ID
        Into n_序号控制, n_计划id
        From (Select 序号控制, ID
               From 挂号安排计划
               Where 号码 = v_号码 And d_日期 Between Nvl(生效时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                     Nvl(失效时间, To_Date('3000-01-01', 'YYYY-MM-DD')) And 审核时间 Is Not Null
               Order By 生效时间 Desc)
        Where Rownum < 2;
      Exception
        When Others Then
          Select 序号控制, ID Into n_序号控制, n_安排id From 挂号安排 Where 号码 = v_号码;
      End;
      If n_序号控制 = 1 Then
        If Nvl(n_计划id, 0) <> 0 Then
          Select Nvl(Max(1), 0)
          Into n_分时段
          From 挂号计划时段
          Where 星期 = v_星期 And 计划id = n_计划id And Rownum < 2;
          Select Nvl(Max(1), 0)
          Into n_启用合作单位
          From 合作单位计划控制
          Where 限制项目 = v_星期 And 计划id = n_计划id And 合作单位 = v_合作单位 And Rownum < 2;
          If v_时间段 Is Null Then
            Begin
              Select 1, a.状态, a.操作员姓名, a.机器名, a.序号
              Into n_存在, n_状态, v_验证姓名, v_验证机器名, n_号序
              From 挂号序号状态 A, 挂号计划时段 B
              Where a.号码 = v_号码 And Trunc(a.日期) = Trunc(d_日期) And a.序号 = b.序号 And b.计划id = n_计划id And b.星期 = v_星期 And
                    To_Char(b.开始时间, 'hh24:mi') = To_Char(d_日期, 'hh24:mi') And Rownum < 2;
            Exception
              When Others Then
                n_存在 := 0;
            End;
          Else
            n_存在 := 0;
          End If;
        
          If n_存在 = 1 Then
            If n_状态 = 5 And v_验证姓名 = v_操作员姓名 And v_机器名 = v_验证机器名 Then
              v_Temp := '<HX>' || n_号序 || '</HX>';
              Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
            Else
              --传入时间的序号已经被使用
              v_Temp := '传入时间' || d_日期 || '的序号已被使用';
              Raise Err_Item;
            End If;
          Else
            If n_分时段 = 1 Then
              If v_时间段 Is Null Then
                --精确定位序号
                Begin
                  Select 序号
                  Into n_号序
                  From 挂号计划时段
                  Where 计划id = n_计划id And 星期 = v_星期 And To_Char(开始时间, 'hh24:mi') = To_Char(d_日期, 'hh24:mi') And
                        Rownum < 2;
                Exception
                  When Others Then
                    Select Max(序号) + 1
                    Into n_号序
                    From (Select Distinct 序号
                           From 挂号计划时段
                           Where 计划id = n_计划id And 星期 = v_星期
                           Union
                           Select Distinct 序号 From 挂号序号状态 Where 号码 = v_号码 And Trunc(日期) = Trunc(d_日期));
                  
                End;
                Begin
                  Select 1 Into n_存在 From 挂号序号状态 Where 号码 = v_号码 And 日期 = d_日期 And 序号 = n_号序;
                Exception
                  When Others Then
                    Insert Into 挂号序号状态
                      (号码, 日期, 序号, 状态, 操作员姓名, 备注, 登记时间, 机器名)
                    Values
                      (v_号码, d_日期, n_号序, 5, v_操作员姓名, '移动锁号', Sysdate, v_机器名);
                End;
              Else
                --时间段自动取序号
                Begin
                  If Trunc(d_日期) = Trunc(Sysdate) Then
                    Select Min(a.序号), Min(b.状态)
                    Into n_号序, n_状态
                    From 挂号计划时段 A, 挂号序号状态 B
                    Where a.序号 = b.序号(+) And (Nvl(b.状态, 0) = 0 Or Nvl(b.状态, 0) = 5) And b.号码(+) = v_号码 And
                          Trunc(b.日期(+)) = Trunc(d_日期) And a.计划id = n_计划id And a.星期 = v_星期 And
                          To_Char(a.开始时间, 'hh24:mi') >= To_Char(d_时段开始, 'hh24:mi') And
                          To_Char(a.开始时间, 'hh24:mi') < To_Char(d_时段结束, 'hh24:mi');
                  Else
                    Select Min(a.序号), Min(b.状态)
                    Into n_号序, n_状态
                    From 挂号计划时段 A, 挂号序号状态 B
                    Where a.序号 = b.序号(+) And (Nvl(b.状态, 0) = 0 Or Nvl(b.状态, 0) = 5) And b.号码(+) = v_号码 And
                          Trunc(b.日期(+)) = Trunc(d_日期) And a.计划id = n_计划id And a.星期 = v_星期 And
                          To_Char(a.开始时间, 'hh24:mi') >= To_Char(d_时段开始, 'hh24:mi') And
                          To_Char(a.开始时间, 'hh24:mi') < To_Char(d_时段结束, 'hh24:mi') And a.是否预约 = 1;
                  End If;
                  If Nvl(n_号序, 0) = 0 Then
                    If d_时段结束 Is Null Then
                      Select Max(序号) + 1
                      Into n_号序
                      From (Select Distinct 序号
                             From 挂号计划时段
                             Where 计划id = n_计划id And 星期 = v_星期
                             Union
                             Select Distinct 序号 From 挂号序号状态 Where 号码 = v_号码 And Trunc(日期) = Trunc(d_日期));
                    Else
                      v_Temp := '传入时间段' || v_时间段 || '的序号已被使用完';
                      Raise Err_Item;
                    End If;
                  Else
                    If Nvl(n_状态, 0) = 5 Then
                      Select 1
                      Into n_存在
                      From 挂号序号状态
                      Where 机器名 = v_机器名 And 操作员姓名 = v_操作员姓名 And 序号 = n_号序;
                      If n_存在 = 1 Then
                        v_Temp := '<HX>' || n_号序 || '</HX>';
                        Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
                      End If;
                    Else
                      If d_时段结束 Is Null Then
                        Select Max(序号) + 1
                        Into n_号序
                        From (Select Distinct 序号
                               From 挂号计划时段
                               Where 计划id = n_计划id And 星期 = v_星期
                               Union
                               Select Distinct 序号 From 挂号序号状态 Where 号码 = v_号码 And Trunc(日期) = Trunc(d_日期));
                      Else
                        v_Temp := '传入时间段' || v_时间段 || '的序号已被使用完';
                        Raise Err_Item;
                      End If;
                    End If;
                  End If;
                Exception
                  When Others Then
                    If d_时段结束 Is Null Then
                      Select Max(序号) + 1
                      Into n_号序
                      From (Select Distinct 序号
                             From 挂号计划时段
                             Where 计划id = n_计划id And 星期 = v_星期
                             Union
                             Select Distinct 序号 From 挂号序号状态 Where 号码 = v_号码 And Trunc(日期) = Trunc(d_日期));
                    Else
                      v_Temp := '传入时间段' || v_时间段 || '的序号已被使用完';
                      Raise Err_Item;
                    End If;
                End;
                Begin
                  Select To_Date(To_Char(d_日期, 'yyyy-mm-dd') || To_Char(开始时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss')
                  Into d_序号时间
                  From 挂号计划时段
                  Where 计划id = n_计划id And 星期 = v_星期 And 序号 = n_号序;
                Exception
                  When Others Then
                    d_序号时间 := d_日期;
                End;
                Begin
                  Select 1 Into n_存在 From 挂号序号状态 Where 号码 = v_号码 And 日期 = d_序号时间 And 序号 = n_号序;
                Exception
                  When Others Then
                  
                    Insert Into 挂号序号状态
                      (号码, 日期, 序号, 状态, 操作员姓名, 备注, 登记时间, 机器名)
                    Values
                      (v_号码, d_序号时间, n_号序, 5, v_操作员姓名, '移动锁号', Sysdate, v_机器名);
                End;
              
              End If;
              v_Temp := '<HX>' || n_号序 || '</HX>';
              Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
            Else
              If v_合作单位 Is Null Or n_启用合作单位 = 0 Then
                If Trunc(d_日期) = Trunc(Sysdate) Then
                  n_号序 := 1;
                  Select 限号数 Into n_限号数 From 挂号计划限制 Where 计划id = n_计划id And 限制项目 = v_星期;
                  For r_序号 In (Select 序号, 状态, 操作员姓名, 机器名
                               From 挂号序号状态
                               Where 号码 = v_号码 And Trunc(日期) = Trunc(d_日期)
                               Order By 序号) Loop
                    Exit When r_序号.状态 = 5 And r_序号.操作员姓名 = v_操作员姓名 And r_序号.机器名 = v_机器名;
                    If r_序号.序号 = n_号序 Then
                      n_号序 := n_号序 + 1;
                    End If;
                  End Loop;
                  If n_号序 > n_限号数 Then
                    v_Temp := '传入号别' || v_号码 || '的所有序号已被用完';
                    Raise Err_Item;
                  Else
                    Begin
                      Select 1
                      Into n_存在
                      From 挂号序号状态
                      Where 号码 = v_号码 And Trunc(日期) = Trunc(d_日期) And 序号 = n_号序;
                    Exception
                      When Others Then
                        Insert Into 挂号序号状态
                          (号码, 日期, 序号, 状态, 操作员姓名, 备注, 登记时间, 机器名)
                        Values
                          (v_号码, Trunc(d_日期), n_号序, 5, v_操作员姓名, '移动锁号', Sysdate, v_机器名);
                    End;
                    v_Temp := '<HX>' || n_号序 || '</HX>';
                    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
                  End If;
                Else
                  n_号序 := 1;
                  Select 限号数 Into n_限号数 From 挂号计划限制 Where 计划id = n_计划id And 限制项目 = v_星期;
                  For r_序号 In (Select 序号, 状态, 操作员姓名, 机器名
                               From 挂号序号状态
                               Where 号码 = v_号码 And Trunc(日期) = Trunc(d_日期)
                               
                               Union
                               Select 序号, Null, Null, Null
                               From 合作单位计划控制
                               Where 计划id = n_计划id And 限制项目 = v_星期 And 数量 <> 0
                               Order By 序号) Loop
                    Exit When r_序号.状态 = 5 And r_序号.操作员姓名 = v_操作员姓名 And r_序号.机器名 = v_机器名;
                    If r_序号.序号 = n_号序 Then
                      n_号序 := n_号序 + 1;
                    End If;
                  End Loop;
                  If n_号序 > n_限号数 Then
                    v_Temp := '传入号别' || v_号码 || '的所有序号已被用完';
                    Raise Err_Item;
                  Else
                    Begin
                      Select 1
                      Into n_存在
                      From 挂号序号状态
                      Where 号码 = v_号码 And Trunc(日期) = Trunc(d_日期) And 序号 = n_号序;
                    Exception
                      When Others Then
                        Insert Into 挂号序号状态
                          (号码, 日期, 序号, 状态, 操作员姓名, 备注, 登记时间, 机器名)
                        Values
                          (v_号码, Trunc(d_日期), n_号序, 5, v_操作员姓名, '移动锁号', Sysdate, v_机器名);
                    End;
                    v_Temp := '<HX>' || n_号序 || '</HX>';
                    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
                  End If;
                End If;
              Else
                Select Count(1)
                Into n_合约模式
                From 合作单位计划控制
                Where 序号 = 0 And 计划id = n_计划id And 合作单位 = v_合作单位 And 限制项目 = v_星期 And 数量 <> 0;
                If n_合约模式 = 0 Then
                  Begin
                    Select 序号
                    Into n_号序
                    From (Select 序号
                           From 合作单位计划控制 A
                           Where 计划id = n_计划id And 合作单位 = v_合作单位 And 限制项目 = v_星期 And 数量 <> 0 And
                                 (Not Exists
                                  (Select 1
                                   From 挂号序号状态
                                   Where 号码 = v_号码 And 序号 = a.序号 And Trunc(日期) = Trunc(d_日期) And 状态 <> 0) Or Exists
                                  (Select 1
                                   From 挂号序号状态
                                   Where 号码 = v_号码 And 序号 = a.序号 And Trunc(日期) = Trunc(d_日期) And 状态 = 5 And 操作员姓名 = v_操作员姓名 And
                                         机器名 = v_机器名))
                           Order By 序号)
                    Where Rownum < 2;
                  Exception
                    When Others Then
                      n_号序 := 0;
                  End;
                  If n_号序 = 0 Then
                    v_Temp := '传入号别' || v_号码 || '的所有序号已被用完';
                    Raise Err_Item;
                  Else
                    Begin
                      Select 1
                      Into n_存在
                      From 挂号序号状态
                      Where 号码 = v_号码 And Trunc(日期) = Trunc(d_日期) And 序号 = n_号序;
                    Exception
                      When Others Then
                        Insert Into 挂号序号状态
                          (号码, 日期, 序号, 状态, 操作员姓名, 备注, 登记时间, 机器名)
                        Values
                          (v_号码, Trunc(d_日期), n_号序, 5, v_操作员姓名, '移动锁号', Sysdate, v_机器名);
                    End;
                    v_Temp := '<HX>' || n_号序 || '</HX>';
                    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
                  End If;
                Else
                  n_号序 := 1;
                  Select 限号数 Into n_限号数 From 挂号计划限制 Where 计划id = n_计划id And 限制项目 = v_星期;
                  For r_序号 In (Select 序号, 状态, 操作员姓名, 机器名
                               From 挂号序号状态
                               Where 号码 = v_号码 And Trunc(日期) = Trunc(d_日期)
                               
                               Union
                               Select 序号, Null, Null, Null
                               From 合作单位计划控制
                               Where 计划id = n_计划id And 限制项目 = v_星期 And 数量 <> 0
                               Order By 序号) Loop
                    Exit When r_序号.状态 = 5 And r_序号.操作员姓名 = v_操作员姓名 And r_序号.机器名 = v_机器名;
                    If r_序号.序号 = n_号序 Then
                      n_号序 := n_号序 + 1;
                    End If;
                  End Loop;
                  If n_号序 > n_限号数 Then
                    v_Temp := '传入号别' || v_号码 || '的所有序号已被用完';
                    Raise Err_Item;
                  Else
                    Begin
                      Select 1
                      Into n_存在
                      From 挂号序号状态
                      Where 号码 = v_号码 And Trunc(日期) = Trunc(d_日期) And 序号 = n_号序;
                    Exception
                      When Others Then
                        Insert Into 挂号序号状态
                          (号码, 日期, 序号, 状态, 操作员姓名, 备注, 登记时间, 机器名)
                        Values
                          (v_号码, Trunc(d_日期), n_号序, 5, v_操作员姓名, '移动锁号', Sysdate, v_机器名);
                    End;
                    v_Temp := '<HX>' || n_号序 || '</HX>';
                    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
                  End If;
                End If;
              End If;
            End If;
          End If;
        Else
          Select Nvl(Max(1), 0)
          Into n_分时段
          From 挂号安排时段
          Where 星期 = v_星期 And 安排id = n_安排id And Rownum < 2;
          Select Nvl(Max(1), 0)
          Into n_启用合作单位
          From 合作单位安排控制
          Where 限制项目 = v_星期 And 安排id = n_安排id And 合作单位 = v_合作单位 And Rownum < 2;
          If v_时间段 Is Null Then
            Begin
              Select 1, a.状态, a.操作员姓名, a.机器名, a.序号
              Into n_存在, n_状态, v_验证姓名, v_验证机器名, n_号序
              From 挂号序号状态 A, 挂号安排时段 B
              Where a.号码 = v_号码 And Trunc(a.日期) = Trunc(d_日期) And a.序号 = b.序号 And b.安排id = n_安排id And b.星期 = v_星期 And
                    To_Char(b.开始时间, 'hh24:mi') = To_Char(d_日期, 'hh24:mi') And Rownum < 2;
            Exception
              When Others Then
                n_存在 := 0;
            End;
          Else
            n_存在 := 0;
          End If;
          If n_存在 = 1 Then
            If n_状态 = 5 And v_验证姓名 = v_操作员姓名 And v_机器名 = v_验证机器名 Then
              v_Temp := '<HX>' || n_号序 || '</HX>';
              Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
            Else
              --传入时间的序号已经被使用
              v_Temp := '传入时间' || d_日期 || '的序号已被使用';
              Raise Err_Item;
            End If;
          Else
            If n_分时段 = 1 Then
              If v_时间段 Is Null Then
                Begin
                  Select 序号
                  Into n_号序
                  From 挂号安排时段
                  Where 安排id = n_安排id And 星期 = v_星期 And To_Char(开始时间, 'hh24:mi') = To_Char(d_日期, 'hh24:mi') And
                        Rownum < 2;
                Exception
                  When Others Then
                    Select Max(序号) + 1
                    Into n_号序
                    From (Select Distinct 序号
                           From 挂号安排时段
                           Where 安排id = n_安排id And 星期 = v_星期
                           Union
                           Select Distinct 序号 From 挂号序号状态 Where 号码 = v_号码 And Trunc(日期) = Trunc(d_日期));
                End;
                Begin
                  Select 1 Into n_存在 From 挂号序号状态 Where 号码 = v_号码 And 日期 = d_日期 And 序号 = n_号序;
                Exception
                  When Others Then
                    Insert Into 挂号序号状态
                      (号码, 日期, 序号, 状态, 操作员姓名, 备注, 登记时间, 机器名)
                    Values
                      (v_号码, d_日期, n_号序, 5, v_操作员姓名, '移动锁号', Sysdate, v_机器名);
                End;
              Else
                --时间段自动取序号
                Begin
                  If Trunc(d_日期) = Trunc(Sysdate) Then
                    Select Min(a.序号), Min(b.状态)
                    Into n_号序, n_状态
                    From 挂号安排时段 A, 挂号序号状态 B
                    Where a.序号 = b.序号(+) And (Nvl(b.状态, 0) = 0 Or Nvl(b.状态, 0) = 5) And b.号码(+) = v_号码 And
                          Trunc(b.日期(+)) = Trunc(d_日期) And a.安排id = n_安排id And a.星期 = v_星期 And
                          To_Char(a.开始时间, 'hh24:mi') >= To_Char(d_时段开始, 'hh24:mi') And
                          To_Char(a.开始时间, 'hh24:mi') < To_Char(d_时段结束, 'hh24:mi');
                  Else
                    Select Min(a.序号), Min(b.状态)
                    Into n_号序, n_状态
                    From 挂号安排时段 A, 挂号序号状态 B
                    Where a.序号 = b.序号(+) And (Nvl(b.状态, 0) = 0 Or Nvl(b.状态, 0) = 5) And b.号码(+) = v_号码 And
                          Trunc(b.日期(+)) = Trunc(d_日期) And a.安排id = n_安排id And a.星期 = v_星期 And
                          To_Char(a.开始时间, 'hh24:mi') >= To_Char(d_时段开始, 'hh24:mi') And
                          To_Char(a.开始时间, 'hh24:mi') < To_Char(d_时段结束, 'hh24:mi') And a.是否预约 = 1;
                  End If;
                  If n_号序 Is Null Then
                  
                    If d_时段结束 Is Null Then
                      Select Max(序号) + 1
                      Into n_号序
                      From (Select Distinct 序号
                             From 挂号安排时段
                             Where 安排id = n_安排id And 星期 = v_星期
                             Union
                             Select Distinct 序号 From 挂号序号状态 Where 号码 = v_号码 And Trunc(日期) = Trunc(d_日期));
                    Else
                      v_Temp := '传入时间段' || v_时间段 || '的序号已被使用完';
                      Raise Err_Item;
                    End If;
                  Else
                    If Nvl(n_状态, 0) = 5 Then
                      Select 1
                      Into n_存在
                      From 挂号序号状态
                      Where 机器名 = v_机器名 And 操作员姓名 = v_操作员姓名 And 序号 = n_号序;
                      If n_存在 = 1 Then
                        v_Temp := '<HX>' || n_号序 || '</HX>';
                        Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
                      End If;
                    Else
                      If d_时段结束 Is Null Then
                        Select Max(序号) + 1
                        Into n_号序
                        From (Select Distinct 序号
                               From 挂号安排时段
                               Where 安排id = n_安排id And 星期 = v_星期
                               Union
                               Select Distinct 序号 From 挂号序号状态 Where 号码 = v_号码 And Trunc(日期) = Trunc(d_日期));
                      Else
                        v_Temp := '传入时间段' || v_时间段 || '的序号已被使用完';
                        Raise Err_Item;
                      End If;
                    End If;
                  End If;
                Exception
                  When Others Then
                    If d_时段结束 Is Null Then
                      Select Max(序号) + 1
                      Into n_号序
                      From (Select Distinct 序号
                             From 挂号安排时段
                             Where 安排id = n_安排id And 星期 = v_星期
                             Union
                             Select Distinct 序号 From 挂号序号状态 Where 号码 = v_号码 And Trunc(日期) = Trunc(d_日期));
                    Else
                      v_Temp := '传入时间段' || v_时间段 || '的序号已被使用完';
                      Raise Err_Item;
                    End If;
                  
                End;
                Begin
                  Select To_Date(To_Char(d_日期, 'yyyy-mm-dd') || To_Char(开始时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss')
                  Into d_序号时间
                  From 挂号安排时段
                  Where 安排id = n_安排id And 星期 = v_星期 And 序号 = n_号序;
                Exception
                  When Others Then
                    d_序号时间 := d_日期;
                End;
                Begin
                  Select 1 Into n_存在 From 挂号序号状态 Where 号码 = v_号码 And 日期 = d_序号时间 And 序号 = n_号序;
                Exception
                  When Others Then
                    Insert Into 挂号序号状态
                      (号码, 日期, 序号, 状态, 操作员姓名, 备注, 登记时间, 机器名)
                    Values
                      (v_号码, d_序号时间, n_号序, 5, v_操作员姓名, '移动锁号', Sysdate, v_机器名);
                End;
              
              End If;
              v_Temp := '<HX>' || n_号序 || '</HX>';
              Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
            Else
              If v_合作单位 Is Null Or n_启用合作单位 = 0 Then
                If Trunc(d_日期) = Trunc(Sysdate) Then
                  n_号序 := 1;
                  Select 限号数 Into n_限号数 From 挂号安排限制 Where 安排id = n_安排id And 限制项目 = v_星期;
                  For r_序号 In (Select 序号, 状态, 操作员姓名, 机器名
                               From 挂号序号状态
                               Where 号码 = v_号码 And Trunc(日期) = Trunc(d_日期)
                               Order By 序号) Loop
                    Exit When r_序号.状态 = 5 And r_序号.操作员姓名 = v_操作员姓名 And r_序号.机器名 = v_机器名;
                    If r_序号.序号 = n_号序 Then
                      n_号序 := n_号序 + 1;
                    End If;
                  End Loop;
                  If n_号序 > n_限号数 Then
                    v_Temp := '传入号别' || v_号码 || '的所有序号已被用完';
                    Raise Err_Item;
                  Else
                    Begin
                      Select 1
                      Into n_存在
                      From 挂号序号状态
                      Where 号码 = v_号码 And Trunc(日期) = Trunc(d_日期) And 序号 = n_号序;
                    Exception
                      When Others Then
                        Insert Into 挂号序号状态
                          (号码, 日期, 序号, 状态, 操作员姓名, 备注, 登记时间, 机器名)
                        Values
                          (v_号码, Trunc(d_日期), n_号序, 5, v_操作员姓名, '移动锁号', Sysdate, v_机器名);
                    End;
                    v_Temp := '<HX>' || n_号序 || '</HX>';
                    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
                  End If;
                Else
                  n_号序 := 1;
                  Select 限号数 Into n_限号数 From 挂号安排限制 Where 安排id = n_安排id And 限制项目 = v_星期;
                  For r_序号 In (Select 序号, 状态, 操作员姓名, 机器名
                               From 挂号序号状态
                               Where 号码 = v_号码 And Trunc(日期) = Trunc(d_日期)
                               
                               Union
                               Select 序号, Null, Null, Null
                               From 合作单位安排控制
                               Where 安排id = n_安排id And 限制项目 = v_星期 And 数量 <> 0
                               Order By 序号) Loop
                    Exit When r_序号.状态 = 5 And r_序号.操作员姓名 = v_操作员姓名 And r_序号.机器名 = v_机器名;
                    If r_序号.序号 = n_号序 Then
                      n_号序 := n_号序 + 1;
                    End If;
                  End Loop;
                  If n_号序 > n_限号数 Then
                    v_Temp := '传入号别' || v_号码 || '的所有序号已被用完';
                    Raise Err_Item;
                  Else
                    Begin
                      Select 1
                      Into n_存在
                      From 挂号序号状态
                      Where 号码 = v_号码 And Trunc(日期) = Trunc(d_日期) And 序号 = n_号序;
                    Exception
                      When Others Then
                        Insert Into 挂号序号状态
                          (号码, 日期, 序号, 状态, 操作员姓名, 备注, 登记时间, 机器名)
                        Values
                          (v_号码, Trunc(d_日期), n_号序, 5, v_操作员姓名, '移动锁号', Sysdate, v_机器名);
                    End;
                    v_Temp := '<HX>' || n_号序 || '</HX>';
                    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
                  End If;
                End If;
              Else
                Select Count(1)
                Into n_合约模式
                From 合作单位安排控制
                Where 序号 = 0 And 安排id = n_安排id And 合作单位 = v_合作单位 And 限制项目 = v_星期 And 数量 <> 0;
                If n_合约模式 = 0 Then
                  Begin
                    Select 序号
                    Into n_号序
                    From (Select 序号
                           From 合作单位安排控制 A
                           Where 安排id = n_安排id And 合作单位 = v_合作单位 And 限制项目 = v_星期 And 数量 <> 0 And
                                 (Not Exists
                                  (Select 1
                                   From 挂号序号状态
                                   Where 号码 = v_号码 And 序号 = a.序号 And Trunc(日期) = Trunc(d_日期) And 状态 <> 0) Or Exists
                                  (Select 1
                                   From 挂号序号状态
                                   Where 号码 = v_号码 And 序号 = a.序号 And Trunc(日期) = Trunc(d_日期) And 状态 = 5 And 操作员姓名 = v_操作员姓名 And
                                         机器名 = v_机器名))
                           Order By 序号)
                    Where Rownum < 2;
                  Exception
                    When Others Then
                      n_号序 := 0;
                  End;
                  If n_号序 = 0 Then
                    v_Temp := '传入号别' || v_号码 || '的所有序号已被用完';
                    Raise Err_Item;
                  Else
                    Begin
                      Select 1
                      Into n_存在
                      From 挂号序号状态
                      Where 号码 = v_号码 And Trunc(日期) = Trunc(d_日期) And 序号 = n_号序;
                    Exception
                      When Others Then
                        Insert Into 挂号序号状态
                          (号码, 日期, 序号, 状态, 操作员姓名, 备注, 登记时间, 机器名)
                        Values
                          (v_号码, Trunc(d_日期), n_号序, 5, v_操作员姓名, '移动锁号', Sysdate, v_机器名);
                    End;
                    v_Temp := '<HX>' || n_号序 || '</HX>';
                    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
                  End If;
                Else
                  n_号序 := 1;
                  Select 限号数 Into n_限号数 From 挂号安排限制 Where 安排id = n_安排id And 限制项目 = v_星期;
                  For r_序号 In (Select 序号, 状态, 操作员姓名, 机器名
                               From 挂号序号状态
                               Where 号码 = v_号码 And Trunc(日期) = Trunc(d_日期)
                               
                               Union
                               Select 序号, Null, Null, Null
                               From 合作单位安排控制
                               Where 安排id = n_安排id And 限制项目 = v_星期 And 数量 <> 0
                               Order By 序号) Loop
                    Exit When r_序号.状态 = 5 And r_序号.操作员姓名 = v_操作员姓名 And r_序号.机器名 = v_机器名;
                    If r_序号.序号 = n_号序 Then
                      n_号序 := n_号序 + 1;
                    End If;
                  End Loop;
                  If n_号序 > n_限号数 Then
                    v_Temp := '传入号别' || v_号码 || '的所有序号已被用完';
                    Raise Err_Item;
                  Else
                    Begin
                      Select 1
                      Into n_存在
                      From 挂号序号状态
                      Where 号码 = v_号码 And Trunc(日期) = Trunc(d_日期) And 序号 = n_号序;
                    Exception
                      When Others Then
                        Insert Into 挂号序号状态
                          (号码, 日期, 序号, 状态, 操作员姓名, 备注, 登记时间, 机器名)
                        Values
                          (v_号码, Trunc(d_日期), n_号序, 5, v_操作员姓名, '移动锁号', Sysdate, v_机器名);
                    End;
                    v_Temp := '<HX>' || n_号序 || '</HX>';
                    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
                  End If;
                End If;
              End If;
            End If;
          End If;
        End If;
      End If;
    End If;
  Else
    --出诊表排班模式
    If n_操作类型 = 0 Then
      --解锁
      Select Nvl(Max(1), 0)
      Into n_Exists
      From 临床出诊序号控制
      Where 工作站名称 = v_机器名 And 操作员姓名 = v_操作员姓名 And 挂号状态 = 5 And (序号 = n_号序 Or 备注 = n_号序) And 记录id = n_记录id And
            Rownum < 2;
      If n_Exists = 1 Then
        Update 临床出诊序号控制
        Set 挂号状态 = 0
        Where 工作站名称 = v_机器名 And 操作员姓名 = v_操作员姓名 And 挂号状态 = 5 And (序号 = n_号序 Or 备注 = n_号序) And 记录id = n_记录id;
        v_Temp := '<HX>' || n_号序 || '</HX>';
        Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
      Else
        v_Temp := '没有发现需要解锁的序号';
        Raise Err_Item;
      End If;
    End If;
  
    If n_操作类型 = 1 Then
      --锁号
      Select Nvl(Max(1), 0)
      Into n_出诊
      From 临床出诊记录
      Where ID = n_记录id And d_日期 Between 开始时间 And 终止时间 And Rownum < 2;
      If Nvl(n_出诊, 0) = 0 Then
        v_Temp := '传入的出诊记录与时间不符,请检查!';
        Raise Err_Item;
      End If;
      If n_号序 Is Null Then
        Select 是否序号控制, 是否分时段 Into n_序号控制, n_分时段 From 临床出诊记录 Where ID = n_记录id;
        Select Nvl(Max(1), 0)
        Into n_启用合作单位
        From 临床出诊挂号控制记录
        Where 记录id = n_记录id And 名称 = v_合作单位 And 类型 = 1 And 性质 = 1 And Rownum < 2;
        If n_序号控制 = 1 Then
          If n_分时段 = 1 Then
            If v_时间段 Is Null Then
              Update 临床出诊序号控制
              Set 备注 = 备注
              Where 记录id = n_记录id And 开始时间 <> 终止时间 And To_Char(开始时间, 'hh24:mi') = To_Char(d_日期, 'hh24:mi') And
                    Rownum < 2;
              Begin
                Select 1, 挂号状态, 操作员姓名, 工作站名称, 序号
                Into n_存在, n_状态, v_验证姓名, v_验证机器名, n_序号
                From 临床出诊序号控制
                Where 记录id = n_记录id And 开始时间 <> 终止时间 And To_Char(开始时间, 'hh24:mi') = To_Char(d_日期, 'hh24:mi') And
                      Nvl(挂号状态, 0) <> 0 And Rownum < 2;
              Exception
                When Others Then
                  n_存在 := 0;
              End;
            Else
              n_存在 := 0;
            End If;
          
            If n_存在 = 1 Then
              If n_状态 = 5 And v_验证姓名 = v_操作员姓名 And v_机器名 = v_验证机器名 Then
                v_Temp := '<HX>' || n_序号 || '</HX>';
                Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
              Else
                --传入时间的序号已经被使用
                v_Temp := '传入时间' || d_日期 || '的序号已被使用';
                Raise Err_Item;
              End If;
            Else
              If v_时间段 Is Null Then
                Begin
                  Select 序号
                  Into n_序号
                  From 临床出诊序号控制
                  Where 记录id = n_记录id And 开始时间 <> 终止时间 And To_Char(开始时间, 'hh24:mi') = To_Char(d_日期, 'hh24:mi') And
                        Nvl(挂号状态, 0) = 0 And Nvl(是否停诊, 0) <> 1 And Rownum < 2;
                Exception
                  When Others Then
                    If Trunc(d_日期) = Trunc(Sysdate) Then
                      Select Min(序号)
                      Into n_序号
                      From 临床出诊序号控制
                      Where 记录id = n_记录id And 开始时间 >= d_日期 And Nvl(挂号状态, 0) = 0 And Nvl(是否停诊, 0) <> 1;
                      If Nvl(n_序号, 0) = 0 Then
                        Select Max(序号) + 1 Into n_序号 From 临床出诊序号控制 Where 记录id = n_记录id;
                      End If;
                    Else
                      v_Temp := '传入时间' || d_日期 || '没有找到对应的序号,无法预约';
                      Raise Err_Item;
                    End If;
                End;
                Update 临床出诊序号控制
                Set 挂号状态 = 5, 锁号时间 = Sysdate, 操作员姓名 = v_操作员姓名, 工作站名称 = v_机器名
                Where 记录id = n_记录id And 序号 = n_序号;
                If Sql%RowCount = 0 Then
                  Insert Into 临床出诊序号控制
                    (记录id, 序号, 开始时间, 终止时间, 数量, 是否预约, 挂号状态, 锁号时间, 名称, 类型, 操作员姓名, 工作站名称)
                    Select 记录id, n_序号,
                           To_Date(To_Char(开始时间, 'yyyy-mm-dd') || ' ' || To_Char(d_日期, 'hh24:mi:ss'),
                                    'yyyy-mm-dd hh24:mi:ss'),
                           To_Date(To_Char(开始时间, 'yyyy-mm-dd') || ' ' || To_Char(d_日期, 'hh24:mi:ss'),
                                    'yyyy-mm-dd hh24:mi:ss'), 1, 是否预约, 5, Sysdate, v_合作单位, 1, v_操作员姓名, v_机器名
                    From 临床出诊序号控制
                    Where 记录id = n_记录id And Rownum < 2;
                End If;
              Else
                Begin
                  If Trunc(d_日期) = Trunc(Sysdate) Then
                    Select Min(序号), Min(挂号状态)
                    Into n_序号, n_挂号状态
                    From 临床出诊序号控制
                    Where 记录id = n_记录id And 开始时间 <> 终止时间 And To_Char(开始时间, 'hh24:mi') >= To_Char(d_时段开始, 'hh24:mi') And
                          (Nvl(挂号状态, 0) = 0 Or Nvl(挂号状态, 0) = 5) And Nvl(是否停诊, 0) <> 1 And
                          To_Char(开始时间, 'hh24:mi') < To_Char(d_时段结束, 'hh24:mi') And Rownum < 2;
                  Else
                    Select Min(序号), Min(挂号状态)
                    Into n_序号, n_挂号状态
                    From 临床出诊序号控制
                    Where 记录id = n_记录id And 开始时间 <> 终止时间 And To_Char(开始时间, 'hh24:mi') >= To_Char(d_时段开始, 'hh24:mi') And
                          (Nvl(挂号状态, 0) = 0 Or Nvl(挂号状态, 0) = 5) And Nvl(是否停诊, 0) <> 1 And
                          To_Char(开始时间, 'hh24:mi') < To_Char(d_时段结束, 'hh24:mi') And Rownum < 2 And 是否预约 = 1;
                  End If;
                  If Nvl(n_序号, 0) = 0 Then
                    If d_时段结束 Is Null Then
                      If Trunc(d_日期) = Trunc(Sysdate) Then
                        Select Min(序号)
                        Into n_序号
                        From 临床出诊序号控制
                        Where 记录id = n_记录id And 开始时间 >= d_日期 And Nvl(挂号状态, 0) = 0 And Nvl(是否停诊, 0) <> 1;
                        If Nvl(n_序号, 0) = 0 Then
                          Select Max(序号) + 1 Into n_序号 From 临床出诊序号控制 Where 记录id = n_记录id;
                        End If;
                      Else
                        v_Temp := '传入时间' || d_日期 || '没有找到对应的序号,无法预约';
                        Raise Err_Item;
                      End If;
                    
                    Else
                      v_Temp := '传入时间段' || v_时间段 || '序号已被使用完,无法预约';
                      Raise Err_Item;
                    End If;
                  Else
                    If Nvl(n_挂号状态, 0) = 5 Then
                      Select 1 Into n_存在 From 临床出诊序号控制 Where 操作员姓名 = v_操作员姓名 And 序号 = n_序号;
                      If n_存在 = 1 Then
                        v_Temp := '<HX>' || n_序号 || '</HX>';
                        Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
                      End If;
                    Else
                      If d_时段结束 Is Null Then
                        If Trunc(d_日期) = Trunc(Sysdate) Then
                          Select Min(序号)
                          Into n_序号
                          From 临床出诊序号控制
                          Where 记录id = n_记录id And 开始时间 >= d_日期 And Nvl(挂号状态, 0) = 0 And Nvl(是否停诊, 0) <> 1;
                          If Nvl(n_序号, 0) = 0 Then
                            Select Max(序号) + 1 Into n_序号 From 临床出诊序号控制 Where 记录id = n_记录id;
                          End If;
                        Else
                          v_Temp := '传入时间' || d_日期 || '没有找到对应的序号,无法预约';
                          Raise Err_Item;
                        End If;
                      
                      Else
                        v_Temp := '传入时间段' || v_时间段 || '序号已被使用完,无法预约';
                        Raise Err_Item;
                      End If;
                    End If;
                  End If;
                Exception
                  When Others Then
                    If d_时段结束 Is Null Then
                      If Trunc(d_日期) = Trunc(Sysdate) Then
                        Select Min(序号)
                        Into n_序号
                        From 临床出诊序号控制
                        Where 记录id = n_记录id And 开始时间 >= d_日期 And Nvl(挂号状态, 0) = 0 And Nvl(是否停诊, 0) <> 1;
                        If Nvl(n_序号, 0) = 0 Then
                          Select Max(序号) + 1 Into n_序号 From 临床出诊序号控制 Where 记录id = n_记录id;
                        End If;
                      Else
                        v_Temp := '传入时间' || d_日期 || '没有找到对应的序号,无法预约';
                        Raise Err_Item;
                      End If;
                    Else
                      v_Temp := '传入时间段' || v_时间段 || '序号已被使用完,无法预约';
                      Raise Err_Item;
                    End If;
                End;
              
                Update 临床出诊序号控制
                Set 挂号状态 = 5, 锁号时间 = Sysdate, 操作员姓名 = v_操作员姓名, 工作站名称 = v_机器名
                Where 记录id = n_记录id And 序号 = n_序号;
                If Sql%RowCount = 0 Then
                  Insert Into 临床出诊序号控制
                    (记录id, 序号, 开始时间, 终止时间, 数量, 是否预约, 挂号状态, 锁号时间, 名称, 类型, 操作员姓名, 工作站名称)
                    Select 记录id, n_序号,
                           To_Date(To_Char(开始时间, 'yyyy-mm-dd') || ' ' || To_Char(d_日期, 'hh24:mi:ss'),
                                    'yyyy-mm-dd hh24:mi:ss'),
                           
                           To_Date(To_Char(开始时间, 'yyyy-mm-dd') || ' ' || To_Char(d_日期, 'hh24:mi:ss'),
                                    'yyyy-mm-dd hh24:mi:ss'), 1, 是否预约, 5, Sysdate, v_合作单位, 1, v_操作员姓名, v_机器名
                    From 临床出诊序号控制
                    Where 记录id = n_记录id And Rownum < 2;
                End If;
              
              End If;
            End If;
            v_Temp := '<HX>' || n_序号 || '</HX>';
            Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
          Else
            If v_合作单位 Is Null Or n_启用合作单位 = 0 Then
              --非合作单位
              Select Min(序号)
              Into n_序号
              From 临床出诊序号控制
              Where 记录id = n_记录id And Nvl(挂号状态, 0) = 0 And Nvl(是否停诊, 0) <> 1;
              If Nvl(n_序号, 0) = 0 Then
                Select Max(序号) + 1 Into n_序号 From 临床出诊序号控制 Where 记录id = n_记录id;
              End If;
              Update 临床出诊序号控制
              Set 挂号状态 = 5, 锁号时间 = Sysdate, 操作员姓名 = v_操作员姓名, 工作站名称 = v_机器名
              Where 记录id = n_记录id And 序号 = n_序号;
              If Sql%RowCount = 0 Then
                Insert Into 临床出诊序号控制
                  (记录id, 序号, 开始时间, 终止时间, 数量, 是否预约, 挂号状态, 锁号时间, 名称, 类型, 操作员姓名, 工作站名称)
                  Select 记录id, n_序号,
                         To_Date(To_Char(开始时间, 'yyyy-mm-dd') || ' ' || To_Char(d_日期, 'hh24:mi:ss'),
                                  'yyyy-mm-dd hh24:mi:ss'),
                         To_Date(To_Char(开始时间, 'yyyy-mm-dd') || ' ' || To_Char(d_日期, 'hh24:mi:ss'),
                                  'yyyy-mm-dd hh24:mi:ss'), 1, 是否预约, 5, Sysdate, v_合作单位, 1, v_操作员姓名, v_机器名
                  From 临床出诊序号控制
                  Where 记录id = n_记录id And Rownum < 2;
              End If;
              v_Temp := '<HX>' || n_序号 || '</HX>';
              Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
            Else
              --合作单位
              Begin
                Select 控制方式
                Into n_合约模式
                From 临床出诊挂号控制记录
                Where 记录id = n_记录id And 类型 = 1 And 性质 = 1 And 名称 = v_合作单位 And Rownum < 2;
              Exception
                When Others Then
                  n_合约模式 := 4;
              End;
              If n_合约模式 = 0 Then
                v_Temp := '本号别禁止该合作单位预约!';
                Raise Err_Item;
              End If;
              If n_合约模式 = 1 Or n_合约模式 = 2 Or n_合约模式 = 4 Then
                Select Min(序号)
                Into n_序号
                From 临床出诊序号控制
                Where 记录id = n_记录id And Nvl(挂号状态, 0) = 0 And Nvl(是否停诊, 0) <> 1;
                If n_序号 = 0 Then
                  Select Max(序号) + 1 Into n_序号 From 临床出诊序号控制 Where 记录id = n_记录id;
                End If;
              End If;
              If n_合约模式 = 3 Then
                Select Min(a.序号)
                Into n_序号
                From 临床出诊序号控制 A, 临床出诊挂号控制记录 B
                Where a.记录id = n_记录id And a.记录id = b.记录id And b.类型 = 1 And b.性质 = 1 And b.名称 = v_合作单位 And a.序号 = b.序号 And
                      Nvl(a.挂号状态, 0) = 0 And Nvl(是否停诊, 0) <> 1;
                If n_序号 = 0 Then
                  v_Temp := '本号别合作单位可预约序号已经全部使用完!';
                  Raise Err_Item;
                End If;
              End If;
              Update 临床出诊序号控制
              Set 挂号状态 = 5, 锁号时间 = Sysdate, 操作员姓名 = v_操作员姓名, 工作站名称 = v_机器名
              Where 记录id = n_记录id And 序号 = n_序号;
              If Sql%RowCount = 0 Then
                Insert Into 临床出诊序号控制
                  (记录id, 序号, 开始时间, 终止时间, 数量, 是否预约, 挂号状态, 锁号时间, 名称, 类型, 操作员姓名, 工作站名称)
                  Select 记录id, n_序号,
                         To_Date(To_Char(开始时间, 'yyyy-mm-dd') || ' ' || To_Char(d_日期, 'hh24:mi:ss'),
                                  'yyyy-mm-dd hh24:mi:ss'),
                         To_Date(To_Char(开始时间, 'yyyy-mm-dd') || ' ' || To_Char(d_日期, 'hh24:mi:ss'),
                                  'yyyy-mm-dd hh24:mi:ss'), 1, 是否预约, 5, Sysdate, v_合作单位, 1, v_操作员姓名, v_机器名
                  From 临床出诊序号控制
                  Where 记录id = n_记录id And Rownum < 2;
              End If;
              v_Temp := '<HX>' || n_序号 || '</HX>';
              Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
            End If;
          End If;
        End If;
      Else
        --非序号控制
        If n_分时段 = 1 Then
          If v_合作单位 Is Null Or n_启用合作单位 = 0 Then
            Begin
              If v_时间段 Is Null Then
                Select 序号, 数量
                Into n_号序, n_数量
                From 临床出诊序号控制
                Where 记录id = n_记录id And 预约顺序号 Is Null And 开始时间 = d_日期;
              Else
                Select Min(序号)
                Into n_号序
                From 临床出诊序号控制 A
                Where a.记录id = n_记录id And a.预约顺序号 Is Null And a.开始时间 >= d_时段开始 And a.开始时间 < d_时段结束 And
                      数量 > (Select Count(1)
                            From 临床出诊序号控制
                            Where 记录id = n_记录id And 预约顺序号 Is Not Null And 序号 = a.序号 And Nvl(挂号状态, 0) <> 0);
                If Nvl(n_号序, 0) = 0 Then
                  v_Temp := '本号别可用序号已经全部使用完!';
                  Raise Err_Item;
                End If;
                Select 数量
                Into n_数量
                From 临床出诊序号控制
                Where 记录id = n_记录id And 预约顺序号 Is Null And 序号 = n_号序;
              End If;
              Select Count(1)
              Into n_Exists
              From 临床出诊序号控制
              Where 记录id = n_记录id And 预约顺序号 Is Not Null And 序号 = n_号序 And Nvl(挂号状态, 0) <> 0;
            
              If n_Exists >= n_数量 Then
                v_Temp := '本号别可用序号已经全部使用完!';
                Raise Err_Item;
              Else
                Select Min(预约顺序号)
                Into n_顺序号
                From 临床出诊序号控制
                Where 记录id = n_记录id And 预约顺序号 Is Not Null And 序号 = n_号序 And Nvl(挂号状态, 0) = 0 And Nvl(是否停诊, 0) <> 1;
                If n_顺序号 = 0 Then
                  Select Max(预约顺序号) + 1
                  Into n_顺序号
                  From 临床出诊序号控制
                  Where 记录id = n_记录id And 预约顺序号 Is Not Null And 序号 = n_号序;
                End If;
                Update 临床出诊序号控制
                Set 挂号状态 = 5, 锁号时间 = Sysdate, 操作员姓名 = v_操作员姓名, 工作站名称 = v_机器名
                Where 记录id = n_记录id And 序号 = n_序号 And 预约顺序号 = n_顺序号;
                If Sql%RowCount = 0 Then
                  Insert Into 临床出诊序号控制
                    (记录id, 序号, 开始时间, 终止时间, 数量, 是否预约, 挂号状态, 锁号时间, 名称, 类型, 操作员姓名, 工作站名称, 预约顺序号)
                    Select 记录id, n_序号,
                           To_Date(To_Char(开始时间, 'yyyy-mm-dd') || ' ' || To_Char(d_日期, 'hh24:mi:ss'),
                                    'yyyy-mm-dd hh24:mi:ss'),
                           To_Date(To_Char(开始时间, 'yyyy-mm-dd') || ' ' || To_Char(d_日期, 'hh24:mi:ss'),
                                    'yyyy-mm-dd hh24:mi:ss'), 1, 是否预约, 5, Sysdate, v_合作单位, 1, v_操作员姓名, v_机器名, n_顺序号
                    From 临床出诊序号控制
                    Where 记录id = n_记录id And Rownum < 2;
                End If;
                v_Temp := '<HX>' || n_号序 || '</HX>';
                Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
              End If;
            Exception
              When Others Then
                Null;
            End;
          Else
            --合作单位
            Begin
              Select 控制方式
              Into n_合约模式
              From 临床出诊挂号控制记录
              Where 记录id = n_记录id And 类型 = 1 And 性质 = 1 And 名称 = v_合作单位 And Rownum < 2;
            Exception
              When Others Then
                n_合约模式 := 4;
            End;
            If n_合约模式 = 0 Then
              v_Temp := '本号别禁止该合作单位预约!';
              Raise Err_Item;
            End If;
            If n_合约模式 = 1 Or n_合约模式 = 2 Or n_合约模式 = 4 Then
              Begin
                If v_时间段 Is Null Then
                  Select 序号, 数量
                  Into n_号序, n_数量
                  From 临床出诊序号控制
                  Where 记录id = n_记录id And 预约顺序号 Is Null And 开始时间 = d_日期;
                Else
                  Select Min(序号)
                  Into n_号序
                  From 临床出诊序号控制 A
                  Where a.记录id = n_记录id And a.预约顺序号 Is Null And a.开始时间 >= d_时段开始 And a.开始时间 < d_时段结束 And
                        数量 > (Select Count(1)
                              From 临床出诊序号控制
                              Where 记录id = n_记录id And 预约顺序号 Is Not Null And 序号 = a.序号 And Nvl(挂号状态, 0) <> 0);
                  If Nvl(n_号序, 0) = 0 Then
                    v_Temp := '本号别可用序号已经全部使用完!';
                    Raise Err_Item;
                  End If;
                  Select 数量
                  Into n_数量
                  From 临床出诊序号控制
                  Where 记录id = n_记录id And 预约顺序号 Is Null And 序号 = n_号序;
                End If;
                Select Count(1)
                Into n_Exists
                From 临床出诊序号控制
                Where 记录id = n_记录id And 预约顺序号 Is Not Null And 序号 = n_号序 And Nvl(挂号状态, 0) <> 0;
                If n_Exists >= n_数量 Then
                  v_Temp := '本号别可用序号已经全部使用完!';
                  Raise Err_Item;
                Else
                  Select Min(预约顺序号)
                  Into n_顺序号
                  From 临床出诊序号控制
                  Where 记录id = n_记录id And 预约顺序号 Is Not Null And 序号 = n_号序 And Nvl(挂号状态, 0) = 0 And Nvl(是否停诊, 0) <> 1;
                  If n_顺序号 = 0 Then
                    Select Max(预约顺序号) + 1
                    Into n_顺序号
                    From 临床出诊序号控制
                    Where 记录id = n_记录id And 预约顺序号 Is Not Null And 序号 = n_号序;
                  End If;
                  Update 临床出诊序号控制
                  Set 挂号状态 = 5, 锁号时间 = Sysdate, 操作员姓名 = v_操作员姓名, 工作站名称 = v_机器名
                  Where 记录id = n_记录id And 序号 = n_序号 And 预约顺序号 = n_顺序号;
                  If Sql%RowCount = 0 Then
                    Insert Into 临床出诊序号控制
                      (记录id, 序号, 开始时间, 终止时间, 数量, 是否预约, 挂号状态, 锁号时间, 名称, 类型, 操作员姓名, 工作站名称, 预约顺序号)
                      Select 记录id, n_序号,
                             To_Date(To_Char(开始时间, 'yyyy-mm-dd') || ' ' || To_Char(d_日期, 'hh24:mi:ss'),
                                      'yyyy-mm-dd hh24:mi:ss'),
                             To_Date(To_Char(开始时间, 'yyyy-mm-dd') || ' ' || To_Char(d_日期, 'hh24:mi:ss'),
                                      'yyyy-mm-dd hh24:mi:ss'), 1, 是否预约, 5, Sysdate, v_合作单位, 1, v_操作员姓名, v_机器名, n_顺序号
                      From 临床出诊序号控制
                      Where 记录id = n_记录id And Rownum < 2;
                  End If;
                  v_Temp := '<HX>' || n_号序 || '</HX>';
                  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
                End If;
              Exception
                When Others Then
                  Null;
              End;
            End If;
            If n_合约模式 = 3 Then
              Begin
                If v_时间段 Is Null Then
                  Select 序号
                  Into n_号序
                  From 临床出诊序号控制
                  Where 记录id = n_记录id And 预约顺序号 Is Null And 开始时间 = d_日期;
                  Select 数量
                  Into n_数量
                  From 临床出诊挂号控制记录
                  Where 记录id = n_记录id And 类型 = 1 And 性质 = 1 And 名称 = v_合作单位 And 序号 = n_号序;
                Else
                  Select Min(序号)
                  Into n_号序
                  From 临床出诊序号控制 A
                  Where a.记录id = n_记录id And a.预约顺序号 Is Null And a.开始时间 >= d_时段开始 And a.开始时间 < d_时段结束 And
                        数量 > (Select Count(1)
                              From 临床出诊序号控制
                              Where 记录id = n_记录id And 预约顺序号 Is Not Null And 序号 = a.序号 And Nvl(挂号状态, 0) <> 0);
                  If Nvl(n_号序, 0) = 0 Then
                    v_Temp := '本号别可用序号已经全部使用完!';
                    Raise Err_Item;
                  End If;
                  Select 数量
                  Into n_数量
                  From 临床出诊序号控制
                  Where 记录id = n_记录id And 预约顺序号 Is Null And 序号 = n_号序;
                End If;
                Select Count(1)
                Into n_Exists
                From 临床出诊序号控制
                Where 记录id = n_记录id And 预约顺序号 Is Not Null And 序号 = n_号序 And Nvl(挂号状态, 0) <> 0;
                If n_Exists >= n_数量 Then
                  v_Temp := '本号别可用序号已经全部使用完!';
                  Raise Err_Item;
                Else
                  Select Min(预约顺序号)
                  Into n_顺序号
                  From 临床出诊序号控制
                  Where 记录id = n_记录id And 预约顺序号 Is Not Null And 序号 = n_号序 And Nvl(挂号状态, 0) = 0 And Nvl(是否停诊, 0) <> 1;
                  If n_顺序号 = 0 Then
                    Select Max(预约顺序号) + 1
                    Into n_顺序号
                    From 临床出诊序号控制
                    Where 记录id = n_记录id And 预约顺序号 Is Not Null And 序号 = n_号序;
                  End If;
                  Update 临床出诊序号控制
                  Set 挂号状态 = 5, 锁号时间 = Sysdate, 操作员姓名 = v_操作员姓名, 工作站名称 = v_机器名
                  Where 记录id = n_记录id And 序号 = n_序号 And 预约顺序号 = n_顺序号;
                  If Sql%RowCount = 0 Then
                    Insert Into 临床出诊序号控制
                      (记录id, 序号, 开始时间, 终止时间, 数量, 是否预约, 挂号状态, 锁号时间, 名称, 类型, 操作员姓名, 工作站名称, 预约顺序号)
                      Select 记录id, n_序号,
                             To_Date(To_Char(开始时间, 'yyyy-mm-dd') || ' ' || To_Char(d_日期, 'hh24:mi:ss'),
                                      'yyyy-mm-dd hh24:mi:ss'),
                             To_Date(To_Char(开始时间, 'yyyy-mm-dd') || ' ' || To_Char(d_日期, 'hh24:mi:ss'),
                                      'yyyy-mm-dd hh24:mi:ss'), 1, 是否预约, 5, Sysdate, v_合作单位, 1, v_操作员姓名, v_机器名, n_顺序号
                      From 临床出诊序号控制
                      Where 记录id = n_记录id And Rownum < 2;
                  End If;
                  v_Temp := '<HX>' || n_号序 || '</HX>';
                  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
                End If;
              Exception
                When Others Then
                  Null;
              End;
            End If;
          End If;
        End If;
      End If;
    Else
      n_序号 := n_号序;
      Update 临床出诊序号控制
      Set 挂号状态 = 5, 操作员姓名 = v_操作员姓名, 工作站名称 = v_机器名, 锁号时间 = Sysdate
      Where 记录id = n_记录id And 序号 = n_序号;
      If Sql%RowCount = 0 Then
        Begin
          Insert Into 临床出诊序号控制
            (记录id, 序号, 开始时间, 终止时间, 数量, 是否预约, 挂号状态, 锁号时间, 名称, 类型, 操作员姓名, 工作站名称)
            Select 记录id, n_序号,
                   To_Date(To_Char(开始时间, 'yyyy-mm-dd') || ' ' || To_Char(d_日期, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss'),
                   To_Date(To_Char(开始时间, 'yyyy-mm-dd') || ' ' || To_Char(d_日期, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss'),
                   1, 是否预约, 5, Sysdate, v_合作单位, 1, v_操作员姓名, v_机器名
            From 临床出诊序号控制
            Where 记录id = n_记录id And Rownum < 2;
        Exception
          When Others Then
            v_Temp := '传入的锁号序号已被使用!';
            Raise Err_Item;
        End;
      End If;
    
    End If;
  End If;
  Xml_Out := x_Templet;
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Temp || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Lockno;
/

--114257:刘尔旋,2017-09-20,汇总过程不进行有效性检查
Create Or Replace Procedure Zl_预约挂号接收_Insert
(
  No_In            门诊费用记录.No%Type,
  票据号_In        门诊费用记录.实际票号%Type,
  领用id_In        票据使用明细.领用id%Type,
  结帐id_In        门诊费用记录.结帐id%Type,
  诊室_In          门诊费用记录.发药窗口%Type,
  病人id_In        门诊费用记录.病人id%Type,
  门诊号_In        门诊费用记录.标识号%Type,
  姓名_In          门诊费用记录.姓名%Type,
  性别_In          门诊费用记录.性别%Type,
  年龄_In          门诊费用记录.年龄%Type,
  付款方式_In      门诊费用记录.付款方式%Type, --用于存放病人的医疗付款方式编号
  费别_In          门诊费用记录.费别%Type,
  结算方式_In      病人预交记录.结算方式%Type, --现金的结算名称
  现金支付_In      病人预交记录.冲预交%Type, --挂号时现金支付部份金额
  预交支付_In      病人预交记录.冲预交%Type, --挂号时使用的预交金额
  个帐支付_In      病人预交记录.冲预交%Type, --挂号时个人帐户支付金额
  发生时间_In      门诊费用记录.发生时间%Type,
  号序_In          挂号序号状态.序号%Type,
  操作员编号_In    门诊费用记录.操作员编号%Type,
  操作员姓名_In    门诊费用记录.操作员姓名%Type,
  生成队列_In      Number := 0,
  登记时间_In      门诊费用记录.登记时间%Type := Null,
  卡类别id_In      病人预交记录.卡类别id%Type := Null,
  结算卡序号_In    病人预交记录.结算卡序号%Type := Null,
  卡号_In          病人预交记录.卡号%Type := Null,
  交易流水号_In    病人预交记录.交易流水号%Type := Null,
  交易说明_In      病人预交记录.交易说明%Type := Null,
  险类_In          病人挂号记录.险类%Type := Null,
  结算模式_In      Number := 0,
  记帐费用_In      Number := 0,
  冲预交病人ids_In Varchar2 := Null,
  三方调用_In      Number := 0,
  更新交款余额_In  Number := 0, --是否更新人员交款余额，主要是处理统一操作员登录多台自助机的情况
  摘要_In          病人挂号记录.摘要%Type := Null
) As
  --该游标用于收费冲预交的可用预交列表
  --以ID排序，优先冲上次未冲完的。
  Cursor c_Deposit
  (
    v_病人id        病人信息.病人id%Type,
    v_冲预交病人ids Varchar2
  ) Is
    Select 病人id, NO, Sum(Nvl(金额, 0) - Nvl(冲预交, 0)) As 金额, Min(记录状态) As 记录状态, Nvl(Max(结帐id), 0) As 结帐id,
           Max(Decode(记录性质, 1, ID, 0) * Decode(记录状态, 2, 0, 1)) As 原预交id
    From 病人预交记录
    Where 记录性质 In (1, 11) And 病人id In (Select Column_Value From Table(f_Num2list(v_冲预交病人ids))) And Nvl(预交类别, 2) = 1
     Having Sum(Nvl(金额, 0) - Nvl(冲预交, 0)) <> 0
    Group By NO, 病人id
    Order By Decode(病人id, Nvl(v_病人id, 0), 0, 1), 结帐id, NO;

  v_Err_Msg Varchar2(255);
  Err_Item    Exception;
  Err_Special Exception;

  v_现金     结算方式.名称%Type;
  v_个人帐户 结算方式.名称%Type;
  v_队列名称 排队叫号队列.队列名称%Type;
  v_号别     门诊费用记录.计算单位%Type;
  v_号序     门诊费用记录.发药窗口%Type;
  v_排队号码 排队叫号队列.排队号码 %Type;
  v_预约方式 病人挂号记录.预约方式 %Type;

  n_打印id        票据打印内容.Id%Type;
  n_预交金额      病人预交记录.金额%Type;
  n_返回值        病人预交记录.金额%Type;
  v_冲预交病人ids Varchar2(4000);

  n_挂号id         病人挂号记录.Id%Type;
  n_分诊台签到排队 Number;
  n_组id           财务缴款分组.Id%Type;
  n_Count          Number(18);
  n_排队           Number;
  n_当天排队       Number;
  n_当前金额       病人预交记录.金额%Type;
  n_预交id         病人预交记录.Id%Type;
  n_消费卡id       消费卡目录.Id%Type;
  n_自制卡         Number;

  d_Date       Date;
  d_预约时间   门诊费用记录.发生时间%Type;
  d_发生时间   Date;
  d_排队时间   Date;
  n_时段       Number := 0;
  n_存在       Number := 0;
  v_排队序号   排队叫号队列.排队序号%Type;
  n_结算模式   病人信息.结算模式%Type;
  n_票种       票据使用明细.票种%Type;
  v_付款方式   病人挂号记录.医疗付款方式%Type;
  v_操作员姓名 病人挂号记录.接收人%Type;
  n_接收模式   Number := 0;
Begin
  n_组id          := Zl_Get组id(操作员姓名_In);
  v_冲预交病人ids := Nvl(冲预交病人ids_In, 病人id_In);
  n_接收模式      := Nvl(zl_GetSysParameter('预约接收模式', 1111), 0);

  --获取结算方式名称
  Begin
    Select 名称 Into v_现金 From 结算方式 Where 性质 = 1;
  Exception
    When Others Then
      v_现金 := '现金';
  End;
  Begin
    Select 名称 Into v_个人帐户 From 结算方式 Where 性质 = 3;
  Exception
    When Others Then
      v_个人帐户 := '个人帐户';
  End;
  If 登记时间_In Is Null Then
    Select Sysdate Into d_Date From Dual;
  Else
    d_Date := 登记时间_In;
  End If;

  --更新挂号序号状态
  Begin
    Select 号别, 号序, Trunc(发生时间), 发生时间, 预约方式
    Into v_号别, v_号序, d_预约时间, d_发生时间, v_预约方式
    From 病人挂号记录
    Where 记录性质 = 2 And 记录状态 = 1 And Rownum = 1 And NO = No_In;
  Exception
    When Others Then
      Select Max(接收人) Into v_操作员姓名 From 病人挂号记录 Where 记录性质 = 2 And 记录状态 In (1, 3) And NO = No_In;
      If v_操作员姓名 Is Null Then
        v_Err_Msg := '当前预约挂号单已被取消';
        Raise Err_Item;
      Else
        If v_操作员姓名 = 操作员姓名_In Then
          v_Err_Msg := '当前预约挂号单已被接收';
          Raise Err_Special;
        Else
          v_Err_Msg := '当前预约挂号单已被其它人接收';
          Raise Err_Item;
        End If;
      End If;
  End;

  --判断是否分时段
  Begin
    Select 1
    Into n_时段
    From Dual
    Where Exists (Select 1
           From 挂号安排时段 A, 挂号安排 B
           Where a.安排id = b.Id And b.号码 = v_号别 And Rownum < 2
           Union All
           Select 1
           From 挂号计划时段 C, 挂号安排计划 D 　
           Where c.计划id = d.Id And d.号码 = v_号别 And d.生效时间 > Sysdate And Rownum < 2);
  Exception
    When Others Then
      n_时段 := 0;
  End;
  --分时段的号别，只能当天接收
  If n_时段 = 1 And 三方调用_In = 0 And n_接收模式 = 0 Then
    If Trunc(发生时间_In) <> Trunc(Sysdate) Then
      v_Err_Msg := '分时段的预约挂号单只能当天接收！';
      Raise Err_Item;
    End If;
  End If;

  If n_时段 = 0 And 三方调用_In = 0 Then
    If n_接收模式 = 0 Then
      If Trunc(发生时间_In) = Trunc(Sysdate) Then
        d_发生时间 := 发生时间_In;
      Else
        d_发生时间 := Sysdate;
      End If;
    Else
      d_发生时间 := 发生时间_In;
    End If;
  Else
    If Not 发生时间_In Is Null Then
      d_发生时间 := 发生时间_In;
    End If;
  End If;
  If Not v_号序 Is Null Then
    If 号序_In Is Null Then
      Delete 挂号序号状态 Where 号码 = v_号别 And Trunc(日期) = Trunc(d_预约时间) And 序号 = v_号序;
    Else
      If Trunc(d_预约时间) <> Trunc(Sysdate) And n_接收模式 = 0 Then
      
        If n_时段 = 0 And 三方调用_In = 0 Then
          --提前接收或延迟接收
          Delete 挂号序号状态 Where 号码 = v_号别 And Trunc(日期) = Trunc(d_预约时间) And 序号 = v_号序;
          Begin
            Select 1 Into n_存在 From 挂号序号状态 Where 号码 = v_号别 And 日期 = Trunc(Sysdate) And 序号 = v_号序;
          Exception
            When Others Then
              n_存在 := 0;
          End;
          If n_存在 = 0 Then
            Insert Into 挂号序号状态
              (号码, 日期, 序号, 状态, 操作员姓名, 登记时间)
            Values
              (v_号别, Trunc(Sysdate), v_号序, 1, 操作员姓名_In, Sysdate);
          Else
            --号码已被使用的情况
            Begin
              v_号序 := 1;
              Insert Into 挂号序号状态
                (号码, 日期, 序号, 状态, 操作员姓名, 登记时间)
              Values
                (v_号别, Trunc(Sysdate), v_号序, 1, 操作员姓名_In, Sysdate);
            Exception
              When Others Then
                Select Min(序号 + 1)
                Into v_号序
                From 挂号序号状态 A
                Where 号码 = v_号别 And 日期 = Trunc(Sysdate) And Not Exists
                 (Select 1 From 挂号序号状态 Where 号码 = a.号码 And 日期 = a.日期 And 序号 = a.序号 + 1);
                Insert Into 挂号序号状态
                  (号码, 日期, 序号, 状态, 操作员姓名, 登记时间)
                Values
                  (v_号别, Trunc(Sysdate), v_号序, 1, 操作员姓名_In, Sysdate);
            End;
          End If;
        Else
          Update 挂号序号状态
          Set 状态 = 1, 登记时间 = Sysdate
          Where Trunc(日期) = Trunc(d_预约时间) And 序号 = v_号序 And 号码 = v_号别 And 状态 = 2;
          If Sql% NotFound Then
            Begin
              Insert Into 挂号序号状态
                (号码, 日期, 序号, 状态, 操作员姓名, 登记时间)
              Values
                (v_号别, Trunc(Sysdate), v_号序, 1, 操作员姓名_In, Sysdate);
            Exception
              When Others Then
                v_Err_Msg := '序号' || v_号序 || '已被其它人使用,请重新选择一个序号.';
                Raise Err_Item;
            End;
          End If;
        
        End If;
      
      Else
        Update 挂号序号状态
        Set 序号 = 号序_In, 状态 = 1, 登记时间 = Sysdate
        Where 号码 = v_号别 And Trunc(日期) = Trunc(d_预约时间) And 序号 = v_号序;
        If Sql%RowCount = 0 Then
          Begin
            Insert Into 挂号序号状态
              (号码, 日期, 序号, 状态, 操作员姓名, 登记时间)
            Values
              (v_号别, Trunc(d_发生时间), v_号序, 1, 操作员姓名_In, Sysdate);
          Exception
            When Others Then
              v_Err_Msg := '序号' || v_号序 || '已被其它人使用,请重新选择一个序号.';
              Raise Err_Item;
          End;
        End If;
      End If;
    End If;
  Else
    If Not 号序_In Is Null Then
      Begin
        Insert Into 挂号序号状态
          (号码, 日期, 序号, 状态, 操作员姓名, 登记时间)
        Values
          (v_号别, Trunc(Sysdate), 号序_In, 1, 操作员姓名_In, Sysdate);
      Exception
        When Others Then
          v_Err_Msg := '序号' || 号序_In || '已被其它人使用,请重新选择一个序号.';
          Raise Err_Item;
      End;
      v_号序 := 号序_In;
    Else
      v_号序 := Null;
    End If;
  End If;

  --更新门诊费用记录
  Update 门诊费用记录
  Set 记录状态 = 1, 实际票号 = Decode(Nvl(记帐费用_In, 0), 1, Null, 票据号_In), 结帐id = Decode(Nvl(记帐费用_In, 0), 1, Null, 结帐id_In),
      结帐金额 = Decode(Nvl(记帐费用_In, 0), 1, Null, 实收金额), 发药窗口 = 诊室_In, 病人id = 病人id_In, 标识号 = 门诊号_In, 姓名 = 姓名_In, 年龄 = 年龄_In,
      性别 = 性别_In, 付款方式 = 付款方式_In, 费别 = 费别_In, 发生时间 = d_发生时间, 登记时间 = d_Date, 操作员编号 = 操作员编号_In, 操作员姓名 = 操作员姓名_In,
      缴款组id = n_组id, 记帐费用 = Decode(Nvl(记帐费用_In, 0), 1, 1, 0), 摘要 = Nvl(摘要_In, 摘要)
  Where 记录性质 = 4 And 记录状态 = 0 And NO = No_In;

  --病人挂号记录
  Update 病人挂号记录
  Set 接收人 = 操作员姓名_In, 接收时间 = d_Date, 记录性质 = 1, 病人id = 病人id_In, 门诊号 = 门诊号_In, 发生时间 = d_发生时间, 姓名 = 姓名_In, 性别 = 性别_In,
      年龄 = 年龄_In, 操作员编号 = 操作员编号_In, 操作员姓名 = 操作员姓名_In, 险类 = Decode(Nvl(险类_In, 0), 0, Null, 险类_In), 号序 = v_号序, 诊室 = 诊室_In,
      摘要 = Nvl(摘要_In, 摘要)
  Where 记录状态 = 1 And NO = No_In And 记录性质 = 2
  Returning ID Into n_挂号id;
  If Sql%NotFound Then
    Begin
      Select 病人挂号记录_Id.Nextval Into n_挂号id From Dual;
      Begin
        Select 名称 Into v_付款方式 From 医疗付款方式 Where 编码 = 付款方式_In And Rownum < 2;
      Exception
        When Others Then
          v_付款方式 := Null;
      End;
      Insert Into 病人挂号记录
        (ID, NO, 记录性质, 记录状态, 病人id, 门诊号, 姓名, 性别, 年龄, 号别, 急诊, 诊室, 附加标志, 执行部门id, 执行人, 执行状态, 执行时间, 登记时间, 发生时间, 操作员编号, 操作员姓名,
         摘要, 号序, 预约, 预约方式, 接收人, 接收时间, 预约时间, 险类, 医疗付款方式)
        Select n_挂号id, No_In, 1, 1, 病人id_In, 门诊号_In, 姓名_In, 性别_In, 年龄_In, 计算单位, 加班标志, 诊室_In, Null, 执行部门id, 执行人, 0, Null,
               登记时间, 发生时间, 操作员编号, 操作员姓名, Nvl(摘要_In, 摘要), v_号序, 1, Substr(结论, 1, 10) As 预约方式, 操作员姓名_In,
               Nvl(登记时间_In, Sysdate), 发生时间, Decode(Nvl(险类_In, 0), 0, Null, 险类_In), v_付款方式
        From 门诊费用记录
        Where 记录性质 = 4 And 记录状态 = 1 And Rownum = 1 And NO = No_In;
    Exception
      When Others Then
        v_Err_Msg := '由于并发原因,单据号为【' || No_In || '】的病人' || 姓名_In || '已经被接收';
        Raise Err_Item;
    End;
  End If;

  --0-不产生队列;1-按医生或分诊台排队;2-先分诊,后医生站
  If Nvl(生成队列_In, 0) <> 0 Then
    n_分诊台签到排队 := Zl_To_Number(zl_GetSysParameter('分诊台签到排队', 1113));
    If Nvl(n_分诊台签到排队, 0) = 0 Then
      For v_挂号 In (Select ID, 姓名, 诊室, 执行人, 执行部门id, 发生时间, 号别, 号序 From 病人挂号记录 Where NO = No_In) Loop
      
        Begin
          Select 1,
                 Case
                   When 排队时间 < Trunc(Sysdate) Then
                    1
                   Else
                    0
                 End
          Into n_排队, n_当天排队
          From 排队叫号队列
          Where 业务类型 = 0 And 业务id = v_挂号.Id And Rownum <= 1;
        Exception
          When Others Then
            n_排队 := 0;
        End;
        If n_排队 = 0 Then
          --产生队列
          --按”执行部门”产生队列
          n_挂号id   := v_挂号.Id;
          v_队列名称 := v_挂号.执行部门id;
          v_排队号码 := Zlgetnextqueue(v_挂号.执行部门id, n_挂号id, v_挂号.号别 || '|' || v_挂号.号序);
          v_排队序号 := Zlgetsequencenum(0, n_挂号id, 0);
        
          --挂号id_In,号码_In,号序_In,缺省日期_In,扩展_In(暂无用)
          d_排队时间 := Zl_Get_Queuedate(n_挂号id, v_挂号.号别, v_挂号.号序, v_挂号.发生时间);
          --   队列名称_In , 业务类型_In, 业务id_In,科室id_In,排队号码_In,排队标记_In,患者姓名_In,病人ID_IN, 诊室_In, 医生姓名_In,
          Zl_排队叫号队列_Insert(v_队列名称, 0, n_挂号id, v_挂号.执行部门id, v_排队号码, Null, 姓名_In, 病人id_In, v_挂号.诊室, v_挂号.执行人, d_排队时间,
                           v_预约方式, Null, v_排队序号);
        Elsif Nvl(n_当天排队, 0) = 1 Then
          --更新队列号
          v_排队号码 := Zlgetnextqueue(v_挂号.执行部门id, v_挂号.Id, v_挂号.号别 || '|' || Nvl(v_挂号.号序, 0));
          v_排队序号 := Zlgetsequencenum(0, v_挂号.Id, 1);
          --新队列名称_IN, 业务类型_In, 业务id_In , 科室id_In , 患者姓名_In , 诊室_In, 医生姓名_In ,排队号码_In
          Zl_排队叫号队列_Update(v_挂号.执行部门id, 0, v_挂号.Id, v_挂号.执行部门id, v_挂号.姓名, v_挂号.诊室, v_挂号.执行人, v_排队号码, v_排队序号);
        
        Else
          --新队列名称_IN, 业务类型_In, 业务id_In , 科室id_In , 患者姓名_In , 诊室_In, 医生姓名_In ,排队号码_In
          Zl_排队叫号队列_Update(v_挂号.执行部门id, 0, v_挂号.Id, v_挂号.执行部门id, v_挂号.姓名, v_挂号.诊室, v_挂号.执行人);
        End If;
        --预约接收时，改变记录标志
        Update 病人挂号记录 Set 记录标志 = 1 Where ID = n_挂号id;
      End Loop;
    End If;
  End If;

  --汇总结算到病人预交记录
  If (Nvl(现金支付_In, 0) <> 0 Or (Nvl(现金支付_In, 0) = 0 And Nvl(个帐支付_In, 0) = 0 And Nvl(预交支付_In, 0) = 0)) And
     Nvl(记帐费用_In, 0) = 0 Then
    Select 病人预交记录_Id.Nextval Into n_预交id From Dual;
    Insert Into 病人预交记录
      (ID, 记录性质, 记录状态, NO, 病人id, 结算方式, 冲预交, 收款时间, 操作员编号, 操作员姓名, 结帐id, 摘要, 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 结算序号,
       结算性质)
    Values
      (n_预交id, 4, 1, No_In, 病人id_In, Nvl(结算方式_In, v_现金), Nvl(现金支付_In, 0), d_Date, 操作员编号_In, 操作员姓名_In, 结帐id_In, '挂号收费',
       n_组id, 卡类别id_In, 结算卡序号_In, 卡号_In, 交易流水号_In, 交易说明_In, 结帐id_In, 4);
  
    If Nvl(结算卡序号_In, 0) <> 0 And Nvl(现金支付_In, 0) <> 0 Then
    
      n_消费卡id := Null;
      Begin
        Select Nvl(自制卡, 0), 1 Into n_自制卡, n_Count From 卡消费接口目录 Where 编号 = 结算卡序号_In;
      Exception
        When Others Then
          n_Count := 0;
      End;
      If n_Count = 0 Then
        v_Err_Msg := '[ZLSOFT]没有发现原结算卡的相应类别,不能继续操作！[ZLSOFT]';
        Raise Err_Item;
      End If;
      If n_自制卡 = 1 Then
        Select ID
        Into n_消费卡id
        From 消费卡目录
        Where 接口编号 = 结算卡序号_In And 卡号 = 卡号_In And
              序号 = (Select Max(序号) From 消费卡目录 Where 接口编号 = 结算卡序号_In And 卡号 = 卡号_In);
      End If;
      Zl_病人卡结算记录_Insert(结算卡序号_In, n_消费卡id, 结算方式_In, 现金支付_In, 卡号_In, Null, 登记时间_In, Null, 结帐id_In, n_预交id);
    End If;
  
  End If;

  --对于就诊卡通过预交金挂号
  If Nvl(预交支付_In, 0) <> 0 And Nvl(记帐费用_In, 0) = 0 Then
    n_预交金额 := 预交支付_In;
    For r_Deposit In c_Deposit(病人id_In, v_冲预交病人ids) Loop
      n_当前金额 := Case
                  When r_Deposit.金额 - n_预交金额 < 0 Then
                   r_Deposit.金额
                  Else
                   n_预交金额
                End;
      If r_Deposit.结帐id = 0 Then
        --第一次冲预交(填上结帐ID,金额为0)
        Update 病人预交记录 Set 冲预交 = 0, 结帐id = 结帐id_In, 结算性质 = 4 Where ID = r_Deposit.原预交id;
      End If;
      --冲上次剩余额
      Insert Into 病人预交记录
        (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 科室id, 金额, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, 收款时间, 操作员姓名, 操作员编号, 冲预交,
         结帐id, 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 预交类别, 结算序号, 结算性质)
        Select 病人预交记录_Id.Nextval, NO, 实际票号, 11, 记录状态, 病人id, 主页id, 科室id, Null, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, 登记时间_In,
               操作员姓名_In, 操作员编号_In, n_当前金额, 结帐id_In, n_组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 预交类别, 结帐id_In, 4
        From 病人预交记录
        Where NO = r_Deposit.No And 记录状态 = r_Deposit.记录状态 And 记录性质 In (1, 11) And Rownum = 1;
    
      --更新病人预交余额
      Update 病人余额
      Set 预交余额 = Nvl(预交余额, 0) - n_当前金额
      Where 病人id = r_Deposit.病人id And 性质 = 1 And 类型 = Nvl(1, 2)
      Returning 预交余额 Into n_返回值;
      If Sql%RowCount = 0 Then
        Insert Into 病人余额 (病人id, 类型, 预交余额, 性质) Values (r_Deposit.病人id, Nvl(1, 2), -1 * n_当前金额, 1);
        n_返回值 := -1 * n_当前金额;
      End If;
      If Nvl(n_返回值, 0) = 0 Then
        Delete From 病人余额
        Where 病人id = r_Deposit.病人id And 性质 = 1 And Nvl(费用余额, 0) = 0 And Nvl(预交余额, 0) = 0;
      End If;
    
      --检查是否已经处理完
      If r_Deposit.金额 < n_预交金额 Then
        n_预交金额 := n_预交金额 - r_Deposit.金额;
      Else
        n_预交金额 := 0;
      End If;
    
      If n_预交金额 = 0 Then
        Exit;
      End If;
    End Loop;
  End If;

  --对于医保挂号
  If Nvl(个帐支付_In, 0) <> 0 And Nvl(记帐费用_In, 0) = 0 Then
    Insert Into 病人预交记录
      (ID, 记录性质, 记录状态, NO, 病人id, 结算方式, 冲预交, 收款时间, 操作员编号, 操作员姓名, 结帐id, 摘要, 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位,
       预交类别, 结算序号, 结算性质)
    Values
      (病人预交记录_Id.Nextval, 4, 1, No_In, 病人id_In, v_个人帐户, 个帐支付_In, d_Date, 操作员编号_In, 操作员姓名_In, 结帐id_In, '医保挂号', n_组id,
       Null, Null, Null, Null, Null, Null, Null, 结帐id_In, 4);
  End If;

  --相关汇总表的处理
  --人员缴款余额
  If Nvl(现金支付_In, 0) <> 0 And Nvl(记帐费用_In, 0) = 0 And Nvl(更新交款余额_In, 0) = 0 Then
    Update 人员缴款余额
    Set 余额 = Nvl(余额, 0) + 现金支付_In
    Where 性质 = 1 And 收款员 = 操作员姓名_In And 结算方式 = Nvl(结算方式_In, v_现金)
    Returning 余额 Into n_返回值;
  
    If Sql%RowCount = 0 Then
      Insert Into 人员缴款余额
        (收款员, 结算方式, 性质, 余额)
      Values
        (操作员姓名_In, Nvl(结算方式_In, v_现金), 1, 现金支付_In);
      n_返回值 := 现金支付_In;
    
    End If;
    If Nvl(n_返回值, 0) = 0 Then
      Delete From 人员缴款余额
      Where 收款员 = 操作员姓名_In And 性质 = 1 And 结算方式 = Nvl(结算方式_In, v_现金) And Nvl(余额, 0) = 0;
    End If;
  End If;

  If Nvl(个帐支付_In, 0) <> 0 And Nvl(记帐费用_In, 0) = 0 And Nvl(更新交款余额_In, 0) = 0 Then
    Update 人员缴款余额
    Set 余额 = Nvl(余额, 0) + 个帐支付_In
    Where 性质 = 1 And 收款员 = 操作员姓名_In And 结算方式 = v_个人帐户
    Returning 余额 Into n_返回值;
  
    If Sql%RowCount = 0 Then
      Insert Into 人员缴款余额 (收款员, 结算方式, 性质, 余额) Values (操作员姓名_In, v_个人帐户, 1, 个帐支付_In);
      n_返回值 := 个帐支付_In;
    End If;
    If Nvl(n_返回值, 0) = 0 Then
      Delete From 人员缴款余额 Where 收款员 = 操作员姓名_In And 性质 = 1 And Nvl(余额, 0) = 0;
    End If;
  End If;

  If Nvl(记帐费用_In, 0) = 1 Then
    --记帐
    If Nvl(病人id_In, 0) = 0 Then
      v_Err_Msg := '要针对病人的挂号费进行记帐，必须是建档病人才能记帐挂号。';
      Raise Err_Item;
    End If;
    For c_费用 In (Select 实收金额, 病人科室id, 开单部门id, 执行部门id, 收入项目id
                 From 门诊费用记录
                 Where 记录性质 = 4 And 记录状态 = 1 And NO = No_In And Nvl(记帐费用, 0) = 1) Loop
      --病人余额
      Update 病人余额
      Set 费用余额 = Nvl(费用余额, 0) + Nvl(c_费用.实收金额, 0)
      Where 病人id = Nvl(病人id_In, 0) And 性质 = 1 And 类型 = 1;
    
      If Sql%RowCount = 0 Then
        Insert Into 病人余额
          (病人id, 性质, 类型, 费用余额, 预交余额)
        Values
          (病人id_In, 1, 1, Nvl(c_费用.实收金额, 0), 0);
      End If;
    
      --病人未结费用
      Update 病人未结费用
      Set 金额 = Nvl(金额, 0) + Nvl(c_费用.实收金额, 0)
      Where 病人id = 病人id_In And Nvl(主页id, 0) = 0 And Nvl(病人病区id, 0) = 0 And Nvl(病人科室id, 0) = Nvl(c_费用.病人科室id, 0) And
            Nvl(开单部门id, 0) = Nvl(c_费用.开单部门id, 0) And Nvl(执行部门id, 0) = Nvl(c_费用.执行部门id, 0) And 收入项目id + 0 = c_费用.收入项目id And
            来源途径 + 0 = 1;
    
      If Sql%RowCount = 0 Then
        Insert Into 病人未结费用
          (病人id, 主页id, 病人病区id, 病人科室id, 开单部门id, 执行部门id, 收入项目id, 来源途径, 金额)
        Values
          (病人id_In, Null, Null, c_费用.病人科室id, c_费用.开单部门id, c_费用.执行部门id, c_费用.收入项目id, 1, Nvl(c_费用.实收金额, 0));
      End If;
    End Loop;
  End If;
  If Nvl(病人id_In, 0) <> 0 Then
    n_结算模式 := 0;
    Update 病人信息
    Set 就诊时间 = d_发生时间, 就诊状态 = 1, 就诊诊室 = 诊室_In
    Where 病人id = 病人id_In
    Returning Nvl(结算模式, 0) Into n_结算模式;
    --取参数:
    If Nvl(n_结算模式, 0) <> Nvl(结算模式_In, 0) Then
      --结算模式的确定
      If n_结算模式 = 1 And Nvl(结算模式_In, 0) = 0 Then
        --病人已经是"先诊疗后结算的",本次是"先结算后诊疗的",则检查是否存在未结数据
        Select Count(1)
        Into n_Count
        From 病人未结费用
        Where 病人id = 病人id_In And (来源途径 In (1, 4) Or 来源途径 = 3 And Nvl(主页id, 0) = 0) And Nvl(金额, 0) <> 0 And Rownum < 2;
        If Nvl(n_Count, 0) <> 0 Then
          --存在未结算数据，必须先结算后才允许执行
          v_Err_Msg := '当前病人的就诊模式为先诊疗后结算且存在未结费用，不允许调整该病人的就诊模式,你可以先对未结费用结帐后再挂号或不调整病人的就诊模式!';
          Raise Err_Item;
        End If;
        --检查
        --未发生医嘱业务的（即当时就挂号的,需要保证同一次的就诊模式是一至的(程序已经检查，不用再处理)
      End If;
      Update 病人信息 Set 结算模式 = 结算模式_In Where 病人id = 病人id_In;
    End If;
  End If;

  --病人担保信息
  If 病人id_In Is Not Null Then
    Update 病人信息
    Set 担保人 = Null, 担保额 = Null, 担保性质 = Null
    Where 病人id = 病人id_In And Nvl(在院, 0) = 0 And Exists
     (Select 1
           From 病人担保记录
           Where 病人id = 病人id_In And 主页id Is Not Null And
                 登记时间 = (Select Max(登记时间) From 病人担保记录 Where 病人id = 病人id_In));
    If Sql%RowCount > 0 Then
      Update 病人担保记录
      Set 到期时间 = d_Date
      Where 病人id = 病人id_In And 主页id Is Not Null And Nvl(到期时间, d_Date) >= d_Date;
    End If;
  End If;
  --消息推送
  Begin
    Execute Immediate 'Begin ZL_服务窗消息_发送(:1,:2); End;'
      Using 1, n_挂号id;
  Exception
    When Others Then
      Null;
  End;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Err_Special Then
    Raise_Application_Error(-20105, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_预约挂号接收_Insert;
/

--114257:刘尔旋,2017-09-20,汇总过程中不进行有效性检查
Create Or Replace Procedure Zl_病人挂号汇总_Update
(
  医生姓名_In   挂号安排.医生姓名%Type,
  医生id_In     挂号安排.医生id%Type,
  收费细目id_In 门诊费用记录.收费细目id%Type,
  执行部门id_In 门诊费用记录.执行部门id%Type,
  发生时间_In   门诊费用记录.发生时间%Type,
  预约标志_In   Number := 0, --是否为预约接收:0-非预约挂号; 1-预约挂号,2-预约接收;3-收费预约
  号码_In       挂号安排.号码%Type := Null,
  三方调用_In   Number := 0, --是否接口调用
  出诊记录id_In 临床出诊记录.Id%Type := Null
) As
  --发生时间_In:预约时,为预约时间;否则为登记时间
  v_Date    Date;
  n_预约数  病人挂号汇总.已约数%Type;
  n_时段    Number := 0;
  v_Err_Msg Varchar2(255);
  Err_Item Exception;
  n_接收模式     Number := 0;
  n_号源id       临床出诊记录.号源id%Type;
  n_新出诊记录id 临床出诊记录.Id%Type;
  n_旧分时段     临床出诊记录.是否分时段%Type;
  n_旧序号控制   临床出诊记录.是否序号控制%Type;
  n_旧医生id     临床出诊记录.医生id%Type;
  v_旧上班时段   临床出诊记录.上班时段%Type;
  n_旧科室id     临床出诊记录.科室id%Type;
Begin
  If 出诊记录id_In Is Null Then
    Begin
      Select 1
      Into n_时段
      From Dual
      Where Exists (Select 1
             From 挂号安排时段 A, 挂号安排 B
             Where a.安排id = b.Id And b.号码 = 号码_In And Rownum <= 1
             Union All
             Select 1
             From 挂号计划时段 C, 挂号安排计划 D 　
             Where c.计划id = d.Id And d.号码 = 号码_In And d.生效时间 > Sysdate And Rownum <= 1);
    Exception
      When Others Then
        n_时段 := 0;
    End;
    n_接收模式 := Nvl(zl_GetSysParameter('预约接收模式', 1111), 0);
    If Nvl(预约标志_In, 0) <> 2 Or 三方调用_In = 1 Then
      v_Date := Trunc(发生时间_In);
    Else
      If n_接收模式 = 0 Then
        v_Date := Trunc(Sysdate);
      Else
        v_Date := Trunc(发生时间_In);
      End If;
    End If;
  
    n_预约数 := 0;
    If Nvl(预约标志_In, 0) <> 1 Then
      --非预约挂号;或预约接收
      If Nvl(预约标志_In, 0) = 2 And v_Date <> Trunc(发生时间_In) Then
        --1.减去预约日期的预约数;
        --2-加上当前预约日期的挂号数;
        Update 病人挂号汇总
        Set 已约数 = Nvl(已约数, 0) - 1
        Where 日期 = Trunc(发生时间_In) And Nvl(科室id, 0) = 执行部门id_In And Nvl(项目id, 0) = 收费细目id_In And
              (号码 = 号码_In Or 号码 Is Null)
        Returning 已约数 Into n_预约数;
      
        If n_预约数 < 0 Then
          Update 病人挂号汇总
          Set 已约数 = 0
          Where 日期 = Trunc(发生时间_In) And Nvl(科室id, 0) = 执行部门id_In And Nvl(项目id, 0) = 收费细目id_In And
                (号码 = 号码_In Or 号码 Is Null)
          Returning 已约数 Into n_预约数;
        End If;
        n_预约数 := 1;
      Elsif Nvl(预约标志_In, 0) = 3 Then
        n_预约数 := 1;
      End If;
      Update 病人挂号汇总
      Set 已挂数 = Nvl(已挂数, 0) + 1, 其中已接收 = Nvl(其中已接收, 0) + Decode(预约标志_In, 0, 0, 1), 已约数 = Nvl(已约数, 0) + Nvl(n_预约数, 0)
      Where 日期 = Decode(预约标志_In, 2, Trunc(v_Date), Trunc(发生时间_In)) And Nvl(科室id, 0) = 执行部门id_In And
            Nvl(项目id, 0) = 收费细目id_In And (号码 = 号码_In Or 号码 Is Null);
      If Sql%RowCount = 0 Then
        Insert Into 病人挂号汇总
          (日期, 科室id, 项目id, 医生姓名, 医生id, 号码, 已挂数, 已约数, 其中已接收)
        Values
          (Decode(预约标志_In, 2, Trunc(v_Date), Trunc(发生时间_In)), 执行部门id_In, 收费细目id_In, 医生姓名_In,
           Decode(医生id_In, 0, Null, 医生id_In), 号码_In, 1, Nvl(n_预约数, 0), Decode(预约标志_In, 0, 0, 1));
      End If;
    Else
      --预约挂号
      Update 病人挂号汇总
      Set 已约数 = Nvl(已约数, 0) + 1
      Where 日期 = Trunc(v_Date) And Nvl(科室id, 0) = 执行部门id_In And Nvl(项目id, 0) = 收费细目id_In And (号码 = 号码_In Or 号码 Is Null);
    
      If Sql%RowCount = 0 Then
        Insert Into 病人挂号汇总
          (日期, 科室id, 项目id, 医生姓名, 医生id, 号码, 已约数)
        Values
          (Trunc(v_Date), 执行部门id_In, 收费细目id_In, 医生姓名_In, Decode(医生id_In, 0, Null, 医生id_In), 号码_In, 1);
      End If;
    End If;
  Else
    --出诊表排班模式
    Begin
      Select Nvl(是否分时段, 0) Into n_时段 From 临床出诊记录 Where ID = 出诊记录id_In;
    Exception
      When Others Then
        n_时段 := 0;
    End;
    Select 号源id Into n_号源id From 临床出诊记录 Where ID = 出诊记录id_In;
    n_接收模式 := Nvl(zl_GetSysParameter('预约接收模式', 1111), 0);
    If Nvl(预约标志_In, 0) <> 2 Or 三方调用_In = 1 Then
      v_Date := Trunc(发生时间_In);
    Else
      If n_接收模式 = 0 Then
        v_Date := Trunc(Sysdate);
      Else
        v_Date := Trunc(发生时间_In);
      End If;
    End If;
  
    n_预约数 := 0;
    If Nvl(预约标志_In, 0) <> 1 Then
      --非预约挂号;或预约接收
      If Nvl(预约标志_In, 0) = 2 And v_Date <> Trunc(发生时间_In) Then
        --1.减去预约日期的预约数;
        --2-加上当前预约日期的挂号数;
        Update 临床出诊记录 Set 已约数 = Nvl(已约数, 0) - 1 Where ID = 出诊记录id_In Returning 已约数 Into n_预约数;
        If n_预约数 < 0 Then
          Update 临床出诊记录 Set 已约数 = 0 Where ID = 出诊记录id_In Returning 已约数 Into n_预约数;
        End If;
        Update 病人挂号汇总
        Set 已约数 = Nvl(已约数, 0) - 1
        Where 日期 = Trunc(发生时间_In) And Nvl(医生id, 0) = Nvl(医生id_In, 0) And Nvl(医生姓名, '-') = Nvl(医生姓名_In, '-') And
              Nvl(科室id, 0) = 执行部门id_In And Nvl(项目id, 0) = 收费细目id_In And (号码 = 号码_In Or 号码 Is Null)
        Returning 已约数 Into n_预约数;
        If n_预约数 < 0 Then
          Update 病人挂号汇总
          Set 已约数 = 0
          Where 日期 = Trunc(发生时间_In) And Nvl(医生id, 0) = Nvl(医生id_In, 0) And Nvl(医生姓名, '-') = Nvl(医生姓名_In, '-') And
                Nvl(科室id, 0) = 执行部门id_In And Nvl(项目id, 0) = 收费细目id_In And (号码 = 号码_In Or 号码 Is Null)
          Returning 已约数 Into n_预约数;
        End If;
        n_预约数 := 1;
      Elsif Nvl(预约标志_In, 0) = 3 Then
        n_预约数 := 1;
      End If;
      If Nvl(预约标志_In, 0) = 2 And v_Date <> Trunc(发生时间_In) Then
        Select 是否分时段, 是否序号控制, 科室id, 医生id, 上班时段
        Into n_旧分时段, n_旧序号控制, n_旧科室id, n_旧医生id, v_旧上班时段
        From 临床出诊记录
        Where ID = 出诊记录id_In;

        Select ID
        Into n_新出诊记录id
        From 临床出诊记录
        Where 号源id = n_号源id And 是否分时段 = n_旧分时段 And 是否序号控制 = n_旧序号控制 And 科室id = n_旧科室id And
            Nvl(医生id, 0) = Nvl(n_旧医生id, 0) And Nvl(是否发布, 0) = 1 And 出诊日期 = Trunc(Sysdate) And 上班时段 = v_旧上班时段 And
            Rownum < 2;

        Update 临床出诊记录
        Set 已挂数 = Nvl(已挂数, 0) + 1, 其中已接收 = Nvl(其中已接收, 0) + Decode(预约标志_In, 0, 0, 1), 已约数 = Nvl(已约数, 0) + Nvl(n_预约数, 0)
        Where ID = n_新出诊记录id;
      
        Update 病人挂号汇总
        Set 已挂数 = Nvl(已挂数, 0) + 1, 其中已接收 = Nvl(其中已接收, 0) + Decode(预约标志_In, 0, 0, 1), 已约数 = Nvl(已约数, 0) + Nvl(n_预约数, 0)
        Where 日期 = Decode(预约标志_In, 2, Trunc(v_Date), Trunc(发生时间_In)) And Nvl(科室id, 0) = 执行部门id_In And
              Nvl(项目id, 0) = 收费细目id_In And Nvl(医生id, 0) = Nvl(医生id_In, 0) And Nvl(医生姓名, '-') = Nvl(医生姓名_In, '-') And
              (号码 = 号码_In Or 号码 Is Null);
        If Sql%RowCount = 0 Then
          Insert Into 病人挂号汇总
            (日期, 科室id, 项目id, 医生姓名, 医生id, 号码, 已挂数, 已约数, 其中已接收)
          Values
            (Decode(预约标志_In, 2, Trunc(v_Date), Trunc(发生时间_In)), 执行部门id_In, 收费细目id_In, 医生姓名_In,
             Decode(医生id_In, 0, Null, 医生id_In), 号码_In, 1, Nvl(n_预约数, 0), Decode(预约标志_In, 0, 0, 1));
        End If;
      Else
        Update 临床出诊记录
        Set 已挂数 = Nvl(已挂数, 0) + 1, 其中已接收 = Nvl(其中已接收, 0) + Decode(预约标志_In, 0, 0, 1), 已约数 = Nvl(已约数, 0) + Nvl(n_预约数, 0)
        Where ID = 出诊记录id_In;
      
        Update 病人挂号汇总
        Set 已挂数 = Nvl(已挂数, 0) + 1, 其中已接收 = Nvl(其中已接收, 0) + Decode(预约标志_In, 0, 0, 1), 已约数 = Nvl(已约数, 0) + Nvl(n_预约数, 0)
        Where 日期 = Decode(预约标志_In, 2, Trunc(v_Date), Trunc(发生时间_In)) And Nvl(科室id, 0) = 执行部门id_In And
              Nvl(项目id, 0) = 收费细目id_In And Nvl(医生id, 0) = Nvl(医生id_In, 0) And Nvl(医生姓名, '-') = Nvl(医生姓名_In, '-') And
              (号码 = 号码_In Or 号码 Is Null);
        If Sql%RowCount = 0 Then
          Insert Into 病人挂号汇总
            (日期, 科室id, 项目id, 医生姓名, 医生id, 号码, 已挂数, 已约数, 其中已接收)
          Values
            (Decode(预约标志_In, 2, Trunc(v_Date), Trunc(发生时间_In)), 执行部门id_In, 收费细目id_In, 医生姓名_In,
             Decode(医生id_In, 0, Null, 医生id_In), 号码_In, 1, Nvl(n_预约数, 0), Decode(预约标志_In, 0, 0, 1));
        End If;
      End If;
    Else
      --预约挂号
      Update 临床出诊记录 Set 已约数 = Nvl(已约数, 0) + 1 Where ID = 出诊记录id_In;
      Update 病人挂号汇总
      Set 已约数 = Nvl(已约数, 0) + 1
      Where 日期 = Trunc(v_Date) And Nvl(医生id, 0) = Nvl(医生id_In, 0) And Nvl(医生姓名, '-') = Nvl(医生姓名_In, '-') And
            Nvl(科室id, 0) = 执行部门id_In And Nvl(项目id, 0) = 收费细目id_In And (号码 = 号码_In Or 号码 Is Null);
    
      If Sql%RowCount = 0 Then
        Insert Into 病人挂号汇总
          (日期, 科室id, 项目id, 医生姓名, 医生id, 号码, 已约数)
        Values
          (Trunc(v_Date), 执行部门id_In, 收费细目id_In, 医生姓名_In, Decode(医生id_In, 0, Null, 医生id_In), 号码_In, 1);
      End If;
    End If;
  End If;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_病人挂号汇总_Update;
/

--96742:董露露,2017-09-19,解决外国人身份证号录入的问题
CREATE OR REPLACE Procedure Zl_住院病案主页_Update
(
  病人id_In     病案主页.病人id%Type,
  主页id_In     病案主页.主页id%Type,
  年龄_In       病案主页.年龄%Type,
  费别_In       病案主页.费别%Type,
  婚姻状况_In   病案主页.婚姻状况%Type,
  学历_In       病案主页.学历%Type,
  职业_In       病案主页.职业%Type,
  当前病况_In   病案主页.当前病况%Type,
  单位地址_In   病案主页.单位地址%Type,
  合同单位id_In 病人信息.合同单位id%Type,
  单位电话_In   病案主页.单位电话%Type,
  单位邮编_In   病案主页.单位邮编%Type,
  家庭地址_In   病案主页.家庭地址%Type,
  家庭电话_In   病案主页.家庭电话%Type,
  家庭地址邮编_In   病案主页.家庭地址邮编%Type,
  户口地址_In   病案主页.户口地址%Type,
  户口地址邮编_In   病案主页.户口地址邮编%Type,
  联系人姓名_In 病案主页.联系人姓名%Type,
  联系人关系_In 病案主页.联系人关系%Type,
  联系人电话_In 病案主页.联系人电话%Type,
  联系人地址_In 病案主页.联系人地址%Type,
  责任护士_In   病案主页.责任护士%Type,
  门诊医师_In   病案主页.门诊医师%Type,
  住院医师_In   病案主页.住院医师%Type,
  疾病id_In     病人诊断记录.疾病id%Type,
  诊断id_In     病人诊断记录.诊断id%Type,
  入院诊断_In   病人诊断记录.诊断描述%Type,
  中医疾病id_In 病人诊断记录.疾病id%Type,
  中医诊断id_In 病人诊断记录.诊断id%Type,
  中医诊断_In   病人诊断记录.诊断描述%Type,
  操作员编号_In 病案主页.编目员编号%Type,
  操作员姓名_In 病案主页.编目员姓名%Type,
  主治医师_In   病案主页.住院医师%Type,
  主任医师_In   病案主页.住院医师%Type,
  再入院_In     病案主页.再入院%Type,
  身份证号_In   病人信息.身份证号%Type,
  出生地点_In   病人信息.出生地点%Type,
  籍贯_In       病人信息.籍贯%Type,
  区域_In       病人信息.区域%Type,
  入院属性_In   病案主页.入院属性%Type := Null,
  病人类型_In   病案主页.病人类型%Type := Null,
  入院方式_In   病案主页.入院方式%Type := Null,
  备注_In       病案主页.备注%Type := Null,
  是否陪伴_In   病案主页.是否陪伴%Type := Null,
  联系人身份证号_In 病案主页.联系人身份证号%Type := Null,
  国籍_In       病人信息.国籍%Type:=Null
) As
  v_责任护士 病案主页.责任护士%Type;
  v_住院医师 病案主页.住院医师%Type;
  v_主治医师 病案主页.住院医师%Type;
  v_主任医师 病案主页.住院医师%Type;
  v_病人性质 病案主页.病人性质%Type;
  v_当前病况 病案主页.当前病况%Type;
  v_原因     病人变动记录.开始原因%Type;
  v_出院科室 病案主页.出院科室id%Type;
  v_终止原因 病人变动记录.终止原因%Type;
  v_终止时间 病人变动记录.终止时间%Type;
  v_终止人员 病人变动记录.终止人员%Type;
  v_Count    Number;
  v_Curdate  Date;
  v_Error    Varchar2(255);
  Err_Custom Exception;
  Cursor c_Oldinfo Is
        Select b.*
    From (Select c.*
           From 病人变动记录 C
           Where c.病人id = 病人id_In And c.主页id = 主页id_In And
                 c.开始时间 = (Select Min(开始时间) From 病人变动记录 Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间 > v_Curdate)) A, 病人变动记录 B
    Where b.病人id = 病人id_In And b.主页id = 主页id_In And a.开始时间 = b.终止时间 And a.开始原因 = b.终止原因 And a.附加床位 = b.附加床位
    Union
    Select * From 病人变动记录 Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null And 开始时间 <= v_Curdate;

  Cursor c_Endinfo Is
    Select * From 病人变动记录 Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null;
  r_Oldinfo c_Oldinfo%RowType;
  r_Endinfo c_Endinfo%RowType;
Begin
  --取更改前的内容(用NoneData和新的比较)
  Select 病人性质, Nvl(责任护士, 'NoneData'), Nvl(住院医师, 'NoneData'), Nvl(当前病况, 'NoneData'), Nvl(出院科室id, 入院科室id)
  Into v_病人性质, v_责任护士, v_住院医师, v_当前病况, v_出院科室
  From 病案主页
  Where 病人id = 病人id_In And 主页id = 主页id_In;
  Begin
    Select Nvl(信息值, 'NoneData')
    Into v_主治医师
    From 病案主页从表
    Where 病人id = 病人id_In And 主页id = 主页id_In And 信息名 = '主治医师';
  Exception
    When Others Then
      v_主治医师 := 'NoneData';
  End;
  Begin
    Select Nvl(信息值, 'NoneData')
    Into v_主任医师
    From 病案主页从表
    Where 病人id = 病人id_In And 主页id = 主页id_In And 信息名 = '主任医师';
  Exception
    When Others Then
      v_主任医师 := 'NoneData';
  End;

  Update 病案主页
  Set 年龄 = 年龄_In, 费别 = 费别_In, 婚姻状况 = 婚姻状况_In, 国籍=国籍_In,学历 = 学历_In, 当前病况 = 当前病况_In, 职业 = 职业_In, 单位地址 = 单位地址_In, 单位电话 = 单位电话_In,
      单位邮编 = 单位邮编_In, 家庭地址 = 家庭地址_In, 家庭电话 = 家庭电话_In, 家庭地址邮编 = 家庭地址邮编_In, 户口地址 = 户口地址_In, 户口地址邮编 = 户口地址邮编_In,
      联系人姓名 = 联系人姓名_In, 联系人关系 = 联系人关系_In, 联系人身份证号 = 联系人身份证号_In,
      联系人地址 = 联系人地址_In, 联系人电话 = 联系人电话_In, 责任护士 = 责任护士_In, 门诊医师 = 门诊医师_In, 住院医师 = 住院医师_In, 编目员编号 = 操作员编号_In,
      编目员姓名 = 操作员姓名_In, 再入院 = 再入院_In, 入院属性 = 入院属性_In, 病人类型 = 病人类型_In, 入院方式 = 入院方式_In, 备注 = 备注_In,是否陪伴 =是否陪伴_In
  Where 病人id = 病人id_In And 主页id = 主页id_In;

  --仅修改住院费别,除非是门诊留观病人
  Update 病人信息
  Set 年龄 = 年龄_In, 费别 = Decode(v_病人性质, 1, 费别_In, 费别), 婚姻状况 = 婚姻状况_In, 国籍=国籍_In, 学历 = 学历_In, 职业 = 职业_In, 工作单位 = 单位地址_In,
      合同单位id = Decode(合同单位id_In, 0, 合同单位id, 合同单位id_In), 单位电话 = 单位电话_In, 单位邮编 = 单位邮编_In, 家庭地址 = 家庭地址_In, 家庭电话 = 家庭电话_In,
      家庭地址邮编 = 家庭地址邮编_In, 户口地址 = 户口地址_In, 户口地址邮编 = 户口地址邮编_In,
      联系人姓名 = 联系人姓名_In, 联系人关系 = 联系人关系_In, 联系人地址 = 联系人地址_In, 联系人电话 = 联系人电话_In, 身份证号 = 身份证号_In,
      出生地点 = 出生地点_In, 籍贯 = 籍贯_In, 区域 = 区域_In, 联系人身份证号 = 联系人身份证号_In
  Where 病人id = 病人id_In;

  --产生变动记录
  If v_住院医师 <> 住院医师_In Or v_责任护士 <> 责任护士_In Or v_主治医师 <> 主治医师_In Or v_主任医师 <> 主任医师_In Or v_当前病况 <> 当前病况_In Then
    Select Sysdate Into v_Curdate From Dual;
    Open c_Oldinfo;
    Fetch c_Oldinfo
      Into r_Oldinfo;
    Open c_Endinfo;
    Fetch c_Endinfo
      Into r_Endinfo;
    If c_Endinfo%RowCount = 0 Then
      Close c_Endinfo;
      v_Error := '未发现该病人当前有效的变动记录！';
      Raise Err_Custom;
    End If;
    Select Count(*) Into v_count From 病人变动记录 Where 病人ID=病人ID_in And 主页ID=主页id_In And 开始时间 Is null And 终止时间 Is Null;
    If v_count > 0 Then
      v_Error := '该病人正在转科或转病区，不能进行其他变动！';
      Raise Err_Custom;
    End If;

    --如果终止时间<>NULL ，就记录下终止时间和终止原因。
    If r_Oldinfo.终止时间 Is not NULL then
      v_终止时间:=r_Oldinfo.终止时间;
      v_终止原因:=r_Oldinfo.终止原因;
      v_终止人员:=r_Oldinfo.终止人员;
    End IF;

    If v_住院医师 <> 住院医师_In Then
      v_原因 := 7;
      If v_终止时间 Is NULL then
        Update 病人变动记录
        Set 终止时间 = v_Curdate, 终止原因 = v_原因,终止人员 = 操作员姓名_In
        Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null;
      Else
        Update 病人变动记录
        Set 终止时间 = v_Curdate, 终止原因 = v_原因,终止人员 = 操作员姓名_In,上次计算时间 = Null
        Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 = v_终止时间 And 终止原因=v_终止原因;
        --更新将来的记录，如果有停止到将来的则删除上次计算时间
        Update 病人变动记录 Set 经治医师=住院医师_In,上次计算时间 = Null Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间>v_Curdate;
      End If;

      --产生病历书写时机
      ZL_电子病历时机_Insert(病人id_In, 主页id_In, 2, '交班', r_Oldinfo.科室id, 住院医师_In, v_Curdate, v_Curdate);

      While c_Oldinfo%Found Loop
        --注意:有附加床位时有多条记录
        Insert Into 病人变动记录
          (ID, 病人id, 主页id, 开始时间, 开始原因, 附加床位, 病区id, 科室id, 医疗小组id, 护理等级id, 床位等级id, 床号, 责任护士, 经治医师, 主治医师, 主任医师, 病情, 操作员编号, 操作员姓名,终止时间,终止原因,终止人员)
        Values
          (病人变动记录_Id.Nextval, 病人id_In, 主页id_In, v_Curdate, v_原因, r_Oldinfo.附加床位, r_Oldinfo.病区id, r_Oldinfo.科室id, r_Oldinfo.医疗小组id,
           r_Oldinfo.护理等级id, r_Oldinfo.床位等级id, r_Oldinfo.床号, r_Oldinfo.责任护士, 住院医师_In, r_Oldinfo.主治医师, r_Oldinfo.主任医师,
           r_Oldinfo.病情, 操作员编号_In, 操作员姓名_In,v_终止时间,v_终止原因,v_终止人员);
        Fetch c_Oldinfo
          Into r_Oldinfo;
      End Loop;
      --如果存在停止到将来的变动就更新终止原因
      If v_终止时间 Is Not Null then
        v_终止原因:=v_原因;
        v_终止时间:=v_Curdate;
        v_终止人员:=操作员姓名_In;
      End If;
      Close c_Oldinfo;
      Open c_Oldinfo; --重新打开,以便取最新信息
      Fetch c_Oldinfo
        Into r_Oldinfo;
    End If;

    If v_责任护士 <> 责任护士_In Then
      v_原因 := 8;
      If v_终止时间 Is NULL then
        Update 病人变动记录
        Set 终止时间 = v_Curdate, 终止原因 = v_原因,终止人员 = 操作员姓名_In
        Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null;
       Else
        Update 病人变动记录
        Set 终止时间 = v_Curdate, 终止原因 = v_原因,终止人员 = 操作员姓名_In,上次计算时间 = Null
        Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 = v_终止时间 And 终止原因=v_终止原因;
        --更新将来的记录，如果有停止到将来的则删除上次计算时间
        Update 病人变动记录 Set 责任护士=责任护士_In,上次计算时间 = Null Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间>v_Curdate;
      End If;
      While c_Oldinfo%Found Loop
        Insert Into 病人变动记录
          (ID, 病人id, 主页id, 开始时间, 开始原因, 附加床位, 病区id, 科室id, 医疗小组id, 护理等级id, 床位等级id, 床号, 责任护士, 经治医师, 主治医师, 主任医师, 病情, 操作员编号, 操作员姓名,终止时间,终止原因,终止人员)
        Values
          (病人变动记录_Id.Nextval, 病人id_In, 主页id_In, v_Curdate, v_原因, r_Oldinfo.附加床位, r_Oldinfo.病区id, r_Oldinfo.科室id, r_Oldinfo.医疗小组id,
           r_Oldinfo.护理等级id, r_Oldinfo.床位等级id, r_Oldinfo.床号, 责任护士_In, r_Oldinfo.经治医师, r_Oldinfo.主治医师, r_Oldinfo.主任医师,
           r_Oldinfo.病情, 操作员编号_In, 操作员姓名_In,v_终止时间,v_终止原因,v_终止人员);
        Fetch c_Oldinfo
          Into r_Oldinfo;
      End Loop;
      --如果存在停止到将来的变动就更新终止原因
      If v_终止时间 Is Not Null then
        v_终止原因:=v_原因;
        v_终止时间:=v_Curdate;
        v_终止人员:=操作员姓名_In;
      End If;
      Close c_Oldinfo;
      Open c_Oldinfo;
      Fetch c_Oldinfo
        Into r_Oldinfo;
    End If;

    If v_主治医师 <> 主治医师_In Then
      Update 病案主页从表
      Set 信息值 = 主治医师_In
      Where 病人id = 病人id_In And 主页id = 主页id_In And 信息名 = '主治医师';
      If Sql%RowCount = 0 Then
        Insert Into 病案主页从表
          (病人id, 主页id, 信息名, 信息值)
        Values
          (病人id_In, 主页id_In, '主治医师', 主治医师_In);
      End If;

      v_原因 := 11;
      If v_终止时间 Is NULL then
        Update 病人变动记录
        Set 终止时间 = v_Curdate, 终止原因 = v_原因,终止人员 = 操作员姓名_In
        Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null;
      Else
        Update 病人变动记录
        Set 终止时间 = v_Curdate, 终止原因 = v_原因,终止人员 = 操作员姓名_In,上次计算时间 = Null
        Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 = v_终止时间 And 终止原因=v_终止原因;
        --更新将来的记录，如果有停止到将来的则删除上次计算时间
        Update 病人变动记录 Set 主治医师=主治医师_In,上次计算时间 = Null Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间>v_Curdate;
      End If;
      While c_Oldinfo%Found Loop
        Insert Into 病人变动记录
          (ID, 病人id, 主页id, 开始时间, 开始原因, 附加床位, 病区id, 科室id, 医疗小组id, 护理等级id, 床位等级id, 床号, 责任护士, 经治医师, 主治医师, 主任医师, 病情, 操作员编号, 操作员姓名,终止时间,终止原因,终止人员)
        Values
          (病人变动记录_Id.Nextval, 病人id_In, 主页id_In, v_Curdate, v_原因, r_Oldinfo.附加床位, r_Oldinfo.病区id, r_Oldinfo.科室id, r_Oldinfo.医疗小组id,
           r_Oldinfo.护理等级id, r_Oldinfo.床位等级id, r_Oldinfo.床号, r_Oldinfo.责任护士, r_Oldinfo.经治医师, 主治医师_In, r_Oldinfo.主任医师,
           r_Oldinfo.病情, 操作员编号_In, 操作员姓名_In,v_终止时间,v_终止原因,v_终止人员);
        Fetch c_Oldinfo
          Into r_Oldinfo;
      End Loop;
      --如果存在停止到将来的变动就更新终止原因
      If v_终止时间 Is Not Null then
        v_终止原因:=v_原因;
        v_终止时间:=v_Curdate;
        v_终止人员:=操作员姓名_In;
      End If;
      Close c_Oldinfo;
      Open c_Oldinfo;
      Fetch c_Oldinfo
        Into r_Oldinfo;
    End If;

    If v_主任医师 <> 主任医师_In Then
      Update 病案主页从表
      Set 信息值 = 主任医师_In
      Where 病人id = 病人id_In And 主页id = 主页id_In And 信息名 = '主任医师';
      If Sql%RowCount = 0 Then
        Insert Into 病案主页从表
          (病人id, 主页id, 信息名, 信息值)
        Values
          (病人id_In, 主页id_In, '主任医师', 主任医师_In);
      End If;

      v_原因 := 12;
      If v_终止时间 Is NULL then
        Update 病人变动记录
        Set 终止时间 = v_Curdate, 终止原因 = v_原因,终止人员 = 操作员姓名_In
        Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null;
      Else
        Update 病人变动记录
        Set 终止时间 = v_Curdate, 终止原因 = v_原因,终止人员 = 操作员姓名_In,上次计算时间 = Null
        Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 = v_终止时间 And 终止原因=v_终止原因;
        --更新将来的记录，如果有停止到将来的则删除上次计算时间
        Update 病人变动记录 Set 主任医师=主任医师_In,上次计算时间 = Null Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间>v_Curdate;
      End If;
      While c_Oldinfo%Found Loop
        Insert Into 病人变动记录
          (ID, 病人id, 主页id, 开始时间, 开始原因, 附加床位, 病区id, 科室id, 医疗小组id, 护理等级id, 床位等级id, 床号, 责任护士, 经治医师, 主治医师, 主任医师, 病情, 操作员编号, 操作员姓名,终止时间,终止原因,终止人员)
        Values
          (病人变动记录_Id.Nextval, 病人id_In, 主页id_In, v_Curdate, v_原因, r_Oldinfo.附加床位, r_Oldinfo.病区id, r_Oldinfo.科室id, r_Oldinfo.医疗小组id,
           r_Oldinfo.护理等级id, r_Oldinfo.床位等级id, r_Oldinfo.床号, r_Oldinfo.责任护士, r_Oldinfo.经治医师, r_Oldinfo.主治医师, 主任医师_In,
           r_Oldinfo.病情, 操作员编号_In, 操作员姓名_In,v_终止时间,v_终止原因,v_终止人员);
        Fetch c_Oldinfo
          Into r_Oldinfo;
      End Loop;
      --如果存在停止到将来的变动就更新终止原因
      If v_终止时间 Is Not Null then
        v_终止原因:=v_原因;
        v_终止时间:=v_Curdate;
        v_终止人员:=操作员姓名_In;
      End If;
      Close c_Oldinfo;
      Open c_Oldinfo;
      Fetch c_Oldinfo
        Into r_Oldinfo;
    End If;

    If v_当前病况 <> 当前病况_In Then
      v_原因 := 13;
      If v_终止时间 Is NULL then
        Update 病人变动记录
        Set 终止时间 = v_Curdate, 终止原因 = v_原因,终止人员 = 操作员姓名_In
        Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 Is Null;
      Else
        Update 病人变动记录
        Set 终止时间 = v_Curdate, 终止原因 = v_原因,终止人员 = 操作员姓名_In,上次计算时间 = Null
        Where 病人id = 病人id_In And 主页id = 主页id_In And 终止时间 = v_终止时间 And 终止原因=v_终止原因;
        --更新将来的记录，如果有停止到将来的则删除上次计算时间
        Update 病人变动记录 Set 病情=当前病况_In,上次计算时间 = Null Where 病人id = 病人id_In And 主页id = 主页id_In And 开始时间>v_Curdate;
      End If;
      While c_Oldinfo%Found Loop
        Insert Into 病人变动记录
          (ID, 病人id, 主页id, 开始时间, 开始原因, 附加床位, 病区id, 科室id, 医疗小组id, 护理等级id, 床位等级id, 床号, 责任护士, 经治医师, 主治医师, 主任医师, 病情, 操作员编号, 操作员姓名,终止时间,终止原因,终止人员)
        Values
          (病人变动记录_Id.Nextval, 病人id_In, 主页id_In, v_Curdate, v_原因, r_Oldinfo.附加床位, r_Oldinfo.病区id, r_Oldinfo.科室id, r_Oldinfo.医疗小组id,
           r_Oldinfo.护理等级id, r_Oldinfo.床位等级id, r_Oldinfo.床号, r_Oldinfo.责任护士, r_Oldinfo.经治医师, r_Oldinfo.主治医师,
           r_Oldinfo.主任医师,当前病况_In, 操作员编号_In, 操作员姓名_In,v_终止时间,v_终止原因,v_终止人员);
        Fetch c_Oldinfo
          Into r_Oldinfo;
      End Loop;
      Close c_Oldinfo;
      Open c_Oldinfo;
      Fetch c_Oldinfo
        Into r_Oldinfo;
    End If;
    Close c_Oldinfo;
    Close c_Endinfo;
  End If;

  --处理入院诊断
  If 入院诊断_In Is Null And 疾病id_In Is Null Then
    Delete From 病人诊断记录 Where 病人id = 病人id_In And 主页id = 主页id_In And 诊断类型 = 2 And 记录来源 = 2;
  Else
    Update 病人诊断记录
    Set 疾病id = 疾病id_In, 诊断id = 诊断id_In, 诊断描述 = 入院诊断_In, 记录日期 = Sysdate, 记录人 = 操作员姓名_In
    Where 病人id = 病人id_In And 主页id = 主页id_In And 诊断类型 = 2 And 记录来源 = 2;
    If Sql%RowCount = 0 Then
      Insert Into 病人诊断记录
        (ID, 病人id, 主页id, 记录来源, 诊断类型, 诊断次序, 疾病id, 诊断id, 诊断描述, 记录日期, 记录人)
      Values
        (病人诊断记录_Id.Nextval, 病人id_In, 主页id_In, 2, 2, 1, 疾病id_In, 诊断id_In, 入院诊断_In, Sysdate, 操作员姓名_In);
    End If;
  End If;

  --处理中医入院诊断
  If 中医诊断_In Is Null And 中医疾病id_In Is Null Then
    Delete From 病人诊断记录 Where 病人id = 病人id_In And 主页id = 主页id_In And 诊断类型 = 12 And 记录来源 = 2;
  Else
    Update 病人诊断记录
    Set 疾病id = 中医疾病id_In, 诊断id = 中医诊断id_In, 诊断描述 = 中医诊断_In, 记录日期 = Sysdate, 记录人 = 操作员姓名_In
    Where 病人id = 病人id_In And 主页id = 主页id_In And 诊断类型 = 12 And 记录来源 = 2;
    If Sql%RowCount = 0 Then
      Insert Into 病人诊断记录
        (ID, 病人id, 主页id, 记录来源, 诊断类型, 诊断次序, 疾病id, 诊断id, 诊断描述, 记录日期, 记录人)
      Values
        (病人诊断记录_Id.Nextval, 病人id_In, 主页id_In, 2, 12, 1, 中医疾病id_In, 中医诊断id_In, 中医诊断_In, Sysdate, 操作员姓名_In);
    End If;
  End If;

  If (入院诊断_In Is Not Null Or 疾病id_In Is Not Null) Or (中医诊断_In Is Not Null Or 中医疾病id_In Is Not Null) Then
     --产生病历书写时机
     ZL_电子病历时机_Insert(病人id_In, 主页id_In, 2, '诊断', v_出院科室, 住院医师_In, Sysdate, Sysdate);
  End If;

  Select Count(*)
  Into v_Count
  From 病人变动记录
  Where 病人id = 病人id_In And 主页id = 主页id_In And Nvl(附加床位, 0) = 0 And 开始时间 Is Not Null And 终止时间 Is Null;
  If v_Count > 1 Then
    v_Error := '发现病人存在非法的变动记录,当前操作不能继续！' || Chr(13) || Chr(10) || '这可能是由于网络并发操作引起的,请刷新病人状态后再试！';
    Raise Err_Custom;
  End If;

Exception

  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_住院病案主页_Update;
/

--113742:秦龙,2017-09-19,增加传参“别名”
Create Or Replace Procedure Zl_部门表_Update
(
  Id_In       In 部门表.Id%Type,
  上级id_In   In 部门表.上级id%Type,
  编码_In     In 部门表.编码%Type,
  名称_In     In 部门表.名称%Type,
  简码_In     In 部门表.简码%Type,
  位置_In     In 部门表.位置%Type,
  原长度_In   In Number,
  部门性质_In In Varchar2,
  临床性质_In In Varchar2, --部门性质_IN参数的填写方式如下："临床:3:护理:3:产科:0:" 
  环境类别_In In 部门表.环境类别%Type := Null,
  负责人_In   In 部门表.部门负责人%Type := Null,
  站点_In     In 部门表.站点%Type := Null,
  顺序_In     In 部门表.顺序%Type := Null,
  别名_In     In 部门表.别名%Type := Null
) Is
  Intpos  Pls_Integer;
  Int对象 Number(1);
  Strtemp Varchar2(2000);
  Str性质 Varchar2(20);
Begin
  --首先插入修改记录 
  Update 部门表
  Set 上级id = 上级id_In, 编码 = 编码_In, 名称 = 名称_In, 简码 = 简码_In, 位置 = 位置_In, 站点 = 站点_In, 环境类别 = 环境类别_In, 部门负责人 = 负责人_In,
      撤档时间 = To_Date('3000-1-1', 'yyyy-mm-dd'), 顺序 = 顺序_In, 最后修改时间 = Sysdate, 别名 = 别名_In
  Where ID = Id_In;

  --对它的下级也要修改编码 
  Update 部门表
  Set 编码 = 编码_In || Substr(编码, 原长度_In)
  Where ID In (Select ID From 部门表 Start With 上级id = Id_In Connect By Prior ID = 上级id);

  --接着删除已有的性质说明 
  Delete From 部门性质说明 Where 部门id = Id_In;

  --接着修改部门性质说明 
  Strtemp := 部门性质_In;

  While Strtemp Is Not Null Loop
    Intpos := Instr(Strtemp, ':');
  
    If Intpos = 0 Then
      Str性质 := '';
    Else
      --得到工作性质 
      Str性质 := Substr(Strtemp, 1, Intpos - 1);
      Strtemp := Substr(Strtemp, Intpos + 1);
      --得到服务对象 
      Intpos  := Instr(Strtemp, ':');
      Int对象 := To_Number(Substr(Strtemp, 1, Intpos - 1));
      Strtemp := Substr(Strtemp, Intpos + 1);
    
      Insert Into 部门性质说明 (工作性质, 服务对象, 部门id) Values (Str性质, Int对象, Id_In);
    End If;
  End Loop;

  --删除可能有的临床性质 
  Delete From 临床部门 Where 部门id = Id_In;

  If 临床性质_In Is Not Null Then
    Insert Into 临床部门 (工作性质, 部门id) Values (临床性质_In, Id_In);
  End If;

Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_部门表_Update;
/

--113742:秦龙,2017-09-19,增加传参“别名”
Create Or Replace Procedure Zl_部门表_Insert
(
  Id_In       In 部门表.Id%Type,
  上级id_In   In 部门表.上级id%Type,
  编码_In     In 部门表.编码%Type,
  名称_In     In 部门表.名称%Type,
  简码_In     In 部门表.简码%Type,
  位置_In     In 部门表.位置%Type,
  部门性质_In In Varchar2,
  临床性质_In In Varchar2, --部门性质_IN参数的填写方式如下： "临床:3:护理:3:产科:0:" 
  环境类别_In In 部门表.环境类别%Type := Null,
  站点_In     In 部门表.站点%Type := Null,
  顺序_In     In 部门表.顺序%Type := Null,
  别名_In     In 部门表.别名%Type := Null
) Is
  Intpos  Pls_Integer;
  Int对象 Number(1);
  Strtemp Varchar2(2000);
  Str性质 Varchar2(20);
Begin
  --首先插入记录 
  Insert Into 部门表
    (ID, 上级id, 编码, 名称, 简码, 位置, 建档时间, 撤档时间, 站点, 环境类别, 顺序, 最后修改时间, 别名)
  Values
    (Id_In, 上级id_In, 编码_In, 名称_In, 简码_In, 位置_In, Sysdate, To_Date('3000-01-01', 'yyyy-mm-dd'), 站点_In, 环境类别_In, 顺序_In,
     Sysdate, 别名_In);

  --接着修改部门性质说明 
  Strtemp := 部门性质_In;

  While Strtemp Is Not Null Loop
    Intpos := Instr(Strtemp, ':');
  
    If Intpos = 0 Then
      Str性质 := '';
    Else
      --得到工作性质 
      Str性质 := Substr(Strtemp, 1, Intpos - 1);
      Strtemp := Substr(Strtemp, Intpos + 1);
      --得到服务对象 
      Intpos  := Instr(Strtemp, ':');
      Int对象 := To_Number(Substr(Strtemp, 1, Intpos - 1));
      Strtemp := Substr(Strtemp, Intpos + 1);
    
      Insert Into 部门性质说明 (工作性质, 服务对象, 部门id) Values (Str性质, Int对象, Id_In);
    End If;
  End Loop;

  If 临床性质_In Is Not Null Then
    Insert Into 临床部门 (工作性质, 部门id) Values (临床性质_In, Id_In);
  End If;

Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_部门表_Insert;
/

--113591:刘尔旋,2017-09-18,自动计算医疗小组问题
Create Or Replace Procedure Zl1_Autocptone
(
  病人id_In   In Number,
  主页id_In   In Number,
  期间_In     In Varchar2,
  在院记帐_In In Number := 0,
  强制记帐_In In Number := 0
) As

  -------------------------------------------------------------------------
  --功能说明：完成指定病人指定期间自动计价项目表设置自动计算的项目进行记帐处理
  --          1、系统首先根据系统参数"修正上期自动计费"，修改以往该病人自动记帐记录标志;
  --          2、综合病人的床位变化、入出转情况、调价情况等多项因素，结合期间跨度、病人费
  --             别等完成费用的正确计算：
  --             如果发现已经计算，则修改标志为正常;如果未计算，则插入新的自动记帐记录;
  --             作废以前的错误计算的记录;
  --             统计本次变动(新增和作废)，填写余额表和汇总表;
  --入口参数：
  --       病人ID_IN  number    病人身份ID
  --       主页ID_IN  number    病案主页ID，两个参数共同确定需要计算的病人
  --       期间_IN  varchar2     需要计算的最小期间
  --       在院记帐_IN number   为1时,仅计算在院病人的费用
  --       强制记帐_IN number   为1时,不受病案主页.禁止自动记帐属性控制
  --调用关系：zl1_AutoCptPati/zl1_AutoCptWard/zl1_AutoCptAll 调用本过程

  Cursor v_Autocur
  (
    期间_In Varchar2,
    Insure  病案主页.险类%Type
  ) Is
    Select l.病人id, l.主页id, l.姓名, l.性别, l.年龄, l.住院号, l.费别, l.科室id, l.病区id, l.床号, l.附加床位, l.收费细目id, l.收入项目id, l.标志, l.标准单价,
           Greatest(l.开始日期, Trunc(p.开始日期)) As 开始日期, l.终止日期, l.天数, l.数量, l.经治医师, l.责任护士, l.操作员编号, l.操作员姓名, i.险类, i.大类id,
           k.算法, k.统筹比额, l.医疗小组id
    From (Select * From 出院病人自动记帐 Where 病人id = 病人id_In And 主页id = 主页id_In) L,
         (Select Min(开始日期) As 开始日期 From 期间表 Where 期间 >= 期间_In) P, 保险支付项目 I, 保险支付大类 K
    Where Trunc(l.终止日期) >= Trunc(p.开始日期) And l.收费细目id = i.收费细目id(+) And i.险类(+) = Insure And i.大类id = k.Id(+)
    Order By l.开始日期;

  Cursor v_Autocurzy
  (
    期间_In Varchar2,
    Insure  病案主页.险类%Type
  ) Is
    Select l.病人id, l.主页id, l.姓名, l.性别, l.年龄, l.住院号, l.费别, l.科室id, l.病区id, l.床号, l.附加床位, l.收费细目id, l.收入项目id, l.标志, l.标准单价,
           Greatest(l.开始日期, Trunc(p.开始日期)) As 开始日期, l.终止日期, l.天数, l.数量, l.经治医师, l.责任护士, l.操作员编号, l.操作员姓名, i.险类, i.大类id,
           k.算法, k.统筹比额, l.医疗小组id
    From (Select * From 在院病人自动记帐 Where 病人id = 病人id_In And 主页id = 主页id_In) L,
         (Select Min(开始日期) As 开始日期 From 期间表 Where 期间 >= 期间_In) P, 保险支付项目 I, 保险支付大类 K
    Where Trunc(l.终止日期) >= Trunc(p.开始日期) And l.收费细目id = i.收费细目id(+) And i.险类(+) = Insure And i.大类id = k.Id(+)
    Order By l.开始日期;

  n_Insure       病案主页.险类%Type;
  v_Billno       Varchar2(8); --费用表实际的自动记帐号码
  n_Datecount    Integer; --日期计数器
  d_Datefrom     Date; --开始计算日期
  d_Dateto       Date; --终止计算日期
  d_Datelast     Date;
  n_Billcount    Number(5) := 0; --单据序号计数器
  n_Exsetax      Number(16, 2) := 0; --费用收取比率
  n_Exsetax_Temp Number(16, 2) := 0; --费用收取比率
  n_Summoney     Number(16, 2) := 0; --金额

  Cursor v_Sumcur
  (
    Billno    Varchar2,
    Datestart Date
  ) Is
    Select 病人病区id, 病人科室id, 开单部门id, 执行部门id, 收入项目id, Sum(Decode(附加标志, 0, 1, -1) * 应收金额) As 应收金额,
           Sum(Decode(附加标志, 0, 1, -1) * 实收金额) As 实收金额
    From 住院费用记录
    Where 病人id = 病人id_In And 主页id = 主页id_In And 记录性质 = 3 And 记录状态 = 1 And
          (NO = Billno Or 附加标志 = 5 And 发生时间 >= Datestart)
    Group By 病人病区id, 病人科室id, 开单部门id, 执行部门id, 收入项目id;

  n_Dec            Number; --金额小数位数
  d_登记时间       Date; --登记时间
  d_发生时间       Date; --发生时间
  n_Dates          Number(3, 1); --当前记录的天数，全天为1
  n_Do             Number(1);
  n_返回值         病人余额.预交余额%Type;
  n_Delete         Number;
  n_医疗小组id     住院费用记录.医疗小组id%Type;
  n_护理计算标准   Number(2); --护理费计算标准
  n_收费细目id     Number(18);
  n_Temp           Number(18);
  l_护理id         t_Numlist := t_Numlist();
  l_护理等级       t_Numlist := t_Numlist();
  n_护理项目       Number(2); --1:是护理项目;0-非不护理
  n_价格           收费价目.现价%Type;
  n_护理已处理     Number(2); --1-护理费已经处理,;0-未处理
  n_收入项目id     Number(18);
  n_从属项目       Number(2);
  n_审核标志       病案主页.审核标志%Type;
  n_住院状态       病案主页.状态%Type;
  n_病人审核方式   Number(2);
  n_未入科禁止记账 Number(2);
  n_禁止自动记帐   Number(2);

  n_病人病区id 住院费用记录.病人病区id%Type;
  n_开单部门id 住院费用记录.开单部门id%Type;

  --已经计算了的护理类型
  Type t_护理_Rec Is Record(
    收费细目id 收费项目目录.Id%Type,
    日期       Date);
  Type t_护理 Is Table Of t_护理_Rec;
  c_护理 t_护理 := t_护理();

Begin
  Begin
    Select 险类, Nvl(审核标志, 0), Nvl(状态, 0), Nvl(是否禁止自动记帐, 0)
    Into n_Insure, n_审核标志, n_住院状态, n_禁止自动记帐
    From 病案主页
    Where 病人id = 病人id_In And 主页id = 主页id_In;
  Exception
    When Others Then
      Return;
  End;

  If 强制记帐_In = 0 And n_禁止自动记帐 = 1 Then
    Return;
  End If;

  n_病人审核方式   := Nvl(zl_GetSysParameter(185), 0);
  n_未入科禁止记账 := Nvl(zl_GetSysParameter(215), 0);
  If n_病人审核方式 = 1 And Nvl(n_审核标志, 0) >= 1 Then
    Return;
  End If;
  If n_未入科禁止记账 = 1 And n_住院状态 = 1 Then
    Return;
  End If;

  v_Billno := Nextno(17);

  --金额小数位数
  Select Zl_To_Number(Nvl(zl_GetSysParameter(9), '2')), Zl_To_Number(Nvl(zl_GetSysParameter(160), '0'))
  Into n_Dec, n_护理计算标准
  From Dual;

  --每天5点以前，将记录时间登记为昨天，否则登记为当时
  Select Decode(Sign(To_Number(To_Char(Sysdate, 'HH24')) - 5), -1, Trunc(Sysdate) - 1 / 24 / 60, Sysdate)
  Into d_登记时间
  From Dual;

  --锁定该病人的记录,以免重复计算
  Update 病案主页 Set 状态 = 状态 Where 病人id = 病人id_In And 主页id = 主页id_In;

  -----------------------------------------------------------------
  d_Datefrom := Sysdate + 1000;
  d_Dateto   := Sysdate - 1000;
  n_Do       := 0;
  --------------------------------------------------------------------
  If n_护理计算标准 = 1 Then
    --同天以最高价位的护理费为准,先将其护理等级记住,
    For v_护理 In (Select Distinct 护理等级id
                 From (Select 护理等级id
                        From 病人变动记录
                        Where 开始原因 <> 10 And 病人id = 病人id_In And 主页id = 主页id_In
                        Union All
                        Select i.从项id As 护理等级id
                        From 病人变动记录 B, 收费从属项目 I
                        Where b.护理等级id = i.主项id And 病人id = 病人id_In And 主页id = 主页id_In And b.开始原因 <> 10 And i.固有从属 > 0)) Loop
      If Nvl(v_护理.护理等级id, 0) <> 0 Then
        l_护理id.Extend;
        l_护理id(l_护理id.Count) := v_护理.护理等级id;
      End If;
    End Loop;
  End If;
  -----------------------------------------------------------------
  --循环检查计算情况，并增加正确和新计算的记录
  -----------------------------------------------------------------
  If 在院记帐_In = 1 Then
    For v_Currrow In v_Autocurzy(期间_In, n_Insure) Loop
    
      If v_Currrow.医疗小组id Is Null Then
        n_医疗小组id := Zl_医疗小组_Get(v_Currrow.科室id, v_Currrow.操作员姓名, v_Currrow.病人id, v_Currrow.主页id, d_发生时间);
      Else
        n_医疗小组id := v_Currrow.医疗小组id;
      End If;
    
      If d_Datefrom > v_Currrow.开始日期 Then
        d_Datefrom := v_Currrow.开始日期;
        n_Do       := 1;
        --将本次开始计算时间以后的已计算记录标志修改
        Update 住院费用记录
        Set 附加标志 = 5
        Where 病人id = 病人id_In And 主页id = 主页id_In And 记录性质 = 3 And 记录状态 = 1 And 附加标志 <> 8 And Nvl(医嘱序号, 0) = 0 And
              发生时间 >= v_Currrow.开始日期;
      End If;
    
      If d_Dateto < v_Currrow.终止日期 Then
        d_Dateto := v_Currrow.终止日期;
      End If;
      n_收费细目id := v_Currrow.收费细目id;
      n_护理项目   := 0;
      --护理费计算标准:0-按最后一次护理计算;1-按价格最高的护理等级计算。
      If n_护理计算标准 = 1 Then
        --先确定是否护理项目,如果是,则需要重新进行计算
        Select Count(*) Into n_护理项目 From Table(l_护理id) Where Column_Value = n_收费细目id;
      End If;
    
      --提取当前收入项目的收费比率
      Begin
        Select 实收比率
        Into n_Exsetax
        From (Select 实收比率
               From 费别明细
               Where 费别 = v_Currrow.费别 And 收费细目id = v_Currrow.收费细目id And
                     (Abs(v_Currrow.标准单价 * v_Currrow.数量) Between 应收段首值 And 应收段尾值)
               Union All
               Select 实收比率
               From 费别明细
               Where 费别 = v_Currrow.费别 And 收入项目id = v_Currrow.收入项目id And
                     (Abs(v_Currrow.标准单价 * v_Currrow.数量) Between 应收段首值 And 应收段尾值) And Not Exists
                (Select 1 From 费别明细 Where 费别 = v_Currrow.费别 And 收费细目id = v_Currrow.收费细目id));
      Exception
        When Others Then
          n_Exsetax := 100.00;
      End;
    
      n_Exsetax := Nvl(n_Exsetax, 100);
      For n_Datecount In 0 .. (Trunc(v_Currrow.终止日期 + 0.5) - Trunc(v_Currrow.开始日期)) - 1 Loop
        d_发生时间   := Greatest(v_Currrow.开始日期, Trunc(v_Currrow.开始日期 + n_Datecount));
        n_Dates      := Least(Trunc(v_Currrow.开始日期 + n_Datecount + 1), v_Currrow.终止日期) -
                        Greatest(v_Currrow.开始日期, Trunc(v_Currrow.开始日期 + n_Datecount));
        n_护理已处理 := 0;
        If n_护理项目 = 1 Then
          --1.先检查当天是否存在护理变动,只有存在多个护理变动的,才会去处理(以主项目为准)
          n_从属项目 := 1;
          If l_护理等级.Count > 0 Then
            l_护理等级.Delete;
          End If;
          For v_护理 In (Select Distinct 护理等级id
                       From 病人变动记录
                       Where 开始原因 <> 10 And 病人id = 病人id_In And 主页id = 主页id_In And
                             (Trunc(开始时间) = Trunc(d_发生时间) Or Trunc(Nvl(终止时间, Sysdate)) = Trunc(d_发生时间))) Loop
            If Nvl(v_护理.护理等级id, 0) <> 0 Then
              l_护理等级.Extend;
              l_护理等级(l_护理等级.Count) := v_护理.护理等级id;
              If Nvl(v_护理.护理等级id, 0) = Nvl(v_Currrow.收费细目id, 0) Then
                n_从属项目 := 0;
              End If;
            End If;
          End Loop;
          If l_护理等级.Count > 1 Then
            --2. 存在两个以上变动,则取价位最高的
            n_Temp       := v_Currrow.收费细目id;
            n_价格       := Nvl(v_Currrow.标准单价, 0);
            n_收入项目id := v_Currrow.收入项目id;
            --本身是从属项目时,由于主项目计算时,已经计算了的,所以就不再计算
            If Nvl(n_从属项目, 0) = 1 Then
              n_护理已处理 := 1;
            End If;
            --因为可能存在多个收入项目,但收费细目相同的情况,因此,必须先检查该项目是否已经参与计算过的
            For I In 1 .. c_护理.Count Loop
              If c_护理(I).收费细目id = v_Currrow.收费细目id And c_护理(I).日期 = Trunc(d_发生时间) Then
                n_护理已处理 := 1;
                Exit;
              End If;
            End Loop;
            If Nvl(n_护理已处理, 0) = 0 Then
              c_护理.Extend;
              c_护理(c_护理.Count).收费细目id := v_Currrow.收费细目id;
              c_护理(c_护理.Count).日期 := Trunc(d_发生时间);
            End If;
            If Nvl(n_从属项目, 0) = 0 And Nvl(n_护理已处理, 0) = 0 Then
              --3.处理最高价位
              For v_价位 In (Select /*+ rule */
                            a.Column_Value As 收费细目id, p.现价, p.收入项目id
                           From Table(l_护理等级) A, 收费价目 P, 收费项目目录 C
                           Where a.Column_Value = p.收费细目id And a.Column_Value = c.Id And d_发生时间 Between p.执行日期 And
                                 Nvl(p.终止日期, Sysdate) And Nvl(c.计算方式, 0) <> 1) Loop
                If Nvl(v_价位.现价, 0) > n_价格 Then
                  n_价格       := Nvl(v_价位.现价, 0);
                  n_Temp       := v_价位.收费细目id;
                  n_收入项目id := v_价位.收入项目id;
                End If;
              End Loop;
            
              If n_Temp <> v_Currrow.收费细目id And Nvl(n_护理已处理, 0) = 0 Then
              
                n_开单部门id := v_Currrow.科室id;
                n_病人病区id := v_Currrow.病区id;
              
                For c_变动记录 In (Select 病区id, 科室id
                               From 病人变动记录
                               Where 开始原因 <> 10 And 病人id = 病人id_In And 主页id = 主页id_In And 护理等级id + 0 = n_Temp And
                                     (Trunc(开始时间) = Trunc(d_发生时间) Or Trunc(Nvl(终止时间, Sysdate)) = Trunc(d_发生时间))
                               Order By 开始时间 Desc) Loop
                  n_开单部门id := c_变动记录.科室id;
                  n_病人病区id := c_变动记录.病区id;
                  Exit;
                End Loop;
              
                --4. 不等的话,需要重新处理相关费用
                For v_费用 In (Select n_Temp As 收费细目id, v_Currrow.数量 As 数量, n_价格 As 单价, n_收入项目id As 收入项目id
                             From Dual
                             Union All
                             Select 从项id As 收费细目id, a.从项数次 As 数量, p.现价 As 单价, p.收入项目id
                             From 收费从属项目 A, 收费价目 P, 收费项目目录 C
                             Where a.从项id = p.收费细目id And a.从项id = c.Id And Nvl(c.计算方式, 0) <> 1 And a.主项id = n_Temp And
                                   d_发生时间 Between p.执行日期 And Nvl(p.终止日期, Sysdate)) Loop
                  --确定比例
                  Begin
                    Select 实收比率
                    Into n_Exsetax_Temp
                    From (Select 实收比率
                           From 费别明细
                           Where 费别 = v_Currrow.费别 And 收费细目id = v_费用.收费细目id And
                                 (Abs(v_费用.单价 * v_费用.数量) Between 应收段首值 And 应收段尾值)
                           Union All
                           Select 实收比率
                           From 费别明细
                           Where 费别 = v_Currrow.费别 And 收入项目id = v_费用.收入项目id And
                                 (Abs(v_费用.单价 * v_费用.数量) Between 应收段首值 And 应收段尾值) And Not Exists
                            (Select 1 From 费别明细 Where 费别 = v_Currrow.费别 And 收费细目id = v_费用.收费细目id));
                  Exception
                    When Others Then
                      n_Exsetax_Temp := 100.00;
                  End;
                  n_Exsetax_Temp := Nvl(n_Exsetax_Temp, 100);
                  --如果已经计算，原记录计算完全正确，则直接修改将标志改正
                  Update 住院费用记录
                  Set 附加标志 = 0
                  Where 病人id = 病人id_In And 主页id = 主页id_In And 记录性质 = 3 And 记录状态 = 1 And Nvl(加班标志, 0) = v_Currrow.附加床位 And
                        病人科室id = Nvl(n_开单部门id, 0) And 病人病区id = Nvl(n_病人病区id, 0) And Nvl(床号, 0) = Nvl(v_Currrow.床号, 0) And
                        收费细目id = v_费用.收费细目id And 收入项目id = v_费用.收入项目id And 发生时间 = d_发生时间 And 数次 = v_费用.数量 * n_Dates And
                        标准单价 = v_费用.单价 And 应收金额 = Round(v_费用.单价 * v_费用.数量 * n_Dates, n_Dec) And
                        实收金额 = Round(v_费用.单价 * v_费用.数量 * n_Dates * n_Exsetax / 100, n_Dec);
                
                  If Sql%RowCount = 0 Then
                    --如果未计算或计算错误，则增加正确的计算记录
                    Insert Into 住院费用记录
                      (ID, 记录性质, NO, 记录状态, 序号, 从属父号, 价格父号, 多病人单, 医嘱序号, 门诊标志, 病人id, 主页id, 病人病区id, 病人科室id, 开单部门id, 执行部门id,
                       姓名, 性别, 年龄, 标识号, 床号, 费别, 记帐费用, 收费细目id, 收入项目id, 附加标志, 标准单价, 付数, 数次, 应收金额, 实收金额, 收费类别, 计算单位, 加班标志,
                       收据费目, 开单人, 划价人, 操作员编号, 操作员姓名, 发生时间, 登记时间, 保险项目否, 保险大类id, 统筹金额, 医疗小组id)
                      Select 病人费用记录_Id.Nextval, 3, v_Billno, 1, Rownum + n_Billcount, Null, Null, 0, Null,
                             Decode(v_Currrow.主页id, Null, 1, 2), v_Currrow.病人id, v_Currrow.主页id, n_病人病区id, n_开单部门id,
                             n_开单部门id, n_病人病区id, v_Currrow.姓名, v_Currrow.性别, v_Currrow.年龄, v_Currrow.住院号, v_Currrow.床号,
                             v_Currrow.费别, 1, v_费用.收费细目id, v_费用.收入项目id, 0, v_费用.单价, 1, v_费用.数量 * n_Dates,
                             Round(v_费用.单价 * v_费用.数量 * n_Dates, n_Dec),
                             Round(v_费用.单价 * v_费用.数量 * n_Dates * n_Exsetax / 100, n_Dec), i.类别, i.计算单位, v_Currrow.附加床位,
                             j.收据费目, v_Currrow.经治医师, v_Currrow.责任护士, v_Currrow.操作员编号, v_Currrow.操作员姓名, d_发生时间, d_登记时间,
                             Decode(v_Currrow.险类, Null, 0, 1), v_Currrow.大类id,
                             Decode(v_Currrow.算法, 1,
                                     Round(v_费用.单价 * v_费用.数量 * n_Dates * n_Exsetax / 100 * v_Currrow.统筹比额 / 100, n_Dec), 2,
                                     v_Currrow.统筹比额, 0), n_医疗小组id
                      From (Select 类别, 计算单位
                             From 收费细目
                             Where ID = v_费用.收费细目id And (撤档时间 Is Null Or 撤档时间 > d_发生时间)) I,
                           (Select 收据费目
                             From 收入项目
                             Where ID = v_费用.收入项目id And (撤档时间 Is Null Or 撤档时间 > d_发生时间)) J;
                    n_Billcount := n_Billcount + Sql%RowCount;
                  End If;
                  n_护理已处理 := 1;
                End Loop;
              End If;
            End If;
          End If;
        End If;
      
        If Nvl(n_护理已处理, 0) = 0 Then
          --如果已经计算，原记录计算完全正确，则直接修改将标志改正
          Update 住院费用记录
          Set 附加标志 = 0
          Where 病人id = 病人id_In And 主页id = 主页id_In And 记录性质 = 3 And 记录状态 = 1 And Nvl(加班标志, 0) = v_Currrow.附加床位 And
                病人科室id = v_Currrow.科室id And 病人病区id = Nvl(v_Currrow.病区id, 0) And Nvl(床号, 0) = Nvl(v_Currrow.床号, 0) And
                收费细目id = v_Currrow.收费细目id And 收入项目id = v_Currrow.收入项目id And 发生时间 = d_发生时间 And
                数次 = v_Currrow.数量 * n_Dates And 标准单价 = v_Currrow.标准单价 And
                应收金额 = Round(v_Currrow.标准单价 * v_Currrow.数量 * n_Dates, n_Dec) And
                实收金额 = Round(v_Currrow.标准单价 * v_Currrow.数量 * n_Dates * n_Exsetax / 100, n_Dec);
        
          If Sql%RowCount = 0 Then
            --如果未计算或计算错误，则增加正确的计算记录\
            Insert Into 住院费用记录
              (ID, 记录性质, NO, 记录状态, 序号, 从属父号, 价格父号, 多病人单, 医嘱序号, 门诊标志, 病人id, 主页id, 病人病区id, 病人科室id, 开单部门id, 执行部门id, 姓名, 性别,
               年龄, 标识号, 床号, 费别, 记帐费用, 收费细目id, 收入项目id, 附加标志, 标准单价, 付数, 数次, 应收金额, 实收金额, 收费类别, 计算单位, 加班标志, 收据费目, 开单人, 划价人,
               操作员编号, 操作员姓名, 发生时间, 登记时间, 保险项目否, 保险大类id, 统筹金额, 医疗小组id)
              Select 病人费用记录_Id.Nextval, 3, v_Billno, 1, Rownum + n_Billcount, Null, Null, 0, Null,
                     Decode(v_Currrow.主页id, Null, 1, 2), v_Currrow.病人id, v_Currrow.主页id, v_Currrow.病区id, v_Currrow.科室id,
                     v_Currrow.科室id, v_Currrow.病区id, v_Currrow.姓名, v_Currrow.性别, v_Currrow.年龄, v_Currrow.住院号,
                     v_Currrow.床号, v_Currrow.费别, 1, v_Currrow.收费细目id, v_Currrow.收入项目id, 0, v_Currrow.标准单价, 1,
                     v_Currrow.数量 * n_Dates, Round(v_Currrow.标准单价 * v_Currrow.数量 * n_Dates, n_Dec),
                     Round(v_Currrow.标准单价 * v_Currrow.数量 * n_Dates * n_Exsetax / 100, n_Dec), i.类别, i.计算单位,
                     v_Currrow.附加床位, j.收据费目, v_Currrow.经治医师, v_Currrow.责任护士, v_Currrow.操作员编号, v_Currrow.操作员姓名, d_发生时间,
                     d_登记时间, Decode(v_Currrow.险类, Null, 0, 1), v_Currrow.大类id,
                     Decode(v_Currrow.算法, 1,
                             Round(v_Currrow.标准单价 * v_Currrow.数量 * n_Dates * n_Exsetax / 100 * v_Currrow.统筹比额 / 100, n_Dec),
                             2, v_Currrow.统筹比额, 0), n_医疗小组id
              From (Select 类别, 计算单位
                     From 收费细目
                     Where ID = v_Currrow.收费细目id And (撤档时间 Is Null Or 撤档时间 > d_发生时间)) I,
                   (Select 收据费目
                     From 收入项目
                     Where ID = v_Currrow.收入项目id And (撤档时间 Is Null Or 撤档时间 > d_发生时间)) J;
          
            n_Billcount := n_Billcount + Sql%RowCount;
          End If;
        End If;
      End Loop;
    End Loop;
  Else
    For v_Currrow In v_Autocur(期间_In, n_Insure) Loop
    
      If v_Currrow.医疗小组id Is Null Then
        n_医疗小组id := Zl_医疗小组_Get(v_Currrow.科室id, v_Currrow.操作员姓名, v_Currrow.病人id, v_Currrow.主页id, d_发生时间);
      Else
        n_医疗小组id := v_Currrow.医疗小组id;
      End If;
    
      If d_Datefrom > v_Currrow.开始日期 Then
        d_Datefrom := v_Currrow.开始日期;
        n_Do       := 1;
        --将本次开始计算时间以后的已计算记录标志修改
        Update 住院费用记录
        Set 附加标志 = 5
        Where 病人id = 病人id_In And 主页id = 主页id_In And 记录性质 = 3 And 记录状态 = 1 And 附加标志 <> 8 And Nvl(医嘱序号, 0) = 0 And
              发生时间 >= v_Currrow.开始日期;
      End If;
    
      If d_Dateto < v_Currrow.终止日期 Then
        d_Dateto := v_Currrow.终止日期;
      End If;
      n_收费细目id := v_Currrow.收费细目id;
      n_护理项目   := 0;
      --护理费计算标准:0-按最后一次护理计算;1-按价格最高的护理等级计算。
      If n_护理计算标准 = 1 Then
        --先确定是否护理项目,如果是,则需要重新进行计算
        Select Count(*) Into n_护理项目 From Table(l_护理id) Where Column_Value = n_收费细目id;
      End If;
    
      --提取当前收入项目的收费比率
      Begin
        Select 实收比率
        Into n_Exsetax
        From (Select 实收比率
               From 费别明细
               Where 费别 = v_Currrow.费别 And 收费细目id = v_Currrow.收费细目id And
                     (Abs(v_Currrow.标准单价 * v_Currrow.数量) Between 应收段首值 And 应收段尾值)
               Union All
               Select 实收比率
               From 费别明细
               Where 费别 = v_Currrow.费别 And 收入项目id = v_Currrow.收入项目id And
                     (Abs(v_Currrow.标准单价 * v_Currrow.数量) Between 应收段首值 And 应收段尾值) And Not Exists
                (Select 1 From 费别明细 Where 费别 = v_Currrow.费别 And 收费细目id = v_Currrow.收费细目id));
      Exception
        When Others Then
          n_Exsetax := 100.00;
      End;
    
      n_Exsetax := Nvl(n_Exsetax, 100);
      For n_Datecount In 0 .. (Trunc(v_Currrow.终止日期 + 0.5) - Trunc(v_Currrow.开始日期)) - 1 Loop
        d_发生时间   := Greatest(v_Currrow.开始日期, Trunc(v_Currrow.开始日期 + n_Datecount));
        n_Dates      := Least(Trunc(v_Currrow.开始日期 + n_Datecount + 1), v_Currrow.终止日期) -
                        Greatest(v_Currrow.开始日期, Trunc(v_Currrow.开始日期 + n_Datecount));
        n_护理已处理 := 0;
        If n_护理项目 = 1 Then
          --1.先检查当天是否存在护理变动,只有存在多个护理变动的,才会去处理(以主项目为准)
          n_从属项目 := 1;
          If l_护理等级.Count > 0 Then
            l_护理等级.Delete;
          End If;
          For v_护理 In (Select Distinct 护理等级id
                       From 病人变动记录
                       Where 开始原因 <> 10 And 病人id = 病人id_In And 主页id = 主页id_In And
                             (Trunc(开始时间) = Trunc(d_发生时间) Or Trunc(Nvl(终止时间, Sysdate)) = Trunc(d_发生时间))) Loop
            If Nvl(v_护理.护理等级id, 0) <> 0 Then
              l_护理等级.Extend;
              l_护理等级(l_护理等级.Count) := v_护理.护理等级id;
              If Nvl(v_护理.护理等级id, 0) = Nvl(v_Currrow.收费细目id, 0) Then
                n_从属项目 := 0;
              End If;
            End If;
          End Loop;
          If l_护理等级.Count > 1 Then
            --2. 存在两个以上变动,则取价位最高的
            n_Temp       := v_Currrow.收费细目id;
            n_价格       := Nvl(v_Currrow.标准单价, 0);
            n_收入项目id := v_Currrow.收入项目id;
            --本身是从属项目时,由于主项目计算时,已经计算了的,所以就不再计算
            If Nvl(n_从属项目, 0) = 1 Then
              n_护理已处理 := 1;
            End If;
            --因为可能存在多个收入项目,但收费细目相同的情况,因此,必须先检查该项目是否已经参与计算过的
            For I In 1 .. c_护理.Count Loop
              If c_护理(I).收费细目id = v_Currrow.收费细目id And c_护理(I).日期 = Trunc(d_发生时间) Then
                n_护理已处理 := 1;
                Exit;
              End If;
            End Loop;
            If Nvl(n_护理已处理, 0) = 0 Then
              c_护理.Extend;
              c_护理(c_护理.Count).收费细目id := v_Currrow.收费细目id;
              c_护理(c_护理.Count).日期 := Trunc(d_发生时间);
            End If;
            If Nvl(n_从属项目, 0) = 0 And Nvl(n_护理已处理, 0) = 0 Then
              --3.处理最高价位
              For v_价位 In (Select /*+ rule */
                            a.Column_Value As 收费细目id, p.现价, p.收入项目id
                           From Table(l_护理等级) A, 收费价目 P, 收费项目目录 C
                           Where a.Column_Value = p.收费细目id And a.Column_Value = c.Id And d_发生时间 Between p.执行日期 And
                                 Nvl(p.终止日期, Sysdate) And Nvl(c.计算方式, 0) <> 1) Loop
                If Nvl(v_价位.现价, 0) > n_价格 Then
                  n_价格       := Nvl(v_价位.现价, 0);
                  n_Temp       := v_价位.收费细目id;
                  n_收入项目id := v_价位.收入项目id;
                End If;
              End Loop;
            
              If n_Temp <> v_Currrow.收费细目id And Nvl(n_护理已处理, 0) = 0 Then
              
                n_开单部门id := v_Currrow.科室id;
                n_病人病区id := v_Currrow.病区id;
              
                For c_变动记录 In (Select 病区id, 科室id
                               From 病人变动记录
                               Where 开始原因 <> 10 And 病人id = 病人id_In And 主页id = 主页id_In And 护理等级id + 0 = n_Temp And
                                     (Trunc(开始时间) = Trunc(d_发生时间) Or Trunc(Nvl(终止时间, Sysdate)) = Trunc(d_发生时间))
                               Order By 开始时间 Desc) Loop
                  n_开单部门id := c_变动记录.科室id;
                  n_病人病区id := c_变动记录.病区id;
                  Exit;
                End Loop;
              
                --4. 不等的话,需要重新处理相关费用
                For v_费用 In (Select n_Temp As 收费细目id, v_Currrow.数量 As 数量, n_价格 As 单价, n_收入项目id As 收入项目id
                             From Dual
                             Union All
                             Select 从项id As 收费细目id, a.从项数次 As 数量, p.现价 As 单价, p.收入项目id
                             From 收费从属项目 A, 收费价目 P, 收费项目目录 C
                             Where a.从项id = p.收费细目id And a.从项id = c.Id And Nvl(c.计算方式, 0) <> 1 And a.主项id = n_Temp And
                                   d_发生时间 Between p.执行日期 And Nvl(p.终止日期, Sysdate)) Loop
                  --确定比例
                  Begin
                    Select 实收比率
                    Into n_Exsetax_Temp
                    From (Select 实收比率
                           From 费别明细
                           Where 费别 = v_Currrow.费别 And 收费细目id = v_费用.收费细目id And
                                 (Abs(v_费用.单价 * v_费用.数量) Between 应收段首值 And 应收段尾值)
                           Union All
                           Select 实收比率
                           From 费别明细
                           Where 费别 = v_Currrow.费别 And 收入项目id = v_费用.收入项目id And
                                 (Abs(v_费用.单价 * v_费用.数量) Between 应收段首值 And 应收段尾值) And Not Exists
                            (Select 1 From 费别明细 Where 费别 = v_Currrow.费别 And 收费细目id = v_费用.收费细目id));
                  Exception
                    When Others Then
                      n_Exsetax_Temp := 100.00;
                  End;
                  n_Exsetax_Temp := Nvl(n_Exsetax_Temp, 100);
                  --如果已经计算，原记录计算完全正确，则直接修改将标志改正
                  Update 住院费用记录
                  Set 附加标志 = 0
                  Where 病人id = 病人id_In And 主页id = 主页id_In And 记录性质 = 3 And 记录状态 = 1 And Nvl(加班标志, 0) = v_Currrow.附加床位 And
                        病人科室id = Nvl(n_开单部门id, 0) And 病人病区id = Nvl(n_病人病区id, 0) And Nvl(床号, 0) = Nvl(v_Currrow.床号, 0) And
                        收费细目id = v_费用.收费细目id And 收入项目id = v_费用.收入项目id And 发生时间 = d_发生时间 And 数次 = v_费用.数量 * n_Dates And
                        标准单价 = v_费用.单价 And 应收金额 = Round(v_费用.单价 * v_费用.数量 * n_Dates, n_Dec) And
                        实收金额 = Round(v_费用.单价 * v_费用.数量 * n_Dates * n_Exsetax / 100, n_Dec);
                
                  If Sql%RowCount = 0 Then
                    --如果未计算或计算错误，则增加正确的计算记录
                    Insert Into 住院费用记录
                      (ID, 记录性质, NO, 记录状态, 序号, 从属父号, 价格父号, 多病人单, 医嘱序号, 门诊标志, 病人id, 主页id, 病人病区id, 病人科室id, 开单部门id, 执行部门id,
                       姓名, 性别, 年龄, 标识号, 床号, 费别, 记帐费用, 收费细目id, 收入项目id, 附加标志, 标准单价, 付数, 数次, 应收金额, 实收金额, 收费类别, 计算单位, 加班标志,
                       收据费目, 开单人, 划价人, 操作员编号, 操作员姓名, 发生时间, 登记时间, 保险项目否, 保险大类id, 统筹金额, 医疗小组id)
                      Select 病人费用记录_Id.Nextval, 3, v_Billno, 1, Rownum + n_Billcount, Null, Null, 0, Null,
                             Decode(v_Currrow.主页id, Null, 1, 2), v_Currrow.病人id, v_Currrow.主页id, n_病人病区id, n_开单部门id,
                             n_开单部门id, n_病人病区id, v_Currrow.姓名, v_Currrow.性别, v_Currrow.年龄, v_Currrow.住院号, v_Currrow.床号,
                             v_Currrow.费别, 1, v_费用.收费细目id, v_费用.收入项目id, 0, v_费用.单价, 1, v_费用.数量 * n_Dates,
                             Round(v_费用.单价 * v_费用.数量 * n_Dates, n_Dec),
                             Round(v_费用.单价 * v_费用.数量 * n_Dates * n_Exsetax / 100, n_Dec), i.类别, i.计算单位, v_Currrow.附加床位,
                             j.收据费目, v_Currrow.经治医师, v_Currrow.责任护士, v_Currrow.操作员编号, v_Currrow.操作员姓名, d_发生时间, d_登记时间,
                             Decode(v_Currrow.险类, Null, 0, 1), v_Currrow.大类id,
                             Decode(v_Currrow.算法, 1,
                                     Round(v_费用.单价 * v_费用.数量 * n_Dates * n_Exsetax / 100 * v_Currrow.统筹比额 / 100, n_Dec), 2,
                                     v_Currrow.统筹比额, 0), n_医疗小组id
                      From (Select 类别, 计算单位
                             From 收费细目
                             Where ID = v_费用.收费细目id And (撤档时间 Is Null Or 撤档时间 > d_发生时间)) I,
                           (Select 收据费目
                             From 收入项目
                             Where ID = v_费用.收入项目id And (撤档时间 Is Null Or 撤档时间 > d_发生时间)) J;
                    n_Billcount := n_Billcount + Sql%RowCount;
                  End If;
                  n_护理已处理 := 1;
                End Loop;
              End If;
            End If;
          End If;
        End If;
      
        If Nvl(n_护理已处理, 0) = 0 Then
          --如果已经计算，原记录计算完全正确，则直接修改将标志改正
          Update 住院费用记录
          Set 附加标志 = 0
          Where 病人id = 病人id_In And 主页id = 主页id_In And 记录性质 = 3 And 记录状态 = 1 And Nvl(加班标志, 0) = v_Currrow.附加床位 And
                病人科室id = v_Currrow.科室id And 病人病区id = Nvl(v_Currrow.病区id, 0) And Nvl(床号, 0) = Nvl(v_Currrow.床号, 0) And
                收费细目id = v_Currrow.收费细目id And 收入项目id = v_Currrow.收入项目id And 发生时间 = d_发生时间 And
                数次 = v_Currrow.数量 * n_Dates And 标准单价 = v_Currrow.标准单价 And
                应收金额 = Round(v_Currrow.标准单价 * v_Currrow.数量 * n_Dates, n_Dec) And
                实收金额 = Round(v_Currrow.标准单价 * v_Currrow.数量 * n_Dates * n_Exsetax / 100, n_Dec);
        
          If Sql%RowCount = 0 Then
            --如果未计算或计算错误，则增加正确的计算记录\
            Insert Into 住院费用记录
              (ID, 记录性质, NO, 记录状态, 序号, 从属父号, 价格父号, 多病人单, 医嘱序号, 门诊标志, 病人id, 主页id, 病人病区id, 病人科室id, 开单部门id, 执行部门id, 姓名, 性别,
               年龄, 标识号, 床号, 费别, 记帐费用, 收费细目id, 收入项目id, 附加标志, 标准单价, 付数, 数次, 应收金额, 实收金额, 收费类别, 计算单位, 加班标志, 收据费目, 开单人, 划价人,
               操作员编号, 操作员姓名, 发生时间, 登记时间, 保险项目否, 保险大类id, 统筹金额, 医疗小组id)
              Select 病人费用记录_Id.Nextval, 3, v_Billno, 1, Rownum + n_Billcount, Null, Null, 0, Null,
                     Decode(v_Currrow.主页id, Null, 1, 2), v_Currrow.病人id, v_Currrow.主页id, v_Currrow.病区id, v_Currrow.科室id,
                     v_Currrow.科室id, v_Currrow.病区id, v_Currrow.姓名, v_Currrow.性别, v_Currrow.年龄, v_Currrow.住院号,
                     v_Currrow.床号, v_Currrow.费别, 1, v_Currrow.收费细目id, v_Currrow.收入项目id, 0, v_Currrow.标准单价, 1,
                     v_Currrow.数量 * n_Dates, Round(v_Currrow.标准单价 * v_Currrow.数量 * n_Dates, n_Dec),
                     Round(v_Currrow.标准单价 * v_Currrow.数量 * n_Dates * n_Exsetax / 100, n_Dec), i.类别, i.计算单位,
                     v_Currrow.附加床位, j.收据费目, v_Currrow.经治医师, v_Currrow.责任护士, v_Currrow.操作员编号, v_Currrow.操作员姓名, d_发生时间,
                     d_登记时间, Decode(v_Currrow.险类, Null, 0, 1), v_Currrow.大类id,
                     Decode(v_Currrow.算法, 1,
                             Round(v_Currrow.标准单价 * v_Currrow.数量 * n_Dates * n_Exsetax / 100 * v_Currrow.统筹比额 / 100, n_Dec),
                             2, v_Currrow.统筹比额, 0), n_医疗小组id
              From (Select 类别, 计算单位
                     From 收费细目
                     Where ID = v_Currrow.收费细目id And (撤档时间 Is Null Or 撤档时间 > d_发生时间)) I,
                   (Select 收据费目
                     From 收入项目
                     Where ID = v_Currrow.收入项目id And (撤档时间 Is Null Or 撤档时间 > d_发生时间)) J;
          
            n_Billcount := n_Billcount + Sql%RowCount;
          End If;
        End If;
      End Loop;
    End Loop;
  End If;
  If n_Do = 0 Then
    --撤销出院后,如果修改出院时间为入院当天则不产生新费用,但以前的费用要冲销
    Begin
      Select Trunc(Nvl(b.上次计算时间, b.终止时间))
      Into d_Datelast
      From 病人变动记录 A, 病人变动记录 B
      Where a.病人id = 病人id_In And a.主页id = 主页id_In And a.终止原因 = 1 And a.病人id = b.病人id And a.主页id = b.主页id And b.开始原因 = 1 And
            Trunc(b.开始时间) = Trunc(a.终止时间) And a.附加床位 = 0 And b.附加床位 = 0;
    Exception
      When Others Then
        Null;
    End;
    If d_Datelast Is Not Null Then
      d_Datefrom := d_Datelast;
      d_Dateto   := Sysdate;
      Update 住院费用记录
      Set 附加标志 = 5
      Where 病人id = 病人id_In And 主页id = 主页id_In And 记录性质 = 3 And 记录状态 = 1 And 附加标志 <> 8 And Nvl(医嘱序号, 0) = 0 And
            发生时间 >= d_Datefrom;
    End If;
  End If;

  -----------------------------------------------------------------
  --作废以前计算的错误记录
  -----------------------------------------------------------------
  Insert Into 住院费用记录
    (ID, 记录性质, NO, 记录状态, 序号, 从属父号, 价格父号, 多病人单, 医嘱序号, 门诊标志, 病人id, 主页id, 病人病区id, 病人科室id, 开单部门id, 执行部门id, 姓名, 性别, 年龄, 标识号,
     床号, 费别, 记帐费用, 收费细目id, 收入项目id, 附加标志, 标准单价, 付数, 数次, 应收金额, 实收金额, 收费类别, 计算单位, 加班标志, 收据费目, 开单人, 划价人, 操作员编号, 操作员姓名, 发生时间,
     登记时间, 保险项目否, 保险大类id, 统筹金额, 医疗小组id)
    Select 病人费用记录_Id.Nextval, 记录性质, NO, 2, 序号, 从属父号, 价格父号, 多病人单, 医嘱序号, 门诊标志, 病人id, 主页id, 病人病区id, 病人科室id, 开单部门id, 执行部门id,
           姓名, 性别, 年龄, 标识号, 床号, 费别, 记帐费用, 收费细目id, 收入项目id, 0, 标准单价, 付数, -数次, -应收金额, -实收金额, 收费类别, 计算单位, 加班标志, 收据费目, 开单人,
           划价人, 操作员编号, 操作员姓名, 发生时间, d_登记时间, 保险项目否, 保险大类id, -统筹金额, 医疗小组id
    From 住院费用记录
    Where 病人id = 病人id_In And 主页id = 主页id_In And 记录性质 = 3 And 记录状态 = 1 And 附加标志 = 5 And 发生时间 >= d_Datefrom;

  -----------------------------------------------------------------
  --填写病人余额
  -----------------------------------------------------------------
  Select Sum(Decode(附加标志, 0, 1, -1) * 实收金额) As 实收金额
  Into n_Summoney
  From 住院费用记录
  Where 病人id = 病人id_In And 主页id = 主页id_In And 记录性质 = 3 And 记录状态 = 1 And
        (NO = v_Billno Or 附加标志 = 5 And 发生时间 >= d_Datefrom);

  Update 病人余额
  Set 费用余额 = Nvl(费用余额, 0) + Nvl(n_Summoney, 0)
  Where 病人id = 病人id_In And 性质 = 1 And 类型 = 2
  Returning 费用余额 Into n_返回值;

  If Sql%RowCount = 0 Then
    Insert Into 病人余额 (病人id, 性质, 类型, 费用余额, 预交余额) Values (病人id_In, 1, 2, n_Summoney, 0);
    n_返回值 := n_Summoney;
  End If;

  If Nvl(n_返回值, 0) = 0 Then
    Delete From 病人余额 Where 性质 = 1 And 病人id = 病人id_In And Nvl(费用余额, 0) = 0 And Nvl(预交余额, 0) = 0;
  End If;

  -----------------------------------------------------------------
  --填写病人汇总费用
  -----------------------------------------------------------------
  n_Delete := 0;
  For v_Currrow In v_Sumcur(v_Billno, d_Datefrom) Loop
    Update 病人未结费用
    Set 金额 = Nvl(金额, 0) + Nvl(v_Currrow.实收金额, 0)
    Where 病人id = 病人id_In And Nvl(主页id, 0) = Nvl(主页id_In, 0) And Nvl(病人病区id, 0) = Nvl(v_Currrow.病人病区id, 0) And
          Nvl(病人科室id, 0) = Nvl(v_Currrow.病人科室id, 0) And Nvl(开单部门id, 0) = Nvl(v_Currrow.开单部门id, 0) And
          Nvl(执行部门id, 0) = Nvl(v_Currrow.执行部门id, 0) And Nvl(收入项目id, 0) = Nvl(v_Currrow.收入项目id, 0) And 来源途径 + 0 = 2
    Returning 金额 Into n_返回值;
  
    If Sql%RowCount = 0 Then
      Insert Into 病人未结费用
        (病人id, 主页id, 病人病区id, 病人科室id, 开单部门id, 执行部门id, 收入项目id, 来源途径, 金额)
      Values
        (病人id_In, 主页id_In, v_Currrow.病人病区id, v_Currrow.病人科室id, v_Currrow.开单部门id, v_Currrow.执行部门id, v_Currrow.收入项目id, 2,
         v_Currrow.实收金额);
      n_返回值 := v_Currrow.实收金额;
    End If;
    If Nvl(n_返回值, 0) = 0 Then
      n_Delete := 1;
    End If;
  End Loop;

  If Nvl(n_Delete, 0) = 1 Then
    Delete From 病人未结费用 Where 病人id = 病人id_In And 金额 = 0;
  End If;

  -----------------------------------------------------------------
  --将所有修改的附加标志还原为正常标志
  -----------------------------------------------------------------
  Update 住院费用记录
  Set 附加标志 = 0, 记录状态 = 3
  Where 病人id = 病人id_In And 主页id = 主页id_In And 记录性质 = 3 And 记录状态 = 1 And 附加标志 = 5 And 发生时间 >= d_Datefrom;

  -----------------------------------------------------------------
  --修改计算时间标志
  -----------------------------------------------------------------
  Update 病人变动记录
  Set 上次计算时间 = Least(d_Dateto, Nvl(终止时间, Greatest(开始时间, Sysdate)))
  Where 病人id = 病人id_In And 主页id = 主页id_In And Nvl(终止时间, Sysdate) > d_Datefrom;
  Commit; --单个病人提交
End Zl1_Autocptone;
/

--96903:胡俊勇,2017-09-18,门诊病人强制续诊取消接诊
Create Or Replace Procedure Zl_病人接诊_Cancel
(
  病人id_In 病人信息.病人id%Type,
  No_In     病人挂号记录.No%Type
) As
  v_门诊号   病人信息.门诊号%Type;
  v_挂号id   病人挂号记录.Id%Type;
  v_分诊方式 挂号安排.分诊方式%Type;

  n_转诊       Number(1);
  n_申请科室id 病人转诊记录.申请科室id%Type;
  v_申请医生   病人转诊记录.申请医生%Type;
Begin
  Select 门诊号 Into v_门诊号 From 病人信息 Where 病人id = 病人id_In;
  Select ID Into v_挂号id From 病人挂号记录 Where NO = No_In And 记录性质 = 1 And 记录状态 = 1;

  --确定原挂号号别的医生,用于还原
  Begin
    Select Nvl(a.分诊方式, 0) Into v_分诊方式 From 挂号安排 A, 病人挂号记录 B Where a.号码 = b.号别 And b.No = No_In;    
  Exception
    When Others Then
      Null;
  End;

  --判断病人是否是转诊方式(强制续诊/转诊),如果是该回恢到以前的 科室和医生 然后撤消转诊变动记录
  For R In (Select a.挂号id, a.申请科室id, a.申请医生, a.接收科室id, a.接收医生, a.接收时间
            From 病人转诊记录 A
            Where a.No = No_In
            Order By a.接收时间 Desc) Loop
    n_申请科室id := r.申请科室id;
    v_申请医生   := r.申请医生;
    n_转诊       := 1;
    Delete 病人转诊记录 Where 挂号id = r.挂号id And 接收时间 = r.接收时间;
    Exit;
  End Loop;

  --就诊状态
  Update 病人信息 Set 就诊时间 = Null, 就诊状态 = 1 Where 病人id = 病人id_In;

  Update 门诊费用记录
  Set 执行状态 = 0, 执行时间 = Null, 发药窗口 = Decode(v_分诊方式, 0, Null, 发药窗口), 结论 = Null
  Where NO = No_In And 记录性质 = 4 And 记录状态 In (1, 3);

  If n_转诊 = 1 Then
    Update 病人挂号记录
    Set 执行部门id = n_申请科室id, 执行人 = v_申请医生, 执行状态 = 0, 执行时间 = Null, 诊室 = Decode(v_分诊方式, 0, Null, 诊室), 摘要 = Null
    Where NO = No_In And 记录性质 = 1 And 记录状态 = 1;
  Else
    Update 病人挂号记录
    Set 执行状态 = 0, 执行时间 = Null, 诊室 = Decode(v_分诊方式, 0, Null, 诊室), 摘要 = Null
    Where NO = No_In And 记录性质 = 1 And 记录状态 = 1;
  End If;
  
  --删除过敏，诊断信息
  Zl_病人过敏记录_Delete(病人id_In, v_挂号id);
  Zl_病人诊断记录_Delete(病人id_In, v_挂号id, Null, Null, '1,11');
  Update 排队叫号队列 Set 排队状态 = 0 Where 业务类型 = 0 And 业务id = v_挂号id;

  Delete From 病人医嘱记录 Where 病人id = 病人id_In And 挂号单 = No_In And 医嘱状态 = 1;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_病人接诊_Cancel;
/

--101473:董露露,2017-09-14,解决门诊医生站病人血压信息填写成0时，后台数据没得记录的问题
Create Or Replace Procedure Zl_门诊生命体征_Update
(
  病人id_In     In 病人护理记录.病人id%Type,
  挂号id_In     In 病人护理记录.主页id%Type,
  体征_In       In Varchar2,
  操作员姓名_In In 病人护理内容.记录人%Type := Null
  --功能：更新病人生命体征
  --参数：体征_In 项目ID1|项目值1|单位1,项目ID2|项目值2|单位2
) Is
  v_Temp         Varchar2(255);
  v_Fields       Varchar2(255);
  v_人员姓名     病人医嘱状态.操作人员%Type;
  病人护理记录id Number;
  护理项目id     Number;
  v_项目名称     Varchar2(255);
  v_项目内容     Varchar2(255);
  v_项目单位     Varchar2(255);
  v_Date         Date;
  n_Count        Number;
  Err_Custom Exception;
Begin
  --当前操作人员
  If 操作员姓名_In Is Not Null Then
    v_人员姓名 := 操作员姓名_In;
  Else
    v_Temp     := Zl_Identity;
    v_Temp     := Substr(v_Temp, Instr(v_Temp, ';') + 1);
    v_Temp     := Substr(v_Temp, Instr(v_Temp, ',') + 1);
    v_人员姓名 := Substr(v_Temp, Instr(v_Temp, ',') + 1);
  End If;
  --先插入 病人护理记录 表；再插入 病人护理内容，如果有记录则修改原有记录
  Select Max(ID) Into 病人护理记录id From 病人护理记录 Where 病人id = 病人id_In And 主页id = 挂号id_In;
  Select Sysdate Into v_Date From Dual;
  If 病人护理记录id Is Null Then
    Select 病人护理记录_Id.Nextval Into 病人护理记录id From Dual;
    Insert Into 病人护理记录
      (ID, 病人来源, 病人id, 主页id, 保存人, 保存时间)
    Values
      (病人护理记录id, 1, 病人id_In, 挂号id_In, v_人员姓名, v_Date);
  Else
    Update 病人护理记录 Set 保存人 = v_人员姓名, 保存时间 = v_Date Where ID = 病人护理记录id;
  End If;

  --原来没有的现在新增 
  v_Temp := 体征_In || ',';
  While v_Temp Is Not Null Loop
    --依次取每个项目 
    v_Fields := Substr(v_Temp, 1, Instr(v_Temp, ',') - 1);
    v_Temp   := Replace(',' || v_Temp, ',' || v_Fields || ',');
  
    If v_Fields Is Not Null Then
      护理项目id := Substr(v_Fields, 1, Instr(v_Fields, '|') - 1);
      v_Fields   := Replace('|' || v_Fields, '|' || 护理项目id || '|');
      v_项目内容 := Substr(v_Fields, 1, Instr(v_Fields, '|') - 1);
      v_项目单位 := Replace('|' || v_Fields, '|' || v_项目内容 || '|');
      Select Count(*)
      Into n_Count
      From 病人护理内容 A, 病人护理记录 B
      Where b.Id = a.记录id And b.病人id = 病人id_In And b.主页id = 挂号id_In And a.项目id = 护理项目id;
    
      If n_Count = 0 And v_项目内容 <>'空' Then
        Select 中文名 Into v_项目名称 From 诊治所见项目 Where ID = 护理项目id;
        Insert Into 病人护理内容
          (ID, 记录id, 记录类型, 项目id, 项目名称, 记录内容, 项目单位, 记录人, 修改时间)
        Values
          (病人护理内容_Id.Nextval, 病人护理记录id, 1, 护理项目id, v_项目名称, v_项目内容, v_项目单位, v_人员姓名, v_Date);
      Elsif v_项目内容 <>'空' Then
        Update 病人护理内容
        Set 记录内容 = v_项目内容, 项目单位 = v_项目单位, 记录人 = v_人员姓名, 修改时间 = v_Date
        Where 项目id = 护理项目id And 记录id = 病人护理记录id;
      Elsif n_Count <> 0 And v_项目内容 ='空' Then
        Delete 病人护理内容 Where 项目id = 护理项目id And 记录id = 病人护理记录id;
      End If;
    End If;
  End Loop;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_门诊生命体征_Update;
/

--112759:刘涛,2017-10-10,材料其他出库审核时成本价为空则重算
Create Or Replace Procedure Zl_材料其他出库_Verify
(
  序号_In       In 药品收发记录.序号%Type,
  No_In         In 药品收发记录.No%Type,
  库房id_In     In 药品收发记录.库房id%Type,
  材料id_In     In 药品收发记录.药品id%Type,
  批次_In       In 药品收发记录.批次%Type,
  实际数量_In   In 药品收发记录.实际数量%Type,
  成本价_In     In 药品收发记录.成本价%Type,
  成本金额_In   In 药品收发记录.成本金额%Type,
  零售金额_In   In 药品收发记录.零售金额%Type,
  差价_In       In 药品收发记录.差价%Type,
  入出类别id_In In 药品收发记录.入出类别id%Type,
  审核人_In     In 药品收发记录.审核人%Type,
  审核日期_In   In 药品收发记录.审核日期%Type
) Is
  Err_Item Exception;
  v_Err_Msg    Varchar2(100);
  v_负成本计算 Zlparameters.参数值%Type;
  v_批准文号   药品库存.批准文号%Type;
  v_批号       药品收发记录.批号%Type;
  v_产地       药品收发记录.产地%Type;

  n_实际库存金额 药品库存.实际金额%Type;
  n_实际库存差价 药品库存.实际差价%Type;
  n_实际库存数量 药品库存.实际数量%Type;

  n_出库差价 药品库存.实际差价%Type;
  n_成本价   药品收发记录.成本价%Type;
  n_成本金额 药品收发记录.成本金额%Type;

  n_上次供应商id 药品库存.上次供应商id%Type;
  n_实价卫材     收费项目目录.是否变价%Type;
  n_零售价       药品收发记录.零售价%Type;
  n_小数         Number(2);

  d_上次生产日期 药品库存.上次生产日期%Type;
  d_效期         药品库存.效期%Type;
  d_灭菌效期     药品库存.灭菌效期%Type;
  v_上次扣率     药品库存.上次扣率%Type;
  v_商品条码     药品库存.商品条码%Type;
  v_内部条码     药品库存.内部条码%Type;
  n_平均成本价   药品库存.平均成本价%Type;
Begin
  Select Nvl(精度, 2) Into n_小数 From 药品卫材精度 Where 类别 = 2 And 内容 = 4 And 单位 = 5;
  Select zl_GetSysParameter(120) Into v_负成本计算 From Dual;

  --由于领用处理允许在审核时改变实际数量，
  --所以首先对实际数量和其他相应的字段进行更新。
  Begin
    Select Nvl(实际金额, 0), Nvl(实际差价, 0), Nvl(实际数量, 0), Nvl(上次扣率, 100), 商品条码, 内部条码
    Into n_实际库存金额, n_实际库存差价, n_实际库存数量, v_上次扣率, v_商品条码, v_内部条码
    From 药品库存
    Where 药品id = 材料id_In And Nvl(批次, 0) = 批次_In And 库房id = 库房id_In And 性质 = 1 And Rownum = 1;
  Exception
    When Others Then
      n_实际库存金额 := 0;
      n_实际库存数量 := 0;
      v_上次扣率     := 100;
      v_商品条码     := Null;
      v_内部条码     := Null;
  End;

  If 成本价_In Is Null Then
    --成本价为空
    n_成本价   := Round(Zl_Fun_Getoutcost(材料id_In, 批次_In, 库房id_In), 7);
    n_成本金额 := Round(n_成本价 * 实际数量_In, n_小数);
    n_出库差价 := Round(零售金额_In - n_成本金额, n_小数);
  Else
    n_成本价   := 成本价_In;
    n_成本金额 := 成本金额_In;
    n_出库差价 := 差价_In;
  End If;

  --取上次供应商ID
  Begin
    Select 供药单位id, 零售价, 生产日期, 批准文号, 效期, 灭菌效期, 批号, 产地
    Into n_上次供应商id, n_零售价, d_上次生产日期, v_批准文号, d_效期, d_灭菌效期, v_批号, v_产地
    From 药品收发记录
    Where NO = No_In And 单据 = 21 And 药品id = 材料id_In And 记录状态 = 1 And 序号 = 序号_In And Rownum = 1;
  
  Exception
    When Others Then
      n_上次供应商id := Null;
  End;

  Update 药品收发记录
  Set 审核人 = Nvl(审核人_In, 审核人), 审核日期 = 审核日期_In, 成本价 = n_成本价, 成本金额 = n_成本金额, 差价 = n_出库差价, 扣率 = v_上次扣率, 商品条码 = v_商品条码,
      内部条码 = v_内部条码
  Where NO = No_In And 单据 = 21 And 药品id = 材料id_In And 序号 = 序号_In And 记录状态 = 1 And 审核人 Is Null;

  If Sql%RowCount = 0 Then
    v_Err_Msg := '[ZLSOFT]该单据已经被他人审核！[ZLSOFT]';
    Raise Err_Item;
  End If;
  Select 是否变价 Into n_实价卫材 From 收费项目目录 Where ID = 材料id_In;

  --更改药品库存的相应数据
  Update 药品库存
  Set 实际数量 = Nvl(实际数量, 0) - 实际数量_In, 实际金额 = Nvl(实际金额, 0) - 零售金额_In, 实际差价 = Nvl(实际差价, 0) - n_出库差价,
      零售价 = Decode(n_实价卫材, 1, Decode(Nvl(批次_In, 0), 0, Null, Decode(Nvl(零售价, 0), 0, n_零售价, 零售价)), Null), 商品条码 = v_商品条码,
      内部条码 = v_内部条码
  Where 库房id = 库房id_In And 药品id = 材料id_In And Nvl(批次, 0) = Nvl(批次_In, 0) And 性质 = 1;

  If Sql%NotFound Then
    Insert Into 药品库存
      (库房id, 药品id, 批次, 性质, 可用数量, 实际数量, 实际金额, 实际差价, 效期, 灭菌效期, 上次供应商id, 上次采购价, 上次批号, 上次生产日期, 上次产地, 批准文号, 零售价, 上次扣率, 商品条码,
       内部条码, 平均成本价)
    Values
      (库房id_In, 材料id_In, 批次_In, 1, -实际数量_In, -实际数量_In, -零售金额_In, -n_出库差价, d_效期, d_灭菌效期, n_上次供应商id, n_成本价, v_批号,
       d_上次生产日期, v_产地, v_批准文号, Decode(n_实价卫材, 1, Decode(Nvl(批次_In, 0), 0, Null, n_零售价), Null), v_上次扣率, v_商品条码, v_内部条码,
       n_成本价);
  End If;

  Delete From 药品库存
  Where 库房id = 库房id_In And 药品id = 材料id_In And Nvl(可用数量, 0) = 0 And Nvl(实际数量, 0) = 0 And Nvl(实际金额, 0) = 0 And
        Nvl(实际差价, 0) = 0;

  --重新计算库存表中的平均成本价
  Update 药品库存
  Set 平均成本价 = Decode(Nvl(批次, 0),
                      0,
                      Decode((实际金额 - 实际差价) / 实际数量, 0, 上次采购价, (实际金额 - 实际差价) / 实际数量),
                      上次采购价)
  Where 性质 = 1 And 库房id = 库房id_In And 药品id = 材料id_In And Nvl(批次, 0) = Nvl(批次_In, 0) And Nvl(实际数量, 0) <> 0;
  If Sql%NotFound Then
    Select 成本价 Into n_平均成本价 From 材料特性 Where 材料id = 材料id_In;
    Update 药品库存
    Set 平均成本价 = n_平均成本价
    Where 性质 = 1 And 库房id = 库房id_In And 药品id = 材料id_In And Nvl(批次, 0) = Nvl(批次_In, 0);
  End If;

Exception
  When Err_Item Then
    Raise_Application_Error(-20101, v_Err_Msg);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_材料其他出库_Verify;
/

--113688:董露露,2017-09-10,解决取消门诊再入院后，病人信息表中的数据没有更新的问题
Create Or Replace Procedure Zl_入院病案主页_Delete
(
  病人id_In     病案主页.病人id%Type,
  主页id_In     病案主页.主页id%Type,
  转留观_In     Number := 0,
  清除住院号_In Number := 0
  --功能：取消病人入院/预约登记
  --     主页ID_IN:为0时表示取消预约登记
  --     转留观_IN:将正常入院登记病人转为住院留观病人
  --     清除住院号_In:第一次住院的病人转留观时是否清除住院号
) As
  v_入院时间   病案主页.入院日期%Type;
  v_入院科室   病案主页.入院科室id%Type;
  v_出院时间   病案主页.出院日期%Type;
  v_住院号     病案主页.住院号%Type;
  v_再入院     病案主页.再入院%Type;
  v_出院科室id 病案主页.出院科室id%Type;
  n_病人性质   病案主页.病人性质%Type;
  n_主页id     病案主页.主页id%Type;

  v_Count Number;
  v_Error Varchar2(255);
  Err_Custom Exception;
Begin
  Select Nvl(状态, 0), Nvl(病人性质, 0)
  Into v_Count, n_病人性质
  From 病案主页
  Where 病人id = 病人id_In And 主页id = 主页id_In;
  If v_Count <> 1 Then
    v_Error := '该病人已经入科,请先将病人撤消至入院状态。';
    Raise Err_Custom;
  End If;

  --删除电子病历时机
  Select 出院科室id, 再入院 Into v_出院科室id, v_再入院 From 病案主页 Where 病人id = 病人id_In And 主页id = 主页id_In;
  If v_再入院 = 0 Then
    Zl_电子病历时机_Delete(病人id_In, 主页id_In, '入院', v_出院科室id);
  Else
    Zl_电子病历时机_Delete(病人id_In, 主页id_In, '再次入院', v_出院科室id);
  End If;

  --提取最近一次不为空的住院号
  Begin
    If 主页id_In = 0 Then
      Select 住院号
      Into v_住院号
      From 病案主页
      Where 病人id = 病人id_In And
            主页id =
            (Select Max(主页id) From 病案主页 Where 病人id = 病人id_In And Nvl(主页id, 0) <> 0 And Nvl(住院号, 0) <> 0);
    Else
      Select 住院号
      Into v_住院号
      From 病案主页
      Where 病人id = 病人id_In And
            主页id =
            (Select Max(主页id) From 病案主页 Where 病人id = 病人id_In And 主页id < 主页id_In And Nvl(住院号, 0) <> 0);
    End If;
  Exception
    When Others Then
      Null;
  End;

  If 转留观_In = 1 And Nvl(主页id_In, 0) <> 0 Then
    Update 病案主页
    Set 病人性质 = 2, 住院号 = Decode(清除住院号_In, 1, Null, 住院号)
    Where 病人id = 病人id_In And 主页id = 主页id_In And Nvl(病人性质, 0) = 0;
  
    --调整住院次数
    Update 病人信息 Set 住院次数 = Decode(Sign(住院次数 - 1), 1, 住院次数 - 1, Null) Where 病人id = 病人id_In;
    If 清除住院号_In = 1 Then
      Update 病人信息 Set 住院号 = v_住院号 Where 病人id = 病人id_In;
    End If;
  Else
    Begin
      Select b.入院日期, b.出院日期, b.入院科室id
      Into v_入院时间, v_出院时间, v_入院科室
      From 病人信息 A, 病案主页 B
      Where a.病人id = 病人id_In And a.病人id = b.病人id And a.主页id = b.主页id And Nvl(b.主页id, 0) <> 0;
    Exception
      When Others Then
        Null;
    End;
    --撤消预约登记病人不检查住院日报
    If Nvl(主页id_In, 0) <> 0 Then
      Select Zl_住院日报_Count(v_入院科室, v_入院时间) Into v_Count From Dual;
      If v_Count > 0 Then
        v_Error := '已产生业务时间内的住院日报,不能办理该业务!';
        Raise Err_Custom;
      End If;
    End If;
    --门诊留观病人下达入院通知后存在两条有效的病案主页记录（36549）
    Select Count(*) Into v_Count From 病案主页 Where 病人id = 病人id_In And 入院日期 Is Not Null And 出院日期 Is Null;
    If Not v_Count > 1 Then
      v_Count := 0;
      If Nvl(主页id_In, 0) <> 0 And Nvl(n_病人性质, 0) = 0 Then
        v_Count := 1;
      End If;
      --再入院病人,取消入院登记时,病人信息的入院时间和出院时间应该回退到上一次入院日期和出院日期
      If v_再入院 = 1 Then
        Begin
          Select 入院日期, 出院日期
          Into v_入院时间, v_出院时间
          From 病案主页
          Where 病人id = 病人id_In And
                主页id = (Select Max(主页id)
                        From 病案主页
                        Where 病人id = 病人id_In And 主页id < 主页id_In);
        End;
      End If;    
      Update 病人信息
      Set 住院号 = v_住院号, 住院次数 = Decode(v_Count, 0, 住院次数, Decode(Sign(住院次数 - 1), 1, 住院次数 - 1, Null)), 当前科室id = Null,
          当前病区id = Null, 当前床号 = Null, 入院时间 = v_入院时间, 出院时间 = v_出院时间, 担保人 = Null, 担保额 = Null, 担保性质 = Null, 在院 = Null
      Where 病人id = 病人id_In;
      Delete From 在院病人 Where 病人id = 病人id_In;
    End If;
    Delete From 病人变动记录 Where 病人id = 病人id_In And 主页id = 主页id_In;
    Delete From 病人诊断记录 Where 病人id = 病人id_In And 主页id = 主页id_In And 记录来源 = 2;
  
    --本次住院如果交了预交款,改为当作门诊交的
    Update 病人预交记录 Set 主页id = Null Where 病人id = 病人id_In And 主页id = 主页id_In;
  
    --本次发卡的,改变门诊发卡
    Update 住院费用记录 Set 主页id = Null Where 病人id = 病人id_In And 主页id = 主页id_In And 记录性质 = 5;
  
    --本次住院的所有费用记录无结算且已全部冲销，则将对应费用记录中的"主页ID"清除。
    v_Count := 0;
    Select Nvl(Count(*), 0)
    Into v_Count
    From 住院费用记录
    Where 病人id = 病人id_In And 主页id = 主页id_In And 记帐费用 = 1 And 结帐id Is Not Null;
  
    If v_Count = 0 Then
      Begin
        Select Nvl(Count(*), 0)
        Into v_Count
        From 住院费用记录
        Where 病人id = 病人id_In And 主页id = 主页id_In And 记帐费用 = 1
        Group By NO, 记录性质, 序号
        Having Nvl(Sum(实收金额), 0) <> 0;
      Exception
        When Others Then
          v_Count := 0;
      End;
    
      If v_Count = 0 Then
        Delete 病人未结费用 Where 病人id = 病人id_In And 主页id = 主页id_In And 金额 = 0;
        Update 住院费用记录 Set 主页id = Null Where 病人id = 病人id_In And 主页id = 主页id_In And 记帐费用 = 1;
      End If;
    End If;
  
    --本次住院所有医嘱记录都已作废
    v_Count := 0;
    Select Nvl(Count(*), 0)
    Into v_Count
    From 病人医嘱记录
    Where 病人id = 病人id_In And 主页id = 主页id_In And Nvl(医嘱状态, 0) <> 4;
    If v_Count = 0 Then
      Delete From 病人医嘱记录 Where 病人id = 病人id_In And 主页id = 主页id_In;
    End If;
  
    --以下表,没有建病案主页(病人ID,主页ID)的外键,因为其主页ID可能是挂号ID
    Delete From 病人过敏记录 Where 病人id = 病人id_In And Nvl(主页id, 0) = Nvl(主页id_In, 0);
    Delete From 病人诊断记录 Where 病人id = 病人id_In And Nvl(主页id, 0) = Nvl(主页id_In, 0);
    Delete From 病人新生儿记录 Where 病人id = 病人id_In And Nvl(主页id, 0) = Nvl(主页id_In, 0);
    Delete From 电子病历记录 Where 病人id = 病人id_In And Nvl(主页id, 0) = Nvl(主页id_In, 0);
    Delete From 电子病历打印 Where 病人id = 病人id_In And Nvl(主页id, 0) = Nvl(主页id_In, 0);
    --如果入院发放了就诊卡,则删除会失败(病人费用记录主页ID有外键约束)
    Delete From 病案主页 Where 病人id = 病人id_In And Nvl(主页id, 0) = Nvl(主页id_In, 0);
    --修改病人信息的主页ID和住院次数
    Select Max(主页id) Into n_主页id From 病案主页 Where 病人id = 病人id_In And Nvl(主页id, 0) <> 0;
    Update 病人信息 Set 主页id = n_主页id Where 病人id = 病人id_In;
    If n_主页id Is Null Then
      Update 病人信息 Set 住院次数 = Null Where 病人id = 病人id_In;
    End If;
  End If;
Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_入院病案主页_Delete;
/

--114085:陈刘,2017-09-08,产程图无法绑定项目
CREATE OR REPLACE Procedure Zl_护理文件样式_Update
(
  文件id_In     In 病历文件结构.文件id%Type,
  表头层数_In   Number,
  总列数_In     Number,
  最小行高_In   Number,
  文本字体_In   Varchar2,
  文本颜色_In   Number,
  表格颜色_In   Number,
  标题文本_In   Varchar2,
  标题字体_In   Varchar2,
  开始时间_In   Number,
  终止时间_In   Number,
  条件字体_In   Varchar2,
  条件颜色_In   Number,
  有效数据行_In Number,
  首列合并_In   Number,
  时间隐藏_In   Number, --记录单预览、打印时隐藏时间列(如：血糖记录单不需要显示具体的时间)
  页面格式_In   病历页面格式.格式%Type, --按.PaperKind;.PaperOrient;.PaperHeight;.PaperWidth;.MarginLeft;.MarginRight;.MarginTop;.MarginBottom组织
  页眉文本_In   病历页面格式.页眉%Type,
  页脚文本_In   病历页面格式.页脚%Type,
  表上标签_In   Varchar2, --按照"前缀{项目}"组织，以"|"为分隔的表上标签集合
  表头单元_In   Varchar2, --按照"列号,层号,文本"组织，以"|"为分隔的表头单元集合
  表列集合_In   Varchar2, --按照"列号,列宽,项目集合"组织，以"|"为分隔的表列集合；其中项目集合组织为"前缀{项目}后缀`是否汇总", 空格分隔。
  汇总时段_In   Varchar2 := Null, --按照"时段名称,开始时间点,结束时间点"组织，以"|"为分隔的集合。
  表下标签_In   Varchar2 := Null --按照"前缀{项目}"组织，以"|"为分隔的表上标签集合
) Is
  v_Items    Varchar2(4000); --项目集合
  v_Subitems Varchar2(4000); --项目集合
  v_Fields   Varchar2(4000); --一个项目的属性组合
  v_Colno    Varchar2(100); --项目列号
  n_父id     病历文件结构.父id%Type;
  n_对象序号 病历文件结构.对象序号%Type;
  n_对象标记 病历文件结构.对象标记%Type;
  v_对象属性 病历文件结构.对象属性%Type;
  n_内容行次 病历文件结构.内容行次%Type;
  v_内容文本 病历文件结构.内容文本%Type;
  v_是否换行 病历文件结构.是否换行%Type;
  v_要素名称 病历文件结构.要素名称%Type;
  v_要素单位 病历文件结构.要素单位%Type;
  n_要素表示 病历文件结构.要素表示%Type;
  v_医嘱绑定 病历文件结构.要素值域%type;
Begin
  Delete 病历文件结构 Where 文件id = 文件id_In;

  Update 病历页面格式
  Set 格式 = 页面格式_In, 页眉 = 页眉文本_In, 页脚 = 页脚文本_In
  Where 种类 = 3 And 编号 In (Select 页面 From 病历文件列表 Where Id = 文件id_In);

  Select 病历文件结构_Id.Nextval Into n_父id From Dual;
  Insert Into 病历文件结构
    (Id, 文件id, 对象序号, 对象类型, 对象属性, 内容文本)
  Values
    (n_父id, 文件id_In, 1, 1, '表格基本属性和样式的说明', '表格样式');
  Insert Into 病历文件结构
    (Id, 文件id, 父id, 对象类型, 对象序号, 对象属性, 内容文本, 要素名称)
    Select 病历文件结构_Id.Nextval, 文件id_In, n_父id, 4, 序号, 属性, 文本, 名称
    From (Select 1 As 序号, '目前支持单层(1)和多层次(2)' As 属性, To_Char(表头层数_In) As 文本, '表头层数' As 名称
           From Dual
           Union All
           Select 2, '表格总共有的列数', To_Char(总列数_In), '总列数'
           From Dual
           Union All
           Select 3, '每行的最小高度(缇)', To_Char(最小行高_In), '最小行高'
           From Dual
           Union All
           Select 4, '表格的默认字体', 文本字体_In, '文本字体'
           From Dual
           Union All
           Select 5, '表格文本颜色RGB值', To_Char(文本颜色_In), '文本颜色'
           From Dual
           Union All
           Select 6, '表格线的基本颜色', To_Char(表格颜色_In), '表格颜色'
           From Dual
           Union All
           Select 7, '标题的文字内容', 标题文本_In, '标题文本'
           From Dual
           Union All
           Select 8, '标题的字体', 标题字体_In, '标题字体'
           From Dual
           Union All
           Select 9, '按24小时表示的条件开始范围', To_Char(开始时间_In), '开始时间'
           From Dual
           Union All
           Select 10, '小于开始时间表示次日终止', To_Char(终止时间_In), '终止时间'
           From Dual
           Union All
           Select 11, '符合条件的内容记录的字体', 条件字体_In, '条件字体'
           From Dual
           Union All
           Select 13, '有效数据行', To_Char(有效数据行_In), '有效数据行'
           From Dual
           Union All
           Select 14, '日期时间合并', To_Char(首列合并_In), '日期时间合并'
           From Dual
           Union All
           Select 12, '符合表件的内容记录的颜色', To_Char(条件颜色_In), '条件颜色'
           From Dual
           Union All
           Select 15, '时间列隐藏', To_Char(时间隐藏_In), '时间列隐藏'
           From Dual);

  Select 病历文件结构_Id.Nextval Into n_父id From Dual;
  Insert Into 病历文件结构
    (Id, 文件id, 对象序号, 对象类型, 对象属性, 内容文本)
  Values
    (n_父id, 文件id_In, 2, 1, '由替换项组成的表上项目', '表上标签');
  If 表头单元_In Is Null Then
    v_Items := Null;
  Else
    v_Items := Rtrim(表上标签_In) || '|';
  End If;
  n_对象序号 := 0;
  While v_Items Is Not Null Loop
    v_Fields   := Substr(v_Items, 1, Instr(v_Items, '|') - 1);
    n_对象序号 := n_对象序号 + 1;
    v_内容文本 := Substr(v_Fields, 1, Instr(v_Fields, '{') - 1);
    v_要素名称 := Substr(v_Fields, Instr(v_Fields, '{') + 1, Instr(v_Fields, '}') - Instr(v_Fields, '{') - 1);
    If Substr(v_内容文本, 1, 2) = Chr(13) || Chr(10) Then
      v_是否换行 := 1;
      v_内容文本 := Substr(v_内容文本, 3);
    Else
      v_是否换行 := 0;
    End If;
    Insert Into 病历文件结构
      (Id, 文件id, 父id, 对象类型, 对象序号, 内容文本, 要素名称, 是否换行)
    Values
      (病历文件结构_Id.Nextval, 文件id_In, n_父id, 4, n_对象序号, v_内容文本, v_要素名称, v_是否换行);
    v_Items := Substr(v_Items, Instr(v_Items, '|') + 1);
  End Loop;

  Select 病历文件结构_Id.Nextval Into n_父id From Dual;
  Insert Into 病历文件结构
    (Id, 文件id, 对象序号, 对象类型, 对象属性, 内容文本)
  Values
    (n_父id, 文件id_In, 3, 1, '组成表头的各单元内容', '表头单元');
  If 表头单元_In Is Null Then
    v_Items := Null;
  Else
    v_Items := Rtrim(表头单元_In) || '|';
  End If;
  While v_Items Is Not Null Loop
    v_Fields   := Substr(v_Items, 1, Instr(v_Items, '|') - 1);
    n_对象序号 := To_Number(Substr(v_Fields, 1, Instr(v_Fields, ',', 1, 1) - 1));
    n_内容行次 := To_Number(Substr(v_Fields,
                               Instr(v_Fields, ',', 1, 1) + 1,
                               Instr(v_Fields, ',', 1, 2) - Instr(v_Fields, ',', 1, 1) - 1));
    v_内容文本 := Substr(v_Fields, Instr(v_Fields, ',', 1, 2) + 1);
    Insert Into 病历文件结构
      (Id, 文件id, 父id, 对象类型, 对象序号, 内容行次, 内容文本)
    Values
      (病历文件结构_Id.Nextval, 文件id_In, n_父id, 2, n_对象序号, n_内容行次, v_内容文本);
    v_Items := Substr(v_Items, Instr(v_Items, '|') + 1);
  End Loop;

  Select 病历文件结构_Id.Nextval Into n_父id From Dual;
  Insert Into 病历文件结构
    (Id, 文件id, 对象序号, 对象类型, 对象属性, 内容文本)
  Values
    (n_父id, 文件id_In, 4, 1, '表体各数据列的定义设置', '表列集合');
  If 表列集合_In Is Null Then
    v_Items := Null;
  Else
    v_Items := Rtrim(表列集合_In) || '|';
  End If;
  While v_Items Is Not Null Loop
    v_Fields := Substr(v_Items, 1, Instr(v_Items, '|') - 1);
    --汇总列设置了对照关系列号为:项目列号`对照列号
    v_Colno := Substr(v_Fields, 1, Instr(v_Fields, ',', 1, 1) - 1);
    If Instr(v_Colno, '`', 1, 1) > 0 Then
      n_对象序号 := To_Number(Substr(v_Colno, 1, Instr(v_Colno, '`', 1, 1) - 1));
      n_对象标记 := To_Number(Substr(v_Colno, Instr(v_Colno, '`', 1, 1) + 1));
    Else
      n_对象序号 := To_Number(v_Colno);
      n_对象标记 := Null;
    End If;
    v_对象属性 := Substr(v_Fields,
                     Instr(v_Fields, ',', 1, 1) + 1,
                     Instr(v_Fields, ',', 1, 2) - Instr(v_Fields, ',', 1, 1) - 1);
    v_Subitems := Substr(v_Fields, Instr(v_Fields, ',', 1, 2) + 1);
    if   Instr(v_Subitems, ',', 1,1) >0 then 
       v_医嘱绑定:= substr(v_Subitems,Instr(v_Subitems, ',', 1,1) + 1);
       v_Subitems:= substr(v_Subitems,1,Instr(v_Subitems, ',', 1,1) - 1);
    else
      v_医嘱绑定:='';
    end if;
    If v_Subitems Is Null Then
      Insert Into 病历文件结构
        (Id, 文件id, 父id, 对象类型, 对象序号, 对象标记, 对象属性, 内容行次, 内容文本, 要素名称, 要素单位,要素值域)
      Values
        (病历文件结构_Id.Nextval, 文件id_In, n_父id, 4, n_对象序号, n_对象标记, v_对象属性, 1, '', '', '',v_医嘱绑定);
    Else
      v_Subitems := Rtrim(v_Subitems) || ' ';
    End If;
    n_内容行次 := 0;
    While v_Subitems Is Not Null Loop
      n_内容行次 := n_内容行次 + 1;
      v_Fields   := Substr(v_Subitems, 1, Instr(v_Subitems, ' ') - 1);
      v_内容文本 := Substr(v_Fields, 1, Instr(v_Fields, '{') - 1);
      v_要素名称 := Substr(v_Fields, Instr(v_Fields, '{') + 1, Instr(v_Fields, '}') - Instr(v_Fields, '{') - 1);
      If Instr(v_Fields, '`') > 0 Then
        v_要素单位 := Substr(v_Fields, Instr(v_Fields, '}') + 1, Instr(v_Fields, '`') - Instr(v_Fields, '}') - 1);
        n_要素表示 := To_Number(Substr(v_Fields, Instr(v_Fields, '`', 1, 1) + 1));
      Else
        v_要素单位 := Substr(v_Fields, Instr(v_Fields, '}') + 1);
        n_要素表示 := 0;
      End If;
      If n_内容行次 > 1 Then
        n_对象标记 := Null;
      End If;
      Insert Into 病历文件结构
        (Id, 文件id, 父id, 对象类型, 对象序号, 对象标记, 对象属性, 内容行次, 内容文本, 要素名称, 要素单位, 要素表示,要素值域)
      Values
        (病历文件结构_Id.Nextval, 文件id_In, n_父id, 4, n_对象序号, n_对象标记, v_对象属性, n_内容行次, v_内容文本, v_要素名称, v_要素单位, n_要素表示,v_医嘱绑定);
      v_Subitems := Substr(v_Subitems, Instr(v_Subitems, ' ') + 1);
    End Loop;
    v_Items := Substr(v_Items, Instr(v_Items, '|') + 1);
  End Loop;

  Select 病历文件结构_Id.Nextval Into n_父id From Dual;
  Insert Into 病历文件结构
    (Id, 文件id, 对象序号, 对象类型, 对象属性, 内容文本)
  Values
    (n_父id, 文件id_In, 5, 1, '汇总时的分组依据', '汇总时段');
  If 汇总时段_In Is Null Then
    v_Items := Null;
  Else
    v_Items := Rtrim(汇总时段_In) || '|';
  End If;

  n_内容行次 := 0;
  While v_Items Is Not Null Loop
    v_Fields   := Substr(v_Items, 1, Instr(v_Items, '|') - 1);
    n_内容行次 := n_内容行次 + 1;
    Insert Into 病历文件结构
      (Id, 文件id, 父id, 对象类型, 对象序号, 内容行次, 内容文本)
    Values
      (病历文件结构_Id.Nextval, 文件id_In, n_父id, 2, n_内容行次, n_内容行次, v_Fields);
    v_Items := Substr(v_Items, Instr(v_Items, '|') + 1);
  End Loop;

  Select 病历文件结构_Id.Nextval Into n_父id From Dual;
  Insert Into 病历文件结构
    (Id, 文件id, 对象序号, 对象类型, 对象属性, 内容文本)
  Values
    (n_父id, 文件id_In, 6, 1, '由替换项组成的表上项目', '表下标签');
  If 表头单元_In Is Null Then
    v_Items := Null;
  Else
    v_Items := Rtrim(表下标签_In) || '|';
  End If;
  n_对象序号 := 0;
  While v_Items Is Not Null Loop
    v_Fields   := Substr(v_Items, 1, Instr(v_Items, '|') - 1);
    n_对象序号 := n_对象序号 + 1;
    v_内容文本 := Substr(v_Fields, 1, Instr(v_Fields, '{') - 1);
    v_要素名称 := Substr(v_Fields, Instr(v_Fields, '{') + 1, Instr(v_Fields, '}') - Instr(v_Fields, '{') - 1);
    If Substr(v_内容文本, 1, 2) = Chr(13) || Chr(10) Then
      v_是否换行 := 1;
      v_内容文本 := Substr(v_内容文本, 3);
    Else
      v_是否换行 := 0;
    End If;
    Insert Into 病历文件结构
      (Id, 文件id, 父id, 对象类型, 对象序号, 内容文本, 要素名称, 是否换行)
    Values
      (病历文件结构_Id.Nextval, 文件id_In, n_父id, 4, n_对象序号, v_内容文本, v_要素名称, v_是否换行);
    v_Items := Substr(v_Items, Instr(v_Items, '|') + 1);
  End Loop;
Exception
  When Others Then
    Zl_Errorcenter(Sqlcode, Sqlerrm);
End Zl_护理文件样式_Update;
/

--113243:焦博,2017-10-13,传入操作员为空时,设置默认操作员
Create Or Replace Procedure Zl_住院记帐记录_Insert
(
  No_In             住院费用记录.No%Type,
  序号_In           住院费用记录.序号%Type,
  病人id_In         住院费用记录.病人id%Type,
  主页id_In         住院费用记录.主页id%Type,
  标识号_In         住院费用记录.标识号%Type,
  姓名_In           住院费用记录.姓名%Type,
  性别_In           住院费用记录.性别%Type,
  年龄_In           住院费用记录.年龄%Type,
  床号_In           住院费用记录.床号%Type,
  费别_In           住院费用记录.费别%Type,
  病区id_In         住院费用记录.病人病区id%Type,
  科室id_In         住院费用记录.病人科室id%Type,
  加班标志_In       住院费用记录.加班标志%Type,
  婴儿费_In         住院费用记录.婴儿费%Type,
  开单部门id_In     住院费用记录.开单部门id%Type,
  开单人_In         住院费用记录.开单人%Type,
  从属父号_In       住院费用记录.从属父号%Type,
  收费细目id_In     住院费用记录.收费细目id%Type,
  收费类别_In       住院费用记录.收费类别%Type,
  计算单位_In       住院费用记录.计算单位%Type,
  保险项目否_In     住院费用记录.保险项目否%Type,
  保险大类id_In     住院费用记录.保险大类id%Type,
  保险编码_In       住院费用记录.保险编码%Type,
  付数_In           住院费用记录.付数%Type,
  数次_In           住院费用记录.数次%Type,
  附加标志_In       住院费用记录.附加标志%Type,
  执行部门id_In     住院费用记录.执行部门id%Type,
  价格父号_In       住院费用记录.价格父号%Type,
  收入项目id_In     住院费用记录.收入项目id%Type,
  收据费目_In       住院费用记录.收据费目%Type,
  标准单价_In       住院费用记录.标准单价%Type,
  应收金额_In       住院费用记录.应收金额%Type,
  实收金额_In       住院费用记录.实收金额%Type,
  统筹金额_In       住院费用记录.统筹金额%Type,
  发生时间_In       住院费用记录.发生时间%Type,
  登记时间_In       住院费用记录.登记时间%Type,
  药品摘要_In       药品收发记录.摘要%Type,
  划价_In           Number,
  操作员编号_In     住院费用记录.操作员编号%Type,
  操作员姓名_In     住院费用记录.操作员姓名%Type,
  多病人单_In       Number := 0,
  类别id_In         药品单据性质.类别id%Type := Null,
  记帐单id_In       住院费用记录.记帐单id%Type := Null,
  费用摘要_In       住院费用记录.摘要%Type := Null,
  是否急诊_In       住院费用记录.是否急诊%Type := 0,
  医嘱序号_In       住院费用记录.医嘱序号%Type := Null,
  频次_In           药品收发记录.频次%Type := Null,
  单量_In           药品收发记录.单量%Type := Null,
  用法_In           药品收发记录.用法%Type := Null, --用法[|煎法]
  期效_In           药品收发记录.扣率%Type := Null,
  计价特性_In       药品收发记录.扣率%Type := Null,
  简单记帐_In       Number := 0,
  费用类型_In       住院费用记录.费用类型%Type := Null,
  医技补临床费用_In Number := 0,
  领药部门id_In     药品收发记录.对方部门id%Type := Null,
  中药形态_In       住院费用记录.结论%Type := Null,
  医疗小组id_In     住院费用记录.医疗小组id%Type := -1,
  备货材料_In       Number := 0,
  批次_In           药品收发记录.批次%Type := Null
) As
  --功能：新收一张住院记帐单据
  --参数：
  --   药品摘要_IN:存放医嘱中的附加说明或修改保存新单据时用。目前仅用于存放于药品收发记录的摘要中。
  --         原单据(记录状态=2)记录修改产生的新单据号。
  --         新单据(记录状态=1)记录所修改的原单据号。
  --   划价-是否属于住院划价。
  --   医技补临床费用_in:医技站补费时,如果开单科室为临床科室则划价人和记帐人填写为不同,用于销帐申请时区分填写审核科室
  --   备货材料_IN: 医技站的卫生材料备货处理方式:0-正常记帐单;1-备货材料记帐
  --   批次_In:当备货材料_IN=1时有效.传入指定的卫生材料的批次
  v_费用id 住院费用记录.Id%Type;
  v_优先级 未发药品记录.优先级%Type;

  --药房分批、时价药品--
  ------------------------------------------------------------
  --该游标用于分批药品数量分解
  Cursor c_Stock
  (
    n_Outmode Number,
    n_库房id  药品收发记录.库房id%Type
  ) Is
    Select 库房id, 药品id, 批次, 上次批号, 可用数量, 实际数量, 实际金额, 上次供应商id, 批准文号, 上次产地, 上次生产日期, 灭菌效期, 效期, 零售价, 商品条码, 内部条码
    From 药品库存
    Where 药品id = 收费细目id_In And 库房id = n_库房id And 性质 = 1 And (Nvl(批次, 0) = Nvl(批次_In, 0) Or Nvl(批次_In, 0) = 0) And
          (Nvl(批次, 0) = 0 Or 效期 Is Null Or 效期 > Trunc(Sysdate)) And Nvl(可用数量, 0) > 0
    Order By Decode(n_Outmode, 1, 效期, Null), Nvl(批次, 0);
  r_Stock c_Stock%RowType;

  --属性
  n_分批 药品规格.药房分批%Type;
  n_时价 收费项目目录.是否变价%Type;
  v_名称 收费项目目录.名称%Type;
  --临时变量
  n_总数量   Number;
  n_当前数量 Number;
  n_总金额   Number;
  n_当前单价 Number;
  --药品收发记录
  n_批次       药品收发记录.批次%Type;
  n_序号       药品收发记录.序号%Type;
  n_扣率       药品收发记录.扣率%Type;
  n_领药部门id 药品收发记录.对方部门id%Type;
  n_供药单位id 药品收发记录.供药单位id%Type;
  v_商品条码   药品收发记录.商品条码%Type;
  v_内部条码   药品收发记录.内部条码%Type;
  d_效期       药品收发记录.效期%Type;
  d_灭菌效期   药品收发记录.灭菌效期%Type;
  d_灭菌日期   药品收发记录.灭菌日期%Type;
  d_生产日期   药品收发记录.生产日期%Type;
  n_虚拟库房id 药品收发记录.库房id%Type;
  v_产地       药品收发记录.产地%Type;
  v_批号       药品收发记录.批号%Type;
  v_批准文号   药品收发记录.批准文号%Type;
  v_其他出库no 药品收发记录.No%Type;
  n_Aval       药品库存.可用数量%Type;
  v_部门名称   部门表.名称%Type;
  ------------------------------------------------------------
  v_用法       药品收发记录.用法%Type;
  v_煎法       药品收发记录.外观%Type;
  n_单价小数   Number;
  n_医疗小组id 住院费用记录.医疗小组id%Type;
  n_库房id     药品库存.库房id%Type;
  n_修正库房id 药品库存.库房id%Type;
  n_Outmode    Number(1);
  v_Dec        Number;
  v_Count      Number;
  v_Err_Msg    Varchar2(255);
  Err_Item Exception;
  n_出库序号       药品收发记录.序号%Type;
  n_审核标志       病案主页.审核标志%Type;
  n_住院状态       病案主页.状态%Type;
  n_病人审核方式   Number(2);
  n_未入科禁止记账 Number(2);
  v_操作员编号     人员表.编号%Type;
  v_操作员姓名     人员表.姓名%Type;
  v_Temp           Varchar2(255);
Begin
  v_操作员编号 := 操作员编号_In;
  v_操作员姓名 := 操作员姓名_In;
  If v_操作员编号 Is Null Then
    v_Temp := Zl_Identity(1);
    If Not (Nvl(v_Temp, '0') = '0' Or Nvl(v_Temp, '_') = '_') Then
      v_Temp       := Substr(v_Temp, Instr(v_Temp, ';') + 1);
      v_Temp       := Substr(v_Temp, Instr(v_Temp, ',') + 1);
      v_操作员编号 := Substr(v_Temp, 1, Instr(v_Temp, ',') - 1);
      v_Temp       := Substr(v_Temp, Instr(v_Temp, ',') + 1);
      v_操作员姓名 := v_Temp;
    End If;
  End If;
  --根据执行库房取虚拟库房ID
  Begin
    Select 虚拟库房id Into n_虚拟库房id From 虚拟库房对照 Where 科室id = 执行部门id_In And Rownum <= 1;
  Exception
    When Others Then
      n_虚拟库房id := 0;
  End;
  If Nvl(批次_In, 0) <> 0 Then
    Select Nvl(Sum(可用数量), 0)
    Into n_Aval
    From 药品库存
    Where 药品id = 收费细目id_In And 批次 = 批次_In And 库房id = 执行部门id_In;
    If n_Aval <= 0 Then
      n_修正库房id := n_虚拟库房id;
    End If;
  End If;

  If Nvl(备货材料_In, 0) = 1 And 收费类别_In = '4' Then
    If Nvl(n_虚拟库房id, 0) = 0 Then
      Begin
        Select 名称 Into v_Err_Msg From 部门表 Where ID = 执行部门id_In;
      Exception
        When Others Then
          v_Err_Msg := '';
      End;
      v_Err_Msg := '执行部门"' || Nvl(v_Err_Msg, '') || '"未设置虚拟部门,请在卫材参数设置中设置.';
      Raise Err_Item;
    End If;
  End If;
  If Nvl(多病人单_In, 0) = 1 Or Nvl(序号_In, 0) = 1 Then
    --记帐表,全部检查,如果是记帐单只检查第一条,其他不检查
  
    n_病人审核方式   := Nvl(zl_GetSysParameter(185), 0);
    n_未入科禁止记账 := Nvl(zl_GetSysParameter(215), 0);
    If n_病人审核方式 = 1 Or n_未入科禁止记账 = 1 Then
      Begin
        Select 审核标志, 状态
        Into n_审核标志, n_住院状态
        From 病案主页
        Where 病人id = Nvl(病人id_In, 0) And 主页id = Nvl(主页id_In, 0);
      Exception
        When Others Then
          n_审核标志 := 0;
          n_住院状态 := 0;
      End;
      If n_未入科禁止记账 = 1 And n_住院状态 = 1 Then
        v_Err_Msg := '病人未入科,禁止对病人相关费用的操作!';
        Raise Err_Item;
      End If;
    
      If n_病人审核方式 = 1 Then
      
        If Nvl(n_审核标志, 0) = 1 Then
          v_Err_Msg := '该病人目前正在审核费用,不能进行费用相关调整!';
          Raise Err_Item;
        End If;
        If Nvl(n_审核标志, 0) = 2 Then
          v_Err_Msg := '该病人目前已经完成了费用审核,不能进行费用相关调整!';
          Raise Err_Item;
        End If;
      End If;
    End If;
  End If;
  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------
  --领药部门确认规则:
  -- 1.传入 :领药部门ID_IN,直接以传入的为准
  -- 2.领药部门ID_IN=NULL的情况, 如果”开单科室=病人科室”，则填为”病人病区”，如果”开单科室<>病人科室”，则填写为”开单科室”
  If Nvl(领药部门id_In, 0) = 0 Then
    If Nvl(科室id_In, 0) = Nvl(开单部门id_In, 0) Then
      --如果”开单科室=病人科室”，则填为”病人病区”(如果没有入科,即病匹为空这种情况,则以病人科室为准,由于一般这种情况较少(护土开单),因此,这种情况应该不会存在)
      n_领药部门id := Nvl(病区id_In, 0);
      If Nvl(n_领药部门id, 0) = 0 Then
        n_领药部门id := 科室id_In;
      End If;
    Else
      --如果”开单科室<>病人科室”，则填写为”开单科室”
      n_领药部门id := 开单部门id_In;
    End If;
  Else
    n_领药部门id := 领药部门id_In;
  End If;
  --需要检查0这种情况,回为有关联
  If Nvl(n_领药部门id, 0) = 0 Then
    n_领药部门id := Null;
  End If;
  ----------------------------------------------------------------------------------------------------------------------------------------------------------------------

  --药品用法煎法分解
  If 用法_In Is Not Null Then
    If Instr(用法_In, '|') > 0 Then
      v_用法 := Substr(用法_In, 1, Instr(用法_In, '|') - 1);
      v_煎法 := Substr(用法_In, Instr(用法_In, '|') + 1);
    Else
      v_用法 := 用法_In;
    End If;
  End If;

  --金额小数位数
  Select Zl_To_Number(Nvl(zl_GetSysParameter(9), '2')), Zl_To_Number(Nvl(zl_GetSysParameter(157), '5'))
  Into v_Dec, n_单价小数
  From Dual;

  --住院费用记录
  Select 病人费用记录_Id.Nextval Into v_费用id From Dual;
  n_医疗小组id := 医疗小组id_In;

  If Nvl(医疗小组id_In, 0) < 0 Then
    n_医疗小组id := Zl_医疗小组_Get(开单部门id_In, 开单人_In, 病人id_In, 主页id_In, 发生时间_In);
  End If;

  Insert Into 住院费用记录
    (ID, 记录性质, NO, 记录状态, 序号, 从属父号, 价格父号, 多病人单, 门诊标志, 病人id, 主页id, 标识号, 姓名, 性别, 年龄, 床号, 病人病区id, 病人科室id, 费别, 收费类别, 收费细目id,
     计算单位, 保险项目否, 保险大类id, 保险编码, 费用类型, 发药窗口, 付数, 数次, 加班标志, 附加标志, 婴儿费, 收入项目id, 收据费目, 标准单价, 应收金额, 实收金额, 统筹金额, 记帐费用, 开单部门id,
     开单人, 发生时间, 登记时间, 执行部门id, 执行状态, 划价人, 操作员编号, 操作员姓名, 记帐单id, 摘要, 是否急诊, 医嘱序号, 结论, 医疗小组id)
  Values
    (v_费用id, 2, No_In, Decode(划价_In, 1, 0, 1), 序号_In, Decode(从属父号_In, 0, Null, 从属父号_In),
     Decode(价格父号_In, 0, Null, 价格父号_In), 多病人单_In, 2, 病人id_In, 主页id_In, Decode(标识号_In, 0, Null, 标识号_In), 姓名_In, 性别_In,
     年龄_In, 床号_In, Decode(病区id_In, 0, Null, 病区id_In), Decode(科室id_In, 0, Null, 科室id_In), 费别_In, 收费类别_In, 收费细目id_In,
     计算单位_In, 保险项目否_In, 保险大类id_In, 保险编码_In, 费用类型_In, Decode(Nvl(简单记帐_In, 0), 0, Null, 收费类别_In), 付数_In, 数次_In, 加班标志_In,
     附加标志_In, 婴儿费_In, 收入项目id_In, 收据费目_In, 标准单价_In, 应收金额_In, 实收金额_In, 统筹金额_In, 1, 开单部门id_In, 开单人_In, 发生时间_In, 登记时间_In,
     执行部门id_In, 0, Decode(划价_In, 1, v_操作员姓名, Decode(医技补临床费用_In, 1, '补临床费', Null)), Decode(划价_In, 1, Null, v_操作员编号),
     Decode(划价_In, 1, Null, v_操作员姓名), 记帐单id_In, 费用摘要_In, 是否急诊_In, 医嘱序号_In, 中药形态_In, n_医疗小组id);

  Select Max(使用限量 - Nvl(已用数量, 0))
  Into n_当前数量
  From 病人审批项目
  Where 病人id = 病人id_In And 主页id = 主页id_In And 项目id = 收费细目id_In And Nvl(使用限量, 0) <> 0;
  If 付数_In * 数次_In <= Nvl(n_当前数量, 0) Then
    Update 病人审批项目
    Set 已用数量 = Nvl(已用数量, 0) + 付数_In * 数次_In
    Where 病人id = 病人id_In And 主页id = 主页id_In And 项目id = 收费细目id_In And Nvl(使用限量, 0) <> 0;
  Elsif Not n_当前数量 Is Null Then
    v_Err_Msg := '第 ' || 序号_In || ' 行输入的数次超过了批准的可用数量' || n_当前数量 || '.'; --简化为不转换,直接以售价单位提示.
    Raise Err_Item;
  End If;

  --相关汇总表的处理
  If Nvl(划价_In, 0) = 0 Then
    --病人余额
    Update 病人余额 Set 费用余额 = Nvl(费用余额, 0) + 实收金额_In Where 病人id = 病人id_In And 类型 = 2 And 性质 = 1;
    If Sql%RowCount = 0 Then
      Insert Into 病人余额 (病人id, 类型, 性质, 费用余额, 预交余额) Values (病人id_In, 2, 1, 实收金额_In, 0);
    End If;
  
    --病人未结费用
    Update 病人未结费用
    Set 金额 = Nvl(金额, 0) + 实收金额_In
    Where 病人id = 病人id_In And Nvl(主页id, 0) = Nvl(主页id_In, 0) And Nvl(病人病区id, 0) = Nvl(病区id_In, 0) And
          Nvl(病人科室id, 0) = Nvl(科室id_In, 0) And Nvl(开单部门id, 0) = Nvl(开单部门id_In, 0) And
          Nvl(执行部门id, 0) = Nvl(执行部门id_In, 0) And 收入项目id + 0 = 收入项目id_In And 来源途径 + 0 = 2;
    If Sql%RowCount = 0 Then
      Insert Into 病人未结费用
        (病人id, 主页id, 病人病区id, 病人科室id, 开单部门id, 执行部门id, 收入项目id, 来源途径, 金额)
      Values
        (病人id_In, 主页id_In, 病区id_In, 科室id_In, 开单部门id_In, 执行部门id_In, 收入项目id_In, 2, 实收金额_In);
    End If;
  End If;

  --药品和卫生材料部分
  v_Count := 0; --@@@
  If 收费类别_In = '4' Then
    --跟踪在用的卫材才处理
    Select 跟踪在用 Into v_Count From 材料特性 Where 材料id = 收费细目id_In;
  End If;
  If 收费类别_In In ('5', '6', '7') Or (收费类别_In = '4' And Nvl(v_Count, 0) = 1) Then
    If 收费类别_In = '4' Then
      Select Nvl(a.在用分批, 0), Nvl(b.是否变价, 0), b.名称
      Into n_分批, n_时价, v_名称
      From 材料特性 A, 收费项目目录 B
      Where a.材料id = b.Id And b.Id = 收费细目id_In;
    Else
      Select Nvl(a.药房分批, 0), Nvl(b.是否变价, 0), b.名称
      Into n_分批, n_时价, v_名称
      From 药品规格 A, 收费项目目录 B
      Where a.药品id = b.Id And b.Id = 收费细目id_In;
    End If;
  
    --药品分批出库方式
    Select Zl_To_Number(Nvl(zl_GetSysParameter(150), 0)) Into n_Outmode From Dual;
  
    n_总数量 := 付数_In * 数次_In;
    n_总金额 := 0;
    If Nvl(备货材料_In, 0) = 1 And 收费类别_In = '4' Then
      n_库房id := n_虚拟库房id;
      Open c_Stock(n_Outmode, n_虚拟库房id);
    Else
      If Nvl(n_修正库房id, 0) <> 0 Then
        n_库房id := n_修正库房id;
        Open c_Stock(n_Outmode, n_修正库房id);
      Else
        n_库房id := 执行部门id_In;
        Open c_Stock(n_Outmode, 执行部门id_In);
      End If;
    End If;
  
    While n_总数量 <> 0 Loop
      Fetch c_Stock
        Into r_Stock;
      If c_Stock%NotFound Then
        --第一次就没有库存,分批或时价都不允许(包含备货卫材)。
        --分批药品数量分解不完,也就是库存不足。
        If n_分批 = 1 Or n_时价 = 1 Or (Nvl(备货材料_In, 0) = 1 And 收费类别_In = '4') Then
          Close c_Stock;
          If 医嘱序号_In Is Null Then
            If 收费类别_In = '4' Then
              If Nvl(备货材料_In, 0) = 1 And Not (n_分批 = 1 Or n_时价 = 1) Then
                v_Err_Msg := '第 ' || 序号_In || ' 行的卫生材料"' || v_名称 || '"没有足够的材料库存,不能进行备货记帐！';
              Else
                v_Err_Msg := '第 ' || 序号_In || ' 行的分批或时价卫生材料"' || v_名称 || '"没有足够的材料库存' || Case
                               When Nvl(备货材料_In, 0) = 0 Then
                                '！'
                               Else
                                ',不能进行备货记帐！'
                             End;
              End If;
            Else
              v_Err_Msg := '第 ' || 序号_In || ' 行的分批或时价药品"' || v_名称 || '"没有足够的药品库存！';
            End If;
          Else
            If 收费类别_In = '4' Then
              If Nvl(备货材料_In, 0) = 1 And Not (n_分批 = 1 Or n_时价 = 1) Then
                v_Err_Msg := '在处理病人"' || 姓名_In || '"时发现卫生材料"' || v_名称 || '"没有足够的材料库存,不能进行备货记帐！';
              Else
                v_Err_Msg := '在处理病人"' || 姓名_In || '"时发现分批或时价卫生材料"' || v_名称 || '"没有足够的材料库存' || Case
                               When Nvl(备货材料_In, 0) = 0 Then
                                '！'
                               Else
                                ',不能进行备货记帐！'
                             End;
              End If;
            Else
              v_Err_Msg := '在处理病人"' || 姓名_In || '"时发现分批或时价药品"' || v_名称 || '"没有足够的药品库存！';
            End If;
          End If;
          Raise Err_Item;
        End If;
      Elsif (n_分批 = 1 And Nvl(r_Stock.批次, 0) = 0) Or (n_分批 = 0 And Nvl(r_Stock.批次, 0) <> 0) Then
        Close c_Stock;
        If 医嘱序号_In Is Null Then
          If 收费类别_In = '4' Then
            v_Err_Msg := '第 ' || 序号_In || ' 行卫生材料"' || v_名称 || '"的分批属性与库存记录不相符,请检查材料数据的正确性！';
          Else
            v_Err_Msg := '第 ' || 序号_In || ' 行药品"' || v_名称 || '"的分批属性与库存记录不相符,请检查药品数据的正确性！';
          End If;
        Else
          If 收费类别_In = '4' Then
            v_Err_Msg := '在处理病人"' || 姓名_In || '"时发现卫生材料"' || v_名称 || '"的分批属性与库存记录不相符,请检查材料数据的正确性！';
          Else
            v_Err_Msg := '在处理病人"' || 姓名_In || '"时发现药品"' || v_名称 || '"的分批属性与库存记录不相符,请检查药品数据的正确性！';
          End If;
        End If;
        Raise Err_Item;
      End If;
    
      If c_Stock%Found Then
        If Nvl(r_Stock.实际数量, 0) = 0 And (n_总数量 > 0 Or n_时价 = 1) Then
          --实际数量为零时，不正常，不允许出库
          --实际数量不为零，金额为零，可能是正常的零价格管理。
          --负数的情况相当于入库,这种情况应是允许的；但时价需要计算价格，必须要有实际数量。
          Close c_Stock;
          If 医嘱序号_In Is Null Then
            If 收费类别_In = '4' Then
              v_Err_Msg := '第 ' || 序号_In || ' 行的卫生材料"' || v_名称 || '"当前无库存实际数量，可能存在尚未退料的记录，当前不能出库。';
            Else
              v_Err_Msg := '第 ' || 序号_In || ' 行药品"' || v_名称 || '"当前无库存实际数量，可能存在尚未退药的记录，当前不能出库。';
            End If;
          Else
            If 收费类别_In = '4' Then
              v_Err_Msg := '在处理病人"' || 姓名_In || '"时发现卫生材料"' || v_名称 || '"当前无库存实际数量，可能存在尚未退料的记录，当前不能出库。';
            Else
              v_Err_Msg := '在处理病人"' || 姓名_In || '"时发现药品"' || v_名称 || '"当前无库存实际数量，可能存在尚未退药的记录，当前不能出库。';
            End If;
          End If;
          Raise Err_Item;
        End If;
      End If;
    
      --确定本次分解数量
      If n_分批 = 1 Or n_时价 = 1 Then
        --对于不分批的时价只可能分解一次,分解不完上面判断了.它分解是为了计算单价.
        --每次分解取小者,库存不够分解不完在上面判断.
        If n_总数量 <= Nvl(r_Stock.可用数量, 0) Then
          n_当前数量 := n_总数量;
        Else
          n_当前数量 := Nvl(r_Stock.可用数量, 0);
        End If;
        If n_时价 = 1 Then
          n_当前单价 := Round(Nvl(r_Stock.零售价, Nvl(r_Stock.实际金额 / r_Stock.实际数量, 0)), n_单价小数);
        Elsif n_分批 = 1 Then
          n_当前单价 := 标准单价_In;
        End If;
      Else
        --普通药品
        --不管够不够,程序中已根据参数判断
        If Nvl(备货材料_In, 0) = 1 And 收费类别_In = '4' Then
          If n_总数量 > Nvl(r_Stock.可用数量, 0) Then
            --不分批, 但又是备货卫材方式出库的,则需要检查当前库存是否充足.
            v_Err_Msg := '第 ' || 序号_In || ' 行的卫生材料"' || v_名称 || '"没有足够的材料库存,不能进行备货记帐！';
            Raise Err_Item;
          End If;
        End If;
        n_当前数量 := n_总数量;
        n_当前单价 := 标准单价_In;
      End If;
    
      --药品库存(普通情况可能没有记录)
      If c_Stock%Found Then
        Update 药品库存
        Set 可用数量 = Nvl(可用数量, 0) - n_当前数量
        Where 库房id = n_库房id And 药品id = 收费细目id_In And Nvl(批次, 0) = Nvl(r_Stock.批次, 0) And 性质 = 1
        Returning 可用数量 Into v_Count;
        If n_分批 = 1 Or n_时价 = 1 Then
          If v_Count < 0 Then
            If 收费类别_In = '4' Then
              v_Err_Msg := '在处理病人"' || 姓名_In || '"时发现卫生材料"' || v_名称 || '"当前库存实际数量不足，当前不能出库，可能是由于网络并发操作引起，请刷新后再试！。';
            Else
              v_Err_Msg := '在处理病人"' || 姓名_In || '"时发现药品"' || v_名称 || '"当前库存实际数量不足，当前不能出库，可能是由于网络并发操作引起，请刷新后再试！。';
            End If;
            Raise Err_Item;
          End If;
        End If;
      Elsif n_库房id Is Not Null Then
        --只有不分批非时价药品可能库存不足出库
        Update 药品库存
        Set 可用数量 = Nvl(可用数量, 0) - n_当前数量
        Where 库房id = n_库房id And 药品id = 收费细目id_In And Nvl(批次, 0) = 0 And 性质 = 1;
        If Sql%RowCount = 0 Then
          Insert Into 药品库存
            (库房id, 药品id, 性质, 可用数量, 商品条码, 内部条码)
          Values
            (n_库房id, 收费细目id_In, 1, -1 * n_当前数量, r_Stock.商品条码, r_Stock.内部条码);
        End If;
      End If;
    
      If Nvl(备货材料_In, 0) = 1 And 收费类别_In = '4' Then
        Update 药品库存
        Set 可用数量 = Nvl(可用数量, 0) - n_当前数量
        Where 库房id = 执行部门id_In And 药品id = 收费细目id_In And Nvl(批次, 0) = Nvl(r_Stock.批次, 0) And 性质 = 1;
      
        If Sql%RowCount = 0 Then
          Insert Into 药品库存
            (库房id, 药品id, 批次, 性质, 可用数量, 商品条码, 内部条码, 效期, 上次批号, 上次产地, 上次供应商id, 上次生产日期, 批准文号)
          Values
            (执行部门id_In, 收费细目id_In, Nvl(r_Stock.批次, 0), 1, -1 * n_当前数量, r_Stock.商品条码, r_Stock.内部条码, r_Stock.效期,
             r_Stock.上次批号, r_Stock.上次产地, r_Stock.上次供应商id, r_Stock.上次生产日期, r_Stock.批准文号);
        End If;
      End If;
    
      --药品收发记录
      n_批次       := Null;
      v_批号       := Null;
      d_效期       := Null;
      v_产地       := Null;
      d_灭菌效期   := Null;
      d_灭菌日期   := Null;
      n_供药单位id := Null;
      d_生产日期   := Null;
      v_批准文号   := Null;
      If c_Stock%Found Then
        n_批次       := r_Stock.批次;
        v_批号       := r_Stock.上次批号;
        d_效期       := r_Stock.效期;
        v_产地       := r_Stock.上次产地;
        n_供药单位id := r_Stock.上次供应商id;
        d_生产日期   := r_Stock.上次生产日期;
        v_批准文号   := r_Stock.批准文号;
        v_商品条码   := r_Stock.商品条码;
        v_内部条码   := r_Stock.内部条码;
      
        --卫材灭菌效期:一次性材料且有效期
        If 收费类别_In = '4' Then
          v_Count := 0;
          Begin
            Select 灭菌效期 Into v_Count From 材料特性 Where Nvl(一次性材料, 0) = 1 And 材料id = 收费细目id_In;
          Exception
            When Others Then
              Null;
          End;
          If Nvl(v_Count, 0) > 0 Then
            d_灭菌效期 := r_Stock.灭菌效期;
            d_灭菌日期 := d_灭菌效期 - v_Count * 30;
          End If;
        End If;
      End If;
    
      Select Nvl(Max(序号), 0) + 1
      Into n_序号
      From 药品收发记录
      Where NO = No_In And 记录状态 = 1 And 单据 = Decode(多病人单_In, 1, 10, 9) + Decode(收费类别_In, '4', 16, 0);
    
      n_扣率 := Null;
      If 期效_In Is Not Null Or 计价特性_In Is Not Null Then
        n_扣率 := Nvl(期效_In, 0) || Nvl(计价特性_In, 0);
      End If;
    
      --分批药品,如果是只使用了一个批次,则要填写付数
      If n_分批 = 1 And n_当前数量 <> 付数_In * 数次_In Then
        v_Count := 1;
      Else
        v_Count := 0;
      End If;
    
      --修改的原单据号存放在摘要中
      Insert Into 药品收发记录
        (ID, 记录状态, 单据, NO, 序号, 库房id, 对方部门id, 入出类别id, 入出系数, 药品id, 批次, 产地, 批号, 效期, 付数, 填写数量, 实际数量, 零售价, 零售金额, 摘要, 填制人,
         填制日期, 费用id, 频次, 单量, 用法, 外观, 扣率, 灭菌效期, 灭菌日期, 供药单位id, 生产日期, 批准文号, 商品条码, 内部条码)
      Values
        (药品收发记录_Id.Nextval, 1, Decode(多病人单_In, 1, 10, 9) + Decode(收费类别_In, '4', 16, 0), No_In, n_序号, 执行部门id_In,
         n_领药部门id, 类别id_In, -1, 收费细目id_In, n_批次, v_产地, v_批号, d_效期, Decode(v_Count, 1, 1, 付数_In),
         Decode(v_Count, 1, n_当前数量, n_当前数量 / 付数_In), Decode(v_Count, 1, n_当前数量, n_当前数量 / 付数_In), n_当前单价,
         Round(n_当前单价 * n_当前数量, v_Dec), 药品摘要_In, v_操作员姓名, 登记时间_In, v_费用id, 频次_In, 单量_In, v_用法, v_煎法, n_扣率, d_灭菌效期,
         d_灭菌日期, n_供药单位id, d_生产日期, v_批准文号, v_商品条码, v_内部条码);
    
      --产生其他出库单
      If 收费类别_In = '4' And (Nvl(备货材料_In, 0) = 1 Or Nvl(n_修正库房id, 0) <> 0) Then
        Begin
          Select Max(a.No), Max(a.序号)
          Into v_其他出库no, n_出库序号
          From 药品收发记录 A, 住院费用记录 B
          Where a.费用id = b.Id And a.单据 = 21 And b.No = No_In And b.记录性质 = 2;
        Exception
          When Others Then
            v_其他出库no := Null;
        End;
        If v_其他出库no Is Null Then
          v_其他出库no := Nextno(74, n_虚拟库房id, Null, 1);
        End If;
        If v_其他出库no Is Null Then
          v_Err_Msg := '在生成卫生材料的其他出库单时,获取相关的出库NO有误,请检查出库单的规则是否有误!';
          Raise Err_Item;
        End If;
        If Nvl(科室id_In, 0) <> 0 Then
          Select 名称 Into v_部门名称 From 部门表 Where ID = 科室id_In;
        End If;
        v_Err_Msg := LPad(' ', 4);
        v_Err_Msg := Substr('病人姓名:' || 姓名_In || v_Err_Msg || '性别:' || 性别_In || v_Err_Msg || '年龄' || 年龄_In || v_Err_Msg ||
                            '床号:' || 床号_In || v_Err_Msg || '住院号:' || Nvl(标识号_In, '') || v_Err_Msg || '病人科室:' || v_部门名称, 1,
                            100);
      
        n_出库序号 := Nvl(n_出库序号, 0) + 1;
        Insert Into 药品收发记录
          (ID, 记录状态, 单据, NO, 序号, 库房id, 对方部门id, 入出类别id, 入出系数, 药品id, 批次, 产地, 批号, 效期, 付数, 填写数量, 实际数量, 零售价, 零售金额, 摘要, 填制人,
           填制日期, 费用id, 频次, 单量, 用法, 外观, 扣率, 灭菌效期, 灭菌日期, 供药单位id, 生产日期, 批准文号, 商品条码, 内部条码)
        Values
          (药品收发记录_Id.Nextval, 1, 21, v_其他出库no, n_出库序号, n_虚拟库房id, n_领药部门id, 类别id_In, -1, 收费细目id_In, n_批次, v_产地, v_批号,
           d_效期, Decode(v_Count, 1, 1, 付数_In), Decode(v_Count, 1, n_当前数量, n_当前数量 / 付数_In),
           Decode(v_Count, 1, n_当前数量, n_当前数量 / 付数_In), n_当前单价, Round(n_当前单价 * n_当前数量, v_Dec), v_Err_Msg, v_操作员姓名,
           登记时间_In, v_费用id, 频次_In, 单量_In, v_用法, v_煎法, n_扣率, d_灭菌效期, d_灭菌日期, n_供药单位id, d_生产日期, v_批准文号, v_商品条码, v_内部条码);
      End If;
      v_Err_Msg := '';
      n_总数量  := n_总数量 - n_当前数量;
      n_总金额  := n_总金额 + Round(n_当前数量 * n_当前单价, v_Dec);
    End Loop;
  
    --未发药品记录
    Update 未发药品记录
    Set 病人id = 病人id_In, 主页id = 主页id_In, 姓名 = 姓名_In
    Where 单据 = Decode(多病人单_In, 1, 10, 9) + Decode(收费类别_In, '4', 16, 0) And NO = No_In And
          Nvl(库房id, 0) = Nvl(执行部门id_In, 0);
    If Sql%RowCount = 0 Then
      --取身份优先级
      Begin
        Select b.优先级 Into v_优先级 From 病人信息 A, 身份 B Where a.身份 = b.名称(+) And a.病人id = 病人id_In;
      Exception
        When Others Then
          Null;
      End;
      Insert Into 未发药品记录
        (单据, NO, 病人id, 主页id, 姓名, 优先级, 对方部门id, 库房id, 填制日期, 已收费, 打印状态)
      Values
        (Decode(多病人单_In, 1, 10, 9) + Decode(收费类别_In, '4', 16, 0), No_In, 病人id_In, 主页id_In, 姓名_In, v_优先级, n_领药部门id,
         执行部门id_In, 登记时间_In, Decode(划价_In, 1, 0, 1), 0);
    End If;
    Zl_Prescription_Type_Zy_Update(No_In, 2, 收费细目id_In, 收费类别_In);
    --可能时价药品的库存金额和数量变化了
    If n_时价 = 1 Then
      --只有一个批次时,直接取该批次的单价
      If n_当前数量 <> 付数_In * 数次_In Then
        n_当前单价 := Round(n_总金额 / (付数_In * 数次_In), n_单价小数);
      End If;
      If n_当前单价 <> 标准单价_In Then
        Close c_Stock;
        If 医嘱序号_In Is Null Then
          If 收费类别_In = '4' Then
            v_Err_Msg := '第 ' || 序号_In || ' 行的时价卫生材料"' || v_名称 || '"当前计算单价不一致,请重新输入数量计算！';
          Else
            v_Err_Msg := '第 ' || 序号_In || ' 行的时价药品"' || v_名称 || '"当前计算单价不一致,请重新输入数量计算！';
          End If;
        Else
          --医嘱摆药时是按病人分次计算并提交数据库,因此不同病人使用相同实价药品没有问题。
          --但同一病人同时使用两笔以上相同实价药品则会有问题。
          If 收费类别_In = '4' Then
            v_Err_Msg := '在处理病人"' || 姓名_In || '"时发现时价卫生材料"' || v_名称 || '"当前计算的单价发生变化。' || Chr(13) || Chr(10) ||
                         '请检查该病人是否同时使用了两笔相同的"' || v_名称 || '"！';
          Else
            v_Err_Msg := '在处理病人"' || 姓名_In || '"时发现时价药品"' || v_名称 || '"当前计算的单价发生变化。' || Chr(13) || Chr(10) ||
                         '请检查该病人是否同时使用了两笔相同的"' || v_名称 || '"！';
          End If;
        End If;
        Raise Err_Item;
      End If;
    End If;
    Close c_Stock;
  End If;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_住院记帐记录_Insert;
/

--113243:焦博,2017-10-13,传入操作员为空时,设置默认操作员
Create Or Replace Procedure Zl_住院记帐记录_Verify
(
  No_In         住院费用记录.No%Type,
  操作员编号_In 住院费用记录.操作员编号%Type,
  操作员姓名_In 住院费用记录.操作员姓名%Type,
  序号_In       Varchar2 := Null,
  病人id_In     住院费用记录.病人id%Type := Null,
  审核时间_In   住院费用记录.登记时间%Type := Null
) As
  --功能：审核一张住院记帐划价单
  --参数：
  --    序号_IN：格式如"1,3,5,7,8",为空表示审核所有未审核的行
  --    病人ID_IN：只审核指定病人,用于按病人审核记帐表。
  --    审核时间_IN：用于部份需要统一控制或返回时间的地方
  --只读取指定序号的,未审核的部份进行处理
  Cursor c_Bill Is
    Select ID, 病人id, 主页id, 收费细目id, 实收金额, 门诊标志, 收入项目id, 执行部门id, 开单部门id, 病人病区id, 病人科室id, 医嘱序号


    
    From 住院费用记录
    Where 记录性质 = 2 And 记录状态 = 0 And NO = No_In And
          (Instr(',' || 序号_In || ',', ',' || Nvl(价格父号, 序号) || ',') > 0 Or 序号_In Is Null) And
          (病人id + 0 = 病人id_In Or 病人id_In Is Null)
    Order By 序号;

  --审核中包含跟踪在用的未发卫料时，根据参数设置是否自动发料
  Cursor c_Stuff Is
    Select ID, 库房id
    From 药品收发记录 M
    Where NO = No_In And 单据 In (25, 26) And 库房id Is Not Null And 记录状态 = 1 And 审核人 Is Null And Exists
     (Select 1
           From 住院费用记录 A, 材料特性 B
           Where a.Id = m.费用id + 0 And a.记录性质 = 2 And a.记录状态 = 1 And a.No = No_In And
                 (Instr(',' || 序号_In || ',', ',' || Nvl(a.价格父号, a.序号) || ',') > 0 Or 序号_In Is Null) And
                 (a.病人id + 0 = 病人id_In Or 病人id_In Is Null) And a.收费细目id = b.材料id And b.跟踪在用 = 1)
    Order By 库房id, 药品id;
  --
  v_发料号         药品收发记录.汇总发药号%Type;
  v_库房id         药品收发记录.库房id%Type;
  v_收发ids        Varchar2(4000);
  v_医嘱ids        Varchar2(4000);
  v_Date           Date;
  n_审核标志       病案主页.审核标志%Type;
  n_住院状态       病案主页.状态%Type;
  n_病人审核方式   Number(2);
  n_未入科禁止记账 Number(2);
  n_病人id         病案主页.病人id%Type;
  n_主页id         病案主页.主页id%Type;
  v_Err_Msg        Varchar2(500);
  Err_Item Exception;
  v_操作员编号 人员表.编号%Type;
  v_操作员姓名 人员表.姓名%Type;
  v_Temp       Varchar2(225);
Begin
  If 审核时间_In Is Null Then
    Select Sysdate Into v_Date From Dual;
  Else
    v_Date := 审核时间_In;
  End If;

 v_操作员编号 := 操作员编号_In;
  v_操作员姓名 := 操作员姓名_In;
  If v_操作员编号 Is Null Then
    v_Temp := Zl_Identity(1);
    If Not (Nvl(v_Temp, '0') = '0' Or Nvl(v_Temp, '_') = '_') Then
      v_Temp       := Substr(v_Temp, Instr(v_Temp, ';') + 1);
      v_Temp       := Substr(v_Temp, Instr(v_Temp, ',') + 1);
      v_操作员编号 := Substr(v_Temp, 1, Instr(v_Temp, ',') - 1);
      v_Temp       := Substr(v_Temp, Instr(v_Temp, ',') + 1);
      v_操作员姓名 := v_Temp;
    End If;
  End If;

  For r_Bill In c_Bill Loop
    Update 住院费用记录
    Set 记录状态 = 1, 操作员编号 = v_操作员编号, 操作员姓名 = v_操作员姓名, 登记时间 = v_Date --已产生的药品记录的时间不变
    Where ID = r_Bill.Id;
    If Nvl(n_病人id, 0) <> Nvl(r_Bill.病人id, 0) Then
      If Nvl(zl_GetSysParameter(185), 0) = 1 Then
        n_病人id := Nvl(r_Bill.病人id, 0);
        n_主页id := Nvl(r_Bill.主页id, 0);
      
        n_病人审核方式   := Nvl(zl_GetSysParameter(185), 0);
        n_未入科禁止记账 := Nvl(zl_GetSysParameter(215), 0);
        If n_病人审核方式 = 1 Or n_未入科禁止记账 = 1 Then
          Begin
            Select 审核标志, 状态
            Into n_审核标志, n_住院状态
            From 病案主页
            Where 病人id = n_病人id And 主页id = n_主页id;
          Exception
            When Others Then
              n_审核标志 := 0;
              n_住院状态 := 0;
          End;
          If n_未入科禁止记账 = 1 And n_住院状态 = 1 Then
            v_Err_Msg := '病人未入科,禁止对病人相关费用的操作!';
            Raise Err_Item;
          End If;
        
          If n_病人审核方式 = 1 Then
            If Nvl(n_审核标志, 0) = 1 Then
              v_Err_Msg := '该病人目前正在审核费用,不能进行费用相关调整!';
              Raise Err_Item;
            End If;
            If Nvl(n_审核标志, 0) = 2 Then
              v_Err_Msg := '该病人目前已经完成了费用审核,不能进行费用相关调整!';
              Raise Err_Item;
            End If;
          End If;
        End If;
      End If;
    
    End If;
  
    --药品收发记录.填制日期
    Update 药品收发记录
    Set 填制日期 = Decode(Sign(Nvl(审核日期, v_Date) - v_Date), -1, 填制日期, v_Date)
    Where NO = No_In And 单据 In (9, 10, 25, 26) And 费用id = r_Bill.Id;
  
    --病人余额
    Update 病人余额
    Set 费用余额 = Nvl(费用余额, 0) + Nvl(r_Bill.实收金额, 0)
    Where 病人id = r_Bill.病人id And 性质 = 1 And 类型 = 2;
  
    If Sql%RowCount = 0 Then
      Insert Into 病人余额 (病人id, 性质, 类型, 费用余额, 预交余额) Values (r_Bill.病人id, 1, 2, r_Bill.实收金额, 0);
    End If;
  
    --病人未结费用
    Update 病人未结费用
    Set 金额 = Nvl(金额, 0) + Nvl(r_Bill.实收金额, 0)
    Where 病人id = r_Bill.病人id And Nvl(主页id, 0) = Nvl(r_Bill.主页id, 0) And Nvl(病人病区id, 0) = Nvl(r_Bill.病人病区id, 0) And
          Nvl(病人科室id, 0) = Nvl(r_Bill.病人科室id, 0) And Nvl(开单部门id, 0) = Nvl(r_Bill.开单部门id, 0) And
          Nvl(执行部门id, 0) = Nvl(r_Bill.执行部门id, 0) And 收入项目id + 0 = r_Bill.收入项目id And 来源途径 + 0 = r_Bill.门诊标志;
  
    If Sql%RowCount = 0 Then
      Insert Into 病人未结费用
        (病人id, 主页id, 病人病区id, 病人科室id, 开单部门id, 执行部门id, 收入项目id, 来源途径, 金额)
      Values
        (r_Bill.病人id, r_Bill.主页id, r_Bill.病人病区id, r_Bill.病人科室id, r_Bill.开单部门id, r_Bill.执行部门id, r_Bill.收入项目id,
         r_Bill.门诊标志, Nvl(r_Bill.实收金额, 0));
    End If;
  
    If r_Bill.医嘱序号 Is Not Null Then
      v_医嘱ids := v_医嘱ids || ',' || r_Bill.医嘱序号;
    End If;
  End Loop;

  --处理医嘱发送计费状态
  If v_医嘱ids Is Not Null Then
    v_医嘱ids := Substr(v_医嘱ids, 2);
    Zl_医嘱发送_计费状态_Update(1, 2, 1, No_In, v_医嘱ids);
  End If;

  --库房中的药品已全部审核则标为已收费
  Update 未发药品记录
  Set 已收费 = 1, 填制日期 = v_Date
  Where NO = No_In And 单据 In (9, 10) And Nvl(已收费, 0) = 0 And
        Nvl(库房id, 0) Not In
        (Select Distinct Nvl(执行部门id, 0)
         From 住院费用记录
         Where 记录性质 = 2 And NO = No_In And 收费类别 In ('5', '6', '7') And 记录状态 = 0);

  Update 未发药品记录
  Set 已收费 = 1, 填制日期 = v_Date
  Where NO = No_In And 单据 In (25, 26) And Nvl(已收费, 0) = 0 And
        Nvl(库房id, 0) Not In (Select Distinct Nvl(执行部门id, 0)
                             From 住院费用记录
                             Where 记录性质 = 2 And NO = No_In And 收费类别 = '4' And 记录状态 = 0);
  If zl_GetSysParameter(63) = '1' Then
  
    --处理跟踪在用卫料自动发料
    For r_Stuff In c_Stuff Loop
      If v_发料号 Is Null Then
        v_发料号 := Nextno(20);
      End If;
    
      If r_Stuff.库房id <> Nvl(v_库房id, 0) Then
        If Nvl(v_库房id, 0) <> 0 And v_收发ids Is Not Null Then
          v_收发ids := Substr(v_收发ids, 2);
          Zl_药品收发记录_批量发料(v_收发ids, v_库房id, v_操作员姓名, Sysdate, 1, v_操作员姓名, v_发料号, v_操作员姓名);
        End If;
      
        v_库房id  := r_Stuff.库房id;
        v_收发ids := Null;
      End If;
    
      v_收发ids := v_收发ids || '|' || r_Stuff.Id || ',0';
    End Loop;
    If Nvl(v_库房id, 0) <> 0 And v_收发ids Is Not Null Then
      v_收发ids := Substr(v_收发ids, 2);
      Zl_药品收发记录_批量发料(v_收发ids, v_库房id, v_操作员姓名, Sysdate, 1, v_操作员姓名, v_发料号, v_操作员姓名);
    End If;
  End If;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_住院记帐记录_Verify;
/

--113899:刘涛,2017-09-05,修改卫材盘点的修改功能
Create Or Replace Procedure Zl_材料盘点_Insert
(
  No_In         In 药品收发记录.NO%Type,
  序号_In       In 药品收发记录.序号%Type,
  库房id_In     In 药品收发记录.库房id%Type,
  批次_In       In 药品收发记录.批次%Type,
  入出类别id_In In 药品收发记录.入出类别id%Type,
  入出系数_In   In 药品收发记录.入出系数%Type,
  材料id_In     In 药品收发记录.药品id%Type,
  帐面数量_In   In 药品收发记录.填写数量%Type,
  实盘数量_In   In 药品收发记录.扣率%Type,
  数量差_In     In 药品收发记录.实际数量%Type,
  成本价_In     In 药品收发记录.成本价%Type,
  售价_In       In 药品收发记录.零售价%Type,
  金额差_In     In 药品收发记录.零售金额%Type,
  差价差_In     In 药品收发记录.差价%Type,
  填制人_In     In 药品收发记录.填制人%Type,
  填制日期_In   In 药品收发记录.填制日期%Type,
  摘要_In       In 药品收发记录.摘要%Type := Null,
  产地_In       In 药品收发记录.产地%Type := Null,
  批号_In       In 药品收发记录.批号%Type := Null,
  效期_In       In 药品收发记录.效期%Type := Null,
  盘点时间_In   In 药品收发记录.频次%Type := Null,
  库存金额_In   In 药品收发记录.成本价%Type := Null,
  库存差价_In   In 药品收发记录.成本金额%Type := Null,
  新批次_In     In Number := 0
) Is
  n_Id           药品收发记录.ID%Type;
  n_成本价       药品库存.上次采购价%Type;
  n_上次供应商id 药品库存.上次供应商id%Type;
  n_实价卫材     收费项目目录.是否变价%Type;

  d_灭菌效期     药品库存.灭菌效期%Type;
  d_上次生产日期 药品库存.上次生产日期%Type;
  v_批准文号     药品库存.批准文号%Type;

Begin
  --如果批次_IN为-1,则表示新产生一个批次材料
  Select 药品收发记录_Id.Nextval Into n_Id From Dual;

  Begin
    Select Decode(上次供应商id, 0, Null, 上次供应商id), 上次生产日期, 批准文号, 灭菌效期
    Into n_上次供应商id, d_上次生产日期, v_批准文号, d_灭菌效期
    From 药品库存
    Where 药品id = 材料id_In And Nvl(批次, 0) = Nvl(批次_In, 0) And 库房id = 库房id_In And 性质 = 1 And Rownum = 1;
  Exception
    When Others Then
      n_上次供应商id := Null;
      d_上次生产日期 := Null;
      v_批准文号     := Null;

  End;

  Insert Into 药品收发记录
    (ID, 记录状态, 单据, NO, 序号, 库房id, 入出类别id, 入出系数, 药品id, 批次, 产地, 批号, 效期, 填写数量, 扣率,
     实际数量, 零售价, 零售金额, 差价, 摘要, 填制人, 填制日期, 频次, 成本价, 成本金额, 供药单位id, 生产日期, 批准文号,
     灭菌效期, 单量,发药方式)
  Values
    (n_Id, 1, 22, No_In, 序号_In, 库房id_In, 入出类别id_In, 入出系数_In, 材料id_In, Decode(批次_In, -1, n_Id, 批次_In),
     产地_In, 批号_In, 效期_In, 帐面数量_In, 实盘数量_In, 数量差_In, 售价_In, 金额差_In, 差价差_In, 摘要_In, 填制人_In,
     填制日期_In, 盘点时间_In, 库存金额_In, 库存差价_In, n_上次供应商id, d_上次生产日期, v_批准文号, d_灭菌效期,
     成本价_In,新批次_In);

  If 入出系数_In = -1 Then
    --同时更新库存数
    Update 药品库存
    Set 可用数量 = Nvl(可用数量, 0) - 数量差_In
    Where 库房id = 库房id_In And 药品id = 材料id_In And Nvl(批次, 0) = Nvl(批次_In, 0) And 性质 = 1;
    If Sql%NotFound Then

      If Nvl(数量差_In, 0) <> 0 Then
        n_成本价 := Round((金额差_In - 差价差_In) / 数量差_In, 7);
      Else
        n_成本价 := 0;
      End If;
      Select 是否变价 Into n_实价卫材 From 收费项目目录 Where ID = 材料id_In;

      Insert Into 药品库存
        (库房id, 药品id, 批次, 性质, 可用数量, 效期, 灭菌效期, 上次供应商id, 上次采购价, 上次批号, 上次生产日期,
         上次产地, 批准文号, 零售价)

      Values
        (库房id_In, 材料id_In, 批次_In, 1, -数量差_In, 效期_In, d_灭菌效期, n_上次供应商id, n_成本价, 批号_In,
         d_上次生产日期, 产地_In, v_批准文号, Decode(n_实价卫材, 1, Decode(Nvl(批次_In, 0), 0, Null, 售价_In), Null));
    End If;

    Delete From 药品库存
    Where 库房id = 库房id_In And 药品id = 材料id_In And Nvl(可用数量, 0) = 0 And Nvl(实际数量, 0) = 0 And
          Nvl(实际金额, 0) = 0 And Nvl(实际差价, 0) = 0;
  End If;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_材料盘点_Insert;
/

--101301:刘鹏飞,2017-10-13,输血申请项目历史数据抽回处理
--113707:张永康,2017-08-30,含LOB字段的表数据抽回修正
Create Or Replace Procedure Zl_Retu_Clinic
(
  n_Patiid In Number,
  v_Times  In Varchar2,
  n_Flag   In Number
) As
  --------------------------------------------
  --参数:n_Patiid,病人id
  --     v_Times,挂号单号或住院主页id（体检时，挂号单是体检单号）
  --     n_Flag,门诊或住院标志:0-门诊,1-住院,2-体检（此时，只有n_Patiid参数无效）
  --------------------------------------------
  Err_Item Exception;
  v_Err_Msg    Varchar2(100);
  n_System     Number(5);
  n_Opersystem Number(5);
  n_只读       Number(2);

  v_Table    Varchar2(100);
  v_Subtable Varchar2(100);
  v_Field    Varchar2(100);
  v_Subfield Varchar2(100);
  v_Sql      Varchar2(4000);
  v_Sqlchild Varchar2(4000);
  v_Fields   Varchar2(4000);

  v_Dblink Varchar2(30);
  
  Type t_Tab_Col Is Table Of Varchar2(4000) Index By Varchar2(32);
  Arr_Tab_Col t_Tab_Col;

  ---------------------------------------------
  --功能：获取表的字段字符串
  Function Getfields(v_Table In Varchar2) Return Varchar2 As
    v_Colstr Varchar2(4000);
  Begin
    If Arr_Tab_Col.Exists(v_Table) Then
      v_Colstr := Arr_Tab_Col(v_Table);
    Else
      Select f_List2str(Cast(Collect(Column_Name) As t_Strlist)) As Colsstr
      Into v_Colstr
      From (Select Column_Name From User_Tab_Columns Where Table_Name = v_Table Order By Column_Id);
    
      Arr_Tab_Col(v_Table) := v_Colstr;
    End If;
  
    Return v_Colstr;
  End Getfields;

  --------------------------------------------
  --返回指定病人ID和主页的相关表的子过程
  --------------------------------------------
  Procedure Zl_Retu_Other
  (
    n_Pati_Id 病案主页.病人id%Type,
    n_Page_Id 病案主页.主页id%Type
  ) As
  
  Begin
  
    For R In (Select Column_Value From Table(f_Str2list('病人过敏记录,病人诊断记录,病人手麻记录'))) Loop
      v_Table  := r.Column_Value;
      v_Fields := Getfields(v_Table);
      v_Sql    := 'Insert Into ' || v_Table || '(' || v_Fields || ') Select ' ||
                  Replace(v_Fields, '待转出', 'Null as 待转出') || ' From H' || v_Table || ' Where 病人id = :1 And 主页id = :2';
      Execute Immediate v_Sql
        Using n_Pati_Id, n_Page_Id;
    
      v_Sql := 'Delete From H' || v_Table || ' Where 病人id = :1 And 主页id = :2';
      Execute Immediate v_Sql
        Using n_Pati_Id, n_Page_Id;
    End Loop;
  End Zl_Retu_Other;

  --------------------------------------------
  --返回指定病人ID和主页的临床路径相关表的子过程
  --------------------------------------------
  Procedure Zl_Retu_Path
  (
    n_Pati_Id 病案主页.病人id%Type,
    n_Page_Id 病案主页.主页id%Type
  ) As
  Begin
    v_Table  := '病人临床路径';
    v_Fields := Getfields(v_Table);
    v_Sql    := 'Insert Into ' || v_Table || '(' || v_Fields || ') Select ' || Replace(v_Fields, '待转出', 'Null as 待转出') ||
                ' From H' || v_Table || ' Where 病人id = :1 And 主页id = :2 ';
    Execute Immediate v_Sql
      Using n_Pati_Id, n_Page_Id;
  
    --病人路径医嘱，在病人医嘱记录转出之后执行
    For P In (Select ID As 路径记录id From H病人临床路径 Where 病人id = n_Pati_Id And 主页id = n_Page_Id) Loop
      For R In (Select Column_Value
                From Table(f_Str2list('病人路径执行,病人合并路径,病人路径评估,病人路径变异,病人路径指标,病人合并路径评估,病人出径记录'))) Loop
        v_Table := r.Column_Value;
        If v_Table = '病人合并路径' Then
          v_Field := '首要路径记录id';
        Else
          v_Field := '路径记录id';
        End If;
      
        v_Fields := Getfields(v_Table);
        v_Sql    := 'Insert Into ' || v_Table || '(' || v_Fields || ') Select ' ||
                    Replace(v_Fields, '待转出', 'Null as 待转出') || ' From H' || v_Table || ' Where ' || v_Field || ' = :1';
        Execute Immediate v_Sql
          Using p.路径记录id;
      
        v_Sql := 'Delete H' || v_Table || ' Where ' || v_Field || ' = :1';
        Execute Immediate v_Sql
          Using p.路径记录id;
      End Loop;
    End Loop;
  
    Delete H病人临床路径 Where 病人id = n_Pati_Id And 主页id = n_Page_Id;
  End Zl_Retu_Path;

  --------------------------------------------
  --返回指定病人ID和主页的护理相关表的子过程
  --------------------------------------------
  Procedure Zl_Retu_Tend
  (
    n_Pati_Id 病案主页.病人id%Type,
    n_Page_Id 病案主页.主页id%Type
  ) As
  Begin
  
    v_Table  := '病人护理文件';
    v_Fields := Getfields(v_Table);
    v_Sql    := 'Insert Into ' || v_Table || '(' || v_Fields || ') Select ' || Replace(v_Fields, '待转出', 'Null as 待转出') ||
                ' From H' || v_Table || ' Where 病人id = :1 And 主页id = :2 ';
    Execute Immediate v_Sql
      Using n_Pati_Id, n_Page_Id;
  
    For P In (Select ID As 文件id From H病人护理文件 Where 病人id = n_Pati_Id And 主页id = n_Page_Id) Loop
      For R In (Select Column_Value
                From Table(f_Str2list('病人护理数据,病人护理打印,病人护理活动项目,病人护理要素内容,产程要素内容'))) Loop
        v_Table  := r.Column_Value;
        v_Fields := Getfields(v_Table);
        v_Sql    := 'Insert Into ' || v_Table || '(' || v_Fields || ') Select ' ||
                    Replace(v_Fields, '待转出', 'Null as 待转出') || ' From H' || v_Table || ' Where 文件id = :1';
        Execute Immediate v_Sql
          Using p.文件id;
      
        If v_Table = '病人护理数据' Then
          v_Fields := Getfields('病人护理明细');
          v_Sql    := 'Insert Into 病人护理明细(' || v_Fields || ') Select ' || Replace(v_Fields, '待转出', 'Null as 待转出') ||
                      ' From H病人护理明细 Where 记录id In (Select ID From H病人护理数据 Where 文件id = :1)';
          Execute Immediate v_Sql
            Using p.文件id;
        
          v_Sql := 'Delete H病人护理明细 Where 记录id In (Select ID From H病人护理数据 Where 文件id = :1)';
          Execute Immediate v_Sql
            Using p.文件id;
        End If;
      
        v_Sql := 'Delete H' || v_Table || ' Where 文件id = :1';
        Execute Immediate v_Sql
          Using p.文件id;
      End Loop;
    End Loop;
  
    Delete H病人护理文件 Where 病人id = n_Pati_Id And 主页id = n_Page_Id;
  
    --老版护理系统数据
    ------------------------------------------------------------------------
    v_Table  := '病人护理记录';
    v_Fields := Getfields(v_Table);
    v_Sql    := 'Insert Into ' || v_Table || '(' || v_Fields || ') Select ' || Replace(v_Fields, '待转出', 'Null as 待转出') ||
                ' From H' || v_Table || ' Where 病人id = :1 And 主页id = :2 ';
    Execute Immediate v_Sql
      Using n_Pati_Id, n_Page_Id;
  
    For P In (Select ID From H病人护理记录 Where 病人id = n_Pati_Id And 主页id = n_Page_Id) Loop
      v_Table  := '病人护理内容';
      v_Fields := Getfields(v_Table);
      v_Sql    := 'Insert Into ' || v_Table || '(' || v_Fields || ') Select ' ||
                  Replace(v_Fields, '待转出', 'Null as 待转出') || ' From H' || v_Table || ' Where 记录ID = :1';
      Execute Immediate v_Sql
        Using p.Id;
    
      v_Sql := 'Delete H' || v_Table || ' Where 记录ID = :1';
      Execute Immediate v_Sql
        Using p.Id;
    End Loop;
  
    Delete H病人护理记录 Where 病人id = n_Pati_Id And 主页id = n_Page_Id;
  End Zl_Retu_Tend;

  --------------------------------------------
  --返回指定ID的病人新版电子病历记录子过程
  --------------------------------------------
  Procedure Zl_Retu_Epr(n_Rec_Id H电子病历记录.Id%Type) As
    v_Field Varchar(100);
  Begin
    v_Table  := '电子病历记录';
    v_Fields := Getfields(v_Table);
    v_Sql    := 'Insert Into ' || v_Table || '(' || v_Fields || ') Select ' || Replace(v_Fields, '待转出', 'Null as 待转出') ||
                ' From H' || v_Table || ' Where id = :1';
    Execute Immediate v_Sql
      Using n_Rec_Id;
  
    --病人诊断记录在Zl_Retu_Other中已转回（无病历ID外键）
    --影像报告驳回,病人医嘱报告,报告查阅记录,这几张表的数据在Zl_Retu_Order中转回医嘱后再处理
    For R In (Select Column_Value
              From Table(f_Str2list('电子病历附件,电子病历格式,电子病历内容,疾病申报记录,疾病报告反馈,疾病申报反馈'))) Loop
      v_Table := r.Column_Value;
      If v_Table = '电子病历附件' Then
        v_Field := '病历id';
      Else
        v_Field := '文件id';
      End If;
      v_Fields := Getfields(v_Table);
      
    --含LOB字段的表(电子病历图形,电子病历格式,电子病历附件)，其H表是临时表，所以需直接指定dblink
      If v_Dblink Is Not Null And (v_Table = '电子病历附件' Or v_Table = '电子病历格式') Then
        v_Sql := 'Insert Into ' || v_Table || '(' || v_Fields || ') Select ' || Replace(v_Fields, '待转出', 'Null as 待转出') ||
                 ' From ' || v_Table || '@' || v_Dblink || ' Where ' || v_Field || ' = :1';
      Else
        v_Sql := 'Insert Into ' || v_Table || '(' || v_Fields || ') Select ' || Replace(v_Fields, '待转出', 'Null as 待转出') ||
                 ' From H' || v_Table || ' Where ' || v_Field || ' = :1';
      End If;
      Execute Immediate v_Sql
        Using n_Rec_Id;
    
      If v_Table = '电子病历内容' Then
        v_Fields := Getfields('电子病历图形');
      
        If v_Dblink Is Not Null Then
          v_Sql := 'Insert Into 电子病历图形(' || v_Fields || ') Select ' || Replace(v_Fields, '待转出', 'Null as 待转出') ||
                   ' From 电子病历图形@' || v_Dblink ||
                   ' a Where 对象id In (Select ID From H电子病历内容 Where 文件id = :1 And 对象类型 = 5)';
        Else
          v_Sql := 'Insert Into 电子病历图形(' || v_Fields || ') Select ' || Replace(v_Fields, '待转出', 'Null as 待转出') ||
                   ' From H电子病历图形 Where 对象id In (Select ID From H电子病历内容 Where 文件id = :1 And 对象类型 = 5)';
        End If;
        Execute Immediate v_Sql
          Using n_Rec_Id;
      
        If v_Dblink Is Not Null Then
          v_Sql := 'Delete 电子病历图形@' || v_Dblink ||
                   ' Where 对象id In (Select ID From H电子病历内容 Where 文件id = :1 And 对象类型 = 5)';
          Execute Immediate v_Sql
            Using n_Rec_Id;
        Else
          Delete H电子病历图形 Where 对象id In (Select ID From H电子病历内容 Where 文件id = n_Rec_Id And 对象类型 = 5);
        End If;
      End If;
    
      If v_Dblink Is Not Null And (v_Table = '电子病历附件' Or v_Table = '电子病历格式') Then
        v_Sql := 'Delete ' || v_Table || '@' || v_Dblink || ' Where ' || v_Field || ' = :1';
      Else
        v_Sql := 'Delete H' || v_Table || ' Where ' || v_Field || ' = :1';
      End If;
      Execute Immediate v_Sql
        Using n_Rec_Id;
    End Loop;
  
    Delete H电子病历记录 Where ID = n_Rec_Id;
  End Zl_Retu_Epr;

  --------------------------------------------
  --返回指定ID的病人医嘱记录子过程，必须在病历、临床路径转出之后执行(病人医嘱报告,影像报告驳回，病人路径医嘱)
  --在Zl_Retu_Other中已转回了"病人诊断记录",转回"病人诊断医嘱"时不用再转
  --------------------------------------------
  Procedure Zl_Retu_Order(n_Rec_Id H病人医嘱记录.Id%Type) As
  Begin
    v_Table  := '病人医嘱记录';
    v_Fields := Getfields(v_Table);
    v_Sql    := 'Insert Into ' || v_Table || '(' || v_Fields || ') Select ' || Replace(v_Fields, '待转出', 'Null as 待转出') ||
                ' From H' || v_Table || ' Where id = :1';
    Execute Immediate v_Sql
      Using n_Rec_Id;
  
    --以"医嘱ID,发送号"为外键的，都按医嘱ID直接转回，只需要排在"病人医嘱发送"之后即可
    --由于外键关系，"报告查阅记录"须在"病人医嘱报告"后面
    For P In (Select Column_Value
              From Table(f_Str2list('病人医嘱计价,病人医嘱状态,病人医嘱发送,病人医嘱附费,病人医嘱附件,病人医嘱执行,病人医嘱打印,输血申请记录,输血检验结果,输血申请项目,' ||
                                     '医嘱执行打印,医嘱执行时间,医嘱执行计价,执行打印记录,病人诊断医嘱,病人路径医嘱,病人医嘱报告,报告查阅记录,' ||
                                     '影像报告驳回,影像报告记录,影像报告操作记录,影像检查记录,影像申请单图像,影像收藏内容,影像危急值记录,检验标本记录,检验试剂记录,检验拒收记录,疾病阳性记录'))) Loop
      v_Table := p.Column_Value;
      If Instr('病人路径医嘱', v_Table) > 0 Then
        v_Field := '病人医嘱ID';
      Else
        v_Field := '医嘱ID';
      End If;
    
      v_Fields := Getfields(v_Table);
      v_Sql    := 'Insert Into ' || v_Table || '(' || v_Fields || ') Select ' ||
                  Replace(v_Fields, '待转出', 'Null as 待转出') || ' From H' || v_Table || ' Where ' || v_Field || ' = :1';
      If v_Table = '病人医嘱状态' Or v_Table = '病人医嘱报告' Then
        v_Sqlchild := v_Sql;
      Else
        Execute Immediate v_Sql
          Using n_Rec_Id;
      End If;
    
      If v_Table = '病人医嘱状态' Then
        v_Fields := Getfields('医嘱签名记录');
        v_Sql    := 'Insert Into 医嘱签名记录(' || v_Fields || ') Select ' || Replace(v_Fields, '待转出', 'Null as 待转出') ||
                    ' From H医嘱签名记录 Where ID In (Select 签名id From H病人医嘱状态 Where 医嘱id = :1 And 签名id Is Not Null)';
        Execute Immediate v_Sql
          Using n_Rec_Id;
        Delete H医嘱签名记录
        Where ID In (Select 签名id From H病人医嘱状态 Where 医嘱id = n_Rec_Id And 签名id Is Not Null);
      
        Execute Immediate v_Sqlchild
          Using n_Rec_Id;
      
      Elsif v_Table = '病人医嘱发送' Then
        v_Fields := Getfields('诊疗单据打印');
        v_Sql    := 'Insert Into 诊疗单据打印(' || v_Fields || ') Select ' || Replace(v_Fields, '待转出', 'Null as 待转出') ||
                    ' From H诊疗单据打印 Where (NO, 记录性质) In (Select NO, 记录性质 From H病人医嘱发送 Where 医嘱id = :1)';
        Execute Immediate v_Sql
          Using n_Rec_Id;
        Delete H诊疗单据打印 Where (NO, 记录性质) In (Select NO, 记录性质 From H病人医嘱发送 Where 医嘱id = n_Rec_Id);
      
      Elsif v_Table = '影像检查记录' Then
        v_Fields := Getfields('影像检查序列');
        v_Sql    := 'Insert Into 影像检查序列(' || v_Fields || ') Select ' || Replace(v_Fields, '待转出', 'Null as 待转出') ||
                    ' From H影像检查序列 Where 检查uid In (Select 检查uid From H影像检查记录 Where 医嘱id = :1)';
        Execute Immediate v_Sql
          Using n_Rec_Id;
      
        v_Fields := Getfields('影像检查图象');
        v_Sql    := 'Insert Into 影像检查图象(' || v_Fields || ') Select ' || Replace(v_Fields, '待转出', 'Null as 待转出') ||
                    ' From H影像检查图象 Where 序列uid In (Select b.序列uid From H影像检查记录 A, H影像检查序列 B Where a.医嘱id = :1 And a.检查uid = b.检查uid)';
        Execute Immediate v_Sql
          Using n_Rec_Id;
      
        Delete H影像检查图象
        Where 序列uid In (Select b.序列uid
                        From H影像检查记录 A, H影像检查序列 B
                        Where a.医嘱id = n_Rec_Id And a.检查uid = b.检查uid);
        Delete H影像检查序列 Where 检查uid In (Select 检查uid From H影像检查记录 Where 医嘱id = n_Rec_Id);
      
      Elsif v_Table = '检验标本记录' Then
        For R In (Select Column_Value
                  From Table(f_Str2list('检验申请项目,检验分析记录,检验项目分布,检验质控记录,检验操作记录,检验签名记录,检验图像结果'))) Loop
          v_Subtable := r.Column_Value;
          If v_Subtable = '检验签名记录' Then
            v_Subfield := '检验标本ID';
          Else
            v_Subfield := '标本ID';
          End If;
          v_Fields := Getfields(v_Subtable);
          v_Sql    := 'Insert Into ' || v_Subtable || '(' || v_Fields || ') Select ' ||
                      Replace(v_Fields, '待转出', 'Null as 待转出') || ' From H' || v_Subtable || ' Where ' || v_Subfield ||
                      ' In (Select ID From H检验标本记录 Where 医嘱id = :1)';
          Execute Immediate v_Sql
            Using n_Rec_Id;
        
          v_Sql := 'Delete H' || v_Subtable || ' Where ' || v_Subfield ||
                   ' In (Select ID From H检验标本记录 Where 医嘱id = :1)';
          Execute Immediate v_Sql
            Using n_Rec_Id;
        End Loop;
      
        v_Fields := Getfields('检验普通结果');
        v_Sql    := 'Insert Into 检验普通结果(' || v_Fields || ') Select ' || Replace(v_Fields, '待转出', 'Null as 待转出') ||
                    ' From H检验普通结果 Where 检验标本id In (Select ID From H检验标本记录 Where 医嘱id = :1)';
        Execute Immediate v_Sql
          Using n_Rec_Id;
      
        v_Fields := Getfields('检验药敏结果');
        v_Sql    := 'Insert Into 检验药敏结果(' || v_Fields || ') Select ' || Replace(v_Fields, '待转出', 'Null as 待转出') ||
                    ' From H检验药敏结果 Where 细菌结果id In (Select ID From H检验普通结果 Where 检验标本id In (Select ID From H检验标本记录 Where 医嘱id = :1))';
        Execute Immediate v_Sql
          Using n_Rec_Id;
      
        v_Fields := Getfields('检验质控报告');
        v_Sql    := 'Insert Into 检验质控报告(' || v_Fields || ') Select ' || Replace(v_Fields, '待转出', 'Null as 待转出') ||
                    ' From H检验质控报告 Where 结果ID In (Select ID From H检验普通结果 Where 检验标本id In (Select ID From H检验标本记录 Where 医嘱id = :1))';
        Execute Immediate v_Sql
          Using n_Rec_Id;
      
        Delete H检验药敏结果
        Where 细菌结果id In
              (Select ID From H检验普通结果 Where 检验标本id In (Select ID From H检验标本记录 Where 医嘱id = n_Rec_Id));
        Delete H检验质控报告
        Where 结果id In
              (Select ID From H检验普通结果 Where 检验标本id In (Select ID From H检验标本记录 Where 医嘱id = n_Rec_Id));
      
        Delete H检验普通结果 Where 检验标本id In (Select ID From H检验标本记录 Where 医嘱id = n_Rec_Id);
      Elsif v_Table = '病人医嘱报告' Then
        v_Fields := Getfields('医嘱报告内容');
        v_Sql    := 'Insert Into 医嘱报告内容(' || v_Fields || ') Select ' || Replace(v_Fields, '待转出', 'Null as 待转出') ||
                    ' From H医嘱报告内容 Where ID In (Select 报告id From H病人医嘱报告 Where 医嘱id = :1 And 报告id Is Not Null)';
        Execute Immediate v_Sql
          Using n_Rec_Id;
      
        Delete H医嘱报告内容
        Where ID In (Select 报告id From H病人医嘱报告 Where 医嘱id = n_Rec_Id And 报告id Is Not Null);
      
        Execute Immediate v_Sqlchild
          Using n_Rec_Id;
      End If;
    
      v_Sql := 'Delete H' || v_Table || ' Where ' || v_Field || ' = :1';
      Execute Immediate v_Sql
        Using n_Rec_Id;
    End Loop;
  
    --手麻数据
    If n_Opersystem > 0 Then
      Execute Immediate 'Call zl24_Retu_Oper(:1)'
        Using n_Rec_Id;
    End If;
  
    Delete H病人医嘱记录 Where ID = n_Rec_Id;
  End Zl_Retu_Order;

  --------------------------------------------
  --以下为主程序体
  --------------------------------------------
Begin
  ----------------------------------------------------------------------------------------------------------
  --对基于视图的转储方案进行了只读判断.
  Select 编号 Into n_System From zlSystems Where Upper(所有者) = Zl_Owner And 编号 Like '1%';
  Begin
    Select Nvl(只读, 0) Into n_只读 From zlBakSpaces Where 系统 = n_System And 当前 = 1;
  Exception
    When Others Then
      v_Err_Msg := '[ZLSOFT]当前没有可用的历史数据空间,不能继续![ZLSOFT]';
      Raise Err_Item;
  End;
  If n_只读 = 1 Then
    v_Err_Msg := '[ZLSOFT]历史数据空间目前的状态为只读,不能继续![ZLSOFT]';
    Raise Err_Item;
  End If;

  Select Max(Db连接) Into v_Dblink From zlBakSpaces Where 系统 = 100 And 当前 = 1;

  --对基于视图的转储方案进行了只读判断.
  n_Opersystem := 0;
  Select 编号 Into n_Opersystem From zlSystems Where Upper(所有者) = Zl_Owner And 编号 Like '24%';
  If n_Opersystem > 0 Then
    Begin
      Select Nvl(只读, 0) Into n_只读 From zlBakSpaces Where 系统 = n_Opersystem And 当前 = 1;
    Exception
      When Others Then
        v_Err_Msg := '[ZLSOFT]当前没有可用的手麻子系统历史数据空间,不能继续![ZLSOFT]';
        Raise Err_Item;
    End;
    If n_只读 = 1 Then
      v_Err_Msg := '[ZLSOFT]手麻子系统历史数据空间目前的状态为只读,不能继续![ZLSOFT]';
      Raise Err_Item;
    End If;
  End If;

  --1.门诊病人，按挂号单抽回
  If n_Flag = 0 Then
    --抽回未结记帐费用
    Zl_Retu_Exes(n_Patiid, 8);
  
    v_Table  := '病人挂号记录';
    v_Fields := Getfields(v_Table);
    v_Sql    := 'Insert Into ' || v_Table || '(' || v_Fields || ') Select ' || Replace(v_Fields, '待转出', 'Null as 待转出') ||
                ' From H' || v_Table || ' Where NO =:1 ';
    Execute Immediate v_Sql
      Using v_Times;
  
    For r_Other In (Select ID, 病人id From H病人挂号记录 Where NO = v_Times) Loop
      Zl_Retu_Other(r_Other.病人id, r_Other.Id);
    End Loop;
  
    For r_Epr In (Select b.Id
                  From H病人挂号记录 A, H电子病历记录 B
                  Where a.No = v_Times And a.病人id = n_Patiid And b.病人id = a.病人id And b.主页id = a.Id) Loop
      Zl_Retu_Epr(r_Epr.Id);
    End Loop;
  
    For r_Order In (Select ID From H病人医嘱记录 Where 病人来源 <> 4 And 病人id = n_Patiid And 挂号单 = v_Times) Loop
      Zl_Retu_Order(r_Order.Id);
    End Loop;
  
    --转诊记录
    v_Table  := '病人转诊记录';
    v_Fields := Getfields(v_Table);
    v_Sql    := 'Insert Into ' || v_Table || '(' || v_Fields || ') Select ' || Replace(v_Fields, '待转出', 'Null as 待转出') ||
                ' From H' || v_Table || ' Where NO =:1';
    Execute Immediate v_Sql
      Using v_Times;
  
    Delete H病人转诊记录 Where NO = v_Times;
    Delete H病人挂号记录 Where NO = v_Times;
  
    --2.住院病人，按病人ID和主页ID抽回
  Elsif n_Flag = 1 Then
    --抽回未结记帐费用
    Zl_Retu_Exes(n_Patiid || ',' || v_Times, 8);
  
    Zl_Retu_Other(n_Patiid, To_Number(v_Times));
    Zl_Retu_Path(n_Patiid, To_Number(v_Times));
  
    --先转病历，再转医嘱（影像报告驳回，病人医嘱报告这类又有病历又有医嘱的子表，在医嘱转回后处理）
    For r_Epr In (Select ID From H电子病历记录 Where 病人id = n_Patiid And 主页id = To_Number(v_Times)) Loop
      Zl_Retu_Epr(r_Epr.Id);
    End Loop;
  
    Zl_Retu_Tend(n_Patiid, To_Number(v_Times));
  
    For r_Order In (Select ID From H病人医嘱记录 Where 病人id = n_Patiid And 主页id = To_Number(v_Times)) Loop
      Zl_Retu_Order(r_Order.Id);
    End Loop;
    Update 病案主页 Set 数据转出 = 0 Where 病人id = n_Patiid And 主页id = To_Number(v_Times);
  
    --3.体检病人
  Elsif n_Flag = 2 Then
    Zl_Retu_Other(n_Patiid, v_Times);
  
    For r_Cpr In (Select ID From H病人医嘱记录 Where 病人来源 = 4 And 挂号单 = v_Times) Loop
      Zl_Retu_Order(r_Cpr.Id);
    End Loop;
  End If;

Exception
  When Err_Item Then
    Raise_Application_Error(-20101, v_Err_Msg);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM || ':' || v_Sql);
End Zl_Retu_Clinic;
/


--112852:焦博,2017-08-28,服务窗预约时，根据预约的时间去计算预约费用
Create Or Replace Procedure Zl_Third_Getregfeedetail
(
  Xml_In  In Xmltype,
  Xml_Out In Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:获取挂号费用明细
  --入参:Xml_In:
  --<IN>
  --  <BRID></BRID> //病人ID
  --  <XM></XM>     //姓名
  --  <SFZH></SFZH> //身份证号
  --  <SFYY></SFYY> //是否仅预约不支付,1-仅预约不支付,0-挂号,预约支付,预约接收，默认为0
  --  <GHDH></GHDH> //挂号单号,预约接收时传入
  --  <GHHM></GHHM> //挂号安排号码,挂号和预约时传入
  --  <XMID></XMID> //挂号安排的项目ID,挂号和预约时传入
  --  <FB></FB>     //病人费别
  --  <RQ></RQ>     //日期
  --  <ZD></ZD>     //站点
  --</IN>
  --出参:Xml_Out
  -- <OUTPUT>
  --  <ZJE></ZJE>   //总实收金额
  --  <XMMX>        //项目明细
  --    <XM>
  --      <DJH></DJH>       //单据号
  --      <MC></MC>   //项目名称
  --      <ID></ID>   //项目ID
  --      <SL></SL>   //数量，数次*付数
  --      <YSJE></YSJE>   //应收金额
  --      <SSJE></SSJE>   //实收金额
  --      <SJFM></SJFM>       //收据费目
  --    </XM>
  --    <XM>
  --    ...
  --    </XM>
  --  </XMMX>
  -- </OUTPUT>

  --------------------------------------------------------------------------------------------------
  x_Templet    Xmltype; --模板XML
  v_Err_Msg    Varchar2(200);
  v_Temp       Varchar2(4000);
  n_项目id     挂号安排.项目id%Type;
  v_No         门诊费用记录.No%Type;
  n_预约       Number(3);
  n_病人id     病人信息.病人id%Type;
  v_姓名       病人信息.姓名%Type;
  v_身份证号   病人信息.身份证号%Type;
  v_费别       病人信息.费别%Type;
  d_日期       Date;
  v_站点       部门表.站点%Type;
  v_号码       挂号安排.号码%Type;
  n_总金额     门诊费用记录.实收金额%Type;
  n_实收金额   门诊费用记录.实收金额%Type;
  v_实收       Varchar(500);
  v_附加项目id Varchar2(500);
  Err_Item Exception;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');
  Select Extractvalue(Value(A), 'IN/BRID'), Extractvalue(Value(A), 'IN/XMID'), Extractvalue(Value(A), 'IN/GHHM'),
         Extractvalue(Value(A), 'IN/FB'), Extractvalue(Value(A), 'IN/ZD'), Extractvalue(Value(A), 'IN/SFYY'),
         Extractvalue(Value(A), 'IN/GHDH'), Extractvalue(Value(A), 'IN/SFZH'), Extractvalue(Value(A), 'IN/XM'),
         To_Date(Extractvalue(Value(A), 'IN/RQ'), 'yyyy-mm-dd hh24:mi:ss')
  Into n_病人id, n_项目id, v_号码, v_费别, v_站点, n_预约, v_No, v_身份证号, v_姓名, d_日期
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;

  If Nvl(n_病人id, 0) = 0 And Not v_身份证号 Is Null And Not v_姓名 Is Null Then
    n_病人id := Zl_Third_Getpatiid(v_身份证号, v_姓名);
  End If;
  If Nvl(n_病人id, 0) = 0 Then
    v_Err_Msg := '无法确定病人信息,请检查';
    Raise Err_Item;
  End If;

  n_总金额 := 0;
  If v_No Is Null Then
    --挂号或者预约
    For c_挂号项目 In (Select 1 As 性质, a.类别, a.Id As 项目id, a.名称 As 项目名称, a.编码 As 项目编码, a.计算单位, a.屏蔽费别, 1 As 数次,
                          c.Id As 收入项目id, c.名称 As 收入项目, c.编码 As 收入编码, c.收据费目, b.现价 As 单价, -1 As 执行科室类型
                   From 收费项目目录 A, 收费价目 B, 收入项目 C
                   Where b.收费细目id = a.Id And b.收入项目id = c.Id And a.Id = n_项目id And d_日期 Between b.执行日期 And
                         Nvl(b.终止日期, To_Date('3000-1-1', 'YYYY-MM-DD'))
                   Union All
                   Select 2 As 性质, a.类别, a.Id As 项目id, a.名称 As 项目名称, a.编码 As 项目编码, a.计算单位, a.屏蔽费别, d.从项数次 As 数次,
                          c.Id As 收入项目id, c.名称 As 收入项目, c.编码 As 收入编码, c.收据费目, b.现价 As 单价, -1 As 执行科室类型
                   From 收费项目目录 A, 收费价目 B, 收入项目 C, 收费从属项目 D
                   Where b.收费细目id = a.Id And b.收入项目id = c.Id And a.Id = d.从项id And d.主项id = n_项目id And
                         d_日期 Between b.执行日期 And Nvl(b.终止日期, To_Date('3000-1-1', 'YYYY-MM-DD'))) Loop
      v_实收     := Zl_Actualmoney(v_费别, c_挂号项目.项目id, c_挂号项目.收入项目id, c_挂号项目.数次 * c_挂号项目.单价);
      n_实收金额 := To_Number(Substr(v_实收, Instr(v_实收, ':') + 1));
      n_总金额   := n_总金额 + Nvl(n_实收金额, 0);
      v_Temp     := v_Temp || '<XM><DJH></DJH><MC>' || c_挂号项目.项目名称 || '</MC>' || '<ID>' || c_挂号项目.项目id || '</ID>' ||
                    '<SL>' || c_挂号项目.数次 || '</SL>' || '<YSJE>' || c_挂号项目.数次 * c_挂号项目.单价 || '</YSJE>' || '<SSJE>' ||
                    n_实收金额 || '</SSJE>' || '<SJFM>' || c_挂号项目.收据费目 || '</SJFM></XM>';
    End Loop;
  Else
    --预约接收
    For c_挂号项目 In (Select a.收费细目id As 项目id, a.应收金额, a.实收金额, a.计算单位, a.收据费目, b.名称 As 项目名称, a.No, Nvl(a.付数, 1) As 付数, a.数次
                   From 门诊费用记录 A, 收费项目目录 B
                   Where a.收费细目id = b.Id And a.No = v_No And a.记录性质 = 4 And a.记录状态 = 0) Loop
      n_总金额 := n_总金额 + Nvl(c_挂号项目.实收金额, 0);
      v_号码   := c_挂号项目.计算单位;
      v_Temp   := v_Temp || '<XM><DJH>' || c_挂号项目.No || '</DJH><MC>' || c_挂号项目.项目名称 || '</MC>' || '<ID>' || c_挂号项目.项目id ||
                  '</ID>' || '<SL>' || c_挂号项目.付数 * c_挂号项目.数次 || '</SL>' || '<YSJE>' || c_挂号项目.应收金额 || '</YSJE>' ||
                  '<SSJE>' || c_挂号项目.实收金额 || '</SSJE>' || '<SJFM>' || c_挂号项目.收据费目 || '</SJFM></XM>';
    End Loop;
  End If;

  If Nvl(n_预约, 0) = 0 Then
    Begin
      Select Zl_Fun_Customregexpenses(n_病人id, 0, v_号码) Into v_附加项目id From Dual;
    Exception
      When Others Then
        v_附加项目id := Null;
    End;
    If v_附加项目id Is Not Null Then
      For c_附加项目 In (Select /*+cardinality(D,10)*/
                      5 As 性质, a.类别, a.Id As 项目id, a.名称 As 项目名称, a.编码 As 项目编码, a.计算单位, a.屏蔽费别, 1 As 数次, c.Id As 收入项目id,
                      c.名称 As 收入项目, c.编码 As 收入编码, c.收据费目, b.现价 As 单价, -1 As 执行科室类型
                     From 收费项目目录 A, 收费价目 B, 收入项目 C, Table(f_Str2list(v_附加项目id)) D
                     Where b.收费细目id = a.Id And b.收入项目id = c.Id And a.Id = d.Column_Value And d_日期 Between b.执行日期 And
                           Nvl(b.终止日期, To_Date('3000-1-1', 'YYYY-MM-DD'))
                     Union All
                     Select /*+cardinality(E,10)*/
                      5 As 性质, a.类别, a.Id As 项目id, a.名称 As 项目名称, a.编码 As 项目编码, a.计算单位, a.屏蔽费别, d.从项数次 As 数次,
                      c.Id As 收入项目id, c.名称 As 收入项目, c.编码 As 收入编码, c.收据费目, b.现价 As 单价, -1 As 执行科室类型
                     From 收费项目目录 A, 收费价目 B, 收入项目 C, 收费从属项目 D, Table(f_Str2list(v_附加项目id)) E
                     Where b.收费细目id = a.Id And b.收入项目id = c.Id And a.Id = d.从项id And d.主项id = e.Column_Value And
                           d_日期 Between b.执行日期 And Nvl(b.终止日期, To_Date('3000-1-1', 'YYYY-MM-DD'))) Loop
        v_实收     := Zl_Actualmoney(v_费别, c_附加项目.项目id, c_附加项目.收入项目id, c_附加项目.数次 * c_附加项目.单价);
        n_实收金额 := To_Number(Substr(v_实收, Instr(v_实收, ':') + 1));
        n_总金额   := n_总金额 + Nvl(n_实收金额, 0);
        v_Temp     := v_Temp || '<XM><DJH></DJH><MC>' || c_附加项目.项目名称 || '</MC>' || '<ID>' || c_附加项目.项目id || '</ID>' ||
                      '<SL>' || c_附加项目.数次 || '</SL>' || '<YSJE>' || c_附加项目.数次 * c_附加项目.单价 || '</YSJE>' || '<SSJE>' ||
                      n_实收金额 || '</SSJE>' || '<SJFM>' || c_附加项目.收据费目 || '</SJFM></XM>';
      End Loop;
    End If;
  End If;

  v_Temp := '<XMMX>' || v_Temp || '</XMMX>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

  v_Temp := '<ZJE>' || n_总金额 || '</ZJE>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;

  Xml_Out := x_Templet;
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getregfeedetail;
/

--112852:焦博,2017-08-28,服务窗预约时，根据预约的时间去计算预约费用
Create Or Replace Procedure Zl_Third_Getnolist
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:获取号源列表(简易模式)
  --入参:Xml_In:
  --<IN>
  --  <RQ>日期</RQ>
  --  <KSID>科室ID</KSID>
  --  <YSID>医生ID</YSID>
  --  <YSXM>医生姓名</YSXM>
  --  <HZDW>支付宝</HZDW>    //合作单位，传入了的时候，只取合作单位的号;为空时，只取非合作单位的号
  --  <SJJG>60</SJJG>     //时间间隔,不传则返回序号时段
  --</IN>

  --出参:Xml_Out
  --<OUTPUT>
  --  <GROUP>
  --    <RQ>日期</RQ>
  --    <HBLIST>
  --     <HB>
  --        <CZJLID>1</CZJLID>     //出诊记录ID
  --        <HM>235</HM>       //号码
  --        <YSID>549</YSID>      //医生ID
  --        <YS>张锐</YS>       //医生姓名
  --        <KSID>123</KSID>   //科室ID
  --        <KSMC>内科</KSMC>   //科室名称
  --        <ZC>主治医师</ZC> //职称
  --        <XMID>10086<XMID> //挂号项目的ID
  --        <XMMC>挂号费</XMMC> //挂号项目的名称
  --        <YGHS>0</YGHS>      //已挂号数
  --        <SYHS>99</SYHS>   //剩余号数
  --        <PRICE>15</PRICE>      //价格
  --        <HL>普通</HL>       //挂号类型
  --        <HCXH>1</HCXH>    //是否存在缓冲序号时间段，1-存在 0或者空-不存在
  --        <FSD>0</FSD>      //是否分时段
  --        <FWMC>白天</FWMC>     //号别时段
  --        <HBTIME>(08:00-17:59)</HBTIME> //可挂时间
  --     <SPANLIST>
  --            <SPAN>
  --                  <SJD></SJD>          //时间段,格式:hh24:mi-hh24:mi
  --                  <GHZS></GHZS>      //时段挂号总数
  --                  <SL></SL>      //剩余数量
  --            </SPAN>
  --            ……
  --          </SPANLIST>
  --      </HB>
  --      <HB>
  --      ……
  --      </HB>
  --    </HBLIST>
  --  </GROUP>
  --</OUTPUT>
  --------------------------------------------------------------------------------------------------
  d_日期         Date;
  n_科室id       病人挂号记录.执行部门id%Type;
  n_医生id       人员表.Id%Type;
  v_医生姓名     人员表.姓名%Type;
  v_星期         挂号安排限制.限制项目%Type;
  v_时间段       Varchar2(100);
  v_合作单位     挂号合作单位.名称%Type;
  n_分时段       Number(3);
  n_单个剩余     Number(5);
  n_已挂数       Number(5);
  n_合约已挂数   Number(5);
  n_合计金额     收费价目.现价%Type;
  n_合约总数量   Number(5);
  n_合约剩余数量 Number(5);
  n_最大可用数量 Number(5);
  n_合约模式     Number(3); --合约模式:1-合约单位限数量模式 0-合约单位指定序号模式
  n_非合约       Number(3);
  n_是否预留     Number(3);
  d_加号时间     Date;
  d_开始时间     临床出诊记录.开始时间%Type;
  d_终止时间     临床出诊记录.终止时间%Type;
  n_缓冲序号     Number(3);
  n_时段数量     Number(5);
  n_序号控制     临床出诊记录.是否序号控制%Type;
  n_预留数量     Number(5);
  n_特殊预约     Number(3);
  n_禁用         Number(3);
  v_剩余数量     Varchar2(100);
  v_Timetemp     Varchar2(100);
  v_Temp         Varchar2(32767); --临时XML
  v_Xmlmain      Clob; --临时XML
  c_Xmlmain      Clob; --临时XML
  x_Templet      Xmltype; --模板XML
  v_Err_Msg      Varchar2(200);
  n_Exists       Number(5);
  n_时段已挂     Number(5);
  n_挂号模式     Number(3);
  v_挂号模式     Varchar2(500);
  v_启用时间     Varchar2(500);
  n_时间间隔     Number(5);
  n_预约天数     Number(5);
  n_补充天数     Number(5);
  d_时段开始     Date;
  d_时段结束     Date;
  n_时段总数     Number(5);
  n_时段剩余     Number(5);
  Err_Item Exception;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Select To_Date(Extractvalue(Value(A), 'IN/RQ'), 'YYYY-MM-DD hh24:mi:ss'), Extractvalue(Value(A), 'IN/KSID'),
         Extractvalue(Value(A), 'IN/YSID'), Extractvalue(Value(A), 'IN/YSXM'), Extractvalue(Value(A), 'IN/HZDW'),
         Extractvalue(Value(A), 'IN/SJJG')
  Into d_日期, n_科室id, n_医生id, v_医生姓名, v_合作单位, n_时间间隔
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;
  v_挂号模式 := zl_GetSysParameter('挂号排班模式');
  n_挂号模式 := To_Number(Substr(v_挂号模式, 1, 1));
  If n_挂号模式 = 1 Then
     Select Max(Substr(v_挂号模式, 3)) Into v_启用时间 From Dual;
  End If;
  --日期节点为空的情况
  If d_日期 Is Null Then
    d_日期 := Trunc(Sysdate);
  End If;
  n_预约天数 := Nvl(zl_GetSysParameter(66), 7);
  If d_日期 < To_Date(v_启用时间, 'yyyy-mm-dd hh24:mi:ss') And n_挂号模式 = 1 Then
    n_挂号模式 := 0;
  End If;

  If n_挂号模式 = 0 Then
    Select Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五', '7', '周六', Null)
    Into v_星期
    From Dual;
    n_合约剩余数量 := 0;
  
    For r_No In (Select a.科室id, a.号类, a.科室名称, a.医生姓名, a.医生id, a.职称, a.号码, a.安排id, a.计划id, a.排班, a.项目id, a.项目名称, a.序号控制,
                        a.限号数, a.限约数, a.预约天数, Nvl(Hz.已挂数, 0) As 已挂数, Nvl(Hz.已约数, 0) As 已约数, Nvl(Hz.其中已接收, 0) As 已接收,
                        Sum(b.现价) As 价格
                 From (Select Ap.科室id, Ap.号类, Bm.名称 As 科室名称, Ap.医生姓名, Nvl(Ap.医生id, 0) As 医生id, Ry.专业技术职务 As 职称, Ap.号码,
                               Ap.安排id, Ap.计划id, Ap.排班, Ap.项目id, Fy.名称 As 项目名称, Ap.序号控制, Ap.限号数, Ap.限约数, Ap.预约天数
                        From (Select Ap.科室id, Ap.号类, Bm.名称 As 科室名称, Ap.医生姓名, Ap.医生id, Ap.号码, Ap.Id As 安排id, 0 As 计划id,
                                      Ap.项目id, Nvl(Ap.序号控制, 0) As 序号控制,
                                      Decode(To_Char(d_日期, 'D'), '1', Ap.周日, '2', Ap.周一, '3', Ap.周二, '4', Ap.周三, '5', Ap.周四,
                                              '6', Ap.周五, '7', Ap.周六, Null) As 排班, Xz.限约数, Xz.限号数,
                                      Nvl(Ap.预约天数, n_预约天数) As 预约天数
                               From 挂号安排 Ap, 部门表 Bm, 挂号安排限制 Xz
                               Where Ap.科室id = Bm.Id(+) And Decode(Nvl(n_科室id, 0), 0, 0, Ap.科室id) = Nvl(n_科室id, 0) And
                                     Decode(Nvl(n_医生id, 0), 0, 0, Ap.医生id) = Nvl(n_医生id, 0) And
                                     Decode(Nvl(v_医生姓名, '-'), '-', '-', Ap.医生姓名) = Nvl(v_医生姓名, '-') And Ap.停用日期 Is Null And
                                     d_日期 Between Nvl(Ap.开始时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                                     Nvl(Ap.终止时间, To_Date('3000 - 01 - 01', 'YYYY-MM-DD')) And Xz.安排id(+) = Ap.Id And
                                     Xz.限制项目(+) = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5',
                                                         '周四', '6', '周五', '7', '周六', Null) And Not Exists
                                (Select Rownum
                                      From 挂号安排停用状态 Ty
                                      Where Ty.安排id = Ap.Id And d_日期 Between Ty.开始停止时间 And Ty.结束停止时间) And Not Exists
                                (Select Rownum
                                      From 挂号安排计划 Jh
                                      Where Jh.安排id = Ap.Id And Jh.审核时间 Is Not Null And
                                            d_日期 Between Nvl(Jh.生效时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                                            Nvl(Jh.失效时间, To_Date('3000-01-01', 'YYYY-MM-DD')))
                               Union All
                               Select Ap.科室id, Ap.号类, Bm.名称 As 科室名称, Jh.医生姓名, Jh.医生id, Ap.号码, Ap.Id As 安排id, Jh.Id As 计划id,
                                      Jh.项目id, Nvl(Jh.序号控制, 0) As 序号控制,
                                      Decode(To_Char(d_日期, 'D'), '1', Jh.周日, '2', Jh.周一, '3', Jh.周二, '4', Jh.周三, '5', Jh.周四,
                                              '6', Jh.周五, '7', Jh.周六, Null) As 排班, Xz.限约数, Xz.限号数,
                                      Nvl(Ap.预约天数, n_预约天数) As 预约天数
                               From 挂号安排计划 Jh, 挂号安排 Ap, 部门表 Bm, 挂号计划限制 Xz
                               Where Jh.安排id = Ap.Id And Ap.科室id = Bm.Id(+) And Ap.停用日期 Is Null And
                                     Decode(Nvl(n_科室id, 0), 0, 0, Ap.科室id) = Nvl(n_科室id, 0) And
                                     Decode(Nvl(n_医生id, 0), 0, 0, Jh.医生id) = Nvl(n_医生id, 0) And
                                     Decode(Nvl(v_医生姓名, '-'), '-', '-', Jh.医生姓名) = Nvl(v_医生姓名, '-') And
                                     d_日期 Between Nvl(Jh.生效时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                                     Nvl(Jh.失效时间, To_Date('3000-01-01', 'YYYY-MM-DD')) And Xz.计划id(+) = Jh.Id And
                                     Xz.限制项目(+) = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5',
                                                         '周四', '6', '周五', '7', '周六', Null) And Not Exists
                                (Select Rownum
                                      From 挂号安排停用状态 Ty
                                      Where Ty.安排id = Ap.Id And d_日期 Between Ty.开始停止时间 And Ty.结束停止时间) And
                                     (Jh.生效时间, Jh.安排id) =
                                     (Select Max(Sxjh.生效时间) As 生效时间, 安排id
                                      From 挂号安排计划 Sxjh
                                      Where Sxjh.审核时间 Is Not Null And
                                            d_日期 Between Nvl(Sxjh.生效时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                                            Nvl(Sxjh.失效时间, To_Date('3000-01-01', 'YYYY-MM-DD')) And Sxjh.安排id = Jh.安排id
                                      Group By Sxjh.安排id)) Ap, 部门表 Bm, 人员表 Ry, 收费项目目录 Fy
                        Where Ap.科室id = Bm.Id(+) And Ap.医生id = Ry.Id(+) And Ap.项目id = Fy.Id And 排班 Is Not Null) A,
                      病人挂号汇总 Hz, 收费价目 B
                 Where a.号码 = Hz.号码(+) And Hz.日期(+) = Trunc(d_日期) And a.项目id = b.收费细目id And
                       Nvl(b.终止日期, To_Date('3000-1-1', 'YYYY-Mm-DD')) > d_日期 And b.执行日期 <= d_日期
                 Group By a.科室id, a.号类, a.科室名称, a.医生姓名, a.医生id, a.职称, a.号码, a.安排id, a.计划id, a.排班, a.项目id, a.项目名称, a.序号控制,
                          a.限号数, a.限约数, a.预约天数, Nvl(Hz.已挂数, 0), Nvl(Hz.已约数, 0), Nvl(Hz.其中已接收, 0)) Loop
      Zl_挂号序号状态_Delete(1, r_No.号码);
      If Sysdate + Nvl(r_No.预约天数, n_预约天数) >= d_日期 Then
        If r_No.计划id <> 0 Then
          Select Sign(Count(Rownum))
          Into n_分时段
          From 挂号安排计划 Jh, 挂号计划时段 Sd
          Where Jh.Id = Sd.计划id And Jh.Id = r_No.计划id And
                Sd.星期 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五', '7',
                               '周六', Null) And Rownum < 2;
        Else
          Select Sign(Count(Rownum))
          Into n_分时段
          From 挂号安排 Ap, 挂号安排时段 Sd
          Where Ap.Id = Sd.安排id And Ap.Id = r_No.安排id And
                Sd.星期 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五', '7',
                               '周六', Null) And Rownum < 2;
        End If;
        --分时段不序号控制当天号为普通号
        If Trunc(Sysdate) = Trunc(d_日期) And n_分时段 = 1 And r_No.序号控制 = 0 Then
          n_分时段 := 0;
        End If;
        If n_分时段 = 0 Then
          v_Temp := '';
          If v_合作单位 Is Not Null And r_No.序号控制 = 1 Then
            If r_No.计划id <> 0 Then
              Select Nvl(Sum(数量), 0)
              Into n_合约总数量
              From 合作单位计划控制
              Where 计划id = r_No.计划id And 合作单位 = v_合作单位 And
                    限制项目 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五',
                                  '7', '周六', Null);
              Select Count(1)
              Into n_合约模式
              From 合作单位计划控制
              Where 计划id = r_No.计划id And 合作单位 = v_合作单位 And
                    限制项目 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五',
                                  '7', '周六', Null) And 序号 = 0;
            Else
              Select Nvl(Sum(数量), 0)
              Into n_合约总数量
              From 合作单位安排控制
              Where 安排id = r_No.安排id And 合作单位 = v_合作单位 And
                    限制项目 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五',
                                  '7', '周六', Null);
              Select Count(1)
              Into n_合约模式
              From 合作单位安排控制
              Where 安排id = r_No.安排id And 合作单位 = v_合作单位 And
                    限制项目 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五',
                                  '7', '周六', Null) And 序号 = 0;
            End If;
            If n_合约模式 = 0 Then
              If r_No.计划id <> 0 Then
                Select Count(1)
                Into n_合约已挂数
                From 病人挂号记录 A
                Where 号别 = r_No.号码 And 记录状态 = 1 And 发生时间 Between Trunc(d_日期) And Trunc(d_日期 + 1) - 1 / 60 / 60 / 24 And
                      Exists
                 (Select 1
                       From 合作单位计划控制
                       Where 计划id = r_No.计划id And 合作单位 = v_合作单位 And
                             限制项目 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6',
                                           '周五', '7', '周六', Null) And 序号 = a.号序 And 数量 <> 0);
              Else
                Select Count(1)
                Into n_合约已挂数
                From 病人挂号记录 A
                Where 号别 = r_No.号码 And 记录状态 = 1 And 发生时间 Between Trunc(d_日期) And Trunc(d_日期 + 1) - 1 / 60 / 60 / 24 And
                      Exists
                 (Select 1
                       From 合作单位安排控制
                       Where 安排id = r_No.安排id And 合作单位 = v_合作单位 And
                             限制项目 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6',
                                           '周五', '7', '周六', Null) And 序号 = a.号序 And 数量 <> 0);
              End If;
            Else
              Select Count(1)
              Into n_合约已挂数
              From 病人挂号记录
              Where 号别 = r_No.号码 And 记录状态 = 1 And 合作单位 = v_合作单位 And 发生时间 Between Trunc(d_日期) And
                    Trunc(d_日期 + 1) - 1 / 60 / 60 / 24;
            End If;
            If n_合约总数量 = 0 Then
              n_合约剩余数量 := 0;
            Else
              n_合约剩余数量 := n_合约总数量 - n_合约已挂数;
              If n_合约剩余数量 > (Nvl(r_No.限号数, 0) - r_No.已挂数) Then
                n_合约剩余数量 := Nvl(r_No.限号数, 0) - r_No.已挂数;
              End If;
            End If;
          End If;
        Else
          v_Temp := '<SPANLIST>';
          If r_No.计划id <> 0 Then
            Select To_Date(To_Char(d_日期, 'yyyy-mm-dd') || To_Char(Max(结束时间), 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss')
            Into d_加号时间
            From 挂号计划时段
            Where 计划id = r_No.计划id And 星期 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5',
                                                   '周四', '6', '周五', '7', '周六', Null);
            If r_No.序号控制 = 1 Then
              If Trunc(d_日期) = Trunc(Sysdate) Then
                n_特殊预约 := 0;
              Else
                Select Nvl(Max(Jh.是否预约), 0)
                Into n_特殊预约
                From (Select Sd.计划id, Sd.序号, Sd.星期, Jh.号码,
                              To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' || To_Char(Sd.开始时间, 'hh24:mi:ss'),
                                       'yyyy-mm-dd hh24:mi:ss') As 开始时间,
                              To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' || To_Char(Sd.结束时间, 'hh24:mi:ss'),
                                       'yyyy-mm-dd hh24:mi:ss') As 结束时间, Sd.限制数量, Sd.是否预约
                       From 挂号安排计划 Jh, 挂号计划时段 Sd
                       Where Jh.Id = Sd.计划id And Jh.Id = r_No.计划id And
                             Sd.星期 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6',
                                            '周五', '7', '周六', Null)) Jh, 挂号序号状态 Zt
                Where Zt.日期(+) = Jh.开始时间 And Zt.号码(+) = Jh.号码 And Zt.序号(+) = Jh.序号 And
                      Decode(Sign(Sysdate - Jh.开始时间), -1, 0, 1) <> 1;
              End If;
            
              d_时段开始 := Null;
              d_时段结束 := Null;
              n_时段总数 := 0;
              n_时段剩余 := 0;
              For r_Time In (Select Jh.号码, Jh.序号, Jh.星期, Jh.开始时间, Jh.结束时间, Jh.限制数量, Jh.是否预约, 0 As 已约数,
                                    Decode(Nvl(Zt.序号, 0), 0, 1, 0) As 剩余数,
                                    Decode(Sign(Sysdate - Jh.开始时间), -1, 0, 1) As 失效时段
                             From (Select Sd.计划id, Sd.序号, Sd.星期, Jh.号码,
                                           To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' || To_Char(Sd.开始时间, 'hh24:mi:ss'),
                                                    'yyyy-mm-dd hh24:mi:ss') As 开始时间,
                                           To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' || To_Char(Sd.结束时间, 'hh24:mi:ss'),
                                                    'yyyy-mm-dd hh24:mi:ss') As 结束时间, Sd.限制数量, Sd.是否预约
                                    From 挂号安排计划 Jh, 挂号计划时段 Sd
                                    Where Jh.Id = Sd.计划id And Jh.Id = r_No.计划id And Not Exists
                                     (Select 1
                                           From 挂号安排停用状态
                                           Where 安排id = Jh.安排id And
                                                 To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' ||
                                                         To_Char(Sd.开始时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss') Between
                                                 开始停止时间 And 结束停止时间) And
                                          Sd.星期 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                                         '5', '周四', '6', '周五', '7', '周六', Null)) Jh, 挂号序号状态 Zt
                             Where Zt.日期(+) = Jh.开始时间 And Zt.号码(+) = Jh.号码 And Zt.序号(+) = Jh.序号
                             Order By 序号) Loop
                If Nvl(n_时间间隔, 0) <> 0 Then
                  If d_时段开始 Is Null Then
                    d_时段开始 := r_Time.开始时间;
                    d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                    n_时段总数 := n_时段总数 + r_Time.限制数量;
                    If d_加号时间 < d_时段结束 Then
                      d_时段结束 := d_加号时间;
                    End If;
                  Else
                    If r_Time.开始时间 >= d_时段结束 Then
                      v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                    To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                    '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                      n_时段总数 := r_Time.限制数量;
                      n_时段剩余 := 0;
                      d_时段开始 := r_Time.开始时间;
                      d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                      If d_加号时间 < d_时段结束 Then
                        d_时段结束 := d_加号时间;
                      End If;
                    Else
                      n_时段总数 := n_时段总数 + r_Time.限制数量;
                    End If;
                  End If;
                End If;
                If v_合作单位 Is Not Null Then
                  Select Nvl(Max(1), 0)
                  Into n_合约模式
                  From 合作单位计划控制
                  Where 限制项目 = r_Time.星期 And 计划id = r_No.计划id And 序号 = 0 And 合作单位 = v_合作单位;
                Else
                  n_合约模式 := 0;
                End If;
                If r_Time.剩余数 = 0 Then
                  n_单个剩余 := 0;
                Else
                  n_单个剩余 := r_Time.限制数量;
                End If;
                If v_合作单位 Is Null Or n_合约模式 = 1 Then
                  Select Nvl(Max(1), 0)
                  Into n_Exists
                  From 合作单位计划控制
                  Where 限制项目 = r_Time.星期 And 计划id = r_No.计划id And 序号 = r_Time.序号 And Rownum < 2;
                  If n_Exists = 0 And r_Time.失效时段 <> 1 Then
                    If n_特殊预约 = 1 And r_Time.是否预约 = 0 Then
                      Null;
                    Else
                      Select Nvl(Max(1), 0)
                      Into n_是否预留
                      From 挂号序号状态
                      Where 状态 In (3, 4) And 号码 = r_No.号码 And 序号 = r_Time.序号 And Trunc(日期) = Trunc(d_日期);
                      If n_是否预留 = 0 Then
                        If Nvl(n_时间间隔, 0) = 0 Then
                          v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                    To_Char(r_Time.结束时间, 'hh24:mi:ss') || '</SJD>' || '<SL>' || n_单个剩余 || '</SL>' ||
                                    '</SPAN>';
                        Else
                          n_时段剩余 := n_时段剩余 + n_单个剩余;
                        End If;
                        n_时段数量 := Nvl(n_时段数量, 0) + n_单个剩余;
                      End If;
                    End If;
                  End If;
                Else
                  Select Nvl(Max(1), 0)
                  Into n_Exists
                  From 合作单位计划控制
                  Where 限制项目 = r_Time.星期 And 计划id = r_No.计划id And 序号 = r_Time.序号 And 合作单位 = v_合作单位 And Rownum < 2;
                  Begin
                    Select 0
                    Into n_非合约
                    From 合作单位计划控制
                    Where 计划id = r_No.计划id And 合作单位 = v_合作单位 And Rownum < 2;
                  Exception
                    When Others Then
                      n_非合约 := 1;
                  End;
                  If (n_Exists = 1 Or n_非合约 = 1) And r_Time.失效时段 <> 1 Then
                    If n_特殊预约 = 1 And r_Time.是否预约 = 0 Then
                      Null;
                    Else
                      Select Nvl(Max(1), 0)
                      Into n_是否预留
                      From 挂号序号状态
                      Where 状态 In (3, 4) And 号码 = r_No.号码 And 序号 = r_Time.序号 And Trunc(日期) = Trunc(d_日期);
                      If n_是否预留 = 0 Then
                        If Nvl(n_时间间隔, 0) = 0 Then
                          v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                    To_Char(r_Time.结束时间, 'hh24:mi:ss') || '</SJD>' || '<SL>' || n_单个剩余 || '</SL>' ||
                                    '</SPAN>';
                        Else
                          n_时段剩余 := n_时段剩余 + n_单个剩余;
                        End If;
                        n_合约剩余数量 := n_合约剩余数量 + 1;
                      End If;
                    End If;
                  End If;
                End If;
              End Loop;
              If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                              To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' || '<SL>' ||
                              n_时段剩余 || '</SL>' || '</SPAN>';
                n_时段总数 := 0;
                n_时段剩余 := 0;
                d_时段开始 := Null;
                d_时段结束 := Null;
              End If;
            Else
              n_最大可用数量 := Nvl(r_No.限约数, Nvl(r_No.限号数, 0)) - Nvl(r_No.已约数, 0);
              n_时段总数     := 0;
              n_时段剩余     := 0;
              d_时段开始     := Null;
              d_时段结束     := Null;
              For r_Time In (Select Jh.号码, Jh.序号, Jh.星期, Jh.开始时间, Jh.结束时间, Jh.限制数量, Jh.是否预约,
                                    Sum(Decode(Nvl(Zt.序号, 0), 0, 0, 1)) As 已约数,
                                    Jh.限制数量 - Sum(Decode(Nvl(Zt.序号, 0), 0, 0, 1)) As 剩余数,
                                    Decode(Sign(Sysdate - Jh.开始时间), -1, 0, 1) As 失效时段
                             From (Select Sd.计划id, Sd.序号, Sd.星期, Jh.号码,
                                           To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' || To_Char(Sd.开始时间, 'hh24:mi:ss'),
                                                    'yyyy-mm-dd hh24:mi:ss') As 开始时间,
                                           To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' || To_Char(Sd.结束时间, 'hh24:mi:ss'),
                                                    'yyyy-mm-dd hh24:mi:ss') As 结束时间, Sd.限制数量, Sd.是否预约
                                    From 挂号安排计划 Jh, 挂号计划时段 Sd
                                    Where Jh.Id = Sd.计划id And Jh.Id = r_No.计划id And Not Exists
                                     (Select 1
                                           From 挂号安排停用状态
                                           Where 安排id = Jh.安排id And
                                                 To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' ||
                                                         To_Char(Sd.开始时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss') Between
                                                 开始停止时间 And 结束停止时间) And
                                          Sd.星期 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                                         '5', '周四', '6', '周五', '7', '周六', Null)) Jh, 挂号序号状态 Zt
                             Where Jh.号码 = Zt.号码(+) And Jh.开始时间 = Zt.日期(+)
                             Group By Jh.号码, Jh.序号, Jh.星期, Jh.开始时间, Jh.结束时间, Jh.限制数量, Jh.是否预约
                             Order By Jh.序号) Loop
                If Nvl(n_时间间隔, 0) <> 0 Then
                  If d_时段开始 Is Null Then
                    d_时段开始 := r_Time.开始时间;
                    d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                    n_时段总数 := n_时段总数 + r_Time.限制数量;
                    If d_加号时间 < d_时段结束 Then
                      d_时段结束 := d_加号时间;
                    End If;
                  Else
                    If r_Time.开始时间 >= d_时段结束 Then
                      v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                    To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                    '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                      n_时段总数 := r_Time.限制数量;
                      n_时段剩余 := 0;
                      d_时段开始 := r_Time.开始时间;
                      d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                      If d_加号时间 < d_时段结束 Then
                        d_时段结束 := d_加号时间;
                      End If;
                    Else
                      n_时段总数 := n_时段总数 + r_Time.限制数量;
                    End If;
                  End If;
                End If;
                If v_合作单位 Is Not Null Then
                  Select Nvl(Max(1), 0)
                  Into n_合约模式
                  From 合作单位计划控制
                  Where 限制项目 = r_Time.星期 And 计划id = r_No.计划id And 序号 = 0 And 合作单位 = v_合作单位;
                Else
                  n_合约模式 := 0;
                End If;
                n_单个剩余 := r_Time.剩余数;
                If v_合作单位 Is Null Or n_合约模式 = 1 Then
                  Select Nvl(Max(1), 0)
                  Into n_Exists
                  From 合作单位计划控制
                  Where 限制项目 = r_Time.星期 And 计划id = r_No.计划id And 序号 = r_Time.序号 And Rownum < 2;
                  If n_Exists = 0 And r_Time.失效时段 <> 1 Then
                    If n_最大可用数量 < n_单个剩余 Then
                      If Nvl(n_时间间隔, 0) = 0 Then
                        v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                  To_Char(r_Time.结束时间, 'hh24:mi:ss') || '</SJD>' || '<SL>' || n_最大可用数量 || '</SL>' ||
                                  '</SPAN>';
                      Else
                        n_时段剩余 := n_时段剩余 + n_最大可用数量;
                      End If;
                      n_时段数量 := Nvl(n_时段数量, 0) + n_最大可用数量;
                    Else
                      If Nvl(n_时间间隔, 0) = 0 Then
                        v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                  To_Char(r_Time.结束时间, 'hh24:mi:ss') || '</SJD>' || '<SL>' || n_单个剩余 || '</SL>' ||
                                  '</SPAN>';
                      Else
                        n_时段剩余 := n_时段剩余 + n_单个剩余;
                      End If;
                      n_时段数量 := Nvl(n_时段数量, 0) + n_单个剩余;
                    End If;
                  End If;
                Else
                  Select Nvl(Max(1), 0)
                  Into n_Exists
                  From 合作单位计划控制
                  Where 限制项目 = r_Time.星期 And 计划id = r_No.计划id And 序号 = r_Time.序号 And 合作单位 = v_合作单位 And Rownum < 2;
                  Begin
                    Select 0
                    Into n_非合约
                    From 合作单位计划控制
                    Where 计划id = r_No.计划id And 合作单位 = v_合作单位 And Rownum < 2;
                  Exception
                    When Others Then
                      n_非合约 := 1;
                  End;
                  If (n_Exists = 1 Or n_非合约 = 1) And r_Time.失效时段 <> 1 Then
                    If n_最大可用数量 < n_单个剩余 Then
                      If Nvl(n_时间间隔, 0) = 0 Then
                        v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                  To_Char(r_Time.结束时间, 'hh24:mi:ss') || '</SJD>' || '<SL>' || n_最大可用数量 || '</SL>' ||
                                  '</SPAN>';
                      Else
                        n_时段剩余 := n_时段剩余 + n_最大可用数量;
                      End If;
                      n_合约剩余数量 := n_合约剩余数量 + Nvl(n_最大可用数量, 0);
                    Else
                      If Nvl(n_时间间隔, 0) = 0 Then
                        v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                  To_Char(r_Time.结束时间, 'hh24:mi:ss') || '</SJD>' || '<SL>' || n_单个剩余 || '</SL>' ||
                                  '</SPAN>';
                      Else
                        n_时段剩余 := n_时段剩余 + n_单个剩余;
                      End If;
                      n_合约剩余数量 := n_合约剩余数量 + Nvl(n_单个剩余, 0);
                    End If;
                  End If;
                End If;
              End Loop;
              If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                              To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' || '<SL>' ||
                              n_时段剩余 || '</SL>' || '</SPAN>';
                n_时段总数 := 0;
                n_时段剩余 := 0;
                d_时段开始 := Null;
                d_时段结束 := Null;
              End If;
            End If;
          Else
            Select To_Date(To_Char(d_日期, 'yyyy-mm-dd') || To_Char(Max(结束时间), 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss')
            Into d_加号时间
            From 挂号安排时段
            Where 安排id = r_No.安排id And 星期 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5',
                                                   '周四', '6', '周五', '7', '周六', Null);
            If r_No.序号控制 = 1 Then
              If Trunc(d_日期) = Trunc(Sysdate) Then
                n_特殊预约 := 0;
              Else
                Select Nvl(Max(Ap.是否预约), 0)
                Into n_特殊预约
                From (Select Sd.安排id, Sd.序号, Sd.星期, Ap.号码,
                              To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' || To_Char(Sd.开始时间, 'hh24:mi:ss'),
                                       'yyyy-mm-dd hh24:mi:ss') As 开始时间,
                              To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' || To_Char(Sd.结束时间, 'hh24:mi:ss'),
                                       'yyyy-mm-dd hh24:mi:ss') As 结束时间, Sd.限制数量, Sd.是否预约
                       From 挂号安排 Ap, 挂号安排时段 Sd
                       Where Ap.Id = Sd.安排id And Ap.Id = r_No.安排id And
                             Sd.星期 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6',
                                            '周五', '7', '周六', Null)) Ap, 挂号序号状态 Zt
                Where Zt.日期(+) = Ap.开始时间 And Zt.号码(+) = Ap.号码 And Zt.序号(+) = Ap.序号 And
                      Decode(Sign(Sysdate - Ap.开始时间), -1, 0, 1) <> 1;
              End If;
              n_时段总数 := 0;
              n_时段剩余 := 0;
              d_时段开始 := Null;
              d_时段结束 := Null;
              For r_Time In (Select Ap.号码, Ap.序号, Ap.星期, Ap.开始时间, Ap.结束时间, Ap.限制数量, Ap.是否预约, 0 As 已约数,
                                    Decode(Nvl(Zt.序号, 0), 0, 1, 0) As 剩余数,
                                    Decode(Sign(Sysdate - Ap.开始时间), -1, 0, 1) As 失效时段
                             
                             From (Select Sd.安排id, Sd.序号, Sd.星期, Ap.号码,
                                           To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' || To_Char(Sd.开始时间, 'hh24:mi:ss'),
                                                    'yyyy-mm-dd hh24:mi:ss') As 开始时间,
                                           To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' || To_Char(Sd.结束时间, 'hh24:mi:ss'),
                                                    'yyyy-mm-dd hh24:mi:ss') As 结束时间, Sd.限制数量, Sd.是否预约
                                    From 挂号安排 Ap, 挂号安排时段 Sd
                                    Where Ap.Id = Sd.安排id And Ap.Id = r_No.安排id And Not Exists
                                     (Select 1
                                           From 挂号安排停用状态
                                           Where 安排id = Ap.Id And
                                                 To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' ||
                                                         To_Char(Sd.开始时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss') Between
                                                 开始停止时间 And 结束停止时间) And
                                          Sd.星期 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                                         '5', '周四', '6', '周五', '7', '周六', Null)) Ap, 挂号序号状态 Zt
                             Where Zt.日期(+) = Ap.开始时间 And Zt.号码(+) = Ap.号码 And Zt.序号(+) = Ap.序号
                             Order By 序号) Loop
                If Nvl(n_时间间隔, 0) <> 0 Then
                  If d_时段开始 Is Null Then
                    d_时段开始 := r_Time.开始时间;
                    n_时段总数 := n_时段总数 + r_Time.限制数量;
                    d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                    If d_加号时间 < d_时段结束 Then
                      d_时段结束 := d_加号时间;
                    End If;
                  Else
                    If r_Time.开始时间 >= d_时段结束 Then
                      v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                    To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                    '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                      n_时段总数 := r_Time.限制数量;
                      n_时段剩余 := 0;
                      d_时段开始 := r_Time.开始时间;
                      d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                      If d_加号时间 < d_时段结束 Then
                        d_时段结束 := d_加号时间;
                      End If;
                    Else
                      n_时段总数 := n_时段总数 + r_Time.限制数量;
                    End If;
                  End If;
                End If;
                If v_合作单位 Is Not Null Then
                  Begin
                    Select 1
                    Into n_合约模式
                    From 合作单位安排控制
                    Where 限制项目 = r_Time.星期 And 安排id = r_No.安排id And 序号 = 0 And 合作单位 = v_合作单位;
                  Exception
                    When Others Then
                      n_合约模式 := 0;
                  End;
                Else
                  n_合约模式 := 0;
                End If;
                If r_Time.剩余数 = 0 Then
                  n_单个剩余 := 0;
                Else
                  n_单个剩余 := r_Time.限制数量;
                End If;
                If v_合作单位 Is Null Or n_合约模式 = 1 Then
                  Select Nvl(Max(1), 0)
                  Into n_Exists
                  From 合作单位安排控制
                  Where 限制项目 = r_Time.星期 And 安排id = r_No.安排id And 序号 = r_Time.序号 And Rownum < 2;
                  If n_Exists = 0 And r_Time.失效时段 <> 1 Then
                    If n_特殊预约 = 1 And r_Time.是否预约 = 0 Then
                      Null;
                    Else
                      Select Nvl(Max(1), 0)
                      Into n_是否预留
                      From 挂号序号状态
                      Where 状态 In (3, 4) And 号码 = r_No.号码 And 序号 = r_Time.序号 And Trunc(日期) = Trunc(d_日期);
                      If n_是否预留 = 0 Then
                        If Nvl(n_时间间隔, 0) = 0 Then
                          v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                    To_Char(r_Time.结束时间, 'hh24:mi:ss') || '</SJD>' || '<SL>' || n_单个剩余 || '</SL>' ||
                                    '</SPAN>';
                        Else
                          n_时段剩余 := n_时段剩余 + n_单个剩余;
                        End If;
                        n_时段数量 := Nvl(n_时段数量, 0) + n_单个剩余;
                      End If;
                    End If;
                  End If;
                Else
                  Select Nvl(Max(1), 0)
                  Into n_Exists
                  From 合作单位安排控制
                  Where 限制项目 = r_Time.星期 And 安排id = r_No.安排id And 序号 = r_Time.序号 And 合作单位 = v_合作单位 And Rownum < 2;
                  Begin
                    Select 0
                    Into n_非合约
                    From 合作单位安排控制
                    Where 安排id = r_No.安排id And 合作单位 = v_合作单位 And Rownum < 2;
                  Exception
                    When Others Then
                      n_非合约 := 1;
                  End;
                  If (n_Exists = 1 Or n_非合约 = 1) And r_Time.失效时段 <> 1 Then
                    If n_特殊预约 = 1 And r_Time.是否预约 = 0 Then
                      Null;
                    Else
                      Select Nvl(Max(1), 0)
                      Into n_是否预留
                      From 挂号序号状态
                      Where 状态 In (3, 4) And 号码 = r_No.号码 And 序号 = r_Time.序号 And Trunc(日期) = Trunc(d_日期);
                      If n_是否预留 = 0 Then
                        If Nvl(n_时间间隔, 0) = 0 Then
                          v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                    To_Char(r_Time.结束时间, 'hh24:mi:ss') || '</SJD>' || '<SL>' || n_单个剩余 || '</SL>' ||
                                    '</SPAN>';
                        Else
                          n_时段剩余 := n_时段剩余 + n_单个剩余;
                        End If;
                        n_合约剩余数量 := n_合约剩余数量 + n_单个剩余;
                      End If;
                    End If;
                  End If;
                End If;
              End Loop;
              If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                              To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' || '<SL>' ||
                              n_时段剩余 || '</SL>' || '</SPAN>';
                n_时段总数 := 0;
                n_时段剩余 := 0;
                d_时段开始 := Null;
                d_时段结束 := Null;
              End If;
            Else
              n_最大可用数量 := Nvl(r_No.限约数, Nvl(r_No.限号数, 0)) - Nvl(r_No.已约数, 0);
              n_时段总数     := 0;
              n_时段剩余     := 0;
              d_时段开始     := Null;
              d_时段结束     := Null;
              For r_Time In (Select Ap.号码, Ap.序号, Ap.星期, Ap.开始时间, Ap.结束时间, Ap.限制数量, Ap.是否预约,
                                    Sum(Decode(Nvl(Zt.序号, 0), 0, 0, 1)) As 已约数,
                                    Ap.限制数量 - Sum(Decode(Nvl(Zt.序号, 0), 0, 0, 1)) As 剩余数,
                                    Decode(Sign(Sysdate - Ap.开始时间), -1, 0, 1) As 失效时段
                             From (Select Sd.安排id, Sd.序号, Sd.星期, Ap.号码,
                                           To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' || To_Char(Sd.开始时间, 'hh24:mi:ss'),
                                                    'yyyy-mm-dd hh24:mi:ss') As 开始时间,
                                           To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' || To_Char(Sd.结束时间, 'hh24:mi:ss'),
                                                    'yyyy-mm-dd hh24:mi:ss') As 结束时间, Sd.限制数量, Sd.是否预约
                                    From 挂号安排 Ap, 挂号安排时段 Sd
                                    Where Ap.Id = Sd.安排id And Ap.Id = r_No.安排id And Not Exists
                                     (Select 1
                                           From 挂号安排停用状态
                                           Where 安排id = Ap.Id And
                                                 To_Date(To_Char(d_日期, 'yyyy-mm-dd') || ' ' ||
                                                         To_Char(Sd.开始时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss') Between
                                                 开始停止时间 And 结束停止时间) And
                                          Sd.星期 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三',
                                                         '5', '周四', '6', '周五', '7', '周六', Null)) Ap, 挂号序号状态 Zt
                             Where Ap.号码 = Zt.号码(+) And Ap.开始时间 = Zt.日期(+)
                             Group By Ap.号码, Ap.序号, Ap.星期, Ap.开始时间, Ap.结束时间, Ap.限制数量, Ap.是否预约
                             Order By Ap.序号) Loop
                If Nvl(n_时间间隔, 0) <> 0 Then
                  If d_时段开始 Is Null Then
                    d_时段开始 := r_Time.开始时间;
                    d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                    n_时段总数 := n_时段总数 + r_Time.限制数量;
                    If d_加号时间 < d_时段结束 Then
                      d_时段结束 := d_加号时间;
                    End If;
                  Else
                    If r_Time.开始时间 >= d_时段结束 Then
                      v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                    To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                    '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                      n_时段总数 := r_Time.限制数量;
                      n_时段剩余 := 0;
                      d_时段开始 := r_Time.开始时间;
                      d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                      If d_加号时间 < d_时段结束 Then
                        d_时段结束 := d_加号时间;
                      End If;
                    Else
                      n_时段总数 := n_时段总数 + r_Time.限制数量;
                    End If;
                  End If;
                End If;
                If v_合作单位 Is Not Null Then
                  Select Nvl(Max(1), 0)
                  Into n_合约模式
                  From 合作单位安排控制
                  Where 限制项目 = r_Time.星期 And 安排id = r_No.安排id And 序号 = 0 And 合作单位 = v_合作单位;
                Else
                  n_合约模式 := 0;
                End If;
                n_单个剩余 := r_Time.剩余数;
                If v_合作单位 Is Null Or n_合约模式 = 1 Then
                  Select Nvl(Max(1), 0)
                  Into n_Exists
                  From 合作单位安排控制
                  Where 限制项目 = r_Time.星期 And 安排id = r_No.安排id And 序号 = r_Time.序号 And Rownum < 2;
                  If n_Exists = 0 And r_Time.失效时段 <> 1 Then
                    If n_最大可用数量 < n_单个剩余 Then
                      If Nvl(n_时间间隔, 0) = 0 Then
                        v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                  To_Char(r_Time.结束时间, 'hh24:mi:ss') || '</SJD>' || '<SL>' || n_最大可用数量 || '</SL>' ||
                                  '</SPAN>';
                      Else
                        n_时段剩余 := n_时段剩余 + n_最大可用数量;
                      End If;
                      n_时段数量 := Nvl(n_时段数量, 0) + n_最大可用数量;
                    Else
                      If Nvl(n_时间间隔, 0) = 0 Then
                        v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                  To_Char(r_Time.结束时间, 'hh24:mi:ss') || '</SJD>' || '<SL>' || n_单个剩余 || '</SL>' ||
                                  '</SPAN>';
                      Else
                        n_时段剩余 := n_时段剩余 + n_单个剩余;
                      End If;
                      n_时段数量 := Nvl(n_时段数量, 0) + n_单个剩余;
                    End If;
                  End If;
                Else
                  Select Nvl(Max(1), 0)
                  Into n_Exists
                  From 合作单位安排控制
                  Where 限制项目 = r_Time.星期 And 安排id = r_No.安排id And 序号 = r_Time.序号 And 合作单位 = v_合作单位 And Rownum < 2;
                  Begin
                    Select 0
                    Into n_非合约
                    From 合作单位安排控制
                    Where 安排id = r_No.安排id And 合作单位 = v_合作单位 And Rownum < 2;
                  Exception
                    When Others Then
                      n_非合约 := 1;
                  End;
                  If (n_Exists = 1 Or n_非合约 = 1) And r_Time.失效时段 <> 1 Then
                    If n_最大可用数量 < n_单个剩余 Then
                      If Nvl(n_时间间隔, 0) = 0 Then
                        v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                  To_Char(r_Time.结束时间, 'hh24:mi:ss') || '</SJD>' || '<SL>' || n_最大可用数量 || '</SL>' ||
                                  '</SPAN>';
                      Else
                        n_时段剩余 := n_时段剩余 + n_最大可用数量;
                      End If;
                      n_合约剩余数量 := n_合约剩余数量 + Nvl(n_最大可用数量, 0);
                    Else
                      If Nvl(n_时间间隔, 0) = 0 Then
                        v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                  To_Char(r_Time.结束时间, 'hh24:mi:ss') || '</SJD>' || '<SL>' || n_单个剩余 || '</SL>' ||
                                  '</SPAN>';
                      Else
                        n_时段剩余 := n_时段剩余 + n_单个剩余;
                      End If;
                      n_合约剩余数量 := n_合约剩余数量 + Nvl(n_单个剩余, 0);
                    End If;
                  End If;
                End If;
              End Loop;
              If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                              To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' || '<SL>' ||
                              n_时段剩余 || '</SL>' || '</SPAN>';
                n_时段总数 := 0;
                n_时段剩余 := 0;
                d_时段开始 := Null;
                d_时段结束 := Null;
              End If;
            End If;
          End If;
        End If;
        If v_合作单位 Is Not Null Then
          If Nvl(r_No.计划id, 0) <> 0 Then
            Begin
              Select 0
              Into n_非合约
              From 合作单位计划控制
              Where 计划id = r_No.计划id And 合作单位 = v_合作单位 And Rownum < 2;
            Exception
              When Others Then
                n_非合约 := 1;
            End;
          Else
            Begin
              Select 0
              Into n_非合约
              From 合作单位安排控制
              Where 安排id = r_No.安排id And 合作单位 = v_合作单位 And Rownum < 2;
            Exception
              When Others Then
                n_非合约 := 1;
            End;
          End If;
        End If;
        If v_合作单位 Is Null Or n_非合约 = 1 Then
          If r_No.限号数 = 0 Then
            v_剩余数量 := '';
          Else
            If Nvl(r_No.计划id, 0) <> 0 Then
              Select Sum(数量)
              Into n_合约总数量
              From 合作单位计划控制
              Where 计划id = r_No.计划id And
                    限制项目 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五',
                                  '7', '周六', Null);
            Else
              Select Sum(数量)
              Into n_合约总数量
              From 合作单位安排控制
              Where 安排id = r_No.安排id And
                    限制项目 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五',
                                  '7', '周六', Null);
            End If;
            Select Count(1)
            Into n_合约已挂数
            From 病人挂号记录
            Where 号别 = r_No.号码 And 记录状态 = 1 And 合作单位 Is Not Null And 发生时间 Between Trunc(d_日期) And
                  Trunc(d_日期 + 1) - 1 / 60 / 60 / 24;
            Select Count(1)
            Into n_预留数量
            From 挂号序号状态
            Where 状态 = 3 And 号码 = r_No.号码 And Trunc(日期) = Trunc(d_日期);
            If Trunc(d_日期) = Trunc(Sysdate) Then
              If Nvl(n_合约总数量, 0) = 0 Then
                v_剩余数量 := r_No.限号数 - r_No.已挂数 - r_No.已约数 + r_No.已接收 - n_预留数量;
              Else
                v_剩余数量 := r_No.限号数 - r_No.已挂数 - r_No.已约数 + r_No.已接收 - n_合约总数量 + n_合约已挂数 - n_预留数量;
              End If;
              n_已挂数 := r_No.已挂数;
              If Nvl(n_时段数量, 0) < v_剩余数量 And n_分时段 <> 0 Then
                n_缓冲序号 := 1;
                v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_加号时间, 'hh24:mi:ss') || '-' || '</SJD>' ||
                              '<SL>' || To_Number(v_剩余数量 - Nvl(n_时段数量, 0) - Nvl(n_合约剩余数量, 0)) || '</SL>' || '</SPAN>';
              Else
                n_缓冲序号 := 0;
              End If;
            Else
              If Nvl(n_合约总数量, 0) = 0 Then
                v_剩余数量 := r_No.限约数 - r_No.已约数 - n_预留数量;
                If v_剩余数量 Is Null Then
                  v_剩余数量 := r_No.限号数 - r_No.已挂数 - r_No.已约数 + r_No.已接收 - n_预留数量;
                End If;
              Else
                v_剩余数量 := r_No.限约数 - r_No.已约数 - n_合约总数量 + n_合约已挂数 - n_预留数量;
                If v_剩余数量 Is Null Then
                  v_剩余数量 := r_No.限号数 - r_No.已挂数 - r_No.已约数 + r_No.已接收 - n_合约总数量 + n_合约已挂数 - n_预留数量;
                End If;
              End If;
              n_已挂数 := r_No.已挂数;
            End If;
          End If;
        Else
          If Nvl(r_No.计划id, 0) <> 0 Then
            If v_合作单位 Is Not Null Then
              Select Nvl(Max(1), 0)
              Into n_合约模式
              From 合作单位计划控制
              Where 限制项目 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五',
                                  '7', '周六', Null) And 计划id = r_No.计划id And 序号 = 0 And 合作单位 = v_合作单位;
            Else
              n_合约模式 := 0;
            End If;
            Select Sum(数量)
            Into n_合约总数量
            From 合作单位计划控制
            Where 计划id = r_No.计划id And 限制项目 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5',
                                                     '周四', '6', '周五', '7', '周六', Null) And 合作单位 = v_合作单位;
          Else
            If v_合作单位 Is Not Null Then
              Select Nvl(Max(1), 0)
              Into n_合约模式
              From 合作单位安排控制
              Where 限制项目 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五',
                                  '7', '周六', Null) And 安排id = r_No.安排id And 序号 = 0 And 合作单位 = v_合作单位;
            Else
              n_合约模式 := 0;
            End If;
            Select Sum(数量)
            Into n_合约总数量
            From 合作单位安排控制
            Where 安排id = r_No.安排id And 限制项目 = Decode(To_Char(d_日期, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5',
                                                     '周四', '6', '周五', '7', '周六', Null) And 合作单位 = v_合作单位;
          End If;
          If n_合约模式 = 0 Then
            v_剩余数量   := n_合约剩余数量;
            n_已挂数     := r_No.已挂数;
            n_合约已挂数 := Nvl(n_合约总数量, 0) - n_合约剩余数量;
          Else
            n_已挂数 := r_No.已挂数;
            Select Count(1)
            Into n_合约已挂数
            From 病人挂号记录
            Where 号别 = r_No.号码 And 记录状态 = 1 And 合作单位 = v_合作单位 And 发生时间 Between Trunc(d_日期) And
                  Trunc(d_日期 + 1) - 1 / 60 / 60 / 24;
            If Nvl(n_合约总数量, 0) = 0 Then
              v_剩余数量 := '0';
            Else
              v_剩余数量 := n_合约总数量 - n_合约已挂数;
            End If;
          End If;
        End If;
        Select To_Char(开始时间, 'hh24:mi') Into v_Timetemp From 时间段 Where 时间段 = r_No.排班;
        v_时间段 := v_Timetemp || '-';
        Select To_Char(终止时间, 'hh24:mi') Into v_Timetemp From 时间段 Where 时间段 = r_No.排班;
        v_时间段 := v_时间段 || v_Timetemp;
        If v_Temp Is Not Null Then
          v_Temp := v_Temp || '</SPANLIST>';
        End If;
        If v_合作单位 Is Not Null Then
          If Nvl(r_No.计划id, 0) <> 0 Then
            Select Nvl(Max(1), 0)
            Into n_禁用
            From 合作单位计划控制
            Where 计划id = r_No.计划id And 合作单位 = v_合作单位 And 数量 = 0 And Rownum < 2;
          Else
            Select Nvl(Max(1), 0)
            Into n_禁用
            From 合作单位安排控制
            Where 安排id = r_No.安排id And 合作单位 = v_合作单位 And 数量 = 0 And Rownum < 2;
          End If;
        End If;
        --限约数=0的预约禁止
        If Trunc(d_日期) <> Trunc(Sysdate) Then
          If r_No.限约数 = 0 Then
            n_禁用 := 1;
          End If;
        End If;
        If Nvl(n_禁用, 0) = 0 Then
          --从项金额计算
          n_合计金额 := r_No.价格;
          For r_Subfee In (Select 现价, 从项数次
                           From 收费从属项目 A, 收费价目 B
                           Where a.主项id = r_No.项目id And a.从项id = b.收费细目id And d_日期 Between b.执行日期 And
                                 Nvl(b.终止日期, To_Date('3000-1-1', 'YYYY-MM-DD'))) Loop
            n_合计金额 := n_合计金额 + r_Subfee.现价 * r_Subfee.从项数次;
          End Loop;
          If Trunc(Sysdate) = Trunc(d_日期) Then
            Select Nvl(Max(1), 0)
            Into n_Exists
            From (Select 时间段
                   From 时间段
                   Where ('3000-01-10 ' || To_Char(Sysdate, 'HH24:MI:SS') < '3000-01-10 ' || To_Char(终止时间, 'HH24:MI:SS')) Or
                         ('3000-01-10 ' || To_Char(Sysdate, 'HH24:MI:SS') <
                         Decode(Sign(开始时间 - 终止时间), 1, '3000-01-11 ' || To_Char(终止时间, 'HH24:MI:SS'),
                                 '3000-01-10 ' || To_Char(终止时间, 'HH24:MI:SS'))))
            Where 时间段 = r_No.排班;
          Else
            n_Exists := 1;
          End If;
          If n_Exists = 1 Then
            If v_剩余数量 > 0 Then
              c_Xmlmain := '<HB>' || '<HM>' || r_No.号码 || '</HM>' || '<YSID>' || r_No.医生id || '</YSID>' || '<YS>' ||
                           r_No.医生姓名 || '</YS>' || '<KSID>' || r_No.科室id || '</KSID>' || '<KSMC>' || r_No.科室名称 ||
                           '</KSMC>' || '<ZC>' || r_No.职称 || '</ZC>' || '<XMID>' || r_No.项目id || '</XMID>' || '<XMMC>' ||
                           r_No.项目名称 || '</XMMC>' || '<YGHS>' || n_已挂数 || '</YGHS>' || '<SYHS>' || v_剩余数量 || '</SYHS>' ||
                           '<PRICE>' || n_合计金额 || '</PRICE>' || '<HCXH>' || n_缓冲序号 || '</HCXH>' || '<HL>' || r_No.号类 ||
                           '</HL>' || '<FSD>' || n_分时段 || '</FSD>' || '<HBTIME>' || v_时间段 || '</HBTIME>' || '<FWMC>' ||
                           r_No.排班 || '</FWMC>' || v_Temp || '</HB>';
              v_Xmlmain := v_Xmlmain || c_Xmlmain;
            Else
              c_Xmlmain := '<HB>' || '<HM>' || r_No.号码 || '</HM>' || '<YSID>' || r_No.医生id || '</YSID>' || '<YS>' ||
                           r_No.医生姓名 || '</YS>' || '<KSID>' || r_No.科室id || '</KSID>' || '<KSMC>' || r_No.科室名称 ||
                           '</KSMC>' || '<ZC>' || r_No.职称 || '</ZC>' || '<XMID>' || r_No.项目id || '</XMID>' || '<XMMC>' ||
                           r_No.项目名称 || '</XMMC>' || '<YGHS>' || n_已挂数 || '</YGHS>' || '<SYHS>' || v_剩余数量 || '</SYHS>' ||
                           '<PRICE>' || n_合计金额 || '</PRICE>' || '<HL>' || r_No.号类 || '</HL>' || '<FSD>' || n_分时段 ||
                           '</FSD>' || '<HBTIME>' || v_时间段 || '</HBTIME>' || '<FWMC>' || r_No.排班 || '</FWMC>' ||
                           '</HB>';
              v_Xmlmain := v_Xmlmain || c_Xmlmain;
            End If;
          End If;
        End If;
      End If;
      n_合约剩余数量 := 0;
      n_合约总数量   := 0;
      n_时段数量     := 0;
      n_禁用         := 0;
      n_非合约       := 0;
    End Loop;
    v_Xmlmain := '<GROUP>' || '<RQ>' || To_Char(d_日期, 'yyyy-mm-dd') || '</RQ>' || '<HBLIST>' || v_Xmlmain ||
                 '</HBLIST>' || '</GROUP>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Xmlmain)) Into x_Templet From Dual;
  Else
    --出诊表排班模式
    n_合约剩余数量 := 0;
    n_补充天数     := Zl_Fun_Getappointmentdays;
    For r_No In (Select a.科室id, b.号类, c.名称 As 科室名称, a.医生姓名, a.医生id, d.专业技术职务 As 职称, b.号码, a.Id As 记录id, a.上班时段 As 排班,
                        a.项目id, e.名称 As 项目名称, a.是否序号控制 As 序号控制, a.限号数, Nvl(a.限约数, a.限号数) As 限约数, Nvl(a.已挂数, 0) As 已挂数,
                        Nvl(a.已约数, 0) As 已约数, Nvl(a.其中已接收, 0) As 已接收, a.是否分时段 As 分时段, a.开始时间, a.终止时间, a.预约控制, a.替诊开始时间,
                        a.替诊终止时间, Nvl(b.预约天数, n_预约天数) + n_补充天数 As 预约天数, a.停诊开始时间, a.停诊终止时间
                 From 临床出诊记录 A, 临床出诊号源 B, 部门表 C, 人员表 D, 收费项目目录 E
                 Where a.出诊日期 = Trunc(d_日期) And a.终止时间 > Sysdate And a.号源id = b.Id And a.项目id = e.Id And
                       a.医生id = d.Id(+) And b.科室id = c.Id And Nvl(a.是否锁定, 0) = 0 And
                       (a.开始时间 < Nvl(a.停诊开始时间, a.终止时间) Or a.终止时间 > Nvl(a.停诊终止时间, a.开始时间) Or Exists
                        (Select 1
                         From 临床出诊序号控制 C, 临床出诊记录 D
                         Where d.Id = a.Id And c.记录id = d.Id And Nvl(c.是否停诊, 0) = 0 And d.是否序号控制 = 1 And d.是否分时段 = 1 And
                               c.开始时间 <> c.终止时间)) And (a.开始时间 < Nvl(a.替诊开始时间, a.终止时间) Or a.终止时间 > Nvl(a.替诊终止时间, a.开始时间)) And
                       Nvl(a.是否发布, 0) = 1 And a.开始时间 > Trunc(To_Date(v_启用时间, 'yyyy-mm-dd hh24:mi:ss')) And
                       Decode(Nvl(n_科室id, 0), 0, 0, b.科室id) = Nvl(n_科室id, 0) And
                       Decode(Nvl(n_医生id, 0), 0, 0, a.医生id) = Nvl(n_医生id, 0) And
                       Decode(Nvl(v_医生姓名, '-'), '-', '-', a.医生姓名) = Nvl(v_医生姓名, '-')) Loop
      Zl_挂号序号状态_出诊_Delete(r_No.记录id);
      v_Temp := Null;
      If Sysdate + Nvl(r_No.预约天数, n_预约天数) + n_补充天数 >= d_日期 Then
        If Trunc(d_日期) = Trunc(Sysdate) Then
          --当天挂号
          If v_合作单位 Is Null Then
            --未传入合作单位
            n_已挂数   := r_No.已挂数;
            v_剩余数量 := r_No.限号数 - Nvl(r_No.已挂数, 0) - (Nvl(r_No.已约数, 0) - Nvl(r_No.已接收, 0));
            If r_No.分时段 = 1 And r_No.序号控制 = 1 Then
              --分时段
              Select Max(终止时间) Into d_加号时间 From 临床出诊序号控制 Where 记录id = r_No.记录id;
              v_Temp     := '<SPANLIST>';
              n_Exists   := 0;
              n_时段总数 := 0;
              n_时段剩余 := 0;
              d_时段开始 := Null;
              d_时段结束 := Null;
              For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态
                             From 临床出诊序号控制
                             Where 记录id = r_No.记录id And 开始时间 Not Between Nvl(r_No.替诊开始时间, Sysdate) And
                                   Nvl(r_No.替诊终止时间, Sysdate - 1) And Nvl(是否停诊, 0) <> 1) Loop
                If Nvl(n_时间间隔, 0) <> 0 Then
                  If d_时段开始 Is Null Then
                    d_时段开始 := r_Time.开始时间;
                    d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                    n_时段总数 := n_时段总数 + 1;
                    If d_加号时间 < d_时段结束 Then
                      d_时段结束 := d_加号时间;
                    End If;
                  Else
                    If r_Time.开始时间 >= d_时段结束 Then
                      v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                    To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                    '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                      n_时段总数 := 1;
                      n_时段剩余 := 0;
                      d_时段开始 := r_Time.开始时间;
                      d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                      If d_加号时间 < d_时段结束 Then
                        d_时段结束 := d_加号时间;
                      End If;
                    Else
                      n_时段总数 := n_时段总数 + 1;
                    End If;
                  End If;
                End If;
                If r_Time.开始时间 > Sysdate Then
                  If Nvl(n_时间间隔, 0) = 0 Then
                    v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                              To_Char(r_Time.终止时间, 'hh24:mi:ss') || '</SJD>';
                    If Nvl(r_Time.挂号状态, 0) = 0 Then
                      v_Temp   := v_Temp || '<SL>1</SL></SPAN>';
                      n_Exists := n_Exists + 1;
                    Else
                      v_Temp := v_Temp || '<SL>0</SL></SPAN>';
                    End If;
                  Else
                    If Nvl(r_Time.挂号状态, 0) = 0 Then
                      n_时段剩余 := n_时段剩余 + 1;
                      n_Exists   := n_Exists + 1;
                    End If;
                  End If;
                End If;
              End Loop;
              If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                              To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' || '<SL>' ||
                              n_时段剩余 || '</SL>' || '</SPAN>';
                n_时段总数 := 0;
                n_时段剩余 := 0;
                d_时段开始 := Null;
                d_时段结束 := Null;
              End If;
            
              If n_Exists < To_Number(v_剩余数量) And r_No.替诊开始时间 Is Null Then
                v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_加号时间, 'hh24:mi:ss') || '-' || '</SJD><SL>' ||
                          To_Number(v_剩余数量 - n_Exists) || '</SL></SPAN>';
              End If;
              v_Temp := v_Temp || '</SPANLIST>';
            End If;
          Else
            --传入合作单位
            n_已挂数 := r_No.已挂数;
            Begin
              Select 控制方式
              Into n_合约模式
              From 临床出诊挂号控制记录
              Where 记录id = r_No.记录id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1 And Rownum < 2;
            Exception
              When Others Then
                n_合约模式 := 4;
            End;
            If n_合约模式 = 0 Then
              n_禁用 := 1;
            End If;
            If n_合约模式 = 1 Or n_合约模式 = 2 Then
              Select 数量
              Into n_合约总数量
              From 临床出诊挂号控制记录
              Where 记录id = r_No.记录id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1;
              If n_合约模式 = 1 Then
                n_合约总数量 := Round(r_No.限号数 * n_合约总数量 / 100);
              End If;
              Select Count(1)
              Into n_合约已挂数
              From 病人挂号记录
              Where 号别 = r_No.号码 And 记录状态 = 1 And 合作单位 = v_合作单位 And 发生时间 Between Trunc(d_日期) And
                    Trunc(d_日期 + 1) - 1 / 60 / 60 / 24;
              n_合约剩余数量 := n_合约总数量 - n_合约已挂数;
              If r_No.限号数 - Nvl(r_No.已挂数, 0) < n_合约剩余数量 Then
                v_剩余数量 := r_No.限号数 - Nvl(r_No.已挂数, 0);
              Else
                v_剩余数量 := n_合约剩余数量;
              End If;
              If r_No.分时段 = 1 And r_No.序号控制 = 1 Then
                --分时段
                v_Temp   := '<SPANLIST>';
                n_Exists := 0;
                Select Max(终止时间) Into d_加号时间 From 临床出诊序号控制 Where 记录id = r_No.记录id;
                n_时段总数 := 0;
                n_时段剩余 := 0;
                d_时段开始 := Null;
                d_时段结束 := Null;
                For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态
                               From 临床出诊序号控制
                               Where 记录id = r_No.记录id And 开始时间 Not Between Nvl(r_No.替诊开始时间, Sysdate) And
                                     Nvl(r_No.替诊终止时间, Sysdate - 1) And Nvl(是否停诊, 0) <> 1) Loop
                  If Nvl(n_时间间隔, 0) <> 0 Then
                    If d_时段开始 Is Null Then
                      d_时段开始 := r_Time.开始时间;
                      d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                      n_时段总数 := n_时段总数 + 1;
                      If d_加号时间 < d_时段结束 Then
                        d_时段结束 := d_加号时间;
                      End If;
                    Else
                      If r_Time.开始时间 >= d_时段结束 Then
                        v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                      To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                      '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                        n_时段总数 := 1;
                        n_时段剩余 := 0;
                        d_时段开始 := r_Time.开始时间;
                        d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                        If d_加号时间 < d_时段结束 Then
                          d_时段结束 := d_加号时间;
                        End If;
                      Else
                        n_时段总数 := n_时段总数 + 1;
                      End If;
                    End If;
                  End If;
                  If r_Time.开始时间 > Sysdate Then
                    If Nvl(n_时间间隔, 0) = 0 Then
                      v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                To_Char(r_Time.终止时间, 'hh24:mi:ss') || '</SJD>';
                      If Nvl(r_Time.挂号状态, 0) = 0 Then
                        v_Temp   := v_Temp || '<SL>1</SL></SPAN>';
                        n_Exists := n_Exists + 1;
                      Else
                        v_Temp := v_Temp || '<SL>0</SL></SPAN>';
                      End If;
                    Else
                      If Nvl(r_Time.挂号状态, 0) = 0 Then
                        n_时段剩余 := n_时段剩余 + 1;
                        n_Exists   := n_Exists + 1;
                      End If;
                    End If;
                  End If;
                End Loop;
                If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                  v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' || '<SL>' ||
                                n_时段剩余 || '</SL>' || '</SPAN>';
                  n_时段总数 := 0;
                  n_时段剩余 := 0;
                  d_时段开始 := Null;
                  d_时段结束 := Null;
                End If;
                If n_Exists < To_Number(v_剩余数量) And r_No.替诊开始时间 Is Null Then
                  v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_加号时间, 'hh24:mi:ss') || '-' || '</SJD><SL>' ||
                            To_Number(v_剩余数量 - n_Exists) || '</SL></SPAN>';
                End If;
                v_Temp := v_Temp || '</SPANLIST>';
              End If;
            End If;
            If n_合约模式 = 3 Then
              If n_序号控制 = 0 Then
                n_已挂数   := r_No.已挂数;
                v_剩余数量 := r_No.限号数 - Nvl(r_No.已挂数, 0) - (Nvl(r_No.已约数, 0) - Nvl(r_No.已接收, 0));
              Else
                n_已挂数   := 0;
                v_剩余数量 := 0;
                n_时段总数 := 0;
                n_时段剩余 := 0;
                d_时段开始 := Null;
                d_时段结束 := Null;
                For r_合作 In (Select 序号
                             From 临床出诊挂号控制记录
                             Where 记录id = r_No.记录id And 类型 = 1 And 性质 = 1 And 名称 = v_合作单位) Loop
                  Begin
                    Select 1, 开始时间, 终止时间
                    Into n_Exists, d_开始时间, d_终止时间
                    From 临床出诊序号控制
                    Where 序号 = r_合作.序号 And Nvl(挂号状态, 0) = 0 And 开始时间 Not Between Nvl(r_No.替诊开始时间, Sysdate) And
                          Nvl(r_No.替诊终止时间, Sysdate - 1) And Nvl(是否停诊, 0) <> 1;
                  Exception
                    When Others Then
                      n_Exists := 0;
                  End;
                  If Nvl(n_时间间隔, 0) <> 0 Then
                    If d_时段开始 Is Null Then
                      d_时段开始 := d_开始时间;
                      d_时段结束 := d_开始时间 + 1 / 24 / 60 * n_时间间隔;
                      n_时段总数 := n_时段总数 + 1;
                    Else
                      If d_开始时间 >= d_时段结束 Then
                        v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                      To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                      '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                        n_时段总数 := 1;
                        n_时段剩余 := 0;
                        d_时段开始 := d_开始时间;
                        d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                      Else
                        n_时段总数 := n_时段总数 + 1;
                      End If;
                    End If;
                  End If;
                  If n_Exists = 1 Then
                    v_剩余数量 := v_剩余数量 + 1;
                    If r_No.分时段 = 1 Then
                      If d_开始时间 > Sysdate Then
                        If Nvl(n_时间间隔, 0) = 0 Then
                          v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_开始时间, 'hh24:mi:ss') || '-' ||
                                    To_Char(d_终止时间, 'hh24:mi:ss') || '</SJD><SL>1</SL></SPAN>';
                        Else
                          n_时段剩余 := n_时段剩余 + 1;
                        End If;
                      End If;
                    End If;
                  Else
                    n_已挂数 := n_已挂数 + 1;
                  End If;
                End Loop;
                If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                  v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' || '<SL>' ||
                                n_时段剩余 || '</SL>' || '</SPAN>';
                  n_时段总数 := 0;
                  n_时段剩余 := 0;
                  d_时段开始 := Null;
                  d_时段结束 := Null;
                End If;
                If v_Temp Is Not Null Then
                  v_Temp := '<SPANLIST>' || v_Temp || '</SPANLIST>';
                End If;
              End If;
            End If;
            If n_合约模式 = 4 Then
              n_已挂数   := r_No.已挂数;
              v_剩余数量 := r_No.限号数 - Nvl(r_No.已挂数, 0) - (Nvl(r_No.已约数, 0) - Nvl(r_No.已接收, 0));
              If r_No.分时段 = 1 And r_No.序号控制 = 1 Then
                --分时段
                v_Temp   := '<SPANLIST>';
                n_Exists := 0;
                Select Max(终止时间) Into d_加号时间 From 临床出诊序号控制 Where 记录id = r_No.记录id;
                n_时段总数 := 0;
                n_时段剩余 := 0;
                d_时段开始 := Null;
                d_时段结束 := Null;
                For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态
                               From 临床出诊序号控制
                               Where 记录id = r_No.记录id And 开始时间 Not Between Nvl(r_No.替诊开始时间, Sysdate) And
                                     Nvl(r_No.替诊终止时间, Sysdate - 1) And Nvl(是否停诊, 0) <> 1) Loop
                  If Nvl(n_时间间隔, 0) <> 0 Then
                    If d_时段开始 Is Null Then
                      d_时段开始 := r_Time.开始时间;
                      d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                      n_时段总数 := n_时段总数 + 1;
                      If d_加号时间 < d_时段结束 Then
                        d_时段结束 := d_加号时间;
                      End If;
                    Else
                      If r_Time.开始时间 >= d_时段结束 Then
                        v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                      To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                      '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                        n_时段总数 := 1;
                        n_时段剩余 := 0;
                        d_时段开始 := r_Time.开始时间;
                        d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                        If d_加号时间 < d_时段结束 Then
                          d_时段结束 := d_加号时间;
                        End If;
                      Else
                        n_时段总数 := n_时段总数 + 1;
                      End If;
                    End If;
                  End If;
                  If r_Time.开始时间 > Sysdate Then
                    If Nvl(n_时间间隔, 0) = 0 Then
                      v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                To_Char(r_Time.终止时间, 'hh24:mi:ss') || '</SJD>';
                      If Nvl(r_Time.挂号状态, 0) = 0 Then
                        v_Temp   := v_Temp || '<SL>1</SL></SPAN>';
                        n_Exists := n_Exists + 1;
                      Else
                        v_Temp := v_Temp || '<SL>0</SL></SPAN>';
                      End If;
                    Else
                      If Nvl(r_Time.挂号状态, 0) = 0 Then
                        n_时段剩余 := n_时段剩余 + 1;
                        n_Exists   := n_Exists + 1;
                      End If;
                    End If;
                  End If;
                End Loop;
                If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                  v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' || '<SL>' ||
                                n_时段剩余 || '</SL>' || '</SPAN>';
                  n_时段总数 := 0;
                  n_时段剩余 := 0;
                  d_时段开始 := Null;
                  d_时段结束 := Null;
                End If;
                If n_Exists < To_Number(v_剩余数量) And r_No.替诊开始时间 Is Null Then
                  v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_加号时间, 'hh24:mi:ss') || '-' || '</SJD><SL>' ||
                            To_Number(v_剩余数量 - n_Exists) || '</SL></SPAN>';
                End If;
                v_Temp := v_Temp || '</SPANLIST>';
              End If;
            End If;
          End If;
        Else
          --预约挂号
          If r_No.预约控制 = 1 Then
            n_禁用 := 1;
          Else
            --不限制预约
            If v_合作单位 Is Null Then
              If r_No.分时段 = 0 Then
                n_已挂数   := r_No.已约数;
                v_剩余数量 := Nvl(r_No.限约数, r_No.限号数) - Nvl(r_No.已约数, 0);
              Else
                --分时段
                n_已挂数   := 0;
                v_剩余数量 := 0;
                v_Temp     := '<SPANLIST>';
                If r_No.序号控制 = 0 Then
                  --非序号控制分时段预约
                  n_时段总数 := 0;
                  n_时段剩余 := 0;
                  d_时段开始 := Null;
                  d_时段结束 := Null;
                  Select Max(终止时间) Into d_加号时间 From 临床出诊序号控制 Where 记录id = r_No.记录id;
                  For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态, 数量
                                 From 临床出诊序号控制
                                 Where 记录id = r_No.记录id And 预约顺序号 Is Null And 是否预约 = 1 And
                                       开始时间 Not Between Nvl(r_No.替诊开始时间, Sysdate) And Nvl(r_No.替诊终止时间, Sysdate - 1) And
                                       开始时间 Not Between Nvl(r_No.停诊开始时间, Sysdate) And Nvl(r_No.停诊终止时间, Sysdate - 1)) Loop
                    If Nvl(n_时间间隔, 0) <> 0 Then
                      If d_时段开始 Is Null Then
                        d_时段开始 := r_Time.开始时间;
                        d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                        n_时段总数 := n_时段总数 + r_Time.数量;
                        If d_加号时间 < d_时段结束 Then
                          d_时段结束 := d_加号时间;
                        End If;
                      Else
                        If r_Time.开始时间 >= d_时段结束 Then
                          v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                        To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                        '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                          n_时段总数 := r_Time.数量;
                          n_时段剩余 := 0;
                          d_时段开始 := r_Time.开始时间;
                          d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                          If d_加号时间 < d_时段结束 Then
                            d_时段结束 := d_加号时间;
                          End If;
                        Else
                          n_时段总数 := n_时段总数 + r_Time.数量;
                        End If;
                      End If;
                    End If;
                    Select Count(1)
                    Into n_时段已挂
                    From 临床出诊序号控制
                    Where 预约顺序号 Is Not Null And Nvl(挂号状态, 0) <> 0;
                    If r_Time.开始时间 > Sysdate Then
                      If Nvl(n_时间间隔, 0) = 0 Then
                        v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                  To_Char(r_Time.终止时间, 'hh24:mi:ss') || '</SJD>';
                        v_Temp := v_Temp || '<SL>' || r_Time.数量 - n_时段已挂 || '</SL></SPAN>';
                      Else
                        n_时段剩余 := n_时段剩余 + r_Time.数量 - n_时段已挂;
                      End If;
                      n_已挂数   := n_已挂数 + n_时段已挂;
                      v_剩余数量 := v_剩余数量 + (r_Time.数量 - n_时段已挂);
                    End If;
                  End Loop;
                  If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                    v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                  To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                  '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                    n_时段总数 := 0;
                    n_时段剩余 := 0;
                    d_时段开始 := Null;
                    d_时段结束 := Null;
                  End If;
                Else
                  n_时段总数 := 0;
                  n_时段剩余 := 0;
                  d_时段开始 := Null;
                  d_时段结束 := Null;
                  Select Max(终止时间) Into d_加号时间 From 临床出诊序号控制 Where 记录id = r_No.记录id;
                  For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态
                                 From 临床出诊序号控制
                                 Where 记录id = r_No.记录id And 开始时间 Not Between Nvl(r_No.替诊开始时间, Sysdate) And
                                       Nvl(r_No.替诊终止时间, Sysdate - 1) And Nvl(是否停诊, 0) <> 1) Loop
                    If Nvl(n_时间间隔, 0) <> 0 Then
                      If d_时段开始 Is Null Then
                        d_时段开始 := r_Time.开始时间;
                        d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                        n_时段总数 := n_时段总数 + 1;
                        If d_加号时间 < d_时段结束 Then
                          d_时段结束 := d_加号时间;
                        End If;
                      Else
                        If r_Time.开始时间 >= d_时段结束 Then
                          v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                        To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                        '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                          n_时段总数 := 1;
                          n_时段剩余 := 0;
                          d_时段开始 := r_Time.开始时间;
                          d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                          If d_加号时间 < d_时段结束 Then
                            d_时段结束 := d_加号时间;
                          End If;
                        Else
                          n_时段总数 := n_时段总数 + 1;
                        End If;
                      End If;
                    End If;
                    If r_Time.开始时间 > Sysdate Then
                      If Nvl(n_时间间隔, 0) = 0 Then
                        v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                  To_Char(r_Time.终止时间, 'hh24:mi:ss') || '</SJD>';
                        If Nvl(r_Time.挂号状态, 0) = 0 Then
                          v_Temp     := v_Temp || '<SL>1</SL></SPAN>';
                          v_剩余数量 := v_剩余数量 + 1;
                        Else
                          v_Temp   := v_Temp || '<SL>0</SL></SPAN>';
                          n_已挂数 := n_已挂数 + 1;
                        End If;
                      Else
                        If Nvl(r_Time.挂号状态, 0) = 0 Then
                          n_时段剩余 := n_时段剩余 + 1;
                          v_剩余数量 := v_剩余数量 + 1;
                        Else
                          n_已挂数 := n_已挂数 + 1;
                        End If;
                        n_时段剩余 := n_时段剩余 + 1;
                      End If;
                    End If;
                  End Loop;
                  If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                    v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                  To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                  '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                    n_时段总数 := 0;
                    n_时段剩余 := 0;
                    d_时段开始 := Null;
                    d_时段结束 := Null;
                  End If;
                End If;
                v_Temp := v_Temp || '</SPANLIST>';
              End If;
            Else
              --合作单位预约挂号
              If r_No.预约控制 = 2 Then
                n_禁用 := 1;
              Else
                Begin
                  Select 控制方式
                  Into n_合约模式
                  From 临床出诊挂号控制记录
                  Where 记录id = r_No.记录id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1 And Rownum < 2;
                Exception
                  When Others Then
                    n_合约模式 := 4;
                End;
                If n_合约模式 = 0 Then
                  n_禁用 := 1;
                End If;
                If n_合约模式 = 1 Or n_合约模式 = 2 Then
                  Select 数量
                  Into n_合约总数量
                  From 临床出诊挂号控制记录
                  Where 记录id = r_No.记录id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1;
                  If n_合约模式 = 1 Then
                    n_合约总数量 := Round(r_No.限号数 * n_合约总数量 / 100);
                  End If;
                  Begin
                    Select Count(1)
                    Into n_合约已挂数
                    From 病人挂号记录
                    Where 号别 = r_No.号码 And 记录状态 = 1 And 合作单位 = v_合作单位 And 发生时间 Between Trunc(d_日期) And
                          Trunc(d_日期 + 1) - 1 / 60 / 60 / 24;
                  Exception
                    When Others Then
                      n_合约已挂数 := 0;
                  End;
                  n_合约剩余数量 := n_合约总数量 - n_合约已挂数;
                  If Nvl(r_No.限约数, r_No.限号数) - Nvl(r_No.已约数, 0) < n_合约剩余数量 Then
                    v_剩余数量 := Nvl(r_No.限约数, r_No.限号数) - Nvl(r_No.已约数, 0);
                  Else
                    v_剩余数量 := n_合约剩余数量;
                  End If;
                  If r_No.分时段 = 1 Then
                    v_Temp := '<SPANLIST>';
                    If r_No.序号控制 = 1 Then
                      --分时段,序号控制
                      n_Exists   := 0;
                      n_时段总数 := 0;
                      n_时段剩余 := 0;
                      d_时段开始 := Null;
                      d_时段结束 := Null;
                      Select Max(终止时间) Into d_加号时间 From 临床出诊序号控制 Where 记录id = r_No.记录id;
                      For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态
                                     From 临床出诊序号控制
                                     Where 记录id = r_No.记录id And 开始时间 Not Between Nvl(r_No.替诊开始时间, Sysdate) And
                                           Nvl(r_No.替诊终止时间, Sysdate - 1) And Nvl(是否停诊, 0) <> 1) Loop
                        If Nvl(n_时间间隔, 0) <> 0 Then
                          If d_时段开始 Is Null Then
                            d_时段开始 := r_Time.开始时间;
                            d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                            n_时段总数 := n_时段总数 + 1;
                            If d_加号时间 < d_时段结束 Then
                              d_时段结束 := d_加号时间;
                            End If;
                          Else
                            If r_Time.开始时间 >= d_时段结束 Then
                              v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                            To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 ||
                                            '</GHZS>' || '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                              n_时段总数 := 1;
                              n_时段剩余 := 0;
                              d_时段开始 := r_Time.开始时间;
                              d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                              If d_加号时间 < d_时段结束 Then
                                d_时段结束 := d_加号时间;
                              End If;
                            Else
                              n_时段总数 := n_时段总数 + 1;
                            End If;
                          End If;
                        End If;
                        If r_Time.开始时间 > Sysdate Then
                          If Nvl(n_时间间隔, 0) = 0 Then
                            v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                      To_Char(r_Time.终止时间, 'hh24:mi:ss') || '</SJD>';
                            If Nvl(r_Time.挂号状态, 0) = 0 Then
                              v_Temp   := v_Temp || '<SL>1</SL></SPAN>';
                              n_Exists := n_Exists + 1;
                            Else
                              v_Temp := v_Temp || '<SL>0</SL></SPAN>';
                            End If;
                          Else
                            n_Exists   := n_Exists + 1;
                            n_时段剩余 := n_时段剩余 + 1;
                          End If;
                        End If;
                      End Loop;
                      If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                        v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                      To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                      '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                        n_时段总数 := 0;
                        n_时段剩余 := 0;
                        d_时段开始 := Null;
                        d_时段结束 := Null;
                      End If;
                      If n_Exists < To_Number(v_剩余数量) Then
                        v_剩余数量 := n_Exists;
                      End If;
                    Else
                      --分时段,非序号控制
                      n_Exists   := 0;
                      n_时段总数 := 0;
                      n_时段剩余 := 0;
                      d_时段开始 := Null;
                      d_时段结束 := Null;
                      Select Max(终止时间) Into d_加号时间 From 临床出诊序号控制 Where 记录id = r_No.记录id;
                      For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态, 数量
                                     From 临床出诊序号控制
                                     Where 记录id = r_No.记录id And 预约顺序号 Is Null And 是否预约 = 1 And
                                           开始时间 Not Between Nvl(r_No.替诊开始时间, Sysdate) And Nvl(r_No.替诊终止时间, Sysdate - 1) And
                                           开始时间 Not Between Nvl(r_No.停诊开始时间, Sysdate) And Nvl(r_No.停诊终止时间, Sysdate - 1)) Loop
                        If Nvl(n_时间间隔, 0) <> 0 Then
                          If d_时段开始 Is Null Then
                            d_时段开始 := r_Time.开始时间;
                            d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                            n_时段总数 := n_时段总数 + r_Time.数量;
                            If d_加号时间 < d_时段结束 Then
                              d_时段结束 := d_加号时间;
                            End If;
                          Else
                            If r_Time.开始时间 >= d_时段结束 Then
                              v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                            To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 ||
                                            '</GHZS>' || '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                              n_时段总数 := r_Time.数量;
                              n_时段剩余 := 0;
                              d_时段开始 := r_Time.开始时间;
                              d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                              If d_加号时间 < d_时段结束 Then
                                d_时段结束 := d_加号时间;
                              End If;
                            Else
                              n_时段总数 := n_时段总数 + r_Time.数量;
                            End If;
                          End If;
                        End If;
                        Select Count(1)
                        Into n_时段已挂
                        From 临床出诊序号控制
                        Where 预约顺序号 Is Not Null And Nvl(挂号状态, 0) <> 0;
                        If r_Time.开始时间 > Sysdate Then
                          If Nvl(n_时间间隔, 0) = 0 Then
                            v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                      To_Char(r_Time.终止时间, 'hh24:mi:ss') || '</SJD>';
                            v_Temp := v_Temp || '<SL>' || r_Time.数量 - n_时段已挂 || '</SL></SPAN>';
                          Else
                            n_时段剩余 := n_时段剩余 + (r_Time.数量 - n_时段已挂);
                          End If;
                          n_Exists := n_Exists + (r_Time.数量 - n_时段已挂);
                        End If;
                      End Loop;
                      If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                        v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                      To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                      '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                        n_时段总数 := 0;
                        n_时段剩余 := 0;
                        d_时段开始 := Null;
                        d_时段结束 := Null;
                      End If;
                      If n_Exists < To_Number(v_剩余数量) Then
                        v_剩余数量 := n_Exists;
                      End If;
                    End If;
                    v_Temp := v_Temp || '</SPANLIST>';
                  End If;
                  n_已挂数 := r_No.已约数;
                End If;
                If n_合约模式 = 3 Then
                  If r_No.分时段 = 0 Then
                    If r_No.序号控制 = 0 Then
                      n_禁用 := 1;
                    Else
                      n_已挂数   := 0;
                      v_剩余数量 := 0;
                      For r_合作 In (Select 序号
                                   From 临床出诊挂号控制记录
                                   Where 记录id = r_No.记录id And 类型 = 1 And 性质 = 1 And 名称 = v_合作单位) Loop
                        Begin
                          Select 1
                          Into n_Exists
                          From 临床出诊序号控制
                          Where 记录id = r_No.记录id And 序号 = r_合作.序号 And 是否预约 = 1 And Nvl(挂号状态, 0) = 0 And
                                开始时间 Not Between Nvl(r_No.替诊开始时间, Sysdate) And Nvl(r_No.替诊终止时间, Sysdate - 1) And
                                Nvl(是否停诊, 0) <> 1;
                        Exception
                          When Others Then
                            n_Exists := 0;
                        End;
                        If n_Exists = 1 Then
                          v_剩余数量 := v_剩余数量 + 1;
                        Else
                          n_已挂数 := n_已挂数 + 1;
                        End If;
                      End Loop;
                      If Nvl(r_No.限约数, r_No.限号数) - Nvl(r_No.已约数, 0) < v_剩余数量 Then
                        v_剩余数量 := Nvl(r_No.限约数, r_No.限号数) - Nvl(r_No.已约数, 0);
                      End If;
                    End If;
                  Else
                    If r_No.序号控制 = 0 Then
                      --合作单位,分时段,非序号控制
                      n_已挂数   := 0;
                      v_剩余数量 := 0;
                      v_Temp     := '<SPANLIST>';
                      n_时段总数 := 0;
                      n_时段剩余 := 0;
                      d_时段开始 := Null;
                      d_时段结束 := Null;
                      For r_合作 In (Select 序号, 数量
                                   From 临床出诊挂号控制记录
                                   Where 记录id = r_No.记录id And 类型 = 1 And 性质 = 1 And 名称 = v_合作单位) Loop
                        Begin
                          Select Count(1), Max(开始时间), Max(终止时间)
                          Into n_时段已挂, d_开始时间, d_终止时间
                          From 临床出诊序号控制
                          Where 记录id = r_No.记录id And 预约顺序号 Is Not Null And Nvl(挂号状态, 0) <> 0 And 序号 = r_合作.序号 And
                                开始时间 Not Between Nvl(r_No.替诊开始时间, Sysdate) And Nvl(r_No.替诊终止时间, Sysdate - 1);
                        
                          If Nvl(n_时间间隔, 0) <> 0 Then
                            If d_时段开始 Is Null Then
                              d_时段开始 := d_开始时间;
                              d_时段结束 := d_开始时间 + 1 / 24 / 60 * n_时间间隔;
                              n_时段总数 := n_时段总数 + r_合作.数量;
                            Else
                              If d_开始时间 >= d_时段结束 Then
                                v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                              To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 ||
                                              '</GHZS>' || '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                                n_时段总数 := r_合作.数量;
                                n_时段剩余 := 0;
                                d_时段开始 := d_开始时间;
                                d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                              Else
                                n_时段总数 := n_时段总数 + r_合作.数量;
                              End If;
                            End If;
                          End If;
                          If d_开始时间 > Sysdate Then
                            n_已挂数 := n_已挂数 + n_时段已挂;
                            If Nvl(n_时间间隔, 0) = 0 Then
                              v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_开始时间, 'hh24:mi:ss') || '-' ||
                                        To_Char(d_终止时间, 'hh24:mi:ss') || '</SJD>';
                              v_Temp := v_Temp || '<SL>' || r_合作.数量 - n_时段已挂 || '</SL></SPAN>';
                            Else
                              n_时段剩余 := n_时段剩余 + r_合作.数量 - n_时段已挂;
                            End If;
                            v_剩余数量 := v_剩余数量 + r_合作.数量 - n_时段已挂;
                          End If;
                        Exception
                          When Others Then
                            Null;
                        End;
                      End Loop;
                      If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                        v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                      To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                      '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                        n_时段总数 := 0;
                        n_时段剩余 := 0;
                        d_时段开始 := Null;
                        d_时段结束 := Null;
                      End If;
                      v_Temp := v_Temp || '</SPANLIST>';
                    Else
                      n_已挂数   := 0;
                      v_剩余数量 := 0;
                      v_Temp     := '<SPANLIST>';
                      n_时段总数 := 0;
                      n_时段剩余 := 0;
                      d_时段开始 := Null;
                      d_时段结束 := Null;
                      For r_合作 In (Select 序号
                                   From 临床出诊挂号控制记录
                                   Where 记录id = r_No.记录id And 类型 = 1 And 性质 = 1 And 名称 = v_合作单位) Loop
                        Begin
                          Select 1, 开始时间, 终止时间
                          Into n_Exists, d_开始时间, d_终止时间
                          From 临床出诊序号控制
                          Where 记录id = r_No.记录id And Nvl(挂号状态, 0) = 0 And 序号 = r_合作.序号 And
                                开始时间 Not Between Nvl(r_No.替诊开始时间, Sysdate) And Nvl(r_No.替诊终止时间, Sysdate - 1) And
                                Nvl(是否停诊, 0) <> 1;
                        Exception
                          When Others Then
                            n_Exists := 0;
                        End;
                        If Nvl(n_时间间隔, 0) <> 0 Then
                          If d_时段开始 Is Null Then
                            d_时段开始 := d_开始时间;
                            d_时段结束 := d_开始时间 + 1 / 24 / 60 * n_时间间隔;
                            n_时段总数 := n_时段总数 + 1;
                          Else
                            If d_开始时间 >= d_时段结束 Then
                              v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                            To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 ||
                                            '</GHZS>' || '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                              n_时段总数 := 1;
                              n_时段剩余 := 0;
                              d_时段开始 := d_开始时间;
                              d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                            Else
                              n_时段总数 := n_时段总数 + 1;
                            End If;
                          End If;
                        End If;
                        If d_开始时间 > Sysdate Then
                          If n_Exists = 1 Then
                            v_剩余数量 := v_剩余数量 + 1;
                            If Nvl(n_时间间隔, 0) = 0 Then
                              v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_开始时间, 'hh24:mi:ss') || '-' ||
                                        To_Char(d_终止时间, 'hh24:mi:ss') || '</SJD>';
                              v_Temp := v_Temp || '<SL>' || 1 || '</SL></SPAN>';
                            Else
                              n_时段剩余 := n_时段剩余 + 1;
                            End If;
                          Else
                            If Nvl(n_时间间隔, 0) = 0 Then
                              v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_开始时间, 'hh24:mi:ss') || '-' ||
                                        To_Char(d_终止时间, 'hh24:mi:ss') || '</SJD>';
                              v_Temp := v_Temp || '<SL>' || 0 || '</SL></SPAN>';
                            End If;
                            n_已挂数 := n_已挂数 + 1;
                          End If;
                        End If;
                      End Loop;
                      If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                        v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                      To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                      '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                        n_时段总数 := 0;
                        n_时段剩余 := 0;
                        d_时段开始 := Null;
                        d_时段结束 := Null;
                      End If;
                    End If;
                  End If;
                End If;
                If n_合约模式 = 4 Then
                  If r_No.分时段 = 0 Then
                    n_已挂数   := r_No.已约数;
                    v_剩余数量 := Nvl(r_No.限约数, r_No.限号数) - Nvl(r_No.已约数, 0);
                  Else
                    --分时段
                    n_已挂数   := 0;
                    v_剩余数量 := 0;
                    v_Temp     := '<SPANLIST>';
                    n_时段总数 := 0;
                    n_时段剩余 := 0;
                    d_时段开始 := Null;
                    d_时段结束 := Null;
                    Select Max(终止时间) Into d_加号时间 From 临床出诊序号控制 Where 记录id = r_No.记录id;
                    If r_No.序号控制 = 0 Then
                      --非序号控制分时段预约
                      For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态, 数量
                                     From 临床出诊序号控制
                                     Where 记录id = r_No.记录id And 预约顺序号 Is Null And 是否预约 = 1 And
                                           开始时间 Not Between Nvl(r_No.替诊开始时间, Sysdate) And Nvl(r_No.替诊终止时间, Sysdate - 1) And
                                           开始时间 Not Between Nvl(r_No.停诊开始时间, Sysdate) And Nvl(r_No.停诊终止时间, Sysdate - 1)) Loop
                        If Nvl(n_时间间隔, 0) <> 0 Then
                          If d_时段开始 Is Null Then
                            d_时段开始 := r_Time.开始时间;
                            d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                            n_时段总数 := n_时段总数 + r_Time.数量;
                            If d_加号时间 < d_时段结束 Then
                              d_时段结束 := d_加号时间;
                            End If;
                          Else
                            If r_Time.开始时间 >= d_时段结束 Then
                              v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                            To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 ||
                                            '</GHZS>' || '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                              n_时段总数 := r_Time.数量;
                              n_时段剩余 := 0;
                              d_时段开始 := r_Time.开始时间;
                              d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                              If d_加号时间 < d_时段结束 Then
                                d_时段结束 := d_加号时间;
                              End If;
                            Else
                              n_时段总数 := n_时段总数 + r_Time.数量;
                            End If;
                          End If;
                        End If;
                        Select Count(1)
                        Into n_时段已挂
                        From 临床出诊序号控制
                        Where 预约顺序号 Is Not Null And Nvl(挂号状态, 0) <> 0;
                        If r_Time.开始时间 > Sysdate Then
                          If Nvl(n_时间间隔, 0) = 0 Then
                            v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                      To_Char(r_Time.终止时间, 'hh24:mi:ss') || '</SJD>';
                            v_Temp := v_Temp || '<SL>' || r_Time.数量 - n_时段已挂 || '</SL></SPAN>';
                          Else
                            n_时段剩余 := n_时段剩余 + (r_Time.数量 - n_时段已挂);
                          End If;
                          n_已挂数   := n_已挂数 + n_时段已挂;
                          v_剩余数量 := v_剩余数量 + (r_Time.数量 - n_时段已挂);
                        End If;
                      End Loop;
                      If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                        v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                      To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                      '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                        n_时段总数 := 0;
                        n_时段剩余 := 0;
                        d_时段开始 := Null;
                        d_时段结束 := Null;
                      End If;
                    Else
                      n_时段总数 := 0;
                      n_时段剩余 := 0;
                      d_时段开始 := Null;
                      d_时段结束 := Null;
                      For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态
                                     From 临床出诊序号控制
                                     Where 记录id = r_No.记录id And 开始时间 Not Between Nvl(r_No.替诊开始时间, Sysdate) And
                                           Nvl(r_No.替诊终止时间, Sysdate - 1) And Nvl(是否停诊, 0) <> 1) Loop
                        If Nvl(n_时间间隔, 0) <> 0 Then
                          If d_时段开始 Is Null Then
                            d_时段开始 := r_Time.开始时间;
                            d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                            n_时段总数 := n_时段总数 + 1;
                            If d_加号时间 < d_时段结束 Then
                              d_时段结束 := d_加号时间;
                            End If;
                          Else
                            If r_Time.开始时间 >= d_时段结束 Then
                              v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                            To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 ||
                                            '</GHZS>' || '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                              n_时段总数 := 1;
                              n_时段剩余 := 0;
                              d_时段开始 := r_Time.开始时间;
                              d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                              If d_加号时间 < d_时段结束 Then
                                d_时段结束 := d_加号时间;
                              End If;
                            Else
                              n_时段总数 := n_时段总数 + 1;
                            End If;
                          End If;
                        End If;
                        If r_Time.开始时间 > Sysdate Then
                          If Nvl(n_时间间隔, 0) = 0 Then
                            v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                      To_Char(r_Time.终止时间, 'hh24:mi:ss') || '</SJD>';
                            If Nvl(r_Time.挂号状态, 0) = 0 Then
                              v_Temp     := v_Temp || '<SL>1</SL></SPAN>';
                              v_剩余数量 := v_剩余数量 + 1;
                            Else
                              v_Temp   := v_Temp || '<SL>0</SL></SPAN>';
                              n_已挂数 := n_已挂数 + 1;
                            End If;
                          Else
                            If Nvl(r_Time.挂号状态, 0) = 0 Then
                              n_时段剩余 := n_时段剩余 + 1;
                              v_剩余数量 := v_剩余数量 + 1;
                            Else
                              n_已挂数 := n_已挂数 + 1;
                            End If;
                          End If;
                        End If;
                      End Loop;
                      If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                        v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                      To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                      '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                        n_时段总数 := 0;
                        n_时段剩余 := 0;
                        d_时段开始 := Null;
                        d_时段结束 := Null;
                      End If;
                    End If;
                    v_Temp := v_Temp || '</SPANLIST>';
                  End If;
                End If;
              End If;
            End If;
          End If;
        End If;
      
        If Not (r_No.分时段 = 1 And r_No.序号控制 = 1) Then
          If d_日期 Between Nvl(r_No.替诊开始时间, Sysdate) And Nvl(r_No.替诊终止时间, Sysdate - 1) Then
            n_禁用 := 1;
          End If;
          If d_日期 Between Nvl(r_No.停诊开始时间, Sysdate) And Nvl(r_No.停诊终止时间, Sysdate - 1) Then
            n_禁用 := 1;
          End If;
        End If;
      
        If Nvl(n_禁用, 0) = 0 Then
          n_合计金额 := 0;
          For r_Fee In (Select b.现价, a.从项数次
                        From 收费从属项目 A, 收费价目 B
                        Where a.主项id = r_No.项目id And a.从项id = b.收费细目id And d_日期 Between b.执行日期 And
                              Nvl(b.终止日期, To_Date('3000-1-1', 'YYYY-MM-DD'))
                        Union
                        Select b.现价, 1 As 从项数次
                        From 收费项目目录 A, 收费价目 B
                        Where a.Id = b.收费细目id And a.Id = r_No.项目id And d_日期 Between b.执行日期 And
                              Nvl(b.终止日期, To_Date('3000-1-1', 'YYYY-MM-DD'))) Loop
            n_合计金额 := n_合计金额 + r_Fee.现价 * r_Fee.从项数次;
          End Loop;
          v_时间段 := To_Char(r_No.开始时间, 'HH24:MI') || '-' || To_Char(r_No.终止时间, 'HH24:MI');
          If Trunc(Sysdate) = Trunc(d_日期) Then
            c_Xmlmain := '<HB>' || '<CZJLID>' || r_No.记录id || '</CZJLID>' || '<HM>' || r_No.号码 || '</HM>' || '<YSID>' ||
                         r_No.医生id || '</YSID>' || '<YS>' || r_No.医生姓名 || '</YS>' || '<KSID>' || r_No.科室id || '</KSID>' ||
                         '<KSMC>' || r_No.科室名称 || '</KSMC>' || '<ZC>' || r_No.职称 || '</ZC>' || '<XMID>' || r_No.项目id ||
                         '</XMID>' || '<XMMC>' || r_No.项目名称 || '</XMMC>' || '<YGHS>' || n_已挂数 || '</YGHS>' || '<SYHS>' ||
                         v_剩余数量 || '</SYHS>' || '<PRICE>' || n_合计金额 || '</PRICE>' || '<HL>' || r_No.号类 || '</HL>' ||
                         '<FSD>' || r_No.分时段 || '</FSD>' || '<HBTIME>' || v_时间段 || '</HBTIME>' || '<FWMC>' || r_No.排班 ||
                         '</FWMC>' || v_Temp || '</HB>';
            v_Xmlmain := v_Xmlmain || c_Xmlmain;
          Else
            If r_No.已约数 >= r_No.限约数 Then
              c_Xmlmain := '<HB>' || '<CZJLID>' || r_No.记录id || '</CZJLID>' || '<HM>' || r_No.号码 || '</HM>' || '<YSID>' ||
                           r_No.医生id || '</YSID>' || '<YS>' || r_No.医生姓名 || '</YS>' || '<KSID>' || r_No.科室id ||
                           '</KSID>' || '<KSMC>' || r_No.科室名称 || '</KSMC>' || '<ZC>' || r_No.职称 || '</ZC>' || '<XMID>' ||
                           r_No.项目id || '</XMID>' || '<XMMC>' || r_No.项目名称 || '</XMMC>' || '<YGHS>' || r_No.已约数 ||
                           '</YGHS>' || '<SYHS>' || 0 || '</SYHS>' || '<PRICE>' || n_合计金额 || '</PRICE>' || '<HL>' ||
                           r_No.号类 || '</HL>' || '<FSD>' || r_No.分时段 || '</FSD>' || '<HBTIME>' || v_时间段 || '</HBTIME>' ||
                           '<FWMC>' || r_No.排班 || '</FWMC>' || '</HB>';
              v_Xmlmain := v_Xmlmain || c_Xmlmain;
            Else
              c_Xmlmain := '<HB>' || '<CZJLID>' || r_No.记录id || '</CZJLID>' || '<HM>' || r_No.号码 || '</HM>' || '<YSID>' ||
                           r_No.医生id || '</YSID>' || '<YS>' || r_No.医生姓名 || '</YS>' || '<KSID>' || r_No.科室id ||
                           '</KSID>' || '<KSMC>' || r_No.科室名称 || '</KSMC>' || '<ZC>' || r_No.职称 || '</ZC>' || '<XMID>' ||
                           r_No.项目id || '</XMID>' || '<XMMC>' || r_No.项目名称 || '</XMMC>' || '<YGHS>' || n_已挂数 ||
                           '</YGHS>' || '<SYHS>' || v_剩余数量 || '</SYHS>' || '<PRICE>' || n_合计金额 || '</PRICE>' || '<HL>' ||
                           r_No.号类 || '</HL>' || '<FSD>' || r_No.分时段 || '</FSD>' || '<HBTIME>' || v_时间段 || '</HBTIME>' ||
                           '<FWMC>' || r_No.排班 || '</FWMC>' || v_Temp || '</HB>';
              v_Xmlmain := v_Xmlmain || c_Xmlmain;
            End If;
          End If;
        End If;
      End If;
      n_禁用 := 0;
    End Loop;
  
    --加入替诊号源
    n_合约剩余数量 := 0;
    For r_No In (Select a.科室id, b.号类, c.名称 As 科室名称, a.替诊医生姓名 As 医生姓名, a.替诊医生id As 医生id, d.专业技术职务 As 职称, b.号码,
                        a.Id As 记录id, a.上班时段 As 排班, a.项目id, e.名称 As 项目名称, a.是否序号控制 As 序号控制, a.限号数,
                        Nvl(a.限约数, a.限号数) As 限约数, Nvl(a.已挂数, 0) As 已挂数, Nvl(a.已约数, 0) As 已约数, Nvl(a.其中已接收, 0) As 已接收,
                        a.是否分时段 As 分时段, a.开始时间, a.终止时间, a.预约控制, a.替诊开始时间, a.替诊终止时间, Nvl(b.预约天数, n_预约天数) + n_补充天数 As 预约天数,
                        a.停诊开始时间, a.停诊终止时间
                 From 临床出诊记录 A, 临床出诊号源 B, 部门表 C, 人员表 D, 收费项目目录 E
                 Where a.出诊日期 = Trunc(d_日期) And a.替诊医生姓名 Is Not Null And a.终止时间 > Sysdate And a.号源id = b.Id And
                       a.项目id = e.Id And a.替诊医生id = d.Id(+) And b.科室id = c.Id And Nvl(a.是否锁定, 0) = 0 And
                       (a.开始时间 < Nvl(a.停诊开始时间, a.终止时间) Or a.终止时间 > Nvl(a.停诊终止时间, a.开始时间) Or Exists
                        (Select 1
                         From 临床出诊序号控制 C, 临床出诊记录 D
                         Where d.Id = a.Id And c.记录id = d.Id And Nvl(c.是否停诊, 0) = 0 And d.是否序号控制 = 1 And d.是否分时段 = 1 And
                               c.开始时间 <> c.终止时间)) And Nvl(a.是否发布, 0) = 1 And
                       a.开始时间 > Trunc(To_Date(v_启用时间, 'yyyy-mm-dd hh24:mi:ss')) And
                       Decode(Nvl(n_科室id, 0), 0, 0, b.科室id) = Nvl(n_科室id, 0) And
                       Decode(Nvl(n_医生id, 0), 0, 0, a.医生id) = Nvl(n_医生id, 0) And
                       Decode(Nvl(v_医生姓名, '-'), '-', '-', a.医生姓名) = Nvl(v_医生姓名, '-')) Loop
      v_Temp := '';
      If Sysdate + Nvl(r_No.预约天数, n_预约天数) + n_补充天数 >= d_日期 Then
        If Trunc(d_日期) = Trunc(Sysdate) Then
          --当天挂号
          If v_合作单位 Is Null Then
            --未传入合作单位
            n_已挂数   := r_No.已挂数;
            v_剩余数量 := r_No.限号数 - Nvl(r_No.已挂数, 0);
            If r_No.分时段 = 1 And r_No.序号控制 = 1 Then
              --分时段
              v_Temp     := '<SPANLIST>';
              n_Exists   := 0;
              n_时段总数 := 0;
              n_时段剩余 := 0;
              d_时段开始 := Null;
              d_时段结束 := Null;
              Select Max(终止时间) Into d_加号时间 From 临床出诊序号控制 Where 记录id = r_No.记录id;
              For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态
                             From 临床出诊序号控制
                             Where 记录id = r_No.记录id And 开始时间 Between Nvl(r_No.替诊开始时间, Sysdate) And
                                   Nvl(r_No.替诊终止时间, Sysdate - 1) And Nvl(是否停诊, 0) <> 1) Loop
                If Nvl(n_时间间隔, 0) <> 0 Then
                  If d_时段开始 Is Null Then
                    d_时段开始 := r_Time.开始时间;
                    d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                    n_时段总数 := n_时段总数 + 1;
                    If d_加号时间 < d_时段结束 Then
                      d_时段结束 := d_加号时间;
                    End If;
                  Else
                    If r_Time.开始时间 >= d_时段结束 Then
                      v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                    To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                    '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                      n_时段总数 := 1;
                      n_时段剩余 := 0;
                      d_时段开始 := r_Time.开始时间;
                      d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                      If d_加号时间 < d_时段结束 Then
                        d_时段结束 := d_加号时间;
                      End If;
                    Else
                      n_时段总数 := n_时段总数 + 1;
                    End If;
                  End If;
                End If;
                If r_Time.开始时间 > Sysdate Then
                  If Nvl(n_时间间隔, 0) = 0 Then
                    v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                              To_Char(r_Time.终止时间, 'hh24:mi:ss') || '</SJD>';
                    If Nvl(r_Time.挂号状态, 0) = 0 Then
                      v_Temp   := v_Temp || '<SL>1</SL></SPAN>';
                      n_Exists := n_Exists + 1;
                    Else
                      v_Temp := v_Temp || '<SL>0</SL></SPAN>';
                    End If;
                  Else
                    If Nvl(r_Time.挂号状态, 0) = 0 Then
                      n_Exists   := n_Exists + 1;
                      n_时段剩余 := n_时段剩余 + 1;
                    End If;
                  End If;
                End If;
              End Loop;
              If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                              To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' || '<SL>' ||
                              n_时段剩余 || '</SL>' || '</SPAN>';
                n_时段总数 := 0;
                n_时段剩余 := 0;
                d_时段开始 := Null;
                d_时段结束 := Null;
              End If;
              If n_Exists < To_Number(v_剩余数量) And r_No.替诊开始时间 Is Null Then
                v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_加号时间, 'hh24:mi:ss') || '-' || '</SJD><SL>' ||
                          To_Number(v_剩余数量 - n_Exists) || '</SL></SPAN>';
              End If;
              v_Temp := v_Temp || '</SPANLIST>';
            End If;
          Else
            --传入合作单位
            n_已挂数 := r_No.已挂数;
            Begin
              Select 控制方式
              Into n_合约模式
              From 临床出诊挂号控制记录
              Where 记录id = r_No.记录id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1 And Rownum < 2;
            Exception
              When Others Then
                n_合约模式 := 4;
            End;
            If n_合约模式 = 0 Then
              n_禁用 := 1;
            End If;
            If n_合约模式 = 1 Or n_合约模式 = 2 Then
              Select 数量
              Into n_合约总数量
              From 临床出诊挂号控制记录
              Where 记录id = r_No.记录id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1;
              If n_合约模式 = 1 Then
                n_合约总数量 := Round(r_No.限号数 * n_合约总数量 / 100);
              End If;
              Select Count(1)
              Into n_合约已挂数
              From 病人挂号记录
              Where 号别 = r_No.号码 And 记录状态 = 1 And 合作单位 = v_合作单位 And 发生时间 Between Trunc(d_日期) And
                    Trunc(d_日期 + 1) - 1 / 60 / 60 / 24;
              n_合约剩余数量 := n_合约总数量 - n_合约已挂数;
              If r_No.限号数 - Nvl(r_No.已挂数, 0) < n_合约剩余数量 Then
                v_剩余数量 := r_No.限号数 - Nvl(r_No.已挂数, 0);
              Else
                v_剩余数量 := n_合约剩余数量;
              End If;
              If r_No.分时段 = 1 And r_No.序号控制 = 1 Then
                --分时段
                v_Temp   := '<SPANLIST>';
                n_Exists := 0;
                Select Max(终止时间) Into d_加号时间 From 临床出诊序号控制 Where 记录id = r_No.记录id;
                n_时段总数 := 0;
                n_时段剩余 := 0;
                d_时段开始 := Null;
                d_时段结束 := Null;
                For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态
                               From 临床出诊序号控制
                               Where 记录id = r_No.记录id And 开始时间 Between Nvl(r_No.替诊开始时间, Sysdate) And
                                     Nvl(r_No.替诊终止时间, Sysdate - 1) And Nvl(是否停诊, 0) <> 1) Loop
                
                  If Nvl(n_时间间隔, 0) <> 0 Then
                    If d_时段开始 Is Null Then
                      d_时段开始 := r_Time.开始时间;
                      d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                      n_时段总数 := n_时段总数 + 1;
                      If d_加号时间 < d_时段结束 Then
                        d_时段结束 := d_加号时间;
                      End If;
                    Else
                      If r_Time.开始时间 >= d_时段结束 Then
                        v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                      To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                      '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                        n_时段总数 := 1;
                        n_时段剩余 := 0;
                        d_时段开始 := r_Time.开始时间;
                        d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                        If d_加号时间 < d_时段结束 Then
                          d_时段结束 := d_加号时间;
                        End If;
                      Else
                        n_时段总数 := n_时段总数 + 1;
                      End If;
                    End If;
                  End If;
                  If r_Time.开始时间 > Sysdate Then
                    If Nvl(n_时间间隔, 0) = 0 Then
                      v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                To_Char(r_Time.终止时间, 'hh24:mi:ss') || '</SJD>';
                      If Nvl(r_Time.挂号状态, 0) = 0 Then
                        v_Temp   := v_Temp || '<SL>1</SL></SPAN>';
                        n_Exists := n_Exists + 1;
                      Else
                        v_Temp := v_Temp || '<SL>0</SL></SPAN>';
                      End If;
                    Else
                      If Nvl(r_Time.挂号状态, 0) = 0 Then
                        n_Exists   := n_Exists + 1;
                        n_时段剩余 := n_时段剩余 + 1;
                      End If;
                    End If;
                  End If;
                End Loop;
                If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                  v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' || '<SL>' ||
                                n_时段剩余 || '</SL>' || '</SPAN>';
                  n_时段总数 := 0;
                  n_时段剩余 := 0;
                  d_时段开始 := Null;
                  d_时段结束 := Null;
                End If;
                If n_Exists < To_Number(v_剩余数量) And r_No.替诊开始时间 Is Null Then
                  v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_加号时间, 'hh24:mi:ss') || '-' || '</SJD><SL>' ||
                            To_Number(v_剩余数量 - n_Exists) || '</SL></SPAN>';
                End If;
                v_Temp := v_Temp || '</SPANLIST>';
              End If;
            End If;
            If n_合约模式 = 3 Then
              If n_序号控制 = 0 Then
                n_已挂数   := r_No.已挂数;
                v_剩余数量 := r_No.限号数 - Nvl(r_No.已挂数, 0);
              Else
                n_已挂数   := 0;
                v_剩余数量 := 0;
                n_时段总数 := 0;
                n_时段剩余 := 0;
                d_时段开始 := Null;
                d_时段结束 := Null;
                For r_合作 In (Select 序号
                             From 临床出诊挂号控制记录
                             Where 记录id = r_No.记录id And 类型 = 1 And 性质 = 1 And 名称 = v_合作单位) Loop
                  Begin
                    Select 1, 开始时间, 终止时间
                    Into n_Exists, d_开始时间, d_终止时间
                    From 临床出诊序号控制
                    Where 序号 = r_合作.序号 And Nvl(挂号状态, 0) = 0 And 开始时间 Between Nvl(r_No.替诊开始时间, Sysdate) And
                          Nvl(r_No.替诊终止时间, Sysdate - 1) And Nvl(是否停诊, 0) <> 1;
                  Exception
                    When Others Then
                      n_Exists := 0;
                  End;
                  If n_Exists = 1 Then
                    v_剩余数量 := v_剩余数量 + 1;
                    If r_No.分时段 = 1 Then
                    
                      If Nvl(n_时间间隔, 0) <> 0 Then
                        If d_时段开始 Is Null Then
                          d_时段开始 := d_开始时间;
                          d_时段结束 := d_开始时间 + 1 / 24 / 60 * n_时间间隔;
                          n_时段总数 := n_时段总数 + 1;
                        Else
                          If d_开始时间 >= d_时段结束 Then
                            v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                          To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                          '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                            n_时段总数 := 1;
                            n_时段剩余 := 0;
                            d_时段开始 := d_开始时间;
                            d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                          Else
                            n_时段总数 := n_时段总数 + 1;
                          End If;
                        End If;
                      End If;
                      If d_开始时间 > Sysdate Then
                        If Nvl(n_时间间隔, 0) = 0 Then
                          v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_开始时间, 'hh24:mi:ss') || '-' ||
                                    To_Char(d_终止时间, 'hh24:mi:ss') || '</SJD><SL>1</SL></SPAN>';
                        Else
                          n_时段剩余 := n_时段剩余 + 1;
                        End If;
                      End If;
                    End If;
                  Else
                    n_已挂数 := n_已挂数 + 1;
                  End If;
                End Loop;
                If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                  v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' || '<SL>' ||
                                n_时段剩余 || '</SL>' || '</SPAN>';
                  n_时段总数 := 0;
                  n_时段剩余 := 0;
                  d_时段开始 := Null;
                  d_时段结束 := Null;
                End If;
                If v_Temp Is Not Null Then
                  v_Temp := '<SPANLIST>' || v_Temp || '</SPANLIST>';
                End If;
              End If;
            End If;
            If n_合约模式 = 4 Then
              n_已挂数   := r_No.已挂数;
              v_剩余数量 := r_No.限号数 - Nvl(r_No.已挂数, 0);
              If r_No.分时段 = 1 And r_No.序号控制 = 1 Then
                --分时段
                v_Temp   := '<SPANLIST>';
                n_Exists := 0;
                Select Max(终止时间) Into d_加号时间 From 临床出诊序号控制 Where 记录id = r_No.记录id;
                n_时段总数 := 0;
                n_时段剩余 := 0;
                d_时段开始 := Null;
                d_时段结束 := Null;
                For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态
                               From 临床出诊序号控制
                               Where 记录id = r_No.记录id And 开始时间 Between Nvl(r_No.替诊开始时间, Sysdate) And
                                     Nvl(r_No.替诊终止时间, Sysdate - 1) And Nvl(是否停诊, 0) <> 1) Loop
                
                  If Nvl(n_时间间隔, 0) <> 0 Then
                    If d_时段开始 Is Null Then
                      d_时段开始 := r_Time.开始时间;
                      d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                      n_时段总数 := n_时段总数 + 1;
                      If d_加号时间 < d_时段结束 Then
                        d_时段结束 := d_加号时间;
                      End If;
                    Else
                      If r_Time.开始时间 >= d_时段结束 Then
                        v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                      To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                      '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                        n_时段总数 := 1;
                        n_时段剩余 := 0;
                        d_时段开始 := r_Time.开始时间;
                        d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                        If d_加号时间 < d_时段结束 Then
                          d_时段结束 := d_加号时间;
                        End If;
                      Else
                        n_时段总数 := n_时段总数 + 1;
                      End If;
                    End If;
                  End If;
                  If r_Time.开始时间 > Sysdate Then
                    If Nvl(n_时间间隔, 0) = 0 Then
                      v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                To_Char(r_Time.终止时间, 'hh24:mi:ss') || '</SJD>';
                      If Nvl(r_Time.挂号状态, 0) = 0 Then
                        v_Temp   := v_Temp || '<SL>1</SL></SPAN>';
                        n_Exists := n_Exists + 1;
                      Else
                        v_Temp := v_Temp || '<SL>0</SL></SPAN>';
                      End If;
                    Else
                      If Nvl(r_Time.挂号状态, 0) = 0 Then
                        n_Exists   := n_Exists + 1;
                        n_时段剩余 := n_时段剩余 + 1;
                      End If;
                    End If;
                  End If;
                End Loop;
                If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                  v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' || '<SL>' ||
                                n_时段剩余 || '</SL>' || '</SPAN>';
                  n_时段总数 := 0;
                  n_时段剩余 := 0;
                  d_时段开始 := Null;
                  d_时段结束 := Null;
                End If;
                If n_Exists < To_Number(v_剩余数量) And r_No.替诊开始时间 Is Null Then
                
                  v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_加号时间, 'hh24:mi:ss') || '-' || '</SJD><SL>' ||
                            To_Number(v_剩余数量 - n_Exists) || '</SL></SPAN>';
                End If;
                v_Temp := v_Temp || '</SPANLIST>';
              End If;
            End If;
          End If;
        Else
          --预约挂号
          If r_No.预约控制 = 1 Then
            n_禁用 := 1;
          Else
            --不限制预约
            If v_合作单位 Is Null Then
              If r_No.分时段 = 0 Then
                n_已挂数   := r_No.已约数;
                v_剩余数量 := Nvl(r_No.限约数, r_No.限号数) - Nvl(r_No.已约数, 0);
              Else
                --分时段
                n_已挂数   := 0;
                v_剩余数量 := 0;
                v_Temp     := '<SPANLIST>';
                If r_No.序号控制 = 0 Then
                  --非序号控制分时段预约
                  n_时段总数 := 0;
                  n_时段剩余 := 0;
                  d_时段开始 := Null;
                  d_时段结束 := Null;
                  Select Max(终止时间) Into d_加号时间 From 临床出诊序号控制 Where 记录id = r_No.记录id;
                  For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态, 数量
                                 From 临床出诊序号控制
                                 Where 记录id = r_No.记录id And 预约顺序号 Is Null And 是否预约 = 1 And
                                       开始时间 Between Nvl(r_No.替诊开始时间, Sysdate) And Nvl(r_No.替诊终止时间, Sysdate - 1) And
                                       开始时间 Not Between Nvl(r_No.停诊开始时间, Sysdate) And Nvl(r_No.停诊终止时间, Sysdate - 1)) Loop
                    If Nvl(n_时间间隔, 0) <> 0 Then
                      If d_时段开始 Is Null Then
                        d_时段开始 := r_Time.开始时间;
                        d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                        n_时段总数 := n_时段总数 + r_Time.数量;
                        If d_加号时间 < d_时段结束 Then
                          d_时段结束 := d_加号时间;
                        End If;
                      Else
                        If r_Time.开始时间 >= d_时段结束 Then
                          v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                        To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                        '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                          n_时段总数 := r_Time.数量;
                          n_时段剩余 := 0;
                          d_时段开始 := r_Time.开始时间;
                          d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                          If d_加号时间 < d_时段结束 Then
                            d_时段结束 := d_加号时间;
                          End If;
                        Else
                          n_时段总数 := n_时段总数 + r_Time.数量;
                        End If;
                      End If;
                    End If;
                    Select Count(1)
                    Into n_时段已挂
                    From 临床出诊序号控制
                    Where 预约顺序号 Is Not Null And Nvl(挂号状态, 0) <> 0;
                    If r_Time.开始时间 > Sysdate Then
                      If Nvl(n_时间间隔, 0) = 0 Then
                        v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                  To_Char(r_Time.终止时间, 'hh24:mi:ss') || '</SJD>';
                        v_Temp := v_Temp || '<SL>' || r_Time.数量 - n_时段已挂 || '</SL></SPAN>';
                      Else
                        n_时段剩余 := n_时段剩余 + (r_Time.数量 - n_时段已挂);
                      End If;
                      n_已挂数   := n_已挂数 + n_时段已挂;
                      v_剩余数量 := v_剩余数量 + (r_Time.数量 - n_时段已挂);
                    End If;
                  End Loop;
                  If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                    v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                  To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                  '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                    n_时段总数 := 0;
                    n_时段剩余 := 0;
                    d_时段开始 := Null;
                    d_时段结束 := Null;
                  End If;
                Else
                  n_时段总数 := 0;
                  n_时段剩余 := 0;
                  d_时段开始 := Null;
                  d_时段结束 := Null;
                  Select Max(终止时间) Into d_加号时间 From 临床出诊序号控制 Where 记录id = r_No.记录id;
                  For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态
                                 From 临床出诊序号控制
                                 Where 记录id = r_No.记录id And 开始时间 Between Nvl(r_No.替诊开始时间, Sysdate) And
                                       Nvl(r_No.替诊终止时间, Sysdate - 1) And Nvl(是否停诊, 0) <> 1) Loop
                    If Nvl(n_时间间隔, 0) <> 0 Then
                      If d_时段开始 Is Null Then
                        d_时段开始 := r_Time.开始时间;
                        d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                        n_时段总数 := n_时段总数 + 1;
                        If d_加号时间 < d_时段结束 Then
                          d_时段结束 := d_加号时间;
                        End If;
                      Else
                        If r_Time.开始时间 >= d_时段结束 Then
                          v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                        To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                        '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                          n_时段总数 := 1;
                          n_时段剩余 := 0;
                          d_时段开始 := r_Time.开始时间;
                          d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                          If d_加号时间 < d_时段结束 Then
                            d_时段结束 := d_加号时间;
                          End If;
                        Else
                          n_时段总数 := n_时段总数 + 1;
                        End If;
                      End If;
                    End If;
                    If r_Time.开始时间 > Sysdate Then
                      If Nvl(n_时间间隔, 0) = 0 Then
                        v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                  To_Char(r_Time.终止时间, 'hh24:mi:ss') || '</SJD>';
                        If Nvl(r_Time.挂号状态, 0) = 0 Then
                          v_Temp     := v_Temp || '<SL>1</SL></SPAN>';
                          v_剩余数量 := v_剩余数量 + 1;
                        Else
                          v_Temp   := v_Temp || '<SL>0</SL></SPAN>';
                          n_已挂数 := n_已挂数 + 1;
                        End If;
                      Else
                        If Nvl(r_Time.挂号状态, 0) = 0 Then
                          n_时段剩余 := n_时段剩余 + 1;
                          v_剩余数量 := v_剩余数量 + 1;
                        Else
                          n_已挂数 := n_已挂数 + 1;
                        End If;
                      End If;
                    End If;
                  End Loop;
                  If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                    v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                  To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                  '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                    n_时段总数 := 0;
                    n_时段剩余 := 0;
                    d_时段开始 := Null;
                    d_时段结束 := Null;
                  End If;
                End If;
                v_Temp := v_Temp || '</SPANLIST>';
              End If;
            Else
              --合作单位预约挂号
              If r_No.预约控制 = 2 Then
                n_禁用 := 1;
              Else
                Begin
                  Select 控制方式
                  Into n_合约模式
                  From 临床出诊挂号控制记录
                  Where 记录id = r_No.记录id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1 And Rownum < 2;
                Exception
                  When Others Then
                    n_合约模式 := 4;
                End;
                If n_合约模式 = 0 Then
                  n_禁用 := 1;
                End If;
                If n_合约模式 = 1 Or n_合约模式 = 2 Then
                  Select 数量
                  Into n_合约总数量
                  From 临床出诊挂号控制记录
                  Where 记录id = r_No.记录id And 类型 = 1 And 名称 = v_合作单位 And 性质 = 1;
                  If n_合约模式 = 1 Then
                    n_合约总数量 := Round(r_No.限号数 * n_合约总数量 / 100);
                  End If;
                  Select Count(1)
                  Into n_合约已挂数
                  From 病人挂号记录
                  Where 号别 = r_No.号码 And 记录状态 = 1 And 合作单位 = v_合作单位 And 发生时间 Between Trunc(d_日期) And
                        Trunc(d_日期 + 1) - 1 / 60 / 60 / 24;
                  n_合约剩余数量 := n_合约总数量 - n_合约已挂数;
                  If Nvl(r_No.限约数, r_No.限号数) - Nvl(r_No.已约数, 0) < n_合约剩余数量 Then
                    v_剩余数量 := Nvl(r_No.限约数, r_No.限号数) - Nvl(r_No.已约数, 0);
                  Else
                    v_剩余数量 := n_合约剩余数量;
                  End If;
                  If r_No.分时段 = 1 Then
                    v_Temp := '<SPANLIST>';
                    If r_No.序号控制 = 1 Then
                      --分时段,序号控制
                      n_Exists   := 0;
                      n_时段总数 := 0;
                      n_时段剩余 := 0;
                      d_时段开始 := Null;
                      d_时段结束 := Null;
                      Select Max(终止时间) Into d_加号时间 From 临床出诊序号控制 Where 记录id = r_No.记录id;
                      For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态
                                     From 临床出诊序号控制
                                     Where 记录id = r_No.记录id And 开始时间 Between Nvl(r_No.替诊开始时间, Sysdate) And
                                           Nvl(r_No.替诊终止时间, Sysdate - 1) And Nvl(是否停诊, 0) <> 1) Loop
                      
                        If Nvl(n_时间间隔, 0) <> 0 Then
                          If d_时段开始 Is Null Then
                            d_时段开始 := r_Time.开始时间;
                            d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                            n_时段总数 := n_时段总数 + 1;
                            If d_加号时间 < d_时段结束 Then
                              d_时段结束 := d_加号时间;
                            End If;
                          Else
                            If r_Time.开始时间 >= d_时段结束 Then
                              v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                            To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 ||
                                            '</GHZS>' || '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                              n_时段总数 := 1;
                              n_时段剩余 := 0;
                              d_时段开始 := r_Time.开始时间;
                              d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                              If d_加号时间 < d_时段结束 Then
                                d_时段结束 := d_加号时间;
                              End If;
                            Else
                              n_时段总数 := n_时段总数 + 1;
                            End If;
                          End If;
                        End If;
                        If r_Time.开始时间 > Sysdate Then
                          If Nvl(n_时间间隔, 0) = 0 Then
                            v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                      To_Char(r_Time.终止时间, 'hh24:mi:ss') || '</SJD>';
                            If Nvl(r_Time.挂号状态, 0) = 0 Then
                              v_Temp   := v_Temp || '<SL>1</SL></SPAN>';
                              n_Exists := n_Exists + 1;
                            Else
                              v_Temp := v_Temp || '<SL>0</SL></SPAN>';
                            End If;
                          Else
                            If Nvl(r_Time.挂号状态, 0) = 0 Then
                              n_时段剩余 := n_时段剩余 + 1;
                              n_Exists   := n_Exists + 1;
                            End If;
                          End If;
                        End If;
                      End Loop;
                      If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                        v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                      To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                      '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                        n_时段总数 := 0;
                        n_时段剩余 := 0;
                        d_时段开始 := Null;
                        d_时段结束 := Null;
                      End If;
                      If n_Exists < To_Number(v_剩余数量) Then
                        v_剩余数量 := n_Exists;
                      End If;
                    Else
                      --分时段,非序号控制
                      n_Exists   := 0;
                      n_时段总数 := 0;
                      n_时段剩余 := 0;
                      d_时段开始 := Null;
                      d_时段结束 := Null;
                      Select Max(终止时间) Into d_加号时间 From 临床出诊序号控制 Where 记录id = r_No.记录id;
                      For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态, 数量
                                     From 临床出诊序号控制
                                     Where 记录id = r_No.记录id And 预约顺序号 Is Null And 是否预约 = 1 And
                                           开始时间 Between Nvl(r_No.替诊开始时间, Sysdate) And Nvl(r_No.替诊终止时间, Sysdate - 1) And
                                           开始时间 Not Between Nvl(r_No.停诊开始时间, Sysdate) And Nvl(r_No.停诊终止时间, Sysdate - 1)) Loop
                        If Nvl(n_时间间隔, 0) <> 0 Then
                          If d_时段开始 Is Null Then
                            d_时段开始 := r_Time.开始时间;
                            d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                            n_时段总数 := n_时段总数 + r_Time.数量;
                            If d_加号时间 < d_时段结束 Then
                              d_时段结束 := d_加号时间;
                            End If;
                          Else
                            If r_Time.开始时间 >= d_时段结束 Then
                              v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                            To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 ||
                                            '</GHZS>' || '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                              n_时段总数 := r_Time.数量;
                              n_时段剩余 := 0;
                              d_时段开始 := r_Time.开始时间;
                              d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                              If d_加号时间 < d_时段结束 Then
                                d_时段结束 := d_加号时间;
                              End If;
                            Else
                              n_时段总数 := n_时段总数 + r_Time.数量;
                            End If;
                          End If;
                        End If;
                        Select Count(1)
                        Into n_时段已挂
                        From 临床出诊序号控制
                        Where 预约顺序号 Is Not Null And Nvl(挂号状态, 0) <> 0;
                        If r_Time.开始时间 > Sysdate Then
                          If Nvl(n_时间间隔, 0) = 0 Then
                            v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                      To_Char(r_Time.终止时间, 'hh24:mi:ss') || '</SJD>';
                            v_Temp := v_Temp || '<SL>' || r_Time.数量 - n_时段已挂 || '</SL></SPAN>';
                          Else
                            n_时段剩余 := n_时段剩余 + (r_Time.数量 - n_时段已挂);
                          End If;
                          n_Exists := n_Exists + (r_Time.数量 - n_时段已挂);
                        
                        End If;
                      End Loop;
                      If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                        v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                      To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                      '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                        n_时段总数 := 0;
                        n_时段剩余 := 0;
                        d_时段开始 := Null;
                        d_时段结束 := Null;
                      End If;
                      If n_Exists < To_Number(v_剩余数量) Then
                        v_剩余数量 := n_Exists;
                      End If;
                    End If;
                    v_Temp := v_Temp || '</SPANLIST>';
                  End If;
                  n_已挂数 := r_No.已约数;
                End If;
                If n_合约模式 = 3 Then
                  If r_No.分时段 = 0 Then
                    If r_No.序号控制 = 0 Then
                      n_禁用 := 1;
                    Else
                      n_已挂数   := 0;
                      v_剩余数量 := 0;
                      For r_合作 In (Select 序号
                                   From 临床出诊挂号控制记录
                                   Where 记录id = r_No.记录id And 类型 = 1 And 性质 = 1 And 名称 = v_合作单位) Loop
                        Select Nvl(Max(1), 0)
                        Into n_Exists
                        From 临床出诊序号控制
                        Where 记录id = r_No.记录id And 序号 = r_合作.序号 And 是否预约 = 1 And Nvl(挂号状态, 0) = 0 And
                              开始时间 Between Nvl(r_No.替诊开始时间, Sysdate) And Nvl(r_No.替诊终止时间, Sysdate - 1) And
                              Nvl(是否停诊, 0) <> 1;
                        If n_Exists = 1 Then
                          v_剩余数量 := v_剩余数量 + 1;
                        Else
                          n_已挂数 := n_已挂数 + 1;
                        End If;
                      End Loop;
                      If Nvl(r_No.限约数, r_No.限号数) - Nvl(r_No.已约数, 0) < v_剩余数量 Then
                        v_剩余数量 := Nvl(r_No.限约数, r_No.限号数) - Nvl(r_No.已约数, 0);
                      End If;
                    End If;
                  Else
                    If r_No.序号控制 = 0 Then
                      --合作单位,分时段,非序号控制
                      n_已挂数   := 0;
                      v_剩余数量 := 0;
                      n_时段总数 := 0;
                      n_时段剩余 := 0;
                      d_时段开始 := Null;
                      d_时段结束 := Null;
                      v_Temp     := '<SPANLIST>';
                      For r_合作 In (Select 序号, 数量
                                   From 临床出诊挂号控制记录
                                   Where 记录id = r_No.记录id And 类型 = 1 And 性质 = 1 And 名称 = v_合作单位) Loop
                        Begin
                          Select Count(1), Max(开始时间), Max(终止时间)
                          Into n_时段已挂, d_开始时间, d_终止时间
                          From 临床出诊序号控制
                          Where 记录id = r_No.记录id And 预约顺序号 Is Not Null And Nvl(挂号状态, 0) <> 0 And 序号 = r_合作.序号 And
                                开始时间 Between Nvl(r_No.替诊开始时间, Sysdate) And Nvl(r_No.替诊终止时间, Sysdate - 1);
                        
                          If Nvl(n_时间间隔, 0) <> 0 Then
                            If d_时段开始 Is Null Then
                              d_时段开始 := d_开始时间;
                              d_时段结束 := d_开始时间 + 1 / 24 / 60 * n_时间间隔;
                              n_时段总数 := n_时段总数 + r_合作.数量;
                            Else
                              If d_开始时间 >= d_时段结束 Then
                                v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                              To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 ||
                                              '</GHZS>' || '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                                n_时段总数 := r_合作.数量;
                                n_时段剩余 := 0;
                                d_时段开始 := d_开始时间;
                                d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                              Else
                                n_时段总数 := n_时段总数 + r_合作.数量;
                              End If;
                            End If;
                          End If;
                          n_已挂数 := n_已挂数 + n_时段已挂;
                          If d_开始时间 > Sysdate Then
                            If Nvl(n_时间间隔, 0) = 0 Then
                              v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_开始时间, 'hh24:mi:ss') || '-' ||
                                        To_Char(d_终止时间, 'hh24:mi:ss') || '</SJD>';
                              v_Temp := v_Temp || '<SL>' || r_合作.数量 - n_时段已挂 || '</SL></SPAN>';
                            Else
                              n_时段剩余 := n_时段剩余 + r_合作.数量 - n_时段已挂;
                            End If;
                            v_剩余数量 := v_剩余数量 + r_合作.数量 - n_时段已挂;
                          End If;
                        Exception
                          When Others Then
                            Null;
                        End;
                      End Loop;
                      If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                        v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                      To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                      '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                        n_时段总数 := 0;
                        n_时段剩余 := 0;
                        d_时段开始 := Null;
                        d_时段结束 := Null;
                      End If;
                      v_Temp := v_Temp || '</SPANLIST>';
                    Else
                      n_已挂数   := 0;
                      v_剩余数量 := 0;
                      n_时段总数 := 0;
                      n_时段剩余 := 0;
                      d_时段开始 := Null;
                      d_时段结束 := Null;
                      v_Temp     := '<SPANLIST>';
                      For r_合作 In (Select 序号
                                   From 临床出诊挂号控制记录
                                   Where 记录id = r_No.记录id And 类型 = 1 And 性质 = 1 And 名称 = v_合作单位) Loop
                        Begin
                          Select 1, 开始时间, 终止时间
                          Into n_Exists, d_开始时间, d_终止时间
                          From 临床出诊序号控制
                          Where 记录id = r_No.记录id And Nvl(挂号状态, 0) = 0 And 序号 = r_合作.序号 And
                                开始时间 Between Nvl(r_No.替诊开始时间, Sysdate) And Nvl(r_No.替诊终止时间, Sysdate - 1) And
                                Nvl(是否停诊, 0) <> 1;
                        Exception
                          When Others Then
                            n_Exists := 0;
                        End;
                      
                        If Nvl(n_时间间隔, 0) <> 0 Then
                          If d_时段开始 Is Null Then
                            d_时段开始 := d_开始时间;
                            d_时段结束 := d_开始时间 + 1 / 24 / 60 * n_时间间隔;
                            n_时段总数 := n_时段总数 + 1;
                          Else
                            If d_开始时间 >= d_时段结束 Then
                              v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                            To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 ||
                                            '</GHZS>' || '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                              n_时段总数 := 1;
                              n_时段剩余 := 0;
                              d_时段开始 := d_开始时间;
                              d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                            Else
                              n_时段总数 := n_时段总数 + 1;
                            End If;
                          End If;
                        End If;
                        If d_开始时间 > Sysdate Then
                          If n_Exists = 1 Then
                            v_剩余数量 := v_剩余数量 + 1;
                            If Nvl(n_时间间隔, 0) = 0 Then
                              v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_开始时间, 'hh24:mi:ss') || '-' ||
                                        To_Char(d_终止时间, 'hh24:mi:ss') || '</SJD>';
                              v_Temp := v_Temp || '<SL>' || 1 || '</SL></SPAN>';
                            Else
                              n_时段剩余 := n_时段剩余 + 1;
                            End If;
                          Else
                            If Nvl(n_时间间隔, 0) = 0 Then
                              v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_开始时间, 'hh24:mi:ss') || '-' ||
                                        To_Char(d_终止时间, 'hh24:mi:ss') || '</SJD>';
                              v_Temp := v_Temp || '<SL>' || 0 || '</SL></SPAN>';
                            End If;
                            n_已挂数 := n_已挂数 + 1;
                          End If;
                        End If;
                      End Loop;
                      If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                        v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                      To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                      '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                        n_时段总数 := 0;
                        n_时段剩余 := 0;
                        d_时段开始 := Null;
                        d_时段结束 := Null;
                      End If;
                    End If;
                  End If;
                End If;
                If n_合约模式 = 4 Then
                  If r_No.分时段 = 0 Then
                    n_已挂数   := r_No.已约数;
                    v_剩余数量 := Nvl(r_No.限约数, r_No.限号数) - Nvl(r_No.已约数, 0);
                  Else
                    --分时段
                    n_已挂数   := 0;
                    v_剩余数量 := 0;
                    n_时段总数 := 0;
                    n_时段剩余 := 0;
                    d_时段开始 := Null;
                    d_时段结束 := Null;
                    v_Temp     := '<SPANLIST>';
                    If r_No.序号控制 = 0 Then
                      --非序号控制分时段预约
                      Select Max(终止时间) Into d_加号时间 From 临床出诊序号控制 Where 记录id = r_No.记录id;
                      For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态, 数量
                                     From 临床出诊序号控制
                                     Where 记录id = r_No.记录id And 预约顺序号 Is Null And 是否预约 = 1 And
                                           开始时间 Between Nvl(r_No.替诊开始时间, Sysdate) And Nvl(r_No.替诊终止时间, Sysdate - 1) And
                                           开始时间 Not Between Nvl(r_No.停诊开始时间, Sysdate) And Nvl(r_No.停诊终止时间, Sysdate - 1)) Loop
                      
                        If Nvl(n_时间间隔, 0) <> 0 Then
                          If d_时段开始 Is Null Then
                            d_时段开始 := r_Time.开始时间;
                            d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                            n_时段总数 := n_时段总数 + r_Time.数量;
                            If d_加号时间 < d_时段结束 Then
                              d_时段结束 := d_加号时间;
                            End If;
                          Else
                            If r_Time.开始时间 >= d_时段结束 Then
                              v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                            To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 ||
                                            '</GHZS>' || '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                              n_时段总数 := r_Time.数量;
                              n_时段剩余 := 0;
                              d_时段开始 := r_Time.开始时间;
                              d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                              If d_加号时间 < d_时段结束 Then
                                d_时段结束 := d_加号时间;
                              End If;
                            Else
                              n_时段总数 := n_时段总数 + r_Time.数量;
                            End If;
                          End If;
                        End If;
                        Select Count(1)
                        Into n_时段已挂
                        From 临床出诊序号控制
                        Where 预约顺序号 Is Not Null And Nvl(挂号状态, 0) <> 0;
                        If r_Time.开始时间 > Sysdate Then
                          If Nvl(n_时间间隔, 0) = 0 Then
                            v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                      To_Char(r_Time.终止时间, 'hh24:mi:ss') || '</SJD>';
                            v_Temp := v_Temp || '<SL>' || r_Time.数量 - n_时段已挂 || '</SL></SPAN>';
                          Else
                            n_时段剩余 := n_时段剩余 + (r_Time.数量 - n_时段已挂);
                          End If;
                          n_已挂数   := n_已挂数 + n_时段已挂;
                          v_剩余数量 := v_剩余数量 + (r_Time.数量 - n_时段已挂);
                        End If;
                      End Loop;
                      If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                        v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                      To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                      '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                        n_时段总数 := 0;
                        n_时段剩余 := 0;
                        d_时段开始 := Null;
                        d_时段结束 := Null;
                      End If;
                    Else
                      n_时段总数 := 0;
                      n_时段剩余 := 0;
                      d_时段开始 := Null;
                      d_时段结束 := Null;
                      Select Max(终止时间) Into d_加号时间 From 临床出诊序号控制 Where 记录id = r_No.记录id;
                      For r_Time In (Select 序号, 开始时间, 终止时间, 挂号状态
                                     From 临床出诊序号控制
                                     Where 记录id = r_No.记录id And 开始时间 Between Nvl(r_No.替诊开始时间, Sysdate) And
                                           Nvl(r_No.替诊终止时间, Sysdate - 1) And Nvl(是否停诊, 0) <> 1) Loop
                      
                        If Nvl(n_时间间隔, 0) <> 0 Then
                          If d_时段开始 Is Null Then
                            d_时段开始 := r_Time.开始时间;
                            d_时段结束 := r_Time.开始时间 + 1 / 24 / 60 * n_时间间隔;
                            n_时段总数 := n_时段总数 + 1;
                            If d_加号时间 < d_时段结束 Then
                              d_时段结束 := d_加号时间;
                            End If;
                          Else
                            If r_Time.开始时间 >= d_时段结束 Then
                              v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                            To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 ||
                                            '</GHZS>' || '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                              n_时段总数 := 1;
                              n_时段剩余 := 0;
                              d_时段开始 := r_Time.开始时间;
                              d_时段结束 := d_时段开始 + 1 / 24 / 60 * n_时间间隔;
                              If d_加号时间 < d_时段结束 Then
                                d_时段结束 := d_加号时间;
                              End If;
                            Else
                              n_时段总数 := n_时段总数 + 1;
                            End If;
                          End If;
                        End If;
                        If r_Time.开始时间 > Sysdate Then
                          If Nvl(n_时间间隔, 0) = 0 Then
                            v_Temp := v_Temp || '<SPAN>' || '<SJD>' || To_Char(r_Time.开始时间, 'hh24:mi:ss') || '-' ||
                                      To_Char(r_Time.终止时间, 'hh24:mi:ss') || '</SJD>';
                            If Nvl(r_Time.挂号状态, 0) = 0 Then
                              v_Temp     := v_Temp || '<SL>1</SL></SPAN>';
                              v_剩余数量 := v_剩余数量 + 1;
                            Else
                              v_Temp   := v_Temp || '<SL>0</SL></SPAN>';
                              n_已挂数 := n_已挂数 + 1;
                            End If;
                          Else
                            If Nvl(r_Time.挂号状态, 0) = 0 Then
                              n_时段剩余 := n_时段剩余 + 1;
                              v_剩余数量 := v_剩余数量 + 1;
                            Else
                              n_已挂数 := n_已挂数 + 1;
                            End If;
                          End If;
                        End If;
                      End Loop;
                      If Nvl(n_时间间隔, 0) <> 0 And n_时段总数 <> 0 Then
                        v_Temp     := v_Temp || '<SPAN>' || '<SJD>' || To_Char(d_时段开始, 'hh24:mi:ss') || '-' ||
                                      To_Char(d_时段结束, 'hh24:mi:ss') || '</SJD>' || '<GHZS>' || n_时段总数 || '</GHZS>' ||
                                      '<SL>' || n_时段剩余 || '</SL>' || '</SPAN>';
                        n_时段总数 := 0;
                        n_时段剩余 := 0;
                        d_时段开始 := Null;
                        d_时段结束 := Null;
                      End If;
                    End If;
                    v_Temp := v_Temp || '</SPANLIST>';
                  End If;
                End If;
              End If;
            End If;
          End If;
        End If;
      
        If Not (r_No.分时段 = 1 And r_No.序号控制 = 1) Then
          If d_日期 Between Nvl(r_No.替诊开始时间, Sysdate) And Nvl(r_No.替诊终止时间, Sysdate - 1) Then
            n_禁用 := 1;
          End If;
          If d_日期 Between Nvl(r_No.停诊开始时间, Sysdate) And Nvl(r_No.停诊终止时间, Sysdate - 1) Then
            n_禁用 := 1;
          End If;
        End If;
      
        If Nvl(n_禁用, 0) = 0 Then
          n_合计金额 := 0;
          For r_Fee In (Select b.现价, a.从项数次
                        From 收费从属项目 A, 收费价目 B
                        Where a.主项id = r_No.项目id And a.从项id = b.收费细目id And d_日期 Between b.执行日期 And
                              Nvl(b.终止日期, To_Date('3000-1-1', 'YYYY-MM-DD'))
                        Union
                        Select b.现价, 1 As 从项数次
                        From 收费项目目录 A, 收费价目 B
                        Where a.Id = b.收费细目id And a.Id = r_No.项目id And d_日期 Between b.执行日期 And
                              Nvl(b.终止日期, To_Date('3000-1-1', 'YYYY-MM-DD'))) Loop
            n_合计金额 := n_合计金额 + r_Fee.现价 * r_Fee.从项数次;
          End Loop;
          v_时间段 := To_Char(r_No.替诊开始时间, 'HH24:MI') || '-' || To_Char(r_No.替诊终止时间, 'HH24:MI');
          If Trunc(Sysdate) = Trunc(d_日期) Then
            c_Xmlmain := '<HB>' || '<CZJLID>' || r_No.记录id || '</CZJLID>' || '<HM>' || r_No.号码 || '</HM>' || '<YSID>' ||
                         r_No.医生id || '</YSID>' || '<YS>' || r_No.医生姓名 || '</YS>' || '<KSID>' || r_No.科室id || '</KSID>' ||
                         '<KSMC>' || r_No.科室名称 || '</KSMC>' || '<ZC>' || r_No.职称 || '</ZC>' || '<XMID>' || r_No.项目id ||
                         '</XMID>' || '<XMMC>' || r_No.项目名称 || '</XMMC>' || '<YGHS>' || n_已挂数 || '</YGHS>' || '<SYHS>' ||
                         v_剩余数量 || '</SYHS>' || '<PRICE>' || n_合计金额 || '</PRICE>' || '<HL>' || r_No.号类 || '</HL>' ||
                         '<FSD>' || r_No.分时段 || '</FSD>' || '<HBTIME>' || v_时间段 || '</HBTIME>' || '<FWMC>' || r_No.排班 ||
                         '</FWMC>' || v_Temp || '</HB>';
            v_Xmlmain := v_Xmlmain || c_Xmlmain;
          Else
            If r_No.已约数 >= r_No.限约数 Then
              c_Xmlmain := '<HB>' || '<CZJLID>' || r_No.记录id || '</CZJLID>' || '<HM>' || r_No.号码 || '</HM>' || '<YSID>' ||
                           r_No.医生id || '</YSID>' || '<YS>' || r_No.医生姓名 || '</YS>' || '<KSID>' || r_No.科室id ||
                           '</KSID>' || '<KSMC>' || r_No.科室名称 || '</KSMC>' || '<ZC>' || r_No.职称 || '</ZC>' || '<XMID>' ||
                           r_No.项目id || '</XMID>' || '<XMMC>' || r_No.项目名称 || '</XMMC>' || '<YGHS>' || r_No.已约数 ||
                           '</YGHS>' || '<SYHS>' || 0 || '</SYHS>' || '<PRICE>' || n_合计金额 || '</PRICE>' || '<HL>' ||
                           r_No.号类 || '</HL>' || '<FSD>' || r_No.分时段 || '</FSD>' || '<HBTIME>' || v_时间段 || '</HBTIME>' ||
                           '<FWMC>' || r_No.排班 || '</FWMC>' || '</HB>';
              v_Xmlmain := v_Xmlmain || c_Xmlmain;
            Else
              c_Xmlmain := '<HB>' || '<CZJLID>' || r_No.记录id || '</CZJLID>' || '<HM>' || r_No.号码 || '</HM>' || '<YSID>' ||
                           r_No.医生id || '</YSID>' || '<YS>' || r_No.医生姓名 || '</YS>' || '<KSID>' || r_No.科室id ||
                           '</KSID>' || '<KSMC>' || r_No.科室名称 || '</KSMC>' || '<ZC>' || r_No.职称 || '</ZC>' || '<XMID>' ||
                           r_No.项目id || '</XMID>' || '<XMMC>' || r_No.项目名称 || '</XMMC>' || '<YGHS>' || n_已挂数 ||
                           '</YGHS>' || '<SYHS>' || v_剩余数量 || '</SYHS>' || '<PRICE>' || n_合计金额 || '</PRICE>' || '<HL>' ||
                           r_No.号类 || '</HL>' || '<FSD>' || r_No.分时段 || '</FSD>' || '<HBTIME>' || v_时间段 || '</HBTIME>' ||
                           '<FWMC>' || r_No.排班 || '</FWMC>' || v_Temp || '</HB>';
              v_Xmlmain := v_Xmlmain || c_Xmlmain;
            End If;
          End If;
        End If;
      End If;
      n_禁用 := 0;
    End Loop;
    v_Xmlmain := '<GROUP>' || '<RQ>' || To_Char(d_日期, 'yyyy-mm-dd') || '</RQ>' || '<HBLIST>' || v_Xmlmain ||
                 '</HBLIST>' || '</GROUP>';
    Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Xmlmain)) Into x_Templet From Dual;
  End If;
  Xml_Out := x_Templet;
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Getnolist;
/

--112852:焦博,2017-08-28,服务窗预约时，根据预约的时间去计算预约费用
Create Or Replace Procedure Zl_Third_Salereginfo
(
  Xml_In  In Xmltype,
  Xml_Out In Out Xmltype
) Is
  --------------------------------------------------------------------------------------------------
  --功能:调用用户自定义函数获取指定的费别
  --入参:Xml_In:
  --  <IN>
  --       <XMID>123</XMID>   //要计算的收费项目的ID
  --       <BRID>421<BRID>   //病人ID
  --       <XM>姓名</XM>        //姓名
  --       <SFZH>身份证号</SFZH>   //身份证号
  --       <RQ></RQ>          //日期
  --  </IN>
  --出参:Xml_Out
  -- <OUTPUT>
  --  <YHJE>优惠金额</YHJE>
  --  <JE>计算后的金额</JE>
  --  <FB>计算后的费别</FB>
  -- </OUTPUT>
  --    如无下列错误结点则说明正确执行
  --    <ERROR>
  --      <MSG>错误信息</MSG>
  --    </ERROR>
  -- </OUTPUT>

  --------------------------------------------------------------------------------------------------
  x_Templet  Xmltype; --模板XML
  v_Err_Msg  Varchar2(200);
  v_Temp     Varchar2(500);
  n_项目id   挂号安排.项目id%Type;
  n_病人id   病人信息.病人id%Type;
  v_姓名     病人信息.姓名%Type;
  v_身份证号 病人信息.身份证号%Type;
  v_费别     病人信息.费别%Type;
  n_实收金额 门诊费用记录.实收金额%Type := 0;
  n_应收金额 门诊费用记录.应收金额%Type := 0;
  n_优惠金额 门诊费用记录.实收金额%Type := 0;
  d_日期     Date;
  Err_Item Exception;
Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');
  Select Extractvalue(Value(A), 'IN/BRID'), Extractvalue(Value(A), 'IN/XMID'), Extractvalue(Value(A), 'IN/SFZH'),
         Extractvalue(Value(A), 'IN/XM'), To_Date(Extractvalue(Value(A), 'IN/RQ'), 'yyyy-mm-dd hh24:mi:ss')
  Into n_病人id, n_项目id, v_身份证号, v_姓名, d_日期
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;
  v_费别 := Zl_Custom_Getpatifeetype(1, n_病人id);

  If Nvl(n_病人id, 0) = 0 And Not v_身份证号 Is Null And v_姓名 Is Not Null Then
    n_病人id := Zl_Third_Getpatiid(v_身份证号, v_姓名);
  End If;
  If Nvl(n_病人id, 0) = 0 Then
    v_Err_Msg := '无法确定病人信息,请检查!';
    Raise Err_Item;
  End If;

  If d_日期 Is Null Then
    d_日期 := Sysdate;
  End If;

  For r_Fb In (Select 1 As 性质, a.类别, a.Id As 项目id, a.名称 As 项目名称, a.编码 As 项目编码, a.计算单位, a.屏蔽费别, 1 As 数次, c.Id As 收入项目id,
                      c.名称 As 收入项目, c.编码 As 收入编码, c.收据费目, b.现价 As 单价, Null As 从属父号
               From 收费项目目录 A, 收费价目 B, 收入项目 C
               Where b.收费细目id = a.Id And b.收入项目id = c.Id And a.Id = n_项目id And d_日期 Between b.执行日期 And
                     Nvl(b.终止日期, To_Date('3000-1-1', 'YYYY-MM-DD'))
               Union All
               Select 2 As 性质, a.类别, a.Id As 项目id, a.名称 As 项目名称, a.编码 As 项目编码, a.计算单位, a.屏蔽费别, d.从项数次 As 数次,
                      c.Id As 收入项目id, c.名称 As 收入项目, c.编码 As 收入编码, c.收据费目, b.现价 As 单价, 1 As 从属父号
               From 收费项目目录 A, 收费价目 B, 收入项目 C, 收费从属项目 D
               Where b.收费细目id = a.Id And b.收入项目id = c.Id And a.Id = d.从项id And d.主项id = n_项目id And d_日期 Between b.执行日期 And
                     Nvl(b.终止日期, To_Date('3000-1-1', 'YYYY-MM-DD'))
               Order By 性质, 项目编码, 收入编码) Loop
    v_Temp     := Zl_Actualmoney(v_费别, r_Fb.项目id, r_Fb.收入项目id, r_Fb.单价);
    v_Temp     := Substr(v_Temp, Instr(v_Temp, ':') + 1);
    n_实收金额 := n_实收金额 + Zl_To_Number(v_Temp);
    n_应收金额 := n_应收金额 + r_Fb.单价;
  End Loop;
  n_优惠金额 := n_应收金额 - n_实收金额;
  v_Temp     := '<YHJE>' || n_优惠金额 || '</YHJE>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  v_Temp := '<JE>' || n_实收金额 || '</JE>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  v_Temp := '<FB>' || v_费别 || '</FB>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  Xml_Out := x_Templet;
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Salereginfo;
/

--112852:焦博,2017-08-28,服务窗预约时，根据预约的时间去计算预约费用
Create Or Replace Procedure Zl_三方机构挂号_Insert
(
  操作方式_In     Integer,
  病人id_In       门诊费用记录.病人id%Type,
  号码_In         挂号安排.号码%Type,
  号序_In         挂号序号状态.序号%Type,
  单据号_In       门诊费用记录.No%Type,
  票据号_In       门诊费用记录.实际票号%Type,
  结算方式_In     Varchar2,
  摘要_In         门诊费用记录.摘要%Type, --预约挂号摘要信息
  发生时间_In     门诊费用记录.发生时间%Type,
  登记时间_In     门诊费用记录.登记时间%Type,
  合作单位_In     挂号合作单位.名称%Type,
  挂号金额合计_In 门诊费用记录.实收金额%Type,
  领用id_In       票据使用明细.领用id%Type,
  收费票据_In     Number := 0, --挂号是否使用收费票据
  交易流水号_In   病人预交记录.交易流水号%Type,
  交易说明_In     病人预交记录.交易说明%Type,
  预约方式_In     预约方式.名称%Type := Null,
  预交id_In       病人预交记录.Id%Type := Null,
  卡类别id_In     病人预交记录.卡类别id%Type := Null,
  加入序号状态_In Number := 0,
  是否自助设备_In Number := 0,
  结帐id_In       门诊费用记录.结帐id%Type := Null,
  锁定类型_In     Number := 0,
  保险结算_In     Varchar2 := Null,
  冲预交_In       Number := Null,
  支付卡号_In     病人预交记录.卡号%Type := Null,
  退号重用_In     Number := 1,
  费别_In         门诊费用记录.费别%Type := Null,
  机器名_In       挂号序号状态.机器名%Type := Null,
  更新年龄_In     Number := 0,
  购买病历_In     Number := 0,
  出诊记录id_In   临床出诊记录.Id%Type := Null
) As
  --功能：三方机构进行挂号(包含预约;预约挂号不扣款;预约挂号扣款)
  --入参:操作方式_IN:1-表示挂号,2-表示预约挂号不扣款,3-表示预约挂号,扣款
  --      结算方式_IN:支持多种结算方式,多种结算方式时，传入格式如下:结算方式名称1,金额,结算号码,三方卡标志|结算方式名称2,金额,结算号码,三方卡标志|...
  --      加入序号状态_In:1-表示强制加入挂号序号状态表中;否则根据启用序号或启用时段时才加入.
  --      是否自助设备_In:1-表示是医院的自助设备进行此函数的调用,自助设备调用此函数 允许加号,否则不允许
  --      锁定类型_In :0-产生正常数据 1-表示对单据进行锁定,产生未生效的单据信息;2-对锁定的记录进行解锁-生成正常数据:未生效的单据在银行扣款完成后进行解锁
  --      保险结算_IN:格式="结算方式|结算金额||....."
  Err_Item Exception;
  Err_Special Exception;
  v_Err_Msg            Varchar2(255);
  n_打印id             票据打印内容.Id%Type;
  n_返回值             病人预交记录.金额%Type;
  v_排队号码           Varchar2(20);
  v_队列名称           排队叫号队列.队列名称%Type;
  n_预交id             病人预交记录.Id%Type;
  n_挂号id             病人挂号记录.Id%Type;
  v_结算内容           Varchar2(3000);
  v_当前结算           Varchar2(150);
  d_发生时间           Date;
  v_结算方式           病人预交记录.结算方式%Type;
  n_结算金额           病人预交记录.冲预交%Type;
  n_结算合计           Number(16, 5);
  n_预交金额           病人预交记录.冲预交%Type;
  n_组id               财务缴款分组.Id%Type;
  d_排队时间           Date;
  n_锁定               Number;
  n_病人预约科室数     Number(18);
  n_已约科室           Number(18);
  n_合作单位限制       Number(18);
  n_是否开放           Number(1);
  n_Count              Number(18);
  n_行号               Number(18);
  n_序号               病人挂号记录.号序%Type;
  n_费用id             门诊费用记录.Id%Type;
  n_价格父号           Number(18);
  n_原项目id           收费项目目录.Id%Type;
  n_原收入项目id       收费项目目录.Id%Type;
  v_诊室               病人挂号记录.诊室%Type;
  n_安排id             挂号安排.Id%Type;
  n_实收金额合计       门诊费用记录.实收金额%Type;
  n_开单部门id         门诊费用记录.开单部门id%Type;
  n_实收金额           门诊费用记录.实收金额%Type;
  n_应收金额           门诊费用记录.实收金额%Type;
  n_结帐id             病人结帐记录.Id%Type;
  v_Temp               Varchar2(500);
  n_预约时段序号       Number;
  n_预约总数           Number;
  d_时段开始时间       Date;
  v_收费项目ids        Varchar2(300);
  n_预约数量           合作单位挂号汇总.已约数%Type;
  n_号序               病人挂号记录.号序%Type;
  d_登记时间           Date;
  v_操作员编号         人员表.编号%Type;
  v_操作员姓名         人员表.姓名%Type;
  n_预约               Integer;
  v_星期               挂号安排时段.星期%Type;
  n_启用分时段         Integer;
  n_已挂数             病人挂号汇总.已挂数%Type;
  n_已约数             病人挂号汇总.已约数%Type;
  n_其中已接收         病人挂号汇总.已约数%Type;
  n_预约生成队列       Number;
  d_Date               Date;
  n_挂号序号           Number;
  v_排队序号           排队叫号队列.排队序号%Type;
  v_机器名             挂号序号状态.机器名%Type;
  v_序号操作员         挂号序号状态.操作员姓名%Type;
  v_序号机器名         挂号序号状态.机器名%Type;
  n_序号锁定           Number := 0;
  n_病历费id           收费特定项目.收费细目id%Type;
  v_付款方式           病人挂号记录.医疗付款方式%Type;
  v_费别               门诊费用记录.费别%Type;
  n_屏蔽费别           Number(3) := 0;
  n_Tmp安排id          挂号安排.Id%Type;
  n_计划id             挂号安排计划.Id%Type;
  v_年龄               病人信息.年龄%Type;
  n_合作单位限数量模式 Number;
  n_出诊记录id         临床出诊记录.Id%Type;
  n_挂号模式           Number(3);
  n_同科限号数         Number;
  n_同科限约数         Number;
  n_病人挂号科室数     Number;
  n_分时点显示         Number;
  d_启用时间           Date;
  n_Exists             Number;
  v_Para               Varchar2(2000);
  n_专家号挂号限制     Number;
  n_专家号预约限制     Number;
  v_时间段             时间段.时间段%Type;
  d_检查开始时间       时间段.开始时间%Type;
  d_检查结束时间       时间段.终止时间%Type;

  Cursor c_Pati(n_病人id 病人信息.病人id%Type) Is
    Select a.病人id, a.姓名, a.性别, a.年龄, a.住院号, a.门诊号, a.费别, a.险类, c.编码 As 付款方式
    From 病人信息 A, 医疗付款方式 C
    Where a.病人id = n_病人id And a.医疗付款方式 = c.名称(+);

  r_Pati c_Pati%RowType;

  --该游标用于收费冲预交的可用预交列表
  --以ID排序，优先冲上次未冲完的。
  Cursor c_Deposit(v_病人id 病人信息.病人id%Type) Is
    Select NO, Sum(Nvl(金额, 0) - Nvl(冲预交, 0)) As 金额, Min(记录状态) As 记录状态, Nvl(Max(结帐id), 0) As 结帐id,
           Max(Decode(记录性质, 1, ID, 0) * Decode(记录状态, 2, 0, 1)) As 原预交id
    From 病人预交记录
    Where 记录性质 In (1, 11) And 病人id = v_病人id And Nvl(预交类别, 2) = 1 Having Sum(Nvl(金额, 0) - Nvl(冲预交, 0)) <> 0
    Group By NO
    Order By 结帐id, NO;

  Cursor c_安排
  (
    v_号码        挂号安排.号码%Type,
    d_发生时间_In Date
  ) Is
    Select *
    From (With 安排时间段 As (Select 时间段
                         From (Select 时间段,
                                       To_Date(Decode(Sign(开始时间 - 终止时间), 1, '3000-01-09 ' || To_Char(开始时间, 'HH24:MI:SS'),
                                                       '3000-01-10 ' || To_Char(开始时间, 'HH24:MI:SS')), 'yyyy-mm-dd hh24:mi:ss') As 开始时间,
                                       To_Date(Decode(Sign(开始时间 - 终止时间), 1, '3000-01-11 ' || To_Char(终止时间, 'HH24:MI:SS'),
                                                       '3000-01-10 ' || To_Char(终止时间, 'HH24:MI:SS')), 'yyyy-mm-dd hh24:mi:ss') As 终止时间,
                                       To_Date('3000-01-10 ' || To_Char(d_发生时间_In, 'HH24:MI:SS'), 'yyyy-mm-dd hh24:mi:ss') As 当前时间,
                                       To_Date('3000-01-10 ' || To_Char(开始时间, 'HH24:MI:SS'), 'yyyy-mm-dd hh24:mi:ss') As 开始时间1,
                                       To_Date('3000-01-10 ' || To_Char(终止时间, 'HH24:MI:SS'), 'yyyy-mm-dd hh24:mi:ss') As 终止时间1
                                From 时间段)
                         Where 当前时间 Between 开始时间 And 终止时间1 Or 当前时间 Between 开始时间1 And 终止时间)
           Select Distinct p.Id, p.号类, p.号码, p.科室id, b.编码 As 科室编码, b.名称 As 科室名称, p.项目id, c.编码 As 项目编码, c.名称 As 项目名称,
                           p.医生id, d.编号 As 医生编号, p.医生姓名, p.限号数, p.限约数, p.周日 As 日, p.周一 As 一, p.周二 As 二, p.周三 As 三,
                           p.周四 As 四, p.周五 As 五, p.周六 As 六, p.序号控制, p.计划id
           From (Select p.Id, p.号码, p.号类, p.科室id, p.项目id, p.医生id, p.医生姓名, b.限号数, b.限约数, Nvl(p.病案必须, 0) As 病案必须, p.周日, p.周一,
                         p.周二, p.周三, p.周四, p.周五, p.周六, p.分诊方式, p.序号控制,
                         Decode(To_Char(d_发生时间_In, 'D'), '1', p.周日, '2', p.周一, '3', p.周二, '4', p.周三, '5', p.周四, '6', p.周五,
                                 '7', p.周六, Null) As 排班, Null As 计划id
                  From 挂号安排 P, 挂号安排限制 B
                  Where p.停用日期 Is Null And p.Id = b.安排id(+) And
                        b.限制项目(+) = Decode(To_Char(d_发生时间_In, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四',
                                           '6', '周五', '7', '周六', Null) And
                        d_发生时间_In Between Nvl(p.开始时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
                        Nvl(p.终止时间, To_Date('3000-01-01', 'YYYY-MM-DD')) And Not Exists
                   (Select 1
                         From 挂号安排计划
                         Where 安排id = p.Id And (d_发生时间_In Between 生效时间 And 失效时间) And 审核时间 Is Not Null) And Not Exists
                   (Select 1
                         From 挂号安排停用状态
                         Where 安排id = p.Id And d_发生时间_In Between 开始停止时间 And 结束停止时间) And p.号码 = v_号码
                  Union All
                  Select c.Id, c.号码, c.号类, c.科室id, p.项目id, p.医生id, p.医生姓名, b.限号数, b.限约数, Nvl(c.病案必须, 0) As 病案必须, p.周日, p.周一,
                         p.周二, p.周三, p.周四, p.周五, p.周六, p.分诊方式, p.序号控制,
                         Decode(To_Char(d_发生时间_In, 'D'), '1', p.周日, '2', p.周一, '3', p.周二, '4', p.周三, '5', p.周四, '6', p.周五,
                                 '7', p.周六, Null) As 排班, p.Id As 计划id
                  From 挂号安排计划 P, 挂号安排 C, 挂号计划限制 B,
                       (Select Max(a.生效时间) As 生效, 安排id
                         From 挂号安排计划 A, 挂号安排 B
                         Where a.安排id = b.Id And a.审核时间 Is Not Null And
                               发生时间_In Between Nvl(a.生效时间, To_Date('1900-01-01', 'yyyy-mm-dd')) And
                               Nvl(a.失效时间, To_Date('3000-01-01', 'yyyy-mm-dd')) And b.号码 = 号码_In
                         Group By 安排id) E
                  Where p.安排id = c.Id And p.Id = b.计划id(+) And p.生效时间 = e.生效 And p.安排id = e.安排id And
                        Nvl(p.生效时间, To_Date('1900-01-01', 'yyyy-mm-dd')) = Nvl(e.生效, To_Date('1900-01-01', 'yyyy-mm-dd')) And
                        b.限制项目(+) = Decode(To_Char(d_发生时间_In, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四',
                                           '6', '周五', '7', '周六', Null) And (d_发生时间_In Between p.生效时间 And p.失效时间) And
                        p.审核时间 Is Not Null And Not Exists
                   (Select 1
                         From 挂号安排停用状态
                         Where 安排id = c.Id And d_发生时间_In Between 开始停止时间 And 结束停止时间) And p.号码 = v_号码) P, 部门表 B, 收费项目目录 C,
                人员表 D
           Where p.科室id = b.Id And p.医生id = d.Id(+) And p.项目id = c.Id And
                 (c.撤档时间 Is Null Or c.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD')) And
                 (Nvl(p.医生id, 0) = 0 Or Exists
                  (Select 1
                   From 人员表 Q
                   Where p.医生id = q.Id And (q.撤档时间 = To_Date('3000-01-01', 'YYYY-MM-DD') Or q.撤档时间 Is Null))) And Exists
            (Select 1 From 安排时间段 Where 时间段 = p.排班))
           Order By 号码;


  r_安排 c_安排%RowType;

  Function Zl_诊室(号码_In 挂号安排.号码%Type) Return Varchar2 As
    n_分诊方式 挂号安排.分诊方式%Type;
    n_安排id   挂号安排.Id%Type;
    v_诊室     病人挂号记录.诊室%Type;
    v_Rowid    Varchar2(500);
    n_Next     Integer;
    n_First    Integer;
  Begin
  
    If 锁定类型_In = 2 Then
      --对单据进行解锁,首先检查是否存在锁定
      Select Count(Rowid) Into n_锁定 From 病人挂号记录 Where　记录状态 = 0 And NO = 单据号_In And 病人id = 病人id_In;
      If n_锁定 = 0 Then
        v_Err_Msg := '单据号为(' || 单据号_In || ')的单据,不存在或者已经被解锁!';
        Raise Err_Item;
      End If;
      Select Max(号序) Into n_号序 From 病人挂号记录 Where　记录状态 = 0 And NO = 单据号_In And 病人id = 病人id_In;
    End If;
  
    Begin
      Select ID, Nvl(分诊方式, 0) Into n_安排id, n_分诊方式 From 挂号安排 Where 号码 = 号码_In;
    Exception
      When Others Then
        n_安排id := -1;
    End;
  
    If n_安排id = -1 Then
      v_Err_Msg := '号码(' || 号码_In || ')未找到!';
      Raise Err_Item;
    End If;
    --0-不分诊、1-指定诊室、2-动态分诊、3-平均分诊,对应门诊诊室设置
    v_诊室 := Null;
    If n_分诊方式 = 1 Then
      --1-指定诊室
      Begin
        Select 门诊诊室 Into v_诊室 From 挂号安排诊室 Where 号表id = n_安排id;
      Exception
        When Others Then
          v_诊室 := Null;
      End;
    End If;
    If n_分诊方式 = 2 Then
      --2-动态分诊:该个号别当天挂号未诊数最少的诊室
      For c_诊室 In (Select 门诊诊室, Sum(Num) As Num
                   From (Select 门诊诊室, 0 As Num
                          From 挂号安排诊室
                          Where 号表id = n_安排id
                          Union All
                          Select 诊室, Count(诊室) As Num
                          From 病人挂号记录
                          Where Nvl(执行状态, 0) = 0 And 发生时间 Between Trunc(Sysdate) And Sysdate And 号别 = 号码_In And
                                诊室 In (Select 门诊诊室 From 挂号安排诊室 Where 号表id = n_安排id)
                          Group By 诊室)
                   Group By 门诊诊室
                   Order By Num) Loop
        v_诊室 := c_诊室.门诊诊室;
        Exit;
      End Loop;
    End If;
    If n_分诊方式 = 3 Then
    
      --平均分诊：当前分配=1表示下次应取的当前诊室
      n_Next  := 0;
      n_First := 1;
      For c_诊室 In (Select Rowid As Rid, 号表id, 门诊诊室, 当前分配 From 挂号安排诊室 Where 号表id = n_安排id) Loop
        If n_First = 1 Then
          v_Rowid := c_诊室.Rid;
        End If;
        If n_Next = 1 Then
          v_诊室 := c_诊室.门诊诊室;
          Update 挂号安排诊室 Set 当前分配 = 1 Where Rowid = c_诊室.Rid;
          Exit;
        End If;
        If Nvl(c_诊室.当前分配, 0) = 1 Then
          Update 挂号安排诊室 Set 当前分配 = 0 Where Rowid = c_诊室.Rid;
          n_Next := 1;
        End If;
      End Loop;
      If v_诊室 Is Null Then
        Update 挂号安排诊室 Set 当前分配 = 1 Where Rowid = v_Rowid Returning 门诊诊室 Into v_诊室;
      End If;
    End If;
  
    Return v_诊室;
  End;

  Function Zl_操作员
  (
    Type_In     Integer,
    Splitstr_In Varchar2
  ) Return Varchar2 As
    n_Step Number(18);
    v_Sub  Varchar2(1000);
    --Type_In:0-获取缺省部门ID;1-获取操作员编号;2-获取操作员姓名
    -- SplitStr:格式为:部门ID,部门名称;人员ID,人员编号,人员姓名(用Zl_Identity获取的)
  Begin
    If Type_In = 0 Then
      --缺省部门
      n_Step := Instr(Splitstr_In, ',');
      v_Sub  := Substr(Splitstr_In, 1, n_Step - 1);
      Return v_Sub;
    End If;
    If Type_In = 1 Then
      --操作员编码
      n_Step := Instr(Splitstr_In, ';');
      v_Sub  := Substr(Splitstr_In, n_Step + 1);
      n_Step := Instr(v_Sub, ',');
      v_Sub  := Substr(v_Sub, n_Step + 1);
      n_Step := Instr(v_Sub, ',');
      v_Sub  := Substr(v_Sub, 1, n_Step - 1);
      Return v_Sub;
    End If;
    If Type_In = 2 Then
      --操作员姓名
      n_Step := Instr(Splitstr_In, ';');
      v_Sub  := Substr(Splitstr_In, n_Step + 1);
      n_Step := Instr(v_Sub, ',');
      v_Sub  := Substr(v_Sub, n_Step + 1);
      n_Step := Instr(v_Sub, ',');
      v_Sub  := Substr(v_Sub, n_Step + 1);
      Return v_Sub;
    End If;
  End;

  Procedure Zl_三方机构挂号_出诊_Insert
  (
    记录id_In       临床出诊记录.Id%Type,
    操作方式_In     Integer,
    病人id_In       门诊费用记录.病人id%Type,
    号码_In         挂号安排.号码%Type,
    号序_In         挂号序号状态.序号%Type,
    单据号_In       门诊费用记录.No%Type,
    票据号_In       门诊费用记录.实际票号%Type,
    结算方式_In     Varchar2,
    摘要_In         门诊费用记录.摘要%Type, --预约挂号摘要信息
    发生时间_In     门诊费用记录.发生时间%Type,
    登记时间_In     门诊费用记录.登记时间%Type,
    合作单位_In     挂号合作单位.名称%Type,
    挂号金额合计_In 门诊费用记录.实收金额%Type,
    领用id_In       票据使用明细.领用id%Type,
    收费票据_In     Number := 0, --挂号是否使用收费票据
    交易流水号_In   病人预交记录.交易流水号%Type,
    交易说明_In     病人预交记录.交易说明%Type,
    预约方式_In     预约方式.名称%Type := Null,
    预交id_In       病人预交记录.Id%Type := Null,
    卡类别id_In     病人预交记录.卡类别id%Type := Null,
    加入序号状态_In Number := 0,
    是否自助设备_In Number := 0,
    结帐id_In       门诊费用记录.结帐id%Type := Null,
    锁定类型_In     Number := 0,
    保险结算_In     Varchar2 := Null,
    冲预交_In       Number := Null,
    支付卡号_In     病人预交记录.卡号%Type := Null,
    退号重用_In     Number := 1,
    费别_In         门诊费用记录.费别%Type := Null,
    机器名_In       挂号序号状态.机器名%Type := Null,
    更新年龄_In     Number := 0,
    购买病历_In     Number := 0
  ) As
    --功能：三方机构进行挂号(包含预约;预约挂号不扣款;预约挂号扣款),出诊表排班模式下使用
    --入参: 操作方式_IN:1-表示挂号,2-表示预约挂号不扣款,3-表示预约挂号,扣款
    --      加入序号状态_In:1-表示强制加入挂号序号状态表中;否则根据启用序号或启用时段时才加入.
    --      是否自助设备_In:1-表示是医院的自助设备进行此函数的调用,自助设备调用此函数 允许加号,否则不允许
    --      锁定类型_In :0-产生正常数据 1-表示对单据进行锁定,产生未生效的单据信息;2-对锁定的记录进行解锁-生成正常数据:未生效的单据在银行扣款完成后进行解锁
    --      保险结算_IN:格式="结算方式|结算金额||....."
    --      冲预交病人ids_In:多个用逗分分离,冲预交时有效(冲预交类别与业务操作保持一致),主要是使用家属的预交款
    Err_Item Exception;
    Err_Special Exception;
    v_Err_Msg            Varchar2(255);
    n_打印id             票据打印内容.Id%Type;
    n_返回值             病人预交记录.金额%Type;
    v_排队号码           Varchar2(20);
    v_队列名称           排队叫号队列.队列名称%Type;
    n_预交id             病人预交记录.Id%Type;
    n_挂号id             病人挂号记录.Id%Type;
    v_结算内容           Varchar2(3000);
    v_当前结算           Varchar2(150);
    v_结算方式           病人预交记录.结算方式%Type;
    n_结算金额           病人预交记录.冲预交%Type;
    n_结算合计           Number(16, 5);
    n_预交金额           病人预交记录.冲预交%Type;
    n_组id               财务缴款分组.Id%Type;
    d_排队时间           Date;
    n_锁定               Number;
    n_病人预约科室数     Number(18);
    n_已约科室           Number(18);
    d_发生时间           Date;
    n_合作单位限制       Number(18);
    n_是否开放           Number(1);
    n_Count              Number(18);
    n_行号               Number(18);
    n_序号               病人挂号记录.号序%Type;
    n_费用id             门诊费用记录.Id%Type;
    n_价格父号           Number(18);
    n_原项目id           收费项目目录.Id%Type;
    n_原收入项目id       收费项目目录.Id%Type;
    v_诊室               病人挂号记录.诊室%Type;
    n_实收金额合计       门诊费用记录.实收金额%Type;
    n_开单部门id         门诊费用记录.开单部门id%Type;
    n_实收金额           门诊费用记录.实收金额%Type;
    n_应收金额           门诊费用记录.实收金额%Type;
    n_结帐id             病人结帐记录.Id%Type;
    v_Temp               Varchar2(500);
    v_结算方式记录       Varchar2(1000);
    n_预约时段序号       Number;
    n_序号控制           临床出诊记录.是否序号控制%Type;
    n_限约数             临床出诊记录.限约数%Type;
    n_项目id             临床出诊记录.项目id%Type;
    n_科室id             临床出诊记录.科室id%Type;
    d_终止时间           临床出诊记录.终止时间%Type;
    v_医生姓名           临床出诊记录.医生姓名%Type;
    n_医生id             临床出诊记录.医生id%Type;
    n_预约顺序号         临床出诊序号控制.预约顺序号%Type;
    n_预约总数           Number;
    d_时段开始时间       Date;
    d_时段终止时间       Date;
    v_收费项目ids        Varchar2(300);
    n_三方卡标志         Number;
    n_号序               病人挂号记录.号序%Type;
    d_登记时间           Date;
    n_单笔金额           病人预交记录.冲预交%Type;
    v_结算号码           病人预交记录.结算号码%Type;
    v_操作员编号         人员表.编号%Type;
    v_操作员姓名         人员表.姓名%Type;
    n_预约               Integer;
    v_现金               病人预交记录.结算方式%Type;
    n_启用分时段         Integer;
    n_已挂数             病人挂号汇总.已挂数%Type;
    n_已约数             病人挂号汇总.已约数%Type;
    n_其中已接收         病人挂号汇总.已约数%Type;
    n_预约生成队列       Number;
    n_限号数             临床出诊记录.限号数%Type;
    d_Date               Date;
    n_挂号序号           Number;
    v_排队序号           排队叫号队列.排队序号%Type;
    v_机器名             挂号序号状态.机器名%Type;
    v_序号操作员         挂号序号状态.操作员姓名%Type;
    v_序号机器名         挂号序号状态.机器名%Type;
    n_序号锁定           Number := 0;
    n_病历费id           收费特定项目.收费细目id%Type;
    v_付款方式           病人挂号记录.医疗付款方式%Type;
    v_费别               门诊费用记录.费别%Type;
    n_屏蔽费别           Number(3) := 0;
    v_年龄               病人信息.年龄%Type;
    n_合作单位限数量模式 Number;
    n_同科限号数         Number;
    n_分时点显示         Number;
    n_同科限约数         Number;
    n_病人挂号科室数     Number;
    n_Exists             Number(5);
    n_替诊医生id         临床出诊记录.替诊医生id%Type;
    v_替诊医生姓名       临床出诊记录.替诊医生姓名%Type;
    d_替诊开始时间       临床出诊记录.替诊开始时间%Type;
    d_替诊终止时间       临床出诊记录.替诊终止时间%Type;
    n_专家号挂号限制     Number;
    n_专家号预约限制     Number;
  
    Cursor c_Pati(n_病人id 病人信息.病人id%Type) Is
      Select a.病人id, a.姓名, a.性别, a.年龄, a.住院号, a.门诊号, a.费别, a.险类, c.编码 As 付款方式
      From 病人信息 A, 医疗付款方式 C
      Where a.病人id = n_病人id And a.医疗付款方式 = c.名称(+);
  
    r_Pati c_Pati%RowType;
  
    --该游标用于收费冲预交的可用预交列表
    --以ID排序，优先冲上次未冲完的。
    Cursor c_Deposit(v_病人id 病人信息.病人id%Type) Is
      Select NO, Sum(Nvl(金额, 0) - Nvl(冲预交, 0)) As 金额, Min(记录状态) As 记录状态, Nvl(Max(结帐id), 0) As 结帐id,
             Max(Decode(记录性质, 1, ID, 0) * Decode(记录状态, 2, 0, 1)) As 原预交id
      From 病人预交记录
      Where 记录性质 In (1, 11) And 病人id = v_病人id And Nvl(预交类别, 2) = 1 Having Sum(Nvl(金额, 0) - Nvl(冲预交, 0)) <> 0
      Group By NO
      Order By 结帐id, NO;
  
    Function Zl_诊室(记录id_In 临床出诊记录.Id%Type) Return Varchar2 As
      n_分诊方式 临床出诊记录.分诊方式%Type;
      v_诊室     病人挂号记录.诊室%Type;
      v_Rowid    Varchar2(500);
      n_Next     Integer;
      n_First    Integer;
    Begin
    
      If 锁定类型_In = 2 Then
        --对单据进行解锁,首先检查是否存在锁定
        Select Count(Rowid)
        Into n_锁定
        From 病人挂号记录 Where　记录状态 = 0 And NO = 单据号_In And 病人id = 病人id_In;
        If n_锁定 = 0 Then
          v_Err_Msg := '单据号为(' || 单据号_In || ')的单据,不存在或者已经被解锁!';
          Raise Err_Item;
        End If;
        Select Max(号序) Into n_号序 From 病人挂号记录 Where　记录状态 = 0 And NO = 单据号_In And 病人id = 病人id_In;
      End If;
    
      Begin
        Select Nvl(分诊方式, 0) Into n_分诊方式 From 临床出诊记录 Where ID = 记录id_In;
      Exception
        When Others Then
          v_Err_Msg := '出诊记录(' || 记录id_In || ')未找到!';
          Raise Err_Item;
      End;
    
      --0-不分诊、1-指定诊室、2-动态分诊、3-平均分诊,对应门诊诊室设置
      v_诊室 := Null;
      If n_分诊方式 = 1 Then
        --1-指定诊室
        Begin
          Select b.名称 Into v_诊室 From 临床出诊诊室记录 A, 门诊诊室 B Where a.诊室id = b.Id And a.记录id = 记录id_In;
        Exception
          When Others Then
            v_诊室 := Null;
        End;
      End If;
      If n_分诊方式 = 2 Then
        --2-动态分诊:该个号别当天挂号未诊数最少的诊室
        For c_诊室 In (Select 门诊诊室, Sum(Num) As Num
                     From (Select b.名称 As 门诊诊室, 0 As Num
                            From 临床出诊诊室记录 A, 门诊诊室 B
                            Where a.诊室id = b.Id And a.记录id = 记录id_In
                            Union All
                            Select 诊室, Count(诊室) As Num
                            From 病人挂号记录
                            Where Nvl(执行状态, 0) = 0 And 发生时间 Between Trunc(Sysdate) And Sysdate And 号别 = 号码_In And
                                  诊室 In (Select d.名称
                                         From 临床出诊诊室记录 C, 门诊诊室 D
                                         Where c.诊室id = d.Id And c.记录id = 记录id_In)
                            Group By 诊室)
                     Group By 门诊诊室
                     Order By Num) Loop
          v_诊室 := c_诊室.门诊诊室;
          Exit;
        End Loop;
      End If;
      If n_分诊方式 = 3 Then
        --平均分诊：当前分配=1表示下次应取的当前诊室
        n_Next  := 0;
        n_First := 1;
        For c_诊室 In (Select a.Rowid As Rid, b.名称 As 门诊诊室, a.当前分配
                     From 临床出诊诊室记录 A, 门诊诊室 B
                     Where a.诊室id = b.Id And a.记录id = 记录id_In) Loop
          If n_First = 1 Then
            v_Rowid := c_诊室.Rid;
          End If;
          If n_Next = 1 Then
            v_诊室 := c_诊室.门诊诊室;
            Update 临床出诊诊室记录 Set 当前分配 = 1 Where Rowid = c_诊室.Rid;
            Exit;
          End If;
          If Nvl(c_诊室.当前分配, 0) = 1 Then
            Update 临床出诊诊室记录 Set 当前分配 = 0 Where Rowid = c_诊室.Rid;
            n_Next := 1;
          End If;
        End Loop;
        If v_诊室 Is Null Then
          Update 临床出诊诊室记录 Set 当前分配 = 1 Where Rowid = v_Rowid Returning 诊室id Into v_诊室;
          Select 名称 Into v_诊室 From 门诊诊室 Where ID = v_诊室;
        End If;
      End If;
      Return v_诊室;
    End;
  
    Function Zl_操作员
    (
      Type_In     Integer,
      Splitstr_In Varchar2
    ) Return Varchar2 As
      n_Step Number(18);
      v_Sub  Varchar2(1000);
      --Type_In:0-获取缺省部门ID;1-获取操作员编号;2-获取操作员姓名
      -- SplitStr:格式为:部门ID,部门名称;人员ID,人员编号,人员姓名(用Zl_Identity获取的)
    Begin
      If Type_In = 0 Then
        --缺省部门
        n_Step := Instr(Splitstr_In, ',');
        v_Sub  := Substr(Splitstr_In, 1, n_Step - 1);
        Return v_Sub;
      End If;
      If Type_In = 1 Then
        --操作员编码
        n_Step := Instr(Splitstr_In, ';');
        v_Sub  := Substr(Splitstr_In, n_Step + 1);
        n_Step := Instr(v_Sub, ',');
        v_Sub  := Substr(v_Sub, n_Step + 1);
        n_Step := Instr(v_Sub, ',');
        v_Sub  := Substr(v_Sub, 1, n_Step - 1);
        Return v_Sub;
      End If;
      If Type_In = 2 Then
        --操作员姓名
        n_Step := Instr(Splitstr_In, ';');
        v_Sub  := Substr(Splitstr_In, n_Step + 1);
        n_Step := Instr(v_Sub, ',');
        v_Sub  := Substr(v_Sub, n_Step + 1);
        n_Step := Instr(v_Sub, ',');
        v_Sub  := Substr(v_Sub, n_Step + 1);
        Return v_Sub;
      End If;
    End;
  
  Begin
    d_发生时间 := 发生时间_In;
  
    If d_发生时间 Is Null Then
      d_发生时间 := Sysdate;
    End If;
  
    Begin
      Select 名称 Into v_现金 From 结算方式 Where 性质 = 1;
    Exception
      When Others Then
        v_现金 := '现金';
    End;
  
    If 费别_In Is Null Then
      Select Zl_Custom_Getpatifeetype(1, 病人id_In) Into v_费别 From Dual;
    Else
      v_费别 := 费别_In;
    End If;
    If v_费别 Is Null Then
      n_屏蔽费别 := 1;
      Select 名称 Into v_费别 From 费别 Where 缺省标志 = 1 And Rownum < 2;
    End If;
    Update 病人信息 Set 费别 = v_费别 Where 病人id = 病人id_In;
  
    If 更新年龄_In = 1 Then
      Select Zl_Age_Calc(病人id_In) Into v_年龄 From Dual;
      If v_年龄 Is Not Null Then
        Update 病人信息 Set 年龄 = v_年龄 Where 病人id = 病人id_In;
      End If;
    End If;
    --获取当前机器名称
    If 机器名_In Is Not Null Then
      v_机器名 := 机器名_In;
    Else
      Select Terminal Into v_机器名 From V$session Where Audsid = Userenv('sessionid');
    End If;
    n_实收金额合计 := 0;
  
    Select Count(*) + 1
    Into n_挂号序号
    From 病人挂号记录
    Where 出诊记录id = 记录id_In And 登记时间 Between Trunc(发生时间_In) And Trunc(发生时间_In + 1) - 1 / 24 / 60 / 60;
  
    If 登记时间_In Is Null Then
      d_登记时间 := Sysdate;
    Else
      d_登记时间 := 登记时间_In;
    End If;
    If Trunc(Sysdate) > Trunc(发生时间_In) Then
      v_Err_Msg := '不能挂以前的号(' || To_Char(发生时间_In, 'yyyy-mm-dd') || ')。';
      Raise Err_Item;
    End If;
  
    v_Temp           := Nvl(zl_GetSysParameter('病人同科限挂N个号', 1111), '0|0') || '|';
    n_同科限号数     := To_Number(Substr(v_Temp, 1, Instr(v_Temp, '|') - 1));
    n_同科限约数     := To_Number(Nvl(zl_GetSysParameter('病人同科限约N个号', 1111), '0'));
    n_病人预约科室数 := To_Number(Nvl(zl_GetSysParameter('病人预约科室数', 1111), '0'));
    n_病人挂号科室数 := To_Number(Nvl(zl_GetSysParameter('病人挂号科室限制', 1111), '0'));
    n_专家号挂号限制 := To_Number(Nvl(zl_GetSysParameter('专家号挂号限制'), '0'));
    n_专家号预约限制 := To_Number(Nvl(zl_GetSysParameter('专家号预约限制'), '0'));
  
    --部门ID,部门名称;人员ID,人员编号,人员姓名
    v_Temp := Zl_Identity(0);
    If Nvl(v_Temp, ' ') = ' ' Then
      v_Err_Msg := '当前操作人员未设置对应的人员关系,不能继续。';
      Raise Err_Item;
    End If;
    n_开单部门id := To_Number(Zl_操作员(0, v_Temp));
    v_操作员编号 := Zl_操作员(1, v_Temp);
    v_操作员姓名 := Zl_操作员(2, v_Temp);
    n_组id       := Zl_Get组id(v_操作员姓名);
  
    --支付宝并发提交检查
    Select Nvl(Max(1), 0)
    Into n_Exists
    From 病人挂号记录
    Where 病人id = 病人id_In And 号别 = 号码_In And 号序 = 号序_In And 操作员姓名 = v_操作员姓名 And Nvl(记录id_In, 0) = Nvl(出诊记录id, 0) And
          登记时间 > Sysdate - 0.01 And 记录状态 = 1 And 发生时间 = 发生时间_In;
    If n_Exists = 1 Then
      v_Err_Msg := '病人已经挂号,不能重复挂相同的号！';
      Raise Err_Special;
    End If;
  
    If 操作方式_In <> 1 Then
      --预约检查是否添加合作单位控制
      --如果设置了合作单位控制 则
      Begin
        Select 1
        Into n_合作单位限制
        From 临床出诊挂号控制记录
        Where 记录id = 记录id_In And 类型 = 1 And 性质 = 1 And 控制方式 <> 4 And Rownum < 2;
      Exception
        When Others Then
          n_合作单位限制 := 0;
      End;
    End If;
  
    If 操作方式_In <> 2 Then
      v_诊室 := Zl_诊室(记录id_In);
    End If;
  
    --因为现在有按日编单据号规则,日挂号量不能超过10000次,所以要检查唯一约束。
    Select Count(*) Into n_Count From 门诊费用记录 Where 记录性质 = 4 And 记录状态 In (1, 3) And NO = 单据号_In;
    If n_Count <> 0 Then
      v_Err_Msg := '挂号单据号重复,不能保存！' || Chr(13) || '如果使用了按日顺序编号,当日挂号量不能超过10000人次。';
      Raise Err_Item;
    End If;
  
    Open c_Pati(病人id_In);
    n_Count := 0;
    Begin
      Fetch c_Pati
        Into r_Pati;
    Exception
      When Others Then
        n_Count := -1;
    End;
    If n_Count = -1 Then
      v_Err_Msg := '病人未找到，不能继续。';
      Raise Err_Item;
    End If;
  
    Begin
      Select Nvl(是否分时段, 0), 限号数, 已挂数, 其中已接收, 已约数, 是否序号控制, 限约数, 项目id, 科室id, 医生id, 医生姓名, 替诊医生id, 替诊医生姓名, 替诊开始时间, 替诊终止时间
      Into n_启用分时段, n_限号数, n_已挂数, n_其中已接收, n_已约数, n_序号控制, n_限约数, n_项目id, n_科室id, n_医生id, v_医生姓名, n_替诊医生id, v_替诊医生姓名,
           d_替诊开始时间, d_替诊终止时间
      From 临床出诊记录
      Where ID = 记录id_In And Nvl(是否锁定, 0) = 0;
    Exception
      When Others Then
        n_Count := -1;
    End;
    If n_Count = -1 Then
      v_Err_Msg := '该号别没有在' || To_Char(发生时间_In, 'yyyy-mm-dd hh24:mi:ss') || '中进行安排。';
      Raise Err_Item;
    End If;
  
    If 发生时间_In Between Nvl(d_替诊开始时间, Sysdate) And Nvl(d_替诊终止时间, Sysdate - 1) And v_替诊医生姓名 Is Not Null Then
      n_医生id   := n_替诊医生id;
      v_医生姓名 := v_替诊医生姓名;
    End If;
  
    --对参数控制进行检查
    --仅在预约不扣款时进行检查
    If 操作方式_In = 2 Then
      If Nvl(n_同科限约数, 0) <> 0 Or Nvl(n_病人预约科室数, 0) <> 0 Then
        n_已约科室 := 0;
        For c_Chkitem In (Select Distinct 执行部门id
                          From 病人挂号记录
                          Where 病人id = 病人id_In And 记录状态 = 1 And 记录性质 = 2 And 预约时间 Between Trunc(发生时间_In) And
                                Trunc(发生时间_In) + 1 - 1 / 24 / 60 / 60 And 执行部门id <> n_科室id) Loop
          n_已约科室 := n_已约科室 + 1;
        End Loop;
        If n_已约科室 >= Nvl(n_病人预约科室数, 0) And Nvl(n_病人预约科室数, 0) > 0 Then
          v_Err_Msg := '同一病人最多同时能预约[' || Nvl(n_病人预约科室数, 0) || ']个科室,不能再预约！';
          Raise Err_Item;
        End If;
      
        Select Count(1)
        Into n_Count
        From 病人挂号记录
        Where 病人id = 病人id_In And 记录状态 = 1 And 记录性质 = 2 And 预约时间 Between Trunc(发生时间_In) And
              Trunc(发生时间_In) + 1 - 1 / 24 / 60 / 60 And 执行部门id = n_科室id;
        If n_Count >= Nvl(n_同科限约数, 0) And Nvl(n_同科限约数, 0) > 0 Then
          v_Err_Msg := '该病人已经在该科室预约了' || n_Count || '次,不能再预约！';
          Raise Err_Item;
        End If;
      End If;
      If Nvl(n_专家号预约限制, 0) <> 0 Then
        Select Count(1)
        Into n_Count
        From 病人挂号记录
        Where 病人id = 病人id_In And 记录状态 = 1 And 记录性质 = 2 And 出诊记录id = 记录id_In;
        If n_Count >= Nvl(n_专家号预约限制, 0) And Nvl(n_专家号预约限制, 0) > 0 Then
          v_Err_Msg := '该病人已经超过本号预约限制,不能再预约！';
          Raise Err_Item;
        End If;
      End If;
    Else
      If Nvl(n_同科限号数, 0) <> 0 Or Nvl(n_病人挂号科室数, 0) <> 0 Then
        n_已约科室 := 0;
        For c_Chkitem In (Select Distinct 执行部门id
                          From 病人挂号记录
                          Where 病人id = 病人id_In And 记录状态 = 1 And 记录性质 = 1 And 发生时间 Between Trunc(发生时间_In) And
                                Trunc(发生时间_In) + 1 - 1 / 24 / 60 / 60 And 执行部门id <> n_科室id) Loop
          n_已约科室 := n_已约科室 + 1;
        End Loop;
        If n_已约科室 >= Nvl(n_病人挂号科室数, 0) And Nvl(n_病人挂号科室数, 0) > 0 Then
          v_Err_Msg := '同一病人最多同时能挂号[' || Nvl(n_病人挂号科室数, 0) || ']个科室,不能再挂号！';
          Raise Err_Item;
        End If;
      
        Select Count(1)
        Into n_Count
        From 病人挂号记录
        Where 病人id = 病人id_In And 记录状态 = 1 And 记录性质 = 1 And 发生时间 Between Trunc(发生时间_In) And
              Trunc(发生时间_In) + 1 - 1 / 24 / 60 / 60 And 执行部门id = n_科室id;
        If n_Count >= Nvl(n_同科限号数, 0) And Nvl(n_同科限号数, 0) > 0 Then
          v_Err_Msg := '该病人已经在该科室挂号了' || n_Count || '次,不能再挂号！';
          Raise Err_Item;
        End If;
      End If;
      If Nvl(n_专家号挂号限制, 0) <> 0 Then
        Select Count(1)
        Into n_Count
        From 病人挂号记录
        Where 病人id = 病人id_In And 记录状态 = 1 And 记录性质 = 1 And 出诊记录id = 记录id_In;
        If n_Count >= Nvl(n_专家号挂号限制, 0) And Nvl(n_专家号挂号限制, 0) > 0 Then
          v_Err_Msg := '该病人已经超过本号挂号限制,不能再挂号！';
          Raise Err_Item;
        End If;
      End If;
    End If;
  
    d_Date         := Null;
    d_时段开始时间 := Null;
  
    If Nvl(n_限号数, 0) >= 0 Or n_限号数 Is Null Then
      If n_启用分时段 = 1 Then
        If Nvl(n_序号控制, 0) = 1 Then
          If Nvl(是否自助设备_In, 0) = 0 Then
            Select Count(*), Max(开始时间)
            Into n_Count, d_时段开始时间
            From 临床出诊序号控制
            Where 记录id = 记录id_In And 序号 = Nvl(号序_In, 0);
          
            v_Temp := '挂号';
            If 操作方式_In > 1 Then
              v_Temp := '预约挂号';
            End If;
          
            If n_Count = 0 Then
              v_Err_Msg := '号别为' || 号码_In || '的挂号安排中不存在序号为' || Nvl(号序_In, 0) || '的安排,不能再' || v_Temp || '！';
              Raise Err_Item;
            End If;
          End If;
        
          --过点的,不能选择挂号
          If Trunc(Sysdate) = Trunc(发生时间_In) Then
            --挂当天的号
            v_Temp := To_Char(Sysdate, 'yyyy-mm-dd') || ' ';
            For v_时段 In (Select To_Date(v_Temp || To_Char(开始时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss') As 开始时间,
                                To_Date(To_Char(Sysdate + Decode(Sign(开始时间 - 终止时间), 1, 1, 0), 'yyyy-mm-dd') || ' ' ||
                                         To_Char(终止时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss') As 终止时间, 数量, 是否预约
                         From 临床出诊序号控制
                         Where 记录id = 记录id_In And 序号 = Nvl(号序_In, 0)) Loop
              If Sysdate > v_时段.终止时间 Then
                v_Err_Msg := '号别为' || 号码_In || '及号序为' || Nvl(号序_In, 0) || '的安排,已经超过时点,不能再' || v_Temp || '！';
                Raise Err_Item;
              End If;
            End Loop;
          End If;
        Elsif 操作方式_In > 1 Then
          --未启用序号的,需要检查预约的情况
          n_Count := 0;
          For v_时段 In (Select 序号, 开始时间, 终止时间, 数量, 是否预约
                       From 临床出诊序号控制
                       Where 记录id = 记录id_In And
                             (('3000-01-10 ' || To_Char(发生时间_In, 'HH24:MI:SS') Between
                             Decode(Sign(开始时间 - 终止时间 - 1 / 24 / 60 / 60), 1,
                                      '3000-01-09 ' || To_Char(开始时间, 'HH24:MI:SS'),
                                      '3000-01-10 ' || To_Char(开始时间, 'HH24:MI:SS')) And
                             '3000-01-10 ' || To_Char(终止时间 - 1 / 24 / 60 / 60, 'HH24:MI:SS')) Or
                             ('3000-01-10 ' || To_Char(发生时间_In, 'HH24:MI:SS') Between
                             '3000-01-10 ' || To_Char(开始时间, 'HH24:MI:SS') And
                             Decode(Sign(开始时间 - 终止时间 - 1 / 24 / 60 / 60), 1,
                                      '3000-01-11 ' || To_Char(终止时间 - 1 / 24 / 60 / 60, 'HH24:MI:SS'),
                                      '3000-01-10 ' || To_Char(终止时间 - 1 / 24 / 60 / 60, 'HH24:MI:SS'))))) Loop
            n_预约时段序号 := v_时段.序号;
            d_时段开始时间 := v_时段.开始时间;
            d_时段终止时间 := v_时段.终止时间;
          
            Select Count(*), Max(序号), Max(预约顺序号) + 1
            Into n_Count, n_预约总数, n_预约顺序号
            From 临床出诊序号控制
            Where 记录id = 记录id_In And Nvl(挂号状态, 0) Not In (0, 4, 5);
          
            If Nvl(n_Count, 0) > Nvl(v_时段.数量, 0) And 锁定类型_In <> 2 Then
              v_Err_Msg := '号别为' || 号码_In || '的挂号安排中在' || To_Char(v_时段.开始时间, 'hh24:mi:ss') || '至' ||
                           To_Char(v_时段.终止时间, 'hh24:mi:ss') || '最多只能预约' || Nvl(v_时段.数量, 0) || '人,不能再进行预约挂号！';
              Raise Err_Item;
            End If;
            n_Count := 1;
          End Loop;
        
          If n_Count = 0 Then
            v_Err_Msg := '号别为' || 号码_In || '的挂号安排中没有相关的安排计划(' || To_Char(发生时间_In, 'YYYY-mm-dd HH24:MI:SS') ||
                         '),不能进行预约挂号！';
            Raise Err_Item;
          End If;
        End If;
      End If;
    End If;
  
    If 操作方式_In = 1 And 锁定类型_In <> 2 Then
      --挂号规则:
      --  已挂数不能大于限号数
      If n_已挂数 >= Nvl(n_限号数, 0) And n_限号数 Is Not Null Then
        v_Err_Msg := '该号别今天已达到限号数 ' || Nvl(n_限号数, 0) || '不能再挂号！';
        Raise Err_Item;
      End If;
    End If;
  
    If 操作方式_In > 1 Then
      --预约的相关检查
      --规则:
      --   1.已限约不能超过限约数
      --   2.检查是否启用时段的
      If n_已约数 >= Nvl(n_限约数, 0) And Nvl(n_限约数, 0) <> 0 And n_限约数 Is Not Null And 锁定类型_In <> 2 Then
        v_Err_Msg := '该号别已达到限约数 ' || Nvl(n_限约数, 0) || '不能再预约挂号！';
        Raise Err_Item;
      End If;
      If 预约方式_In Is Not Null Then
        Select To_Number(Substr(Zl_Fun_Get临床出诊预约状态(记录id_In, 发生时间_In, 号序_In, 预约方式_In), 1, 1))
        Into n_Exists
        From Dual;
        If n_Exists <> 0 Then
          v_Err_Msg := '传入的预约方式' || 预约方式_In || '不可用,不能继续。';
          Raise Err_Item;
        End If;
      End If;
    End If;
    If n_合作单位限制 > 0 And 操作方式_In <> 1 And 合作单位_In Is Not Null Then
      If Nvl(n_序号控制, 0) = 1 And Nvl(号序_In, 0) = 0 Then
        v_Err_Msg := '当前安排使用了序号控制,请确认所需要预约的序号,不能继续。';
        Raise Err_Item;
      End If; --Nvl(r_安排.序号控制, 0) =0
    
      n_序号 := Case
                When Nvl(n_序号控制, 0) = 1 Or n_启用分时段 = 1 And 操作方式_In > 1 Then
                 Nvl(号序_In, 0)
                Else
                 0
              End;
    
      --合作单位控制模式
      Select Nvl(控制方式, 0)
      Into n_合作单位限数量模式
      From 临床出诊挂号控制记录
      Where 记录id = 记录id_In And 名称 = 合作单位_In And 类型 = 1 And 性质 = 1 And Rownum < 2;
    
      If n_合作单位限数量模式 = 0 Then
        v_Err_Msg := '当前号码(' || Nvl(号码_In, 0) || '未开放' || 合作单位_In || '的预约,不能继续。';
        Raise Err_Item;
      End If;
      If n_合作单位限数量模式 = 1 Or n_合作单位限数量模式 = 2 Then
        Select 数量
        Into n_Count
        From 临床出诊挂号控制记录
        Where 记录id = 记录id_In And 名称 = 合作单位_In And 类型 = 1 And 性质 = 1;
        If n_合作单位限数量模式 = 1 Then
          n_Count := Round(Nvl(n_限约数, n_限号数) * n_Count / 100);
        End If;
        Select Count(1)
        Into n_Exists
        From 病人挂号记录
        Where 记录状态 = 1 And 出诊记录id = 记录id_In And 合作单位 = 合作单位_In;
        If n_Exists >= n_Count Then
          v_Err_Msg := '当前号码(' || Nvl(号码_In, 0) || '已经超过' || 合作单位_In || '的预约限制,不能继续。';
          Raise Err_Item;
        End If;
      End If;
      --开放序号检查
      If n_合作单位限数量模式 = 3 Then
        For c_合作单位 In (Select 序号, 数量
                       From 临床出诊挂号控制记录
                       Where 记录id = 记录id_In And 名称 = 合作单位_In And 类型 = 1 And 性质 = 1 And 序号 = 号序_In) Loop
          If n_序号控制 = 1 Then
            Begin
              Select 1
              Into n_Count
              From 临床出诊序号控制
              Where 记录id = 记录id_In And 序号 = 号序_In And Nvl(挂号状态, 0) = 0;
            Exception
              When Others Then
                n_Count := 0;
            End;
            If n_Count = 1 Then
              n_是否开放 := 1;
            Else
              v_Err_Msg := '当前序号(' || Nvl(号序_In, 0) || '已经超过' || 合作单位_In || '的预约限制,不能继续。';
              Raise Err_Item;
            End If;
          Else
            Select Count(1)
            Into n_Count
            From 临床出诊序号控制
            Where 记录id = 记录id_In And 序号 = 号序_In And 预约顺序号 Is Not Null And Nvl(挂号状态, 0) <> 0;
            If n_Count >= c_合作单位.数量 Then
              v_Err_Msg := '当前序号(' || Nvl(号序_In, 0) || '已经超过' || 合作单位_In || '的预约限制,不能继续。';
              Raise Err_Item;
            Else
              n_是否开放 := 1;
            End If;
          End If;
        End Loop;
      
        If Nvl(n_是否开放, 0) = 0 Then
          v_Err_Msg := '当前序号(' || Nvl(号序_In, 0) || '未开放,不能继续。';
          Raise Err_Item;
        End If;
      End If;
    End If;
  
    --检查限号数和限约数
    n_行号         := 1;
    n_原项目id     := 0;
    n_原收入项目id := 0;
    n_实收金额合计 := 0;
    If 锁定类型_In <> 1 Then
      If 操作方式_In <> 2 Then
        If Nvl(结帐id_In, 0) = 0 Then
          --这里应该程序传入
          Select 病人结帐记录_Id.Nextval Into n_结帐id From Dual;
        Else
          n_结帐id := 结帐id_In;
        End If;
      Else
        n_结帐id := Null;
      End If;
    End If;
  
    If Nvl(购买病历_In, 0) = 1 Then
      Begin
        Select 收费细目id Into n_病历费id From 收费特定项目 Where 特定项目 = '病历费';
        v_收费项目ids := n_项目id || ',' || n_病历费id;
      Exception
        When Others Then
          v_Err_Msg := '不能确定病历费,挂号失败!';
          Raise Err_Item;
      End;
    Else
      v_收费项目ids := n_项目id;
    End If;
  
    For c_Item In (Select 1 As 性质, a.类别, a.Id As 项目id, a.名称 As 项目名称, a.编码 As 项目编码, a.计算单位, a.屏蔽费别, 1 As 数次,
                          c.Id As 收入项目id, c.名称 As 收入项目, c.编码 As 收入编码, c.收据费目, b.现价 As 单价, Null As 从属父号
                   From 收费项目目录 A, 收费价目 B, 收入项目 C
                   Where b.收费细目id = a.Id And b.收入项目id = c.Id And a.Id = n_项目id And d_发生时间 Between b.执行日期 And
                         Nvl(b.终止日期, To_Date('3000-1-1', 'YYYY-MM-DD'))
                   Union All
                   Select 2 As 性质, a.类别, a.Id As 项目id, a.名称 As 项目名称, a.编码 As 项目编码, a.计算单位, a.屏蔽费别, 1 As 数次,
                          c.Id As 收入项目id, c.名称 As 收入项目, c.编码 As 收入编码, c.收据费目, b.现价 As 单价, Null As 从属父号
                   From 收费项目目录 A, 收费价目 B, 收入项目 C
                   Where b.收费细目id = a.Id And b.收入项目id = c.Id And a.Id = n_病历费id And d_发生时间 Between b.执行日期 And
                         Nvl(b.终止日期, To_Date('3000-1-1', 'YYYY-MM-DD'))
                   Union All
                   Select 3 As 性质, a.类别, a.Id As 项目id, a.名称 As 项目名称, a.编码 As 项目编码, a.计算单位, a.屏蔽费别, d.从项数次 As 数次,
                          c.Id As 收入项目id, c.名称 As 收入项目, c.编码 As 收入编码, c.收据费目, b.现价 As 单价, 1 As 从属父号
                   From 收费项目目录 A, 收费价目 B, 收入项目 C, 收费从属项目 D
                   Where b.收费细目id = a.Id And b.收入项目id = c.Id And a.Id = d.从项id And
                         d.主项id In (Select Column_Value From Table(f_Str2list(v_收费项目ids))) And d_发生时间 Between b.执行日期 And
                         Nvl(b.终止日期, To_Date('3000-1-1', 'YYYY-MM-DD'))
                   Order By 性质, 项目编码, 收入编码) Loop
      n_价格父号 := Null;
      If n_原项目id = c_Item.项目id Then
        If n_原收入项目id <> c_Item.收入项目id Then
          n_价格父号 := n_行号;
        End If;
        n_原收入项目id := c_Item.收入项目id;
      End If;
      n_原项目id := c_Item.项目id;
      n_应收金额 := Round(c_Item.数次 * c_Item.单价, 5);
      n_实收金额 := n_应收金额;
      If Nvl(c_Item.屏蔽费别, 0) <> 1 And n_屏蔽费别 = 0 Then
        --打折:
        v_Temp     := Zl_Actualmoney(r_Pati.费别, c_Item.项目id, c_Item.收入项目id, n_应收金额);
        v_Temp     := Substr(v_Temp, Instr(v_Temp, ':') + 1);
        n_实收金额 := Zl_To_Number(v_Temp);
      End If;
      n_实收金额合计 := Nvl(n_实收金额合计, 0) + n_实收金额;
    
      --锁定单据不产生费用
      If 锁定类型_In <> 1 Then
        --产生病人挂号费用(可能单独是或包括病历费用)
        Select 病人费用记录_Id.Nextval Into n_费用id From Dual;
        --:操作方式_IN:1-表示挂号,2-表示预约挂号不扣款,3-表示预约挂号,扣款
        Insert Into 门诊费用记录
          (ID, 记录性质, 记录状态, 序号, 价格父号, 从属父号, NO, 实际票号, 门诊标志, 加班标志, 附加标志, 发药窗口, 病人id, 标识号, 付款方式, 姓名, 性别, 年龄, 费别, 病人科室id,
           收费类别, 计算单位, 收费细目id, 收入项目id, 收据费目, 付数, 数次, 标准单价, 应收金额, 实收金额, 结帐金额, 结帐id, 记帐费用, 开单部门id, 开单人, 划价人, 执行部门id, 执行人,
           操作员编号, 操作员姓名, 发生时间, 登记时间, 保险大类id, 保险项目否, 保险编码, 统筹金额, 摘要, 结论, 缴款组id)
        Values
          (n_费用id, 4, Decode(操作方式_In, 2, 0, 1), n_行号, n_价格父号, c_Item.从属父号, 单据号_In, 票据号_In, 1, Null, Null,
           Decode(操作方式_In, 2, To_Char(号序_In), v_诊室), r_Pati.病人id, r_Pati.门诊号, r_Pati.付款方式, r_Pati.姓名, r_Pati.性别,
           r_Pati.年龄, r_Pati.费别, n_科室id, c_Item.类别, 号码_In, c_Item.项目id, c_Item.收入项目id, c_Item.收据费目, 1, c_Item.数次,
           c_Item.单价, n_应收金额, n_实收金额, Decode(操作方式_In, 2, Null, n_实收金额), n_结帐id, 0, n_开单部门id, v_操作员姓名,
           Decode(操作方式_In, 2, v_操作员姓名, Null), n_科室id, v_医生姓名, v_操作员编号, v_操作员姓名, 发生时间_In, d_登记时间, Null, 0, Null, Null,
           摘要_In, 预约方式_In, Decode(操作方式_In, 2, Null, n_组id));
      End If;
      n_行号 := n_行号 + 1;
    
    End Loop;
  
    If Round(Nvl(挂号金额合计_In, 0), 5) <> Round(Nvl(n_实收金额合计, 0), 5) Then
      v_Err_Msg := '本次挂号金额不正确,可能是因为医院调整了价格,请重新获取挂号收费项目的价格,不能继续。';
      Raise Err_Item;
    End If;
  
    If n_启用分时段 = 1 Then
      d_Date := To_Date(To_Char(发生时间_In, 'yyyy-mm-dd') || ' ' || To_Char(d_时段开始时间, 'hh24:mi:ss'),
                        'yyyy-mm-dd hh24:mi:ss');
    Else
      d_Date := Trunc(发生时间_In);
    End If;
  
    --更新挂号序号状态
    If 锁定类型_In <> 2 Then
      n_号序 := 号序_In;
    End If;
    Begin
      Select 1
      Into n_Count
      From 临床出诊序号控制
      Where 记录id = 记录id_In And 序号 = n_号序 And Nvl(挂号状态, 0) Not In (0, 5);
    Exception
      When Others Then
        n_Count := 0;
    End;
    If n_Count = 1 Then
      If n_启用分时段 = 0 And Nvl(n_序号控制, 0) = 1 Then
        n_号序 := Null;
      End If;
      If n_启用分时段 = 1 And Nvl(n_序号控制, 0) = 1 Then
        v_Err_Msg := '当前序号已被使用，请重新选择一个序号！';
        Raise Err_Item;
      End If;
    End If;
  
    If n_启用分时段 = 0 And Nvl(n_序号控制, 0) = 1 And n_号序 Is Null And 锁定类型_In <> 2 Then
      Select Nvl(Min(序号), 0)
      Into n_号序
      From 临床出诊序号控制
      Where 记录id = 记录id_In And Nvl(挂号状态, 0) = 5 And 操作员姓名 = v_操作员姓名 And 工作站名称 = v_机器名;
      If n_号序 = 0 Then
        Select Nvl(Min(序号), 0) Into n_号序 From 临床出诊序号控制 Where 记录id = 记录id_In And Nvl(挂号状态, 0) = 0;
        If n_号序 = 0 Then
          Select Nvl(Max(序号), 0) + 1 Into n_号序 From 临床出诊序号控制 Where 记录id = 记录id_In;
        End If;
      End If;
    End If;
  
    If n_启用分时段 = 1 And 锁定类型_In <> 2 Then
      If 操作方式_In > 1 And Nvl(n_序号控制, 0) = 0 Then
        --规则:预约时段序号||预约数
        If Nvl(n_预约总数, 0) = 0 Then
          v_Temp := Nvl(n_限约数, 0);
          v_Temp := LTrim(RTrim(v_Temp));
          v_Temp := LPad(Nvl(n_预约总数, 0) + 1, Length(v_Temp), '0');
          v_Temp := n_预约时段序号 || v_Temp;
          n_号序 := To_Number(v_Temp);
        Else
          n_号序 := n_预约总数 + 1;
        End If;
      End If;
    End If;
  
    If Nvl(n_序号控制, 0) = 1 Or (操作方式_In > 1 And n_启用分时段 = 1) Or 加入序号状态_In = 1 Then
      --锁定序号的处理
      Begin
        Select 操作员姓名, 工作站名称
        Into v_序号操作员, v_序号机器名
        From 临床出诊序号控制
        Where 挂号状态 = 5 And 记录id = 记录id_In And 序号 = n_号序;
        n_序号锁定 := 1;
      Exception
        When Others Then
          v_序号操作员 := Null;
          v_序号机器名 := Null;
          n_序号锁定   := 0;
      End;
      If n_序号锁定 = 0 Then
        If n_启用分时段 = 1 And n_序号控制 = 0 Then
          Insert Into 临床出诊序号控制
            (记录id, 序号, 预约顺序号, 开始时间, 终止时间, 数量, 是否预约, 挂号状态, 类型, 名称, 操作员姓名, 备注)
            Select 记录id_In, n_预约时段序号, n_预约顺序号, d_时段开始时间, d_时段终止时间, 1, Decode(操作方式_In, 1, 0, 1), Decode(操作方式_In, 2, 2, 1),
                   1, 合作单位_In, v_操作员姓名, n_号序
            From Dual;
        Else
          Update 临床出诊序号控制
          Set 挂号状态 = Decode(操作方式_In, 2, 2, 1), 操作员姓名 = v_操作员姓名
          Where 记录id = 记录id_In And 序号 = n_号序;
        End If;
        If Sql%RowCount = 0 Then
          Begin
            If n_启用分时段 = 1 Then
              --分时段
              If n_序号控制 = 1 Then
                --序号控制
                Select Max(终止时间) Into d_终止时间 From 临床出诊序号控制 Where 记录id = 记录id_In;
                If Sysdate > d_终止时间 Then
                  d_终止时间 := Sysdate;
                End If;
                Insert Into 临床出诊序号控制
                  (记录id, 序号, 开始时间, 终止时间, 数量, 是否预约, 挂号状态, 类型, 名称, 操作员姓名)
                  Select 记录id_In, n_号序, d_终止时间, d_终止时间, 1, Decode(操作方式_In, 1, 0, 1), Decode(操作方式_In, 2, 2, 1), 1,
                         合作单位_In, v_操作员姓名
                  From Dual;
              Else
                --分时段,非序号控制
                Null;
              End If;
            Else
              --不分时段
              Insert Into 临床出诊序号控制
                (记录id, 序号, 开始时间, 终止时间, 数量, 是否预约, 挂号状态, 类型, 名称, 操作员姓名)
                Select 记录id_In, n_号序, 开始时间, 终止时间, 1, Decode(操作方式_In, 1, 0, 1), Decode(操作方式_In, 2, 2, 1), 1, 合作单位_In,
                       v_操作员姓名
                From 临床出诊序号控制
                Where 记录id = 记录id_In And 序号 = 1;
            End If;
          Exception
            When Others Then
              v_Err_Msg := '序号' || n_号序 || '已被使用,请重新选择一个序号.';
              Raise Err_Item;
          End;
        End If;
      Else
        If v_操作员姓名 <> v_序号操作员 Or v_机器名 <> v_序号机器名 Then
          v_Err_Msg := '序号' || n_号序 || '已被机器' || v_机器名 || '锁定,请重新选择一个序号.';
          Raise Err_Item;
        Else
          Update 临床出诊序号控制
          Set 挂号状态 = Decode(操作方式_In, 2, 2, 1), 锁号时间 = Null
          Where 记录id = 记录id_In And 序号 = n_号序 And 挂号状态 = 5 And 操作员姓名 = v_操作员姓名 And 工作站名称 = v_机器名;
        End If;
      End If;
    End If;
  
    --锁定单据不产生任何 费用
    If 操作方式_In <> 2 And 锁定类型_In <> 1 Then
      --挂号,预约挂号已经扣款部分
      n_预交id := 预交id_In;
      If Nvl(n_预交id, 0) = 0 Then
        Select 病人预交记录_Id.Nextval Into n_预交id From Dual;
      End If;
      n_结算合计 := 0;
      If 保险结算_In Is Not Null Then
        --各个保险结算
        v_结算内容 := 保险结算_In || '||';
        n_结算合计 := 0;
        While v_结算内容 Is Not Null Loop
          v_当前结算 := Substr(v_结算内容, 1, Instr(v_结算内容, '||') - 1);
          v_结算方式 := Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1);
          n_结算金额 := To_Number(Substr(v_当前结算, Instr(v_当前结算, '|') + 1));
          If Nvl(n_结算金额, 0) <> 0 Then
            Insert Into 病人预交记录
              (ID, 记录性质, NO, 记录状态, 病人id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 结算性质)
            Values
              (n_预交id, 4, 单据号_In, 1, Decode(病人id_In, 0, Null, 病人id_In), '保险结算', v_结算方式, d_登记时间, v_操作员编号, v_操作员姓名,
               n_结算金额, n_结帐id, n_组id, n_结帐id, 4);
            Select 病人预交记录_Id.Nextval Into n_预交id From Dual;
          End If;
          n_结算合计 := Nvl(n_结算合计, 0) + Nvl(n_结算金额, 0);
          v_结算内容 := Substr(v_结算内容, Instr(v_结算内容, '||') + 2);
        End Loop;
      End If;
    
      If Nvl(冲预交_In, 0) <> 0 Then
        --处理总预交
        n_结算合计 := n_结算合计 + Nvl(冲预交_In, 0);
        n_预交金额 := 冲预交_In;
        For r_Deposit In c_Deposit(病人id_In) Loop
          n_结算金额 := Case
                      When r_Deposit.金额 - n_预交金额 < 0 Then
                       r_Deposit.金额
                      Else
                       n_预交金额
                    End;
          If r_Deposit.结帐id = 0 Then
            --第一次冲预交(填上结帐ID,金额为0)
            Update 病人预交记录 Set 冲预交 = 0, 结帐id = n_结帐id, 结算性质 = 4 Where ID = r_Deposit.原预交id;
          End If;
          --冲上次剩余额
          Insert Into 病人预交记录
            (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 预交类别, 科室id, 金额, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, 收款时间, 操作员姓名,
             操作员编号, 冲预交, 结帐id, 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算序号, 结算性质)
            Select 病人预交记录_Id.Nextval, NO, 实际票号, 11, 记录状态, 病人id, 主页id, 预交类别, 科室id, Null, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行,
                   单位帐号, d_登记时间, v_操作员姓名, v_操作员编号, n_结算金额, n_结帐id, n_组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, n_结帐id, 4
            From 病人预交记录
            Where NO = r_Deposit.No And 记录状态 = r_Deposit.记录状态 And 记录性质 In (1, 11) And Rownum = 1;
        
          --更新病人预交余额
          Update 病人余额
          Set 预交余额 = Nvl(预交余额, 0) - n_结算金额
          Where 病人id = 病人id_In And 性质 = 1 And 类型 = Nvl(1, 2)
          Returning 预交余额 Into n_返回值;
          If Sql%RowCount = 0 Then
            Insert Into 病人余额 (病人id, 预交余额, 性质, 类型) Values (病人id_In, -1 * n_结算金额, 1, 1);
            n_返回值 := -1 * n_结算金额;
          End If;
          If Nvl(n_返回值, 0) = 0 Then
            Delete From 病人余额
            Where 病人id = 病人id_In And 性质 = 1 And Nvl(费用余额, 0) = 0 And Nvl(预交余额, 0) = 0;
          End If;
        
          --检查是否已经处理完
          If r_Deposit.金额 <= n_结算金额 Then
            n_预交金额 := n_预交金额 - r_Deposit.金额;
          Else
            n_预交金额 := 0;
          End If;
          If n_预交金额 = 0 Then
            Exit;
          End If;
        End Loop;
        If n_预交金额 > 0 Then
          v_Err_Msg := '预交余额不够支付本次支付金额,不能继续操作！';
          Raise Err_Item;
        End If;
      End If;
      --剩余款项,用指定结算方支付
      n_结算金额 := Nvl(n_实收金额合计, 0) - Nvl(n_结算合计, 0);
      If Nvl(n_结算金额, 0) < 0 Then
        v_Err_Msg := '挂号的相关结算金额超出了当前实结金额,不能继续操作！';
        Raise Err_Item;
      End If;
    
      If Nvl(n_结算金额, 0) <> 0 Or (Nvl(n_结算金额, 0) = 0 And Nvl(冲预交_In, 0) = 0) Then
        If 结算方式_In Is Null Then
          v_Err_Msg := '未传入指定的结算方式,不能继续操作！';
          Raise Err_Item;
        End If;
      
        If Nvl(预交id_In, 0) <> 0 Then
          --传入的预交ID_In主要是为了解决三方交易,如果医保结算站用了该ID,需要用新的ID进行更新,三方交易用转入的ID
          Update 病人预交记录 Set ID = n_预交id Where ID = Nvl(预交id_In, 0);
          n_预交id := Nvl(预交id_In, 0);
        End If;
        If Instr(结算方式_In, ',') = 0 Then
          --只传入一种结算方式的
          Select 病人预交记录_Id.Nextval Into n_预交id From Dual;
          Insert Into 病人预交记录
            (ID, 记录性质, 记录状态, NO, 病人id, 结算方式, 冲预交, 收款时间, 操作员编号, 操作员姓名, 结帐id, 摘要, 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明,
             合作单位, 结算性质, 结算号码)
          Values
            (n_预交id, 4, 1, 单据号_In, Decode(病人id_In, 0, Null, 病人id_In), Nvl(结算方式_In, v_现金), Nvl(n_结算金额, 0), 登记时间_In,
             v_操作员编号, v_操作员姓名, n_结帐id, '挂号收费', n_组id, 卡类别id_In, Null, 支付卡号_In, 交易流水号_In, 交易说明_In, 合作单位_In, 4, v_结算号码);
        Else
          v_结算内容     := 结算方式_In || '|'; --以空格分开以|结尾,没有结算号码的
          n_Exists       := 0;
          v_结算方式记录 := '';
          While v_结算内容 Is Not Null Loop
            v_当前结算 := Substr(v_结算内容, 1, Instr(v_结算内容, '|') - 1);
            v_结算方式 := Substr(v_当前结算, 1, Instr(v_当前结算, ',') - 1);
          
            v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, ',') + 1);
            n_单笔金额 := To_Number(Substr(v_当前结算, 1, Instr(v_当前结算, ',') - 1));
          
            v_当前结算 := Substr(v_当前结算, Instr(v_当前结算, ',') + 1);
            v_结算号码 := Substr(v_当前结算, 1, Instr(v_当前结算, ',') - 1);
          
            v_当前结算   := Substr(v_当前结算, Instr(v_当前结算, ',') + 1);
            n_三方卡标志 := To_Number(v_当前结算);
          
            If Instr('|' || v_结算方式记录 || '|', '|' || Nvl(v_结算方式, v_现金) || '|') <> 0 Then
              v_Err_Msg := '使用了重复的结算方式,请检查!';
              Raise Err_Item;
            Else
              v_结算方式记录 := v_结算方式记录 || '|' || Nvl(v_结算方式, v_现金);
            End If;
          
            If n_三方卡标志 = 0 Then
              Select 病人预交记录_Id.Nextval Into n_预交id From Dual;
              Insert Into 病人预交记录
                (ID, 记录性质, 记录状态, NO, 病人id, 结算方式, 冲预交, 收款时间, 操作员编号, 操作员姓名, 结帐id, 摘要, 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号,
                 交易说明, 合作单位, 结算性质, 结算号码)
              Values
                (n_预交id, 4, 1, 单据号_In, Decode(病人id_In, 0, Null, 病人id_In), Nvl(v_结算方式, v_现金), Nvl(n_单笔金额, 0), 登记时间_In,
                 v_操作员编号, v_操作员姓名, n_结帐id, '挂号收费', n_组id, Null, Null, Null, Null, Null, 合作单位_In, 4, v_结算号码);
            Else
              If n_Exists = 1 Then
                v_Err_Msg := '目前挂号仅支持一种三方结算方式,不能继续操作！';
                Raise Err_Item;
              End If;
              Select 病人预交记录_Id.Nextval Into n_预交id From Dual;
              Insert Into 病人预交记录
                (ID, 记录性质, 记录状态, NO, 病人id, 结算方式, 冲预交, 收款时间, 操作员编号, 操作员姓名, 结帐id, 摘要, 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号,
                 交易说明, 合作单位, 结算性质, 结算号码)
              Values
                (n_预交id, 4, 1, 单据号_In, Decode(病人id_In, 0, Null, 病人id_In), Nvl(v_结算方式, v_现金), Nvl(n_单笔金额, 0), 登记时间_In,
                 v_操作员编号, v_操作员姓名, n_结帐id, '挂号收费', n_组id, 卡类别id_In, Null, 支付卡号_In, 交易流水号_In, 交易说明_In, 合作单位_In, 4, v_结算号码);
              n_Exists := 1;
            End If;
          
            v_结算内容 := Substr(v_结算内容, Instr(v_结算内容, '|') + 1);
          End Loop;
        End If;
      End If;
    
      --更新人员缴款数据
    
      For v_缴款 In (Select 结算方式, Sum(Nvl(a.冲预交, 0)) As 冲预交
                   From 病人预交记录 A
                   Where a.结帐id = n_结帐id And Mod(a.记录性质, 10) <> 1 And Nvl(病人id, 0) = Nvl(病人id_In, 0)
                   Group By 结算方式) Loop
      
        Update 人员缴款余额
        Set 余额 = Nvl(余额, 0) + Nvl(v_缴款.冲预交, 0)
        Where 收款员 = v_操作员姓名 And 性质 = 1 And 结算方式 = v_缴款.结算方式
        Returning 余额 Into n_返回值;
        If Sql%RowCount = 0 Then
          Insert Into 人员缴款余额
            (收款员, 结算方式, 性质, 余额)
          Values
            (v_操作员姓名, v_缴款.结算方式, 1, Nvl(v_缴款.冲预交, 0));
          n_返回值 := Nvl(v_缴款.冲预交, 0);
        End If;
        If Nvl(n_返回值, 0) = 0 Then
          Delete From 人员缴款余额
          Where 收款员 = v_操作员姓名 And 结算方式 = v_缴款.结算方式 And 性质 = 1 And Nvl(余额, 0) = 0;
        End If;
      End Loop;
    End If;
  
    --处理挂号记录
    If 锁定类型_In = 2 Then
      Begin
        Select ID Into n_挂号id From 病人挂号记录 Where　记录状态 = 0 And NO = 单据号_In And 病人id = 病人id_In;
      Exception
        When Others Then
          Null;
      End;
    Else
      Select 病人挂号记录_Id.Nextval Into n_挂号id From Dual;
    End If;
  
    Update 病人挂号记录
    Set 记录性质 = Decode(操作方式_In, 2, 2, 1), 记录状态 = Decode(锁定类型_In, 1, 0, 1), 门诊号 = r_Pati.门诊号, 操作员姓名 = v_操作员姓名,
        操作员编号 = v_操作员编号, 预约 = Decode(操作方式_In, 1, 0, 1),
        接收人 = Decode(锁定类型_In, 1, Null, Decode(操作方式_In, 2, Null, v_操作员姓名)),
        接收时间 = Case 锁定类型_In
                  When 1 Then
                   Null
                  Else
                   Case 操作方式_In
                     When 2 Then
                      Null
                     Else
                      d_登记时间
                   End
                End, 交易流水号 = Nvl(交易流水号_In, 交易流水号), 交易说明 = Nvl(交易说明_In, 交易说明), 合作单位 = Nvl(合作单位_In, 合作单位),
        预约操作员 = Decode(操作方式_In, 1, Nvl(预约操作员, Null), Nvl(预约操作员, v_操作员姓名)),
        预约操作员编号 = Decode(操作方式_In, 1, Nvl(预约操作员编号, Null), Nvl(预约操作员编号, v_操作员编号)), 出诊记录id = 记录id_In
    Where ID = n_挂号id;
    If Sql%NotFound Then
      Begin
        Select 名称 Into v_付款方式 From 医疗付款方式 Where 编码 = r_Pati.付款方式 And Rownum < 2;
      Exception
        When Others Then
          v_付款方式 := Null;
      End;
      Insert Into 病人挂号记录
        (ID, NO, 记录性质, 记录状态, 病人id, 门诊号, 姓名, 性别, 年龄, 号别, 急诊, 诊室, 附加标志, 执行部门id, 执行人, 执行状态, 执行时间, 登记时间, 发生时间, 预约时间, 操作员编号,
         操作员姓名, 复诊, 号序, 预约, 接收人, 接收时间, 交易流水号, 交易说明, 合作单位, 医疗付款方式, 预约操作员, 预约操作员编号, 出诊记录id)
      Values
        (n_挂号id, 单据号_In, Decode(操作方式_In, 2, 2, 1), Decode(锁定类型_In, 1, 0, 1), r_Pati.病人id, r_Pati.门诊号, r_Pati.姓名,
         r_Pati.性别, r_Pati.年龄, 号码_In, 0, v_诊室, Null, n_科室id, v_医生姓名, 0, Null, d_登记时间, 发生时间_In,
         Case When(Nvl(操作方式_In, 0)) = 1 Then Null Else 发生时间_In End, v_操作员编号, v_操作员姓名, 0, n_号序, Decode(操作方式_In, 1, 0, 1),
         Decode(操作方式_In, 2, Null, v_操作员姓名), Decode(操作方式_In, 2, To_Date(Null), d_登记时间), 交易流水号_In, 交易说明_In, 合作单位_In,
         v_付款方式, Decode(操作方式_In, 1, Null, v_操作员姓名), Decode(操作方式_In, 1, Null, v_操作员编号), 记录id_In);
    End If;
    --锁定单据不能产生队列
    If 锁定类型_In <> 1 Then
      n_预约生成队列 := 0;
      If 操作方式_In > 1 Then
        n_预约生成队列 := Zl_To_Number(zl_GetSysParameter('预约生成队列', 1113));
      End If;
      --挂号和收费的预约都直接进入队列(收费预约缺少接收过程,所以直接和挂号一样直接进入队列)
      If 操作方式_In <> 2 Or n_预约生成队列 = 1 Then
        If Zl_To_Number(zl_GetSysParameter('排队叫号模式', 1113)) <> 0 Then
          --排队叫号模式:-0-不产生队列;1-按医生或分诊台排队;2-先分诊,后医生站
          If Zl_To_Number(zl_GetSysParameter('分诊台签到排队', 1113)) = 0 Or n_预约生成队列 = 1 Then
            n_分时点显示 := Nvl(Zl_To_Number(zl_GetSysParameter(270)), 0);
            If Nvl(操作方式_In, 0) > 1 And n_分时点显示 = 1 And n_启用分时段 = 1 Then
              n_分时点显示 := 1;
            Else
              n_分时点显示 := Null;
            End If;
            --产生队列
            --.按”执行部门” 的方式生成队列
            v_队列名称 := n_科室id;
            v_排队号码 := Zlgetnextqueue(n_科室id, n_挂号id, 号码_In || '|' || 号序_In);
            --挂号id_In,号码_In,号序_In,缺省日期_In,扩展_In(暂无用)
            v_排队序号 := Zlgetsequencenum(0, n_挂号id, 0);
            --挂号id_In,号码_In,号序_In,缺省日期_In,扩展_In(暂无用)
            d_排队时间 := Zl_Get_Queuedate(n_挂号id, 号码_In, 号序_In, d_Date);
            --  队列名称_In , 业务类型_In, 业务id_In,科室id_In,排队号码_In,v_排队标记,患者姓名_In,病人ID_IN, 诊室_In, 医生姓名_In, 排队时间_In
            Zl_排队叫号队列_Insert(v_队列名称, 0, n_挂号id, n_科室id, v_排队号码, Null, r_Pati.姓名, r_Pati.病人id, v_诊室, v_医生姓名, d_排队时间,
                             预约方式_In, n_分时点显示, v_排队序号);
          End If;
        End If;
      End If;
    
      If Nvl(操作方式_In, 0) = 1 Then
        --处理票据使用情况
        If 票据号_In Is Not Null Then
          Select 票据打印内容_Id.Nextval Into n_打印id From Dual;
          --发出票据
          Insert Into 票据打印内容 (ID, 数据性质, NO) Values (n_打印id, 4, 单据号_In);
          Insert Into 票据使用明细
            (ID, 票种, 号码, 性质, 原因, 领用id, 打印id, 使用时间, 使用人)
          Values
            (票据使用明细_Id.Nextval, Decode(收费票据_In, 1, 1, 4), 票据号_In, 1, 1, 领用id_In, n_打印id, d_登记时间, v_操作员姓名);
          --状态改动
          Update 票据领用记录
          Set 当前号码 = 票据号_In, 剩余数量 = Decode(Sign(剩余数量 - 1), -1, 0, 剩余数量 - 1), 使用时间 = Sysdate
          Where ID = Nvl(领用id_In, 0);
        End If;
        --病人本次就诊(以发生时间为准)
        If Nvl(r_Pati.病人id, 0) <> 0 Then
          Update 病人信息 Set 就诊时间 = 发生时间_In, 就诊状态 = 1, 就诊诊室 = v_诊室 Where 病人id = r_Pati.病人id;
        End If;
      End If;
    End If;
    --病人挂号汇总
    --解锁单据时不用再对汇总单据进行统计了 在锁定单据时已经进行了汇总
    If 锁定类型_In <> 2 Then
      --操作方式_IN:1-表示挂号,2-表示预约挂号不扣款,3-表示预约挂号,扣款
      --是否为预约接收:0-非预约挂号; 1-预约挂号,2-预约接收;3-收费预约
      n_预约 := Case
                When Nvl(操作方式_In, 0) = 1 Then
                 0
                When Nvl(操作方式_In, 0) = 2 Then
                 1
                When Nvl(操作方式_In, 0) = 3 Then
                 3
                Else
                 0
              End;
      Zl_病人挂号汇总_Update(v_医生姓名, n_医生id, n_项目id, n_科室id, 发生时间_In, n_预约, 号码_In, 0, 记录id_In);
    End If;
    --消息推送
    Begin
      Execute Immediate 'Begin ZL_服务窗消息_发送(:1,:2); End;'
        Using 1, n_挂号id;
    Exception
      When Others Then
        Null;
    End;
  Exception
    When Err_Item Then
      Raise_Application_Error(-20101, '[ZLSOFT]+' || v_Err_Msg || '+[ZLSOFT]');
    When Err_Special Then
      Raise_Application_Error(-20105, '[ZLSOFT]+' || v_Err_Msg || '+[ZLSOFT]');
    When Others Then
      zl_ErrorCenter(SQLCode, SQLErrM);
  End;

Begin
  n_出诊记录id := 出诊记录id_In;
  v_Para       := zl_GetSysParameter(256);
  n_挂号模式   := Substr(v_Para, 1, 1);
  Begin
    d_启用时间 := To_Date(Substr(v_Para, 3), 'yyyy-mm-dd hh24:mi:ss');
  Exception
    When Others Then
      d_启用时间 := Null;
  End;

  d_发生时间 := 发生时间_In;
  If d_发生时间 Is Null Then
    d_发生时间 := Sysdate;
  End If;

  If Sysdate - 10 > Nvl(d_启用时间, Sysdate - 30) Then
    If n_挂号模式 = 1 And Nvl(发生时间_In, Sysdate) > Nvl(d_启用时间, Sysdate - 30) And n_出诊记录id Is Null Then
      v_Err_Msg := '系统当前处于出诊表排班模式，传入的参数无法确定挂号安排，请重试！';
      Raise Err_Item;
    End If;
  Else
    If n_挂号模式 = 1 And Nvl(发生时间_In, Sysdate) > Nvl(d_启用时间, Sysdate - 30) And n_出诊记录id Is Null Then
      Begin
        Select a.Id
        Into n_出诊记录id
        From 临床出诊记录 A, 临床出诊号源 B
        Where a.号源id = b.Id And b.号码 = 号码_In And Nvl(发生时间_In, Sysdate) Between a.开始时间 And a.终止时间;
      Exception
        When Others Then
          v_Err_Msg := '系统当前处于出诊表排班模式，传入的参数无法确定挂号安排，请重试！';
          Raise Err_Item;
      End;
    End If;
  End If;

  If n_出诊记录id Is Not Null Then
    --出诊表排班模式
    Zl_三方机构挂号_出诊_Insert(n_出诊记录id, 操作方式_In, 病人id_In, 号码_In, 号序_In, 单据号_In, 票据号_In, 结算方式_In, 摘要_In, 发生时间_In, 登记时间_In,
                        合作单位_In, 挂号金额合计_In, 领用id_In, 收费票据_In, 交易流水号_In, 交易说明_In, 预约方式_In, 预交id_In, 卡类别id_In, 加入序号状态_In,
                        是否自助设备_In, 结帐id_In, 锁定类型_In, 保险结算_In, 冲预交_In, 支付卡号_In, 退号重用_In, 费别_In, 机器名_In, 更新年龄_In, 购买病历_In);
  Else
    v_Temp := zl_GetSysParameter(256);
    If v_Temp Is Null Or Substr(v_Temp, 1, 1) = '0' Then
      Null;
    Else
      Begin
        d_启用时间 := To_Date(Substr(v_Temp, 3), 'YYYY-MM-DD hh24:mi:ss');
      Exception
        When Others Then
          Null;
      End;
      If 发生时间_In > d_启用时间 Then
        v_Err_Msg := '当前挂号的发生时间' || To_Char(发生时间_In, 'yyyy-mm-dd hh24:mi:ss') || '已经启用了出诊表排班模式,不能再使用计划排班模式挂号!';
        Raise Err_Item;
      End If;
    End If;
    If 费别_In Is Null Then
      Select Zl_Custom_Getpatifeetype(1, 病人id_In) Into v_费别 From Dual;
    Else
      v_费别 := 费别_In;
    End If;
    If v_费别 Is Null Then
      n_屏蔽费别 := 1;
      Select 名称 Into v_费别 From 费别 Where 缺省标志 = 1 And Rownum < 2;
    End If;
    Update 病人信息 Set 费别 = v_费别 Where 病人id = 病人id_In;
  
    If 更新年龄_In = 1 Then
      Select Zl_Age_Calc(病人id_In) Into v_年龄 From Dual;
      If v_年龄 Is Not Null Then
        Update 病人信息 Set 年龄 = v_年龄 Where 病人id = 病人id_In;
      End If;
    End If;
    --获取当前机器名称
    If 机器名_In Is Not Null Then
      v_机器名 := 机器名_In;
    Else
      Select Terminal Into v_机器名 From V$session Where Audsid = Userenv('sessionid');
    End If;
    n_实收金额合计 := 0;
    Select Count(*) + 1
    Into n_挂号序号
    From 病人挂号记录
    Where 号别 = 号码_In And 登记时间 Between Trunc(发生时间_In) And Trunc(发生时间_In + 1) - 1 / 24 / 60 / 60;
    --Begin
    v_Temp           := Nvl(zl_GetSysParameter('病人同科限挂N个号', 1111), '0|0') || '|';
    n_同科限号数     := To_Number(Substr(v_Temp, 1, Instr(v_Temp, '|') - 1));
    n_同科限约数     := To_Number(Nvl(zl_GetSysParameter('病人同科限约N个号', 1111), '0'));
    n_病人预约科室数 := To_Number(Nvl(zl_GetSysParameter('病人预约科室数', 1111), '0'));
    n_病人挂号科室数 := To_Number(Nvl(zl_GetSysParameter('病人挂号科室限制', 1111), '0'));
    n_专家号挂号限制 := To_Number(Nvl(zl_GetSysParameter('专家号挂号限制'), '0'));
    n_专家号预约限制 := To_Number(Nvl(zl_GetSysParameter('专家号预约限制'), '0'));
  
    --部门ID,部门名称;人员ID,人员编号,人员姓名
    v_Temp := Zl_Identity(0);
    If Nvl(v_Temp, ' ') = ' ' Then
      v_Err_Msg := '当前操作人员未设置对应的人员关系,不能继续。';
      Raise Err_Item;
    End If;
  
    If 登记时间_In Is Null Then
      d_登记时间 := Sysdate;
    Else
      d_登记时间 := 登记时间_In;
    End If;
    If Trunc(Sysdate) > Trunc(发生时间_In) Then
      v_Err_Msg := '不能挂以前的号(' || To_Char(发生时间_In, 'yyyy-mm-dd') || ')。';
      Raise Err_Item;
    End If;
    n_开单部门id := To_Number(Zl_操作员(0, v_Temp));
    v_操作员编号 := Zl_操作员(1, v_Temp);
    v_操作员姓名 := Zl_操作员(2, v_Temp);
    n_组id       := Zl_Get组id(v_操作员姓名);
  
    --支付宝并发提交检查
    Select Nvl(Max(1), 0)
    Into n_Exists
    From 病人挂号记录
    Where 病人id = 病人id_In And 号别 = 号码_In And 号序 = 号序_In And 操作员姓名 = v_操作员姓名 And Nvl(n_出诊记录id, 0) = Nvl(出诊记录id, 0) And
          登记时间 > Sysdate - 0.01 And 记录状态 = 1 And 发生时间 = 发生时间_In;
    If n_Exists = 1 Then
      v_Err_Msg := '病人已经挂号,不能重复挂相同的号！';
      Raise Err_Special;
    End If;
  
    If 操作方式_In <> 1 Then
      --预约检查是否添加合作单位控制
      --如果设置了合作单位控制 则
      Begin
        Select ID
        Into n_计划id
        From 挂号安排计划
        Where 号码 = 号码_In And 发生时间_In Between Nvl(生效时间, To_Date('1900-01-01', 'YYYY-MM-DD')) And
              Nvl(失效时间, To_Date('3000-01-01', 'YYYY-MM-DD')) And Rownum < 2
        Order By 生效时间 Desc;
      Exception
        When Others Then
          Select ID Into n_Tmp安排id From 挂号安排 Where 号码 = 号码_In;
      End;
      If Nvl(n_计划id, 0) <> 0 Then
        Select Count(0)
        Into n_合作单位限制
        From 合作单位计划控制
        Where 合作单位 = 合作单位_In And 计划id = n_计划id And Rownum < 2;
      Else
        Select Count(0)
        Into n_合作单位限制
        From 合作单位安排控制
        Where 合作单位 = 合作单位_In And 安排id = n_Tmp安排id And Rownum < 2;
      End If;
    End If;
  
    If 操作方式_In <> 2 Then
      v_诊室 := Zl_诊室(号码_In);
    End If;
    If 操作方式_In <> 2 And 结算方式_In Is Not Null Then
      --检查结算方式是否完备
      Select Count(*) Into n_Count From 结算方式 Where 名称 = Nvl(结算方式_In, 'Lxh') And 性质 In (2, 7, 8);
      If Nvl(卡类别id_In, 0) <> 0 And n_Count = 0 Then
        Select Count(1)
        Into n_Count
        From 医疗卡类别
        Where ID = Nvl(卡类别id_In, 0) And 结算方式 = Nvl(结算方式_In, 'lxh');
      End If;
      If n_Count = 0 Then
        v_Err_Msg := '结算方式(' || 结算方式_In || ')未设置,请在结算方式管理中设置。';
        Raise Err_Item;
      End If;
    End If;
  
    --因为现在有按日编单据号规则,日挂号量不能超过10000次,所以要检查唯一约束。
    Select Count(*) Into n_Count From 门诊费用记录 Where 记录性质 = 4 And 记录状态 In (1, 3) And NO = 单据号_In;
    If n_Count <> 0 Then
      v_Err_Msg := '挂号单据号重复,不能保存！' || Chr(13) || '如果使用了按日顺序编号,当日挂号量不能超过10000人次。';
      Raise Err_Item;
    End If;
  
    Open c_Pati(病人id_In);
    n_Count := 0;
    Begin
      Fetch c_Pati
        Into r_Pati;
    Exception
      When Others Then
        n_Count := -1;
    End;
    If n_Count = -1 Then
      v_Err_Msg := '病人未找到，不能继续。';
      Raise Err_Item;
    End If;
  
    Open c_安排(号码_In, 发生时间_In);
    Begin
      Fetch c_安排
        Into r_安排;
    Exception
      When Others Then
        n_Count := -1;
    End;
    If n_Count = -1 Then
      v_Err_Msg := '该号别没有在' || To_Char(发生时间_In, 'yyyy-mm-dd hh24:mi:ss') || '中进行安排。';
      Raise Err_Item;
    End If;
  
    Select Decode(To_Char(发生时间_In, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五', '7', '周六',
                   '周日')
    Into v_星期
    From Dual;
    Begin
      If r_安排.计划id Is Null Then
        Select Max(1) Into n_启用分时段 From 挂号安排时段 Where 安排id = r_安排.Id And 星期 = v_星期 And Rownum < 2;
        Select Decode(To_Char(发生时间_In, 'D'), '1', 周日, '2', 周一, '3', 周二, '4', 周三, '5', 周四, '6', 周五, '7', 周六, Null)
        Into v_时间段
        From 挂号安排
        Where ID = r_安排.Id;
      Else
        Select Max(1)
        Into n_启用分时段
        From 挂号计划时段
        Where 计划id = r_安排.计划id And 星期 = v_星期 And Rownum < 2;
        Select Decode(To_Char(发生时间_In, 'D'), '1', 周日, '2', 周一, '3', 周二, '4', 周三, '5', 周四, '6', 周五, '7', 周六, Null)
        Into v_时间段
        From 挂号安排计划
        Where ID = r_安排.计划id;
      End If;
    Exception
      When Others Then
        n_启用分时段 := 0;
    End;
  
    If v_时间段 Is Not Null And d_启用时间 Is Not Null Then
      --检查是否跨模式挂号安排
      Select To_Date(To_Char(发生时间_In, 'yyyy-mm-dd') || ' ' || To_Char(开始时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss'),
             To_Date(To_Char(发生时间_In, 'yyyy-mm-dd') || ' ' || To_Char(终止时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss')
      Into d_检查开始时间, d_检查结束时间
      From 时间段
      Where 时间段 = v_时间段 And 站点 Is Null And 号类 Is Null;
      If d_检查开始时间 > d_检查结束时间 Then
        d_检查结束时间 := d_检查结束时间 + 1;
      End If;
      If d_检查结束时间 > d_启用时间 Then
        --获取出诊记录id
        Begin
          Select a.Id
          Into n_出诊记录id
          From 临床出诊记录 A, 临床出诊号源 B
          Where a.号源id = b.Id And b.号码 = 号码_In And 上班时段 = v_时间段 And 发生时间_In Between 开始时间 And 终止时间;
        Exception
          When Others Then
            n_出诊记录id := Null;
        End;
      End If;
    End If;
  
    --对参数控制进行检查
    --仅在预约不扣款时进行检查
    If 操作方式_In = 2 Then
      If Nvl(n_同科限约数, 0) <> 0 Or Nvl(n_病人预约科室数, 0) <> 0 Then
        n_已约科室 := 0;
        For c_Chkitem In (Select Distinct 执行部门id
                          From 病人挂号记录
                          Where 病人id = 病人id_In And 记录状态 = 1 And 记录性质 = 2 And 预约时间 Between Trunc(发生时间_In) And
                                Trunc(发生时间_In) + 1 - 1 / 24 / 60 / 60 And 执行部门id <> r_安排.科室id) Loop
          n_已约科室 := n_已约科室 + 1;
        End Loop;
        If n_已约科室 >= Nvl(n_病人预约科室数, 0) And Nvl(n_病人预约科室数, 0) > 0 Then
          v_Err_Msg := '同一病人最多同时能预约[' || Nvl(n_病人预约科室数, 0) || ']个科室,不能再预约！';
          Raise Err_Item;
        End If;
      
        Select Count(1)
        Into n_Count
        From 病人挂号记录
        Where 病人id = 病人id_In And 记录状态 = 1 And 记录性质 = 2 And 预约时间 Between Trunc(发生时间_In) And
              Trunc(发生时间_In) + 1 - 1 / 24 / 60 / 60 And 执行部门id = r_安排.科室id;
        If n_Count >= Nvl(n_同科限约数, 0) And Nvl(n_同科限约数, 0) > 0 Then
          v_Err_Msg := '该病人已经在该科室预约了' || n_Count || '次,不能再预约！';
          Raise Err_Item;
        End If;
      End If;
      If Nvl(n_专家号预约限制, 0) <> 0 Then
        Select Count(1)
        Into n_Count
        From 病人挂号记录
        Where 病人id = 病人id_In And 记录状态 = 1 And 记录性质 = 2 And 预约时间 Between Trunc(发生时间_In) And
              Trunc(发生时间_In) + 1 - 1 / 24 / 60 / 60 And 号别 = r_安排.号码;
        If n_Count >= Nvl(n_专家号预约限制, 0) And Nvl(n_专家号预约限制, 0) > 0 Then
          v_Err_Msg := '该病人已经超过本号预约限制,不能再预约！';
          Raise Err_Item;
        End If;
      End If;
    Else
      If Nvl(n_同科限号数, 0) <> 0 Or Nvl(n_病人挂号科室数, 0) <> 0 Then
        n_已约科室 := 0;
        For c_Chkitem In (Select Distinct 执行部门id
                          From 病人挂号记录
                          Where 病人id = 病人id_In And 记录状态 = 1 And 记录性质 = 1 And 发生时间 Between Trunc(发生时间_In) And
                                Trunc(发生时间_In) + 1 - 1 / 24 / 60 / 60 And 执行部门id <> r_安排.科室id) Loop
          n_已约科室 := n_已约科室 + 1;
        End Loop;
        If n_已约科室 >= Nvl(n_病人挂号科室数, 0) And Nvl(n_病人挂号科室数, 0) > 0 Then
          v_Err_Msg := '同一病人最多同时能挂号[' || Nvl(n_病人挂号科室数, 0) || ']个科室,不能再挂号！';
          Raise Err_Item;
        End If;
      
        Select Count(1)
        Into n_Count
        From 病人挂号记录
        Where 病人id = 病人id_In And 记录状态 = 1 And 记录性质 = 1 And 发生时间 Between Trunc(发生时间_In) And
              Trunc(发生时间_In) + 1 - 1 / 24 / 60 / 60 And 执行部门id = r_安排.科室id;
        If n_Count >= Nvl(n_同科限号数, 0) And Nvl(n_同科限号数, 0) > 0 Then
          v_Err_Msg := '该病人已经在该科室挂号了' || n_Count || '次,不能再挂号！';
          Raise Err_Item;
        End If;
      End If;
      If Nvl(n_专家号挂号限制, 0) <> 0 Then
        Select Count(1)
        Into n_Count
        From 病人挂号记录
        Where 病人id = 病人id_In And 记录状态 = 1 And 记录性质 = 1 And 预约时间 Between Trunc(发生时间_In) And
              Trunc(发生时间_In) + 1 - 1 / 24 / 60 / 60 And 号别 = r_安排.号码;
        If n_Count >= Nvl(n_专家号挂号限制, 0) And Nvl(n_专家号挂号限制, 0) > 0 Then
          v_Err_Msg := '该病人已经超过本号挂号限制,不能再挂号！';
          Raise Err_Item;
        End If;
      End If;
    End If;
  
    d_Date         := Null;
    d_时段开始时间 := Null;
  
    If Nvl(r_安排.限号数, 0) >= 0 Or r_安排.限号数 Is Null Then
    
      Select Nvl(Sum(Nvl(b.已挂数, 0)), 0), Nvl(Sum(Nvl(b.其中已接收, 0)), 0), Nvl(Sum(Nvl(b.已约数, 0)), 0)
      Into n_已挂数, n_其中已接收, n_已约数
      From 挂号安排 A, 病人挂号汇总 B
      Where a.科室id = b.科室id And a.项目id = b.项目id And a.号码 = 号码_In And b.日期 Between Trunc(发生时间_In) And
            Trunc(发生时间_In) + 1 - 1 / 24 / 60 / 60 And (a.号码 = b.号码 Or b.号码 Is Null) And Nvl(a.医生id, 0) = Nvl(b.医生id, 0) And
            Nvl(a.医生姓名, '医生') = Nvl(b.医生姓名, '医生');
    
      If n_启用分时段 = 1 Then
        If Nvl(r_安排.序号控制, 0) = 1 Then
          If Nvl(是否自助设备_In, 0) = 0 Then
            If r_安排.计划id Is Null Then
              Select Count(*), Max(开始时间)
              Into n_Count, d_时段开始时间
              From 挂号安排时段
              Where 安排id = r_安排.Id And 星期 = v_星期 And 序号 = Nvl(号序_In, 0);
            Else
              Select Count(*), Max(开始时间)
              Into n_Count, d_时段开始时间
              From 挂号计划时段
              Where 计划id = r_安排.计划id And 星期 = v_星期 And 序号 = Nvl(号序_In, 0);
            End If;
            v_Temp := '挂号';
            If 操作方式_In > 1 Then
              v_Temp := '预约挂号';
            End If;
          
            If n_Count = 0 Then
              v_Err_Msg := '号别为' || 号码_In || '的挂号安排中不存在序号为' || Nvl(号序_In, 0) || '的安排,不能再' || v_Temp || '！';
              Raise Err_Item;
            End If;
          End If;
          --过点的,不能选择挂号
          If Trunc(Sysdate) = Trunc(发生时间_In) Then
            --挂当天的号
            v_Temp := To_Char(Sysdate, 'yyyy-mm-dd') || ' ';
            If r_安排.计划id Is Null Then
              For v_时段 In (Select To_Date(v_Temp || To_Char(开始时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss') As 开始时间,
                                  To_Date(To_Char(Sysdate + Decode(Sign(开始时间 - 结束时间), 1, 1, 0), 'yyyy-mm-dd') || ' ' ||
                                           To_Char(结束时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss') As 结束时间, 限制数量, 是否预约
                           From 挂号安排时段
                           Where 安排id = r_安排.Id And 星期 = v_星期 And 序号 = Nvl(号序_In, 0)) Loop
                If Sysdate > v_时段.结束时间 Then
                  v_Err_Msg := '号别为' || 号码_In || '及号序为' || Nvl(号序_In, 0) || '的安排,已经超过时点,不能再' || v_Temp || '！';
                  Raise Err_Item;
                End If;
              End Loop;
            Else
              For v_时段 In (Select To_Date(v_Temp || To_Char(开始时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss') As 开始时间,
                                  To_Date(To_Char(Sysdate + Decode(Sign(开始时间 - 结束时间), 1, 1, 0), 'yyyy-mm-dd') || ' ' ||
                                           To_Char(结束时间, 'hh24:mi:ss'), 'yyyy-mm-dd hh24:mi:ss') As 结束时间, 限制数量, 是否预约
                           From 挂号计划时段
                           Where 计划id = r_安排.计划id And 星期 = v_星期 And 序号 = Nvl(号序_In, 0)) Loop
                If Sysdate > v_时段.结束时间 Then
                  v_Err_Msg := '号别为' || 号码_In || '及号序为' || Nvl(号序_In, 0) || '的安排,已经超过时点,不能再' || v_Temp || '！';
                  Raise Err_Item;
                End If;
              End Loop;
            End If;
          End If;
        Elsif 操作方式_In > 1 Then
          --未启用序号的,需要检查预约的情况
          n_Count := 0;
          If r_安排.计划id Is Null Then
            For v_时段 In (Select 序号, 开始时间, 结束时间, 限制数量, 是否预约
                         From 挂号安排时段
                         Where 安排id = r_安排.Id And 星期 = v_星期 And
                               (('3000-01-10 ' || To_Char(发生时间_In, 'HH24:MI:SS') Between
                               Decode(Sign(开始时间 - 结束时间 - 1 / 24 / 60 / 60), 1,
                                        '3000-01-09 ' || To_Char(开始时间, 'HH24:MI:SS'),
                                        '3000-01-10 ' || To_Char(开始时间, 'HH24:MI:SS')) And
                               '3000-01-10 ' || To_Char(结束时间 - 1 / 24 / 60 / 60, 'HH24:MI:SS')) Or
                               ('3000-01-10 ' || To_Char(发生时间_In, 'HH24:MI:SS') Between
                               '3000-01-10 ' || To_Char(开始时间, 'HH24:MI:SS') And
                               Decode(Sign(开始时间 - 结束时间 - 1 / 24 / 60 / 60), 1,
                                        '3000-01-11 ' || To_Char(结束时间 - 1 / 24 / 60 / 60, 'HH24:MI:SS'),
                                        '3000-01-10 ' || To_Char(结束时间 - 1 / 24 / 60 / 60, 'HH24:MI:SS'))))) Loop
              n_预约时段序号 := v_时段.序号;
              d_时段开始时间 := v_时段.开始时间;
            
              Select Count(*), Max(序号)
              Into n_Count, n_预约总数
              From 挂号序号状态
              Where 号码 = 号码_In And 日期 = 发生时间_In And 状态 Not In (4, 5);
            
              If Nvl(n_Count, 0) > Nvl(v_时段.限制数量, 0) And 锁定类型_In <> 2 Then
                v_Err_Msg := '号别为' || 号码_In || '的挂号安排中在' || To_Char(v_时段.开始时间, 'hh24:mi:ss') || '至' ||
                             To_Char(v_时段.结束时间, 'hh24:mi:ss') || '最多只能预约' || Nvl(v_时段.限制数量, 0) || '人,不能再进行预约挂号！';
                Raise Err_Item;
              End If;
              n_Count := 1;
            End Loop;
          Else
            For v_时段 In (Select 序号, 开始时间, 结束时间, 限制数量, 是否预约
                         From 挂号计划时段
                         Where 计划id = r_安排.计划id And 星期 = v_星期 And
                               (('3000-01-10 ' || To_Char(发生时间_In, 'HH24:MI:SS') Between
                               Decode(Sign(开始时间 - 结束时间 - 1 / 24 / 60 / 60), 1,
                                        '3000-01-09 ' || To_Char(开始时间, 'HH24:MI:SS'),
                                        '3000-01-10 ' || To_Char(开始时间, 'HH24:MI:SS')) And
                               '3000-01-10 ' || To_Char(结束时间 - 1 / 24 / 60 / 60, 'HH24:MI:SS')) Or
                               ('3000-01-10 ' || To_Char(发生时间_In, 'HH24:MI:SS') Between
                               '3000-01-10 ' || To_Char(开始时间, 'HH24:MI:SS') And
                               Decode(Sign(开始时间 - 结束时间 - 1 / 24 / 60 / 60), 1,
                                        '3000-01-11 ' || To_Char(结束时间 - 1 / 24 / 60 / 60, 'HH24:MI:SS'),
                                        '3000-01-10 ' || To_Char(结束时间 - 1 / 24 / 60 / 60, 'HH24:MI:SS'))))) Loop
              n_预约时段序号 := v_时段.序号;
              d_时段开始时间 := v_时段.开始时间;
            
              Select Count(*), Max(序号)
              Into n_Count, n_预约总数
              From 挂号序号状态
              Where 号码 = 号码_In And 日期 = 发生时间_In And 状态 Not In (4, 5);
            
              If Nvl(n_Count, 0) > Nvl(v_时段.限制数量, 0) And 锁定类型_In <> 2 Then
                v_Err_Msg := '号别为' || 号码_In || '的挂号安排中在' || To_Char(v_时段.开始时间, 'hh24:mi:ss') || '至' ||
                             To_Char(v_时段.结束时间, 'hh24:mi:ss') || '最多只能预约' || Nvl(v_时段.限制数量, 0) || '人,不能再进行预约挂号！';
                Raise Err_Item;
              End If;
              n_Count := 1;
            End Loop;
          End If;
        
          If n_Count = 0 Then
            v_Err_Msg := '号别为' || 号码_In || '的挂号安排中没有相关的安排计划(' || To_Char(发生时间_In, 'YYYY-mm-dd HH24:MI:SS') ||
                         '),不能进行预约挂号！';
            Raise Err_Item;
          End If;
        End If;
      End If;
    End If;
  
    If 操作方式_In = 1 And 锁定类型_In <> 2 Then
      --挂号规则:
      --  已挂数不能大于限号数
      If n_已挂数 >= Nvl(r_安排.限号数, 0) And r_安排.限号数 Is Not Null Then
        v_Err_Msg := '该号别今天已达到限号数 ' || Nvl(r_安排.限号数, 0) || '不能再挂号！';
        Raise Err_Item;
      End If;
    End If;
  
    If 操作方式_In > 1 Then
      --预约的相关检查
      --规则:
      --   1.已限约不能超过限约数
      --   2.检查是否启用时段的
      If n_已约数 >= Nvl(r_安排.限约数, 0) And Nvl(r_安排.限约数, 0) <> 0 And r_安排.限约数 Is Not Null And 锁定类型_In <> 2 Then
        v_Err_Msg := '该号别已达到限约数 ' || Nvl(r_安排.限约数, 0) || '不能再预约挂号！';
        Raise Err_Item;
      End If;
    End If;
    If n_合作单位限制 > 0 And 操作方式_In <> 1 And 合作单位_In Is Not Null Then
    
      If Nvl(r_安排.序号控制, 0) = 1 And Nvl(号序_In, 0) = 0 Then
        v_Err_Msg := '当前安排使用了序号控制,请确认所需要预约的序号,不能继续。';
        Raise Err_Item;
      End If; --Nvl(r_安排.序号控制, 0) =0
    
      n_序号 := Case
                When Nvl(r_安排.序号控制, 0) = 1 Or n_启用分时段 = 1 And 操作方式_In > 1 Then
                 Nvl(号序_In, 0)
                Else
                 0
              End;
    
      --合作单位限数量模式
      Begin
        If Nvl(n_计划id, 0) <> 0 Then
          Select 0
          Into n_序号
          From 合作单位计划控制
          Where 合作单位 = 合作单位_In And 计划id = n_计划id And
                限制项目 = Decode(To_Char(发生时间_In, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五',
                              '7', '周六', Null) And 数量 <> 0 And 序号 = 0 And Rownum < 2;
        Else
          Select 0
          Into n_序号
          From 合作单位安排控制
          Where 合作单位 = 合作单位_In And 安排id = n_Tmp安排id And
                限制项目 = Decode(To_Char(发生时间_In, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五',
                              '7', '周六', Null) And 数量 <> 0 And 序号 = 0 And Rownum < 2;
        End If;
        n_合作单位限数量模式 := 1;
      Exception
        When Others Then
          n_合作单位限数量模式 := 0;
      End;
      --开放序号检查
      For c_合作单位 In (Select c.序号, 数量
                     From 挂号安排 A, 合作单位安排控制 C
                     Where a.号码 = 号码_In And Decode(To_Char(发生时间_In, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5',
                                                   '周四', '6', '周五', '7', '周六', Null) = c.限制项目(+) And a.Id = c.安排id And
                           c.合作单位 = 合作单位_In And c.序号 = n_序号 And Not Exists
                      (Select 1
                            From 挂号安排计划 D
                            Where d.安排id = a.Id And d.审核时间 Is Not Null And
                                  发生时间_In Between Nvl(d.生效时间, To_Date('1900-01-01', 'yyyy-mm-dd')) And
                                  Nvl(d.失效时间, To_Date('3000-01-01', 'yyyy-mm-dd')))
                     Union All
                     Select c.序号, 数量
                     From 挂号安排计划 A, 挂号安排 D, 合作单位计划控制 C,
                          (Select Max(a.生效时间) As 生效, 安排id
                            From 挂号安排计划 A, 挂号安排 B
                            Where a.安排id = b.Id And a.审核时间 Is Not Null And
                                  发生时间_In Between Nvl(a.生效时间, To_Date('1900-01-01', 'yyyy-mm-dd')) And
                                  Nvl(a.失效时间, To_Date('3000-01-01', 'yyyy-mm-dd')) And b.号码 = 号码_In
                            Group By 安排id) E
                     Where a.安排id = d.Id And a.审核时间 Is Not Null And d.号码 = 号码_In And a.安排id = e.安排id And
                           Nvl(a.生效时间, To_Date('1900-01-01', 'yyyy-mm-dd')) =
                           Nvl(e.生效, To_Date('1900-01-01', 'yyyy-mm-dd')) And
                           Decode(To_Char(发生时间_In, 'D'), '1', '周日', '2', '周一', '3', '周二', '4', '周三', '5', '周四', '6', '周五',
                                  '7', '周六', Null) = c.限制项目(+) And a.Id = c.计划id And c.合作单位 = 合作单位_In And c.序号 = n_序号 And
                           发生时间_In Between Nvl(a.生效时间, To_Date('1900-01-01', 'yyyy-mm-dd')) And
                           Nvl(a.失效时间, To_Date('3000-01-01', 'yyyy-mm-dd'))) Loop
      
        If Nvl(r_安排.序号控制, 0) = 1 And c_合作单位.序号 = n_序号 And n_合作单位限数量模式 = 0 Then
          n_是否开放 := 1;
          Exit;
        Elsif (Nvl(r_安排.序号控制, 0) = 0 And c_合作单位.序号 = n_序号) Or n_合作单位限数量模式 = 1 Then
          Begin
            Select Nvl(已约数, 0)
            Into n_预约数量
            From 合作单位挂号汇总
            Where 合作单位 = 合作单位_In And 日期 = Trunc(发生时间_In) And 号码 = 号码_In;
          Exception
            When Others Then
              n_预约数量 := 0;
          End;
          If c_合作单位.数量 <= n_预约数量 And Nvl(c_合作单位.数量, 0) > 0 And 锁定类型_In <> 2 Then
            v_Err_Msg := '该号别已达到限约数 ' || Nvl(c_合作单位.数量, 0) || '不能再预约挂号！';
            Raise Err_Item;
          End If;
          n_是否开放 := 1;
          Exit;
        End If;
      
      End Loop;
    
      If Nvl(n_是否开放, 0) = 0 Then
        v_Err_Msg := '当前序号(' || Nvl(号序_In, 0) || '未开放,不能继续。';
        Raise Err_Item;
      End If;
    End If;
  
    --检查限号数和限约数
    n_行号         := 1;
    n_原项目id     := 0;
    n_原收入项目id := 0;
    n_实收金额合计 := 0;
    If 锁定类型_In <> 1 Then
      If 操作方式_In <> 2 Then
        If Nvl(结帐id_In, 0) = 0 Then
          --这里应该程序传入
          Select 病人结帐记录_Id.Nextval Into n_结帐id From Dual;
        Else
          n_结帐id := 结帐id_In;
        End If;
      Else
        n_结帐id := Null;
      End If;
    End If;
  
    If Nvl(购买病历_In, 0) = 1 Then
      Begin
        Select 收费细目id Into n_病历费id From 收费特定项目 Where 特定项目 = '病历费';
        v_收费项目ids := r_安排.项目id || ',' || n_病历费id;
      Exception
        When Others Then
          v_Err_Msg := '不能确定病历费,挂号失败!';
          Raise Err_Item;
      End;
    Else
      v_收费项目ids := r_安排.项目id;
    End If;
  
    For c_Item In (Select 1 As 性质, a.类别, a.Id As 项目id, a.名称 As 项目名称, a.编码 As 项目编码, a.计算单位, a.屏蔽费别, 1 As 数次,
                          c.Id As 收入项目id, c.名称 As 收入项目, c.编码 As 收入编码, c.收据费目, b.现价 As 单价, Null As 从属父号
                   From 收费项目目录 A, 收费价目 B, 收入项目 C
                   Where b.收费细目id = a.Id And b.收入项目id = c.Id And a.Id = r_安排.项目id And d_发生时间 Between b.执行日期 And
                         Nvl(b.终止日期, To_Date('3000-1-1', 'YYYY-MM-DD'))
                   Union All
                   Select 2 As 性质, a.类别, a.Id As 项目id, a.名称 As 项目名称, a.编码 As 项目编码, a.计算单位, a.屏蔽费别, 1 As 数次,
                          c.Id As 收入项目id, c.名称 As 收入项目, c.编码 As 收入编码, c.收据费目, b.现价 As 单价, Null As 从属父号
                   From 收费项目目录 A, 收费价目 B, 收入项目 C
                   Where b.收费细目id = a.Id And b.收入项目id = c.Id And a.Id = n_病历费id And d_发生时间 Between b.执行日期 And
                         Nvl(b.终止日期, To_Date('3000-1-1', 'YYYY-MM-DD'))
                   Union All
                   Select 3 As 性质, a.类别, a.Id As 项目id, a.名称 As 项目名称, a.编码 As 项目编码, a.计算单位, a.屏蔽费别, d.从项数次 As 数次,
                          c.Id As 收入项目id, c.名称 As 收入项目, c.编码 As 收入编码, c.收据费目, b.现价 As 单价, 1 As 从属父号
                   From 收费项目目录 A, 收费价目 B, 收入项目 C, 收费从属项目 D
                   Where b.收费细目id = a.Id And b.收入项目id = c.Id And a.Id = d.从项id And
                         d.主项id In (Select Column_Value From Table(f_Str2list(v_收费项目ids))) And d_发生时间 Between b.执行日期 And
                         Nvl(b.终止日期, To_Date('3000-1-1', 'YYYY-MM-DD'))
                   Order By 性质, 项目编码, 收入编码) Loop
      n_价格父号 := Null;
      If n_原项目id = c_Item.项目id Then
        If n_原收入项目id <> c_Item.收入项目id Then
          n_价格父号 := n_行号;
        End If;
        n_原收入项目id := c_Item.收入项目id;
      End If;
      n_原项目id := c_Item.项目id;
      n_应收金额 := Round(c_Item.数次 * c_Item.单价, 5);
      n_实收金额 := n_应收金额;
      If Nvl(c_Item.屏蔽费别, 0) <> 1 And n_屏蔽费别 = 0 Then
        --打折:
        v_Temp     := Zl_Actualmoney(r_Pati.费别, c_Item.项目id, c_Item.收入项目id, n_应收金额);
        v_Temp     := Substr(v_Temp, Instr(v_Temp, ':') + 1);
        n_实收金额 := Zl_To_Number(v_Temp);
      End If;
      n_实收金额合计 := Nvl(n_实收金额合计, 0) + n_实收金额;
    
      --锁定单据不产生费用
      If 锁定类型_In <> 1 Then
        --产生病人挂号费用(可能单独是或包括病历费用)
        Select 病人费用记录_Id.Nextval Into n_费用id From Dual;
        --:操作方式_IN:1-表示挂号,2-表示预约挂号不扣款,3-表示预约挂号,扣款
        Insert Into 门诊费用记录
          (ID, 记录性质, 记录状态, 序号, 价格父号, 从属父号, NO, 实际票号, 门诊标志, 加班标志, 附加标志, 发药窗口, 病人id, 标识号, 付款方式, 姓名, 性别, 年龄, 费别, 病人科室id,
           收费类别, 计算单位, 收费细目id, 收入项目id, 收据费目, 付数, 数次, 标准单价, 应收金额, 实收金额, 结帐金额, 结帐id, 记帐费用, 开单部门id, 开单人, 划价人, 执行部门id, 执行人,
           操作员编号, 操作员姓名, 发生时间, 登记时间, 保险大类id, 保险项目否, 保险编码, 统筹金额, 摘要, 结论, 缴款组id)
        Values
          (n_费用id, 4, Decode(操作方式_In, 2, 0, 1), n_行号, n_价格父号, c_Item.从属父号, 单据号_In, 票据号_In, 1, Null, Null,
           Decode(操作方式_In, 2, To_Char(号序_In), v_诊室), r_Pati.病人id, r_Pati.门诊号, r_Pati.付款方式, r_Pati.姓名, r_Pati.性别,
           r_Pati.年龄, r_Pati.费别, r_安排.科室id, c_Item.类别, 号码_In, c_Item.项目id, c_Item.收入项目id, c_Item.收据费目, 1, c_Item.数次,
           c_Item.单价, n_应收金额, n_实收金额, Decode(操作方式_In, 2, Null, n_实收金额), n_结帐id, 0, n_开单部门id, v_操作员姓名,
           Decode(操作方式_In, 2, v_操作员姓名, Null), r_安排.科室id, r_安排.医生姓名, v_操作员编号, v_操作员姓名, 发生时间_In, d_登记时间, Null, 0, Null,
           Null, 摘要_In, 预约方式_In, Decode(操作方式_In, 2, Null, n_组id));
      End If;
      n_行号 := n_行号 + 1;
    
    End Loop;
  
    If Round(Nvl(挂号金额合计_In, 0), 5) <> Round(Nvl(n_实收金额合计, 0), 5) Then
      v_Err_Msg := '本次挂号金额不正确,可能是因为医院调整了价格,请重新获取挂号收费项目的价格,不能继续。';
      Raise Err_Item;
    End If;
  
    If n_启用分时段 = 1 Then
      d_Date := To_Date(To_Char(发生时间_In, 'yyyy-mm-dd') || ' ' || To_Char(d_时段开始时间, 'hh24:mi:ss'),
                        'yyyy-mm-dd hh24:mi:ss');
    Else
      d_Date := Trunc(发生时间_In);
    End If;
  
    --更新挂号序号状态
    If 锁定类型_In <> 2 Then
      n_号序 := 号序_In;
    End If;
    Begin
      Select 1
      Into n_Count
      From 挂号序号状态
      Where Trunc(日期) = Trunc(发生时间_In) And 号码 = 号码_In And 序号 = n_号序 And 状态 <> 5;
    Exception
      When Others Then
        n_Count := 0;
    End;
    If n_Count = 1 Then
      If n_启用分时段 = 0 And Nvl(r_安排.序号控制, 0) = 1 Then
        n_号序 := Null;
      End If;
      If n_启用分时段 = 1 And Nvl(r_安排.序号控制, 0) = 1 Then
        v_Err_Msg := '当前序号已被使用，请重新选择一个序号！';
        Raise Err_Item;
      End If;
    End If;
    n_Count := 0;
    If n_启用分时段 = 0 And Nvl(r_安排.序号控制, 0) = 1 And n_号序 Is Null And 锁定类型_In <> 2 Then
      If 退号重用_In = 1 Then
        Select Nvl(Max(序号), 0) + 1
        Into n_号序
        From 挂号序号状态
        Where 日期 = Trunc(发生时间_In) And 号码 = r_安排.号码 And 状态 Not In (4, 5);
      Else
        Select Nvl(Max(序号), 0) + 1
        Into n_号序
        From 挂号序号状态
        Where 日期 = Trunc(发生时间_In) And 号码 = r_安排.号码 And 状态 <> 5;
      End If;
    End If;
    If n_启用分时段 = 1 And 锁定类型_In <> 2 Then
    
      If 操作方式_In > 1 And Nvl(r_安排.序号控制, 0) = 0 Then
        --规则:预约时段序号||预约数
        If Nvl(n_预约总数, 0) = 0 Then
          v_Temp := Nvl(r_安排.限约数, 0);
          v_Temp := LTrim(RTrim(v_Temp));
          v_Temp := LPad(Nvl(n_预约总数, 0) + 1, Length(v_Temp), '0');
          v_Temp := n_预约时段序号 || v_Temp;
          n_号序 := To_Number(v_Temp);
        Else
          n_号序 := n_预约总数 + 1;
        End If;
      End If;
    End If;
  
    If Nvl(r_安排.序号控制, 0) = 1 Or (操作方式_In > 1 And n_启用分时段 = 1) Or 加入序号状态_In = 1 Then
      --锁定序号的处理
      Begin
        Select 操作员姓名, 机器名
        Into v_序号操作员, v_序号机器名
        From 挂号序号状态
        Where 状态 = 5 And 号码 = 号码_In And Trunc(日期) = Trunc(d_Date) And 序号 = n_号序;
        n_序号锁定 := 1;
      Exception
        When Others Then
          v_序号操作员 := Null;
          v_序号机器名 := Null;
          n_序号锁定   := 0;
      End;
      If n_序号锁定 = 0 Then
        Update 挂号序号状态
        Set 状态 = Decode(操作方式_In, 2, 2, 1), 预约 = Decode(操作方式_In, 1, 0, 1), 登记时间 = Sysdate
        Where 号码 = 号码_In And 日期 = d_Date And 序号 = n_号序 And 操作员姓名 = v_操作员姓名;
        If Sql%RowCount = 0 Then
          Begin
            Insert Into 挂号序号状态
              (号码, 日期, 序号, 状态, 操作员姓名, 预约, 登记时间)
            Values
              (号码_In, d_Date, n_号序, Decode(操作方式_In, 2, 2, 1), v_操作员姓名, Decode(操作方式_In, 1, 0, 1), Sysdate);
          
            If n_合作单位限制 > 0 And 操作方式_In > 1 And Nvl(n_是否开放, 0) = 1 Then
              Update 合作单位挂号汇总
              Set 已约数 = 已约数 + Decode(操作方式_In, 2, 1, 0), 已接数 = 已接数 + Decode(操作方式_In, 3, 1, 0)
              Where 号码 = 号码_In And 日期 = d_Date And 序号 = n_号序 And 合作单位 = 合作单位_In;
              If Sql%NotFound Then
                Insert Into 合作单位挂号汇总
                  (号码, 日期, 序号, 合作单位, 已约数, 已接数)
                Values
                  (号码_In, d_Date, n_号序, 合作单位_In, Decode(操作方式_In, 1, 0, 1), Decode(操作方式_In, 3, 1, 0));
              End If;
            End If;
          Exception
            When Others Then
              v_Err_Msg := '序号' || n_号序 || '已被使用,请重新选择一个序号.';
              Raise Err_Item;
          End;
        End If;
      Else
        If v_操作员姓名 <> v_序号操作员 Or v_机器名 <> v_序号机器名 Then
          v_Err_Msg := '序号' || n_号序 || '已被自助机' || v_机器名 || '锁定,请重新选择一个序号.';
          Raise Err_Item;
        Else
          Update 挂号序号状态
          Set 状态 = Decode(操作方式_In, 2, 2, 1), 预约 = Decode(操作方式_In, 1, 0, 1), 登记时间 = Sysdate
          Where 号码 = 号码_In And Trunc(日期) = Trunc(d_Date) And 序号 = n_号序 And 状态 = 5 And 操作员姓名 = v_操作员姓名 And 机器名 = v_机器名;
        End If;
      End If;
    End If;
  
    If n_出诊记录id Is Not Null Then
      Update 临床出诊序号控制
      Set 挂号状态 = Decode(操作方式_In, 2, 2, 1), 操作员姓名 = v_操作员姓名
      Where 记录id = n_出诊记录id And 序号 = n_序号;
      If 操作方式_In = 2 Then
        Update 临床出诊记录 Set 已约数 = 已约数 + 1 Where ID = n_出诊记录id;
      Else
        If 操作方式_In <> 1 Then
          Update 临床出诊记录
          Set 已约数 = 已约数 + 1, 已挂数 = 已挂数 + 1, 其中已接收 = 其中已接收 + 1
          Where ID = n_出诊记录id;
        Else
          Update 临床出诊记录 Set 已挂数 = 已挂数 + 1 Where ID = n_出诊记录id;
        End If;
      End If;
    End If;
  
    --锁定单据不产生任何 费用
    If 操作方式_In <> 2 And 锁定类型_In <> 1 Then
      --挂号,预约挂号已经扣款部分
      n_预交id := 预交id_In;
      If Nvl(n_预交id, 0) = 0 Then
        Select 病人预交记录_Id.Nextval Into n_预交id From Dual;
      End If;
      n_结算合计 := 0;
      If 保险结算_In Is Not Null Then
        --各个保险结算
        v_结算内容 := 保险结算_In || '||';
        n_结算合计 := 0;
        While v_结算内容 Is Not Null Loop
          v_当前结算 := Substr(v_结算内容, 1, Instr(v_结算内容, '||') - 1);
          v_结算方式 := Substr(v_当前结算, 1, Instr(v_当前结算, '|') - 1);
          n_结算金额 := To_Number(Substr(v_当前结算, Instr(v_当前结算, '|') + 1));
          If Nvl(n_结算金额, 0) <> 0 Then
            Insert Into 病人预交记录
              (ID, 记录性质, NO, 记录状态, 病人id, 摘要, 结算方式, 收款时间, 操作员编号, 操作员姓名, 冲预交, 结帐id, 缴款组id, 结算序号, 结算性质)
            Values
              (n_预交id, 4, 单据号_In, 1, Decode(病人id_In, 0, Null, 病人id_In), '保险结算', v_结算方式, d_登记时间, v_操作员编号, v_操作员姓名,
               n_结算金额, n_结帐id, n_组id, n_结帐id, 4);
            Select 病人预交记录_Id.Nextval Into n_预交id From Dual;
          End If;
          n_结算合计 := Nvl(n_结算合计, 0) + Nvl(n_结算金额, 0);
          v_结算内容 := Substr(v_结算内容, Instr(v_结算内容, '||') + 2);
        End Loop;
      End If;
    
      If Nvl(冲预交_In, 0) <> 0 Then
        --处理总预交
        n_结算合计 := n_结算合计 + Nvl(冲预交_In, 0);
        n_预交金额 := 冲预交_In;
        For r_Deposit In c_Deposit(病人id_In) Loop
          n_结算金额 := Case
                      When r_Deposit.金额 - n_预交金额 < 0 Then
                       r_Deposit.金额
                      Else
                       n_预交金额
                    End;
          If r_Deposit.结帐id = 0 Then
            --第一次冲预交(填上结帐ID,金额为0)
            Update 病人预交记录 Set 冲预交 = 0, 结帐id = n_结帐id, 结算性质 = 4 Where ID = r_Deposit.原预交id;
          End If;
          --冲上次剩余额
          Insert Into 病人预交记录
            (ID, NO, 实际票号, 记录性质, 记录状态, 病人id, 主页id, 预交类别, 科室id, 金额, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行, 单位帐号, 收款时间, 操作员姓名,
             操作员编号, 冲预交, 结帐id, 缴款组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, 结算序号, 结算性质)
            Select 病人预交记录_Id.Nextval, NO, 实际票号, 11, 记录状态, 病人id, 主页id, 预交类别, 科室id, Null, 结算方式, 结算号码, 摘要, 缴款单位, 单位开户行,
                   单位帐号, d_登记时间, v_操作员姓名, v_操作员编号, n_结算金额, n_结帐id, n_组id, 卡类别id, 结算卡序号, 卡号, 交易流水号, 交易说明, 合作单位, n_结帐id, 4
            From 病人预交记录
            Where NO = r_Deposit.No And 记录状态 = r_Deposit.记录状态 And 记录性质 In (1, 11) And Rownum = 1;
        
          --更新病人预交余额
          Update 病人余额
          Set 预交余额 = Nvl(预交余额, 0) - n_结算金额
          Where 病人id = 病人id_In And 性质 = 1 And 类型 = Nvl(1, 2)
          Returning 预交余额 Into n_返回值;
          If Sql%RowCount = 0 Then
            Insert Into 病人余额 (病人id, 预交余额, 性质, 类型) Values (病人id_In, -1 * n_结算金额, 1, 1);
            n_返回值 := -1 * n_结算金额;
          End If;
          If Nvl(n_返回值, 0) = 0 Then
            Delete From 病人余额
            Where 病人id = 病人id_In And 性质 = 1 And Nvl(费用余额, 0) = 0 And Nvl(预交余额, 0) = 0;
          End If;
        
          --检查是否已经处理完
          If r_Deposit.金额 <= n_结算金额 Then
            n_预交金额 := n_预交金额 - r_Deposit.金额;
          Else
            n_预交金额 := 0;
          End If;
          If n_预交金额 = 0 Then
            Exit;
          End If;
        End Loop;
        If n_预交金额 > 0 Then
          v_Err_Msg := '预交余额不够支付本次支付金额,不能继续操作！';
          Raise Err_Item;
        End If;
      End If;
      --剩余款项,用指定结算方支付
      n_结算金额 := Nvl(n_实收金额合计, 0) - Nvl(n_结算合计, 0);
      If Nvl(n_结算金额, 0) < 0 Then
        v_Err_Msg := '挂号的相关结算金额超出了当前实结金额,不能继续操作！';
        Raise Err_Item;
      End If;
      If Nvl(n_结算金额, 0) <> 0 Or (Nvl(n_结算金额, 0) = 0 And Nvl(冲预交_In, 0) = 0) Then
        If 结算方式_In Is Null Then
          v_Err_Msg := '未传入指定的结算方式,不能继续操作！';
          Raise Err_Item;
        End If;
      
        If Nvl(预交id_In, 0) <> 0 Then
          --传入的预交ID_In主要是为了解决三方交易,如果医保结算站用了该ID,需要用新的ID进行更新,三方交易用转入的ID
          Update 病人预交记录 Set ID = n_预交id Where ID = Nvl(预交id_In, 0);
          n_预交id := Nvl(预交id_In, 0);
        End If;
      
        Insert Into 病人预交记录
          (ID, 记录性质, 记录状态, NO, 病人id, 结算方式, 冲预交, 收款时间, 操作员编号, 操作员姓名, 结帐id, 摘要, 缴款组id, 交易流水号, 交易说明, 结算序号, 合作单位, 卡类别id, 卡号,
           结算性质)
        Values
          (n_预交id, 4, 1, 单据号_In, r_Pati.病人id, 结算方式_In, Nvl(n_结算金额, 0), d_登记时间, v_操作员编号, v_操作员姓名, n_结帐id,
           合作单位_In || '缴款', n_组id, 交易流水号_In, 交易说明_In, n_结帐id, 合作单位_In, 卡类别id_In, 支付卡号_In, 4);
      End If;
    
      --更新人员缴款数据
    
      For v_缴款 In (Select 结算方式, Sum(Nvl(a.冲预交, 0)) As 冲预交
                   From 病人预交记录 A
                   Where a.结帐id = n_结帐id And Mod(a.记录性质, 10) <> 1 And Nvl(病人id, 0) = Nvl(病人id_In, 0)
                   Group By 结算方式) Loop
      
        Update 人员缴款余额
        Set 余额 = Nvl(余额, 0) + Nvl(v_缴款.冲预交, 0)
        Where 收款员 = v_操作员姓名 And 性质 = 1 And 结算方式 = v_缴款.结算方式
        Returning 余额 Into n_返回值;
        If Sql%RowCount = 0 Then
          Insert Into 人员缴款余额
            (收款员, 结算方式, 性质, 余额)
          Values
            (v_操作员姓名, v_缴款.结算方式, 1, Nvl(v_缴款.冲预交, 0));
          n_返回值 := Nvl(v_缴款.冲预交, 0);
        End If;
        If Nvl(n_返回值, 0) = 0 Then
          Delete From 人员缴款余额
          Where 收款员 = v_操作员姓名 And 结算方式 = 结算方式_In And 性质 = 1 And Nvl(余额, 0) = 0;
        End If;
      
      End Loop;
    
    End If;
  
    --处理挂号记录
    If 锁定类型_In = 2 Then
      Begin
        Select ID Into n_挂号id From 病人挂号记录 Where　记录状态 = 0 And NO = 单据号_In And 病人id = 病人id_In;
      Exception
        When Others Then
          Null;
      End;
    Else
      Select 病人挂号记录_Id.Nextval Into n_挂号id From Dual;
    End If;
  
    Update 病人挂号记录
    Set 记录性质 = Decode(操作方式_In, 2, 2, 1), 记录状态 = Decode(锁定类型_In, 1, 0, 1), 门诊号 = r_Pati.门诊号, 操作员姓名 = v_操作员姓名,
        操作员编号 = v_操作员编号, 预约 = Decode(操作方式_In, 1, 0, 1),
        接收人 = Decode(锁定类型_In, 1, Null, Decode(操作方式_In, 2, Null, v_操作员姓名)),
        接收时间 = Case 锁定类型_In
                  When 1 Then
                   Null
                  Else
                   Case 操作方式_In
                     When 2 Then
                      Null
                     Else
                      d_登记时间
                   End
                End, 交易流水号 = Nvl(交易流水号_In, 交易流水号), 交易说明 = Nvl(交易说明_In, 交易说明), 合作单位 = Nvl(合作单位_In, 合作单位),
        预约操作员 = Decode(操作方式_In, 1, Nvl(预约操作员, Null), Nvl(预约操作员, v_操作员姓名)),
        预约操作员编号 = Decode(操作方式_In, 1, Nvl(预约操作员编号, Null), Nvl(预约操作员编号, v_操作员编号))
    Where ID = n_挂号id;
    If Sql%NotFound Then
      Begin
        Select 名称 Into v_付款方式 From 医疗付款方式 Where 编码 = r_Pati.付款方式 And Rownum < 2;
      Exception
        When Others Then
          v_付款方式 := Null;
      End;
      Insert Into 病人挂号记录
        (ID, NO, 记录性质, 记录状态, 病人id, 门诊号, 姓名, 性别, 年龄, 号别, 急诊, 诊室, 附加标志, 执行部门id, 执行人, 执行状态, 执行时间, 登记时间, 发生时间, 预约时间, 操作员编号,
         操作员姓名, 复诊, 号序, 预约, 接收人, 接收时间, 交易流水号, 交易说明, 合作单位, 医疗付款方式, 预约操作员, 预约操作员编号)
      Values
        (n_挂号id, 单据号_In, Decode(操作方式_In, 2, 2, 1), Decode(锁定类型_In, 1, 0, 1), r_Pati.病人id, r_Pati.门诊号, r_Pati.姓名,
         r_Pati.性别, r_Pati.年龄, 号码_In, 0, v_诊室, Null, r_安排.科室id, r_安排.医生姓名, 0, Null, d_登记时间, 发生时间_In,
         Case When(Nvl(操作方式_In, 0)) = 1 Then Null Else 发生时间_In End, v_操作员编号, v_操作员姓名, 0, n_号序, Decode(操作方式_In, 1, 0, 1),
         Decode(操作方式_In, 2, Null, v_操作员姓名), Decode(操作方式_In, 2, To_Date(Null), d_登记时间), 交易流水号_In, 交易说明_In, 合作单位_In,
         v_付款方式, Decode(操作方式_In, 1, Null, v_操作员姓名), Decode(操作方式_In, 1, Null, v_操作员编号));
    End If;
    --锁定单据不能产生队列
    If 锁定类型_In <> 1 Then
      n_预约生成队列 := 0;
      If 操作方式_In > 1 Then
        n_预约生成队列 := Zl_To_Number(zl_GetSysParameter('预约生成队列', 1113));
      End If;
      --挂号和收费的预约都直接进入队列(收费预约缺少接收过程,所以直接和挂号一样直接进入队列)
      If 操作方式_In <> 2 Or n_预约生成队列 = 1 Then
        If Zl_To_Number(zl_GetSysParameter('排队叫号模式', 1113)) <> 0 Then
          --排队叫号模式:-0-不产生队列;1-按医生或分诊台排队;2-先分诊,后医生站
          If Zl_To_Number(zl_GetSysParameter('分诊台签到排队', 1113)) = 0 Or n_预约生成队列 = 1 Then
            n_分时点显示 := Nvl(Zl_To_Number(zl_GetSysParameter(270)), 0);
            If Nvl(操作方式_In, 0) > 1 And n_分时点显示 = 1 And n_启用分时段 = 1 Then
              n_分时点显示 := 1;
            Else
              n_分时点显示 := Null;
            End If;
            --产生队列
            --.按”执行部门” 的方式生成队列
            v_队列名称 := r_安排.科室id;
            v_排队号码 := Zlgetnextqueue(r_安排.科室id, n_挂号id, 号码_In || '|' || 号序_In);
            --挂号id_In,号码_In,号序_In,缺省日期_In,扩展_In(暂无用)
            v_排队序号 := Zlgetsequencenum(0, n_挂号id, 0);
            --挂号id_In,号码_In,号序_In,缺省日期_In,扩展_In(暂无用)
            d_排队时间 := Zl_Get_Queuedate(n_挂号id, 号码_In, 号序_In, d_Date);
            --  队列名称_In , 业务类型_In, 业务id_In,科室id_In,排队号码_In,v_排队标记,患者姓名_In,病人ID_IN, 诊室_In, 医生姓名_In, 排队时间_In
            Zl_排队叫号队列_Insert(v_队列名称, 0, n_挂号id, r_安排.科室id, v_排队号码, Null, r_Pati.姓名, r_Pati.病人id, v_诊室, r_安排.医生姓名,
                             d_排队时间, 预约方式_In, n_分时点显示, v_排队序号);
          End If;
        End If;
      End If;
    
      If Nvl(操作方式_In, 0) = 1 Then
        --处理票据使用情况
        If 票据号_In Is Not Null Then
          Select 票据打印内容_Id.Nextval Into n_打印id From Dual;
          --发出票据
          Insert Into 票据打印内容 (ID, 数据性质, NO) Values (n_打印id, 4, 单据号_In);
          Insert Into 票据使用明细
            (ID, 票种, 号码, 性质, 原因, 领用id, 打印id, 使用时间, 使用人)
          Values
            (票据使用明细_Id.Nextval, Decode(收费票据_In, 1, 1, 4), 票据号_In, 1, 1, 领用id_In, n_打印id, d_登记时间, v_操作员姓名);
          --状态改动
          Update 票据领用记录
          Set 当前号码 = 票据号_In, 剩余数量 = Decode(Sign(剩余数量 - 1), -1, 0, 剩余数量 - 1), 使用时间 = Sysdate
          Where ID = Nvl(领用id_In, 0);
        End If;
        --病人本次就诊(以发生时间为准)
        If Nvl(r_Pati.病人id, 0) <> 0 Then
          Update 病人信息 Set 就诊时间 = 发生时间_In, 就诊状态 = 1, 就诊诊室 = v_诊室 Where 病人id = r_Pati.病人id;
        End If;
      End If;
    End If;
    --病人挂号汇总
    --解锁单据时不用再对汇总单据进行统计了 在锁定单据时已经进行了汇总
    If 锁定类型_In <> 2 Then
      --操作方式_IN:1-表示挂号,2-表示预约挂号不扣款,3-表示预约挂号,扣款
      --是否为预约接收:0-非预约挂号; 1-预约挂号,2-预约接收;3-收费预约
      n_预约 := Case
                When Nvl(操作方式_In, 0) = 1 Then
                 0
                When Nvl(操作方式_In, 0) = 2 Then
                 1
                When Nvl(操作方式_In, 0) = 3 Then
                 3
                Else
                 0
              End;
      Zl_病人挂号汇总_Update(r_安排.医生姓名, r_安排.医生id, r_安排.项目id, r_安排.科室id, 发生时间_In, n_预约, 号码_In);
    End If;
    --消息推送
    Begin
      Execute Immediate 'Begin ZL_服务窗消息_发送(:1,:2); End;'
        Using 1, n_挂号id;
    Exception
      When Others Then
        Null;
    End;
  End If;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]+' || v_Err_Msg || '+[ZLSOFT]');
  When Err_Special Then
    Raise_Application_Error(-20105, '[ZLSOFT]+' || v_Err_Msg || '+[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_三方机构挂号_Insert;
/

--114726:张德婷,2017-10-11,高值卫材取消执行时，不进行销帐操作
--113008:张德婷,2017-09-12,高值卫材取消执行时，不进行销帐操作
CREATE OR REPLACE Procedure Zl_材料收发记录_部门退料
(
  收发id_In   In 药品收发记录.Id%Type,
  审核人_In   In 药品收发记录.审核人%Type,
  审核日期_In In 药品收发记录.审核日期%Type,
  批号_In     In 药品库存.上次批号%Type := Null,
  效期_In     In 药品库存.效期%Type := Null,
  产地_In     In 药品库存.上次产地%Type := Null,
  退料数量_In In 药品收发记录.实际数量%Type := Null,
  自动销帐_In Integer := 0,
  退料人_In   In 药品收发记录.领用人%Type := Null,
  是否销帐_In IN integer:=1
) Is
  Err_Item Exception;
  v_Err_Msg Varchar2(100);
  v_No      药品收发记录.No%Type;

  n_记录状态   药品收发记录.记录状态%Type;
  n_执行状态   住院费用记录.执行状态%Type;
  n_部分退料   Number;
  n_入出类别id Number(18);
  n_单据       药品收发记录.单据%Type;
  n_库房id     药品收发记录.库房id%Type;
  n_药品id     药品收发记录.药品id%Type;
  n_实际数量   药品收发记录.实际数量%Type;
  n_实际金额   药品收发记录.零售金额%Type;
  n_实际成本   药品收发记录.成本金额%Type;
  n_实际差价   药品收发记录.差价%Type;
  n_费用id     药品收发记录.费用id%Type;
  n_零售价     药品收发记录.零售价%Type;
  n_实价卫材   收费项目目录.是否变价%Type;

  --处理退料时，分批核算性质改变后的处理
  n_新批次       药品收发记录.批次%Type;
  n_批次         药品收发记录.批次%Type;
  n_分批         材料特性.在用分批%Type;
  n_小数         Number(2);
  n_上次供应商id 药品库存.上次供应商id%Type;
  n_成本价       药品收发记录.成本价%Type;
  d_上次生产日期 药品库存.上次生产日期%Type;
  d_灭菌效期     药品库存.灭菌效期%Type;
  v_批准文号     药品库存.批准文号%Type;
  v_产地         药品收发记录.产地%Type;
  v_费用no       住院费用记录.No%Type;
  v_Temp         Varchar2(255);
  v_人员编号     人员表.编号%Type;
  v_人员姓名     人员表.姓名%Type;
  n_主页id       住院费用记录.主页id%Type;
  n_序号         住院费用记录.序号%Type;
  v_病人来源     病人医嘱记录.病人来源%Type;

  v_备货id     药品收发记录.Id%Type;
  v_入库no     药品收发记录.No%Type;
  v_入库序号   Number(5) := 0;
  v_执行时间   药品收发记录.审核日期%Type;
  n_平均成本价 药品库存.平均成本价%Type;
  n_冲销记录id 药品收发记录.Id%Type;
  n_移库       Number(1) := 0;
  v_商品条码   药品库存.商品条码%Type;
  v_内部条码   药品库存.内部条码%Type;
Begin
  v_Temp     := Zl_Identity;
  v_Temp     := Substr(v_Temp, Instr(v_Temp, ';') + 1);
  v_Temp     := Substr(v_Temp, Instr(v_Temp, ',') + 1);
  v_人员编号 := Substr(v_Temp, 1, Instr(v_Temp, ',') - 1);
  v_人员姓名 := Substr(v_Temp, Instr(v_Temp, ',') + 1);

  Select Zl_To_Number(Nvl(zl_GetSysParameter(9), '2')) Into n_小数 From Dual;

  If 退料数量_In Is Not Null Then
    If 退料数量_In = 0 Then
      Return;
    End If;
  End If;

  --1、判断当前数据是否是备货卫材
  Begin
    Select 汇总发药号
    Into v_备货id
    From 药品收发记录
    Where 单据 = 21 And 审核日期 Is Not Null And
          汇总发药号 =
          (Select Max(a.Id)
           From 药品收发记录 A, 药品收发记录 B
           Where a.单据 = b.单据 And a.No = b.No And a.序号 = b.序号 and a.审核人 is not null And b.Id = 收发id_In And (Mod(a.记录状态, 3) = 1 Or a.记录状态 = 1)) And
          Rownum = 1;
  Exception
    When Others Then
      v_备货id:=0;
  End;

  Begin
    if v_备货id=0 then
      Select 汇总发药号
      Into v_备货id
      From 药品收发记录
      Where 单据 = 21 And 审核日期 Is Not Null And
            汇总发药号 =
            (Select Max(a.Id)
             From 药品收发记录 A, 药品收发记录 B
             Where a.单据 = b.单据 And a.No = b.No And a.序号 = b.序号 and a.审核人 is not null And b.Id = 收发id_In And (Mod(a.记录状态, 3) = 0)) And
            Rownum = 1;
    end if;
  Exception
    When Others Then
      v_备货id:=0;
  End;

  --获取该收发记录的单据、药品ID、库房ID
  Select 单据, NO, 库房id, 药品id, 费用id, 入出类别id, 记录状态, Nvl(批次, 0), 生产日期, 灭菌效期, 批准文号, 供药单位id, 成本价, 产地, 零售价, 商品条码, 内部条码
  Into n_单据, v_No, n_库房id, n_药品id, n_费用id, n_入出类别id, n_记录状态, n_批次, d_上次生产日期, d_灭菌效期, v_批准文号, n_上次供应商id, n_成本价, v_产地,
       n_零售价, v_商品条码, v_内部条码
  From 药品收发记录
  Where ID = 收发id_In;

  --获取该笔记录剩余未退数量、金额及差价
  --尽量避免金额及差价未出完的现象
  Select Sum(Nvl(实际数量, 0) * Nvl(付数, 1)), Sum(Nvl(零售金额, 0)), Sum(Nvl(成本金额, 0)), Sum(Nvl(差价, 0))
  Into n_实际数量, n_实际金额, n_实际成本, n_实际差价
  From 药品收发记录
  Where 审核人 Is Not Null And NO = v_No And 单据 = n_单据 And 序号 = (Select 序号 From 药品收发记录 Where ID = 收发id_In);

  --如果允许退药数为零，表示已退药
  If n_实际数量 = 0 Then
    v_Err_Msg := '该单据已被其他操作员退料，请刷新后再试！';
    Raise Err_Item;
  End If;

  If Nvl(退料数量_In, 0) > n_实际数量 Then
    v_Err_Msg := '该单据已被其他操作员部分退料，请刷新后再试！';
    Raise Err_Item;
  End If;

  --获取该材料当前是否分批的信息
  Select Nvl(在用分批, 0) Into n_分批 From 材料特性 Where 材料id = n_药品id;

  --如果是部分退料，则重新计算零售金额及差价
  n_部分退料 := 0;
  If Not (退料数量_In Is Null Or Nvl(退料数量_In, 0) = n_实际数量) Then
    n_部分退料 := 1;
  End If;

  If n_部分退料 = 1 Then
    n_实际金额 := Round(n_实际金额 * 退料数量_In / n_实际数量, n_小数);
    n_实际成本 := Round(n_实际成本 * 退料数量_In / n_实际数量, n_小数);
    n_实际差价 := Round(n_实际差价 * 退料数量_In / n_实际数量, n_小数);
    n_实际数量 := 退料数量_In;
  End If;

  --n_分批:0-不分批;1-分批;2-原分批，现不分批，按不分批处理;3-原不分批，现分批，产生新批次
  If n_分批 = 0 And n_批次 <> 0 Then
    --原分批，现不分批，按不分批处理
    n_分批 := 2;
  Elsif n_分批 <> 0 And n_批次 = 0 Then
    --原不分批,现分批,产生新的批次，并在新产生的发药记录中使用
    n_分批 := 3;
  Else
    If n_批次 = 0 Then
      n_分批 := 0;
    Else
      n_分批 := 1;
    End If;
  End If;
  If 产地_In Is Not Null Then
    v_产地 := 产地_In;
  End If;
  --记录状态的含义有所变化
  --冲销的记录状态        :iif(n_记录状态=1,0,1)+1
  --被冲销的记录状态        :iif(n_记录状态=1,0,1)+2
  --等待发料的记录状态    :iif(n_记录状态=1,0,1)+3
  Select 药品收发记录_Id.Nextval Into n_冲销记录id From Dual;
  --产生冲销记录
  Insert Into 药品收发记录
    (ID, 记录状态, 单据, NO, 序号, 库房id, 对方部门id, 入出类别id, 入出系数, 药品id, 批次, 产地, 批号, 效期, 灭菌效期, 付数, 填写数量, 实际数量, 成本价, 成本金额, 扣率, 零售价,
     零售金额, 差价, 摘要, 填制人, 填制日期, 配药人, 审核人, 审核日期, 费用id, 单量, 频次, 用法, 发药窗口, 领用人, 供药单位id, 生产日期, 批准文号, 商品条码, 内部条码)
    Select n_冲销记录id, n_记录状态 + Decode(n_记录状态, 1, 0, 1) + 1, n_单据, v_No, 序号, 库房id, 对方部门id, 入出类别id, 入出系数, 药品id, 批次, 产地, 批号,
           效期, 灭菌效期, 1, -n_实际数量, -n_实际数量, 成本价, -n_实际成本, 扣率, 零售价, -n_实际金额, -n_实际差价, 摘要, 审核人_In, 审核日期_In, 配药人, 审核人_In,
           审核日期_In, 费用id, 单量, 频次, 用法, 发药窗口, 退料人_In, 供药单位id, 生产日期, 批准文号, 商品条码, 内部条码
    From 药品收发记录
    Where ID = 收发id_In;

  --如果是部分冲销，则付数填为1，实际数量为付数与实际数量的积
  --产生正常记录以供继续发料
  Select 药品收发记录_Id.Nextval Into n_新批次 From Dual;

  Insert Into 药品收发记录
    (ID, 记录状态, 单据, NO, 序号, 库房id, 对方部门id, 入出类别id, 入出系数, 药品id, 批次, 产地, 批号, 效期, 灭菌效期, 付数, 填写数量, 实际数量, 成本价, 成本金额, 扣率, 零售价,
     零售金额, 差价, 摘要, 填制人, 填制日期, 配药人, 审核人, 审核日期, 费用id, 单量, 频次, 用法, 发药窗口, 供药单位id, 生产日期, 批准文号, 商品条码, 内部条码)
    Select n_新批次, n_记录状态 + Decode(n_记录状态, 1, 0, 1) + 3, n_单据, v_No, 序号, 库房id, 对方部门id, 入出类别id, 入出系数, 药品id,
           Decode(n_分批, 1, 批次, 3, n_新批次, Null), Decode(n_分批, 3, 产地_In, 1, 产地, Null), Decode(n_分批, 3, 批号_In, 1, 批号, Null),
           Decode(n_分批, 3, 效期_In, 1, 效期, Null), 灭菌效期, 1, n_实际数量, n_实际数量, 成本价, n_实际成本, 扣率, 零售价, n_实际金额, n_实际差价, 摘要, 填制人,
           填制日期, Null, Null, Null, 费用id, 单量, 频次, 用法, 发药窗口, 供药单位id, 生产日期, 批准文号, 商品条码, 内部条码
    From 药品收发记录
    Where ID = 收发id_In;

  --更新病人费用记录的执行状态(0-未执行;1-完全执行;2-部分执行)
  Select Decode(Sum(Nvl(付数, 1) * 实际数量), Null, 0, 0, 0, 2)
  Into n_执行状态
  From 药品收发记录
  Where 单据 = n_单据 And NO = v_No And 费用id = n_费用id And 审核人 Is Not Null;

  If n_执行状态 = 0 Then
    Update 住院费用记录 Set 执行状态 = n_执行状态, 执行人 = Null, 执行时间 = Null Where ID = n_费用id;
    Update 门诊费用记录
    Set 执行状态 = n_执行状态, 执行人 = Null, 执行时间 = Null
    Where NO = v_No And
          序号 = (Select 序号 From 门诊费用记录 Where ID = (Select 费用id From 药品收发记录 Where ID = 收发id_In)) And
          (Mod(记录性质, 10) = 1 Or Mod(记录性质, 10) = 2) And 记录状态 <> 2 And 执行部门id = n_库房id;
  Else
    Update 住院费用记录 Set 执行状态 = n_执行状态 Where ID = n_费用id;
    Update 门诊费用记录
    Set 执行状态 = n_执行状态
    Where NO = v_No And
          序号 = (Select 序号 From 门诊费用记录 Where ID = (Select 费用id From 药品收发记录 Where ID = 收发id_In)) And
          (Mod(记录性质, 10) = 1 Or Mod(记录性质, 10) = 2) And 记录状态 <> 2 And 执行部门id = n_库房id;
  End If;

  --插入未发药品记录
  Begin
    Insert Into 未发药品记录
      (单据, NO, 病人id, 主页id, 姓名, 优先级, 对方部门id, 库房id, 发药窗口, 填制日期, 已收费, 配药人, 打印状态, 未发数)
      Select a.单据, a.No, a.病人id, a.主页id, a.姓名, Nvl(b.优先级, 0) 优先级, a.对方部门id, a.库房id, a.发药窗口, a.填制日期, a.已收费, Null, 1, 1
      From (Select b.单据, b.No, a.病人id, a.主页id, a.姓名, Decode(a.记录性质, 1, Decode(a.操作员姓名, Null, 0, 1), 1) 已收费, b.对方部门id,
                    b.库房id, b.发药窗口, b.填制日期, c.身份
             From 住院费用记录 A, 药品收发记录 B, 病人信息 C
             Where b.Id = 收发id_In And a.Id = b.费用id + 0 And a.病人id = c.病人id(+)
             Union All
             Select b.单据, b.No, a.病人id, Null As 主页id, a.姓名, Decode(a.记录性质, 1, Decode(a.操作员姓名, Null, 0, 1), 1) 已收费,
                    b.对方部门id, b.库房id, b.发药窗口, b.填制日期, c.身份
             From 门诊费用记录 A, 药品收发记录 B, 病人信息 C
             Where b.Id = 收发id_In And a.Id = b.费用id + 0 And a.病人id = c.病人id(+)) A, 身份 B
      Where b.名称(+) = a.身份;
  Exception
    When Others Then
      Null;
  End;

  --修改原记录为被冲销记录
  Update 药品收发记录 Set 记录状态 = n_记录状态 + Decode(n_记录状态, 1, 0, 1) + 2 Where ID = 收发id_In;

  --修改药品库存(反冲库存)
  Select 是否变价 Into n_实价卫材 From 收费项目目录 Where ID = n_药品id;

  If n_分批 <> 3 Then

    Update 药品库存
    Set 实际数量 = Nvl(实际数量, 0) + n_实际数量, 实际金额 = Nvl(实际金额, 0) + n_实际金额, 实际差价 = Nvl(实际差价, 0) + n_实际差价,
        零售价 = Decode(n_实价卫材, 1, Decode(Nvl(n_批次, 0), 0, Null, Decode(Nvl(零售价, 0), 0, n_零售价, 零售价)), Null)
    Where 库房id + 0 = n_库房id And 药品id = n_药品id And 性质 = 1 And Nvl(批次, 0) = n_批次;

    If Sql%RowCount = 0 Then
      Insert Into 药品库存
        (库房id, 药品id, 批次, 性质, 实际数量, 实际金额, 实际差价, 效期, 灭菌效期, 上次供应商id, 上次采购价, 上次批号, 上次生产日期, 上次产地, 批准文号, 零售价, 平均成本价, 商品条码,
         内部条码)
      Values
        (n_库房id, n_药品id, Decode(n_分批, 2, Null, n_批次), 1, n_实际数量, n_实际金额, n_实际差价, Decode(n_分批, 1, 效期_In, Null), d_灭菌效期,
         n_上次供应商id, n_成本价, Decode(n_分批, 1, 批号_In, Null), d_上次生产日期, v_产地, v_批准文号,
         Decode(n_实价卫材, 1, Decode(Nvl(n_批次, 0), 0, Null, n_零售价), Null), n_成本价, v_商品条码, v_内部条码);
    End If;
  Else
    Insert Into 药品库存
      (库房id, 药品id, 批次, 性质, 实际数量, 实际金额, 实际差价, 效期, 灭菌效期, 上次供应商id, 上次采购价, 上次批号, 上次生产日期, 上次产地, 批准文号, 零售价, 平均成本价, 商品条码, 内部条码)
    Values
      (n_库房id, n_药品id, n_新批次, 1, n_实际数量, n_实际金额, n_实际差价, 效期_In, d_灭菌效期, n_上次供应商id, n_成本价, 批号_In, d_上次生产日期, v_产地, v_批准文号,
       Decode(n_实价卫材, 1, Decode(Nvl(n_新批次, 0), 0, Null, n_零售价), Null), n_成本价, v_商品条码, v_内部条码);
  End If;

  Delete 药品库存
  Where 库房id + 0 = n_库房id And 药品id = n_药品id And 性质 = 1 And Nvl(可用数量, 0) = 0 And Nvl(实际数量, 0) = 0 And Nvl(实际金额, 0) = 0 And
        Nvl(实际差价, 0) = 0;

  If (自动销帐_In = 1 And n_单据 <> 24) or (v_备货id>1 And n_单据 <> 24 and not (退料数量_In  is null) and 是否销帐_In=1 ) Then
    Begin
      Select 主页id, NO, 序号 Into n_主页id, v_费用no, n_序号 From 住院费用记录 Where ID = n_费用id;
    Exception
      When Others Then
        Begin
          Select Null, NO, 序号 Into n_主页id, v_费用no, n_序号 From 门诊费用记录 Where ID = n_费用id;
        Exception
          When Others Then
            n_主页id := Null;
        End;
    End;
    If n_主页id Is Null Then
      Zl_门诊记帐记录_Delete(v_费用no, n_序号, v_人员编号, v_人员姓名);
    Else
      Zl_住院记帐记录_Delete(v_费用no, n_序号, v_人员编号, v_人员姓名);
    End If;
  End If;

  if not (退料数量_In  is null) then
  --备货卫材处理
    If v_备货id > 0 Then
      --2、自动冲销已审核的其他出库单据
      Begin
        Select 1
        Into n_移库
        From 药品收发记录
        Where 单据 = 15 And 审核日期 Is Null And
              费用id In (Select Distinct 费用id From 药品收发记录 Where NO = v_No And 药品id = n_药品id And 批次 = n_批次);
      Exception
        When Others Then
          n_移库 := 0;
      End;

      If n_移库 <> 0 Then
        For v_出库冲销 In (Select 1 行次, 记录状态, NO, 序号, 药品id
                       From 药品收发记录
                       Where 单据 = 21 And 审核日期 Is Not Null And 汇总发药号 = v_备货id) Loop
            Zl_材料其他出库_Strike(v_出库冲销.行次, v_出库冲销.记录状态, v_出库冲销.No, v_出库冲销.序号, v_出库冲销.药品id, 退料数量_In, 审核人_In, 审核日期_In);
        End Loop;

        --3、删除未审核的外购入库单据（已审核则不管）
        if n_部分退料=1 then
          update 药品收发记录 set 填写数量=填写数量-退料数量_In,实际数量=实际数量-退料数量_In,零售金额=零售金额-n_实际金额,成本金额=成本金额-n_实际成本,差价=差价-n_实际差价
          Where 单据 = 15 And 药品id = n_药品id And Nvl(批次, 0) = n_批次 And 费用id = n_费用id And 审核日期 Is Null;
        else
          Delete 药品收发记录
          Where 单据 = 15 And 药品id = n_药品id And Nvl(批次, 0) = n_批次 And 费用id = n_费用id And 审核日期 Is Null;
        end if;
      End If;
    End If;
  else
    --备货卫材处理
    If v_备货id > 0 Then
      --2、自动冲销已审核的其他出库单据
      Begin
        Select 1
        Into n_移库
        From 药品收发记录
        Where 单据 = 15 And 审核日期 Is Null And
              费用id In (Select Distinct 费用id From 药品收发记录 Where NO = v_No And 药品id = n_药品id And 批次 = n_批次);
      Exception
        When Others Then
          n_移库 := 0;
      End;

      If n_移库 <> 0 Then
        For v_出库冲销 In (Select 1 行次, 记录状态, NO, 序号, 药品id
                       From 药品收发记录
                       Where 单据 = 21 And 审核日期 Is Not Null And 汇总发药号 = v_备货id) Loop
          Zl_材料其他出库_Strike(v_出库冲销.行次, v_出库冲销.记录状态, v_出库冲销.No, v_出库冲销.序号, v_出库冲销.药品id, 退料数量_In, 审核人_In, 审核日期_In, 1);
        End Loop;

        --3、产生新的其他出库单据
        If v_入库no Is Null Then
          v_入库no := Nextno(74, n_库房id);
        End If;
        v_入库序号 := v_入库序号 + 1;

        For v_入库 In (Select 入出类别id, 库房id, 药品id, 批次, 填写数量, 成本价, 成本金额, 零售价, 零售金额, 差价, 产地, 批号, 效期, 灭菌效期, 摘要, 单量, 发药窗口
                     From 药品收发记录
                     Where 单据 = 21 And 审核日期 Is Not Null And 汇总发药号 = v_备货id) Loop

          Zl_材料其他出库_Insert(v_入库.入出类别id, v_入库no, v_入库序号, v_入库.库房id, v_入库.药品id, v_入库.批次, v_入库.填写数量, v_入库.成本价, v_入库.成本金额,
                           v_入库.零售价, v_入库.零售金额, v_入库.差价, 审核人_In, 审核日期_In, v_入库.产地, v_入库.批号, v_入库.效期, v_入库.灭菌效期, v_入库.摘要,
                           v_入库.单量, v_入库.发药窗口);

          Update 药品收发记录
          Set 费用id = n_费用id, 汇总发药号 = n_新批次
          Where 单据 = 21 And NO = v_入库no And 序号 = v_入库序号;
        End Loop;

        --4、删除未审核的外购入库单据（已审核则不管）
        Delete 药品收发记录
        Where 单据 = 15 And 药品id = n_药品id And Nvl(批次, 0) = n_批次 And 费用id = n_费用id And 审核日期 Is Null;
      End If;
    end if;
  end if;
  --处理调价修正单据
  Zl_材料收发记录_调价修正(n_冲销记录id);
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_材料收发记录_部门退料;
/

--113078:陈刘,2017-08-24,增加骑线体温

CREATE OR REPLACE Procedure Zl_体温单数据_Update
(
  文件id_In   In 病人护理文件.Id%Type, --病人护理文件ID 
  发生时间_In In 病人护理数据.发生时间%Type, --护理数据的发生时间 
  记录类型_In In 病人护理明细.记录类型%Type, --护理项目=1，上标说明=2，入出转标记=3，手术日标记=4,下标说明=6 
  项目序号_In In 病人护理明细.项目序号%Type, --护理项目的序号，非护理项目固定为0 
  记录内容_In In 病人护理明细.记录内容%Type := Null, --记录内容，如果内容为空，即清除以前的内容  36或36/37 
  体温部位_In In 病人护理明细.体温部位%Type := Null, --删除数据时不用填写部位 除活动项目外 
  复试合格_In In Number := 0,
  未记说明_In In 病人护理明细.未记说明%Type := Null, --未记说明 
  他人记录_In In Number := 1,
  数据来源_In In 病人护理明细.数据来源%Type := 0,
  来源id_In   In 病人护理明细.来源id%Type := Null, --始终为原始记录的来源ID 
  共用_In     In 病人护理明细.共用%Type := 0,
  项目首次_In In Number := 0, --汇总项目使用，保存数据前是否先删除一段时间内的数据信息。 1 删除 
  开始时间_In In 病人护理数据.发生时间%Type := Null, --本记录有效跨度的开始时间 
  结束时间_In In 病人护理数据.发生时间%Type := Null, --本记录有效跨度的终止时间，单独记录为每分钟，体温表为4小时,时间跨度内的相同项目记录要删除 
  
  操作员_In   In 病人护理数据.保存人%Type := Null,
  检查科室_In In Number := 1
) Is
  n_项目序号 病人护理明细.项目序号%Type;
  n_记录标记 病人护理明细.记录标记%Type; --记录内容的特殊标志 
  v_保存人   病人护理数据.保存人%Type;
  v_记录人   病人护理明细.记录人%Type;
  d_结束时间 病人护理数据.发生时间%Type;
  d_发生时间 病人护理数据.发生时间%Type;
  d_开始时间 病人护理数据.发生时间%Type;
  n_记录id   病人护理明细.记录id%Type;
  v_科室id   病人护理文件.科室id%Type;
  n_心率应用 护理记录项目.应用方式%Type;
  n_脉搏     护理记录项目.项目序号%Type := 2;
  n_体温     护理记录项目.项目序号%Type := 1;
  n_心率     护理记录项目.项目序号%Type := -1;
  n_项目性质 护理记录项目.项目性质%Type := 1;
  n_开始版本 病人护理明细.开始版本%Type;
  n_疼痛强度 护理记录项目.项目序号%Type;

  n_病人id       病人护理文件.病人id%Type;
  n_主页id       病人护理文件.主页id%Type;
  n_婴儿         病人护理文件.婴儿%Type;
  d_婴儿出院时间 病人医嘱记录.开始执行时间%Type;
  d_文件开始时间 病人护理文件.开始时间%Type;
  n_Preblue      Number;
  n_i            Number;
  n_Sqlrowcount  Number;
  v_记录内容     病人护理明细.记录内容%Type;
  v_Data         病人护理明细.记录内容%Type;
  --主过程 
  v_Error Varchar2(255);
  Err_Custom Exception;
Begin
  d_发生时间 := 发生时间_In;

  If d_发生时间 Is Null Then
    v_Error := '数据发生时间不能为空！';
    Raise Err_Custom;
  End If;

  If 开始时间_In Is Null Then
    d_开始时间 := d_发生时间;
  Else
    d_开始时间 := 开始时间_In;
  End If;

  If 结束时间_In Is Null Then
    d_结束时间 := d_开始时间;
  Else
    d_结束时间 := 结束时间_In;
  End If;

  --提取记录ID 
  n_记录id := 0;
  If 操作员_In Is Null Then
    v_保存人 := Zl_Username;
  Else
    v_保存人 := 操作员_In;
  End If;
  ---------------------------------------------------------------------------------------------------------------------- 
  Begin
    Select ID Into n_记录id From 病人护理数据 Where 文件id = 文件id_In And 发生时间 = 发生时间_In;
  Exception
    When Others Then
      n_记录id := 0;
  End;

  --检查数据的发生时间是否对应科室 
  --------------------------------------------------------------------------------------------------------------------- 
  Select 病人id, 主页id, Nvl(婴儿, 0), 开始时间
  Into n_病人id, n_主页id, n_婴儿, d_文件开始时间
  From 病人护理文件
  Where ID = 文件id_In;
  d_婴儿出院时间 := Null;
  If n_婴儿 <> 0 Then
    Begin
      Select 开始执行时间
      Into d_婴儿出院时间
      From 病人医嘱记录 B, 诊疗项目目录 C
      Where b.诊疗项目id + 0 = c.Id And b.医嘱状态 = 8 And Nvl(b.婴儿, 0) <> 0 And c.类别 = 'Z' And
            Instr(',3,5,11,', ',' || c.操作类型 || ',', 1) > 0 And b.病人id = n_病人id And b.主页id = n_主页id And b.婴儿 = n_婴儿;
    Exception
      When Others Then
        d_婴儿出院时间 := Null;
    End;
  End If;
  If d_婴儿出院时间 Is Null Then
    v_科室id := 0;
    Begin
      Select a.科室id
      Into v_科室id
      From 病人变动记录 A, 病人护理文件 B
      Where a.科室id Is Not Null And a.病人id = b.病人id And a.主页id = b.主页id And b.Id = 文件id_In And
            (发生时间_In >= a.开始时间 And (发生时间_In < = Nvl(a.终止时间, Sysdate) Or a.终止时间 Is Null)) And Rownum < 2;
    Exception
      When Others Then
        v_科室id := 0;
    End;
    If v_科室id = 0 And 检查科室_In = 1 Then
      v_Error := '数据发生时间 ' || To_Char(发生时间_In, 'YYYY-MM-DD HH24:MI:SS') || ' 不在病人有效变动时间范围内，不能操作！';
      Raise Err_Custom;
    End If;
  Else
    If 发生时间_In < d_文件开始时间 Or 发生时间_In > d_婴儿出院时间 Then
      v_Error := '数据发生时间 ' || To_Char(发生时间_In, 'YYYY-MM-DD HH24:MI:SS') || ' 不在病人有效变动时间范围内，不能操作！';
      Raise Err_Custom;
    End If;
  End If;
  --检查是不是本人的记录 
  --------------------------------------------------------------------------------------------------------------------- 
  If 他人记录_In = 0 And n_记录id > 0 Then
    v_记录人 := '';
    Begin
      Select 记录人
      Into v_记录人
      From 病人护理明细
      Where 记录id = n_记录id And 记录类型 = 记录类型_In And 项目序号 = 项目序号_In And 终止版本 Is Null And Rownum < 2
      Order By Nvl(记录标记, 0);
    Exception
      When Others Then
        v_记录人 := '';
    End;
    If v_记录人 Is Not Null And v_记录人 <> v_保存人 Then
      v_Error := '在' || To_Char(d_开始时间, 'yyyy-mm-dd hh24:mi:ss') || '至' || To_Char(d_结束时间, 'yyyy-mm-dd hh24:mi:ss') ||
                 '段内记录人不是当前人，你无权修改！';
      Raise Err_Custom;
    End If;
  End If;

  --提取疼痛强度曲线项目的项目序号 
  Begin
    Select 项目序号 Into n_疼痛强度 From 体温记录项目 Where 记录名 = '疼痛强度';
  Exception
    When Others Then
      n_疼痛强度 := -999;
  End;
  --检查脉搏心率是否共用 
  If 项目序号_In = n_脉搏 Then
    n_项目序号 := n_心率;
  Else
    n_项目序号 := 项目序号_In;
  End If;
  Begin
    Select 应用方式, 项目性质 Into n_心率应用, n_项目性质 From 护理记录项目 Where 项目序号 = n_项目序号;
  Exception
    When Others Then
      n_心率应用 := 0;
  End;

  ----清除某段时间内的护理数据信息 
  --项目首次_In 汇总项目根据汇总时间段保存一天数据时先清除在保存 项目首次_In：=1 
  --记录内容_In Is Null And 未记说明_In Is Null 则认为删除数据 
  --------------------------------------------------------------------------------------------------------------------- 
  If (项目首次_In = 1) Or (记录内容_In Is Null And 未记说明_In Is Null) Then
    For r_List In (Select l.Id, Count(*) As 记录数, Min(l.发生时间) 发生时间
                   From 病人护理文件 A, 病人护理数据 L, 病人护理明细 D
                   Where a.Id = l.文件id And l.Id = d.记录id And a.Id = 文件id_In And d.终止版本 Is Null And l.发生时间 >= d_开始时间 And
                         l.发生时间 <= d_结束时间
                   Group By l.Id) Loop
      n_Sqlrowcount := 0;
      If 记录类型_In = 2 Or 记录类型_In = 6 Then
        Delete 病人护理明细
        Where 记录id = r_List.Id And 记录类型 = 记录类型_In And 项目序号 = 项目序号_In And 终止版本 Is Null;
        n_Sqlrowcount := Sql%RowCount;
      Else
        If 体温部位_In Is Not Null Then
          --此处主要针对活动项目 
          Delete 病人护理明细
          Where 记录id = r_List.Id And 记录类型 = 记录类型_In And 项目序号 = 项目序号_In And Nvl(体温部位, '无') = Nvl(体温部位_In, '无') And
                终止版本 Is Null;
        Else
          Delete 病人护理明细
          Where 记录id = r_List.Id And 记录类型 = 记录类型_In And 项目序号 = 项目序号_In And 终止版本 Is Null;
        End If;
      
        n_Sqlrowcount := Sql%RowCount;
        --如果脉搏和心率共用删除脉搏是同时删除心率数据 
        If 项目序号_In = n_脉搏 And n_心率应用 = 2 Then
          Delete 病人护理明细
          Where 记录id = r_List.Id And 记录类型 = 记录类型_In And 项目序号 = n_心率 And 终止版本 Is Null;
          n_Sqlrowcount := n_Sqlrowcount + Sql%RowCount;
        End If;
        --如果为收缩压/舒张压删除收缩压时同时删除舒张压数据 
        If 项目序号_In = 4 Then
          Delete 病人护理明细
          Where 记录id = r_List.Id And 记录类型 = 记录类型_In And 项目序号 = 5 And 终止版本 Is Null;
          n_Sqlrowcount := n_Sqlrowcount + Sql%RowCount;
        End If;
      End If;
      If n_Sqlrowcount >= r_List.记录数 Then
        Delete 病人护理数据 Where ID = r_List.Id;
      End If;
      --更新打印 
      Update 体温单打印
      Set 打印人 = Null, 打印时间 = Null
      Where 文件id = 文件id_In And
            开始时间 = (Select Max(开始时间) From 体温单打印 Where 文件id = 文件id_In And 开始时间 <= r_List.发生时间);
    End Loop;
  End If;

  If 记录内容_In Is Null And 未记说明_In Is Null Then
    Return;
  End If;

  --分解项目记录内容 
  n_Preblue := 0;
  If (记录类型_In = 1 or 记录类型_In = 7)  And Instr(',' || n_疼痛强度 || ',1,2,4,', ',' || 项目序号_In || ',', 1) > 0 Then
    n_Preblue := Nvl(Instr(Nvl(记录内容_In, ''), '/', 1), 0);
    If n_Preblue > 1 Then
      n_Preblue := 1;
    End If;
  End If;

  If 项目序号_In = 4 And n_Preblue = 0 Then
    v_Error := '血压数据格式错误! 格式:收缩压/舒张压。';
    Raise Err_Custom;
  End If;

  --确认开始版本号 
  --------------------------------------------------------------------------------------------------------------------- 
  n_开始版本 := 1;

  --改写病人护理数据：如果已经存在与病人、科室和发生时间相同的记录则修改，否则增加新的记录 
  --------------------------------------------------------------------------------------------------------------------- 
  --汇总项目是删除后在增加，可能开始提取的记录ID已经不存在。 
  Begin
    Select ID Into n_记录id From 病人护理数据 Where ID = n_记录id;
  Exception
    When Others Then
      n_记录id := 0;
  End;

  If n_记录id = 0 Then
    Select 病人护理数据_Id.Nextval Into n_记录id From Dual;
    Insert Into 病人护理数据
      (ID, 文件id, 显示, 发生时间, 保存人, 保存时间, 最后版本)
    Values
      (n_记录id, 文件id_In, 0, d_发生时间, v_保存人, Sysdate, n_开始版本);
  End If;

  --检查删除物理降温数据或脉搏短轴数据 
  If (项目序号_In = n_体温 Or 项目序号_In = n_疼痛强度 Or (项目序号_In = n_脉搏 And n_心率应用 = 2)) And n_Preblue = 0 Then
    Delete From 病人护理明细
    Where 记录id = n_记录id And 项目序号 = Decode(项目序号_In, n_脉搏, n_心率, 项目序号_In) And Decode(项目序号_In, n_脉搏, 1, Nvl(记录标记, 0)) = 1 And
          记录类型 = 记录类型_In And 终止版本 Is Null;
  End If;

  --改写病人护理明细：如果已经存在与病人、科室和发生时间相同的记录则修改，否则增加新的记录 
  ----------------------------------------------------------------------------------------------------------------------- 
  v_Data     := 记录内容_In;
  n_项目序号 := 项目序号_In;
  For n_i In 0 .. n_Preblue Loop
    If n_i = 0 Then
      If 项目序号_In = n_心率 Then
        n_记录标记 := 1;
      Else
        n_记录标记 := 0;
      End If;
    Else
      --收缩压/舒张压 
      If 项目序号_In = 4 Then
        n_记录标记 := 0;
        n_项目序号 := 5;
      Else
        n_记录标记 := 1;
        If 项目序号_In = n_脉搏 Then
          n_项目序号 := n_心率;
        End If;
      End If;
    
    End If;
    If n_Preblue > 0 Then
      v_记录内容 := Substr(v_Data, 1, Instr(v_Data, '/', 1) - 1);
      If v_记录内容 Is Null Then
        v_记录内容 := v_Data;
      End If;
    Else
      v_记录内容 := v_Data;
    End If;
  
    --为了兼容以前同步过来的心率数据记录标记为0 
    If n_i = 0 Then
      Update 病人护理明细
      Set 记录内容 = v_记录内容, 体温部位 = 体温部位_In, 复试合格 = 复试合格_In,
          未记说明 = Decode(n_项目序号, n_体温, Decode(v_记录内容, '不升', Null, 未记说明_In), 未记说明_In), 记录人 = v_保存人, 记录时间 = Sysdate
      Where 记录id = n_记录id And 项目序号 = n_项目序号 And 记录类型 = 记录类型_In And
            Decode(项目序号_In, n_体温, Nvl(记录标记, 0), n_疼痛强度, Nvl(记录标记, 0), Nvl(n_记录标记, 0)) = Nvl(n_记录标记, 0) And
            Decode(n_项目性质, 2, Nvl(体温部位, '无'), Nvl(体温部位_In, '无')) = Nvl(体温部位_In, '无') And 终止版本 Is Null;
    Else
      Update 病人护理明细
      Set 记录内容 = v_记录内容, 记录人 = v_保存人, 记录时间 = Sysdate
      Where 记录id = n_记录id And 项目序号 = n_项目序号 And 记录类型 = 记录类型_In And
            Decode(项目序号_In, n_体温, Nvl(记录标记, 0), n_疼痛强度, Nvl(记录标记, 0), Nvl(n_记录标记, 0)) = Nvl(n_记录标记, 0) And 终止版本 Is Null;
    End If;
    If Sql%RowCount = 0 Then
      --插入本次登记的病人护理内容 
      If Mod(记录类型_In, 10) = 1 Or 记录类型_In = 7 Then
        Insert Into 病人护理明细
          (ID, 记录id, 记录类型, 项目分组, 项目id, 项目序号, 项目名称, 项目类型, 记录内容, 项目单位, 记录标记, 记录人, 体温部位, 复试合格, 开始版本, 终止版本, 记录组号, 未记说明,
           记录时间, 数据来源, 显示, 来源id, 共用)
          Select 病人护理明细_Id.Nextval, n_记录id, 记录类型_In, 分组名, 项目id, 项目序号, 项目名称, 项目类型, v_记录内容, 项目单位, n_记录标记, v_保存人, 体温部位_In,
                 复试合格_In, n_开始版本, Null, Null, Decode(n_项目序号, n_体温, Decode(v_记录内容, '不升', Null, 未记说明_In), 未记说明_In),
                 Sysdate, 数据来源_In, 0, 来源id_In, 共用_In
          From 护理记录项目
          Where 项目序号 = n_项目序号;
      Else
        Insert Into 病人护理明细
          (ID, 记录id, 记录类型, 项目分组, 项目id, 项目序号, 项目名称, 项目类型, 记录内容, 项目单位, 记录标记, 记录人, 体温部位, 复试合格, 开始版本, 终止版本, 记录组号, 未记说明,
           记录时间, 数据来源, 显示, 来源id, 共用)
        Values
          (病人护理明细_Id.Nextval, n_记录id, 记录类型_In, Null, Null, 0,
           Decode(记录类型_In, 2, '上标说明', 6, '下标说明', 3, '入出转', 4, v_记录内容), Decode(记录类型_In, 3, 0, 1),
           Decode(记录类型_In, 4, '1', 记录内容_In), '', n_记录标记, v_保存人, 体温部位_In, 复试合格_In, n_开始版本, Null, Null, 未记说明_In, Sysdate,
           数据来源_In, 0, 来源id_In, 共用_In);
      End If;
    End If;
    If n_Preblue > 0 Then
      v_Data := Substr(v_Data, Instr(v_Data, '/', 1) + 1);
    End If;
  End Loop;
  --更新打印 
  Update 体温单打印
  Set 打印人 = Null, 打印时间 = Null
  Where 文件id = 文件id_In And
        开始时间 = (Select Max(开始时间) From 体温单打印 Where 文件id = 文件id_In And 开始时间 <= d_发生时间);
Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_体温单数据_Update;
/

--113176:张德婷,2017-08-24,修正因为优先级是字符型，没有正确排批的问题
CREATE OR REPLACE Procedure Zl_输液配药记录_自动排批
(
 病人id_In In number,
 科室id_In In number,
 部门id_In In number,
 执行日期_In in date
) Is
v_批次串 varchar2(500);
n_总量 number(5);
v_配药id  varchar2(500);
v_batch varchar2(20);
v_Fields varchar2(100);
v_Tansid varchar(18);
n_科室id number(18);
v_批次   varchar2(10);
v_Id     varchar2(200);
n_自动排批模式  number(1);
n_打包    number(2);
v_配药类型  Varchar2(20);
v_历史批次  Varchar2(20);
Begin
  n_自动排批模式:=Zl_To_Number(Nvl(zl_GetSysParameter('自动排批时输液单的批次只往后面批次变动', 1345), 0));
  --该科室各个批次对应的容量
  select max(批次) into v_批次 from 配药工作批次 where 配置中心id=部门id_In and 药品类型 is  null;
  for R_Batch in (select B.批次 配药批次,A.容量,A.科室id from 科室容量设置 A,配药工作批次 B where A.配置中心ID=B.配置中心ID And A.配药批次=(B.批次 || '#') and (A.科室id=科室id_In or A.科室ID=0) and A.配置中心id=部门id_In order by A.科室id desc, A.配药批次 asc) loop

    n_科室id:=R_Batch.科室id;

  --该病人按批次排序，执行时间，优先级排序,各个批次现有的容量，优先级在产生输液配药记录的时候写入
    n_总量:=0;
    for r_item in (Select a.Id 配药id, d.单量,A.瓶签号,A.配药批次
    From 输液配药记录 A, 病人医嘱记录 B, 输液配药内容 C, 药品收发记录 D, 药品规格 E, 药品特性 F,配药工作批次 G
    Where a.Id = c.记录id And c.收发id = d.Id And d.药品id = e.药品id And e.药名id = f.药名id And a.部门id = 部门id_In and G.配置中心ID=a.部门id And
          a.医嘱id = b.Id And b.病人id = 病人id_In And A.配药批次=G.批次 And G.批次<>0 and G.药品类型 is null And f.溶媒 = 1 And a.执行时间 Between Trunc(执行日期_In ) And
          Trunc(执行日期_In+1) - 1 / 24 / 60 / 60 And A.操作状态<2 and A.配药批次<=decode(n_自动排批模式,1,R_Batch.配药批次,100)
    Order By a.配药批次,to_number(a.优先级), a.执行时间, d.单量 desc) loop

      if instr(','|| v_配药id,','|| r_item.配药id || ',',1)<1 then
        --当该配药id首次循环的时候对其单量进行累计
        v_配药id:=v_配药id || r_item.配药id || ',';
        n_总量:=n_总量+r_item.单量;
        v_批次串:=v_批次串 || r_item.配药id || ',' || R_Batch.配药批次 || '|';
      elsif instr('|'|| v_批次串,'|'|| r_item.配药id || ',' || R_Batch.配药批次 || '|',1)>0 and n_总量<>0 then
        --当该配药id及批次出现过，则累计该单量
        n_总量:=n_总量+r_item.单量;
      end if;

      if n_总量>=R_Batch.容量 then
        exit;
      end if;

    end loop;
  end loop;

  --如果该科室设置了单独的容量信息则不考虑所有科室的模式
  for r_item in (Select a.Id 配药id, d.单量,A.瓶签号
  From 输液配药记录 A, 病人医嘱记录 B, 输液配药内容 C, 药品收发记录 D, 药品规格 E, 药品特性 F,配药工作批次 G
  Where a.Id = c.记录id And c.收发id = d.Id And d.药品id = e.药品id And e.药名id = f.药名id And a.部门id = 部门id_In  And
        a.医嘱id = b.Id And b.病人id = 病人id_In And A.配药批次=G.批次 And G.批次<>0 and G.配置中心ID=a.部门id and G.药品类型 is null And f.溶媒 = 1  
        And A.操作状态<2 And a.执行时间 Between Trunc(执行日期_In) And Trunc(执行日期_In+1) - 1 / 24 / 60 / 60
  Order By a.配药批次,to_number(a.优先级),a.执行时间, d.单量) loop
    if instr(','|| v_配药id,','|| r_item.配药id || ',',1)<1then
      --没有进行自动分批的输液单直接在最后一个批次
      v_配药id:=v_配药id || r_item.配药id || ',';
      v_批次串:=v_批次串 || r_item.配药id || ',' || v_批次 || '|';
    end if;
  end loop;


  --根据自动调批修正数据
  while v_批次串 is not null loop
    --分解单据ID串
    v_Fields := Substr(v_批次串, 1, Instr(v_批次串, '|') - 1);
    v_Tansid := Substr(v_Fields, 1, Instr(v_Fields, ',') - 1);
    v_batch   := Substr(v_Fields, Instr(v_Fields, ',') + 1);


    v_批次串 := Replace('|' || v_批次串, '|' || v_Fields || '|');

    Select Nvl(max(打包), 0),max(药品类型) Into n_打包,v_配药类型 From 配药工作批次 Where 批次 = v_batch And 配置中心id=部门id_In;

    Select 配药批次 Into v_历史批次 From 输液配药记录 Where id=v_Tansid;
    update 输液配药记录 set 配药批次=v_batch,是否确认调整=0 where id=v_Tansid;

    Update 输液配药记录 Set 是否确认调整 = 0
    Where 医嘱id In (Select ID From 病人医嘱记录 Where 病人id = 病人id_In)
    And 执行时间 Between Trunc(执行日期_In) And Trunc(执行日期_In + 1) - 1 / 24 / 60 / 60 And 操作状态 < 2;

    If n_打包<>0 And v_配药类型 is Null Then
      update 输液配药记录 Set 是否打包=n_打包 where id=v_Tansid;
    Else
      Select Nvl(max(打包), 0) Into n_打包 From 配药工作批次 Where 批次 = v_历史批次 And 配置中心id=部门id_In;
      If n_打包<>0 Then
        Update 输液配药记录 Set 是否打包=0 where id=v_Tansid And trunc(执行时间)>trunc(Sysdate) ;
      End If;
    End If;
  end loop;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_输液配药记录_自动排批;
/

--112862:冉俊明,2017-08-21,支持门诊费用转住院预交票据多单据一次性打印
Create Or Replace Procedure Zl_病人预交记录_Reprint
(
  单据号_In Varchar2,
  票据号_In 票据使用明细.号码%Type,
  领用id_In 票据使用明细.领用id%Type,
  使用人_In 票据使用明细.使用人%Type
) As
  --单据号_In 可能为多张，格式：A001,A002,A003,...
  --       门诊费用转住院时可能会有多张预交单据一起打印
  v_收回id 票据打印内容.Id%Type;
  v_打印id 票据打印内容.Id%Type;

  v_Date  Date;
  v_Error Varchar2(255);
  Err_Custom Exception;
Begin
  Select Sysdate Into v_Date From Dual;
  Begin
    --多张单据时，上一次的打印ID肯定一样
    Select ID
    Into v_收回id
    From (Select b.Id
           From 票据使用明细 A, 票据打印内容 B
           Where a.打印id = b.Id And a.性质 = 1 And b.数据性质 = 2 And
                 b.No In (Select /*+Cardinality(A,10)*/
                           a.Column_Value
                          From Table(f_Str2list(单据号_In)) A)
           Order By a.使用时间 Desc)
    Where Rownum < 2;
  Exception
    When Others Then
      v_收回id := Null;
  End;

  --重打收回(可能以前没有使用票据,无法收回) 
  If v_收回id Is Not Null Then
    Insert Into 票据使用明细
      (ID, 票种, 号码, 性质, 原因, 领用id, 打印id, 使用时间, 使用人)
      Select 票据使用明细_Id.Nextval, 票种, 号码, 2, 4, 领用id, 打印id, v_Date, 使用人_In
      From 票据使用明细 A
      Where 打印id = v_收回id And 票种 = 2 And 性质 = 1 And Not Exists
       (Select 1 From 票据使用明细 Where 号码 = a.号码 And 打印id = v_收回id And 性质 = 2);
  End If;

  If 票据号_In Is Null Then
    Return;
  End If;

  --重新发出票据 
  Select 票据打印内容_Id.Nextval Into v_打印id From Dual;

  Insert Into 票据打印内容
    (ID, 数据性质, NO)
    Select v_打印id, 2, a.Column_Value From Table(f_Str2list(单据号_In)) A;

  Insert Into 票据使用明细
    (ID, 票种, 号码, 性质, 原因, 领用id, 打印id, 使用时间, 使用人)
  Values
    (票据使用明细_Id.Nextval, 2, 票据号_In, 1, Decode(v_收回id, Null, 1, 3), 领用id_In, v_打印id, v_Date, 使用人_In);

  --领用票据当前状态变化 
  Update 票据领用记录
  Set 当前号码 = 票据号_In, 剩余数量 = Decode(Sign(剩余数量 - 1), -1, 0, 剩余数量 - 1), 使用时间 = Sysdate
  Where ID = Nvl(领用id_In, 0);

  Update 病人预交记录
  Set 实际票号 = 票据号_In
  Where NO In (Select /*+Cardinality(A,10)*/
                a.Column_Value
               From Table(f_Str2list(单据号_In)) A) And 记录性质 = 1;
Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_病人预交记录_Reprint;
/

--112382:黄捷,2017-08-18,增加RIS预约调整标记
CREATE OR REPLACE Procedure Zl_Ris检查预约_Insert
(
  医嘱id_In     In Ris检查预约.医嘱id%Type,
  预约id_In     In Ris检查预约.预约id%Type,
  预约日期_In   In Ris检查预约.预约日期%Type,
  设备id_In     In Ris检查预约.检查设备id%Type,
  设备名称_In   In Ris检查预约.检查设备名称%Type,
  开始时间_In   In Ris检查预约.预约开始时间%Type,
  结束时间_In   In Ris检查预约.预约结束时间%Type,
  开始时间段_In In Ris检查预约.预约开始时间段%Type,
  结束时间段_In In Ris检查预约.预约结束时间段%Type,
  序号_In       In Ris检查预约.序号%Type,
  预约来源_In   In Ris检查预约.预约来源%Type,
  是否调整_In   In Ris检查预约.是否调整%Type
) Is
Begin
  If 是否调整_In = 1 Then
    Update Ris检查预约 Set 是否调整 = 1 Where 医嘱id = 医嘱id_In;
  Else
    Insert Into Ris检查预约
      (医嘱id, 预约id, 预约日期, 检查设备id, 检查设备名称, 预约开始时间, 预约结束时间, 预约开始时间段, 预约结束时间段, 序号, 预约来源)
    Values
      (医嘱id_In, 预约id_In, 预约日期_In, 设备id_In, 设备名称_In, 开始时间_In, 结束时间_In, 开始时间段_In, 结束时间段_In, 序号_In, 预约来源_In);
  End If;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Ris检查预约_Insert;
/

--113045:李小东,2017-08-17,转为无主标本时退料
Create Or Replace Procedure Zl_检验标本记录_转为无主
(
  医嘱id_In   In 检验标本记录.医嘱id%Type,
  删除院外_In In Number := 0
) Is
  --=0删除无主=1不删除无主

  Cursor c_Sample Is
    Select Distinct a.Id As 标本id, Decode(b.医嘱id, Null, a.医嘱id, b.医嘱id) As 医嘱id, a.申请类型, a.病人id, a.病人来源
    From 检验项目分布 B, 检验标本记录 A
    Where a.Id = b.标本id(+) And a.医嘱id = 医嘱id_In;

  Cursor c_Stuff(Vno Varchar2) Is
    Select Distinct s.Id, s.批号, s.实际数量, s.已发数量
    From (Select a.Id, a.批号, a.实际数量, b.已发数量, a.记录状态, a.审核人
           From (Select a.Id, a.药品id, a.序号, a.单据, a.批号, a.实际数量, a.记录状态, a.审核人
                  From 药品收发记录 A
                  Where a.审核人 Is Not Null And Nvl(a.发药方式, 0) <> -1 And (a.记录状态 = 1 Or Mod(a.记录状态, 3) = 0) And a.No = Vno And
                        a.单据 In (24, 25, 26)) A,
                (Select a.单据, a.药品id, a.序号, Sum(a.实际数量) As 已发数量
                  From 药品收发记录 A
                  Where a.审核人 Is Not Null And Nvl(a.发药方式, 0) <> -1 And a.No = Vno And
                        单据 In (Select 单据
                               From 药品收发记录
                               Where NO = Vno And 审核人 Is Not Null And Nvl(发药方式, 0) <> -1 And (记录状态 = 1 Or Mod(记录状态, 3) = 0) And
                                     单据 In (24, 25, 26))
                  Group By a.单据, a.药品id, a.序号) B
           Where a.单据 = b.单据 And a.药品id + 0 = b.药品id And a.序号 = b.序号 And b.已发数量 <> 0) S
    Where (s.记录状态 = 1 Or Mod(s.记录状态, 3) = 0) And s.实际数量 > (s.实际数量 - s.已发数量) And s.审核人 Is Not Null;

  v_Temp       Varchar2(255);
  v_人员部门id 部门人员.部门id%Type;
  v_人员编号   人员表.编号%Type;
  v_人员姓名   人员表.姓名%Type;
  Err_Custom Exception;
  v_Error Varchar2(255);
  v_Flag  Number(1) := 0;

  v_No       Varchar2(20);
  v_当前时间 Date;
  v_主页id   Number(18);
Begin
  v_Temp       := Zl_Identity;
  v_人员部门id := To_Number(Substr(v_Temp, 1, Instr(v_Temp, ',') - 1));
  v_Temp       := Substr(v_Temp, Instr(v_Temp, ';') + 1);
  v_Temp       := Substr(v_Temp, Instr(v_Temp, ',') + 1);
  v_人员编号   := Substr(v_Temp, 1, Instr(v_Temp, ',') - 1);
  v_人员姓名   := Substr(v_Temp, Instr(v_Temp, ',') + 1);
  v_当前时间   := Sysdate;
  v_Flag       := 0;
  Begin
    Select Nvl(Max(1), 0) Into v_Flag From 检验标本记录 Where 微生物标本 = 1 And 医嘱id = 医嘱id_In;
  Exception
    When Others Then
      v_Flag := 0;
  End;

  If v_Flag = 1 Then
  
    For r_Sample In c_Sample Loop
      Update 检验项目分布
      Set 医嘱id = Null
      Where 标本id In (Select Distinct ID From 检验标本记录 Where 医嘱id = r_Sample.医嘱id);
      Update 检验标本记录
      Set 医嘱id = Null, 姓名 = Null, 性别 = Null, 年龄 = Null, 病人id = Null, 病人来源 = Null, 婴儿 = Null, 合并id = Null, 紧急 = Null,
          挂号单 = Null, 门诊号 = Null, 住院号 = Null, 出生日期 = Null, 主页id = Null, 检验项目 = Null, 操作类型 = Null, 年龄单位 = Null,
          年龄数字 = Null, 申请人 = Null, 申请科室id = Null, 采样人 = Null, 采样时间 = Null, 标本类型 = Null, 标本形态 = Null, 接收人 = Null,
          接收时间 = Null, 样本条码 = Null
      Where 医嘱id = r_Sample.医嘱id;
      If r_Sample.申请类型 = 1 Then
        --删除时有问题时不进行删除
        Begin
          --Delete 病人医嘱发送 Where 医嘱id In (Select ID From 病人医嘱记录 Where R_Sample.医嘱id In (ID, 相关id));
          --Delete 病人医嘱记录 Where 医嘱id_In In (ID, 相关id);
          Null;
        Exception
          When Others Then
            Null;
        End;
      Else
        Update 病人医嘱发送
        Set 执行状态 = 0
        Where 执行状态 = 3 And 医嘱id In (Select ID From 病人医嘱记录 Where r_Sample.医嘱id In (ID, 相关id));
      
        If r_Sample.病人来源 = 2 Then
          Update /*+ rule */ 住院费用记录
          Set 执行状态 = 0, 执行时间 = Null, 执行人 = Null
          Where 病人id = r_Sample.病人id And 收费类别 Not In ('5', '6', '7') And
                (医嘱序号, 记录性质, NO) In
                (Select 医嘱id, 记录性质, NO
                 From 病人医嘱附费
                 Where 医嘱id = r_Sample.医嘱id
                 Union All
                 Select 医嘱id, 记录性质, NO
                 From 病人医嘱发送
                 Where 医嘱id In (Select ID From 病人医嘱记录 Where r_Sample.医嘱id In (ID, 相关id) And 相关id Is Not Null) And
                       接收人 Is Null
                 Union All
                 Select a.医嘱id, a.记录性质, a.No
                 From 病人医嘱发送 A, 住院费用记录 B
                 Where 医嘱id In (Select ID From 病人医嘱记录 Where r_Sample.医嘱id In (ID, 相关id) And 相关id Is Null) And
                       采样人 Is Null And a.医嘱id = b.医嘱序号 And a.记录性质 = b.记录性质 And a.No = b.No And
                       b.执行人 In (Select Distinct 姓名
                                 From 人员表 A, 部门人员 B, 部门性质说明 C
                                 Where a.Id = b.人员id And b.部门id = c.部门id And c.工作性质 = '检验'));
        Else
          Update /*+ rule */ 门诊费用记录
          Set 执行状态 = 0, 执行时间 = Null, 执行人 = Null
          Where 病人id = r_Sample.病人id And 收费类别 Not In ('5', '6', '7') And
                (医嘱序号, 记录性质, NO) In
                (Select 医嘱id, 记录性质, NO
                 From 病人医嘱附费
                 Where 医嘱id = r_Sample.医嘱id
                 Union All
                 Select 医嘱id, 记录性质, NO
                 From 病人医嘱发送
                 Where 医嘱id In (Select ID From 病人医嘱记录 Where r_Sample.医嘱id In (ID, 相关id) And 相关id Is Not Null) And
                       接收人 Is Null
                 Union All
                 Select a.医嘱id, a.记录性质, a.No
                 From 病人医嘱发送 A, 门诊费用记录 B
                 Where 医嘱id In (Select ID From 病人医嘱记录 Where r_Sample.医嘱id In (ID, 相关id) And 相关id Is Null) And
                       采样人 Is Null And a.医嘱id = b.医嘱序号 And a.记录性质 = b.记录性质 And a.No = b.No And
                       b.执行人 In (Select Distinct 姓名
                                 From 人员表 A, 部门人员 B, 部门性质说明 C
                                 Where a.Id = b.人员id And b.部门id = c.部门id And c.工作性质 = '检验'));
        
        End If;
        --取消试剂消耗单的审核
        v_No := '';
        Begin
          Select Distinct NO Into v_No From 检验试剂记录 Where 医嘱id = r_Sample.医嘱id;
        Exception
          When Others Then
            v_No := '';
        End;
      
        If v_No Is Not Null Then
        
          For r_Stuff In c_Stuff(v_No) Loop
            Zl_材料收发记录_部门退料(r_Stuff.Id, v_人员姓名, v_当前时间, r_Stuff.批号, Null, Null, r_Stuff.已发数量, 0, Null, 0);
          End Loop;
        
          v_主页id := Null;
          Select 主页id Into v_主页id From 病人医嘱记录 A Where ID = r_Sample.医嘱id;
        
          If v_主页id Is Null Then
            Zl_门诊记帐记录_Delete(v_No, '', v_人员编号, v_人员姓名);
          Else
            Zl_住院记帐记录_Delete(v_No, '', v_人员编号, v_人员姓名);
          End If;
          Update 检验试剂记录 Set NO = '' Where 医嘱id = r_Sample.医嘱id;
        End If;
      End If;
    
    End Loop;
  
  Else
  
    For r_Sample In c_Sample Loop
    
      --检查是否允许取消核收
      v_Flag := 0;
      Begin
        Select 1 Into v_Flag From 检验标本记录 Where ID = r_Sample.标本id And 样本状态 = 2;
      Exception
        When Others Then
          v_Flag := 0;
      End;
    
      If v_Flag = 1 Then
        v_Error := '当前申请所在的标本中有已经被审核的，请先取消审核！';
        Raise Err_Custom;
      End If;
    
      --删除合并关联项目
      Update 检验标本记录 Set 合并id = Null Where 合并id In (Select ID From 检验标本记录 Where 医嘱id = 医嘱id_In);
      --更改检验标本记录里记录的医嘱id,其实这可以不要此信息,以后考虑取消
      Update 检验标本记录
      Set 医嘱id = Null, 姓名 = Null, 性别 = Null, 年龄 = Null, 病人id = Null, 病人来源 = Null, 婴儿 = Null, 合并id = Null, 紧急 = Null,
          挂号单 = Null, 门诊号 = Null, 住院号 = Null, 出生日期 = Null, 主页id = Null, 检验项目 = Null, 操作类型 = Null, 年龄单位 = Null,
          年龄数字 = Null, 申请人 = Null, 申请科室id = Null, 采样人 = Null, 采样时间 = Null, 标本类型 = Null, 标本形态 = Null, 接收人 = Null,
          接收时间 = Null, 样本条码 = Null
      Where ID = r_Sample.标本id;
    
      Update 检验项目分布 Set 医嘱id = Null Where 标本id = r_Sample.标本id;
    
      If r_Sample.申请类型 = 1 Then
        --删除时有问题时不进行删除
        Begin
          --Delete 病人医嘱发送 Where 医嘱id In (Select ID From 病人医嘱记录 Where R_Sample.医嘱id In (ID, 相关id));
          --Delete 病人医嘱记录 Where 医嘱id_In In (ID, 相关id);
          Null;
        Exception
          When Others Then
            Null;
        End;
      Else
        Update 病人医嘱发送
        Set 执行状态 = 0
        Where 执行状态 = 3 And 医嘱id In (Select ID From 病人医嘱记录 Where r_Sample.医嘱id In (ID, 相关id));
      
        If r_Sample.病人来源 = 2 Then
          Update /*+ rule */ 住院费用记录
          Set 执行状态 = 0, 执行时间 = Null, 执行人 = Null
          Where 病人id = r_Sample.病人id And 收费类别 Not In ('5', '6', '7') And
                (医嘱序号, 记录性质, NO) In
                (Select 医嘱id, 记录性质, NO
                 From 病人医嘱附费
                 Where 医嘱id = r_Sample.医嘱id
                 Union All
                 Select 医嘱id, 记录性质, NO
                 From 病人医嘱发送
                 Where 医嘱id In (Select ID From 病人医嘱记录 Where r_Sample.医嘱id In (ID, 相关id) And 相关id Is Not Null) And
                       接收人 Is Null
                 Union All
                 Select a.医嘱id, a.记录性质, a.No
                 From 病人医嘱发送 A, 住院费用记录 B
                 Where 医嘱id In (Select ID From 病人医嘱记录 Where r_Sample.医嘱id In (ID, 相关id) And 相关id Is Null) And
                       采样人 Is Null And a.医嘱id = b.医嘱序号 And a.记录性质 = b.记录性质 And a.No = b.No And
                       b.执行人 In (Select Distinct 姓名
                                 From 人员表 A, 部门人员 B, 部门性质说明 C
                                 Where a.Id = b.人员id And b.部门id = c.部门id And c.工作性质 = '检验'));
        Else
          Update /*+ rule */ 门诊费用记录
          Set 执行状态 = 0, 执行时间 = Null, 执行人 = Null
          Where 病人id = r_Sample.病人id And 收费类别 Not In ('5', '6', '7') And
                (医嘱序号, 记录性质, NO) In
                (Select 医嘱id, 记录性质, NO
                 From 病人医嘱附费
                 Where 医嘱id = r_Sample.医嘱id
                 Union All
                 Select 医嘱id, 记录性质, NO
                 From 病人医嘱发送
                 Where 医嘱id In (Select ID From 病人医嘱记录 Where r_Sample.医嘱id In (ID, 相关id) And 相关id Is Not Null) And
                       接收人 Is Null
                 Union All
                 Select a.医嘱id, a.记录性质, a.No
                 From 病人医嘱发送 A, 门诊费用记录 B
                 Where 医嘱id In (Select ID From 病人医嘱记录 Where r_Sample.医嘱id In (ID, 相关id) And 相关id Is Null) And
                       采样人 Is Null And a.医嘱id = b.医嘱序号 And a.记录性质 = b.记录性质 And a.No = b.No And
                       b.执行人 In (Select Distinct 姓名
                                 From 人员表 A, 部门人员 B, 部门性质说明 C
                                 Where a.Id = b.人员id And b.部门id = c.部门id And c.工作性质 = '检验'));
        End If;
      End If;
      --取消试剂消耗单的审核
      v_No := '';
      Begin
        Select Distinct NO Into v_No From 检验试剂记录 Where 医嘱id = r_Sample.医嘱id;
      Exception
        When Others Then
          v_No := '';
      End;
      If v_No Is Not Null Then
        For r_Stuff In c_Stuff(v_No) Loop
          Zl_材料收发记录_部门退料(r_Stuff.Id, v_人员姓名, v_当前时间, r_Stuff.批号, Null, Null, r_Stuff.已发数量, 0, Null, 0);
        End Loop;
      
        v_主页id := Null;
        Select 主页id Into v_主页id From 病人医嘱记录 A Where ID = r_Sample.医嘱id;
      
        If v_主页id Is Null Then
          Zl_门诊记帐记录_Delete(v_No, '', v_人员编号, v_人员姓名);
        Else
          Zl_住院记帐记录_Delete(v_No, '', v_人员编号, v_人员姓名);
        End If;
        Update 检验试剂记录 Set NO = '' Where 医嘱id = r_Sample.医嘱id;
      End If;
      --删除试剂消耗单
    --Delete From 检验试剂记录 Where 医嘱id = r_Sample.医嘱id;
    End Loop;
  End If;

Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_检验标本记录_转为无主;
/

--113218:董露露,2017-08-17,解决病人信息合并时，在当前库是只读的情况下，病人合并会有提示的问题
CREATE OR REPLACE Procedure Zl_病人信息_Merge
(
  A病人id_In    病人信息.病人id%Type, --要合并的病人信息
  B病人id_In    病人信息.病人id%Type, --要保留的病人信息
  合并原因_In   病人合并记录.合并原因%Type,
  操作员姓名_In 人员表.姓名%Type,
  强制保留_In   Number := 0
  --标准版
  ----------------------------------------------------------------------------
  --病人信息,病案主页,病案主页从表,病人变动记录,特殊病人
  --门诊病案记录,住院病案记录,床位状况记录
  --医保病人档案,保险模拟结算,保险结算记录,帐户年度信息
  --病人余额,病人未结费用,住院费用记录,门诊费用记录,病人预交记录,病人结帐记录,未发药品记录
  --病人挂号记录,病人过敏药物,病人过敏记录,病人诊断记录,诊断情况
  --病人医嘱记录,病人手麻记录
  --病人社区信息
  
  --后备表：
  --H病人结帐记录,H病人预交记录,H住院费用记录,H门诊费用记录
  --H病人医嘱记录,H病人诊断记录,H病人过敏记录
  --H病人病历记录,H病人手麻记录
  
  --病案系统
  ----------------------------------------------------------------------------
  --病人费用,随诊记录,借阅记录
  --新生儿诊断记录,病人分娩信息
  --诊断符合情况,病案评分结果
  
) As
  --病人相关表
  Cursor c_Patitable Is
    Select a.Table_Name, Max(Decode(b.Column_Name, '病人ID', 1, 0)) As 病人id,
           Max(Decode(b.Column_Name, '主页ID', 1, 0)) As 主页id
    From User_Tables A, User_Tab_Columns B
    Where a.Table_Name = b.Table_Name And b.Column_Name In ('病人ID', '主页ID') And
          a.Table_Name Not In
          ('病人信息', '病案主页', '病案主页从表', '病人变动记录', '特殊病人', '门诊病案记录', '住院病案记录', '床位状况记录', '医保病人档案', '医保病人关联表', '保险模拟结算',
           '帐户年度信息', '病人余额', '病人未结费用', '住院费用记录', '门诊费用记录', '病人预交记录', '病人结帐记录', '未发药品记录', '病人挂号记录', '病人过敏药物', '病人过敏记录',
           '病人诊断记录', '诊断情况', '病人医嘱记录', '病人手麻记录', '病人费用', '随诊记录', '借阅记录', '病人分娩信息', '诊断符合情况', '病案评分结果', '病人担保记录', '病人社区信息',
           '病人免疫记录', '病人信息从表', '病人医疗卡属性') Having Max(Decode(b.Column_Name, '病人ID', 1, 0)) <> 0
    Group By a.Table_Name;

  --数组定义
  Type Array_Patitable Is Table Of Varchar2(100) Index By Binary_Integer;
  Arronbase Array_Patitable;
  Arronpage Array_Patitable;
  v_Loop    Number;
  n_Have    Number;

  -------------------------------------------------------
  --被合并的病人(住院号可能每次新产生,多次住院取最近一次)
  Cursor c_Infoa Is
    Select a.病人id, a.门诊号, a.住院号, a.就诊卡号, a.卡验证码, a.费别, a.医疗付款方式, a.姓名, a.性别, a.年龄, a.出生日期, a.出生地点, a.身份证号, a.其他证件, a.身份,
           a.职业, a.民族, a.国籍, a.籍贯, a.区域, a.学历, a.婚姻状况, a.家庭地址, a.家庭电话, a.家庭地址邮编, a.监护人, a.联系人姓名, a.联系人关系, a.联系人地址,
           a.联系人电话, a.户口地址, a.户口地址邮编, a.Email, a.Qq, a.合同单位id, a.工作单位, a.单位电话, a.单位邮编, a.单位开户行, a.单位帐号, a.担保人, a.担保额,
           a.担保性质, a.就诊时间, a.就诊状态, a.就诊诊室, a.住院次数, a.当前科室id, a.当前病区id, a.当前床号, a.入院时间, a.出院时间, a.在院, a.Ic卡号, a.健康号,
           a.医保号, a.险类, a.查询密码, a.登记时间, a.停用时间, a.锁定, a.联系人身份证号, b.主页id, b.入院日期, b.出院日期
    From 病人信息 A, 病案主页 B
    Where a.病人id = b.病人id(+) And a.病人id = A病人id_In
    Order By 出院日期 Desc, 主页id Desc;
  r_Infoa c_Infoa%RowType;

  --要保留的病人(住院号可能每次新产生,多次住院取最近一次)
  Cursor c_Infob Is
    Select a.病人id, a.门诊号, a.住院号, a.就诊卡号, a.卡验证码, a.费别, a.医疗付款方式, a.姓名, a.性别, a.年龄, a.出生日期, a.出生地点, a.身份证号, a.其他证件, a.身份,
           a.职业, a.民族, a.国籍, a.籍贯, a.区域, a.学历, a.婚姻状况, a.家庭地址, a.家庭电话, a.家庭地址邮编, a.监护人, a.联系人姓名, a.联系人关系, a.联系人地址,
           a.联系人电话, a.户口地址, a.户口地址邮编, a.Email, a.Qq, a.合同单位id, a.工作单位, a.单位电话, a.单位邮编, a.单位开户行, a.单位帐号, a.担保人, a.担保额,
           a.担保性质, a.就诊时间, a.就诊状态, a.就诊诊室, a.住院次数, a.当前科室id, a.当前病区id, a.当前床号, a.入院时间, a.出院时间, a.在院, a.Ic卡号, a.健康号,
           a.医保号, a.险类, a.查询密码, a.登记时间, a.停用时间, a.锁定, a.联系人身份证号, b.主页id, b.入院日期, b.出院日期
    From 病人信息 A, 病案主页 B
    Where a.病人id = b.病人id(+) And a.病人id = B病人id_In
    Order By 出院日期 Desc, 主页id Desc;
  r_Infob c_Infob%RowType;

  --合并后的信息
  Cursor c_Info(v_病人id 病人信息.病人id%Type) Is
    Select 病人id, 主页id, (Select Nvl(Max(主页id), 0) From 病案主页 Where 病人id = v_病人id) 最大主页id, 住院号, 病人性质, 医疗付款方式, 费别, 再入院,
           入院病区id, 入院科室id, 医疗小组id, 入院日期, 入院病况, 入院方式, 入院属性, 二级院转入, 住院目的, 入院病床, 是否陪伴, 当前病况, 当前病区id, 护理等级id, 出院科室id, 出院病床,
           出院日期, 住院天数, 出院方式, 是否确诊, 确诊日期, 新发肿瘤, 血型, 抢救次数, 成功次数, 随诊标志, 随诊期限, 尸检标志, 门诊医师, 责任护士, 住院医师, 病案号, 编目员编号, 编目员姓名,
           编目日期, 状态, 费用和, 年龄, 身高, 体重, 婚姻状况, 职业, 国籍, 学历, 单位电话, 单位邮编, 单位地址, 区域, 家庭地址, 家庭电话, 家庭地址邮编, 联系人姓名, 联系人关系, 联系人地址,
           联系人电话, 联系人身份证号, 户口地址, 户口地址邮编, 中医治疗类别, 险类, 社区, 审核标志, 审核人, 审核日期, 是否上传, 数据转出, 登记人, 登记时间, 备注, 病案状态, 病人类型
    From 病案主页
    Where 主页id = (Select Nvl(Max(主页id), 0)
                  From 病案主页
                  Where 病人id = v_病人id And Not Exists (Select 主页id From 病案主页 Where 病人id = v_病人id And 主页id = 0)) And
          病人id = v_病人id;
  r_Info c_Info%RowType;

  --合并两个住院病人
  Cursor c_Mergepati Is
    Select a.姓名, a.门诊号, a.住院号 当前住院号, b.病人id, b.主页id, b.住院号, b.病人性质, b.医疗付款方式, b.费别, b.再入院, b.入院病区id, b.入院科室id,
           b.医疗小组id, b.入院日期, b.入院病况, b.入院方式, b.入院属性, b.二级院转入, b.住院目的, b.入院病床, b.是否陪伴, b.当前病况, b.当前病区id, b.护理等级id,
           b.出院科室id, b.出院病床, b.出院日期, b.住院天数, b.出院方式, b.是否确诊, b.确诊日期, b.新发肿瘤, b.血型, b.抢救次数, b.成功次数, b.随诊标志, b.随诊期限,
           b.尸检标志, b.门诊医师, b.责任护士, b.住院医师, b.病案号, b.编目员编号, b.编目员姓名, b.编目日期, b.状态, b.费用和, b.性别, b.年龄, b.身高, b.体重, b.婚姻状况,
           b.职业, b.国籍, b.学历, b.单位电话, b.单位邮编, b.单位地址, b.区域, b.家庭地址, b.家庭电话, b.家庭地址邮编, b.联系人姓名, b.联系人关系, b.联系人地址, b.联系人电话,
           b.联系人身份证号, b.户口地址, b.户口地址邮编, b.中医治疗类别, b.险类, b.社区, b.审核标志, b.审核人, b.审核日期, b.是否上传, b.数据转出, b.登记人, b.登记时间, b.备注,
           b.病案状态, b.病人类型, b.封存时间, b.路径状态, b.单病种, b.婴儿科室id, b.婴儿病区id, b.母婴转科标志, b.医嘱重整时间
    From 病人信息 A, 病案主页 B
    Where a.病人id = b.病人id And a.病人id In (A病人id_In, B病人id_In)
    Order By b.入院日期 Desc, Nvl(b.出院日期, Sysdate) Desc;

  v_保留id 病人信息.病人id%Type;
  v_合并id 病人信息.病人id%Type;
  v_门诊号 病人信息.门诊号%Type;
  v_住院号 病人信息.住院号%Type;
  --病人未结费用(门诊部份)
  Cursor c_Owe(v_病人id 病人信息.病人id%Type) Is
    Select 病人病区id, 病人科室id, 开单部门id, 执行部门id, 收入项目id, 来源途径, Sum(金额) As 金额
    From 病人未结费用
    Where 主页id Is Null And 病人id = v_病人id
    Group By 病人病区id, 病人科室id, 开单部门id, 执行部门id, 收入项目id, 来源途径;

  --病人余额
  Cursor c_Spare(v_病人id 病人信息.病人id%Type) Is
    Select 性质, 类型, 预交余额, 费用余额 From 病人余额 Where 病人id = v_病人id;

  --医保病人档案
  Cursor c_Insure(v_病人id 病人信息.病人id%Type) Is
    Select * From 保险帐户 Where 病人id = v_病人id Order By 险类;

  --要保留的医保病人档案
  Cursor c_Keepinsure
  (
    v_病人id 病人信息.病人id%Type,
    v_险类   医保病人档案.险类%Type
  ) Is
    Select * From 保险帐户 Where 病人id = v_病人id And 险类 = v_险类;
  r_Keepinsure c_Keepinsure%RowType;

  Cursor c_Year
  (
    v_病人id 病人信息.病人id%Type,
    v_险类   医保病人档案.险类%Type
  ) Is
    Select * From 帐户年度信息 Where 病人id = v_病人id And 险类 = v_险类;

  v_原信息   病人合并记录.原信息%Type;
  v_Count    Number;
  n_Readonly Number;
  v_Sql      Varchar2(1000);

  n_主页id       病人信息.主页id%Type;
  v_Error        Varchar2(255);
  n_担保额       病人担保记录.担保额%Type;
  v_担保人       病人信息.担保人%Type;
  n_担保性质     病人担保记录.担保性质%Type;
  n_Row          Number;
  n_独立病案     Number;
  n_每次新住院号 Number;
  n_Max主页id    Number;
  n_Cnt主页id    Number;
  n_Cur主页id    Number;
  n_Cnt住院次数  Number;
  n_Cur住院次数  Number;
  n_Max住院次数  Number;
  n_Loop主页id   病人信息.主页id%Type;

  n_Lengthb Number;
  Err_Custom Exception;
Begin
  Begin
    Select 只读 Into n_Readonly From zlBakSpaces Where 当前 = 1;
  Exception
    When Others Then
      Null;
  End;
  If n_Readonly = 1 Then
    n_Readonly := 0;
    For r_Bak In (Select a.表名 Table_Name
                  From Zltools.Zlbaktables A, User_Constraints B
                  Where a.表名 = b.Table_Name And b.r_Constraint_Name = '病人信息_PK' And b.Constraint_Type = 'R') Loop
      v_Sql := 'Select Count(病人Id) From H' || r_Bak.Table_Name || ' Where 病人Id In(:1,:2)';
      Execute Immediate v_Sql
        Into n_Readonly
        Using A病人id_In, B病人id_In;
      If n_Readonly > 0 Then
        v_Error := '病人在只读的当前转储空间存在数据,不能进行合并!';
        Raise Err_Custom;
      End If;
    End Loop;
  End If;

  --程序中已检查：
  --1.选择了同一个病人
  --2.两个住院病人先入院的却在院(包括两个都在院)。
  --3.两个住院病人的住院期间存在交叉的情况
  --4.医保病人存在未结费用

  --先锁定病人不允许进行其他业务
  Zl_病人信息_锁定(A病人id_In, 1);
  Zl_病人信息_锁定(B病人id_In, 1);

  Open c_Infoa;
  Fetch c_Infoa
    Into r_Infoa;
  If c_Infoa%RowCount = 0 Then
    Close c_Infoa;
    v_Error := '没有发现被合并的病人信息！';
    Raise Err_Custom;
  End If;

  Open c_Infob;
  Fetch c_Infob
    Into r_Infob;
  If c_Infob%RowCount = 0 Then
    Close c_Infob;
    v_Error := '没有发现要保留的病人信息！';
    Raise Err_Custom;
  End If;

  --读取其它相关病人表到数组
  For r_Patitable In c_Patitable Loop
    If r_Patitable.主页id = 0 Then
      Arronbase(Arronbase.Count + 1) := r_Patitable.Table_Name;
    Else
      Arronpage(Arronpage.Count + 1) := r_Patitable.Table_Name;
    End If;
  End Loop;

  --以先住院或先登记的病人ID作为实际上要保留的病人ID
  If Nvl(强制保留_In, 0) = 1 Then
    v_保留id := B病人id_In;
  Else
    Select 病人id
    Into v_保留id
    From (Select /*+ CHOOSE */
            a.病人id
           From 病人信息 A, 病案主页 B
           Where a.病人id = b.病人id(+) And a.病人id In (A病人id_In, B病人id_In)
           Order By Nvl(b.入院日期, To_Date('3000-01-01', 'YYYY-MM-DD')), Nvl(b.出院日期, To_Date('3000-01-01', 'YYYY-MM-DD')),
                    a.登记时间, a.病人id --住院病人优先
           )
    Where Rownum = 1;
  End If;

  --先确定病案号的模式
  Select Zl_To_Number(Nvl(zl_GetSysParameter(39), '0')) Into n_独立病案 From Dual;
  --住院号模式
  Select Zl_To_Number(Nvl(zl_GetSysParameter(145), '0')) Into n_每次新住院号 From Dual;

  --另外一个就是实际最后要删除的病人ID
  If v_保留id = A病人id_In Then
    v_合并id := B病人id_In;
    --问题27445 保留指定病人的门诊号、住院号、医保号
    v_门诊号 := Nvl(r_Infob.门诊号, r_Infoa.门诊号);
    v_住院号 := Nvl(r_Infob.住院号, r_Infoa.住院号);
  Else
    v_合并id := A病人id_In;
    v_门诊号 := Nvl(r_Infob.门诊号, r_Infoa.门诊号);
    v_住院号 := Nvl(r_Infob.住院号, r_Infoa.住院号);
  End If;

  ---记录合并操作,在后面会根据r_PatiTable把合并病人的合并记录更新为保留病人的
  v_原信息 := v_合并id || ',' || r_Infoa.门诊号 || ',' || r_Infoa.住院号 || ',' || r_Infoa.就诊卡号 || ',' || r_Infoa.姓名 || ',' ||
           r_Infoa.性别 || ',' || r_Infoa.年龄 || ',' || To_Char(r_Infoa.出生日期, 'yyyy-mm-dd') || ',' || r_Infoa.身份证号 || ',' ||
           r_Infoa.婚姻状况 || ',' || r_Infoa.职业 || ',' || r_Infoa.家庭地址;
  Insert Into 病人合并记录
    (病人id, 原信息, 合并原因, 操作员姓名, 合并时间)
  Values
    (v_保留id, v_原信息, 合并原因_In, 操作员姓名_In, Sysdate);

  --开始合并
  --84398修改将住院次数计算放在外面，因需要考虑门诊和住院病人合并
  --10.34开始,住院次数不包含留关病人,合并后的住院次数=保留病人住院次数+合并病人正常入院的次数
  Select Nvl(住院次数, 0) Into n_Cur住院次数 From 病人信息 Where 病人id = v_保留id;
  Select Count(*) Into n_Cnt住院次数 From 病案主页 Where 病人id = v_合并id And 主页id <> 0 And 病人性质 = 0;
  n_Max住院次数 := n_Cur住院次数 + n_Cnt住院次数;
  --处理病案主页部份(涉及病人ID,主页ID字段的表)
  If (r_Infoa.主页id Is Not Null And r_Infob.主页id Is Not Null) Or (强制保留_In = 1 And r_Infoa.主页id Is Not Null) Then
    If r_Infoa.主页id = 0 And r_Infob.主页id = 0 Then
      Close c_Infoa;
      Close c_Infob;
      v_Error := '两个预约病人不能进行病人合并操作！';
      Raise Err_Custom;
    Elsif r_Infoa.主页id = 0 Then
      If r_Infob.入院日期 Is Not Null And r_Infob.出院日期 Is Null Then
        Close c_Infoa;
        Close c_Infob;
        v_Error := '预约病人和在院病人不能进行病人合并操作！';
        Raise Err_Custom;
      End If;
    Elsif r_Infob.主页id = 0 Then
      If r_Infoa.入院日期 Is Not Null And r_Infoa.出院日期 Is Null Then
        Close c_Infoa;
        Close c_Infob;
        v_Error := '预约病人和在院病人不能进行病人合并操作！';
        Raise Err_Custom;
      End If;
    End If;
    --求两个病人总共的住院就诊次数
    Select Count(*) Into v_Count From 病案主页 Where 病人id In (A病人id_In, B病人id_In) And 主页id <> 0;
    --因为10.19开始，入院时允许修改主页id，所以最大主页ID可能大于总的住院就诊次数
    Select Max(主页id) Into n_Max主页id From 病案主页 Where 病人id = v_保留id And 主页id <> 0;
    Select Count(*) Into n_Cnt主页id From 病案主页 Where 病人id = v_合并id And 主页id <> 0;
    If n_Max主页id + n_Cnt主页id > v_Count Then
      v_Count := n_Max主页id + n_Cnt主页id;
    End If;
    --求实际要更新的主页截至值,以前用v_Count >= n_Max主页id判断存在一个问题（对于两个病人多次交叉入院，可能导致A,B病人部分就诊次数没有更新）
    Select Nvl(Max(主页id), 0)
    Into n_Loop主页id
    From 病案主页 A, (Select Min(入院日期) 入院日期 From 病案主页 Where 病人id = v_合并id) B
    Where a.病人id = v_保留id And a.入院日期 < b.入院日期;
  
    For r_Merge In c_Mergepati Loop
      If Not (r_Merge.病人id = v_保留id And r_Merge.主页id = v_Count) And v_Count <> 0 Then
        --该病案主页要删除时,不能是已编目了的。
        If r_Merge.编目日期 Is Not Null Then
          Close c_Infoa;
          Close c_Infob;
          If r_Merge.当前住院号 Is Null Then
            v_Error := '病人' || r_Merge.姓名 || '(病人ID=' || r_Merge.病人id || ')存在已编目的病案,不允许合并该病人。';
          Else
            v_Error := '病人' || r_Merge.姓名 || '(病人ID=' || r_Merge.病人id || ',住院号=' || r_Merge.当前住院号 ||
                       ')存在已编目的病案,不允许合并该病人。';
          End If;
          Raise Err_Custom;
        End If;
        If v_Count >= Nvl(n_Loop主页id, 0) Then
          If r_Merge.主页id = 0 Then
            n_Cur主页id := 0;
            Update 病案主页
            Set 病人性质 = r_Merge.病人性质, 医疗付款方式 = r_Merge.医疗付款方式, 费别 = r_Merge.费别, 再入院 = r_Merge.再入院,
                入院病区id = r_Merge.入院病区id, 入院科室id = r_Merge.入院科室id, 入院日期 = r_Merge.入院日期, 入院病况 = r_Merge.入院病况,
                入院方式 = r_Merge.入院方式, 二级院转入 = r_Merge.二级院转入, 住院目的 = r_Merge.住院目的, 入院病床 = r_Merge.入院病床,
                是否陪伴 = r_Merge.是否陪伴, 当前病况 = r_Merge.当前病况, 当前病区id = r_Merge.当前病区id, 护理等级id = r_Merge.护理等级id,
                出院科室id = r_Merge.出院科室id, 出院病床 = r_Merge.出院病床, 出院日期 = r_Merge.出院日期, 住院天数 = r_Merge.住院天数,
                出院方式 = r_Merge.出院方式, 是否确诊 = r_Merge.是否确诊, 确诊日期 = r_Merge.确诊日期, 新发肿瘤 = r_Merge.新发肿瘤, 血型 = r_Merge.血型,
                抢救次数 = r_Merge.抢救次数, 成功次数 = r_Merge.成功次数, 随诊标志 = r_Merge.随诊标志, 随诊期限 = r_Merge.随诊期限, 尸检标志 = r_Merge.尸检标志,
                门诊医师 = r_Merge.门诊医师, 责任护士 = r_Merge.责任护士, 住院医师 = r_Merge.住院医师, 编目员编号 = r_Merge.编目员编号,
                编目员姓名 = r_Merge.编目员姓名, 编目日期 = r_Merge.编目日期, 状态 = r_Merge.状态, 费用和 = r_Merge.费用和, 姓名 = r_Merge.姓名,
                性别 = r_Merge.性别, 年龄 = r_Merge.年龄, 婚姻状况 = r_Merge.婚姻状况, 职业 = r_Merge.职业, 国籍 = r_Merge.国籍, 学历 = r_Merge.学历,
                单位电话 = r_Merge.单位电话, 单位邮编 = r_Merge.单位邮编, 单位地址 = r_Merge.单位地址, 区域 = r_Merge.区域, 家庭地址 = r_Merge.家庭地址,
                家庭电话 = r_Merge.家庭电话, 家庭地址邮编 = r_Merge.家庭地址邮编, 户口地址 = r_Merge.户口地址, 户口地址邮编 = r_Merge.户口地址邮编,
                联系人姓名 = r_Merge.联系人姓名, 联系人关系 = r_Merge.联系人关系, 联系人地址 = r_Merge.联系人地址, 联系人电话 = r_Merge.联系人电话,
                中医治疗类别 = r_Merge.中医治疗类别, 登记人 = r_Merge.登记人, 登记时间 = r_Merge.登记时间, 险类 = r_Merge.险类, 审核标志 = r_Merge.审核标志,
                是否上传 = r_Merge.是否上传, 备注 = r_Merge.备注, 数据转出 = r_Merge.数据转出, 病案号 = r_Merge.病案号,
                住院号 = Decode(n_每次新住院号, 1, r_Merge.住院号, v_住院号),病人类型 = r_Merge.病人类型,
                封存时间 = r_Merge.封存时间, 路径状态 = r_Merge.路径状态, 单病种 = r_Merge.单病种, 婴儿科室id = r_Merge.婴儿科室id,
                婴儿病区id = r_Merge.婴儿病区id, 母婴转科标志 = r_Merge.母婴转科标志, 医嘱重整时间 = r_Merge.医嘱重整时间
            Where 病人id = v_保留id And 主页id = n_Cur主页id;
            If Sql%RowCount = 0 Then
              Insert Into 病案主页
                (病人id, 主页id, 病人性质, 医疗付款方式, 费别, 再入院, 入院病区id, 入院科室id, 入院日期, 入院病况, 入院方式, 二级院转入, 住院目的, 入院病床, 是否陪伴, 当前病况,
                 当前病区id, 护理等级id, 出院科室id, 出院病床, 出院日期, 住院天数, 出院方式, 是否确诊, 确诊日期, 新发肿瘤, 血型, 抢救次数, 成功次数, 随诊标志, 随诊期限, 尸检标志,
                 门诊医师, 责任护士, 住院医师, 编目员编号, 编目员姓名, 编目日期, 状态, 费用和, 姓名, 性别, 年龄, 婚姻状况, 职业, 国籍, 学历, 单位电话, 单位邮编, 单位地址, 区域, 家庭地址,
                 家庭电话, 家庭地址邮编, 户口地址, 户口地址邮编, 联系人姓名, 联系人关系, 联系人地址, 联系人电话, 中医治疗类别, 登记人, 登记时间, 险类, 审核标志, 是否上传, 备注, 数据转出,
                 病案号, 住院号,病人类型, 封存时间, 路径状态, 单病种, 婴儿科室id, 婴儿病区id, 母婴转科标志, 医嘱重整时间)
              Values
                (v_保留id, n_Cur主页id, r_Merge.病人性质, r_Merge.医疗付款方式, r_Merge.费别, r_Merge.再入院, r_Merge.入院病区id,
                 r_Merge.入院科室id, r_Merge.入院日期, r_Merge.入院病况, r_Merge.入院方式, r_Merge.二级院转入, r_Merge.住院目的, r_Merge.入院病床,
                 r_Merge.是否陪伴, r_Merge.当前病况, r_Merge.当前病区id, r_Merge.护理等级id, r_Merge.出院科室id, r_Merge.出院病床, r_Merge.出院日期,
                 r_Merge.住院天数, r_Merge.出院方式, r_Merge.是否确诊, r_Merge.确诊日期, r_Merge.新发肿瘤, r_Merge.血型, r_Merge.抢救次数,
                 r_Merge.成功次数, r_Merge.随诊标志, r_Merge.随诊期限, r_Merge.尸检标志, r_Merge.门诊医师, r_Merge.责任护士, r_Merge.住院医师,
                 r_Merge.编目员编号, r_Merge.编目员姓名, r_Merge.编目日期, r_Merge.状态, r_Merge.费用和, r_Merge.姓名, r_Merge.性别, r_Merge.年龄,
                 r_Merge.婚姻状况, r_Merge.职业, r_Merge.国籍, r_Merge.学历, r_Merge.单位电话, r_Merge.单位邮编, r_Merge.单位地址, r_Merge.区域,
                 r_Merge.家庭地址, r_Merge.家庭电话, r_Merge.家庭地址邮编, r_Merge.户口地址, r_Merge.户口地址邮编, r_Merge.联系人姓名, r_Merge.联系人关系,
                 r_Merge.联系人地址, r_Merge.联系人电话, r_Merge.中医治疗类别, r_Merge.登记人, r_Merge.登记时间, r_Merge.险类, r_Merge.审核标志,
                 r_Merge.是否上传, r_Merge.备注, r_Merge.数据转出, r_Merge.病案号, Decode(n_每次新住院号, 1, r_Merge.住院号, v_住院号),
                 r_Merge.病人类型, r_Merge.封存时间, r_Merge.路径状态, r_Merge.单病种, r_Merge.婴儿科室id, r_Merge.婴儿病区id,
                 r_Merge.母婴转科标志, r_Merge.医嘱重整时间);
            End If;
          Else
            n_Cur主页id := v_Count;
            Insert Into 病案主页
              (病人id, 主页id, 病人性质, 医疗付款方式, 费别, 再入院, 入院病区id, 入院科室id, 入院日期, 入院病况, 入院方式, 二级院转入, 住院目的, 入院病床, 是否陪伴, 当前病况,
               当前病区id, 护理等级id, 出院科室id, 出院病床, 出院日期, 住院天数, 出院方式, 是否确诊, 确诊日期, 新发肿瘤, 血型, 抢救次数, 成功次数, 随诊标志, 随诊期限, 尸检标志, 门诊医师,
               责任护士, 住院医师, 编目员编号, 编目员姓名, 编目日期, 状态, 费用和, 姓名, 性别, 年龄, 婚姻状况, 职业, 国籍, 学历, 单位电话, 单位邮编, 单位地址, 区域, 家庭地址, 家庭电话,
               家庭地址邮编, 户口地址, 户口地址邮编, 联系人姓名, 联系人关系, 联系人地址, 联系人电话, 中医治疗类别, 登记人, 登记时间, 险类, 审核标志, 是否上传, 备注, 数据转出, 病案号, 住院号,
               病人类型, 封存时间, 路径状态, 单病种, 婴儿科室id, 婴儿病区id, 母婴转科标志, 医嘱重整时间)
            Values
              (v_保留id, n_Cur主页id, r_Merge.病人性质, r_Merge.医疗付款方式, r_Merge.费别, r_Merge.再入院, r_Merge.入院病区id, r_Merge.入院科室id,
               r_Merge.入院日期, r_Merge.入院病况, r_Merge.入院方式, r_Merge.二级院转入, r_Merge.住院目的, r_Merge.入院病床, r_Merge.是否陪伴,
               r_Merge.当前病况, r_Merge.当前病区id, r_Merge.护理等级id, r_Merge.出院科室id, r_Merge.出院病床, r_Merge.出院日期, r_Merge.住院天数,
               r_Merge.出院方式, r_Merge.是否确诊, r_Merge.确诊日期, r_Merge.新发肿瘤, r_Merge.血型, r_Merge.抢救次数, r_Merge.成功次数,
               r_Merge.随诊标志, r_Merge.随诊期限, r_Merge.尸检标志, r_Merge.门诊医师, r_Merge.责任护士, r_Merge.住院医师, r_Merge.编目员编号,
               r_Merge.编目员姓名, r_Merge.编目日期, r_Merge.状态, r_Merge.费用和, r_Merge.姓名, r_Merge.性别, r_Merge.年龄, r_Merge.婚姻状况,
               r_Merge.职业, r_Merge.国籍, r_Merge.学历, r_Merge.单位电话, r_Merge.单位邮编, r_Merge.单位地址, r_Merge.区域, r_Merge.家庭地址,
               r_Merge.家庭电话, r_Merge.家庭地址邮编, r_Merge.户口地址, r_Merge.户口地址邮编, r_Merge.联系人姓名, r_Merge.联系人关系, r_Merge.联系人地址,
               r_Merge.联系人电话, r_Merge.中医治疗类别, r_Merge.登记人, r_Merge.登记时间, r_Merge.险类, r_Merge.审核标志, r_Merge.是否上传,
               r_Merge.备注, r_Merge.数据转出, r_Merge.病案号, Decode(n_每次新住院号, 1, r_Merge.住院号, v_住院号),r_Merge.病人类型,
               r_Merge.封存时间, r_Merge.路径状态, r_Merge.单病种, r_Merge.婴儿科室id, r_Merge.婴儿病区id, r_Merge.母婴转科标志, r_Merge.医嘱重整时间);
          End If;
        Else
          Exit;
        End If;
      
        --更新病人相关表的病人指向
        ---------------------------------------------------------------
        --病人变动记录
        Update 病人变动记录
        Set 病人id = v_保留id, 主页id = n_Cur主页id
        Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
      
        --病案主页从表
        Update 病案主页从表
        Set 病人id = v_保留id, 主页id = n_Cur主页id
        Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
      
        --住院费用记录
        Update 住院费用记录
        Set 病人id = v_保留id, 主页id = n_Cur主页id,
            标识号 = Nvl(Decode(门诊标志, 1, v_门诊号, Decode(n_每次新住院号, 1, r_Merge.住院号, v_住院号)), 标识号)
        Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
        Update H住院费用记录
        Set 病人id = v_保留id, 主页id = n_Cur主页id,
            标识号 = Nvl(Decode(门诊标志, 1, v_门诊号, Decode(n_每次新住院号, 1, r_Merge.住院号, v_住院号)), 标识号)
        Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
        --门诊费用记录
        --Update 门诊费用记录
        --Set 病人id = v_保留id,
        --    标识号 = Nvl(Decode(门诊标志, 1, v_门诊号, Decode(n_每次新住院号, 1, r_Merge.住院号, v_住院号)), 标识号)
        --Where 病人id = r_Merge.病人id;
        --Update H门诊费用记录
        --Set 病人id = v_保留id,
        --    标识号 = Nvl(Decode(门诊标志, 1, v_门诊号, Decode(n_每次新住院号, 1, r_Merge.住院号, v_住院号)), 标识号)
        --Where 病人id = r_Merge.病人id;
      
        --病人预交记录
        Update 病人预交记录
        Set 病人id = v_保留id, 主页id = n_Cur主页id
        Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
        Update H病人预交记录
        Set 病人id = v_保留id, 主页id = n_Cur主页id
        Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
      
        --病人未结费用
        Update 病人未结费用
        Set 病人id = v_保留id, 主页id = n_Cur主页id
        Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
      
        --未发药品记录
        Update 未发药品记录
        Set 病人id = v_保留id, 主页id = n_Cur主页id
        Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
      
        --诊断情况
        Update 诊断情况
        Set 病人id = v_保留id, 主页id = n_Cur主页id
        Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
      
        --保险结算记录(病人ID和非住院病人一起在后面处理)
        Update 保险结算记录 Set 主页id = n_Cur主页id Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
      
        --保险模拟结算
        Update 保险模拟结算
        Set 病人id = v_保留id, 主页id = n_Cur主页id
        Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
      
        --病人医嘱记录(ZLHIS+)
        Update 病人医嘱记录
        Set 病人id = v_保留id, 主页id = n_Cur主页id
        Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
        Update H病人医嘱记录
        Set 病人id = v_保留id, 主页id = n_Cur主页id
        Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
      
        --病人过敏记录(ZLHIS+)
        Update 病人过敏记录
        Set 病人id = v_保留id, 主页id = n_Cur主页id
        Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
        Update H病人过敏记录
        Set 病人id = v_保留id, 主页id = n_Cur主页id
        Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
      
        --病人诊断记录(ZLHIS+)
        Update 病人诊断记录
        Set 病人id = v_保留id, 主页id = n_Cur主页id
        Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
        Update H病人诊断记录
        Set 病人id = v_保留id, 主页id = n_Cur主页id
        Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
      
        --病人手麻记录(ZLHIS+)
        Update 病人手麻记录
        Set 病人id = v_保留id, 主页id = n_Cur主页id
        Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
        Update H病人手麻记录
        Set 病人id = v_保留id, 主页id = n_Cur主页id
        Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
      
        --病人担保记录(zlhis+)
        Update 病人担保记录
        Set 病人id = v_保留id, 主页id = n_Cur主页id
        Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
      
        --病案系统的表
        Begin
          v_Sql := 'Update 病人费用 Set 病人ID=:1,主页ID=:2 Where 病人ID=:3 And 主页ID=:4';
          Execute Immediate v_Sql
            Using v_保留id, n_Cur主页id, r_Merge.病人id, r_Merge.主页id;
        Exception
          When Others Then
            Null;
        End;
      
        Begin
          v_Sql := 'Update 随诊记录 Set 病人ID=:1,主页ID=:2 Where 病人ID=:3 And 主页ID=:4';
          Execute Immediate v_Sql
            Using v_保留id, n_Cur主页id, r_Merge.病人id, r_Merge.主页id;
        Exception
          When Others Then
            Null;
        End;
      
        Begin
          v_Sql := 'Update 诊断符合情况 Set 病人ID=:1,主页ID=:2 Where 病人ID=:3 And 主页ID=:4';
          Execute Immediate v_Sql
            Using v_保留id, n_Cur主页id, r_Merge.病人id, r_Merge.主页id;
        Exception
          When Others Then
            Null;
        End;
      
        Begin
          v_Sql := 'Update 病案评分结果 Set 病人ID=:1,主页ID=:2 Where 病人ID=:3 And 主页ID=:4';
          Execute Immediate v_Sql
            Using v_保留id, n_Cur主页id, r_Merge.病人id, r_Merge.主页id;
        Exception
          When Others Then
            Null;
        End;
      
        Begin
          v_Sql := 'Insert Into 病人分娩信息(病人ID,主页ID,胎儿次序,分娩方式,出生胎位,分娩情况,出生缺陷,婴儿性别,婴儿体重,Apgar评分) ' ||
                   'Select :1,:2,胎儿次序,分娩方式,出生胎位,分娩情况,出生缺陷,婴儿性别,婴儿体重,Apgar评分 From 病人分娩信息 Where 病人ID=:3 And 主页ID=:4';
          Execute Immediate v_Sql
            Using v_保留id, n_Cur主页id, r_Merge.病人id, r_Merge.主页id;
        Exception
          When Others Then
            Null;
        End;
      
        Begin
          v_Sql := 'Delete From 病人分娩信息 Where 病人ID=:1 And 主页ID=:2';
          Execute Immediate v_Sql
            Using r_Merge.病人id, r_Merge.主页id;
        Exception
          When Others Then
            Null;
        End;
      
        Begin
          v_Sql := 'Update 借阅记录 Set 病人ID=:1,主页ID=:2 Where 病人ID=:3 And 主页ID=:4';
          Execute Immediate v_Sql
            Using v_保留id, n_Cur主页id, r_Merge.病人id, r_Merge.主页id;
        Exception
          When Others Then
            Null;
        End;
      
        --其它病案主页相关表
        For v_Loop In 1 .. Arronpage.Count Loop
          v_Sql := 'Update ' || Arronpage(v_Loop) || ' Set 病人ID=:1,主页ID=:2 Where 病人ID=:3 And 主页ID=:4';
          Execute Immediate v_Sql
            Using v_保留id, n_Cur主页id, r_Merge.病人id, r_Merge.主页id;
        End Loop;
      
        --删除已调整后的病案主页
        Delete From 病案主页 Where 病人id = r_Merge.病人id And 主页id = r_Merge.主页id;
      End If;
      If r_Merge.主页id <> 0 Then
        v_Count := v_Count - 1;
      End If;
    End Loop;
  End If;

  --不涉及主页ID部份的更改(无主页ID或主页ID可能为空)
  ---------------------------------------------------------------
  --住院费用记录
  Update 住院费用记录
  Set 病人id = v_保留id, 标识号 = Nvl(Decode(门诊标志, 2, v_住院号, v_门诊号), 标识号)
  Where 病人id = v_合并id;
  Update H住院费用记录
  Set 病人id = v_保留id, 标识号 = Nvl(Decode(门诊标志, 2, v_住院号, v_门诊号), 标识号)
  Where 病人id = v_合并id;
  --门诊费用记录
  Update 门诊费用记录
  Set 病人id = v_保留id, 标识号 = Nvl(Decode(门诊标志, 2, v_住院号, v_门诊号), 标识号)
  Where 病人id = v_合并id;
  Update H门诊费用记录
  Set 病人id = v_保留id, 标识号 = Nvl(Decode(门诊标志, 2, v_住院号, v_门诊号), 标识号)
  Where 病人id = v_合并id;

  --病人预交记录
  Update 病人预交记录 Set 病人id = v_保留id Where 病人id = v_合并id And 主页id Is Null;
  Update H病人预交记录 Set 病人id = v_保留id Where 病人id = v_合并id And 主页id Is Null;

  --未发药品记录
  Update 未发药品记录 Set 病人id = v_保留id Where 病人id = v_合并id And 主页id Is Null;

  --诊断情况
  Update 诊断情况 Set 病人id = v_保留id Where 病人id = v_合并id And 主页id Is Null;

  --病人医嘱记录(ZLHIS+)
  Update 病人医嘱记录 Set 病人id = v_保留id Where 病人id = v_合并id And 主页id Is Null;
  Update H病人医嘱记录 Set 病人id = v_保留id Where 病人id = v_合并id And 主页id Is Null;

  --病人过敏记录(ZLHIS+):主页ID可能是挂号ID
  Update 病人过敏记录 Set 病人id = v_保留id Where 病人id = v_合并id;
  Update H病人过敏记录 Set 病人id = v_保留id Where 病人id = v_合并id;

  --病人诊断记录(ZLHIS+):主页ID可能是挂号ID
  Update 病人诊断记录 Set 病人id = v_保留id Where 病人id = v_合并id;
  Update H病人诊断记录 Set 病人id = v_保留id Where 病人id = v_合并id;

  --病人手麻记录(ZLHIS+)
  Update 病人手麻记录 Set 病人id = v_保留id Where 病人id = v_合并id And 主页id Is Null;
  Update H病人手麻记录 Set 病人id = v_保留id Where 病人id = v_合并id And 主页id Is Null;

  --病人挂号记录(ZLHIS+)
  Update 病人挂号记录 Set 病人id = v_保留id, 门诊号 = Nvl(v_门诊号, 门诊号) Where 病人id = v_合并id;

  --病人结帐记录
  Update 病人结帐记录 Set 病人id = v_保留id Where 病人id = v_合并id;
  Update H病人结帐记录 Set 病人id = v_保留id Where 病人id = v_合并id;

  --床位状况记录
  Update 床位状况记录 Set 病人id = v_保留id Where 病人id = v_合并id;

  --病人担保记录
  Update 病人担保记录 Set 病人id = v_保留id Where 病人id = v_合并id;
  --特殊病人
  Select Count(*) Into v_Count From 特殊病人 Where 病人id = v_保留id;
  If v_Count = 0 Then
    Update 特殊病人 Set 病人id = v_保留id Where 病人id = v_合并id;
  Else
    Delete From 特殊病人 Where 病人id = v_合并id;
  End If;

  --病人未结费用
  For r_Owe In c_Owe(v_合并id) Loop
    Update 病人未结费用
    Set 金额 = Nvl(金额, 0) + Nvl(r_Owe.金额, 0)
    Where 主页id Is Null And 病人id = v_保留id And Nvl(病人病区id, 0) = Nvl(r_Owe.病人病区id, 0) And
          Nvl(病人科室id, 0) = Nvl(r_Owe.病人科室id, 0) And Nvl(开单部门id, 0) = Nvl(r_Owe.开单部门id, 0) And
          Nvl(执行部门id, 0) = Nvl(r_Owe.执行部门id, 0) And Nvl(收入项目id, 0) = Nvl(r_Owe.收入项目id, 0) And
          Nvl(来源途径, 0) = Nvl(r_Owe.来源途径, 0);
    If Sql%RowCount = 0 Then
      Insert Into 病人未结费用
        (病人id, 主页id, 病人病区id, 病人科室id, 开单部门id, 执行部门id, 收入项目id, 来源途径, 金额)
      Values
        (v_保留id, Null, r_Owe.病人病区id, r_Owe.病人科室id, r_Owe.开单部门id, r_Owe.执行部门id, r_Owe.收入项目id, r_Owe.来源途径, r_Owe.金额);
    End If;
  End Loop;
  Delete From 病人未结费用 Where 病人id = v_合并id;
  Delete From 病人未结费用 Where 病人id = v_保留id And Nvl(金额, 0) = 0;

  --病人余额
  For r_Spare In c_Spare(v_合并id) Loop
    Update 病人余额
    Set 预交余额 = Nvl(预交余额, 0) + Nvl(r_Spare.预交余额, 0), 费用余额 = Nvl(费用余额, 0) + Nvl(r_Spare.费用余额, 0)
    Where Nvl(性质, 0) = Nvl(r_Spare.性质, 0) And 病人id = v_保留id And 类型 = Nvl(r_Spare.类型, 2);
    If Sql%RowCount = 0 Then
      Insert Into 病人余额
        (病人id, 性质, 类型, 预交余额, 费用余额)
      Values
        (v_保留id, r_Spare.性质, Nvl(r_Spare.类型, 2), r_Spare.预交余额, r_Spare.费用余额);
    End If;
  End Loop;
  Delete From 病人余额 Where 病人id = v_合并id;
  Delete From 病人余额 Where 病人id = v_保留id And Nvl(预交余额, 0) = 0 And Nvl(费用余额, 0) = 0 And 性质 = 1;

  --病人过敏药物
  Insert Into 病人过敏药物
    (病人id, 过敏药物id, 过敏药物)
    Select v_保留id, 过敏药物id, 过敏药物
    From 病人过敏药物
    Where 病人id = v_合并id And 过敏药物id Not In (Select 过敏药物id From 病人过敏药物 Where 病人id = v_保留id);
  Delete From 病人过敏药物 Where 病人id = v_合并id;

  --病人社区信息
  Insert Into 病人社区信息
    (病人id, 社区, 社区号, 标志, 就诊类型, 就诊时间)
    Select v_保留id, 社区, 社区号, 标志, 就诊类型, 就诊时间
    From 病人社区信息
    Where 病人id = v_合并id And 社区 Not In (Select 社区 From 病人社区信息 Where 病人id = v_保留id);
  Delete From 病人社区信息 Where 病人id = v_合并id;

  --病人免疫记录
  Insert Into 病人免疫记录
    (病人id, 接种时间, 接种名称)
    Select v_保留id, a.接种时间, a.接种名称
    From 病人免疫记录 A
    Where a.病人id = v_合并id And Not Exists (Select 1 From 病人免疫记录 Where 病人id = v_保留id And 接种时间 = a.接种时间);
  Delete From 病人免疫记录 Where 病人id = v_合并id;

  --病人信息从表
  Insert Into 病人信息从表
    (病人id, 信息名, 信息值, 就诊id)
    Select v_保留id, a.信息名, a.信息值, a.就诊id
    From 病人信息从表 A
    Where a.病人id = v_合并id And Not Exists (Select 1
           From 病人信息从表
           Where 病人id = v_保留id And 信息名 = a.信息名 And Nvl(就诊id, 0) = Nvl(a.就诊id, 0));
  Delete From 病人信息从表 Where 病人id = v_合并id;

  --病人医疗卡属性
  Insert Into 病人医疗卡属性
    (病人id, 卡类别id, 卡号, 信息名, 信息值)
    Select v_保留id, a.卡类别id, a.卡号, a.信息名, a.信息值
    From 病人医疗卡属性 A
    Where a.病人id = v_合并id And Not Exists (Select 1
           From 病人医疗卡属性
           Where 病人id = v_保留id And 卡类别id = a.卡类别id And 卡号 = a.卡号 And 信息名 = a.信息名);
  Delete From 病人医疗卡属性 Where 病人id = v_合并id;

  --门诊病案记录
  Select Count(*) Into v_Count From 门诊病案记录 Where 病人id = v_保留id;
  If v_Count = 0 Then
    Select Count(*) Into v_Count From 门诊病案记录 Where 病人id = v_合并id;
    If v_Count > 0 Then
      Update 门诊病案记录 Set 病人id = v_保留id Where 病人id = v_合并id;
    End If;
  Else
    Delete From 门诊病案记录 Where 病人id = v_合并id;
  End If;

  --住院病案记录
  Select Count(*) Into v_Count From 住院病案记录 Where 病人id = v_保留id;

  If v_Count = 0 Then
    Select Count(*) Into v_Count From 住院病案记录 Where 病人id = v_合并id;
    If v_Count > 0 Then
      Update 住院病案记录 Set 病人id = v_保留id Where 病人id = v_合并id;
    End If;
  Else
    Begin
      v_Sql := 'Delete From 借阅记录 Where 病人ID=:1';
      Execute Immediate v_Sql
        Using v_合并id;
    Exception
      When Others Then
        Null;
    End;
  
    Delete From 住院病案记录 Where 病人id = v_合并id;
  End If;

  --医保病人相关处理
  --即使合病或保留的病人当前不是医保帐户,只要曾是医保帐户,险类不同也不能合并
  Select Count(Distinct 险类) Into v_Count From 医保病人关联表 Where 病人id In (v_合并id, v_保留id);
  If v_Count = 2 Then
    Close c_Infoa;
    Close c_Infob;
    v_Error := '两个病人分别属于不同的保险类别，不允许合并。';
    Raise Err_Custom;
  End If;

  Select Count(*) Into v_Count From 医保病人关联表 Where 病人id = v_合并id And 标志 = 0;
  --a.合并的病人以前是医保帐户,现在不是
  If v_Count > 0 Then
    Select Count(*) Into v_Count From 医保病人关联表 Where 病人id = v_保留id;
    --a.1保留的病人现在是医保帐户
    --a.2.1保留的病人现在不是医保帐户,以前是,与a.1相同处理
    If v_Count > 0 Then
      Delete From 帐户年度信息 Where 病人id = v_合并id;
    
      Select Count(Distinct 医保号) Into v_Count From 医保病人关联表 Where 病人id In (v_合并id, v_保留id);
      If v_Count <> 2 Then
        --两个病人医保号相同时,不用处理医保病人档案
        For r_Insure In c_Insure(v_合并id) Loop
          --被合并的病人可能关联了多个医保病人,改为关联到保留的病人上
          --问题27445 保留指定病人的门诊号、住院号、医保号
          If v_合并id = B病人id_In Then
            Update 医保病人关联表
            Set 医保号 =
                 (Select 医保号 From 医保病人关联表 Where 病人id = v_合并id), 标志 = 0
            Where 险类 = r_Insure.险类 And 中心 = r_Insure.中心 And 医保号 = r_Insure.医保号 And 病人id <> v_合并id;
          Else
            Update 医保病人关联表
            Set 医保号 =
                 (Select 医保号 From 医保病人关联表 Where 病人id = v_保留id), 标志 = 0
            Where 险类 = r_Insure.险类 And 中心 = r_Insure.中心 And 医保号 = r_Insure.医保号 And 病人id <> v_合并id;
          End If;
          --合并的病人现在不是医保,即使是用户指定要保留该病人,也不保留它的帐户信息
          Delete From 医保病人档案 Where 险类 = r_Insure.险类 And 医保号 = r_Insure.医保号;
        End Loop;
      End If;
      Delete From 医保病人关联表 Where 病人id = v_合并id;
    Else
      --a.2.2保留的病人现在和以前都不是医保帐户
      Update 帐户年度信息 Set 病人id = v_保留id Where 病人id = v_合并id;
      Update 医保病人关联表 Set 病人id = v_保留id Where 病人id = v_合并id;
      --医保病人档案表不用处理,因为通过医保号关联<医保病人关联表>
    End If;
  Else
    Select Count(*) Into v_Count From 医保病人关联表 Where 病人id = v_合并id And 标志 = 1;
    --b.合并的病人现在是医保帐户
    If v_Count > 0 Then
      Select Count(*) Into v_Count From 医保病人关联表 Where 病人id = v_保留id;
      --b.1保留的病人现在也是医保帐户
      --b.2.1保留的病人现在不是医保帐户,以前是,与b.1相同处理
      If v_Count > 0 Then
        For r_Insure In c_Insure(v_合并id) Loop
          --转移帐户年度信息
          For r_Year In c_Year(v_合并id, r_Insure.险类) Loop
            Update 帐户年度信息
            Set 帐户增加累计 = Nvl(帐户增加累计, 0) + Nvl(r_Year.帐户增加累计, 0), 帐户支出累计 = Nvl(帐户支出累计, 0) + Nvl(r_Year.帐户支出累计, 0),
                进入统筹累计 = Nvl(进入统筹累计, 0) + Nvl(r_Year.进入统筹累计, 0), 统筹报销累计 = Nvl(统筹报销累计, 0) + Nvl(r_Year.统筹报销累计, 0),
                住院次数累计 = Nvl(住院次数累计, 0) + Nvl(r_Year.住院次数累计, 0), 大额统筹累计 = Nvl(大额统筹累计, 0) + Nvl(r_Year.大额统筹累计, 0),
                起付线累计 = Nvl(起付线累计, 0) + Nvl(r_Year.起付线累计, 0), 本次起付线 = Nvl(本次起付线, r_Year.本次起付线),
                基本统筹限额 = Nvl(基本统筹限额, r_Year.基本统筹限额), 大额统筹限额 = Nvl(大额统筹限额, r_Year.大额统筹限额), 封销信息 = Nvl(封销信息, r_Year.封销信息)
            Where 病人id = v_保留id And 险类 = r_Insure.险类 And 年度 = r_Year.年度;
            If Sql%RowCount = 0 Then
              Insert Into 帐户年度信息
                (病人id, 险类, 年度, 帐户增加累计, 帐户支出累计, 进入统筹累计, 统筹报销累计, 住院次数累计, 本次起付线, 基本统筹限额, 大额统筹限额, 起付线累计, 大额统筹累计, 封销信息)
              Values
                (v_保留id, r_Insure.险类, r_Year.年度, r_Year.帐户增加累计, r_Year.帐户支出累计, r_Year.进入统筹累计, r_Year.统筹报销累计,
                 r_Year.住院次数累计, r_Year.本次起付线, r_Year.基本统筹限额, r_Year.大额统筹限额, r_Year.起付线累计, r_Year.大额统筹累计, r_Year.封销信息);
            End If;
          End Loop;
          Delete From 帐户年度信息 Where 病人id = v_合并id;
        
          Select Count(Distinct 医保号) Into v_Count From 医保病人关联表 Where 病人id In (v_合并id, v_保留id);
          If v_Count <> 2 Then
            --两个病人医保号相同时,不用处理医保病人档案
            If v_合并id = B病人id_In Then
              Update 医保病人关联表
              Set 标志 = 0
              Where (险类, 中心, 医保号) In (Select 险类, 中心, 医保号 From 医保病人关联表 Where 病人id = v_保留id);
              Update 医保病人关联表 Set 标志 = 1 Where 病人id = v_保留id;
            End If;
            Delete From 医保病人关联表 Where 病人id = v_合并id;
          Else
            --被合并的病人可能关联了多个医保病人,改为关联到保留的病人上
            --问题27445 保留指定病人的门诊号、住院号、医保号
            If v_合并id = B病人id_In Then
              Update 医保病人关联表
              Set 医保号 =
                   (Select 医保号 From 医保病人关联表 Where 病人id = v_合并id), 标志 = 0
              Where 险类 = r_Insure.险类 And 中心 = r_Insure.中心 And 医保号 = r_Insure.医保号 And 病人id <> v_合并id;
            Else
              Update 医保病人关联表
              Set 医保号 =
                   (Select 医保号 From 医保病人关联表 Where 病人id = v_保留id), 标志 = 0
              Where 险类 = r_Insure.险类 And 中心 = r_Insure.中心 And 医保号 = r_Insure.医保号 And 病人id <> v_合并id;
            End If;
            --暂存用户指定要保留病人的帐户信息
            If v_合并id = B病人id_In Then
              Open c_Keepinsure(B病人id_In, r_Insure.险类);
              Fetch c_Keepinsure
                Into r_Keepinsure;
            End If;
          
            Delete From 医保病人关联表 Where 病人id = v_合并id;
            Delete From 医保病人档案 Where 险类 = r_Insure.险类 And 医保号 = r_Insure.医保号;
          
            --保留用户指定要保留病人的帐户信息
            If v_合并id = B病人id_In Then
              If c_Keepinsure%RowCount > 0 Then
                Update 医保病人档案
                Set 卡号 = r_Keepinsure.卡号, 医保号 = r_Keepinsure.医保号, 密码 = r_Keepinsure.密码, 人员身份 = r_Keepinsure.人员身份,
                    单位编码 = r_Keepinsure.单位编码, 顺序号 = r_Keepinsure.顺序号, 退休证号 = r_Keepinsure.退休证号, 帐户余额 = r_Keepinsure.帐户余额,
                    当前状态 = r_Keepinsure.当前状态, 病种id = r_Keepinsure.病种id, 在职 = r_Keepinsure.在职, 年龄段 = r_Keepinsure.年龄段,
                    灰度级 = r_Keepinsure.灰度级, 就诊时间 = r_Keepinsure.就诊时间
                Where (险类, 中心, 医保号) In (Select 险类, 中心, 医保号 From 医保病人关联表 Where 病人id = v_保留id);
                --保留病人可能关联了多个医保病人,都要更改医保号
                Update 医保病人关联表
                Set 医保号 = r_Keepinsure.医保号, 标志 = 0
                Where (险类, 中心, 医保号) In (Select 险类, 中心, 医保号 From 医保病人关联表 Where 病人id = v_保留id);
                Update 医保病人关联表 Set 标志 = 1 Where 病人id = v_保留id;
              End If;
              Close c_Keepinsure;
            End If;
          End If;
        End Loop;
      Else
        --b.2.2保留的病人现在和以前都不是医保帐户
        Update 帐户年度信息 Set 病人id = v_保留id Where 病人id = v_合并id;
        Update 医保病人关联表 Set 病人id = v_保留id Where 病人id = v_合并id;
        --医保病人档案表不用处理,因为通过医保号关联<医保病人关联表>
      End If;
    Else
      --c.合并的病人以前和现在都不是医保帐户,不作任何处理
      Null;
    End If;
  End If;

  --处理体检子系统的病人合并
  n_Have := 0;
  Begin
    Select 1 Into n_Have From zlSystems Where Floor(编号 / 100) = 21;
  Exception
    When Others Then
      Null;
  End;
  If n_Have = 1 Then
    v_Sql := 'Begin zl21_病人信息_Merge(:1,:2); End;';
    Execute Immediate v_Sql
      Using v_合并id, v_保留id;
  End If;

  --其它病人,病案主页相关表
  For v_Loop In 1 .. Arronpage.Count Loop
    --Executesql('Update ' || Arronpage(v_Loop) || ' Set 病人ID=' || v_保留id || ' Where 病人ID=' || v_合并id || ' And Nvl(主页ID,0) = 0');
    --"主页=0，主页ID is NULL，主页ID=挂号ID"都有可能，前面部分与主页ID关联都没处理到，因此不加条件
    v_Sql := 'Update ' || Arronpage(v_Loop) || ' Set 病人ID=:1 Where 病人ID=:2';
    Execute Immediate v_Sql
      Using v_保留id, v_合并id;
  End Loop;
  For v_Loop In 1 .. Arronbase.Count Loop
    If Arronbase(v_Loop) = '病人照片' Then
      Select Count(1) Into n_Have From 病人照片 Where 病人id = v_保留id;
      If n_Have = 1 Then
        Delete From 病人照片 Where 病人id = v_合并id;
      End If;
    End If;
    v_Sql := 'Update ' || Arronbase(v_Loop) || ' Set 病人ID=:1 Where 病人ID=:2';
    Execute Immediate v_Sql
      Using v_保留id, v_合并id;
  End Loop;

  --删除实际不保留的病人信息
  Delete From 病人信息 Where 病人id = v_合并id;

  --根据界面选择保留病人信息
  Update 病人信息
  Set 姓名 = Nvl(r_Infob.姓名, r_Infoa.姓名), 性别 = Nvl(r_Infob.性别, r_Infoa.性别), 年龄 = Nvl(r_Infob.年龄, r_Infoa.年龄), 门诊号 = v_门诊号,
      住院号 = v_住院号, 就诊卡号 = Nvl(r_Infob.就诊卡号, r_Infoa.就诊卡号), 卡验证码 = Decode(r_Infob.就诊卡号, Null, r_Infoa.卡验证码, r_Infob.卡验证码),
      费别 = Nvl(r_Infob.费别, r_Infoa.费别), 医疗付款方式 = Nvl(r_Infob.医疗付款方式, r_Infoa.医疗付款方式),
      出生日期 = Nvl(r_Infob.出生日期, r_Infoa.出生日期), 出生地点 = Nvl(r_Infob.出生地点, r_Infoa.出生地点),
      身份证号 = Nvl(r_Infob.身份证号, r_Infoa.身份证号), 身份 = Nvl(r_Infob.身份, r_Infoa.身份), 职业 = Nvl(r_Infob.职业, r_Infoa.职业),
      民族 = Nvl(r_Infob.民族, r_Infoa.民族), 国籍 = Nvl(r_Infob.国籍, r_Infoa.国籍), 学历 = Nvl(r_Infob.学历, r_Infoa.学历),
      籍贯 = Nvl(r_Infob.籍贯, r_Infoa.籍贯), 区域 = Nvl(r_Infob.区域, r_Infoa.区域), 婚姻状况 = Nvl(r_Infob.婚姻状况, r_Infoa.婚姻状况),
      家庭地址 = Nvl(r_Infob.家庭地址, r_Infoa.家庭地址), 家庭电话 = Nvl(r_Infob.家庭电话, r_Infoa.家庭电话),
      家庭地址邮编 = Nvl(r_Infob.家庭地址邮编, r_Infoa.家庭地址邮编), 户口地址 = Nvl(r_Infob.户口地址, r_Infoa.户口地址),
      户口地址邮编 = Nvl(r_Infob.户口地址邮编, r_Infoa.户口地址邮编), 联系人姓名 = Nvl(r_Infob.联系人姓名, r_Infoa.联系人姓名),
      联系人关系 = Nvl(r_Infob.联系人关系, r_Infoa.联系人关系), 联系人地址 = Nvl(r_Infob.联系人地址, r_Infoa.联系人地址),
      联系人电话 = Nvl(r_Infob.联系人电话, r_Infoa.联系人电话), 合同单位id = Nvl(r_Infob.合同单位id, r_Infoa.合同单位id),
      工作单位 = Nvl(r_Infob.工作单位, r_Infoa.工作单位), 单位电话 = Nvl(r_Infob.单位电话, r_Infoa.单位电话),
      单位邮编 = Nvl(r_Infob.单位邮编, r_Infoa.单位邮编), 单位开户行 = Nvl(r_Infob.单位开户行, r_Infoa.单位开户行),
      单位帐号 = Nvl(r_Infob.单位帐号, r_Infoa.单位帐号), 就诊时间 = Nvl(r_Infob.就诊时间, r_Infoa.就诊时间),
      就诊状态 = Nvl(r_Infob.就诊状态, r_Infoa.就诊状态), 就诊诊室 = Nvl(r_Infob.就诊诊室, r_Infoa.就诊诊室), 险类 = Nvl(r_Infob.险类, r_Infoa.险类),
      登记时间 = Nvl(r_Infob.登记时间, r_Infoa.登记时间), 住院次数 = Null, 主页id = Null, 当前床号 = Null, 当前科室id = Null, 当前病区id = Null,
      入院时间 = Null, 出院时间 = Null, 在院 = Decode(Nvl(r_Infob.在院, 0), 1, 1, Null), 健康号 = Nvl(r_Infob.健康号, r_Infoa.健康号)
  Where 病人id = v_保留id;

  Open c_Info(v_保留id);
  Fetch c_Info
    Into r_Info;
  If c_Info%RowCount > 0 Then
    --最后一次为预约病人,只需要更改住院次数和入院时间
    If r_Info.主页id = 0 Then
      Update 病人信息
      Set 主页id = Decode(r_Info.最大主页id, 0, Null, r_Info.最大主页id), 住院次数 = Decode(n_Max住院次数, 0, Null, n_Max住院次数)
      Where 病人id = v_保留id;
    Else
      Update 病人信息
      Set 主页id = Decode(r_Info.最大主页id, 0, Null, r_Info.最大主页id), 住院次数 = Decode(n_Max住院次数, 0, Null, n_Max住院次数),
          当前床号 = Decode(r_Info.出院日期, Null, r_Info.出院病床, Null), 当前病区id = Decode(r_Info.出院日期, Null, r_Info.当前病区id, Null),
          当前科室id = Decode(r_Info.出院日期, Null, r_Info.出院科室id, Null), 入院时间 = r_Info.入院日期, 出院时间 = r_Info.出院日期





      
      Where 病人id = v_保留id;
    End If;
    --处理担保信息
    Select Nvl(主页id, -1) Into n_主页id From 病人信息 Where 病人id = v_保留id;
    --提取当前有效的正常担保记录,确保正常担保与临时担保不并存
    Select Nvl(Sum(担保额), 0), Count(病人id)
    Into n_担保额, n_Row
    From 病人担保记录
    Where 病人id = v_保留id And Nvl(主页id, -1) = n_主页id And (到期时间 Is Null Or 到期时间 > Sysdate) And 担保性质 = 0 And 删除标志 = 1;
    If n_Row = 0 Then
      --保留最后一条临时担保记录,其余到期
      Update 病人担保记录
      Set 到期时间 = Sysdate - 1 / 24 / 60 / 60
      Where 病人id = v_保留id And Nvl(主页id, -1) = n_主页id And 担保性质 = 1 And (到期时间 Is Null Or 到期时间 > Sysdate) And 删除标志 = 1 And
            登记时间 <> (Select Max(登记时间)
                     From 病人担保记录
                     Where 病人id = v_保留id And Nvl(主页id, -1) = n_主页id And 担保性质 = 1 And (到期时间 Is Null Or 到期时间 > Sysdate) And
                           删除标志 = 1);
    Else
      --有正常担保就让临时担保失效
      Update 病人担保记录
      Set 到期时间 = Sysdate - 1 / 24 / 60 / 60
      Where 病人id = v_保留id And Nvl(主页id, -1) = n_主页id And 担保性质 = 1 And (到期时间 Is Null Or 到期时间 > Sysdate) And 删除标志 = 1;
    End If;
  
    --提取当前有效担保额及有效担保记录数
    n_Row    := 0;
    n_担保额 := 0;
    v_担保人 := '';
    For r_提保信息 In (Select 担保人, 担保额
                   From 病人担保记录
                   Where 病人id = v_保留id And Nvl(主页id, -1) = n_主页id And (到期时间 Is Null Or 到期时间 > Sysdate) And 删除标志 = 1) Loop
      n_Row     := n_Row + 1;
      n_担保额  := n_担保额 + r_提保信息.担保额;
      v_担保人  := v_担保人 || ',' || r_提保信息.担保人;
      n_Lengthb := Lengthb(v_担保人);
      If n_Lengthb >= 101 Then
        v_Error := '不能合并担保记录，在病人信息保存时超过担保人字段长度！';
        Raise Err_Custom;
      End If;
    End Loop;
    v_担保人 := Substr(v_担保人, 2, 100);
  
    If n_Row = 0 Then
      Update 病人信息 Set 担保人 = Null, 担保额 = Null, 担保性质 = Null Where 病人id = v_保留id;
    Else
      --提取最后一条有效担保人和担保性质
      Select 担保性质
      Into n_担保性质
      From 病人担保记录
      Where 病人id = v_保留id And Nvl(主页id, -1) = n_主页id And 删除标志 = 1 And
            登记时间 =
            (Select Max(登记时间)
             From 病人担保记录
             Where 病人id = v_保留id And Nvl(主页id, -1) = n_主页id And (到期时间 Is Null Or 到期时间 > Sysdate) And 删除标志 = 1);
    
      Update 病人信息 Set 担保人 = v_担保人, 担保额 = n_担保额, 担保性质 = n_担保性质 Where 病人id = v_保留id;
    End If;
  End If;

  Close c_Info;
  Close c_Infoa;
  Close c_Infob;

  --对病人进行解锁
  Update 病人信息 Set 锁定 = 0 Where 病人id In (A病人id_In, B病人id_In);
Exception
  When Err_Custom Then
    Begin
      Rollback; --不然会死锁
      Zl_病人信息_锁定(A病人id_In, 0);
      Zl_病人信息_锁定(B病人id_In, 0);
      Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
    End;
  When Others Then
    Begin
      Rollback; --不然会死锁
      Zl_病人信息_锁定(A病人id_In, 0);
      Zl_病人信息_锁定(B病人id_In, 0);
      zl_ErrorCenter(SQLCode, SQLErrM);
    End;
End Zl_病人信息_Merge;
/

--111896:张德婷,2017-08-16,静配添加摆药，核对流程
CREATE OR REPLACE Procedure Zl_输液配药记录_核对
(
  配药id_In   In Varchar2, --ID串:ID1,ID2....
  操作人员_In In 输液配药记录.操作人员%Type := Null,
  操作时间_In In 输液配药记录.操作时间%Type := Null,
  操作说明_In In 输液配药状态.操作说明%Type := Null
) Is
  v_Tansid   Varchar2(20);
  v_Tmp      Varchar2(4000);
  n_操作状态 输液配药记录.操作状态%Type;
  v_Error    Varchar2(255);
  Err_Custom Exception;
Begin

  If 配药id_In Is Null Then
    v_Tmp := Null;
  Else
    v_Tmp := 配药id_In || ',';
  End If;

  While v_Tmp Is Not Null Loop
    --分解单据ID串
    v_Tansid := Substr(v_Tmp, 1, Instr(v_Tmp, ',') - 1);
    v_Tmp    := Replace(',' || v_Tmp, ',' || v_Tansid || ',');

    --检查当前输液单的状态是否为待摆药状态
    Begin
      Select 操作状态 Into n_操作状态 From 输液配药记录 Where ID = v_Tansid;

      if n_操作状态>2 then
        v_Error := '该数据已被操作，不能进行核对！';
        Raise Err_Custom;
      end if;
    Exception
      When Others Then
        v_Error := '该数据已被操作！';
        Raise Err_Custom;
    End;

    Update 输液配药记录 Set 操作状态 = 3, 操作人员 = 操作人员_In, 操作时间 = 操作时间_In Where ID = v_Tansid;
    Insert Into 输液配药状态 (配药id, 操作类型, 操作人员, 操作时间,操作说明) Values (v_Tansid,3, 操作人员_In, 操作时间_In,操作说明_In);
  End Loop;
Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_输液配药记录_核对;
/

--111896:张德婷,2017-08-16,静配添加摆药，核对流程
CREATE OR REPLACE Procedure Zl_输液配药记录_取消核对(配药id_In In Varchar2 --ID串:ID1,ID2....
                                           ) Is
  v_Tansid   Varchar2(20);
  v_Tmp      Varchar2(4000);
  v_操作人员 输液配药记录.操作人员%Type;
  d_操作时间 输液配药记录.操作时间%Type;
  n_操作状态 输液配药记录.操作状态%Type;
  v_Error    Varchar2(255);
  Err_Custom Exception;
Begin
  If 配药id_In Is Null Then
    v_Tmp := Null;
  Else
    v_Tmp := 配药id_In || ',';
  End If;

  While v_Tmp Is Not Null Loop
    --分解单据ID串
    v_Tansid := Substr(v_Tmp, 1, Instr(v_Tmp, ',') - 1);
    v_Tmp    := Replace(',' || v_Tmp, ',' || v_Tansid || ',');

    --检查当前输液单的状态是否为待摆药状态
    Begin
      Select 操作状态 Into n_操作状态 From 输液配药记录 Where ID = v_Tansid;

      if n_操作状态!=3 then
        v_Error := '该数据当前不是核对状态，不能进行取消核对！';
        Raise Err_Custom;
      end if;
    Exception
      When Others Then
        v_Error := '该数据已被操作！';
        Raise Err_Custom;
    End;

    Select 操作人员, 操作时间
    Into v_操作人员, d_操作时间
    From (Select 操作人员, 操作时间 From 输液配药状态 Where 配药id = v_Tansid And 操作类型 = 2 Order By 操作时间 Desc)
    Where Rownum = 1;

    Update 输液配药记录 Set 操作状态 = 2, 操作人员 = v_操作人员, 操作时间 = d_操作时间 Where ID = v_Tansid;
  End Loop;
Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_输液配药记录_取消核对;
/

--111896:张德婷,2017-08-16,移动添加摆药，核对流程
CREATE OR REPLACE Procedure Zl_输液配药记录_配药
(
  配药id_In   In Varchar2, --ID串:ID1,ID2....
  操作人员_In In 输液配药记录.操作人员%Type := Null,
  操作时间_In In 输液配药记录.操作时间%Type := Null,
  操作说明_In In 输液配药状态.操作说明%Type := Null,
  移动操作_In     IN number:=0
) Is
  v_Tansid   Varchar2(20);
  v_Tmp      Varchar2(4000);
  v_No       Varchar2(20);
  v_Usercode Varchar2(100);
  n_操作状态 输液配药记录.操作状态%Type;
  v_Error    Varchar2(255);
  n_People      number(1);
  n_row      number(2);
  d_执行时间 date;
  v_配药类型 varchar2(50);
  n_项目id   number(18);
  v_收费项目id varchar2(200);
  v_info    varchar2(200);
  v_id varchar2(20);
  n_数次 number(2);
  n_count number(18);
  n_Out number(10);
  n_OutNum number(10);
  n_打包状态 number(1);
  Err_Custom Exception;

  Cursor c_Bill Is
    Select a.病人id, a.主页id, a.标识号, a.姓名, a.性别, a.年龄, a.床号, a.费别, a.病人病区id, a.病人科室id, a.婴儿费, e.药品id, b.库房id,f.配药类型
    From 住院费用记录 A, 药品收发记录 B, 输液配药记录 C, 输液配药内容 D, 药品规格 E, 输液药品属性 F,配置收费方案 G
    Where a.Id = b.费用id And b.Id = d.收发id And d.记录id = c.Id And b.药品id = e.药品id And b.药品id = f.药品id 
    And substr(F.配药类型,instr(f.配药类型,'-')+1) = G.配药类型(+) And Nvl(c.是否打包, 0) <> 1 And c.Id = v_Tansid order by G.序号;

Begin
  v_Usercode := Zl_Identity;
  v_Usercode := Substr(v_Usercode, Instr(v_Usercode, ';') + 1);
  v_Usercode := Substr(v_Usercode, Instr(v_Usercode, ',') + 1);
  v_Usercode := Substr(v_Usercode, 1, Instr(v_Usercode, ',') - 1);
  n_People:=Nvl(zl_GetSysParameter('配置费按病人收取', 1345), 0);
  n_Out:=Nvl(zl_GetSysParameter('出院病人不收配置费', 1345), 0);

  If 配药id_In Is Null Then
    v_Tmp := Null;
  Else
    v_Tmp := 配药id_In || ',';
  End If;

  While v_Tmp Is Not Null Loop
    --分解单据ID串
    v_Tansid := Substr(v_Tmp, 1, Instr(v_Tmp, ',') - 1);
    v_Tmp    := Replace(',' || v_Tmp, ',' || v_Tansid || ',');

    --检查当前输液单的状态是否为待摆药状态
    Begin
      Select 操作状态,执行时间,nvl(是否打包,0)  Into n_操作状态,d_执行时间,n_打包状态 From 输液配药记录 Where ID = v_Tansid;

      if n_操作状态>3 then
        v_Error := '该数据已被操作，不能进行发药！';
        Raise Err_Custom;
      end if;
    Exception
      When Others Then
        v_Error := '该数据已被操作！';
        Raise Err_Custom;
    End;

    Update 输液配药记录 Set 操作状态 = 4, 操作人员 = 操作人员_In, 操作时间 = 操作时间_In Where ID = v_Tansid;
    Insert Into 输液配药状态 (配药id, 操作类型, 操作人员, 操作时间,操作说明) Values (v_Tansid, 4, 操作人员_In, 操作时间_In,操作说明_In);

    if n_打包状态=0 then
      n_count:=0;
      Select Nextno(14) Into v_No From Dual;
      For r_Bill In c_Bill Loop
        Select count(病人id) into n_OutNum From 病案主页 where 主页ID=r_Bill.主页id And 病人ID=r_Bill.病人id  And (Nvl(状态,0)=3 Or 出院日期 Is Not NULL);
        if n_count=0 and (n_OutNum=0 or n_out=0) then
          --收取材料费
          --v_收费项目id:='6970,2;6971,1;';
          select zl_fun_PIVACustom(v_Tansid) into  v_收费项目id from dual;
          While v_收费项目id Is Not Null Loop
             v_info:= Substr(v_收费项目id, 1, Instr(v_收费项目id, ';') - 1);
             v_收费项目id := Replace(';' || v_收费项目id, ';' || v_info || ';');
             

             v_id:= Substr(v_info, 1, Instr(v_info, ',') - 1);
             v_info := Replace(',' || v_info, ',' || v_id || ',');

            For r_Item In (Select a.Id 收费细目id, a.类别 收费类别, a.计算单位, a.加班加价 加班标志, d.Id 收入项目id, d.收据费目, b.现价
                           From 收费项目目录 A, 收费价目 B, 收入项目 D
                           Where a.Id = b.收费细目id And b.收入项目id = d.Id And a.id=v_id and
                                 b.执行日期 <= Sysdate And
                                 (b.终止日期 >= Sysdate Or b.终止日期 Is Null)) Loop
              if n_count=0 then
                Insert Into 输液配药附费 (配药id, NO,病人id) Values (v_Tansid, v_No, r_Bill.病人id);
              end if;

              n_count:=n_count+1;
              Zl_住院记帐记录_Insert(v_No, n_count, r_Bill.病人id, r_Bill.主页id, r_Bill.标识号, r_Bill.姓名, r_Bill.性别, r_Bill.年龄, r_Bill.床号,
                               r_Bill.费别, r_Bill.病人病区id, r_Bill.病人科室id, r_Item.加班标志, r_Bill.婴儿费, r_Bill.库房id, 操作人员_In, Null,
                               r_Item.收费细目id, r_Item.收费类别, r_Item.计算单位, Null, Null, Null, 1,v_info, Null, r_Bill.库房id, Null,
                               r_Item.收入项目id, r_Item.收据费目, r_Item.现价, r_Item.现价*v_info, r_Item.现价*v_info, Null, Sysdate, Sysdate, Null, Null,
                               v_Usercode, 操作人员_In);
            End Loop;
          end loop;
        end if;


        select count(项目id) into n_项目id from 配置收费方案 where 配药类型=substr(r_Bill.配药类型,INSTR(r_Bill.配药类型,'-',1,1)+1);
        if n_项目id<>0 then
          n_row:=0;
          select nvl(项目id,0) into n_项目id from 配置收费方案 where 配药类型=substr(r_Bill.配药类型,INSTR(r_Bill.配药类型,'-',1,1)+1);
          if n_People=1 then
            select count(配药id) into n_row from 输液配药附费 A,住院费用记录 B,输液配药记录 C where A.No=b.no and A.配药ID=C.id and b.病人id=r_Bill.病人id And B.记录状态=1 and B.收费细目id=n_项目id and d_执行时间 Between Trunc(c.执行时间) And Trunc(c.执行时间+1) - 1 / 24 / 60 / 60;
          end if;
        else
          n_row:=1;
        end if;

        if n_row=0 and (n_OutNum=0 or n_out=0) then
          For r_Item In (Select a.Id 收费细目id, a.类别 收费类别, a.计算单位, a.加班加价 加班标志, d.Id 收入项目id, d.收据费目, b.现价
                         From 收费项目目录 A, 收费价目 B, 收入项目 D
                         Where a.Id = b.收费细目id And b.收入项目id = d.Id And a.id=n_项目id and
                               b.执行日期 <= Sysdate And
                               (b.终止日期 >= Sysdate Or b.终止日期 Is Null)) Loop
            if n_count=0 then
              Insert Into 输液配药附费 (配药id, NO,病人id) Values (v_Tansid, v_No, r_Bill.病人id);
            end if;

            n_count:=n_count+1;
            Zl_住院记帐记录_Insert(v_No, n_count, r_Bill.病人id, r_Bill.主页id, r_Bill.标识号, r_Bill.姓名, r_Bill.性别, r_Bill.年龄, r_Bill.床号,
                             r_Bill.费别, r_Bill.病人病区id, r_Bill.病人科室id, r_Item.加班标志, r_Bill.婴儿费, r_Bill.库房id, 操作人员_In, Null,
                             r_Item.收费细目id, r_Item.收费类别, r_Item.计算单位, Null, Null, Null, 1, 1, Null, r_Bill.库房id, Null,
                             r_Item.收入项目id, r_Item.收据费目, r_Item.现价, r_Item.现价, r_Item.现价, Null, Sysdate, Sysdate, Null, Null,
                             v_Usercode, 操作人员_In);
          End Loop;
        end if;

        if n_row=0 then
          Exit;
        end if;
      End Loop;
    end if;
  End Loop;
Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_输液配药记录_配药;
/

--111896:张德婷,2017-08-16,移动添加摆药和核对接口
CREATE OR REPLACE Procedure Zl_输液配药记录_摆药
(
  部门id_In   In 输液配药记录.部门id%Type,
  配药id_In   In Varchar2, --ID串:ID1,ID2....
  摆药单号_In In 输液配药记录.摆药单号%Type,
  操作人员_In In 输液配药状态.操作人员%Type := Null,
  操作时间_In In 输液配药状态.操作时间%Type := Null,
  移动操作_In     IN number:=0
) Is
  v_Tansid Varchar2(20);
  v_Tmp    Varchar2(4000);

  v_收发ids  Varchar2(4000);
  v_Error    Varchar2(255);
  n_是否打包 输液配药记录.是否打包%Type;
  n_操作状态 输液配药记录.操作状态%Type;
  Err_Custom Exception;
  Cursor c_收发记录 Is
    Select /*+ rule*/
     a.Id, Nvl(a.批次, 0) As 批次
    From 药品收发记录 A,
         (Select Distinct 收发id
           From 输液配药内容 A, Table(Cast(f_Num2list(配药id_In) As Zltools.t_Numlist)) B
           Where a.记录id = b.Column_Value) B
    Where a.Id = b.收发id And a.审核人 Is Null order by a.药品id;

  v_收发记录 c_收发记录%RowType;
Begin
  If 配药id_In Is Null Then
    v_Tmp := Null;
  Else
    v_Tmp := 配药id_In || ',';
  End If;

  While v_Tmp Is Not Null Loop
    --分解单据ID串
    v_Tansid := Substr(v_Tmp, 1, Instr(v_Tmp, ',') - 1);
    v_Tmp    := Replace(',' || v_Tmp, ',' || v_Tansid || ',');

    --检查当前输液单的状态是否为待摆药状态
    Begin
      Select 操作状态 Into n_操作状态 From 输液配药记录 Where ID = v_Tansid;

      if n_操作状态>1 then
        v_Error := '该数据已被操作，不能进行发药！';
        Raise Err_Custom;
      end if;
    Exception
      When Others Then
        v_Error := '该数据已被操作！';
        Raise Err_Custom;
    End;

    Begin
      Select 是否打包 Into n_是否打包 From 输液配药记录 Where ID = v_Tansid For Update Nowait;
    Exception
      When Others Then
        v_Error := '已有其他用户在执行发药，不能重复操作！';
        Raise Err_Custom;
    End;
    Update 输液配药记录 Set 操作状态 = 2, 操作人员 = 操作人员_In, 操作时间 = 操作时间_In, 摆药单号 = 摆药单号_In Where id=v_Tansid;

    Insert Into 输液配药状态 (配药id, 操作类型, 操作人员, 操作时间) Values (v_Tansid, 2, 操作人员_In, 操作时间_In);
    If n_是否打包 <> 0 and 移动操作_In=0  Then
      Update 输液配药记录 Set 操作状态 =4, 操作人员 = 操作人员_In, 操作时间 = 操作时间_In Where id=v_Tansid;
      Insert Into 输液配药状态 (配药id, 操作类型, 操作人员, 操作时间) Values (v_Tansid, 4, 操作人员_In, 操作时间_In);
    End If;
  End Loop;

  For v_收发记录 In c_收发记录 Loop
    If v_收发ids Is Null Then
      v_收发ids := v_收发记录.Id || ',' || v_收发记录.批次;
    Else
      If Length(v_收发ids || '|' || v_收发记录.Id || ',' || v_收发记录.批次) > 3950 Then
        Zl_药品收发记录_批量发药(v_收发ids, 部门id_In, 操作人员_In, 操作时间_In, 4, 操作人员_In, 摆药单号_In);
        v_收发ids := v_收发记录.Id || ',' || v_收发记录.批次;
      Else
        v_收发ids := v_收发ids || '|' || v_收发记录.Id || ',' || v_收发记录.批次;
      End If;
    End If;
  End Loop;

  If Not v_收发ids Is Null Then
    Zl_药品收发记录_批量发药(v_收发ids, 部门id_In, 操作人员_In, 操作时间_In, 4, 操作人员_In, 摆药单号_In);
  End If;
Exception
  When Err_Custom Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_输液配药记录_摆药;
/

--112445:黄捷,2017-08-14,三种情况禁止RIS登记
Create Or Replace Package b_Zlxwinterface Is
  Type t_Refcur Is Ref Cursor;

  --1、接收RIS状态改变
  Procedure Receiverisstate
  (
    医嘱id_In   病人医嘱发送.医嘱id%Type,
    Risid_In    病人医嘱报告.Risid%Type,
    状态_In     Number,
    操作人员_In 病人医嘱发送.完成人%Type,
    执行时间_In 病人医嘱发送.完成时间%Type := Null,
    执行说明_In 病人医嘱发送.执行说明%Type := Null,
    单独执行_In Number := 0
  );

  --2、费用确认
  Procedure 影像费用执行
  (
    医嘱id_In     影像检查记录.医嘱id%Type,
    单独执行_In   Number := 0,
    操作员编号_In 人员表.编号%Type := Null,
    操作员姓名_In 人员表.姓名%Type := Null,
    执行部门id_In 门诊费用记录.执行部门id%Type := Null
  );

  --3、取消费用确认
  Procedure 影像费用执行_Cancel
  (
    医嘱id_In     影像检查记录.医嘱id%Type,
    单独执行_In   Number := 0,
    操作员编号_In 人员表.编号%Type := Null,
    操作员姓名_In 人员表.姓名%Type := Null,
    执行部门id_In 门诊费用记录.执行部门id%Type := Null
  );

  --4、接收RIS的报告
  Procedure Receivereport
  (
    医嘱id_In   病人医嘱发送.医嘱id%Type,
    Risid_In    病人医嘱报告.Risid%Type,
    报告所见_In 电子病历内容.内容文本%Type,
    报告意见_In 电子病历内容.内容文本%Type,
    报告建议_In 电子病历内容.内容文本%Type,
    报告医生_In 电子病历记录.创建人%Type
  );

  --5、修改申请单信息
  Procedure 影像病人信息_修改
  (
    医嘱id_In       病人医嘱记录.Id%Type,
    姓名_In         病人信息.姓名%Type,
    性别_In         病人信息.性别%Type,
    年龄_In         病人信息.年龄%Type,
    费别_In         病人信息.费别%Type,
    医疗付款方式_In 病人信息.医疗付款方式%Type,
    民族_In         病人信息.民族%Type,
    婚姻_In         病人信息.婚姻状况%Type,
    职业_In         病人信息.职业%Type,
    身份证号_In     病人信息.身份证号%Type,
    家庭地址_In     病人信息.家庭地址%Type,
    家庭电话_In     病人信息.家庭电话%Type,
    家庭地址邮编_In 病人信息.家庭地址邮编%Type,
    出生日期_In     病人信息.出生日期%Type := Null
  );

  --6、取消申请单信息
  Procedure 取消检查申请单
  (
    医嘱id_In     病人医嘱执行.医嘱id%Type,
    操作员编号_In 人员表.编号%Type := Null,
    操作员姓名_In 人员表.姓名%Type := Null,
    执行部门id_In 门诊费用记录.执行部门id%Type := 0,
    拒绝原因_In   病人医嘱发送.执行说明%Type := Null
  );

  --7、插入医嘱操作失败记录
  Procedure Ris医嘱失败记录_Insert
  (
    病人来源_In   In Ris医嘱失败记录.病人来源%Type,
    病人id_In     In Ris医嘱失败记录.病人id%Type,
    主页id_In     In Ris医嘱失败记录.主页id%Type,
    挂号单号_In   In Ris医嘱失败记录.挂号单号%Type,
    发送号_In     In Ris医嘱失败记录.发送号%Type,
    体检任务id_In In Ris医嘱失败记录.体检任务id%Type,
    体检报到号_In In Ris医嘱失败记录.体检报到号%Type,
    发送类型_In   In Ris医嘱失败记录.发送类型%Type
  );

  --8、更新医嘱操作失败记录
  Procedure Ris医嘱失败记录_重发
  (
    Id_In       In Ris医嘱失败记录.Id%Type,
    操作类型_In In Number
  );

  --9、销账后新建住院记账单据
  Procedure 病人医嘱_重建单据
  (
    医嘱id_In In 病人医嘱发送.医嘱id%Type,
    No_In     In 病人医嘱发送.No%Type,
    Action_In In Number
  );

  --10、打印RIS检查预约通知单
  Procedure Ris检查预约_打印(医嘱id_In In Ris检查预约.医嘱id%Type);

  --11、更新RIS分科室启用参数
  Procedure Ris启用控制_Update
  (
    检查类型_In Ris启用控制.检查类型%Type,
    场合_In     Ris启用控制.场合%Type,
    部门ids_In  Varchar2,
    启用类型_In Number
  );

  --12、删除RIS分科室启用参数
  Procedure Ris启用控制_Delete;

  --13、根据元素名提取信息
  Function Ris_Replace_Element_Value
  (
    元素名_In   In 诊治所见项目.中文名%Type,
    病人id_In   In 电子病历记录.病人id%Type,
    就诊id_In   In 电子病历记录.主页id%Type,
    病人来源_In In 电子病历记录.病人来源%Type,
    医嘱id_In   In 病人医嘱发送.医嘱id%Type
  ) Return Varchar2;

End b_Zlxwinterface;
/
Create Or Replace Package Body b_Zlxwinterface Is

  --1、接收RIS状态改变
  Procedure Receiverisstate
  (
    医嘱id_In   病人医嘱发送.医嘱id%Type,
    Risid_In    病人医嘱报告.Risid%Type,
    状态_In     Number,
    操作人员_In 病人医嘱发送.完成人%Type,
    执行时间_In 病人医嘱发送.完成时间%Type := Null,
    执行说明_In 病人医嘱发送.执行说明%Type := Null,
    单独执行_In Number := 0
  ) Is
  
    --参数：医嘱ID_IN - 单独执行的医嘱ID。
    --      状态_IN - -1-删除；0-预约；1-登记；3-检查完成；4-检查中止；9-初步报告；12-报告审核；15-发放
    --     单独执行_In -0-全部执行；1-单独执行；检查医嘱组合是否采用对每个项目分散单独执行的方式
  
    Cursor c_Adviceinfo Is
      Select a.Id, a.相关id, Nvl(a.相关id, a.Id) As 组id, a.诊疗类别, a.病人来源, a.执行科室id, b.执行过程
      From 病人医嘱记录 A, 病人医嘱发送 B
      Where a.Id = b.医嘱id And ID = 医嘱id_In;
    r_Adviceinfo c_Adviceinfo%RowType;
  
    v_执行状态 病人医嘱发送.执行状态%Type;
    v_执行过程 病人医嘱发送.执行过程%Type;
    n_执行     Number; --标记是否需要更新状态，1：需要更新，其他不需要更新
    v_Count    Number;
    v_完成人   病人医嘱发送.完成人%Type;
    v_完成时间 病人医嘱发送.完成时间%Type;
    v_Error    Varchar2(255);
    Err_Custom Exception;
  
  Begin
  
    v_执行状态 := 0;
    v_执行过程 := 0;
  
    --提取医嘱的主医嘱ID，及组ID
    Open c_Adviceinfo;
    Fetch c_Adviceinfo
      Into r_Adviceinfo;
    Close c_Adviceinfo;
  
    --根据状态_IN执行医嘱
    ---1-删除；0-预约；1-登记；3-检查完成；4-检查中止；9-初步报告；12-报告审核；13-取消审核；14-报告删除；15-发放
  
    If 状态_In = -1 Or 状态_In = 0 Then
      v_执行状态 := 0; --未执行
      v_执行过程 := 0;
    Elsif 状态_In = 1 Then
      v_执行状态 := 3; --正在执行
      v_执行过程 := 2; --已报到
    Elsif 状态_In = 3 Or 状态_In = 14 Then
      v_执行状态 := 3; --正在执行
      v_执行过程 := 3; --已检查
    Elsif 状态_In = 4 Then
      --不改变
      v_执行状态 := v_执行状态;
    Elsif 状态_In = 9 Or 状态_In = 13 Then
      v_执行状态 := 3; --正在执行
      v_执行过程 := 4; --已报告
    Elsif 状态_In = 12 Then
      v_执行状态 := 3; --正在执行
      v_执行过程 := 5; --已审核
    Elsif 状态_In = 15 Then
      v_执行状态 := 1; --完全执行
      v_执行过程 := 6; --已完成
      v_完成人   := 操作人员_In;
      v_完成时间 := 执行时间_In;
    End If;
  
    n_执行 := 1; --默认都要更新状态
  
    If 状态_In = 13 Or 状态_In = 14 Then
      --删除对应报告数据
      Delete From 电子病历记录
      Where ID = (Select 病历id From 病人医嘱报告 Where 医嘱id = 医嘱id_In And Risid = Risid_In);
      Delete From 病人医嘱报告 Where 医嘱id = 医嘱id_In And Risid = Risid_In;
    
      --删除后判断是否还存在报告，若存在则医嘱状态保持不变，若报告全部删除则更新医嘱状态
      Select Count(1) Into v_Count From 病人医嘱报告 Where 医嘱id = 医嘱id_In;
    
      If v_Count > 0 Then
        n_执行 := 0; --若存在则医嘱状态保持不变
      End If;
    End If;
  
    --如果是登记，先判断此检查是否未执行
    If 状态_In = 1 Then
      If r_Adviceinfo.执行过程 >= 3 Then
        v_Error := '患者已经做过检查了，不能重复登记。';
        Raise Err_Custom;
      End If;
    End If;
  
    --开始执行医嘱
    If n_执行 = 1 Then
      If Nvl(单独执行_In, 0) = 1 Then
        -- 单个部位医嘱单独执行
        Update 病人医嘱发送
        Set 执行状态 = v_执行状态, 执行过程 = v_执行过程, 执行说明 = 执行说明_In, 完成人 = v_完成人, 完成时间 = v_完成时间
        Where 医嘱id = 医嘱id_In;
      Else
        Update 病人医嘱发送
        Set 执行状态 = v_执行状态, 执行过程 = v_执行过程, 执行说明 = 执行说明_In, 完成人 = v_完成人, 完成时间 = v_完成时间
        Where 医嘱id In (Select ID From 病人医嘱记录 Where (ID = r_Adviceinfo.组id Or 相关id = r_Adviceinfo.组id));
      End If;
    End If;
  Exception
    When Err_Custom Then
      Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
    When Others Then
      zl_ErrorCenter(SQLCode, SQLErrM);
  End Receiverisstate;

  --2、费用确认
  Procedure 影像费用执行
  (
    医嘱id_In     影像检查记录.医嘱id%Type,
    单独执行_In   Number := 0,
    操作员编号_In 人员表.编号%Type := Null,
    操作员姓名_In 人员表.姓名%Type := Null,
    执行部门id_In 门诊费用记录.执行部门id%Type := Null
  ) Is
    --参数：医嘱ID_IN=单独执行的医嘱ID。
    --      单独执行_In=检查医嘱组合是否采用对每个项目分散单独执行的方式,0-不单独执行
    Cursor c_Advice Is
      Select ID, 相关id, Nvl(相关id, ID) As 组id, 诊疗类别, 病人来源 From 病人医嘱记录 Where ID = 医嘱id_In;
    r_Advice c_Advice%RowType;
  
    v_Temp     Varchar2(255);
    v_人员编号 人员表.编号%Type;
    v_人员姓名 人员表.姓名%Type;
    v_部门id   部门表.Id%Type;
    v_费用性质 病人医嘱发送.记录性质%Type;
    v_发送号   病人医嘱发送.发送号%Type;
    v_执行过程 病人医嘱发送.执行过程%Type;
    v_Count    Number;
    v_Error    Varchar2(255);
    Err_Custom Exception;
  Begin
  
    --取主医嘱ID
    Open c_Advice;
    Fetch c_Advice
      Into r_Advice;
    Close c_Advice;
  
    Select 发送号, 执行过程 Into v_发送号, v_执行过程 From 病人医嘱发送 Where 医嘱id = r_Advice.组id;
  
    --登记和完成才执行费用  2-登记，3-检查，4-报告，5-审核，6-完成
    If v_执行过程 >= 2 Or v_执行过程 <= 6 Then
    
      --先检查是否已经出院的住院病人，已经预出院或者出院的检查申请，不允执行费用
      Select Count(*)
      Into v_Count
      From 病人医嘱记录 A, 病案主页 B
      Where a.病人id = b.病人id And a.主页id = b.主页id And (b.出院日期 Is Not Null Or b.状态 = 3) And a.Id = r_Advice.组id;
    
      If v_Count > 0 Then
        --已经出院、预出院或转院，需要判断先是否死亡
        Select Count(*)
        Into v_Count
        From 病人医嘱记录 A, 诊疗项目目录 B, 病人医嘱发送 C
        Where a.Id = c.医嘱id And a.诊疗项目id = b.Id And b.类别 = 'Z' And b.操作类型 = 11 And
              a.病人id = (Select d.病人id From 病人医嘱记录 D Where d.Id = r_Advice.组id);
        If v_Count > 0 Then
          v_Error := '已经对患者下达死亡医嘱，不能执行费用。';
          Raise Err_Custom;
        End If;
        --再判断是否已经预约，已经预约可执行
        Select Count(*) Into v_Count From Ris检查预约 Where 医嘱id = r_Advice.组id;
        If v_Count = 0 Then
          --已经出院或者预出院，未预约，如果在旧版PACS已经报到，也可以执行
          Select Count(*) Into v_Count From 影像检查记录 Where 医嘱id = r_Advice.组id;
          If v_Count = 0 Then
            v_Error := '住院病人已经出院或者预出院，不能执行费用。';
            Raise Err_Custom;
          End If;
        End If;
      End If;
    
      --取当前操作人员
      If 操作员编号_In Is Not Null And 操作员姓名_In Is Not Null And 执行部门id_In Is Not Null Then
        v_人员编号 := 操作员编号_In;
        v_人员姓名 := 操作员姓名_In;
        v_部门id   := 执行部门id_In;
      Else
        v_Temp     := Zl_Identity;
        v_部门id   := Substr(v_Temp, 1, Instr(v_Temp, ',') - 1);
        v_Temp     := Substr(v_Temp, Instr(v_Temp, ';') + 1);
        v_Temp     := Substr(v_Temp, Instr(v_Temp, ',') + 1);
        v_人员编号 := Substr(v_Temp, 1, Instr(v_Temp, ',') - 1);
        v_人员姓名 := Substr(v_Temp, Instr(v_Temp, ',') + 1);
      End If;
    
      If r_Advice.病人来源 = 2 Then
        Select Decode(记录性质, 1, 1, Decode(门诊记帐, 1, 1, 2))
        Into v_费用性质
        From 病人医嘱发送
        Where 发送号 = v_发送号 And 医嘱id = 医嘱id_In;
      Else
        v_费用性质 := 1;
      End If;
    
      --执行费用和自动发料
      If v_费用性质 = 1 Then
        Zl_门诊医嘱执行_Finish(医嘱id_In, v_发送号, 单独执行_In, v_人员编号, v_人员姓名, r_Advice.组id, r_Advice.诊疗类别, v_部门id);
      Else
        Zl_住院医嘱执行_Finish(医嘱id_In, v_发送号, 单独执行_In, v_人员编号, v_人员姓名, r_Advice.组id, r_Advice.诊疗类别, v_部门id);
      End If;
    End If;
  
  Exception
    When Err_Custom Then
      Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
    When Others Then
      zl_ErrorCenter(SQLCode, SQLErrM);
  End 影像费用执行;

  --3、取消费用确认
  Procedure 影像费用执行_Cancel
  (
    医嘱id_In     影像检查记录.医嘱id%Type,
    单独执行_In   Number := 0,
    操作员编号_In 人员表.编号%Type := Null,
    操作员姓名_In 人员表.姓名%Type := Null,
    执行部门id_In 门诊费用记录.执行部门id%Type := Null
  ) Is
    --参数：
    --      医嘱ID_IN=单独执行的医嘱ID。
    --      单独执行_In=检查医嘱组合是否采用对每个项目分散单独执行的方式,0-不单独执行
  
    Cursor c_Advice Is
      Select ID, 相关id, Nvl(相关id, ID) As 组id From 病人医嘱记录 Where ID = 医嘱id_In;
    r_Advice c_Advice%RowType;
  
    v_发送号 病人医嘱发送.发送号%Type;
    v_Count  Number;
    v_Error  Varchar2(255);
    Err_Custom Exception;
  
  Begin
  
    --取主医嘱ID
    Open c_Advice;
    Fetch c_Advice
      Into r_Advice;
    Close c_Advice;
  
    --先检查是否已经出院的住院病人，已经预出院或者出院的检查申请，不允执行费用
    Select Count(*)
    Into v_Count
    From 病人医嘱记录 A, 病案主页 B
    Where a.病人id = b.病人id And a.主页id = b.主页id And (b.出院日期 Is Not Null Or b.状态 = 3) And a.Id = r_Advice.组id;
  
    If v_Count > 0 Then
      v_Error := '住院病人已经出院或者预出院，不能取消费用。';
      Raise Err_Custom;
    End If;
  
    Select 发送号 Into v_发送号 From 病人医嘱发送 Where 医嘱id = r_Advice.组id;
  
    --调用统一的医嘱执行Cancel过程
    Zl_病人医嘱执行_Cancel(医嘱id_In, v_发送号, Null, 单独执行_In, 执行部门id_In, 操作员编号_In, 操作员姓名_In);
  
  Exception
    When Err_Custom Then
      Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
    When Others Then
      zl_ErrorCenter(SQLCode, SQLErrM);
  End 影像费用执行_Cancel;

  --4、接收RIS的报告
  Procedure Receivereport
  (
    医嘱id_In   病人医嘱发送.医嘱id%Type,
    Risid_In    病人医嘱报告.Risid%Type,
    报告所见_In 电子病历内容.内容文本%Type,
    报告意见_In 电子病历内容.内容文本%Type,
    报告建议_In 电子病历内容.内容文本%Type,
    报告医生_In 电子病历记录.创建人%Type
  ) Is
    --提取病人医嘱及报告的相关信息
    Cursor c_Advice
    (
      v_组id  Number,
      v_Risid Number
    ) Is
      Select e.Id, e.病人来源, e.病人id, e.主页id, e.婴儿, e.病人科室id, e.文件id, e.病历种类, e.病历名称, f.病历id, e.执行科室id
      From (Select c.Id, c.病人来源, c.病人id, c.主页id, c.婴儿, c.病人科室id, c.文件id, d.种类 病历种类, d.名称 病历名称, c.执行科室id
             From (Select a.Id, a.病人来源, a.病人id, a.主页id, a.婴儿, a.病人科室id, b.病历文件id 文件id, a.执行科室id
                    From 病人医嘱记录 A, 病历单据应用 B
                    Where a.Id = v_组id And a.诊疗项目id = b.诊疗项目id(+) And b.应用场合(+) = Decode(a.病人来源, 2, 2, 4, 4, 1)) C,
                  病历文件列表 D
             Where c.文件id = d.Id(+)) E, 病人医嘱报告 F
      Where e.Id = f.医嘱id(+) And f.Risid(+) = v_Risid;
  
    --查找文件的组成元素
    Cursor c_File(v_File Number) Is
      Select a.Id, a.文件id, a.父id, a.对象序号, a.对象类型, a.对象标记, a.保留对象, a.对象属性, a.内容行次, a.内容文本, a.是否换行, a.预制提纲id, a.复用提纲,
             a.使用时机, a.诊治要素id, a.替换域, a.要素名称, a.要素类型, a.要素长度, a.要素小数, a.要素单位, a.要素表示, a.输入形态, a.要素值域
      From 病历文件结构 A
      Where a.文件id = v_File
      Order By a.对象序号;
  
    Cursor c_Report(v_电子病历记录id Number) Is
      Select b.Id, a.内容文本
      From 电子病历内容 A, 电子病历内容 B
      Where a.对象类型 = 3 And a.Id = b.父id And b.对象类型 = 2 And b.终止版 = 0 And a.文件id = v_电子病历记录id;
  
    Cursor c_Content
    (
      v_文件id Number,
      v_表格id Number
    ) Is
      Select a.Id, a.文件id, a.父id, a.对象序号, a.对象类型, a.对象标记, a.保留对象, a.对象属性, a.内容行次, a.内容文本, a.是否换行, a.预制提纲id, a.复用提纲,
             a.使用时机, a.诊治要素id, a.替换域, a.要素名称, a.要素类型, a.要素长度, a.要素小数, a.要素单位, a.要素表示, a.输入形态, a.要素值域
      From 病历文件结构 A
      Where 文件id = v_文件id And 父id = v_表格id;
  
    r_Advice        c_Advice%RowType;
    v_病历id        电子病历内容.文件id%Type;
    v_病历内容id    电子病历内容.Id%Type;
    v_病历内容idnew 电子病历内容.Id%Type;
    v_对象序号      电子病历内容.对象序号%Type;
    v_父id          电子病历内容.父id%Type;
    v_内容文本      电子病历内容.内容文本%Type;
    v_定义提纲id    电子病历内容.定义提纲id%Type;
    --v_格式内容    电子病历格式.内容%Type;
    v_Error Varchar2(255);
    Err_Custom Exception;
    v_主医嘱id 病人医嘱发送.医嘱id%Type;
    v_表格     Varchar2(300);
    n_数量     Number;
    n_Rptcount Number;
    v_病历名称 电子病历记录.病历名称%Type;
    v_挂号单id 病人挂号记录.Id%Type;
  
    Function Getrptno
    (
      v_医嘱idin   病人医嘱发送.医嘱id%Type,
      v_病历名称in 电子病历记录.病历名称%Type
    ) Return Varchar As
      v_Return Number;
      v_No     Number;
      v_Count  Number;
    Begin
      Select Count(医嘱id) + 1 Into v_No From 病人医嘱报告 Where 医嘱id = v_医嘱idin;
      v_Count := 1;
      While v_Count = 1 Loop
        Select Count(ID)
        Into v_Count
        From 病人医嘱报告 A, 电子病历记录 B
        Where a.医嘱id = v_医嘱idin And a.病历id = b.Id And b.病历名称 = v_病历名称in || v_No;
        If v_Count = 1 Then
          v_No := v_No + 1;
        End If;
      End Loop;
      v_Return := v_No;
      Return v_Return;
    End Getrptno;
  
  Begin
  
    -- 提取主医嘱ID ，防止因为传入部位医嘱，导致报告保存出错
    Select Nvl(相关id, ID) As 组id Into v_主医嘱id From 病人医嘱记录 Where ID = 医嘱id_In;
  
    Open c_Advice(v_主医嘱id, Nvl(Risid_In, 0));
    Fetch c_Advice
      Into r_Advice;
  
    If Nvl(r_Advice.文件id, 0) = 0 Then
      v_Error := '本次检查项目没有对应相关的检查报告，请与管理员联系！';
      Raise Err_Custom;
    Else
      If Nvl(r_Advice.病历id, 0) > 0 Then
        ----产生过报告
        --找出检查已填写的报告提纲中含有"%所见%","%描述%","%建议%","%意见%",并用传入的参数更新
        For r_Report In c_Report(r_Advice.病历id) Loop
          If r_Report.内容文本 Like '%所见%' Then
            Update 电子病历内容 Set 内容文本 = 报告所见_In || Chr(13) || Chr(13) Where ID = r_Report.Id;
          Elsif r_Report.内容文本 Like '%意见%' Then
            Update 电子病历内容 Set 内容文本 = 报告意见_In || Chr(13) || Chr(13) Where ID = r_Report.Id;
          Elsif r_Report.内容文本 Like '%建议%' Then
            Update 电子病历内容 Set 内容文本 = 报告建议_In || Chr(13) || Chr(13) Where ID = r_Report.Id;
          End If;
        End Loop;
        --更新保存时间
        Update 电子病历记录
        Set 完成时间 = Sysdate, 保存人 = 报告医生_In, 保存时间 = Sysdate
        Where ID = r_Advice.病历id;
      Else
        --先判断单据中是否有对应的提纲和表格
        If Nvl(报告所见_In, ' ') <> ' ' Then
          Select Count(1)
          Into n_数量
          From 病历文件结构 A, 病历文件结构 B
          Where a.父id = b.Id And a.对象类型 = 3 And b.对象类型 = 1 And a.内容文本 Like '%所见%' And a.文件id = r_Advice.文件id;
        
          If n_数量 <= 0 Then
            v_Error := '在诊疗单据中没有找到【所见】对应的提纲或表格，请联系管理员设置！';
            Raise Err_Custom;
          End If;
        End If;
        If Nvl(报告意见_In, ' ') <> ' ' Then
          Select Count(1)
          Into n_数量
          From 病历文件结构 A, 病历文件结构 B
          Where a.父id = b.Id And a.对象类型 = 3 And b.对象类型 = 1 And a.内容文本 Like '%意见%' And a.文件id = r_Advice.文件id;
        
          If n_数量 <= 0 Then
            v_Error := '在诊疗单据中没有找到【意见】对应的提纲或表格，请联系管理员设置！';
            Raise Err_Custom;
          End If;
        End If;
        If Nvl(报告建议_In, ' ') <> ' ' Then
          Select Count(1)
          Into n_数量
          From 病历文件结构 A, 病历文件结构 B
          Where a.父id = b.Id And a.对象类型 = 3 And b.对象类型 = 1 And a.内容文本 Like '%建议%' And a.文件id = r_Advice.文件id;
        
          If n_数量 <= 0 Then
            v_Error := '在诊疗单据中没有找到【建议】对应的提纲或表格，请联系管理员设置！';
            Raise Err_Custom;
          End If;
        End If;
      
        If r_Advice.病人来源 = 1 Then
          --门诊，提取挂号单ID
          Select Nvl(c.Id, 0)
          Into v_挂号单id
          From 病人医嘱记录 B, 病人挂号记录 C
          Where b.挂号单 = c.No(+) And c.记录状态 In (1, 3) And b.Id = v_主医嘱id;
        Else
          --体检或者外诊，无挂号单ID，直接设置为0
          v_挂号单id := 0;
        End If;
      
        --产生电子病历记录
        Select 电子病历记录_Id.Nextval Into v_病历id From Dual;
        n_Rptcount := Getrptno(医嘱id_In, r_Advice.病历名称);
        If n_Rptcount > 1 Then
          v_病历名称 := r_Advice.病历名称 || n_Rptcount;
        Else
          v_病历名称 := r_Advice.病历名称;
        End If;
        Insert Into 电子病历记录
          (ID, 病人来源, 病人id, 主页id, 婴儿, 科室id, 病历种类, 文件id, 病历名称, 创建人, 创建时间, 完成时间, 保存人, 保存时间, 最后版本, 签名级别)
        Values
          (v_病历id, r_Advice.病人来源, r_Advice.病人id, Decode(r_Advice.病人来源, 2, r_Advice.主页id, v_挂号单id), r_Advice.婴儿,
           r_Advice.病人科室id, r_Advice.病历种类, r_Advice.文件id, v_病历名称, 报告医生_In, Sysdate, Sysdate, 报告医生_In, Sysdate, 1, 2);
      
        --产生医嘱报告记录
        Insert Into 病人医嘱报告 (医嘱id, 病历id, Risid) Values (v_主医嘱id, v_病历id, Risid_In);
      
        v_对象序号 := 0;
      
        --新产生报告内容
        For r_File In c_File(r_Advice.文件id) Loop
          Select 电子病历内容_Id.Nextval Into v_病历内容id From Dual;
          v_内容文本   := r_File.内容文本;
          v_定义提纲id := 0;
        
          If Nvl(r_File.对象类型, 0) = 1 And Nvl(r_File.父id, 0) = 0 Then
            --提纲
            v_定义提纲id := r_File.Id;
            v_父id       := v_病历内容id;
          End If;
        
          If Nvl(r_File.对象类型, 0) = 4 And r_File.要素名称 Is Not Null Then
            --元素
            v_内容文本 := Zl_Replace_Element_Value(r_File.要素名称, r_Advice.病人id, r_Advice.主页id, r_Advice.病人来源, r_Advice.Id);
          End If;
        
          If Nvl(r_File.父id, 0) <> 0 Then
            v_定义提纲id := 0;
          End If;
        
          v_对象序号 := v_对象序号 + 1;
        
          If Instr(v_表格, '|' || r_File.父id || '|') > 0 Then
            Null;
          Else
            Insert Into 电子病历内容
              (ID, 文件id, 开始版, 终止版, 父id, 对象序号, 对象类型, 对象标记, 保留对象, 对象属性, 内容行次, 内容文本, 是否换行, 预制提纲id, 复用提纲, 使用时机, 诊治要素id, 替换域,
               要素名称, 要素类型, 要素长度, 要素小数, 要素单位, 要素表示, 输入形态, 要素值域, 定义提纲id)
            Values
              (v_病历内容id, v_病历id, 1, 0, Decode(v_定义提纲id, 0, v_父id, Null), v_对象序号, r_File.对象类型, r_File.对象标记, r_File.保留对象,
               r_File.对象属性, Null, v_内容文本, r_File.是否换行, r_File.预制提纲id, r_File.复用提纲, r_File.使用时机, r_File.诊治要素id,
               r_File.替换域, r_File.要素名称, r_File.要素类型, r_File.要素长度, r_File.要素小数, r_File.要素单位, r_File.要素表示, r_File.输入形态,
               r_File.要素值域, Decode(v_定义提纲id, 0, Null, v_定义提纲id));
          End If;
        
          --为表格时，插入文本内容
          If Nvl(r_File.对象类型, 0) = 3 And Nvl(r_File.父id, 0) <> 0 Then
            v_表格 := v_表格 || ',|' || r_File.Id || '|';
          
            If r_File.内容文本 Like '%所见%' Then
              v_内容文本 := 报告所见_In || Chr(13) || Chr(13);
            Elsif r_File.内容文本 Like '%意见%' Then
              v_内容文本 := 报告意见_In || Chr(13) || Chr(13);
            Else
              v_内容文本 := 报告建议_In || Chr(13) || Chr(13);
            End If;
          
            For r_Con In c_Content(r_Advice.文件id, r_File.Id) Loop
              Select 电子病历内容_Id.Nextval Into v_病历内容idnew From Dual;
              v_对象序号 := v_对象序号 + 1;
            
              Insert Into 电子病历内容
                (ID, 文件id, 开始版, 终止版, 父id, 对象序号, 对象类型, 对象标记, 保留对象, 对象属性, 内容行次, 内容文本, 是否换行, 预制提纲id, 复用提纲, 使用时机, 诊治要素id,
                 替换域, 要素名称, 要素类型, 要素长度, 要素小数, 要素单位, 要素表示, 输入形态, 要素值域, 定义提纲id)
              Values
                (v_病历内容idnew, v_病历id, 1, 0, v_病历内容id, v_对象序号, 2, r_Con.对象标记, r_Con.保留对象, r_Con.对象属性, Null, v_内容文本,
                 r_Con.是否换行, r_Con.预制提纲id, r_Con.复用提纲, r_Con.使用时机, r_Con.诊治要素id, r_Con.替换域, r_Con.要素名称, r_Con.要素类型,
                 r_Con.要素长度, r_Con.要素小数, r_Con.要素单位, r_Con.要素表示, r_Con.输入形态, r_Con.要素值域,
                 Decode(v_定义提纲id, 0, Null, v_定义提纲id));
            End Loop;
          End If;
        End Loop;
      
        --因电子病历格式中含了内容文字格式，此种方法导入之后内容文字将不可见
        --Select 内容 Into v_格式内容 From 病历文件格式 Where 文件ID=r_Advice.文件ID;
        --Insert Into 电子病历格式 (文件ID,内容) Values (v_病历id,v_格式内容);
      
      End If;
    End If;
    Close c_Advice;
  
  Exception
    When Err_Custom Then
      Raise_Application_Error(-20101, '[ZLSOFT]' || v_Error || '[ZLSOFT]');
    When Others Then
      zl_ErrorCenter(SQLCode, SQLErrM);
  End Receivereport;

  --5、修改申请单信息
  Procedure 影像病人信息_修改
  (
    医嘱id_In       病人医嘱记录.Id%Type,
    姓名_In         病人信息.姓名%Type,
    性别_In         病人信息.性别%Type,
    年龄_In         病人信息.年龄%Type,
    费别_In         病人信息.费别%Type,
    医疗付款方式_In 病人信息.医疗付款方式%Type,
    民族_In         病人信息.民族%Type,
    婚姻_In         病人信息.婚姻状况%Type,
    职业_In         病人信息.职业%Type,
    身份证号_In     病人信息.身份证号%Type,
    家庭地址_In     病人信息.家庭地址%Type,
    家庭电话_In     病人信息.家庭电话%Type,
    家庭地址邮编_In 病人信息.家庭地址邮编%Type,
    出生日期_In     病人信息.出生日期%Type := Null
  ) As
  
    v_年龄     Varchar2(20);
    v_年龄单位 Varchar2(20);
    v_出生日期 Date;
    v_病人来源 病人医嘱记录.病人来源%Type;
    v_病人id   病人医嘱记录.病人id%Type;
  Begin
    Begin
      Select 病人来源, 病人id Into v_病人来源, v_病人id From 病人医嘱记录 Where ID = 医嘱id_In;
    Exception
      When Others Then
        Return;
    End;
  
    If 出生日期_In Is Null And 年龄_In Is Not Null Then
      --根据年龄求出生日期
      v_年龄单位 := Substr(年龄_In, Length(年龄_In), 1);
      If Instr('岁,月,天', v_年龄单位) <= 0 Then
        v_年龄单位 := Null;
      Else
        v_年龄 := Replace(年龄_In, v_年龄单位, '');
      End If;
      Begin
        v_年龄 := To_Number(v_年龄);
      Exception
        When Others Then
          v_年龄 := Null;
      End;
      If v_年龄 Is Not Null And v_年龄单位 Is Not Null Then
        Select Decode(v_年龄单位, '岁', Add_Months(Sysdate, -12 * v_年龄), '月', Add_Months(Sysdate, -1 * v_年龄), '天',
                       Sysdate - v_年龄)
        Into v_出生日期
        From Dual;
      End If;
    Else
      v_出生日期 := 出生日期_In;
    End If;
  
    If v_病人来源 = 3 Then
      Update 病人信息
      Set 姓名 = 姓名_In, 性别 = Nvl(性别_In, 性别), 年龄 = 年龄_In, 出生日期 = v_出生日期, 费别 = Nvl(费别_In, 费别),
          医疗付款方式 = Nvl(医疗付款方式_In, 医疗付款方式), 民族 = Nvl(民族_In, 民族), 婚姻状况 = Nvl(婚姻_In, 婚姻状况), 职业 = Nvl(职业_In, 职业),
          身份证号 = 身份证号_In, 家庭地址 = 家庭地址_In, 家庭电话 = 家庭电话_In, 家庭地址邮编 = 家庭地址邮编_In
      Where 病人id = v_病人id;
    
      --修改对应的医嘱记录
      Update 病人医嘱记录
      Set 姓名 = 姓名_In, 性别 = 性别_In, 年龄 = 年龄_In
      Where ID = 医嘱id_In Or 相关id = 医嘱id_In;
    Else
      Update 病人信息
      Set 民族 = Nvl(民族_In, 民族), 婚姻状况 = Nvl(婚姻_In, 婚姻状况), 职业 = Nvl(职业_In, 职业), 家庭地址 = 家庭地址_In, 家庭电话 = 家庭电话_In,
          家庭地址邮编 = 家庭地址邮编_In
      Where 病人id = v_病人id;
    End If;
  Exception
    When Others Then
      zl_ErrorCenter(SQLCode, SQLErrM);
  End 影像病人信息_修改;

  --6、取消申请单信息
  Procedure 取消检查申请单
  (
    医嘱id_In     病人医嘱执行.医嘱id%Type,
    操作员编号_In 人员表.编号%Type := Null,
    操作员姓名_In 人员表.姓名%Type := Null,
    执行部门id_In 门诊费用记录.执行部门id%Type := 0,
    拒绝原因_In   病人医嘱发送.执行说明%Type := Null
  ) As
    --参数：医嘱ID_IN=单独执行的医嘱ID
  
    v_发送号 病人医嘱执行.发送号%Type;
  
  Begin
  
    Begin
      Select 发送号 Into v_发送号 From 病人医嘱发送 Where 医嘱id = 医嘱id_In;
    Exception
      When Others Then
        Return;
    End;
  
    Zl_病人医嘱执行_拒绝执行(医嘱id_In, v_发送号, 操作员编号_In, 操作员姓名_In, 执行部门id_In, 拒绝原因_In);
  
  Exception
    When Others Then
      zl_ErrorCenter(SQLCode, SQLErrM);
  End 取消检查申请单;

  --7、插入医嘱操作失败记录
  Procedure Ris医嘱失败记录_Insert
  (
    病人来源_In   In Ris医嘱失败记录.病人来源%Type,
    病人id_In     In Ris医嘱失败记录.病人id%Type,
    主页id_In     In Ris医嘱失败记录.主页id%Type,
    挂号单号_In   In Ris医嘱失败记录.挂号单号%Type,
    发送号_In     In Ris医嘱失败记录.发送号%Type,
    体检任务id_In In Ris医嘱失败记录.体检任务id%Type,
    体检报到号_In In Ris医嘱失败记录.体检报到号%Type,
    发送类型_In   In Ris医嘱失败记录.发送类型%Type
  ) Is
  Begin
    Insert Into Ris医嘱失败记录
      (ID, 病人来源, 病人id, 主页id, 挂号单号, 发送号, 体检任务id, 体检报到号, 发送类型, 发送时间, 重发次数)
    Values
      (Ris医嘱失败记录_Id.Nextval, 病人来源_In, 病人id_In, 主页id_In, 挂号单号_In, 发送号_In, 体检任务id_In, 体检报到号_In, 发送类型_In, Sysdate, 0);
  
  Exception
    When Others Then
      zl_ErrorCenter(SQLCode, SQLErrM);
  End Ris医嘱失败记录_Insert;

  --8、更新医嘱操作失败记录
  Procedure Ris医嘱失败记录_重发
  (
    Id_In       In Ris医嘱失败记录.Id%Type,
    操作类型_In In Number
  ) Is
    v_重发次数 Ris医嘱失败记录.重发次数%Type;
  Begin
    --操作类型_In -- 1 重发成功，删除记录；2--重发失败
  
    If 操作类型_In = 1 Then
      Delete From Ris医嘱失败记录 Where ID = Id_In;
    Else
      Select 重发次数 Into v_重发次数 From Ris医嘱失败记录 Where ID = Id_In;
      If v_重发次数 >= 99 Then
        v_重发次数 := 99;
      Else
        v_重发次数 := v_重发次数 + 1;
      End If;
      Update Ris医嘱失败记录 Set 发送时间 = Sysdate, 重发次数 = v_重发次数 Where ID = Id_In;
    End If;
  
  Exception
    When Others Then
      zl_ErrorCenter(SQLCode, SQLErrM);
  End Ris医嘱失败记录_重发;

  --9、销账后新建住院记账单据
  Procedure 病人医嘱_重建单据
  (
    医嘱id_In In 病人医嘱发送.医嘱id%Type,
    No_In     In 病人医嘱发送.No%Type,
    Action_In In Number
  ) Is
    -- Action_In: 1 重建单据；2 取消重建单据
    v_No 病人医嘱发送.No%Type;
  Begin
    If Action_In = 1 Then
      Select Nextno(14) Into v_No From Dual;
    
      Update 病人医嘱发送
      Set NO = v_No, 计费状态 = 0
      Where 医嘱id In (Select ID From 病人医嘱记录 Where ID = 医嘱id_In Or 相关id = 医嘱id_In);
      Update 住院费用记录 Set 医嘱序号 = Null Where NO = No_In;
    Elsif Action_In = 2 Then
      Update 住院费用记录 Set 医嘱序号 = 医嘱id_In Where NO = No_In;
      Update 病人医嘱发送
      Set NO = No_In, 计费状态 = 4
      Where 医嘱id In (Select ID From 病人医嘱记录 Where ID = 医嘱id_In Or 相关id = 医嘱id_In);
    End If;
  
  Exception
    When Others Then
      zl_ErrorCenter(SQLCode, SQLErrM);
  End 病人医嘱_重建单据;

  --10、打印RIS检查预约通知单
  Procedure Ris检查预约_打印(医嘱id_In In Ris检查预约.医嘱id%Type) Is
  Begin
    Update Ris检查预约 Set 是否打印 = 1 Where 医嘱id = 医嘱id_In;
  Exception
    When Others Then
      zl_ErrorCenter(SQLCode, SQLErrM);
  End Ris检查预约_打印;

  --11、更新RIS分科室启用参数
  Procedure Ris启用控制_Update
  (
    检查类型_In Ris启用控制.检查类型%Type,
    场合_In     Ris启用控制.场合%Type,
    部门ids_In  Varchar2,
    启用类型_In Number
  ) Is
  
    l_部门id   t_Numlist := t_Numlist();
    v_启用ris  Ris启用控制.是否启用ris%Type;
    v_启用预约 Ris启用控制.是否启用预约%Type;
  
    Cursor c_Dept(Dept_In Varchar2) Is
      Select Column_Value From Table(f_Num2list(Dept_In));
  Begin
  
    If 启用类型_In = 1 Then
      v_启用ris  := 1;
      v_启用预约 := Null;
      Delete From Ris启用控制 Where 检查类型 = 检查类型_In And 场合 = 场合_In And 是否启用ris = 1;
    Else
      v_启用ris  := Null;
      v_启用预约 := 1;
      Delete From Ris启用控制 Where 检查类型 = 检查类型_In And 场合 = 场合_In And 是否启用预约 = 1;
    End If;
  
    If 部门ids_In Is Null Then
      Insert Into Ris启用控制
        (ID, 检查类型, 场合, 部门id, 是否启用ris, 是否启用预约)
      Values
        (Ris启用控制_Id.Nextval, 检查类型_In, 场合_In, Null, v_启用ris, v_启用预约);
    Else
      Open c_Dept(部门ids_In);
      Fetch c_Dept Bulk Collect
        Into l_部门id;
      Close c_Dept;
    
      Forall I In 1 .. l_部门id.Count
        Insert Into Ris启用控制
          (ID, 检查类型, 场合, 部门id, 是否启用ris, 是否启用预约)
        Values
          (Ris启用控制_Id.Nextval, 检查类型_In, 场合_In, l_部门id(I), v_启用ris, v_启用预约);
    End If;
  
  Exception
    When Others Then
      zl_ErrorCenter(SQLCode, SQLErrM);
  End Ris启用控制_Update;

  --12、删除RIS分科室启用参数
  Procedure Ris启用控制_Delete Is
  
  Begin
    Delete From Ris启用控制;
  Exception
    When Others Then
      zl_ErrorCenter(SQLCode, SQLErrM);
  End Ris启用控制_Delete;

  --13、根据元素名提取信息
  Function Ris_Replace_Element_Value
  (
    元素名_In   In 诊治所见项目.中文名%Type,
    病人id_In   In 电子病历记录.病人id%Type,
    就诊id_In   In 电子病历记录.主页id%Type,
    病人来源_In In 电子病历记录.病人来源%Type,
    医嘱id_In   In 病人医嘱发送.医嘱id%Type
  ) Return Varchar2 Is
    v_Return Varchar2(4000) := Null;
    Cursor c_Patient Is
      Select 姓名, 性别, Decode(性别, '男', 'M', '女', 'F', 'O') As 性别编码, 出生日期, 病人id, 联系人地址, 家庭电话, 联系人电话, 婚姻状况, 身份证号, 当前科室id,
             当前病区id, 当前床号 As 床号, 就诊卡号, 入院时间, 出院时间
      From 病人信息
      Where 病人id = 病人id_In;
    r_Patient c_Patient%RowType;
  
    Cursor c_Order Is
      Select 主页id, 婴儿, Decode(病人来源, 1, 'OUTPAT', 2, 'INPAT', 'UNK') As 病人来源, 开嘱医生, 开嘱时间, 校对护士, 医嘱内容, 紧急标志, 执行科室id
      From 病人医嘱记录
      Where ID = 医嘱id_In;
    r_Order c_Order%RowType;
  
    Cursor c_Diagnose Is
      Select 诊断描述 || Decode(Nvl(是否疑诊, 0), 0, '', ' (？)') As 临床诊断
      From 病人诊断医嘱 A, 病人诊断记录 B
      Where a.医嘱id = 医嘱id_In And a.诊断id = b.Id;
    r_Diagnose c_Diagnose%RowType;
  
    --获取指定表的行类型
    Procedure p_Get_Rowtype(Table_In In Varchar2) Is
    Begin
      If Table_In = '病人信息' Then
        Open c_Patient;
        Fetch c_Patient
          Into r_Patient;
      Elsif Table_In = '病人医嘱记录' Then
        Open c_Order;
        Fetch c_Order
          Into r_Order;
      Elsif Table_In = '病人诊断记录' Then
        Open c_Diagnose;
        Fetch c_Diagnose
          Into r_Diagnose;
      End If;
    Exception
      When Others Then
        Null;
    End p_Get_Rowtype;
  
  Begin
    Case
    --直接返回的输入元素
      When 元素名_In = '医嘱ID' Then
        v_Return := 医嘱id_In;
      When 元素名_In = '病人ID' Then
        v_Return := 病人id_In;
      
    --姓名，性别单独处理，可能是婴儿
      When Instr(',姓名,性别,性别编码,出生日期,', ',' || 元素名_In || ',') > 0 Then
        p_Get_Rowtype('病人医嘱记录');
        p_Get_Rowtype('病人信息');
        If Nvl(r_Order.婴儿, 0) = 0 Then
          If 元素名_In = '姓名' Then
            v_Return := r_Patient.姓名;
          Elsif 元素名_In = '性别' Then
            v_Return := r_Patient.性别;
          Elsif 元素名_In = '性别编码' Then
            v_Return := r_Patient.性别编码;
          Elsif 元素名_In = '出生日期' Then
            v_Return := To_Char(r_Patient.出生日期, 'YYYYMMDDMISS');
          End If;
        Else
          If 元素名_In = '姓名' Then
            Select Decode(婴儿姓名, Null, r_Patient.姓名 || '之婴' || Trim(To_Char(序号, '9')), 婴儿姓名) As 婴儿姓名
            Into v_Return
            From 病人新生儿记录
            Where 病人id = 病人id_In And 主页id = r_Order.主页id And 序号 = Nvl(r_Order.婴儿, 0);
          Elsif Instr('性别', 元素名_In) > 0 Then
            Select 婴儿性别
            Into v_Return
            From 病人新生儿记录
            Where 病人id = 病人id_In And 主页id = r_Order.主页id And 序号 = Nvl(r_Order.婴儿, 0);
            If 元素名_In = '性别编码' Then
              Select Decode(v_Return, '男', 'M', '女', 'F', 'O') Into v_Return From Dual;
            End If;
          Elsif 元素名_In = '出生日期' Then
            Select 出生时间
            Into v_Return
            From 病人新生儿记录
            Where 病人id = 病人id_In And 主页id = r_Order.主页id And 序号 = Nvl(r_Order.婴儿, 0);
            v_Return := To_Char(v_Return, 'YYYYMMDDMISS');
          End If;
        End If;
      
    --查询病人信息表返回的元素
      When Instr(',联系人地址,家庭电话,联系人电话,婚姻状况,身份证号,床号,就诊卡号,入院时间,出院时间,', ',' || 元素名_In || ',') > 0 Then
        p_Get_Rowtype('病人信息');
        Case 元素名_In
          When '联系人地址' Then
            v_Return := r_Patient.联系人地址;
          When '家庭电话' Then
            v_Return := r_Patient.家庭电话;
          When '联系人电话' Then
            v_Return := r_Patient.联系人电话;
          When '婚姻状况' Then
            v_Return := r_Patient.婚姻状况;
          When '身份证号' Then
            v_Return := r_Patient.身份证号;
          When '床号' Then
            v_Return := r_Patient.床号;
          When '就诊卡号' Then
            v_Return := r_Patient.就诊卡号;
          When '入院时间' Then
            v_Return := To_Char(r_Patient.入院时间, 'YYYYMMDDMISS');
          When '出院时间' Then
            v_Return := To_Char(r_Patient.出院时间, 'YYYYMMDDMISS');
          Else
            v_Return := '';
        End Case;
        --查询医嘱表返回的元素
      When Instr(',病人来源,开嘱医生,开嘱时间,校对护士,医嘱内容,紧急标志,紧急标志对码,', ',' || 元素名_In || ',') > 0 Then
        p_Get_Rowtype('病人医嘱记录');
        Case 元素名_In
          When '病人来源' Then
            v_Return := r_Order.病人来源;
          When '开嘱医生' Then
            v_Return := r_Order.开嘱医生;
          When '开嘱时间' Then
            v_Return := To_Char(r_Order.开嘱时间, 'YYYYMMDDMISS');
          When '校对护士' Then
            v_Return := r_Order.校对护士;
          When '医嘱内容' Then
            v_Return := r_Order.医嘱内容;
          When '紧急标志' Then
            v_Return := r_Order.紧急标志;
        End Case;
        --查询诊断记录返回的元素
      When 元素名_In = '临床诊断' Then
        p_Get_Rowtype('病人诊断记录');
        v_Return := r_Diagnose.临床诊断;
      
      Else
        --自行查询SQL返回值的元素
        If 元素名_In = '执行站点' Then
          p_Get_Rowtype('病人医嘱记录');
          Select Decode(站点, 1, 'SITE0002', 2, 'SITE0001', 3, 'SITE0003', 'SITE0001')
          Into v_Return
          From 部门表
          Where ID = r_Order.执行科室id;
        End If;
        If 元素名_In = '当前科室名称' Then
          p_Get_Rowtype('病人信息');
          Select 名称 Into v_Return From 部门表 Where ID = r_Patient.当前科室id;
        End If;
        If 元素名_In = '病区名称' Then
          p_Get_Rowtype('病人信息');
          Select 名称 Into v_Return From 部门表 Where ID = r_Patient.当前病区id;
        End If;
        If 元素名_In = '标识号' Then
          Select Decode(a.病人来源, 1, c.门诊号, 2, Decode(c.住院号, Null, c.门诊号, c.住院号), 4, c.健康号, c.门诊号)
          Into v_Return
          From 病人医嘱记录 A, 病人信息 C
          Where a.病人id = c.病人id And a.Id = 医嘱id_In;
        End If;
    End Case;
  
    Return Trim(v_Return);
  Exception
    When Others Then
      Return Null;
  End Ris_Replace_Element_Value;
End b_Zlxwinterface;
/

--112222:焦博,2017-08-21,读取结帐时间的判断的条件不完整,导致漏掉部分的收费记录
Create Or Replace Procedure Zl_Third_Settlement
(
  Xml_In  In Xmltype,
  Xml_Out Out Xmltype
) Is

  --------------------------------------------------------------------------------------------------
  --功能:三方接口结帐
  --入参:Xml_In:
  --<IN>
  --        <BRID>病人ID</BRID>         //病人ID
  --        <XM>姓名</XM>               //姓名
  --        <SFZH>身份证号</SFZH>       //身份证号
  --        <ZYID>主页ID</ZYID>         //主页ID
  --        <JSLX>2</JSLX>         //结算类型,1-门诊,2-住院.目前固定传2
  --        <JE></JE>         //本次结算总金额
  --       <JSLIST>
  --         <JS>
  --              <JSKLB>支付卡类别</JSKLB >
  --              <JSKH>支付卡号</ JSKH >
  --              <JSFS>支付方式</JSFS> //支付方式:现金;支票,如果是三方卡,可以传空
  --              <JSJE>结算金额</JSJE> //结算金额(正金额：个人补款，负金额：医院退款)<SFCYJ>为1时为冲预交金额
  --              <JYLSH>交易流水号</JYLSH>
  --              <ZY>摘要</ZY>
  --              <SFCYJ>是否冲预交</SFCYJ>  //是否冲预交，0-结算，1-冲预交.允冲预交时,只填JSJE节点
  --              <SFXFK>是否消费卡</SFXFK>  //(1-是消费卡),消费卡时,传入结算卡类别,结算卡号,结算金额等接点
  --              <EXPENDLIST>  //扩展交易信息
  --                  <EXPEND>
  --                        <JYMC>交易名称</JYMC> //交易名称   退款时,传入冲预交的流水号
  --                        <JYLR>交易内容</JYLR> //交易内容   退款时,传入冲预交的金额
  --                  </EXPEND>
  --              </EXPENDLIST>
  --         </JS>
  --       </JSLIST >
  --</IN>

  --出参:Xml_Out
  --  <OUT>
  --       <CZSJ>操作时间</CZSJ>          //HIS的登记时间
  --    DD如无下列错误结点则说明正确执行
  --    <ERROR>
  --      <MSG>错误信息</MSG>
  --    </ERROR>
  --  </OUT>
  --------------------------------------------------------------------------------------------------
  n_主页id     病案主页.主页id%Type;
  n_病人id     病案主页.病人id%Type;
  v_姓名       病人信息.姓名%Type;
  v_身份证号   病人信息.身份证号%Type;
  n_结帐总额   病人预交记录.冲预交%Type;
  n_待结帐金额 病人预交记录.冲预交%Type;
  n_结算类型   Number(3);
  v_操作员编码 病人结帐记录.操作员编号%Type;
  v_操作员姓名 病人结帐记录.操作员姓名%Type;
  n_结帐id     病人结帐记录.Id%Type;
  n_冲预交金额 病人预交记录.冲预交%Type;
  d_结帐时间   Date;
  n_预交充值   病人预交记录.金额%Type;
  d_开始日期   Date;
  n_存在       Number(3);
  n_预交id     病人预交记录.Id%Type;
  n_科室id     病案主页.入院科室id%Type;
  d_结束日期   Date;
  n_结算卡序号 卡消费接口目录.编号%Type;
  n_时间类型   Number(3);
  v_Ids        Varchar2(20000);
  v_消费卡结算 Varchar2(5000);
  v_No         病人结帐记录.No%Type;
  v_预交no     病人预交记录.No%Type;
  n_卡类别id   医疗卡类别.Id%Type;
  v_结算卡号   病人预交记录.卡号%Type;
  v_结算方式   病人预交记录.结算方式%Type;
  v_Temp       Varchar2(500);
  x_Templet    Xmltype; --模板XML
  v_Err_Msg    Varchar2(200);
  v_卡类别     三方交易记录.类别%Type;
  Err_Item Exception;
  Err_Special Exception;
  n_Count Number(18);

Begin
  x_Templet := Xmltype('<OUTPUT></OUTPUT>');

  Select Extractvalue(Value(A), 'IN/ZYID'), To_Number(Extractvalue(Value(A), 'IN/BRID')),
         To_Number(Extractvalue(Value(A), 'IN/JE')), To_Number(Extractvalue(Value(A), 'IN/JSLX')),
         Extractvalue(Value(A), 'IN/SFZH'), Extractvalue(Value(A), 'IN/XM')
  Into n_主页id, n_病人id, n_结帐总额, n_结算类型, v_身份证号, v_姓名
  From Table(Xmlsequence(Extract(Xml_In, 'IN'))) A;
  n_结算类型 := Nvl(n_结算类型, 2);
  If n_结算类型 = 1 And Nvl(n_病人id, 0) = 0 And Not v_身份证号 Is Null And Not v_姓名 Is Null Then
    n_病人id := Zl_Third_Getpatiid(v_身份证号, v_姓名);
  End If;
  --0.相关检查
  If Nvl(n_病人id, 0) = 0 Then
    v_Err_Msg := '不能有效识别病人身份,不允许缴费!';
    Raise Err_Item;
  End If;

  --人员id,人员编号,人员姓名
  v_Temp := Zl_Identity(1);
  If Nvl(v_Temp, '0') = '0' Or Nvl(v_Temp, '_') = '_' Then
    v_Err_Msg := '系统不能认别有效的操作员,不允许结算!';
    Raise Err_Item;
  End If;
  v_Temp       := Substr(v_Temp, Instr(v_Temp, ';') + 1);
  v_Temp       := Substr(v_Temp, Instr(v_Temp, ',') + 1);
  v_操作员编码 := Substr(v_Temp, 1, Instr(v_Temp, ',') - 1);
  v_Temp       := Substr(v_Temp, Instr(v_Temp, ',') + 1);
  v_操作员姓名 := v_Temp;
  v_Err_Msg    := Null;

  For c_交易记录 In (Select Extractvalue(b.Column_Value, '/JS/JSKLB') As 结算卡类别,
                        Extractvalue(b.Column_Value, '/JS/JSFS') As 结算方式,
                        Extractvalue(b.Column_Value, '/JS/JYLSH') As 交易流水号,
                        Extractvalue(b.Column_Value, '/JS/JSKH') As 结算卡号, Extractvalue(b.Column_Value, '/JS/ZY') As 摘要
                 From Table(Xmlsequence(Extract(Xml_In, '/IN/JSLIST/JS'))) B) Loop
  
    If c_交易记录.结算卡类别 Is Null Then
      v_卡类别 := c_交易记录.结算方式;
    Else
      Select Decode(Translate(Nvl(c_交易记录.结算卡类别, 'abcd'), '#1234567890', '#'), Null, 1, 0)
      Into n_Count
      From Dual;
    
      If Nvl(n_Count, 0) = 1 Then
        Select Max(名称) Into v_卡类别 From 医疗卡类别 Where ID = To_Number(c_交易记录.结算卡类别);
      Else
        Select Max(名称) Into v_卡类别 From 医疗卡类别 Where 名称 = c_交易记录.结算卡类别;
      End If;
    End If;
    If v_卡类别 Is Null Then
      v_Err_Msg := '不支持的结算方式,请检查！';
      Raise Err_Item;
    End If;
  
    If Zl_Fun_三方交易记录_Locked(v_卡类别, c_交易记录.交易流水号, c_交易记录.结算卡号, c_交易记录.摘要, 2) = 0 Then
      v_Err_Msg := '交易流水号为:' || c_交易记录.交易流水号 || '的交易正在进行中，不允许再次提交此交易!';
      Raise Err_Special;
    End If;
  
  End Loop;

  Select 病人结帐记录_Id.Nextval, Sysdate, Nextno(15) Into n_结帐id, d_结帐时间, v_No From Dual;
  n_时间类型 := zl_GetSysParameter('结帐费用时间', 1137);

  If n_结算类型 = 2 Then
    Select Trunc(Min(Decode(n_时间类型, 0, 登记时间, 发生时间))), Trunc(Max(Decode(n_时间类型, 0, 登记时间, 发生时间))), Sum(未结金额)
    Into d_开始日期, d_结束日期, n_待结帐金额
    From (Select NO, 序号, 登记时间, 发生时间, Sum(Nvl(实收金额, 0)) - Sum(Nvl(结帐金额, 0)) As 未结金额
           From 住院费用记录
           Where 病人id = n_病人id And 记录状态 <> 0 And 主页id = n_主页id And 记帐费用 = 1
           Group By NO, 序号, 登记时间, 发生时间
           Having(Sum(Nvl(实收金额, 0)) - Sum(Nvl(结帐金额, 0)) <> 0) Or (Sum(Nvl(实收金额, 0)) = 0 And Sum(Nvl(应收金额, 0)) <> 0 And Sum(Nvl(结帐金额, 0)) = 0 And Mod(Count(*), 2) = 0) Or Sum(Nvl(结帐金额, 0)) = 0 And Sum(Nvl(应收金额, 0)) <> 0 And Mod(Count(*), 2) = 0);
  
    If n_待结帐金额 <> n_结帐总额 Then
      v_Err_Msg := '传入的结帐金额与实际结帐金额不符,不允许结算!';
      Raise Err_Item;
    End If;
    Begin
      Select 入院科室id Into n_科室id From 病案主页 Where 病人id = n_病人id And 主页id = n_主页id;
    Exception
      When Others Then
        n_科室id := Null;
    End;
  
    Zl_病人结帐记录_Insert(n_结帐id, v_No, n_病人id, d_结帐时间, d_开始日期, d_结束日期, 0, 0, n_主页id, Null, 2, Null, 2);
  
    For r_费用 In (Select Min(ID) As ID, Mod(记录性质, 10) As 记录性质, NO, 序号, 记录状态, 执行状态,
                        Sum(Nvl(实收金额, 0)) - Sum(Nvl(结帐金额, 0)) As 金额, Sum(Nvl(结帐金额, 0)) As 结帐金额
                 From 住院费用记录
                 Where 病人id = n_病人id And 记录状态 <> 0 And 主页id = n_主页id And 记帐费用 = 1
                 Group By Mod(记录性质, 10), NO, 序号, 记录状态, 执行状态
                 Having Sum(Nvl(实收金额, 0)) - Sum(Nvl(结帐金额, 0)) <> 0
                 Order By NO, 序号) Loop
      If Nvl(r_费用.结帐金额, 0) = 0 Then
        Begin
          Select 1 Into n_存在 From 住院费用记录 Where ID = r_费用.Id And 结帐id Is Null;
        Exception
          When Others Then
            n_存在 := 0;
        End;
        If n_存在 = 1 Then
          v_Ids := v_Ids || ',' || r_费用.Id;
        Else
          Zl_结帐费用记录_Insert(0, r_费用.No, r_费用.记录性质, r_费用.记录状态, r_费用.执行状态, r_费用.序号, r_费用.金额, n_结帐id);
        End If;
      Else
        Zl_结帐费用记录_Insert(0, r_费用.No, r_费用.记录性质, r_费用.记录状态, r_费用.执行状态, r_费用.序号, r_费用.金额, n_结帐id);
      End If;
    End Loop;
  
    If v_Ids Is Not Null Then
      v_Ids := Substr(v_Ids, 2);
      Zl_结帐费用记录_Batch(v_Ids, n_病人id, n_结帐id);
    End If;
  
    n_Count := 0;
    For r_结算方式 In (Select Extractvalue(b.Column_Value, '/JS/JSKLB') As 结算卡类别,
                          Extractvalue(b.Column_Value, '/JS/JSKH') As 结算卡号,
                          Extractvalue(b.Column_Value, '/JS/JSFS') As 结算方式,
                          Extractvalue(b.Column_Value, '/JS/JSJE') As 结算金额,
                          Extractvalue(b.Column_Value, '/JS/JYLSH') As 交易流水号,
                          Extractvalue(b.Column_Value, '/JS/JYSM') As 交易说明, Extractvalue(b.Column_Value, '/JS/ZY') As 摘要,
                          Extractvalue(b.Column_Value, '/JS/SFCYJ') As 是否冲预交,
                          Extractvalue(b.Column_Value, '/JS/SFXFK') As 是否消费卡
                   From Table(Xmlsequence(Extract(Xml_In, '/IN/JSLIST/JS'))) B) Loop
      If Nvl(r_结算方式.是否冲预交, 0) = 0 Then
        --付款
        If n_Count = 1 Then
          v_Err_Msg := '结帐结算暂不支持多种结算方式!';
          Raise Err_Item;
        End If;
        If Nvl(r_结算方式.是否消费卡, 0) = 1 Then
          Begin
            n_结算卡序号 := To_Number(r_结算方式.结算卡类别);
          Exception
            When Others Then
              n_结算卡序号 := 0;
          End;
          If n_结算卡序号 = 0 Then
            Begin
              Select 编号
              Into n_结算卡序号
              From 卡消费接口目录
              Where 名称 = r_结算方式.结算卡类别 And Nvl(启用, 0) = 1;
            Exception
              When Others Then
                v_Err_Msg := '未找到对应的消费卡!';
                Raise Err_Item;
            End;
          End If;
          If v_结算方式 Is Null Then
            Select 结算方式 Into v_结算方式 From 卡消费接口目录 Where 编号 = n_结算卡序号;
          End If;
        Else
          Begin
            n_卡类别id := To_Number(r_结算方式.结算卡类别);
          Exception
            When Others Then
              n_卡类别id := 0;
          End;
          If n_卡类别id = 0 Then
            Begin
              Select ID Into n_卡类别id From 医疗卡类别 Where 名称 = r_结算方式.结算卡类别 And Nvl(是否启用, 0) = 1;
            Exception
              When Others Then
                v_Err_Msg := '未找到对应的医疗卡!';
                Raise Err_Item;
            End;
          End If;
          If v_结算方式 Is Null Then
            Select 结算方式 Into v_结算方式 From 医疗卡类别 Where ID = n_卡类别id;
          End If;
        End If;
      
        If n_卡类别id Is Not Null Then
          --三方卡,生成住院预交款
          v_结算卡号 := r_结算方式.结算卡号;
          If r_结算方式.结算金额 > 0 Then
            Select 病人预交记录_Id.Nextval, Nextno(11) Into n_预交id, v_预交no From Dual;
            Zl_病人预交记录_Insert(n_预交id, v_预交no, Null, n_病人id, n_主页id, n_科室id, r_结算方式.结算金额, v_结算方式, '', '', '', '', '',
                             v_操作员编码, v_操作员姓名, Null, 2, n_卡类别id, Null, r_结算方式.结算卡号, r_结算方式.交易流水号, r_结算方式.交易说明, Null,
                             d_结帐时间, 0);
            n_预交充值 := Nvl(n_预交充值, 0) + r_结算方式.结算金额;
          Else
          
            Zl_结帐缴款记录_Insert(v_No, n_病人id, n_主页id, n_科室id, v_结算方式, Null, r_结算方式.结算金额, n_结帐id, v_操作员编码, v_操作员姓名, d_结帐时间,
                             Null, Null, Null, Null, Null, n_卡类别id, r_结算方式.结算卡号, r_结算方式.交易流水号, r_结算方式.交易说明);
          
          End If;
        Else
          If n_结算卡序号 Is Not Null Then
            --消费卡
            v_结算卡号   := r_结算方式.结算卡号;
            v_消费卡结算 := n_结算卡序号 || '|' || r_结算方式.结算卡号 || '|0|' || r_结算方式.结算金额 || '||';
            Zl_结帐缴款记录_Insert(v_No, n_病人id, n_主页id, n_科室id, v_结算方式, Null, r_结算方式.结算金额, n_结帐id, v_操作员编码, v_操作员姓名, d_结帐时间,
                             Null, Null, Null, Null, Null, n_卡类别id, r_结算方式.结算卡号, r_结算方式.交易流水号, r_结算方式.交易说明, v_消费卡结算);
          Else
            --其他结算
            Zl_结帐缴款记录_Insert(v_No, n_病人id, n_主页id, n_科室id, v_结算方式, Null, r_结算方式.结算金额, n_结帐id, v_操作员编码, v_操作员姓名, d_结帐时间,
                             Null, Null, Null, Null, Null, n_卡类别id, r_结算方式.结算卡号, r_结算方式.交易流水号, r_结算方式.交易说明);
          End If;
        End If;
      
        n_Count := 1;
      End If;
      If r_结算方式.结算卡类别 Is Null Then
        v_卡类别 := r_结算方式.结算方式;
      Else
        Select Decode(Translate(Nvl(r_结算方式.结算卡类别, 'abcd'), '#1234567890', '#'), Null, 1, 0)
        Into n_Count
        From Dual;
      
        If Nvl(n_Count, 0) = 1 Then
          Select Max(名称) Into v_卡类别 From 医疗卡类别 Where ID = To_Number(r_结算方式.结算卡类别);
        Else
          Select Max(名称) Into v_卡类别 From 医疗卡类别 Where 名称 = r_结算方式.结算卡类别;
        End If;
      End If;
      Update 三方交易记录
      Set 业务结算id = n_结帐id
      Where 流水号 = r_结算方式.交易流水号 And 类别 = v_卡类别 And 业务类型 = 2;
    End Loop;
  
    For r_结算方式 In (Select Extractvalue(b.Column_Value, '/JS/JSKLB') As 结算卡类别,
                          Extractvalue(b.Column_Value, '/JS/JSKH') As 结算卡号,
                          Extractvalue(b.Column_Value, '/JS/JSFS') As 结算方式,
                          Extractvalue(b.Column_Value, '/JS/JSJE') As 结算金额,
                          Extractvalue(b.Column_Value, '/JS/JYLSH') As 交易流水号,
                          Extractvalue(b.Column_Value, '/JS/JYSM') As 交易说明, Extractvalue(b.Column_Value, '/JS/ZY') As 摘要,
                          Extractvalue(b.Column_Value, '/JS/SFCYJ') As 是否冲预交,
                          Extractvalue(b.Column_Value, '/JS/SFXFK') As 是否消费卡
                   From Table(Xmlsequence(Extract(Xml_In, '/IN/JSLIST/JS'))) B) Loop
      If Nvl(r_结算方式.是否冲预交, 0) = 1 Then
        --冲预交,目前默认全冲
        n_冲预交金额 := r_结算方式.结算金额 + Nvl(n_预交充值, 0);
        For r_预交 In (Select Min(ID) As ID, NO, 结算方式, Sum(Nvl(金额, 0)) - Sum(Nvl(冲预交, 0)) As 金额, 交易流水号
                     From 病人预交记录
                     Where 病人id = n_病人id And Mod(记录性质, 10) = 1 And Nvl(预交类别, 2) = 2 And (主页id = n_主页id Or 主页id Is Null)
                     Group By NO, 结算方式, 交易流水号
                     Having Sum(Nvl(金额, 0)) - Sum(Nvl(冲预交, 0)) <> 0) Loop
          Zl_结帐预交记录_Insert(r_预交.Id, r_预交.No, 1, r_预交.金额, n_结帐id, n_病人id);
          n_冲预交金额 := n_冲预交金额 - Nvl(r_预交.金额, 0);
        End Loop;
        If n_冲预交金额 <> 0 Then
          v_Err_Msg := '传入的预交冲销金额与实际不符,请检查!';
          Raise Err_Item;
        End If;
      End If;
      If r_结算方式.结算卡类别 Is Null Then
        v_卡类别 := r_结算方式.结算方式;
      Else
        Select Decode(Translate(Nvl(r_结算方式.结算卡类别, 'abcd'), '#1234567890', '#'), Null, 1, 0)
        Into n_Count
        From Dual;
      
        If Nvl(n_Count, 0) = 1 Then
          Select Max(名称) Into v_卡类别 From 医疗卡类别 Where ID = To_Number(r_结算方式.结算卡类别);
        Else
          Select Max(名称) Into v_卡类别 From 医疗卡类别 Where 名称 = r_结算方式.结算卡类别;
        End If;
      End If;
      Update 三方交易记录
      Set 业务结算id = n_结帐id
      Where 流水号 = r_结算方式.交易流水号 And 类别 = v_卡类别 And 业务类型 = 2;
    End Loop;
  
    --处理扩展信息
    If Nvl(n_卡类别id, 0) <> 0 Then
      If n_预交id Is Not Null Then
        For c_扩展信息 In (Select Extractvalue(b.Column_Value, '/EXPEND/JYMC') As 交易名称,
                              Extractvalue(b.Column_Value, '/EXPEND/JYLR') As 交易内容
                       From Table(Xmlsequence(Extract(Xml_In, '/IN/JSLIST/JS/EXPENDLIST/EXPEND'))) B) Loop
          Zl_三方结算交易_Insert(n_卡类别id, 0, v_结算卡号, n_预交id, c_扩展信息.交易名称 || '|' || c_扩展信息.交易内容, 1);
        End Loop;
      Else
        For c_扩展信息 In (Select Extractvalue(b.Column_Value, '/EXPEND/JYMC') As 交易名称,
                              Extractvalue(b.Column_Value, '/EXPEND/JYLR') As 交易内容
                       From Table(Xmlsequence(Extract(Xml_In, '/IN/JSLIST/JS/EXPENDLIST/EXPEND'))) B) Loop
          Zl_三方结算交易_Insert(n_卡类别id, 0, v_结算卡号, n_结帐id, c_扩展信息.交易名称 || '|' || c_扩展信息.交易内容, 0);
        End Loop;
      End If;
    End If;
    If Nvl(n_结算卡序号, 0) <> 0 Then
      For c_扩展信息 In (Select Extractvalue(b.Column_Value, '/EXPEND/JYMC') As 交易名称,
                            Extractvalue(b.Column_Value, '/EXPEND/JYLR') As 交易内容
                     From Table(Xmlsequence(Extract(Xml_In, '/IN/JSLIST/JS/EXPENDLIST/EXPEND'))) B) Loop
        Zl_三方结算交易_Insert(n_结算卡序号, 1, v_结算卡号, n_结帐id, c_扩展信息.交易名称 || '|' || c_扩展信息.交易内容, 0);
      End Loop;
    End If;
  End If;
  Update 病人预交记录 Set 校对标志 = 0 Where 结帐id = n_结帐id And Nvl(校对标志, 0) <> 0;
  v_Temp := '<CZSJ>' || To_Char(d_结帐时间, 'YYYY-MM-DD hh24:mi:ss') || '</CZSJ>';
  Select Appendchildxml(x_Templet, '/OUTPUT', Xmltype(v_Temp)) Into x_Templet From Dual;
  Xml_Out := x_Templet;
Exception
  When Err_Item Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20101, v_Temp);
  When Err_Special Then
    v_Temp := '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]';
    Raise_Application_Error(-20105, v_Temp);
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_Third_Settlement;
/


--105604:胡俊勇,2017-08-10,成套方案调用缺省勾选状态
Create Or Replace Procedure Zl_成套方案项目_Update
(
  Id_In       诊疗项目目录.Id%Type,
  分类id_In   诊疗项目目录.分类id%Type,
  编码_In     诊疗项目目录.编码%Type,
  名称_In     诊疗项目目录.名称%Type,
  名称拼音_In 诊疗项目别名.简码%Type,
  名称五笔_In 诊疗项目别名.简码%Type,
  别名_In     诊疗项目目录.名称%Type,
  别名拼音_In 诊疗项目别名.简码%Type,
  别名五笔_In 诊疗项目别名.简码%Type,
  说明_In     诊疗项目目录.标本部位%Type,
  人员id_In   诊疗项目目录.人员id%Type := Null, --如果传入，表示个人使用的成套项目 
  科室id_In   Varchar2 := Null, --如果传入，表示可以使用的科室，格式为"ID1,ID2,..." 
  服务对象_In 诊疗项目目录.服务对象%Type := 3,
  站点_In     In 诊疗项目目录.站点%Type := Null,
  建档人_In   In 诊疗项目目录.建档人%Type := Null,
  全选_In     In 诊疗项目目录.执行分类%Type := Null --为1时医嘱下达调用本方案时默认全选所有项目，否则不选任何项目。
) Is
  v_科室串 Varchar2(4000);
  v_科室id 诊疗适用科室.科室id%Type;
Begin
  --配方名称修改或增加 
  Update 诊疗项目目录
  Set 分类id = 分类id_In, 编码 = 编码_In, 名称 = 名称_In, 标本部位 = 说明_In, 适用性别 = 0, 组合项目 = 1, 服务对象 = Nvl(服务对象_In, 3), 单独应用 = 1,
      人员id = 人员id_In, 站点 = 站点_In, 执行分类 = 全选_In
  Where ID = Id_In;
  If Sql%RowCount = 0 Then
    Insert Into 诊疗项目目录
      (类别, 分类id, ID, 编码, 名称, 标本部位, 适用性别, 组合项目, 服务对象, 单独应用, 建档时间, 撤档时间, 人员id, 站点, 建档人, 执行分类)
    Values
      ('9', 分类id_In, Id_In, 编码_In, 名称_In, 说明_In, 0, 1, Nvl(服务对象_In, 3), 1, Sysdate, To_Date('3000-01-01', 'YYYY-MM-DD'),
       人员id_In, 站点_In, 建档人_In, 全选_In);
  End If;
  --填写适用科室 
  Delete From 诊疗适用科室 Where 项目id = Id_In;
  If 科室id_In Is Not Null Then
    v_科室串 := 科室id_In || ',';
    While v_科室串 Is Not Null Loop
      v_科室id := To_Number(Substr(v_科室串, 1, Instr(v_科室串, ',') - 1));
      v_科室串 := Substr(v_科室串, Instr(v_科室串, ',') + 1);
    
      Insert Into 诊疗适用科室 (项目id, 科室id) Values (Id_In, v_科室id);
    End Loop;
  End If;
  --名称简码处理 
  If 名称_In Is Null Or 名称拼音_In Is Null Then
    Delete 诊疗项目别名 Where 诊疗项目id = Id_In And 性质 = 1 And 码类 = 1;
  Else
    Update 诊疗项目别名 Set 名称 = 名称_In, 简码 = 名称拼音_In Where 诊疗项目id = Id_In And 性质 = 1 And 码类 = 1;
    If Sql%RowCount = 0 Then
      Insert Into 诊疗项目别名 (诊疗项目id, 名称, 性质, 简码, 码类) Values (Id_In, 名称_In, 1, 名称拼音_In, 1);
    End If;
  End If;

  If 名称_In Is Null Or 名称五笔_In Is Null Then
    Delete 诊疗项目别名 Where 诊疗项目id = Id_In And 性质 = 1 And 码类 = 2;
  Else
    Update 诊疗项目别名 Set 名称 = 名称_In, 简码 = 名称五笔_In Where 诊疗项目id = Id_In And 性质 = 1 And 码类 = 2;
    If Sql%RowCount = 0 Then
      Insert Into 诊疗项目别名 (诊疗项目id, 名称, 性质, 简码, 码类) Values (Id_In, 名称_In, 1, 名称五笔_In, 2);
    End If;
  End If;

  --别名处理 
  If 别名_In Is Null Or 别名拼音_In Is Null Then
    Delete 诊疗项目别名 Where 诊疗项目id = Id_In And 性质 = 9 And 码类 = 1;
  Else
    Update 诊疗项目别名 Set 名称 = 别名_In, 简码 = 别名拼音_In Where 诊疗项目id = Id_In And 性质 = 9 And 码类 = 1;
    If Sql%RowCount = 0 Then
      Insert Into 诊疗项目别名 (诊疗项目id, 名称, 性质, 简码, 码类) Values (Id_In, 别名_In, 9, 别名拼音_In, 1);
    End If;
  End If;

  If 别名_In Is Null Or 别名五笔_In Is Null Then
    Delete 诊疗项目别名 Where 诊疗项目id = Id_In And 性质 = 9 And 码类 = 2;
  Else
    Update 诊疗项目别名 Set 名称 = 别名_In, 简码 = 别名五笔_In Where 诊疗项目id = Id_In And 性质 = 9 And 码类 = 2;
    If Sql%RowCount = 0 Then
      Insert Into 诊疗项目别名 (诊疗项目id, 名称, 性质, 简码, 码类) Values (Id_In, 别名_In, 9, 别名五笔_In, 2);
    End If;
  End If;

  --删除已有的方案内容 
  Delete From 诊疗项目组合 Where 诊疗组合id = Id_In;
Exception
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_成套方案项目_Update;
/

--115198:李业庆,2017-10-16,费用执行状态判断错误
--103561:李业庆,2017-10-16,更新门诊记账单的费用记录的执行状态
Create Or Replace Procedure Zl_药品收发记录_批量发料
(
  收发id_In     In Varchar2, --格式:id1,批次1|id2,批次2|.....
  库房id_In     In 药品收发记录.库房id%Type,
  审核人_In     In 药品收发记录.审核人%Type,
  审核日期_In   In 药品收发记录.审核日期%Type,
  发料方式_In   In 药品收发记录.发药方式%Type := 3, --1-处方发料;2-批量发料;3-部门发料;-1 停止发料
  领料人_In     In 药品收发记录.领用人%Type := Null,
  发料标识号_In In 药品收发记录.汇总发药号%Type := Null,
  配料人_In     In 药品收发记录.配药人%Type := Null,
  审核人编码_In In 人员表.编号%Type := Null
) Is
  --只读变量
  Err_Item Exception;
  v_Err_Msg Varchar2(255);

  v_批号     药品收发记录.批号%Type;
  v_上次产地 药品库存.上次产地%Type;
  v_批准文号 药品库存.批准文号%Type;

  v_Loop_Str Varchar2(4000);
  v_Fields   Varchar2(4000);

  n_Id       药品收发记录.Id%Type;
  n_批次     药品收发记录.批次%Type;
  n_成本价   药品收发记录.成本价%Type;
  n_库房id   药品收发记录.库房id%Type;
  n_库存金额 药品库存.实际金额%Type;
  n_库存差价 药品库存.实际差价%Type;
  n_未发数   未发药品记录.未发数%Type;
  --可写变量
  n_成本金额 药品收发记录.成本金额%Type;
  n_实际差价 药品收发记录.差价%Type;
  n_可用数量 药品收发记录.填写数量%Type;
  n_批次_Cur 药品收发记录.批次%Type;
  n_实价卫材 收费项目目录.是否变价%Type;

  n_上次供应商id       药品库存.上次供应商id%Type;
  n_上次采购价         药品库存.上次采购价%Type;
  n_执行状态           Number;
  n_差价率             Number;
  n_收费与发料分离     Number(1);
  n_小数               Number(2);
  n_允许未审核处方发料 Number(2);
  n_序号               Number;

  d_效期                   药品收发记录.效期%Type;
  d_上次生产日期           药品库存.上次生产日期%Type;
  n_门诊标志               Number(1);
  v_入库no                 药品收发记录.No%Type;
  v_入库库房id             药品收发记录.库房id%Type := 0;
  v_病人信息               Varchar2(200);
  v_备货                   Number(1);
  v_允许未审核记账单发料   Number(1);
  v_允许未收费的划价单发料 Number(1);
  v_自动审核记账单         Number(1);
  n_平均成本价             药品库存.平均成本价%Type;
Begin
  --获取金额小数位数
  Select Zl_To_Number(Nvl(zl_GetSysParameter(9), '2')) Into n_小数 From Dual;

  Select zl_GetSysParameter('允许未审核的记账处方发料') Into v_允许未审核记账单发料 From Dual;
  Select zl_GetSysParameter('执行后自动审核划价单') Into v_自动审核记账单 From Dual;
  Select zl_GetSysParameter('允许未收费的门诊划价处方发料') Into v_允许未收费的划价单发料 From Dual;

  If 收发id_In Is Null Then
    v_Loop_Str := Null;
  Else
    v_Loop_Str := 收发id_In || '|';
  End If;

  While v_Loop_Str Is Not Null Loop
    --分解单据ID串
    v_Fields   := Substr(v_Loop_Str, 1, Instr(v_Loop_Str, '|') - 1);
    n_Id       := Substr(v_Fields, 1, Instr(v_Fields, ',') - 1);
    n_批次     := Substr(v_Fields, Instr(v_Fields, ',') + 1);
    v_Loop_Str := Replace('|' || v_Loop_Str, '|' || v_Fields || '|');
  
    --检查相关操作
    v_Err_Msg := 'NO';
    For c_Check In (Select a.Id, a.单据, b.Id 费用id, a.No, b.No 费用no, b.病人id, Null 主页id, Null 病人病区id, b.病人科室id, b.开单部门id,
                           b.执行部门id, b.收入项目id, b.实收金额, b.操作员编号, b.操作员姓名, Nvl(b.记录状态, 0) As 审核标志, a.审核人,
                           Decode(Nvl(a.摘要, 'No拒发'), '拒发', 3, b.执行状态) 执行状态, 1 门诊标志
                    From 药品收发记录 A, 门诊费用记录 B
                    Where a.费用id = b.Id And a.Id = n_Id
                    Union All
                    Select a.Id, a.单据, b.Id 费用id, a.No, b.No 费用no, b.病人id, b.主页id, b.病人病区id, b.病人科室id, b.开单部门id, b.执行部门id,
                           b.收入项目id, b.实收金额, b.操作员编号, b.操作员姓名, Nvl(b.记录状态, 0) As 审核标志, a.审核人,
                           Decode(Nvl(a.摘要, 'No拒发'), '拒发', 3, b.执行状态) 执行状态, 2 门诊标志
                    From 药品收发记录 A, 住院费用记录 B
                    Where a.费用id = b.Id And a.Id = n_Id) Loop
      If Not (c_Check.审核人 Is Null) Then
        v_Err_Msg := '该处方[' || c_Check.No || ']已被其它操作员发料，操作被迫中止！';
        Raise Err_Item;
      End If;
      If Nvl(c_Check.执行状态, 0) = 3 Then
        v_Err_Msg := '该处方[' || c_Check.No || ']已拒发，操作被迫中止！';
        Raise Err_Item;
      End If;
    
      If Nvl(c_Check.审核标志, 0) = 0 And c_Check.单据 = 25 Then
        If v_允许未审核记账单发料 = 0 Then
          v_Err_Msg := '该处方[' || c_Check.No || ']还未审核，操作被迫中止！';
          Raise Err_Item;
        Else
          If v_自动审核记账单 = 1 Then
            --审核门诊和住院的单据
            If c_Check.操作员姓名 Is Null Then
              --审核门诊和住院的单据
              Zl_记帐记录_发料审核(c_Check.Id, c_Check.费用id, c_Check.费用no, c_Check.病人id, c_Check.主页id, c_Check.病人病区id,
                           c_Check.病人科室id, c_Check.开单部门id, c_Check.执行部门id, c_Check.收入项目id, c_Check.实收金额, 审核人编码_In,
                           审核人_In, c_Check.门诊标志, Null);
            Else
              --审核门诊和住院的单据
              Zl_记帐记录_发料审核(c_Check.Id, c_Check.费用id, c_Check.费用no, c_Check.病人id, c_Check.主页id, c_Check.病人病区id,
                           c_Check.病人科室id, c_Check.开单部门id, c_Check.执行部门id, c_Check.收入项目id, c_Check.实收金额, c_Check.操作员编号,
                           c_Check.操作员姓名, c_Check.门诊标志, Null);
            End If;
          End If;
        End If;
      End If;
    
      If Nvl(c_Check.审核标志, 0) = 0 And c_Check.单据 = 24 And v_允许未收费的划价单发料 = 0 Then
        v_Err_Msg := '该处方[' || c_Check.No || ']还未收费，操作被迫中止！';
        Raise Err_Item;
      End If;
    
      v_Err_Msg := 'Have';
    
      n_门诊标志 := c_Check.门诊标志;
    
    End Loop;
  
    If v_Err_Msg = 'NO' Then
      v_Err_Msg := '未找到指定单据,可能已经被其他操作员处理,操作被迫中止！';
      Raise Err_Item;
    End If;
  
    --获取该收发记录的单据、药品ID、库房ID,零售金额及实际数量、入出类别ID
    For c_收发 In (Select a.单据, a.No, a.药品id, a.库房id, a.费用id, a.零售价, Nvl(a.零售金额, 0) As 实际金额,
                        Nvl(a.实际数量, 0) * Nvl(a.付数, 1) As 实际数量, a.入出类别id, a.入出系数, Nvl(a.批次, 0) As 批次,
                        '[' || c.编码 || ']' || c.名称 As 名称, a.批号, a.效期, a.供药单位id, a.产地, a.生产日期, a.批准文号, a.商品条码, a.内部条码,
                        b.序号 As 费用序号
                 From 药品收发记录 A, 收费项目目录 C, 门诊费用记录 B
                 Where a.Id = n_Id And a.药品id = c.Id And a.费用id = b.Id
                 Union All
                 Select a.单据, a.No, a.药品id, a.库房id, a.费用id, a.零售价, Nvl(a.零售金额, 0) As 实际金额,
                        Nvl(a.实际数量, 0) * Nvl(a.付数, 1) As 实际数量, a.入出类别id, a.入出系数, Nvl(a.批次, 0) As 批次,
                        '[' || c.编码 || ']' || c.名称 As 名称, a.批号, a.效期, a.供药单位id, a.产地, a.生产日期, a.批准文号, a.商品条码, a.内部条码,
                        b.序号 As 费用序号
                 From 药品收发记录 A, 收费项目目录 C, 住院费用记录 B
                 Where a.Id = n_Id And a.药品id = c.Id And a.费用id = b.Id) Loop
      If Nvl(n_批次, 0) = 0 Then
        n_批次_Cur := c_收发.批次;
      Else
        n_批次_Cur := Nvl(n_批次, 0);
      End If;
    
      --检查是否已经填写库房
      n_收费与发料分离 := 0;
      If c_收发.库房id Is Null Then
        n_收费与发料分离 := 1;
      End If;
    
      n_库房id := 库房id_In;
      --取该批卫生材料的批号
      Begin
        Select 上次批号, 效期, Nvl(可用数量, 0), 上次供应商id, 上次产地, 上次生产日期, 批准文号, 上次采购价, Nvl(实际金额, 0) 实际金额, Nvl(实际差价, 0) 实际差价
        Into v_批号, d_效期, n_可用数量, n_上次供应商id, v_上次产地, d_上次生产日期, v_批准文号, n_上次采购价, n_库存金额, n_库存差价
        
        From 药品库存
        Where 库房id + 0 = n_库房id And 药品id = c_收发.药品id And 性质 = 1 And Nvl(批次, 0) = n_批次_Cur;
      Exception
        When Others Then
          n_库存金额   := 0;
          n_库存差价   := 0;
          n_上次采购价 := 0;
          n_可用数量   := 0;
      End;
    
      Begin
        Select 1
        Into v_备货
        From 药品收发记录
        Where 单据 = 21 And 审核日期 Is Null And 药品id = c_收发.药品id And Nvl(批次, 0) = c_收发.批次 And 费用id = c_收发.费用id And
              Rownum = 1;
      Exception
        When Others Then
          v_备货 := 0;
      End;
    
      --可用数量不足则退出
      If n_批次_Cur <> Nvl(c_收发.批次, 0) Then
        If v_备货 = 0 And n_可用数量 < Nvl(c_收发.实际数量, 0) And n_批次_Cur <> 0 Then
          v_Err_Msg := c_收发.名称 || '的可用数量不足，操作中止！';
          Raise Err_Item;
        End If;
      End If;
    
      n_成本价   := Round(Zl_Fun_Getoutcost(c_收发.药品id, c_收发.批次, n_库房id), 7);
      n_成本金额 := Round(n_成本价 * c_收发.实际数量, n_小数);
      n_实际差价 := Round(c_收发.实际金额 - n_成本金额, n_小数);
    
      --更新药品收发记录的零售金额、成本金额及差价
      Update 药品收发记录
      Set 成本价 = n_成本价, 成本金额 = n_成本金额, 差价 = n_实际差价, 库房id = n_库房id, 批次 = n_批次_Cur, 批号 = v_批号, 效期 = d_效期, 配药人 = 配料人_In,
          审核人 = 审核人_In, 审核日期 = 审核日期_In, 发药方式 = 发料方式_In, 领用人 = 领料人_In, 汇总发药号 = 发料标识号_In, 供药单位id = n_上次供应商id, 产地 = v_上次产地,
          生产日期 = d_上次生产日期, 批准文号 = v_批准文号
      Where ID = n_Id;
    
      --并发操作检查
      If Sql%RowCount = 0 Then
        v_Err_Msg := '不存在相关的发料记录，材料信息为:' || c_收发.名称 || '，操作中止！';
        Raise Err_Item;
      End If;
    
      --更新费用记录的执行状态(已执行)
      Select Decode(Sum(Nvl(付数, 1) * 实际数量), Null, 1, 0, 1, 2)
      Into n_执行状态
      From 药品收发记录
      Where 单据 = c_收发.单据 And NO = c_收发.No And 费用id = c_收发.费用id And 审核人 Is Null;
    
      If n_门诊标志 = 1 Then
        Update 门诊费用记录
        Set 执行状态 = n_执行状态, 执行部门id = 库房id_In, 执行人 = 审核人_In, 执行时间 = 审核日期_In
        Where NO = c_收发.No And (Mod(记录性质, 10) = 1 Or Mod(记录性质, 10) = 2) And 记录状态 <> 2 And 序号 = c_收发.费用序号;
      Else
        Update 住院费用记录
        Set 执行状态 = n_执行状态, 执行部门id = 库房id_In, 执行人 = 审核人_In, 执行时间 = 审核日期_In
        Where ID = c_收发.费用id;
      End If;
    
      --更新未发药品记录(如果未发数为零则删除)
      Select Count(*)
      Into n_未发数
      From 药品收发记录
      Where 单据 = c_收发.单据 And NO = c_收发.No And 审核人 Is Null And (库房id + 0 = n_库房id Or 库房id Is Null) And
            Nvl(LTrim(RTrim(摘要)), 'No_拒发') <> '拒发';
    
      If n_未发数 = 0 Then
        Delete 未发药品记录 Where 单据 = c_收发.单据 And NO = c_收发.No And (库房id + 0 = n_库房id Or 库房id Is Null);
      End If;
    
      Select 是否变价 Into n_实价卫材 From 收费项目目录 Where ID = c_收发.药品id;
    
      --更新原批次库存的可用数量
      --更新发料批次库存的可用及实际数量
      If c_收发.批次 <> n_批次_Cur Then
        Update 药品库存
        Set 可用数量 = Nvl(可用数量, 0) + c_收发.实际数量,
            零售价 = Decode(n_实价卫材, 1, Decode(Nvl(c_收发.批次, 0), 0, Null, Decode(Nvl(零售价, 0), 0, c_收发.零售价, 零售价)), Null)
        Where 性质 = 1 And 库房id + 0 = n_库房id And 药品id = c_收发.药品id And Nvl(批次, 0) = c_收发.批次;
      
        Update 药品库存
        Set 可用数量 = Nvl(可用数量, 0) - c_收发.实际数量,
            零售价 = Decode(n_实价卫材, 1, Decode(Nvl(n_批次_Cur, 0), 0, Null, Decode(Nvl(零售价, 0), 0, c_收发.零售价, 零售价)), Null)
        Where 性质 = 1 And 库房id + 0 = n_库房id And 药品id = c_收发.药品id And Nvl(批次, 0) = n_批次_Cur;
      End If;
    
      If n_收费与发料分离 = 1 Then
        Update 药品库存
        Set 可用数量 = Nvl(可用数量, 0) - c_收发.实际数量, 实际数量 = Nvl(实际数量, 0) - c_收发.实际数量, 实际金额 = Nvl(实际金额, 0) - c_收发.实际金额,
            实际差价 = Nvl(实际差价, 0) - n_实际差价,
            零售价 = Decode(n_实价卫材, 1, Decode(Nvl(n_批次_Cur, 0), 0, Null, Decode(Nvl(零售价, 0), 0, c_收发.零售价, 零售价)), Null),
            上次采购价 = Decode(上次采购价, Null, n_成本价, 上次采购价), 平均成本价 = Decode(平均成本价, Null, n_成本价, 平均成本价),
            商品条码 = Decode(商品条码, Null, c_收发.商品条码, 商品条码), 内部条码 = Decode(内部条码, Null, c_收发.内部条码, 内部条码),
            效期 = Decode(效期, Null, c_收发.效期, 效期), 上次批号 = Decode(上次批号, Null, c_收发.批号, 上次批号),
            上次生产日期 = Decode(上次生产日期, Null, c_收发.生产日期, 上次生产日期), 上次产地 = Decode(上次产地, Null, c_收发.产地, 上次产地)
        Where 库房id + 0 = n_库房id And 药品id = c_收发.药品id And 性质 = 1 And Nvl(批次, 0) = n_批次_Cur;
      Else
        Update 药品库存
        Set 实际数量 = Nvl(实际数量, 0) - c_收发.实际数量, 实际金额 = Nvl(实际金额, 0) - c_收发.实际金额, 实际差价 = Nvl(实际差价, 0) - n_实际差价,
            零售价 = Decode(n_实价卫材, 1, Decode(Nvl(n_批次_Cur, 0), 0, Null, Decode(Nvl(零售价, 0), 0, c_收发.零售价, 零售价)), Null),
            上次采购价 = Decode(上次采购价, Null, n_成本价, 上次采购价), 平均成本价 = Decode(平均成本价, Null, n_成本价, 平均成本价),
            商品条码 = Decode(商品条码, Null, c_收发.商品条码, 商品条码), 内部条码 = Decode(内部条码, Null, c_收发.内部条码, 内部条码),
            效期 = Decode(效期, Null, c_收发.效期, 效期), 上次批号 = Decode(上次批号, Null, c_收发.批号, 上次批号),
            上次生产日期 = Decode(上次生产日期, Null, c_收发.生产日期, 上次生产日期), 上次产地 = Decode(上次产地, Null, c_收发.产地, 上次产地)
        Where 库房id + 0 = n_库房id And 药品id = c_收发.药品id And 性质 = 1 And Nvl(批次, 0) = n_批次_Cur;
      End If;
    
      If Sql%RowCount = 0 Then
        If n_上次采购价 = 0 Then
          If Nvl(c_收发.实际数量, 0) = 0 Then
            n_上次采购价 := Round(n_成本金额, 5);
          Else
            n_上次采购价 := Round(n_成本金额 / c_收发.实际数量, 5);
          End If;
        
          Insert Into 药品库存
            (库房id, 药品id, 批次, 性质, 可用数量, 实际数量, 实际金额, 实际差价, 上次批号, 上次产地, 上次供应商id, 上次采购价, 上次生产日期, 批准文号, 效期, 零售价, 商品条码, 内部条码,
             平均成本价)
          Values
            (n_库房id, c_收发.药品id, n_批次_Cur, 1, 0 - c_收发.实际数量, 0 - c_收发.实际数量, 0 - c_收发.实际金额, 0 - n_实际差价, v_批号, v_上次产地,
             n_上次供应商id, n_上次采购价, d_上次生产日期, v_批准文号, d_效期,
             Decode(n_实价卫材, 1, Decode(Nvl(n_批次_Cur, 0), 0, Null, c_收发.零售价), Null), c_收发.商品条码, c_收发.内部条码, n_上次采购价);
        End If;
      
      End If;
      Delete 药品库存
      Where 性质 = 1 And 库房id + 0 = n_库房id And 药品id = c_收发.药品id And Nvl(可用数量, 0) = 0 And Nvl(实际数量, 0) = 0 And
            Nvl(实际金额, 0) = 0 And Nvl(实际差价, 0) = 0;
    
      If v_备货 = 1 Then
        --审核备货卫材在虚拟库房的其他出库单据
        For v_出库 In (Select 序号, NO, 库房id, 药品id, Nvl(批次, 0) As 批次, 实际数量, 成本价, 成本金额, 零售金额, 差价, 入出类别id
                     From 药品收发记录
                     Where 单据 = 21 And 审核日期 Is Null And 药品id = c_收发.药品id And Nvl(批次, 0) = c_收发.批次 And 费用id = c_收发.费用id) Loop
        
          Update 药品收发记录
          Set 汇总发药号 = n_Id
          Where 单据 = 21 And 审核日期 Is Null And 药品id = c_收发.药品id And Nvl(批次, 0) = c_收发.批次 And 费用id = c_收发.费用id;
        
          Zl_材料其他出库_Verify(v_出库.序号, v_出库.No, v_出库.库房id, v_出库.药品id, v_出库.批次, v_出库.实际数量, v_出库.成本价, v_出库.成本金额, v_出库.零售金额,
                           v_出库.差价, v_出库.入出类别id, 审核人_In, 审核日期_In);
        End Loop;
      
        --产生备货卫材在卫材仓库的外购入库单据
        For v_入库 In (Select NO, 序号, 供药单位id, 药品id, 产地, 批号, 生产日期, 效期, 灭菌日期, 灭菌效期, 实际数量, 成本价, 成本金额, 扣率, 零售价, 零售金额, 差价, 摘要,
                            注册证号, Nvl(批次, 0) As 批次, 商品条码, 内部条码
                     From 药品收发记录
                     Where 单据 = 21 And 审核日期 Is Not Null And 药品id = c_收发.药品id And Nvl(批次, 0) = c_收发.批次 And
                           费用id = c_收发.费用id And 汇总发药号 = n_Id) Loop
          Begin
            Select 库房id Into v_入库库房id From 虚拟库房对照 Where 科室id = c_收发.库房id;
          Exception
            When Others Then
              v_入库库房id := 0;
          End;
        
          If v_入库库房id > 0 Then
          
            --同一张发料单产生的入库单的NO要一致
            Select Max(NO), Max(序号) + 1
            Into v_入库no, n_序号
            From 药品收发记录
            Where 单据 = 15 And 审核日期 Is Null And 供药单位id = v_入库.供药单位id And
                  费用id In
                  (Select Distinct 费用id
                   From 药品收发记录
                   Where 单据 = 21 And 审核日期 Is Not Null And
                         NO = (Select Distinct NO
                               From 药品收发记录
                               Where 单据 = 21 And 审核日期 Is Not Null And 费用id = c_收发.费用id And 汇总发药号 = n_Id));
          
            If v_入库no Is Null Or v_入库no = '' Then
              --如果入库NO为Null, 产生新的入库单NO
              v_入库no := Nextno(68, v_入库库房id);
              n_序号   := 1;
            End If;
          
            Begin
              If n_门诊标志 = 1 Then
                Select b.名称 || ',' || a.姓名 || ',' || a.标识号 || ',' || '' As 病人信息
                Into v_病人信息
                From 门诊费用记录 A, 部门表 B
                Where a.病人科室id = b.Id And a.Id = c_收发.费用id;
              Else
                Select b.名称 || ',' || a.姓名 || ',' || a.标识号 || ',' || a.床号 As 病人信息
                Into v_病人信息
                From 住院费用记录 A, 部门表 B
                Where a.病人科室id = b.Id And a.Id = c_收发.费用id;
              End If;
            Exception
              When Others Then
                v_病人信息 := '';
            End;
          
            Zl_材料外购_Insert(v_入库no, n_序号, v_入库库房id, v_入库.供药单位id, v_入库.药品id, v_入库.产地, v_入库.批号, v_入库.生产日期, v_入库.效期,
                           v_入库.灭菌日期, v_入库.灭菌效期, v_入库.实际数量, v_入库.成本价, v_入库.成本金额, v_入库.扣率, v_入库.零售价, v_入库.零售金额, v_入库.差价,
                           Null, '【自动入账】' || v_入库.摘要, v_入库.注册证号, 审核人_In, Null, Null, Null, Null, 审核日期_In, Null, Null,
                           v_入库.批次, 1, v_病人信息, v_入库.商品条码, v_入库.内部条码, c_收发.费用id);
          End If;
        End Loop;
      End If;
    End Loop;
    --修正误差数据
    Zl_材料收发记录_调价修正(n_Id);
  End Loop;
Exception
  When Err_Item Then
    Raise_Application_Error(-20101, '[ZLSOFT]' || v_Err_Msg || '[ZLSOFT]');
  When Others Then
    zl_ErrorCenter(SQLCode, SQLErrM);
End Zl_药品收发记录_批量发料;
/




---------------------------------------------------------------------------------------------------
--更改系统及部件的版本号
-------------------------------------------------------------------------------------------------------

Insert Into Zltools.Zlfilesupgrade
  (序号, 加入日期, 安装路径, 文件类型, 文件名, 版本号, 修改日期, 所属系统, 业务部件, Md5, 文件说明, 自动注册, 强制覆盖, 附加安装路径)
  Select 序号, To_Date('2017-10-25', 'yyyy-mm-dd'), '[APPSOFT]\APPLY', 1, 'zlKnowledgeConvert.dll', Null, Null, '1',
         'zl9CISJob.dll', Null, '知识库中心药品说明书部件', 1, 0, Null
  From Dual a, (Select Nvl(Max(To_Number(序号)), 0) + 1 序号 From Zlfilesupgrade) b
  Where Not Exists (Select 1 From Zltools.Zlfilesupgrade Where Upper(文件名) = 'ZLKNOWLEDGECONVERT.DLL');
Insert Into Zltools.Zlfilesupgrade
  (序号, 加入日期, 安装路径, 文件类型, 文件名, 版本号, 修改日期, 所属系统, 业务部件, Md5, 文件说明, 自动注册, 强制覆盖, 附加安装路径)
  Select 序号, To_Date('2017-10-25', 'yyyy-mm-dd'), '[APPSOFT]', 1, 'zlPacsFtpTools.exe', Null, Null, '1',
         'ZL9PACSWORK.DLL', Null, '对PACS FTP服务器进行测试', 0, 0, Null
  From Dual a, (Select Nvl(Max(To_Number(序号)), 0) + 1 序号 From Zlfilesupgrade) b
  Where Not Exists (Select 1 From Zltools.Zlfilesupgrade Where Upper(文件名) = 'ZLPACSFTPTOOLS.EXE');
Insert Into Zltools.Zlfilesupgrade
  (序号, 加入日期, 安装路径, 文件类型, 文件名, 版本号, 修改日期, 所属系统, 业务部件, Md5, 文件说明, 自动注册, 强制覆盖, 附加安装路径)
  Select 序号, To_Date('2017-10-25', 'yyyy-mm-dd'), '[PUBLIC]', 0, 'zlDbaTools.dll', Null, Null, '1', Null, Null,
         'DBA管理工具', 1, 0, Null
  From Dual a, (Select Nvl(Max(To_Number(序号)), 0) + 1 序号 From Zlfilesupgrade) b
  Where Not Exists (Select 1 From Zltools.Zlfilesupgrade Where Upper(文件名) = 'ZLDBATOOLS.DLL');
Insert Into Zltools.Zlfilesupgrade
  (序号, 加入日期, 安装路径, 文件类型, 文件名, 版本号, 修改日期, 所属系统, 业务部件, Md5, 文件说明, 自动注册, 强制覆盖, 附加安装路径)
  Select 序号, To_Date('2017-10-25', 'yyyy-mm-dd'), '[APPSOFT]', 0, 'ZLSQLTrace.exe', Null, Null, '1', Null, Null,
         'SQL跟踪工具', 0, 0, Null
  From Dual a, (Select Nvl(Max(To_Number(序号)), 0) + 1 序号 From Zlfilesupgrade) b
  Where Not Exists (Select 1 From Zltools.Zlfilesupgrade Where Upper(文件名) = 'ZLSQLTRACE.EXE');
Insert Into Zltools.Zlfilesupgrade
  (序号, 加入日期, 安装路径, 文件类型, 文件名, 版本号, 修改日期, 所属系统, 业务部件, Md5, 文件说明, 自动注册, 强制覆盖, 附加安装路径)
  Select 序号, To_Date('2017-10-25', 'yyyy-mm-dd'), '[PUBLIC]', 0, 'zlPublicBlood.dll', Null, Null, '1', Null, Null,
         '血库业务封装公共部件', 1, 0, Null
  From Dual a, (Select Nvl(Max(To_Number(序号)), 0) + 1 序号 From Zlfilesupgrade) b
  Where Not Exists (Select 1 From Zltools.Zlfilesupgrade Where Upper(文件名) = 'ZLPUBLICBLOOD.DLL');

--系统版本号
Update zlSystems Set 版本号='10.34.130' Where 编号=&n_System;
--部件版本号
Commit;
