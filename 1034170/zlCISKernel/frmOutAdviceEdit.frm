VERSION 5.00
Object = "{BEEECC20-4D5F-4F8B-BFDC-5D9B6FBDE09D}#1.0#0"; "vsflex8.ocx"
Object = "{555E8FCC-830E-45CC-AF00-A012D5AE7451}#9.60#0"; "Codejock.CommandBars.9600.ocx"
Object = "{A8E5842E-102B-4289-9D57-3B3F5B5E15D3}#9.60#0"; "Codejock.SuiteCtrls.9600.ocx"
Object = "{831FDD16-0C5C-11D2-A9FC-0000F8754DA1}#2.1#0"; "MSCOMCTL.OCX"
Object = "{86CF1D34-0C5F-11D2-A9FC-0000F8754DA1}#2.0#0"; "MSCOMCT2.OCX"
Begin VB.Form frmOutAdviceEdit 
   AutoRedraw      =   -1  'True
   Caption         =   "√≈’Ô“Ω÷ˆ±‡º≠"
   ClientHeight    =   8385
   ClientLeft      =   120
   ClientTop       =   450
   ClientWidth     =   11130
   Icon            =   "frmOutAdviceEdit.frx":0000
   KeyPreview      =   -1  'True
   LinkTopic       =   "Form1"
   LockControls    =   -1  'True
   ScaleHeight     =   8385
   ScaleWidth      =   11130
   ShowInTaskbar   =   0   'False
   WindowState     =   2  'Maximized
   Begin XtremeSuiteControls.TabControl tbcSub 
      Height          =   1035
      Left            =   10845
      TabIndex        =   74
      Top             =   225
      Width           =   150
      _Version        =   589884
      _ExtentX        =   265
      _ExtentY        =   1826
      _StockProps     =   64
   End
   Begin VB.PictureBox picSub 
      Appearance      =   0  'Flat
      BackColor       =   &H80000005&
      BorderStyle     =   0  'None
      ForeColor       =   &H80000008&
      Height          =   8340
      Left            =   0
      ScaleHeight     =   8340
      ScaleWidth      =   11085
      TabIndex        =   73
      TabStop         =   0   'False
      Top             =   0
      Width           =   11085
      Begin VB.PictureBox pictmp 
         Appearance      =   0  'Flat
         AutoRedraw      =   -1  'True
         BackColor       =   &H80000005&
         BorderStyle     =   0  'None
         ForeColor       =   &H80000008&
         Height          =   240
         Left            =   9720
         ScaleHeight     =   240
         ScaleWidth      =   480
         TabIndex        =   69
         Top             =   2160
         Visible         =   0   'False
         Width           =   480
      End
      Begin VB.PictureBox pic“…Œ  
         Appearance      =   0  'Flat
         AutoRedraw      =   -1  'True
         BorderStyle     =   0  'None
         Enabled         =   0   'False
         ForeColor       =   &H80000008&
         Height          =   270
         Left            =   0
         ScaleHeight     =   270
         ScaleWidth      =   11070
         TabIndex        =   60
         TabStop         =   0   'False
         Top             =   5130
         Visible         =   0   'False
         Width           =   11070
         Begin VB.Label lbl“…Œ  
            BackColor       =   &H00C0C0FF&
            BackStyle       =   0  'Transparent
            ForeColor       =   &H000000C0&
            Height          =   180
            Left            =   495
            TabIndex        =   61
            Top             =   45
            Width           =   1725
         End
         Begin VB.Image Image1 
            Height          =   240
            Left            =   150
            Picture         =   "frmOutAdviceEdit.frx":058A
            Top             =   0
            Width           =   240
         End
      End
      Begin VB.Frame fra’Ô∂œ 
         Appearance      =   0  'Flat
         BackColor       =   &H00C0FFC0&
         BorderStyle     =   0  'None
         ForeColor       =   &H80000008&
         Height          =   660
         Left            =   0
         TabIndex        =   56
         Top             =   960
         Width           =   11060
         Begin VB.CommandButton cmdLastDiag 
            Caption         =   "…œ¥Œ’Ô∂œ"
            Height          =   300
            Left            =   50
            TabIndex        =   70
            TabStop         =   0   'False
            Top             =   320
            Width           =   900
         End
         Begin VB.OptionButton opt’Ô∂œ 
            Caption         =   "∞¥’Ô∂œ±Í◊º"
            Height          =   180
            Index           =   0
            Left            =   9840
            TabIndex        =   35
            TabStop         =   0   'False
            Top             =   100
            Value           =   -1  'True
            Width           =   1200
         End
         Begin VB.OptionButton opt’Ô∂œ 
            Caption         =   "∞¥º≤≤°±‡¬Î"
            Height          =   180
            Index           =   1
            Left            =   9820
            TabIndex        =   36
            TabStop         =   0   'False
            Top             =   380
            Width           =   1200
         End
         Begin VSFlex8Ctl.VSFlexGrid vsDiag 
            Height          =   630
            Left            =   975
            TabIndex        =   34
            TabStop         =   0   'False
            Top             =   0
            Width           =   8760
            _cx             =   15452
            _cy             =   1111
            Appearance      =   2
            BorderStyle     =   1
            Enabled         =   -1  'True
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "ÀŒÃÂ"
               Size            =   9
               Charset         =   134
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            MousePointer    =   0
            BackColor       =   -2147483643
            ForeColor       =   -2147483640
            BackColorFixed  =   -2147483633
            ForeColorFixed  =   -2147483630
            BackColorSel    =   13684944
            ForeColorSel    =   0
            BackColorBkg    =   -2147483643
            BackColorAlternate=   -2147483643
            GridColor       =   -2147483636
            GridColorFixed  =   -2147483636
            TreeColor       =   -2147483632
            FloodColor      =   192
            SheetBorder     =   -2147483643
            FocusRect       =   3
            HighLight       =   1
            AllowSelection  =   0   'False
            AllowBigSelection=   0   'False
            AllowUserResizing=   1
            SelectionMode   =   0
            GridLines       =   1
            GridLinesFixed  =   2
            GridLineWidth   =   1
            Rows            =   2
            Cols            =   20
            FixedRows       =   1
            FixedCols       =   0
            RowHeightMin    =   300
            RowHeightMax    =   0
            ColWidthMin     =   0
            ColWidthMax     =   0
            ExtendLastCol   =   0   'False
            FormatString    =   $"frmOutAdviceEdit.frx":0B14
            ScrollTrack     =   -1  'True
            ScrollBars      =   0
            ScrollTips      =   0   'False
            MergeCells      =   115
            MergeCompare    =   0
            AutoResize      =   -1  'True
            AutoSizeMode    =   0
            AutoSearch      =   0
            AutoSearchDelay =   2
            MultiTotals     =   -1  'True
            SubtotalPosition=   1
            OutlineBar      =   0
            OutlineCol      =   0
            Ellipsis        =   0
            ExplorerBar     =   0
            PicturesOver    =   0   'False
            FillStyle       =   0
            RightToLeft     =   0   'False
            PictureType     =   0
            TabBehavior     =   0
            OwnerDraw       =   0
            Editable        =   2
            ShowComboButton =   1
            WordWrap        =   0   'False
            TextStyle       =   0
            TextStyleFixed  =   0
            OleDragMode     =   0
            OleDropMode     =   0
            DataMode        =   0
            VirtualData     =   -1  'True
            DataMember      =   ""
            ComboSearch     =   3
            AutoSizeMouse   =   -1  'True
            FrozenRows      =   0
            FrozenCols      =   0
            AllowUserFreezing=   0
            BackColorFrozen =   0
            ForeColorFrozen =   0
            WallPaperAlignment=   9
            AccessibleName  =   ""
            AccessibleDescription=   ""
            AccessibleValue =   ""
            AccessibleRole  =   24
         End
         Begin VB.Label lbl’Ô∂œ 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "≤°»À’Ô∂œ"
            Height          =   180
            Left            =   120
            TabIndex        =   33
            Top             =   60
            Width           =   720
         End
      End
      Begin VB.Frame fraPati 
         Appearance      =   0  'Flat
         BackColor       =   &H00C0E0FF&
         BorderStyle     =   0  'None
         ForeColor       =   &H80000008&
         Height          =   450
         Left            =   0
         TabIndex        =   37
         Top             =   510
         Width           =   10995
         Begin VB.CommandButton cmdAlley 
            Caption         =   "π˝√Ù ∑/≤°…˙◊¥Ã¨"
            Height          =   350
            Left            =   9240
            TabIndex        =   32
            TabStop         =   0   'False
            Top             =   0
            Visible         =   0   'False
            Width           =   1530
         End
         Begin VB.ComboBox cbo”§∂˘ 
            Height          =   300
            ItemData        =   "frmOutAdviceEdit.frx":0CDD
            Left            =   9555
            List            =   "frmOutAdviceEdit.frx":0CF3
            Style           =   2  'Dropdown List
            TabIndex        =   31
            TabStop         =   0   'False
            Top             =   75
            Width           =   1395
         End
         Begin VB.Label lbl”§∂˘ 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "”§∂˘"
            Height          =   180
            Left            =   9135
            TabIndex        =   30
            Top             =   135
            Width           =   360
         End
         Begin VB.Label lblPati 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "–’√˚: –‘±: ƒÍ¡‰: √≈’Ô∫≈: ∑—±: “Ω¡∆∏∂øÓ∑Ω Ω:"
            ForeColor       =   &H00800000&
            Height          =   180
            Left            =   210
            TabIndex        =   38
            Top             =   135
            Width           =   4050
         End
      End
      Begin MSComCtl2.MonthView dtpDate 
         Height          =   2220
         Left            =   1725
         TabIndex        =   1
         Top             =   2505
         Visible         =   0   'False
         Width           =   2805
         _ExtentX        =   4948
         _ExtentY        =   3916
         _Version        =   393216
         ForeColor       =   -2147483630
         BackColor       =   -2147483633
         Appearance      =   1
         StartOfWeek     =   179830785
         TitleBackColor  =   -2147483636
         TitleForeColor  =   -2147483634
         TrailingForeColor=   -2147483637
         CurrentDate     =   37904
      End
      Begin VSFlex8Ctl.VSFlexGrid vsAdvice 
         Height          =   3645
         Left            =   60
         TabIndex        =   0
         Top             =   1650
         Width           =   10995
         _cx             =   19394
         _cy             =   6429
         Appearance      =   1
         BorderStyle     =   1
         Enabled         =   -1  'True
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "ÀŒÃÂ"
            Size            =   9
            Charset         =   134
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         MousePointer    =   0
         BackColor       =   -2147483643
         ForeColor       =   -2147483640
         BackColorFixed  =   -2147483633
         ForeColorFixed  =   -2147483630
         BackColorSel    =   16444122
         ForeColorSel    =   0
         BackColorBkg    =   -2147483643
         BackColorAlternate=   -2147483643
         GridColor       =   -2147483636
         GridColorFixed  =   -2147483636
         TreeColor       =   -2147483632
         FloodColor      =   192
         SheetBorder     =   -2147483643
         FocusRect       =   2
         HighLight       =   1
         AllowSelection  =   0   'False
         AllowBigSelection=   0   'False
         AllowUserResizing=   1
         SelectionMode   =   1
         GridLines       =   1
         GridLinesFixed  =   1
         GridLineWidth   =   1
         Rows            =   18
         Cols            =   11
         FixedRows       =   1
         FixedCols       =   1
         RowHeightMin    =   250
         RowHeightMax    =   2000
         ColWidthMin     =   0
         ColWidthMax     =   0
         ExtendLastCol   =   0   'False
         FormatString    =   $"frmOutAdviceEdit.frx":0D42
         ScrollTrack     =   -1  'True
         ScrollBars      =   3
         ScrollTips      =   0   'False
         MergeCells      =   0
         MergeCompare    =   0
         AutoResize      =   0   'False
         AutoSizeMode    =   1
         AutoSearch      =   0
         AutoSearchDelay =   2
         MultiTotals     =   -1  'True
         SubtotalPosition=   1
         OutlineBar      =   0
         OutlineCol      =   0
         Ellipsis        =   0
         ExplorerBar     =   0
         PicturesOver    =   0   'False
         FillStyle       =   0
         RightToLeft     =   0   'False
         PictureType     =   0
         TabBehavior     =   0
         OwnerDraw       =   1
         Editable        =   0
         ShowComboButton =   1
         WordWrap        =   -1  'True
         TextStyle       =   0
         TextStyleFixed  =   0
         OleDragMode     =   0
         OleDropMode     =   0
         DataMode        =   0
         VirtualData     =   -1  'True
         DataMember      =   ""
         ComboSearch     =   3
         AutoSizeMouse   =   -1  'True
         FrozenRows      =   0
         FrozenCols      =   0
         AllowUserFreezing=   0
         BackColorFrozen =   0
         ForeColorFrozen =   0
         WallPaperAlignment=   9
         AccessibleName  =   ""
         AccessibleDescription=   ""
         AccessibleValue =   ""
         AccessibleRole  =   24
         Begin MSComctlLib.ImageList img16 
            Left            =   1965
            Top             =   450
            _ExtentX        =   1005
            _ExtentY        =   1005
            BackColor       =   -2147483643
            ImageWidth      =   16
            ImageHeight     =   16
            MaskColor       =   16777215
            _Version        =   393216
            BeginProperty Images {2C247F25-8591-11D1-B16A-00C0F0283628} 
               NumListImages   =   4
               BeginProperty ListImage1 {2C247F27-8591-11D1-B16A-00C0F0283628} 
                  Picture         =   "frmOutAdviceEdit.frx":0E2A
                  Key             =   "æØ æ"
               EndProperty
               BeginProperty ListImage2 {2C247F27-8591-11D1-B16A-00C0F0283628} 
                  Picture         =   "frmOutAdviceEdit.frx":13C4
                  Key             =   "’Ô∂œ"
               EndProperty
               BeginProperty ListImage3 {2C247F27-8591-11D1-B16A-00C0F0283628} 
                  Picture         =   "frmOutAdviceEdit.frx":195E
                  Key             =   "’Ô∂œ_µ±«∞"
               EndProperty
               BeginProperty ListImage4 {2C247F27-8591-11D1-B16A-00C0F0283628} 
                  Picture         =   "frmOutAdviceEdit.frx":1EF8
                  Key             =   "’Ô∂œ_πÿ¡™"
               EndProperty
            EndProperty
         End
      End
      Begin VB.Frame fraAdvice 
         Height          =   2685
         Left            =   45
         TabIndex        =   39
         Top             =   5340
         Width           =   11040
         Begin VB.ComboBox cboDruPur 
            Height          =   300
            Left            =   960
            Style           =   2  'Dropdown List
            TabIndex        =   19
            Top             =   2220
            Width           =   1815
         End
         Begin VB.CommandButton cmdComExcReason 
            Height          =   300
            Left            =   10260
            Picture         =   "frmOutAdviceEdit.frx":2492
            Style           =   1  'Graphical
            TabIndex        =   72
            TabStop         =   0   'False
            ToolTipText     =   "Ω´µ±«∞Àµ√˜…Ë÷√Œ™≥£”√Àµ√˜"
            Top             =   1860
            Width           =   315
         End
         Begin VB.CommandButton cmdExcReason 
            Caption         =   "°≠"
            Height          =   265
            Left            =   9930
            TabIndex        =   71
            TabStop         =   0   'False
            Top             =   1875
            Width           =   285
         End
         Begin VB.TextBox txt≥¨¡øÀµ√˜ 
            BackColor       =   &H8000000F&
            Enabled         =   0   'False
            Height          =   300
            Left            =   6255
            MaxLength       =   500
            TabIndex        =   18
            Top             =   1875
            Width           =   3945
         End
         Begin VB.ComboBox cbo∑÷¡„ 
            Height          =   300
            Left            =   960
            Style           =   2  'Dropdown List
            TabIndex        =   66
            Top             =   1200
            Visible         =   0   'False
            Width           =   4260
         End
         Begin VB.CommandButton cmd“Ω…˙÷ˆÕ– 
            Caption         =   "°≠"
            Height          =   265
            Left            =   9960
            TabIndex        =   65
            TabStop         =   0   'False
            Top             =   573
            Width           =   285
         End
         Begin VB.TextBox cbo“Ω…˙÷ˆÕ– 
            Height          =   300
            Left            =   6255
            MaxLength       =   100
            TabIndex        =   24
            Top             =   555
            Width           =   4000
         End
         Begin VB.CommandButton cmd ’≤ÿ”√“©¿Ì”… 
            Height          =   300
            Left            =   10275
            Picture         =   "frmOutAdviceEdit.frx":2A1C
            Style           =   1  'Graphical
            TabIndex        =   64
            TabStop         =   0   'False
            ToolTipText     =   "Ω´µ±«∞¿Ì”……Ë÷√Œ™≥£”√¿Ì”…°£"
            Top             =   2250
            Width           =   315
         End
         Begin VB.CommandButton cmdReason 
            Caption         =   "°≠"
            Height          =   265
            Left            =   9930
            TabIndex        =   63
            TabStop         =   0   'False
            Top             =   2250
            Width           =   285
         End
         Begin VB.PictureBox picHelp 
            Appearance      =   0  'Flat
            BorderStyle     =   0  'None
            ForeColor       =   &H80000008&
            Height          =   255
            Left            =   5200
            Picture         =   "frmOutAdviceEdit.frx":2FA6
            ScaleHeight     =   255
            ScaleWidth      =   255
            TabIndex        =   62
            Top             =   900
            Visible         =   0   'False
            Width           =   255
         End
         Begin VB.CheckBox chk√‚ ‘ 
            Caption         =   "√‚ ‘"
            Height          =   180
            Left            =   4560
            TabIndex        =   5
            Top             =   255
            Visible         =   0   'False
            Width           =   660
         End
         Begin VB.TextBox txt”√“©¿Ì”… 
            Height          =   300
            Left            =   4860
            MaxLength       =   1000
            TabIndex        =   21
            Top             =   2250
            Width           =   5385
         End
         Begin VB.CheckBox chkZeroBilling 
            Caption         =   "∑¢ÀÕŒ™≤ª ’∑—µƒº«’ µ•(&F)"
            Height          =   225
            Left            =   8280
            TabIndex        =   23
            TabStop         =   0   'False
            Top             =   233
            Width           =   2370
         End
         Begin VB.ComboBox cboµŒÀŸ 
            Height          =   300
            Left            =   6255
            TabIndex        =   22
            Top             =   195
            Visible         =   0   'False
            Width           =   1050
         End
         Begin VB.CommandButton cmd∞≤≈≈ ±º‰ 
            Height          =   240
            Left            =   2490
            Picture         =   "frmOutAdviceEdit.frx":97F8
            Style           =   1  'Graphical
            TabIndex        =   10
            TabStop         =   0   'False
            ToolTipText     =   "—°‘Ò»’∆⁄(F4)"
            Top             =   1545
            Visible         =   0   'False
            Width           =   255
         End
         Begin VB.TextBox txt∞≤≈≈ ±º‰ 
            Height          =   300
            Left            =   960
            TabIndex        =   9
            Top             =   1515
            Visible         =   0   'False
            Width           =   1815
         End
         Begin VB.CommandButton cmd≥£”√÷ˆÕ– 
            Height          =   300
            Left            =   10275
            Picture         =   "frmOutAdviceEdit.frx":98EE
            Style           =   1  'Graphical
            TabIndex        =   25
            TabStop         =   0   'False
            ToolTipText     =   "Ω´µ±«∞÷ˆÕ–…Ë÷√Œ™≥£”√÷ˆÕ–(Ctrl+D)"
            Top             =   555
            Width           =   315
         End
         Begin VB.ComboBox cbo∏Ωº”÷¥–– 
            Height          =   300
            Left            =   6255
            TabIndex        =   29
            Text            =   "cbo∏Ωº”÷¥––"
            Top             =   1515
            Width           =   1860
         End
         Begin VB.TextBox txtÃÏ ˝ 
            Alignment       =   2  'Center
            Height          =   300
            Left            =   2385
            MaxLength       =   3
            TabIndex        =   16
            Top             =   1875
            Visible         =   0   'False
            Width           =   360
         End
         Begin VB.CommandButton cmd∆µ¬  
            Height          =   240
            Left            =   4920
            Picture         =   "frmOutAdviceEdit.frx":9E78
            Style           =   1  'Graphical
            TabIndex        =   14
            TabStop         =   0   'False
            ToolTipText     =   "—°‘ÒœÓƒø(F4)"
            Top             =   1545
            Width           =   270
         End
         Begin VB.TextBox txt∆µ¬  
            Height          =   300
            Left            =   3540
            TabIndex        =   13
            Top             =   1515
            Width           =   1665
         End
         Begin VB.TextBox txtµ•¡ø 
            Alignment       =   1  'Right Justify
            Height          =   300
            Left            =   3540
            MaxLength       =   10
            TabIndex        =   17
            Top             =   1875
            Width           =   1365
         End
         Begin VB.TextBox txt◊‹¡ø 
            Alignment       =   1  'Right Justify
            Height          =   300
            Left            =   960
            MaxLength       =   10
            TabIndex        =   15
            Top             =   1875
            Width           =   1530
         End
         Begin VB.CommandButton cmd”√∑® 
            Height          =   240
            Left            =   2445
            Picture         =   "frmOutAdviceEdit.frx":9F6E
            Style           =   1  'Graphical
            TabIndex        =   12
            TabStop         =   0   'False
            ToolTipText     =   "—°‘ÒœÓƒø(F4)"
            Top             =   1545
            Width           =   270
         End
         Begin VB.TextBox txt”√∑® 
            Height          =   300
            Left            =   960
            TabIndex        =   11
            Top             =   1515
            Width           =   1815
         End
         Begin VB.CommandButton cmdø™ º ±º‰ 
            Height          =   240
            Left            =   2460
            Picture         =   "frmOutAdviceEdit.frx":A064
            Style           =   1  'Graphical
            TabIndex        =   3
            TabStop         =   0   'False
            ToolTipText     =   "—°‘Ò»’∆⁄(F4)"
            Top             =   225
            Width           =   255
         End
         Begin VB.CheckBox chkΩÙº± 
            Caption         =   "ΩÙº±“Ω÷ˆ(&E)"
            Height          =   225
            Left            =   3000
            TabIndex        =   4
            TabStop         =   0   'False
            Top             =   233
            Width           =   1290
         End
         Begin VB.CommandButton cmdExt 
            Height          =   285
            Left            =   4920
            Picture         =   "frmOutAdviceEdit.frx":A15A
            Style           =   1  'Graphical
            TabIndex        =   7
            TabStop         =   0   'False
            ToolTipText     =   "±‡º≠(F4)"
            Top             =   552
            Width           =   285
         End
         Begin VB.CommandButton cmdSel 
            Caption         =   "°≠"
            Height          =   285
            Left            =   4920
            TabIndex        =   8
            TabStop         =   0   'False
            ToolTipText     =   "—°‘ÒœÓƒø(*)"
            Top             =   870
            Width           =   285
         End
         Begin VB.ComboBox cbo÷¥–––‘÷  
            Height          =   300
            ItemData        =   "frmOutAdviceEdit.frx":A250
            Left            =   9015
            List            =   "frmOutAdviceEdit.frx":A25D
            Style           =   2  'Dropdown List
            TabIndex        =   28
            Top             =   1200
            Width           =   1590
         End
         Begin VB.ComboBox cbo÷¥––ø∆ “ 
            Height          =   300
            Left            =   6255
            TabIndex        =   27
            Text            =   "cbo÷¥––ø∆ “"
            Top             =   1200
            Width           =   1860
         End
         Begin VB.TextBox txt“Ω÷ˆƒ⁄»› 
            Height          =   900
            Left            =   960
            MaxLength       =   1000
            MultiLine       =   -1  'True
            TabIndex        =   6
            ToolTipText     =   "∞¥ ~ º¸œ‘ æ≥…Ã◊∑Ω∞∏—°‘Ò∆˜,Ctrl+F1µ˜”√“Ω±£–≈œ¢"
            Top             =   552
            Width           =   3945
         End
         Begin VB.TextBox txtø™ º ±º‰ 
            Height          =   300
            Left            =   960
            TabIndex        =   2
            TabStop         =   0   'False
            Top             =   195
            Width           =   1815
         End
         Begin VB.ComboBox cbo÷¥–– ±º‰ 
            Height          =   300
            Left            =   6255
            TabIndex        =   26
            Top             =   877
            Width           =   4350
         End
         Begin VB.Label lbl≥¨¡øÀµ√˜ 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "≥¨¡øÀµ√˜"
            Height          =   180
            Left            =   5490
            TabIndex        =   20
            Top             =   1935
            Width           =   720
         End
         Begin VB.Label lbl∑÷¡„ 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "∑÷¡„∑Ω Ω"
            Height          =   180
            Left            =   180
            TabIndex        =   68
            Top             =   1260
            Visible         =   0   'False
            Width           =   720
         End
         Begin VB.Label lbl“Ω÷ˆƒ⁄»› 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "“Ω÷ˆƒ⁄»›"
            Height          =   180
            Left            =   180
            TabIndex        =   67
            Top             =   600
            Width           =   720
         End
         Begin VB.Label lbl”√“©ƒøµƒ 
            AutoSize        =   -1  'True
            Caption         =   "”√“©ƒøµƒ"
            Height          =   180
            Left            =   165
            TabIndex        =   59
            Top             =   2265
            Width           =   720
         End
         Begin VB.Label lbl”√“©¿Ì”… 
            AutoSize        =   -1  'True
            Caption         =   "”√“©¿Ì”…"
            Height          =   180
            Left            =   4080
            TabIndex        =   58
            Top             =   2280
            Width           =   720
         End
         Begin VB.Label lblµŒÀŸµ•Œª 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "µŒ/∑÷÷”"
            Height          =   180
            Left            =   7335
            TabIndex        =   55
            Top             =   255
            Visible         =   0   'False
            Width           =   630
         End
         Begin VB.Label lblµŒÀŸ 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "°˝µŒÀŸ"
            Height          =   180
            Left            =   5670
            TabIndex        =   54
            Top             =   255
            Visible         =   0   'False
            Width           =   540
         End
         Begin VB.Label lbl∞≤≈≈ ±º‰ 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "∞≤≈≈ ±º‰"
            Height          =   180
            Left            =   165
            TabIndex        =   53
            Top             =   1575
            Visible         =   0   'False
            Width           =   720
         End
         Begin VB.Label lbl∏Ωº”÷¥–– 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "∏Ωº”÷¥––"
            Height          =   180
            Left            =   5490
            TabIndex        =   52
            Top             =   1575
            Width           =   720
         End
         Begin VB.Label lblÃÏ ˝ 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "”√    ÃÏ"
            Height          =   180
            Left            =   2205
            TabIndex        =   51
            Top             =   1935
            Visible         =   0   'False
            Width           =   720
         End
         Begin VB.Label lbl∆µ¬  
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "∆µ¬ "
            Height          =   180
            Left            =   3135
            TabIndex        =   46
            Top             =   1575
            Width           =   360
         End
         Begin VB.Label lblµ•¡øµ•Œª 
            AutoSize        =   -1  'True
            BackColor       =   &H00C0C0FF&
            BackStyle       =   0  'Transparent
            Caption         =   "µ•Œª"
            Height          =   180
            Left            =   4905
            TabIndex        =   42
            Top             =   1935
            Width           =   360
         End
         Begin VB.Label lblµ•¡ø 
            Alignment       =   1  'Right Justify
            Appearance      =   0  'Flat
            AutoSize        =   -1  'True
            BackColor       =   &H00FFFFFF&
            BackStyle       =   0  'Transparent
            Caption         =   "°˝µ•¡ø"
            ForeColor       =   &H80000008&
            Height          =   180
            Left            =   2955
            TabIndex        =   41
            ToolTipText     =   "≥£”√º¡¡ø±»¿˝(Ctrl+~)"
            Top             =   1935
            Width           =   540
         End
         Begin VB.Label lbl◊‹¡øµ•Œª 
            BackStyle       =   0  'Transparent
            Caption         =   "µ•Œª"
            Height          =   180
            Left            =   2505
            TabIndex        =   44
            Top             =   1935
            Width           =   360
         End
         Begin VB.Label lbl◊‹¡ø 
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "◊‹¡ø"
            Height          =   180
            Left            =   540
            TabIndex        =   43
            Top             =   1935
            Width           =   360
         End
         Begin VB.Label lbl“Ω…˙÷ˆÕ– 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "“Ω…˙÷ˆÕ–"
            Height          =   180
            Left            =   5490
            TabIndex        =   50
            Top             =   615
            Width           =   720
         End
         Begin VB.Label lbl÷¥–––‘÷  
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "÷¥–––‘÷ "
            Height          =   180
            Left            =   8250
            TabIndex        =   49
            Top             =   1260
            Width           =   720
         End
         Begin VB.Label lbl÷¥––ø∆ “ 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "÷¥––ø∆ “"
            Height          =   180
            Left            =   5490
            TabIndex        =   48
            Top             =   1260
            Width           =   720
         End
         Begin VB.Label lbl”√∑® 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "”√∑®"
            Height          =   180
            Left            =   540
            TabIndex        =   45
            Top             =   1575
            Width           =   360
         End
         Begin VB.Label lblø™ º ±º‰ 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "ø™ º ±º‰"
            Height          =   180
            Left            =   180
            TabIndex        =   40
            Top             =   255
            Width           =   720
         End
         Begin VB.Label lbl÷¥–– ±º‰ 
            Alignment       =   1  'Right Justify
            AutoSize        =   -1  'True
            BackStyle       =   0  'Transparent
            Caption         =   "÷¥–– ±º‰"
            Height          =   180
            Left            =   5490
            TabIndex        =   47
            Top             =   937
            Width           =   720
         End
      End
      Begin MSComctlLib.StatusBar stbThis 
         Height          =   360
         Left            =   0
         TabIndex        =   57
         Top             =   8025
         Width           =   11130
         _ExtentX        =   19632
         _ExtentY        =   635
         _Version        =   393216
         BeginProperty Panels {8E3867A5-8586-11D1-B16A-00C0F0283628} 
            NumPanels       =   9
            BeginProperty Panel1 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
               AutoSize        =   2
               Bevel           =   2
               Object.Width           =   2355
               MinWidth        =   882
               Picture         =   "frmOutAdviceEdit.frx":A27F
               Text            =   "÷–¡™»Ìº˛"
               TextSave        =   "÷–¡™»Ìº˛"
               Key             =   "ZLFLAG"
               Object.ToolTipText     =   "ª∂”≠ π”√÷–¡™”–œﬁπ´Àæ»Ìº˛"
            EndProperty
            BeginProperty Panel2 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
               AutoSize        =   1
               Object.Width           =   12912
            EndProperty
            BeginProperty Panel3 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
               AutoSize        =   2
               Object.Width           =   318
               MinWidth        =   2
            EndProperty
            BeginProperty Panel4 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
               AutoSize        =   2
               Object.Width           =   318
               MinWidth        =   2
            EndProperty
            BeginProperty Panel5 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
               AutoSize        =   2
               Object.Width           =   318
               MinWidth        =   2
            EndProperty
            BeginProperty Panel6 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
               Object.Width           =   970
               MinWidth        =   970
               Picture         =   "frmOutAdviceEdit.frx":AB13
               Key             =   "KB"
            EndProperty
            BeginProperty Panel7 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
               Object.Width           =   617
               MinWidth        =   617
               Picture         =   "frmOutAdviceEdit.frx":B879
               Key             =   "PY"
               Object.ToolTipText     =   "∆¥“Ù(F7)"
            EndProperty
            BeginProperty Panel8 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
               Bevel           =   2
               Object.Width           =   617
               MinWidth        =   617
               Picture         =   "frmOutAdviceEdit.frx":BEB3
               Key             =   "WB"
               Object.ToolTipText     =   "ŒÂ± (F7)"
            EndProperty
            BeginProperty Panel9 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
               Alignment       =   1
               AutoSize        =   2
               Bevel           =   0
               Object.Width           =   953
               MinWidth        =   25
               Text            =   "º∆º€"
               TextSave        =   "º∆º€"
               Key             =   "Price"
               Object.ToolTipText     =   "œ‘ æ’Ô¡∆º∆º€√Ê∞Â(F8)"
            EndProperty
         EndProperty
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "ÀŒÃÂ"
            Size            =   9
            Charset         =   134
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
      End
      Begin VB.Image imgButtonDel 
         Height          =   240
         Left            =   1680
         Picture         =   "frmOutAdviceEdit.frx":C4ED
         Top             =   120
         Visible         =   0   'False
         Width           =   240
      End
      Begin VB.Image imgButtonNew 
         Height          =   240
         Left            =   1005
         Picture         =   "frmOutAdviceEdit.frx":12D3F
         Top             =   105
         Visible         =   0   'False
         Width           =   240
      End
      Begin XtremeCommandBars.CommandBars cbsMain 
         Left            =   75
         Top             =   75
         _Version        =   589884
         _ExtentX        =   635
         _ExtentY        =   635
         _StockProps     =   0
      End
   End
End
Attribute VB_Name = "frmOutAdviceEdit"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Option Explicit
Public Event FormUnload(Cancel As Integer)
Public Event EditDiagnose(ParentForm As Object, ByVal π“∫≈µ• As String, Succeed As Boolean) '±‡º≠√≈’Ô’Ô∂œ
Public Event CheckInfectDisease(ByVal blnOnChek As Boolean, ByVal strº≤≤°ID As String, ByVal str’Ô∂œId As String, ByRef blnNo As Boolean) '∏˘æ›’Ô∂œºÏ≤È «∑Ò È–¥¥´»æ≤°±®∏Êø®

Public mblnOK As Boolean
'»Îø⁄≤Œ ˝
Private mint≥°∫œ As Integer 'µ˜”√≥°∫œ:0-“Ω…˙’æµ˜”√,1-ª§ ø’æµ˜”√,2-“Ωºº’æµ˜”√(PACS/LIS)
Private mblnModal As Boolean
Private mfrmParent As Object
Private mMainPrivs As String
Private mlng≤°»ÀID As Long
Private mstrπ“∫≈µ• As String '≤°»Àπ“∫≈µ•æ›∫≈
Private mlngπ“∫≈ID As Long
Private mlng∫œÕ¨µ•ŒªID As Long
Private mlng«∞Ã·ID As Long '“Ωººπ§◊˜’æœ¬“Ω÷ˆ ±”√
Private mstr«∞Ã·IDs As String
Private mlng“Ωººø∆ “ID As Long
Private mint”§∂˘ As Integer '–ﬁ∏ƒ ±”√
Private mlng“Ω÷ˆID As Long '–ﬁ∏ƒ ±”√
Private mblnCancle As Boolean   '±£¥Ê ±—È÷§

'≥Ã–Ú±‰¡ø
Private mobjVBA As Object
Private mobjScript As clsScript
Private mrsDefine As ADODB.Recordset '“Ω÷ˆƒ⁄»›∂®“Â
Private mrsDrugScale As ADODB.Recordset '≥£”√º¡¡ø±»¿˝
Private mrsPrice As ADODB.Recordset '“Ω÷ˆ∂‘”¶µƒ ’∑—œÓƒø–≈œ¢ºØ

Private WithEvents mfrmSend As frmOutAdviceSend
Attribute mfrmSend.VB_VarHelpID = -1
Private WithEvents mfrmShortCut As frmClinicShortCut
Attribute mfrmShortCut.VB_VarHelpID = -1
Private WithEvents mfrmPrice As frmAdvicePrice
Attribute mfrmPrice.VB_VarHelpID = -1
Private mobjKeyBoard As Object '∆¡ƒªº¸≈Ã∂‘œÛ∂ØÃ¨¥¥Ω®
Private mcolStock1 As Collection '¥Ê∑≈∏˜∏ˆ“©∆∑ø‚∑øµƒ≥ˆø‚ºÏ≤È∑Ω Ω
Private mcolStock2 As Collection '¥Ê∑≈∏˜∏ˆŒ¿≤ƒø‚∑øµƒ≥ˆø‚ºÏ≤È∑Ω Ω
Private mstrDelIDs As String 'º«¬º–Ë“™±ª…æ≥˝µƒ“Ω÷ˆID
Private mstrAduitDelIDs As String '¥¶∑Ω…Û≤È“—…Û≤ÈµƒºŸ…æ≥˝
Private mstr–‘± As String '”√”⁄œÓƒø ‰»Îœﬁ÷∆≈–∂œ
Private mintƒÍ¡‰ As Integer '≤°»Àµƒ’˚ ˝ƒÍ¡‰
Private mDat≥ˆ…˙»’∆⁄ As Date '≤°»À≥ˆ…˙»’∆⁄
Private mdbl√≈’Ô∫≈ As Double   '≤°»À√≈’Ô∫≈ PASS =3-Ã´‘™Õ®
Private mstr–’√˚ As String
Private mstr…Ì∑›÷§∫≈ As String
Private mstr∑—± As String
Private mdatπ“∫≈ ±º‰ As Date '”√”⁄œ‡πÿ≈–∂œ
Private mlng≤°»Àø∆ “id As Long '≤°»À(π“∫≈)ø∆ “ID
Private mintœ’¿‡ As Integer 'µ±«∞≤°»Àœ’¿‡
Private mstr∏∂øÓ¬Î As String 'µ±«∞≤°»À“Ω¡∆∏∂øÓ∑Ω Ω±‡¬Î
Private mbln÷–“Ω As Boolean
Private mblnReturn As Boolean
Private mblnIsInHelp As Boolean
Private mrs’Ô∂œ As ADODB.Recordset
Private mclsMipModule As zl9ComLib.clsMipModule
Attribute mclsMipModule.VB_VarHelpID = -1
Private mblnÃÏ ˝∑¥À„ As Boolean
Private msngPreÃÏ ˝ As Single
Private mbln∏¥’Ô As Boolean  'µ±«∞≤°»À «∑Ò∏¥’Ô
Private mstr◊‘∂®“Â…Í«Îµ•IDs As String 'ID1,√˚≥∆1|ID2,√˚≥∆2°§°§°§

Private mbln¿©’π“≥«© As Boolean ' «∑Ò÷ß≥÷¿©’π“≥«©
Private mblnNoRefresh As Boolean '≤ªÀ¢–¬ΩÁ√Ê
Private mcolSubForm As Collection '¿©’π“≥«©∂‘œÛºØ∫œ
Private mlngID–Ú¡– As Long 'ºŸ“Ω÷ˆID£¨”√∏∫ ˝±Ì æ
Private mstrDel ‰—™ As String 'º«¬º–Ë“™±ª…æ≥˝µƒ ‰—™“Ω÷ˆID£¨Ωˆº«¬º÷˜“Ω÷ˆID
Private mlngŒ£º±÷µID As Long

'≥ˆø⁄≤Œ ˝
Private mobjPassMap As Object  ' PASS  ¥∞ø⁄∂‘œÛ”≥…‰
Private mblnPass As Boolean
'±æµÿ≤Œ ˝
Private mintºÚ¬Î As Integer
Private mstrLike As String
Private mbln◊‘∂Ø∆§ ‘ As Boolean
Private mblnÃÏ ˝ As Boolean
Private msngÃÏ ˝ As Single
Private mblnµ•¡ø As Boolean
Private mblnStaKB As Boolean ' «∑Ò◊‘∂Ø∆Ù”√∆¡ƒªº¸≈Ã
Private mblnÃ·–—∂‘¬Î As Boolean
Private mblnAutoClose As Boolean
Private mblnAddAgent As Boolean ' «∑Ò“™«Ûµ«º«∂æ¬È“©∆∑¥˙∞Ï»À–≈œ¢
Private mblnNewLIS As Boolean
Private mstrPurMed As String  'øπæ˙“©ŒÔ»± °”√“©ƒøµƒ "1"-‘§∑¿£¨"2"-÷Œ¡∆£¨"0"-œ¬¥Ô ±»∑∂®
Private mbytSize As Byte
Private mrsDiag  As ADODB.Recordset 'Œ˜“Ω’Ô∂œº«¬ººØ
Private mblnFreeInput As Boolean

' ¬º˛◊¥Ã¨øÿ÷∆±‰¡ø
Private mblnRowMerge As Boolean
Private mblnNoSave As Boolean
Private mblnRunFirst As Boolean
Private mblnRowChange As Boolean
Private mblnDoCheck As Boolean
Private mbytPatiType As Byte  '≤°»À¿‡–Õ£¨1 ∆’Õ®£¨2 º±’Ô
'√≈’Ô¡∆≥ÃÃÏ ˝£¨º±’Ô3ÃÏ£¨∆’Õ®7ÃÏ
Private Const conEmergency = 3
Private Const conOrdinary = 7

'π§æﬂ¿∏√¸¡Ó
Private Const conMenu_New = 100
Private Const conMenu_Insert = 101
Private Const conMenu_Delete = 102
Private Const conMenu_Merge = 104
Private Const conMenu_Copy = 105
Private Const conMenu_Scheme = 106
Private Const conMenu_Save = 107
Private Const conMenu_Sign = 108
Private Const conMenu_Reference = 109
Private Const conMenu_Help = 110
Private Const conMenu_Exit = 111
Private Const conMenu_Agent = 112
Private Const conMenu_Send = 205
Private Const conMenu_DrugScale = 300
Private Const conMenu_AdvicePay = 3006

'÷¥–– ±º‰ æ¿˝
Private Const COL_∞¥÷‹÷¥–– = _
    "√ø÷‹»˝¥Œ 1/8-3/8-5/8 ªÚ 1/8:00-3/8:00-5/8:00" & vbCrLf & _
        vbTab & "±Ì æ‘⁄√ø÷‹–«∆⁄“ªµƒ8:00,–«∆⁄»˝µƒ8:00,–«∆⁄ŒÂµƒ8:00’‚º∏∏ˆ ±º‰÷¥––"
Private Const COL_∞¥ÃÏ÷¥–– = _
    "√øÃÏ»˝¥Œ 8-12-16 ªÚ 8:00-12:00-16:00" & vbCrLf & _
        vbTab & "±Ì æ‘⁄√øÃÏ8:00,12:00,16:00’‚º∏∏ˆ ±º‰÷¥––" & vbCrLf & _
    "¡ΩÃÏ“ª¥Œ 1/8 ªÚ 1/8:00" & vbCrLf & _
        vbTab & "±Ì æ‘⁄√ø¡ΩÃÏ÷–µƒµ⁄1ÃÏ8:00’‚∏ˆ ±º‰÷¥––"
Private Const COL_∞¥ ±÷¥–– = _
    "√ø–° ±¡Ω¥Œ 1:20-1:40" & vbCrLf & _
        vbTab & "±Ì æ‘⁄√ø–° ±ƒ⁄µƒ20∫Õ40∑÷÷”’‚¡Ω∏ˆ ±º‰÷¥––" & vbCrLf & _
    "¡Ω–° ±“ª¥Œ 2:30 ªÚ 1:30 ªÚ 1:00" & vbCrLf & _
        vbTab & "±Ì æ‘⁄√ø¡Ω–° ±ƒ⁄µƒµ⁄2µƒ∏ˆ–° ±µƒ30∑÷÷”’‚∏ˆ ±º‰÷¥––" & vbCrLf & _
        vbTab & "°°ªÚ‘⁄√ø¡Ω–° ±ƒ⁄µƒµ⁄1µƒ∏ˆ–° ±µƒ30∑÷÷”’‚∏ˆ ±º‰÷¥––" & vbCrLf & _
        vbTab & "°°ªÚ‘⁄√ø¡Ω–° ±ƒ⁄µƒµ⁄1µƒ∏ˆ–° ±’‚∏ˆ ±º‰÷¥––"

'πÃ∂®¡–
Private Const COL_F±Í÷æ = 0 '◊‘”…¬º»Î£¨ΩÙº±£¨≤π¬º,øπæ˙”√“©…Û∫À◊¥Ã¨
'ø…º˚¡–À˜“˝
Private Const COL_æØ æ = 1 'Pass:“‘◊÷∑˚¥Æ¿‡–Õ¥¶¿Ì,ø’±Ì æ√ª”–…Û≤ÈΩ·π˚
Private Const COL_’Ô∂œ = 2
Private Const COL_ø™ º ±º‰ = 3
Private Const col_“Ω÷ˆƒ⁄»› = 4
Private Const COL_◊‹¡ø = 5
Private Const COL_◊‹¡øµ•Œª = 6
Private Const COL_µ•¡ø = 7
Private Const COL_µ•¡øµ•Œª = 8
Private Const COL_ÃÏ ˝ = 9
Private Const COL_∆µ¬  = 10
Private Const COL_”√∑® = 11
Private Const COL_“Ω…˙÷ˆÕ– = 12 'Data”√”⁄¥Ê∑≈’™“™(“Ω±£)
Private Const COL_÷¥–– ±º‰ = 13
Private Const COL_ø™÷ˆ“Ω…˙ = 14
Private Const COL_≥¨¡øÀµ√˜ = 15  '“©∆∑≥¨¡øÀµ√˜
Private Const COL_ª˘±æ“©ŒÔ = 16

'“˛≤ÿ¡–À˜“˝
Private Const COL_EDIT = 17 '±‡º≠±Í÷æ£∫0-‘≠ ºµƒ,1-–¬‘ˆµƒ,2-–ﬁ∏ƒ¡Àƒ⁄»›,3-–ﬁ∏ƒ¡À–Ú∫≈,À¸µƒData÷µ=–¬œ¬µƒ≥…Ã◊∑Ω∞∏ID
Private Const COL_œ‡πÿID = COL_EDIT + 1
Private Const COL_”§∂˘ = COL_EDIT + 2
Private Const COL_–Ú∫≈ = COL_EDIT + 3  'Pass:Data÷µ”√”⁄º«¬º «∑Ò∏¸∏ƒ¡À…Û∫ÀΩ·π˚
Private Const COL_◊¥Ã¨ = COL_EDIT + 4  '≤°»À“Ω÷ˆº«¬º.◊¥Ã¨£¨Data÷µº«¬º∏√“Ω÷ˆ «∑Ò“—Ω¯––¡À“Ω±£π‹øÿºÏ≤È
Private Const COL_¿‡± = COL_EDIT + 5  '√≈’Ô√ª”–◊‘”…¬º»Î“Ω÷ˆ(*)£¨AdviceSet≥…Ã◊œÓƒø÷–Nvl(¿‡±,'*')÷ª «Œ™¡À‘§∑¿ÕÚ“ª
Private Const COL_’Ô¡∆œÓƒøID = COL_EDIT + 6
Private Const COL_√˚≥∆ = COL_EDIT + 7
Private Const COL_±Í±æ≤øŒª = COL_EDIT + 8
    Private Const COL_ ÷ ı ±º‰ = COL_EDIT + 8
    Private Const COL_ ‰—™ ±º‰ = COL_EDIT + 8
Private Const COL_ºÏ≤È∑Ω∑® = COL_EDIT + 9 'µ± ¿‡±=K  ‰—™“Ω÷ˆ ±∏√◊÷∂Œ‘ –Ì¥Ê»Î"1"±Ì æ±∏—™“Ω÷ˆ
    Private Const COL_÷–“©–ŒÃ¨ = COL_EDIT + 9 '0=…¢◊∞£¨1=÷–“©“˚∆¨£¨2=√‚ºÂº¡
Private Const COL_÷¥––±Íº« = COL_EDIT + 10
Private Const COL_ ’∑—œ∏ƒøID = COL_EDIT + 11
Private Const COL_∆µ¬ ¥Œ ˝ = COL_EDIT + 12
Private Const COL_∆µ¬ º‰∏Ù = COL_EDIT + 13
Private Const COL_º‰∏Ùµ•Œª = COL_EDIT + 14
Private Const COL_º∆º€–‘÷  = COL_EDIT + 15
Private Const COL_÷¥––ø∆ “ID = COL_EDIT + 16
Private Const COL_÷¥–––‘÷  = COL_EDIT + 17 '≤°»À“Ω÷ˆº«¬º.÷¥–––‘÷ =’Ô¡∆œÓƒøƒø¬º.÷¥––ø∆ “
Private Const COL_ø™÷ˆø∆ “ID = COL_EDIT + 18
Private Const COL_ø™÷ˆ ±º‰ = COL_EDIT + 19
Private Const COL_±Í÷æ = COL_EDIT + 20     '0-∆’Õ®,1-ΩÙº±£¨2-≤π¬º

Private Const COL_º∆À„∑Ω Ω = COL_±Í÷æ + 1 '’Ô¡∆œÓƒøƒø¬º.º∆À„∑Ω Ω
Private Const COL_∆µ¬ –‘÷  = COL_±Í÷æ + 2 '’Ô¡∆œÓƒøƒø¬º.÷¥––∆µ¬ 
Private Const COL_≤Ÿ◊˜¿‡–Õ = COL_±Í÷æ + 3 '’Ô¡∆œÓƒøƒø¬º.≤Ÿ◊˜¿‡–Õ
Private Const COL_÷¥––∑÷¿‡ = COL_±Í÷æ + 4 '’Ô¡∆œÓƒøƒø¬º.÷¥––∑÷¿‡
Private Const COL_ø‚¥Ê = COL_±Í÷æ + 5 '∞¥√≈’Ô∞¸◊∞¥Ê∑≈µƒø…”√ø‚¥Ê
Private Const COL_ø…∑Ò∑÷¡„ = COL_±Í÷æ + 6 'Œ¿≤ƒ”√”⁄¥Ê∑≈ «∑Ò∏˙◊Ÿ‘⁄”√
    Private Const COL_∏˙◊Ÿ‘⁄”√ = COL_±Í÷æ + 6
Private Const COL_º¡¡øœµ ˝ = COL_±Í÷æ + 7
Private Const COL_√≈’Ôµ•Œª = COL_±Í÷æ + 8
Private Const COL_√≈’Ô∞¸◊∞ = COL_±Í÷æ + 9
Private Const COL_¥¶∑Ωœﬁ¡ø = COL_±Í÷æ + 10 '∑«“©’Ô¡∆œÓƒøŒ™¬º»Îœﬁ¡ø
Private Const COL_¥¶∑Ω÷∞ŒÒ = COL_±Í÷æ + 11
Private Const COL_∂æ¿Ì∑÷¿‡ = COL_±Í÷æ + 12
Private Const COL_“©∆∑º¡–Õ = COL_±Í÷æ + 13
Private Const COL_µ•º€ = COL_±Í÷æ + 14
Private Const COL_«©√˚∑Ò = COL_±Í÷æ + 15
Private Const COL_∏ΩœÓ = COL_±Í÷æ + 16
Private Const COL_¡„∑—º«’  = COL_±Í÷æ + 17
Private Const COL_øπæ˙µ»º∂ = COL_±Í÷æ + 18 'øπæ˙“©ŒÔµ»º∂:0-∑«øπæ˙“©,1-∑«œﬁ÷∆º∂,2-œﬁ÷∆º∂,3-Ãÿ ‚ π”√º∂
Private Const COL_”√“©ƒøµƒ = COL_±Í÷æ + 19
Private Const COL_”√“©¿Ì”… = COL_±Í÷æ + 20
Private Const COL_…Û∫À◊¥Ã¨ = COL_±Í÷æ + 21 'øπæ˙“©ŒÔ…Û∫À◊¥Ã¨£∫Null-Œﬁ–Ë…Û∫À£¨1-¥˝…Û∫À£¨2-…Û∫ÀÕ®π˝£¨3-…Û∫ÀŒ¥Õ®π˝
Private Const COL_√‚ ‘ = COL_±Í÷æ + 22    ' «∑Ò√‚ ‘   1-√‚ ‘£¨0-≤ª√‚ ‘
Private Const COL_ «∑Ò≥¨¡ø = COL_±Í÷æ + 23   '“©∆∑ «∑Ò≥¨¡ø
Private Const COL_ «∑Ò≥¨∆⁄ = COL_±Í÷æ + 24
Private Const COL_≈‰∑ΩID = COL_±Í÷æ + 25
Private Const COL_¡Ÿ¥≤◊‘π‹“© = COL_±Í÷æ + 26
Private Const COL_∏ﬂŒ£“©∆∑ = COL_±Í÷æ + 27
Private Const COL_◊È∫œœÓƒøID = COL_±Í÷æ + 28
Private Const COL_ «∑ÒÕ£”√ = COL_±Í÷æ + 29 '=1±Í ∂“—Õ£”√£¨=0ªÚNULL±Í ∂Œ¥Õ£”√
Private Const COL_ «∑Ò»‹√Ω = COL_±Í÷æ + 30 '=1»‹√Ω
Private Const COL_…Í«Î–Ú∫≈ = COL_±Í÷æ + 31 '
Private Const COL_µ•∂¿”¶”√ = COL_±Í÷æ + 32
Private Const COL_¥¶∑Ω…Û≤È◊¥Ã¨ = COL_±Í÷æ + 33
Private Const COL_¥¶∑Ω…Û≤ÈΩ·π˚ = COL_±Í÷æ + 34
Private Const COL_¥¶∑Ω–Ú∫≈ = COL_±Í÷æ + 35    '∫œ¿Ì”√“©º‡≤‚”√
Private Const COL_Œ£º±÷µID = COL_±Í÷æ + 36

Private Const M_LNG_DIAGCOUNT = 10 '◊Ó¥Û’Ô∂œ ˝

Private Type AGENT_INFO
    ¥˙∞Ï»À–’√˚      As String
    ¥˙∞Ï»À…Ì∑›÷§∫≈  As String
    ±æ¥ŒæÕ’Ô“—¬º»Î  As Boolean
End Type
Private AgentInfo As AGENT_INFO

Private Enum COL_ENUM_’Ô∂œ
    col±Í÷æ = 0
    col÷–“Ω = 1
    COLŒ˜“Ω = 2
    col±‡¬Î = 3
    col’Ô∂œ = 4
    col÷–“Ω÷§∫Ú = 5
    col∑¢≤° ±º‰ = 6
    col“…’Ô = 7
    col‘ˆº” = 8
    col’Ô∂œID = 9
    colº≤≤°ID = 10
    col÷§∫ÚID = 11
    colICD¬Î = 12
    col“Ω÷ˆID = 13
    COLDEL = 14
    col’Ô∂œ±‡¬Î = 15
    colº≤≤°±‡¬Î = 16
    colº≤≤°¿‡± = 17
    colº≤≤°∏Ω¬Î = 18
    col÷§∫Ú±‡¬Î = 19
End Enum

Public Function ShowMe(ByVal frmParent As Object, ByVal int≥°∫œ As Integer, ByVal MainPrivs As String, ByVal lng≤°»ÀID As Long, ByVal strπ“∫≈µ• As String, _
    Optional ByVal lng«∞Ã·ID As Long, Optional ByVal int”§∂˘ As Integer, Optional ByVal lng“Ω÷ˆID As Long, Optional ByVal blnModal As Boolean, _
     Optional ByVal lngΩÁ√Êø∆ “ID As Long, Optional ByVal str«∞Ã·IDs As String, Optional ByRef objMip As Object, Optional ByVal lngŒ£º±÷µID As Long) As Boolean
    
    Set mfrmParent = frmParent
    mint≥°∫œ = int≥°∫œ
    mblnModal = blnModal
    mMainPrivs = MainPrivs
    mlng≤°»ÀID = lng≤°»ÀID
    mstrπ“∫≈µ• = strπ“∫≈µ•
    mlng«∞Ã·ID = lng«∞Ã·ID
    mstr«∞Ã·IDs = str«∞Ã·IDs
    mlng“Ωººø∆ “ID = IIF(mlng«∞Ã·ID <> 0, lngΩÁ√Êø∆ “ID, 0)
    mint”§∂˘ = int”§∂˘
    mlng“Ω÷ˆID = lng“Ω÷ˆID
    mlngŒ£º±÷µID = lngŒ£º±÷µID
    
    If Not (objMip Is Nothing) Then Set mclsMipModule = objMip
    Me.Show IIF(blnModal, 1, 0), frmParent
    ShowMe = mblnOK
End Function

Private Sub InitCommandBar()
'π¶ƒ‹£∫≥ı ºªØπ§æﬂ¿∏
    Dim objBar As CommandBar
    Dim objControl As CommandBarControl
    Dim objPopup As CommandBarPopup
    Dim objMenu As CommandBarPopup
    Dim varArr As Variant
    Dim strTmp As String
    Dim intTmp As Integer
    Dim strName As String
    Dim lngID As Long
    Dim i As Long
    
    Dim blnTwo As Boolean, lng∫œÕ¨µ•ŒªID As Long, blnµ•Œªº«’  As Boolean
    Dim strInsidePrivs As String
    
    strInsidePrivs = GetInsidePrivs(p√≈’Ô“Ω÷ˆœ¬¥Ô)
    lng∫œÕ¨µ•ŒªID = Get∫œÕ¨µ•ŒªID
    blnµ•Œªº«’  = Val(zlDatabase.GetPara("µ•Œªº«’ ", glngSys, p√≈’Ô“Ω÷ˆœ¬¥Ô)) <> 0
    
    blnTwo = Val(zlDatabase.GetPara("∑¢ÀÕµ•æ›¿‡–Õ", glngSys, p√≈’Ô“Ω÷ˆœ¬¥Ô)) <> 2 Or _
             Val(zlDatabase.GetPara("∑¢ÀÕµ•æ›¿‡–Õ", glngSys, p√≈’Ô“Ω÷ˆœ¬¥Ô)) = 2 And _
             (InStr(GetInsidePrivs(p√≈’Ô“Ω÷ˆœ¬¥Ô), "∑¢ÀÕŒ™º«’ µ•") = 0 Or _
            InStr(GetInsidePrivs(p√≈’Ô“Ω÷ˆœ¬¥Ô), "∑¢ÀÕŒ™ ’∑—µ•") = 0 Or _
            blnµ•Œªº«’  And lng∫œÕ¨µ•ŒªID = 0)
            
    If blnµ•Œªº«’  And lng∫œÕ¨µ•ŒªID = 0 Or _
        InStr(GetInsidePrivs(p√≈’Ô“Ω÷ˆœ¬¥Ô), "¡„∑—º«’ ") = 0 Or _
        InStr(GetInsidePrivs(p√≈’Ô“Ω÷ˆœ¬¥Ô), "∑¢ÀÕŒ™º«’ µ•") = 0 Or _
        Val(zlDatabase.GetPara("∑¢ÀÕµ•æ›¿‡–Õ", glngSys, p√≈’Ô“Ω÷ˆœ¬¥Ô)) = 0 Then
        ' «∑Òœ‘ æ¡„∑—º«’ 
        chkZeroBilling.Visible = False
    End If
    
    CommandBarsGlobalSettings.App = App
    CommandBarsGlobalSettings.ResourceFile = CommandBarsGlobalSettings.OcxPath & "\XTPResourceZhCn.dll"
    CommandBarsGlobalSettings.ColorManager.SystemTheme = xtpSystemThemeAuto
    cbsMain.VisualTheme = xtpThemeOffice2003
    With Me.cbsMain.Options
        .ShowExpandButtonAlways = False
        .ToolBarAccelTips = True
        .AlwaysShowFullMenus = False
        .IconsWithShadow = True '∑≈‘⁄VisualTheme∫Û”––ß
        .UseDisabledIcons = True
        .LargeIcons = True
        .SetIconSize True, 24, 24
        .SetIconSize False, 16, 16
    End With
    cbsMain.EnableCustomization False
    cbsMain.ActiveMenuBar.Visible = False
    Set cbsMain.Icons = frmIcons.imgMain.Icons
    
    '≤Àµ•
    Set objMenu = cbsMain.ActiveMenuBar.Controls.Add(xtpControlPopup, conMenu_EditPopup, "“©÷ˆ…Û≤È", -1, False)
    objMenu.ID = conMenu_EditPopup
    With objMenu.CommandBar.Controls
        '≤Âº˛¿©’ππ¶ƒ‹
        Call CreatePlugInOK(p√≈’Ô“Ω÷ˆœ¬¥Ô, mint≥°∫œ)
        If Not gobjPlugIn Is Nothing Then
            Set objPopup = .Add(xtpControlButtonPopup, conMenu_Tool_PlugIn, "¿©’ππ¶ƒ‹")
            objPopup.BeginGroup = True
        End If
                If Not gobjDrugExplain Is Nothing Then
            Set objControl = .Add(xtpControlButton, conMenu_Edit_ViewDrugExplain, "≤Èø¥“©∆∑Àµ√˜ È")
            objControl.IconId = 3205
        End If
    End With
    
    '…˙≥…π§æﬂ¿∏
    Set objBar = cbsMain.Add("π§æﬂ¿∏", xtpBarTop)
    With objBar.Controls
        Set objControl = .Add(xtpControlButton, conMenu_New, "‘ˆº”")
        Set objControl = .Add(xtpControlButton, conMenu_Insert, "≤Â»Î")
        Set objControl = .Add(xtpControlButton, conMenu_Delete, "…æ≥˝")
        
        If mint≥°∫œ = 0 Then '÷ª”–√≈’Ô“Ω…˙π§◊˜’æµ˜”√ ±≤≈”–’‚º∏∏ˆ∞¥≈•
            intTmp = Val(Mid(gstrOutUseApp, 1, 1))
            If intTmp = 1 Then strTmp = strTmp & ",ºÏ≤È…Í«Î:" & conMenu_Edit_PacsApply
            intTmp = Val(Mid(gstrOutUseApp, 2, 1))
            If intTmp = 1 And Not gobjLIS Is Nothing Then strTmp = strTmp & ",ºÏ—È…Í«Î:" & conMenu_Edit_LISApply
            intTmp = Val(Mid(gstrOutUseApp, 3, 1))
            If intTmp = 1 Then strTmp = strTmp & ", ‰—™…Í«Î:" & conMenu_Edit_BloodApply
            

                        Get◊‘∂®“Â…Í«Îµ• 1, mstr◊‘∂®“Â…Í«Îµ•IDs
            If mstr◊‘∂®“Â…Í«Îµ•IDs <> "" Then
                For i = 0 To UBound(Split(mstr◊‘∂®“Â…Í«Îµ•IDs, "|"))
                    strTmp = strTmp & "," & Split(Split(mstr◊‘∂®“Â…Í«Îµ•IDs, "|")(i), ",")(1) & ":" & (conMenu_Edit_ApplyCustom * 100# + i) & ":" & Split(Split(mstr◊‘∂®“Â…Í«Îµ•IDs, "|")(i), ",")(0)
                Next
            End If
            strTmp = Mid(strTmp, 2)
            If strTmp <> "" Then
                If InStr(strTmp, ",") = 0 Then
                    strName = Split(strTmp, ":")(0)
                    lngID = Val(Split(strTmp, ":")(1))
                    Set objControl = .Add(xtpControlButton, lngID, strName)
                        objControl.IconId = conMenu_Edit_PacsApply
                        objControl.ToolTipText = strName
                        objControl.BeginGroup = True
                                            If UBound(Split(strTmp, ":")) = 2 Then objControl.Parameter = Val(Split(strTmp, ":")(2))
                Else
                    varArr = Split(strTmp, ",")
                    For i = 0 To UBound(varArr)
                        strTmp = varArr(i)
                        strName = Split(strTmp, ":")(0)
                        lngID = Val(Split(strTmp, ":")(1))
                        
                        If i = 0 Then
                            Set objPopup = .Add(xtpControlSplitButtonPopup, lngID, strName)
                                objPopup.IconId = conMenu_Edit_PacsApply
                                objPopup.BeginGroup = True
                                objPopup.ToolTipText = strName
                                With objPopup.CommandBar.Controls
                                    Set objControl = .Add(xtpControlButton, lngID * 10# + 1, strName)
                                End With
                        Else
                            Set objControl = objPopup.CommandBar.Controls.Add(xtpControlButton, lngID, strName)
                        End If
                                                If UBound(Split(strTmp, ":")) = 2 Then objControl.Parameter = Val(Split(strTmp, ":")(2))
                    Next
                End If
            End If
        End If
        
        Set objControl = .Add(xtpControlButton, conMenu_Merge, "“ª≤¢∏¯“©"): objControl.BeginGroup = True
        If InStr(strInsidePrivs, ";∏¥÷∆“Ω÷ˆ;") > 0 Then
            Set objControl = .Add(xtpControlButton, conMenu_Copy, "∏¥÷∆“Ω÷ˆ")
        End If
        Set objPopup = .Add(xtpControlSplitButtonPopup, conMenu_Scheme, "≥…Ã◊∑Ω∞∏")
        objPopup.ToolTipText = "±£¥ÊŒ™≥…Ã◊∑Ω∞∏"
        With objPopup.CommandBar.Controls
            .Add xtpControlButton, conMenu_Scheme * 10# + 1, "±£¥ÊŒ™≥…Ã◊∑Ω∞∏"
            .Add xtpControlButton, conMenu_Scheme * 10# + 2, "œ‘ æ≥…Ã◊∑Ω∞∏—°‘Ò∆˜"
        End With
        
        Set objControl = .Add(xtpControlButton, conMenu_Agent, "¥˙∞Ï»À")
        Set objControl = .Add(xtpControlButton, conMenu_Save, "±£¥Ê"): objControl.BeginGroup = True
        Set objControl = .Add(xtpControlButton, conMenu_Sign, "«©√˚")
        
        If blnTwo Then
            Set objPopup = .Add(xtpControlSplitButtonPopup, conMenu_Send, "∑¢ÀÕ")
            objPopup.ToolTipText = "◊‘∂ØÕÍ≥…∑¢ÀÕ(F3)"
            With objPopup.CommandBar.Controls
                .Add xtpControlButton, conMenu_Send * 10# + 1, "◊‘∂ØÕÍ≥…∑¢ÀÕ"
                .Add xtpControlButton, conMenu_Send * 10# + 2, "“Ω÷ˆ∑¢ÀÕ¥¶¿Ì"
            End With
        Else
            Set objControl = .Add(xtpControlButton, conMenu_Send, "∑¢ÀÕ")
        End If
        If InStr(GetInsidePrivs(p√≈’Ô“Ω÷ˆœ¬¥Ô), ";’Ôº‰Œﬁø®÷ß∏∂;") > 0 And Not mblnAutoClose Then
            Set objControl = .Add(xtpControlButton, conMenu_AdvicePay, "’Ôº‰÷ß∏∂"): objControl.BeginGroup = True
        End If
        Set objControl = .Add(xtpControlButton, conMenu_Reference, "≤Œøº"): objControl.BeginGroup = True
        Set objControl = .Add(xtpControlButton, conMenu_Help, "∞Ô÷˙")
        Set objControl = .Add(xtpControlButton, conMenu_Exit, "ÕÀ≥ˆ")
    End With
    objBar.EnableDocking xtpFlagHideWrap
    objBar.ContextMenuPresent = False
    For Each objControl In objBar.Controls
        If objControl.ID = conMenu_Help Or objControl.ID = conMenu_Exit Or objControl.ID = conMenu_Reference Then
            objControl.Style = xtpButtonIcon
        Else
            objControl.Style = xtpButtonIconAndCaption
        End If
    Next
   
    
    '»»º¸∞Û∂®:◊¢“‚≤ªƒ‹∫ÕœµÕ≥µƒŒƒ±æ±‡º≠»»º¸≥ÂÕª£¨“‘º∞Form_keydown÷–µƒ≥ÂÕª
    With cbsMain.KeyBindings
        .Add 0, vbKeyF2, conMenu_Save
        If blnTwo Then
            .Add 0, vbKeyF3, conMenu_Send * 10# + 1
            .Add FCONTROL, vbKeyG, conMenu_Send * 10# + 2
        Else
            .Add 0, vbKeyF3, conMenu_Send
        End If
        .Add 0, vbKeyF6, conMenu_Reference
        .Add 0, vbKeyF9, conMenu_Merge
        .Add 0, vbKeyF1, conMenu_Help
        .Add FCONTROL, vbKeyA, conMenu_New
        .Add FCONTROL, vbKeyI, conMenu_Insert
        .Add FCONTROL, vbKeyK, conMenu_Merge
        .Add FCONTROL, vbKeyY, conMenu_Copy
        .Add FCONTROL, vbKeyT, conMenu_Scheme
        .Add FCONTROL, vbKeyS, conMenu_Save
        .Add FALT, vbKeyX, conMenu_Exit
    End With
End Sub

Private Sub InitAdviceTable()
'π¶ƒ‹£∫≥ı ºªØ±Ì∏Òƒ⁄»›£¨”√‘⁄¥∞ÃÂ∏ˆ–‘ªØ…Ë÷√ª÷∏¥÷Æ«∞
    Dim strHead As String, i As Integer
    Dim arrHead As Variant, arrCol As Variant

    strHead = _
        ",240,4;,270,4;ø™ º ±º‰,1530,1;“Ω÷ˆƒ⁄»›,3500,1;◊‹¡ø,600,7;µ•Œª,450,1;µ•¡ø,600,7;µ•Œª,450,1;" & _
        "ÃÏ ˝,450,1;∆µ¬ ,1200,1;”√∑®,1200,1;“Ω…˙÷ˆÕ–,1000,1;÷¥–– ±º‰;ø™÷ˆ“Ω…˙,850,1;≥¨¡øÀµ√˜,1000,1;ª˘±æ“©ŒÔ,850,1;" & _
        "EDIT;œ‡πÿID;”§∂˘;–Ú∫≈;“Ω÷ˆ◊¥Ã¨;’Ô¡∆¿‡±;’Ô¡∆œÓƒøID;√˚≥∆;±Í±æ≤øŒª;ºÏ≤È∑Ω∑®;÷¥––±Íº«; ’∑—œ∏ƒøID;" & _
        "∆µ¬ ¥Œ ˝;∆µ¬ º‰∏Ù;º‰∏Ùµ•Œª;º∆º€–‘÷ ;÷¥––ø∆ “ID;÷¥–––‘÷ ;ø™÷ˆø∆ “ID;ø™÷ˆ ±º‰;±Í÷æ;º∆À„∑Ω Ω;" & _
        "∆µ¬ –‘÷ ;≤Ÿ◊˜¿‡–Õ;÷¥––∑÷¿‡;ø‚¥Ê;ø…∑Ò∑÷¡„;º¡¡øœµ ˝;√≈’Ôµ•Œª;√≈’Ô∞¸◊∞;¥¶∑Ωœﬁ¡ø;¥¶∑Ω÷∞ŒÒ;" & _
        "∂æ¿Ì∑÷¿‡;“©∆∑º¡–Õ;µ•º€;«©√˚∑Ò;∏ΩœÓ;¡„∑—º«’ ;øπæ˙µ»º∂;”√“©ƒøµƒ;”√“©¿Ì”…;…Û∫À◊¥Ã¨;√‚ ‘;" & _
        " «∑Ò≥¨¡ø; «∑Ò≥¨∆⁄;≈‰∑ΩID;¡Ÿ¥≤◊‘π‹“©;∏ﬂŒ£“©∆∑;◊È∫œœÓƒøID; «∑ÒÕ£”√; «∑Ò»‹√Ω;…Í«Î–Ú∫≈;µ•∂¿”¶”√;¥¶∑Ω…Û≤È◊¥Ã¨;¥¶∑Ω…Û≤ÈΩ·π˚;¥¶∑Ω–Ú∫≈;Œ£º±÷µID"
        
    arrHead = Split(strHead, ";")
    With vsAdvice
        .Clear
        .FixedRows = 1: .FixedCols = 1
        .Rows = 2: .Cols = .FixedCols + UBound(arrHead) + 1
        
        For i = 0 To UBound(arrHead)
            .FixedAlignment(.FixedCols + i) = 4
            arrCol = Split(arrHead(i), ",")
            .TextMatrix(0, .FixedCols + i) = arrCol(0)
            If UBound(arrCol) > 0 Then
                .ColWidth(.FixedCols + i) = Val(arrCol(1))
                .ColAlignment(.FixedCols + i) = Val(arrCol(2))
                .ColHidden(.FixedCols + i) = False
            Else
                .ColHidden(.FixedCols + i) = True
            End If
        Next
        .ColHidden(COL_æØ æ) = True 'Pass
        '.FrozenCols = COL_“Ω÷ˆƒ⁄»› + 1 - .FixedCols
        .ColWidth(0) = 14 * Screen.TwipsPerPixelX
        
        '¡–Õ∑Õº±Í
        Set .Cell(flexcpPicture, 0, COL_æØ æ) = img16.ListImages("æØ æ").Picture
        Set .Cell(flexcpPicture, 0, COL_’Ô∂œ) = img16.ListImages("’Ô∂œ").Picture
        .Cell(flexcpPictureAlignment, 0, 0, 0, .Cols - 1) = 4
    End With
End Sub

Private Sub Set”√∑®Input(rsInput As ADODB.Recordset, ByVal int¿‡–Õ As Integer)
'π¶ƒ‹£∫ ‰»Î∏¯“©Õææ∂ªÚ÷–“©”√∑®∫Ûµ˜”√
'≤Œ ˝£∫rsInput= ‰»ÎªÚ—°‘Òµƒ∑µªÿº«¬º
'      int¿‡–Õ=2-∏¯“©Õææ∂,4-÷–“©”√∑®
'Àµ√˜£∫»Áπ˚ø…—°∆µ¬ ,‘Ú≈‰∫œ∏¯“©Õææ∂¥¶¿Ìø…”√÷¥–– ±º‰∑Ω∞∏µƒ±‰ªØ
    Dim rsTmp As New ADODB.Recordset
    Dim strSQL As String, i As Long
    Dim blnValid As Boolean, sngÃÏ ˝ As Single
    Dim str∆µ¬  As String, int∆µ¬ ¥Œ ˝ As Integer, int∆µ¬ º‰∏Ù As Integer, strº‰∏Ùµ•Œª As String
    Dim vMsg As VbMsgBoxResult, strMsg As String
    Dim bln”√∑®”√¡ø As Boolean, bln”√∑®∆µ¬  As Boolean
    Dim strIDs1 As String, strIDs2 As String, str“Ω÷ˆƒ⁄»› As String
    
    On Error GoTo errH
    cmd”√∑®.Tag = rsInput!ID
    txt”√∑®.Text = rsInput!√˚≥∆
    txt”√∑®.Tag = "1"
    
    With vsAdvice
        '∑« ‰“∫¿‡«Â≥˝µŒÀŸ
        If int¿‡–Õ = 2 Then
            If Nvl(rsInput!÷¥––∑÷¿‡ID, 0) <> 1 And cboµŒÀŸ.Text <> "" Then
                cboµŒÀŸ.Text = ""
                cboµŒÀŸ.Tag = "1"
            End If
        End If
        
        '÷ÿ–¬ªÒ»°ø…”√µƒ»± ° ±º‰∑Ω∞∏
        If cbo÷¥–– ±º‰.Enabled Then '"ø…—°∆µ¬ "ªÚ“©∆∑ ±
            Call Get ±º‰∑Ω∞∏(cbo÷¥–– ±º‰, Get∆µ¬ ∑∂Œß(.Row), .TextMatrix(.Row, COL_∆µ¬ ), rsInput!ID)
            If cbo÷¥–– ±º‰.ListCount > 0 Then
                cbo÷¥–– ±º‰.ListIndex = 0
                cbo÷¥–– ±º‰.Tag = "1"
            Else
                '≈–∂œµ±«∞÷¥–– ±º‰ «∑Ò∫œ∑®
                If cbo÷¥–– ±º‰.Text <> "" Then
                    blnValid = ExeTimeValid(cbo÷¥–– ±º‰.Text, Val(.TextMatrix(.Row, COL_∆µ¬ ¥Œ ˝)), Val(.TextMatrix(.Row, COL_∆µ¬ º‰∏Ù)), .TextMatrix(.Row, COL_º‰∏Ùµ•Œª))
                    If Not blnValid Then '»Áπ˚≤ª∫œ∑®,‘Ú¡Ì»°,∑Ò‘Ú±£≥÷
                        cbo÷¥–– ±º‰.Text = ""
                        cbo÷¥–– ±º‰.Tag = "1"
                    End If
                End If
            End If
        End If
        
        '∏˘æ›’Ô¡∆”√∑®”√¡ø◊˜»± °…Ë÷√
        If InStr(",5,6,", .TextMatrix(.Row, COL_¿‡±)) > 0 Then
            strSQL = "Select ∆µ¥Œ,–°∂˘º¡¡ø,≥…»Àº¡¡ø,“Ω…˙÷ˆÕ–,¡∆≥Ã" & _
                " From ’Ô¡∆”√∑®”√¡ø Where –‘÷ >0 And œÓƒøID=[1] And ”√∑®ID=[2]"
            Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(.TextMatrix(.Row, COL_’Ô¡∆œÓƒøID)), Val(rsInput!ID))
            If rsTmp.EOF Then
                '“©∆∑√ª”–…Ë÷√”√∑®”√¡ø£¨‘Ú’“∏¯“©Õææ∂µƒ»± °∆µ¬ £®»Áπ˚÷ª…Ë÷√¡À“ª∏ˆø…”√∆µ¬ µƒª∞£©,÷Æ«∞ ‰»Î“Ω÷ˆœÓƒø ±…Ë÷√µƒ»± °∆µ¬  «∞¥±‡¬Î≈≈–Ú»°µƒµ⁄“ª∏ˆ
                strSQL = "Select ∆µ¥Œ From ’Ô¡∆”√∑®”√¡ø Where –‘÷ >0 And œÓƒøID=[1] Order by ∆µ¥Œ"
                Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(rsInput!ID))
                bln”√∑®∆µ¬  = rsTmp.RecordCount > 0
            Else
                bln”√∑®”√¡ø = True
            End If
            
            If bln”√∑®”√¡ø Or bln”√∑®∆µ¬  Then
                If Not IsNull(rsTmp!∆µ¥Œ) Then
                    Call Get∆µ¬ –≈œ¢_±‡¬Î(rsTmp!∆µ¥Œ, str∆µ¬ , int∆µ¬ ¥Œ ˝, int∆µ¬ º‰∏Ù, strº‰∏Ùµ•Œª)
                    txt∆µ¬ .Text = str∆µ¬ 
                    cmd∆µ¬ .Tag = str∆µ¬ 
                    txt∆µ¬ .Tag = "1"
                End If
                
                '∏˘æ›–¬µƒ∆µ¬ ÷ÿ–¬…Ë÷√÷¥–– ±º‰
                If cbo÷¥–– ±º‰.Enabled Then
                    Call Get ±º‰∑Ω∞∏(cbo÷¥–– ±º‰, Get∆µ¬ ∑∂Œß(.Row), str∆µ¬ , rsInput!ID)
                    If cbo÷¥–– ±º‰.ListCount > 0 Then
                        cbo÷¥–– ±º‰.ListIndex = 0
                        cbo÷¥–– ±º‰.Tag = "1"
                    Else
                        '≈–∂œµ±«∞÷¥–– ±º‰ «∑Ò∫œ∑®
                        If cbo÷¥–– ±º‰.Text <> "" Then
                            blnValid = ExeTimeValid(cbo÷¥–– ±º‰.Text, int∆µ¬ ¥Œ ˝, int∆µ¬ º‰∏Ù, strº‰∏Ùµ•Œª)
                            If Not blnValid Then '»Áπ˚≤ª∫œ∑®,‘Ú¡Ì»°,∑Ò‘Ú±£≥÷
                                cbo÷¥–– ±º‰.Text = ""
                                cbo÷¥–– ±º‰.Tag = "1"
                            End If
                        End If
                    End If
                End If
                
                If bln”√∑®”√¡ø Then
                    '“©∆∑µ•¡ø
                    If mintƒÍ¡‰ > 12 Then
                        If Nvl(rsTmp!≥…»Àº¡¡ø, 0) <> 0 Then
                            txtµ•¡ø.Text = FormatEx(rsTmp!≥…»Àº¡¡ø, 5)
                            txtµ•¡ø.Tag = "1"
                        End If
                    Else
                        If Nvl(rsTmp!–°∂˘º¡¡ø, 0) <> 0 Then
                            txtµ•¡ø.Text = FormatEx(rsTmp!–°∂˘º¡¡ø, 5)
                            txtµ•¡ø.Tag = "1"
                        ElseIf Nvl(rsTmp!≥…»Àº¡¡ø, 0) <> 0 Then
                            txtµ•¡ø.Text = FormatEx(rsTmp!≥…»Àº¡¡ø * (mintƒÍ¡‰ + 2) * 5 / 100, 5)
                            txtµ•¡ø.Tag = "1"
                        End If
                    End If
                    
                    '»°»± °µƒÃÏ ˝
                    sngÃÏ ˝ = msngÃÏ ˝
                    If mblnÃÏ ˝ Then
                        If strº‰∏Ùµ•Œª = "÷‹" Then
                            sngÃÏ ˝ = IIF(7 > sngÃÏ ˝, 7, sngÃÏ ˝)
                        ElseIf strº‰∏Ùµ•Œª = "ÃÏ" Then
                            sngÃÏ ˝ = IIF(int∆µ¬ º‰∏Ù > sngÃÏ ˝, int∆µ¬ º‰∏Ù, sngÃÏ ˝)
                        ElseIf strº‰∏Ùµ•Œª = "–° ±" Then
                            sngÃÏ ˝ = IIF(int∆µ¬ º‰∏Ù \ 24 > sngÃÏ ˝, int∆µ¬ º‰∏Ù \ 24, sngÃÏ ˝)
                        ElseIf strº‰∏Ùµ•Œª = "∑÷÷”" Then
                            If sngÃÏ ˝ = 0 Then sngÃÏ ˝ = 1
                        End If
                        If sngÃÏ ˝ = 0 Then sngÃÏ ˝ = 1
                    End If
                    If Nvl(rsTmp!¡∆≥Ã, 1) > sngÃÏ ˝ Then
                        sngÃÏ ˝ = Nvl(rsTmp!¡∆≥Ã, 1)
                    End If
                    If Val(.TextMatrix(.Row, COL_ÃÏ ˝)) > sngÃÏ ˝ Then
                        sngÃÏ ˝ = Val(.TextMatrix(.Row, COL_ÃÏ ˝))
                    End If
                    If Val(.TextMatrix(.Row, COL_ÃÏ ˝)) <> sngÃÏ ˝ Then
                        txtÃÏ ˝.Text = sngÃÏ ˝
                        txtÃÏ ˝.Tag = "1"
                    End If
                    
                    '“©∆∑¡Ÿ÷ˆ◊‹¡ø:√≈’Ô∞¸◊∞
                    If str∆µ¬  <> "" And Val(txtµ•¡ø.Text) <> 0 _
                        And Val(.TextMatrix(.Row, COL_º¡¡øœµ ˝)) <> 0 _
                        And Val(.TextMatrix(.Row, COL_√≈’Ô∞¸◊∞)) <> 0 Then
                        
                        txt◊‹¡ø.Text = FormatEx(Calc»± °“©∆∑◊‹¡ø( _
                            Val(txtµ•¡ø.Text), sngÃÏ ˝, _
                            int∆µ¬ ¥Œ ˝, int∆µ¬ º‰∏Ù, strº‰∏Ùµ•Œª, _
                            .TextMatrix(.Row, COL_÷¥–– ±º‰), _
                            Val(.TextMatrix(.Row, COL_º¡¡øœµ ˝)), _
                            Val(.TextMatrix(.Row, COL_√≈’Ô∞¸◊∞)), _
                            Val(.TextMatrix(.Row, COL_ø…∑Ò∑÷¡„))), 5)
                        If InStr(GetInsidePrivs(p√≈’Ô“Ω÷ˆœ¬¥Ô), "“©∆∑–° ˝ ‰»Î") = 0 Then
                            txt◊‹¡ø.Text = IntEx(Val(txt◊‹¡ø.Text))
                        ElseIf Val(.TextMatrix(.Row, COL_ø…∑Ò∑÷¡„)) <> 0 Then
                            txt◊‹¡ø.Text = IntEx(Val(txt◊‹¡ø.Text))
                        End If
                        txt◊‹¡ø.Tag = "1"
                    End If
                    
                    '“Ω…˙÷ˆÕ–
                    If Not IsNull(rsTmp!“Ω…˙÷ˆÕ–) Then
                        cbo“Ω…˙÷ˆÕ–.Text = rsTmp!“Ω…˙÷ˆÕ–
                        cbo“Ω…˙÷ˆÕ–.Tag = "1"
                    End If
                End If
            End If
        End If
    End With
    
    '¥¶¿Ìµ±«∞“Ω÷ˆ∏¯“©Õææ∂/ºÂ∑®µƒ±‰ªØ
    Call AdviceChange
    
    '∂‘±£œ’∂‘¬ÎΩ¯––ºÏ≤È
    Call GetInsureStr(strIDs1, strIDs2, str“Ω÷ˆƒ⁄»›, vsAdvice.Row)
    strMsg = CheckAdviceInsure(mintœ’¿‡, mblnÃ·–—∂‘¬Î, mlng≤°»ÀID, 1, strIDs1, strIDs2, str“Ω÷ˆƒ⁄»›)
    If strMsg <> "" Then
        If gint“Ω±£∂‘¬Î = 2 Then strMsg = strMsg & vbCrLf & vbCrLf & "«Îœ»∫Õœ‡πÿ»À‘±¡™œµ¥¶¿Ì£¨∑Ò‘Ú“Ω÷ˆΩ´≤ª‘ –Ì±£¥Ê°£"
        vMsg = frmMsgBox.ShowMsgBox(strMsg, Me, True)
        If vMsg = vbIgnore Then mblnÃ·–—∂‘¬Î = False
    End If
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Sub Set∆µ¬ Input(rsInput As ADODB.Recordset, ByVal int∑∂Œß As Integer)
'π¶ƒ‹£∫ ‰»Î÷¥––∆µ¬ ∫Ûµ˜”√
'≤Œ ˝£∫rsInput= ‰»ÎªÚ—°‘Òµƒ∑µªÿº«¬º
'      int∑∂Œß=1-Œ˜“Ω;2-÷–“Ω;-1-“ª¥Œ–‘;-2-≥÷–¯–‘
'Àµ√˜£∫≈‰∫œ”√∑®¥¶¿Ìø…”√÷¥–– ±º‰∑Ω∞∏µƒ±‰ªØ
    Dim lng”√∑®ID As Long, blnValid As Boolean
    Dim sngÃÏ ˝ As Single, dbl◊‹¡ø As Double
    Dim lngRow As Long
    
    cmd∆µ¬ .Tag = rsInput!√˚≥∆
    txt∆µ¬ .Text = rsInput!√˚≥∆
    txt∆µ¬ .Tag = "1"
        
    With vsAdvice
        'œ»…Ë÷√÷¥–– ±º‰µƒø…”√–‘:∑÷÷”∆µ¬ «–ªª
        lngRow = GetBaseRow(.Row)
        If Val(.TextMatrix(lngRow, COL_∆µ¬ –‘÷ )) = 0 Or InStr(",5,6,7,", .TextMatrix(lngRow, COL_¿‡±)) > 0 Then
            If Not cbo÷¥–– ±º‰.Enabled Then SetItemEditable , , , , 1
        Else
            If cbo÷¥–– ±º‰.Enabled Then SetItemEditable , , , , -1
        End If
        
        If cbo÷¥–– ±º‰.Enabled Then '"ø…—°∆µ¬ "ªÚ“©∆∑ ±
            If rsInput!º‰∏Ùµ•Œª = "∑÷÷”" Then
                If cbo÷¥–– ±º‰.Text <> "" Then cbo÷¥–– ±º‰.Tag = "1"
                cbo÷¥–– ±º‰.Text = ""
            Else
                '¥¶¿Ìø…”√÷¥–– ±º‰∑Ω∞∏µƒ±‰ªØ
                If InStr(",5,6,", .TextMatrix(.Row, COL_¿‡±)) > 0 Then
                    '≤È’“∏¯“©Õææ∂∂‘”¶µƒ––
                    lng”√∑®ID = .FindRow(CLng(.TextMatrix(.Row, COL_œ‡πÿID)), .Row + 1)
                    If lng”√∑®ID <> -1 Then 'Œ¥’“µΩ∏¯“©Õææ∂µƒ«Èøˆ,”¶∏√≤ªø…ƒ‹
                        lng”√∑®ID = Val(.TextMatrix(lng”√∑®ID, COL_’Ô¡∆œÓƒøID))
                    Else
                        lng”√∑®ID = 0
                    End If
                ElseIf RowIn≈‰∑Ω––(.Row) Then
                    'µ√µΩ∂‘”¶µƒ÷–“©”√∑®ID
                    lng”√∑®ID = Val(.TextMatrix(.Row, COL_’Ô¡∆œÓƒøID))
                End If
                
                Call Get ±º‰∑Ω∞∏(cbo÷¥–– ±º‰, int∑∂Œß, txt∆µ¬ .Text, lng”√∑®ID)
                '»°–¬µƒ∆µ¬ µƒƒ¨»œ÷¥–– ±º‰
                If cbo÷¥–– ±º‰.ListCount > 0 Then
                    cbo÷¥–– ±º‰.ListIndex = 0
                    cbo÷¥–– ±º‰.Tag = "1"
                Else
                    '≈–∂œµ±«∞÷¥–– ±º‰ «∑Ò∫œ∑®
                    If cbo÷¥–– ±º‰.Text <> "" Then
                        blnValid = ExeTimeValid(cbo÷¥–– ±º‰.Text, rsInput!∆µ¬ ¥Œ ˝, rsInput!∆µ¬ º‰∏Ù, rsInput!º‰∏Ùµ•Œª)
                        If Not blnValid Then '»Áπ˚≤ª∫œ∑®,‘Ú¡Ì»°,∑Ò‘Ú±£≥÷
                            cbo÷¥–– ±º‰.Text = ""
                            cbo÷¥–– ±º‰.Tag = "1"
                        End If
                    End If
                End If
            End If
            
            '÷ÿ–¬º∆À„◊‹¡ø
            If mblnÃÏ ˝ And InStr(",5,6,", .TextMatrix(.Row, COL_¿‡±)) > 0 Then
                sngÃÏ ˝ = Val(txtÃÏ ˝.Text)
                If sngÃÏ ˝ = 0 Then sngÃÏ ˝ = 1
                
                If txt∆µ¬ .Text <> "" And Val(txtµ•¡ø.Text) <> 0 _
                    And Val(.TextMatrix(.Row, COL_º¡¡øœµ ˝)) <> 0 _
                    And Val(.TextMatrix(.Row, COL_√≈’Ô∞¸◊∞)) <> 0 Then
                    
                    txt◊‹¡ø.Text = FormatEx(Calc»± °“©∆∑◊‹¡ø( _
                        Val(txtµ•¡ø.Text), sngÃÏ ˝, rsInput!∆µ¬ ¥Œ ˝, _
                        rsInput!∆µ¬ º‰∏Ù, rsInput!º‰∏Ùµ•Œª, cbo÷¥–– ±º‰.Text, _
                        Val(.TextMatrix(.Row, COL_º¡¡øœµ ˝)), _
                        Val(.TextMatrix(.Row, COL_√≈’Ô∞¸◊∞)), _
                        Val(.TextMatrix(.Row, COL_ø…∑Ò∑÷¡„))), 5)
                    If InStr(GetInsidePrivs(p√≈’Ô“Ω÷ˆœ¬¥Ô), "“©∆∑–° ˝ ‰»Î") = 0 Then
                        txt◊‹¡ø.Text = IntEx(Val(txt◊‹¡ø.Text))
                    ElseIf Val(.TextMatrix(.Row, COL_ø…∑Ò∑÷¡„)) <> 0 Then
                        txt◊‹¡ø.Text = IntEx(Val(txt◊‹¡ø.Text))
                    End If
                    txt◊‹¡ø.Tag = "1"
                End If
            End If
        End If
        If rsInput!º‰∏Ùµ•Œª = "∑÷÷”" Then
            If cbo÷¥–– ±º‰.Enabled Then SetItemEditable , , , , -1
        End If
    End With
        
    '¥¶¿Ìµ±«∞“Ω÷ˆ÷¥––∆µ¬ µƒ±‰ªØ
    Call AdviceChange
End Sub

Private Function GetBaseRow(ByVal lngRow As Long) As Long
'π¶ƒ‹£∫”…µ±«∞ø…º˚––ªÒ»°÷˜œÓƒøµƒ––
    If RowIn≈‰∑Ω––(lngRow) Then
        'ªÒ»°÷–“©≈‰∑Ωµ⁄“ªŒ∂÷–“©––
        GetBaseRow = vsAdvice.FindRow(CStr(vsAdvice.RowData(lngRow)), , COL_œ‡πÿID)
    ElseIf RowInºÏ—È––(lngRow) Then
        'ªÒ»°“ª≤¢≤…—˘µƒµ⁄“ª∏ˆœÓƒø––
        GetBaseRow = vsAdvice.FindRow(CStr(vsAdvice.RowData(lngRow)), , COL_œ‡πÿID)
    Else
        GetBaseRow = lngRow
    End If
End Function

Private Sub cboµŒÀŸ_Change()
    cboµŒÀŸ.Tag = "1"
End Sub

Private Sub cboµŒÀŸ_Click()
    cboµŒÀŸ.Tag = "1"
    Call AdviceChange
End Sub

Private Sub cboµŒÀŸ_GotFocus()
    zlControl.TxtSelAll cboµŒÀŸ
End Sub

Private Sub cboµŒÀŸ_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        KeyAscii = 0
        If SeekNextControl Then Call cboµŒÀŸ_Validate(False)
    ElseIf InStr("0123456789-" & Chr(8), Chr(KeyAscii)) = 0 Then
        KeyAscii = 0
    End If
End Sub

Private Sub cboµŒÀŸ_Validate(Cancel As Boolean)
    If zlCommFun.ActualLen(cboµŒÀŸ.Text) > 10 Then
        MsgBox "µŒÀŸ ‰»Îƒ⁄»›π˝≥§£¨«ÎºÏ≤È ‰»Î «∑Ò’˝»∑°£", vbInformation, gstrSysName
        Call cboµŒÀŸ_GotFocus: Cancel = True: Exit Sub
    End If
    
    '∏¸–¬ ˝æ›
    Call AdviceChange
End Sub

Private Sub cbo∏Ωº”÷¥––_Click()
    Dim rsTmp As ADODB.Recordset
    Dim lngRow As Long, strSQL As String
    Dim intIdx As Integer, i As Long
    Dim vRect As RECT, blnCancel As Boolean
        
    If cbo∏Ωº”÷¥––.ListIndex = -1 Then Exit Sub
    
    If cbo∏Ωº”÷¥––.ItemData(cbo∏Ωº”÷¥––.ListIndex) = -1 Then
        strSQL = "Select Distinct A.ID,A.±‡¬Î,A.√˚≥∆,A.ºÚ¬Î" & _
            " From ≤ø√≈±Ì A,≤ø√≈–‘÷ Àµ√˜ B" & _
            " Where A.ID=B.≤ø√≈ID And B.∑˛ŒÒ∂‘œÛ IN(1,3)" & _
            " And (A.≥∑µµ ±º‰=To_Date('3000-01-01','YYYY-MM-DD') Or A.≥∑µµ ±º‰ is NULL)" & _
            " And (A.’æµ„='" & gstrNodeNo & "' Or A.’æµ„ is Null)" & _
            " Order by A.±‡¬Î"
        vRect = GetControlRect(cbo∏Ωº”÷¥––.hWnd)
        Set rsTmp = zlDatabase.ShowSelect(Me, strSQL, 0, lbl∏Ωº”÷¥––.Caption, , , , , , True, vRect.Left, vRect.Top, txt”√∑®.Height, blnCancel, , True)
        If Not rsTmp Is Nothing Then
            intIdx = SeekCboIndex(cbo∏Ωº”÷¥––, rsTmp!ID)
            If intIdx <> -1 Then
                cbo∏Ωº”÷¥––.ListIndex = intIdx
            Else
                cbo∏Ωº”÷¥––.AddItem rsTmp!±‡¬Î & "-" & rsTmp!√˚≥∆, cbo∏Ωº”÷¥––.ListCount - 1
                cbo∏Ωº”÷¥––.ItemData(cbo∏Ωº”÷¥––.NewIndex) = rsTmp!ID
                cbo∏Ωº”÷¥––.ListIndex = cbo∏Ωº”÷¥––.NewIndex
            End If
        Else
            If Not blnCancel Then
                MsgBox "√ª”–ø∆ “ ˝æ›£¨«Îœ»µΩ≤ø√≈π‹¿Ì÷–…Ë÷√°£", vbInformation, gstrSysName
            End If
            'ª÷∏¥≥…œ÷”–µƒø∆ “(≤ª“˝∑¢Click)
            intIdx = SeekCboIndex(cbo∏Ωº”÷¥––, Val(vsAdvice.TextMatrix(vsAdvice.Row, COL_÷¥––ø∆ “ID)))
            Call zlControl.CboSetIndex(cbo∏Ωº”÷¥––.hWnd, intIdx)
        End If
    Else
        cbo∏Ωº”÷¥––.Tag = "1"
        lngRow = vsAdvice.Row
        
        '∏¸–¬∏¸∏ƒ¡Àµƒ÷¥––ø∆ ““Ω÷ˆƒ⁄»›
       Call AdviceChange
    End If
End Sub

Private Sub cbo∏Ωº”÷¥––_GotFocus()
    Call zlControl.TxtSelAll(cbo∏Ωº”÷¥––)
End Sub

Private Sub cbo∏Ωº”÷¥––_KeyPress(KeyAscii As Integer)
    Dim blnCancel As Boolean
    If KeyAscii = 13 Then
        KeyAscii = 0
        If cbo∏Ωº”÷¥––.ListIndex = -1 Then
            Call cbo∏Ωº”÷¥––_Validate(blnCancel)
        End If
        If Not blnCancel Then
            If SeekNextControl Then Call cbo∏Ωº”÷¥––_Validate(False)
        End If
    End If
End Sub

Private Sub cbo∏Ωº”÷¥––_Validate(Cancel As Boolean)
'π¶ƒ‹£∫∏˘æ› ‰»Îµƒƒ⁄»›,◊‘∂Ø∆•≈‰÷¥––ø∆ “
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String, intIdx As Long, i As Long
    Dim blnLimit As Boolean, strInput As String
    Dim vRect As RECT, blnCancel As Boolean
    
    If cbo∏Ωº”÷¥––.ListIndex <> -1 Then Exit Sub '“——°÷–
    If cbo∏Ωº”÷¥––.Text = "" Then 'Œﬁ ‰»Î
        With vsAdvice
            '‘≠“∫∆§ ‘
            If .TextMatrix(.Row, COL_¿‡±) = "E" And .TextMatrix(.Row, COL_≤Ÿ◊˜¿‡–Õ) = "1" And .TextMatrix(.Row, COL_÷¥––∑÷¿‡) = "5" Then
                cbo∏Ωº”÷¥––.Tag = "1"
                Call AdviceChange
                Exit Sub
            Else
                If cbo∏Ωº”÷¥––.ListCount > 0 Then Cancel = True
                Exit Sub
            End If
        End With
    End If
    
    On Error GoTo errH
    
    ' «∑Òø…“‘»Œ“‚ªÚ—°‘Òø∆ “
    blnLimit = True
    If cbo∏Ωº”÷¥––.ListCount > 0 Then
        If cbo∏Ωº”÷¥––.ItemData(cbo∏Ωº”÷¥––.ListCount - 1) = -1 Then
            blnLimit = False
        End If
    End If
    strInput = UCase(NeedName(cbo∏Ωº”÷¥––.Text))
    strSQL = "Select Distinct A.ID,A.±‡¬Î,A.√˚≥∆,A.ºÚ¬Î" & _
        " From ≤ø√≈±Ì A,≤ø√≈–‘÷ Àµ√˜ B" & _
        " Where A.ID=B.≤ø√≈ID And B.∑˛ŒÒ∂‘œÛ IN(1,3)" & _
        " And (A.≥∑µµ ±º‰=To_Date('3000-01-01','YYYY-MM-DD') Or A.≥∑µµ ±º‰ is NULL)" & _
        " And (A.’æµ„='" & gstrNodeNo & "' Or A.’æµ„ is Null)" & _
        " And (Upper(A.±‡¬Î) Like [1] Or Upper(A.√˚≥∆) Like [2] Or Upper(A.ºÚ¬Î) Like [2])" & _
        " Order by A.±‡¬Î"
    If blnLimit Then
        'Set rsTmp = New ADODB.Recordset
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, strInput & "%", mstrLike & strInput & "%")
        For i = 1 To rsTmp.RecordCount
            intIdx = SeekCboIndex(cbo∏Ωº”÷¥––, rsTmp!ID)
            If intIdx <> -1 Then cbo∏Ωº”÷¥––.ListIndex = intIdx: Exit For
            rsTmp.MoveNext
        Next
        If cbo∏Ωº”÷¥––.ListIndex = -1 Then
            MsgBox "Œ¥µΩ∂‘”¶µƒø∆ “°£", vbInformation, gstrSysName
            Cancel = True: Exit Sub
        End If
    Else
        vRect = GetControlRect(cbo∏Ωº”÷¥––.hWnd)
        Set rsTmp = zlDatabase.ShowSQLSelect(Me, strSQL, 0, lbl∏Ωº”÷¥––.Caption, False, "", "", False, False, True, _
            vRect.Left, vRect.Top, txt”√∑®.Height, blnCancel, False, True, strInput & "%", mstrLike & strInput & "%")
        If Not rsTmp Is Nothing Then
            intIdx = SeekCboIndex(cbo∏Ωº”÷¥––, rsTmp!ID)
            If intIdx <> -1 Then
                cbo∏Ωº”÷¥––.ListIndex = intIdx
            Else
                cbo∏Ωº”÷¥––.AddItem rsTmp!±‡¬Î & "-" & rsTmp!√˚≥∆, cbo∏Ωº”÷¥––.ListCount - 1
                cbo∏Ωº”÷¥––.ItemData(cbo∏Ωº”÷¥––.NewIndex) = rsTmp!ID
                cbo∏Ωº”÷¥––.ListIndex = cbo∏Ωº”÷¥––.NewIndex
            End If
        Else
            If Not blnCancel Then
                MsgBox "Œ¥µΩ∂‘”¶µƒø∆ “°£", vbInformation, gstrSysName
            End If
            Cancel = True: Exit Sub
        End If
    End If
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Sub cbo“Ω…˙÷ˆÕ–_LostFocus()
    Call zlCommFun.OpenIme(False)
End Sub

Private Sub cbsMain_GetClientBordersWidth(Left As Long, Top As Long, Right As Long, Bottom As Long)
    Bottom = Me.stbThis.Height
End Sub

Private Sub cbsMain_InitCommandsPopup(ByVal CommandBar As XtremeCommandBars.ICommandBar)
    Dim strTmp As String, arrTmp As Variant
    Dim objControl As CommandBarControl
    Dim i As Long
    
    If CommandBar Is Nothing Then Exit Sub
    If CommandBar.Parent Is Nothing Then Exit Sub
    Select Case CommandBar.Parent.ID
    Case conMenu_Tool_PlugIn
        Call CreatePlugInOK(p√≈’Ô“Ω÷ˆœ¬¥Ô, mint≥°∫œ)
        If Not gobjPlugIn Is Nothing Then
            On Error Resume Next
            If mint≥°∫œ = 0 Then '“Ω…˙’æµ˜”√
                strTmp = gobjPlugIn.GetFuncNames(glngSys, p√≈’Ô“Ω÷ˆœ¬¥Ô, 0)
            ElseIf mint≥°∫œ = 1 Then 'ª§ ø’æµ˜”√
                strTmp = gobjPlugIn.GetFuncNames(glngSys, p√≈’Ô“Ω÷ˆœ¬¥Ô, 1)
            ElseIf mint≥°∫œ = 2 Then '“Ωºº’æµ˜”√
                strTmp = gobjPlugIn.GetFuncNames(glngSys, p√≈’Ô“Ω÷ˆœ¬¥Ô, 2)
            End If
            Call zlPlugInErrH(err, "GetFuncNames")
            err.Clear: On Error GoTo 0
        End If
        If strTmp <> "" Then
            With CommandBar.Controls
                If .Count = 0 Then
                    strTmp = Replace(strTmp, "Auto:", "")
                    arrTmp = Split(strTmp, ",")
                    For i = 0 To UBound(arrTmp)
                        Set objControl = .Add(xtpControlButton, conMenu_Tool_PlugIn_Item + i + 1, CStr(arrTmp(i)))
                        If i <= 9 Then objControl.Caption = objControl.Caption & "(&" & IIF(i = 9, 0, i + 1) & ")"
                        objControl.IconId = conMenu_Tool_PlugIn_Item
                        objControl.Parameter = arrTmp(i)
                    Next
                End If
            End With
        End If
    End Select
End Sub

Private Sub cbsMain_Resize()
    Dim lngLeft As Long, lngTop  As Long, lngRight  As Long, lngBottom  As Long
    Dim lngColW As Long, i As Long
    
    Call Me.cbsMain.GetClientRect(lngLeft, lngTop, lngRight, lngBottom)
    
    On Error Resume Next
    
    fraPati.Left = lngLeft
    fraPati.Top = lngTop
    fraPati.Width = lngRight - lngLeft
    fraPati.Height = cmdAlley.Top + cmdAlley.Height + 60
    
    fra’Ô∂œ.Left = lngLeft
    fra’Ô∂œ.Top = fraPati.Top + fraPati.Height
    fra’Ô∂œ.Width = lngRight - lngLeft
    
    opt’Ô∂œ(1).Left = fra’Ô∂œ.Width - opt’Ô∂œ(1).Width - 10 * Screen.TwipsPerPixelX
    opt’Ô∂œ(0).Left = opt’Ô∂œ(1).Left
    vsDiag.Width = opt’Ô∂œ(0).Left - vsDiag.Left - 100
    For i = 0 To vsDiag.Cols - 1
        If Not vsDiag.ColHidden(i) And i <> col’Ô∂œ Then
            lngColW = lngColW + vsDiag.ColWidth(i)
        End If
    Next
    vsDiag.ColWidth(col’Ô∂œ) = vsDiag.Width - lngColW - 2 * Screen.TwipsPerPixelX
    
    vsAdvice.Left = lngLeft
    vsAdvice.Top = fraPati.Top + fraPati.Height + fra’Ô∂œ.Height
    vsAdvice.Height = lngBottom - lngTop - fraPati.Height - fra’Ô∂œ.Height - (fraAdvice.Height - 80) - IIF(pic“…Œ .Visible, pic“…Œ .Height, 0)
    vsAdvice.Width = lngRight - lngLeft
    
    pic“…Œ .Left = 0
    pic“…Œ .Top = vsAdvice.Top + vsAdvice.Height
    pic“…Œ .Width = vsAdvice.Width
    lbl“…Œ .Width = pic“…Œ .ScaleWidth - lbl“…Œ .Left - 45
    
    fraAdvice.Left = lngLeft
    fraAdvice.Top = vsAdvice.Top + vsAdvice.Height - 6 * Screen.TwipsPerPixelX + IIF(pic“…Œ .Visible, pic“…Œ .Height, 0)
    fraAdvice.Width = lngRight - lngLeft
    
    stbThis.Top = lngBottom - 10
    stbThis.Width = picSub.ScaleWidth
End Sub

Private Sub cbsMain_Update(ByVal Control As XtremeCommandBars.ICommandBarControl)
    Dim blnEnabled As Boolean
    Dim intLoop As Integer
    Dim strTmp As String
    Dim vRect As RECT, vPos As PointAPI
    
    If vsAdvice.Redraw = flexRDNone Then Exit Sub
    
    'PASS∂˛º∂≤Àµ•µƒø…º˚–‘”Îø…”√–‘‘⁄∂¿¡¢≤øº˛÷–…Ë÷√£¨¥À ±–Ë“™∆¡±Œ£¨»Á≤ª∆¡±Œ£¨≤øº˛÷–…Ë÷√÷µΩ´ª·±ª∏≤∏«
    If Between(Control.ID, conMenu_Edit_MediAudit * 10#, conMenu_Edit_MediAudit * 10# + 99) Then
        Exit Sub
    End If
    
    Select Case Control.ID
        Case conMenu_Delete
            With vsAdvice
                blnEnabled = True
                If .RowData(.Row) <> 0 Then
                    If Not fraAdvice.Enabled And Val(.TextMatrix(.Row, COL_…Û∫À◊¥Ã¨)) <> 2 Then blnEnabled = False
                    If Not fraAdvice.Enabled And Val(.TextMatrix(.Row, COL_…Û∫À◊¥Ã¨)) = 2 And .TextMatrix(.Row, COL_¿‡±) = "K" And gbln—™ø‚œµÕ≥ Then blnEnabled = False
                    If .TextMatrix(.Row, COL_¿‡±) = "K" And Val(.TextMatrix(.Row, COL_ºÏ≤È∑Ω∑®)) = 1 And Val(.TextMatrix(.Row, COL_…Û∫À◊¥Ã¨)) = 1 Then blnEnabled = False
                    If Val(.TextMatrix(.Row, COL_◊¥Ã¨)) <> 1 Then blnEnabled = False
                    '“—«©√˚“Ω÷ˆ≤ªø……æ≥˝
                    If Val(.TextMatrix(.Row, COL_«©√˚∑Ò)) = 1 Then blnEnabled = False
                End If
                Control.Enabled = blnEnabled
            End With
        Case conMenu_Merge
            Control.Checked = mblnRowMerge
        Case conMenu_Scheme, conMenu_Scheme * 10# + 1, conMenu_Scheme * 10# + 2
                        If mblnModal Then
                Control.Visible = False
            Else
            If InStr(GetInsidePrivs(p√≈’Ô“Ω÷ˆœ¬¥Ô), "±£¥Ê≥…Ã◊∑Ω∞∏") = 0 Then
                Control.Visible = False
            End If
            If Control.ID = conMenu_Scheme * 10# + 2 Then
                Control.Caption = IIF(mfrmShortCut.Visible, "“˛≤ÿ", "œ‘ æ") & "≥…Ã◊∑Ω∞∏—°‘Ò∆˜"
            End If
                        End If
        Case conMenu_Agent
            If Not mblnAddAgent Then
                Control.Visible = False
            Else
                strTmp = GetTsPrivs(p√≈’Ô“Ω÷ˆœ¬¥Ô)
                Control.Visible = InStr(strTmp, "œ¬¥Ô¬È◊Ì“©÷ˆ") > 0 Or InStr(strTmp, "œ¬¥Ô∂æ–‘“©÷ˆ") > 0 Or InStr(strTmp, "œ¬¥Ôæ´…Ò“©÷ˆ") > 0
            End If
        Case conMenu_Save
            Control.Enabled = mblnNoSave
        Case conMenu_Sign
            If mint≥°∫œ = 1 Or InStr(UserInfo.–‘÷ , "“Ω…˙") = 0 Or gobjESign Is Nothing _
                Or InStr(GetInsidePrivs(p√≈’Ô“Ω÷ˆœ¬¥Ô), ";“Ω÷ˆœ¬¥Ô;") = 0 Then
                Control.Visible = False
            ElseIf mint≥°∫œ = 0 And Control.Category <> "“—≈–∂œ" Then
                If CheckSign(0, 0, mlng“Ωººø∆ “ID, mlng≤°»Àø∆ “id, 1, False, gobjESign) = False Then
                    Control.Visible = False '≤ªÕ¨≥°∫œ√ª”–…Ë÷√“™ π”√«©√˚
                End If
                Control.Category = "“—≈–∂œ"
            ElseIf mint≥°∫œ = 2 And Control.Category <> "“—≈–∂œ" Then
                If CheckSign(3, 0, mlng“Ωººø∆ “ID, mlng≤°»Àø∆ “id, 1, False, gobjESign) = False Then
                    Control.Visible = False '≤ªÕ¨≥°∫œ√ª”–…Ë÷√“™ π”√«©√˚
                End If
                Control.Category = "“—≈–∂œ"
            End If
        Case conMenu_Send, conMenu_Send * 10# + 1, conMenu_Send * 10# + 2
            If InStr(GetInsidePrivs(p√≈’Ô“Ω÷ˆœ¬¥Ô), "“Ω÷ˆ∑¢ÀÕ") = 0 Then
                Control.Visible = False
            ElseIf InStr(GetInsidePrivs(p√≈’Ô“Ω÷ˆœ¬¥Ô), "∑¢ÀÕŒ™ ’∑—µ•") = 0 And InStr(GetInsidePrivs(p√≈’Ô“Ω÷ˆœ¬¥Ô), "∑¢ÀÕŒ™º«’ µ•") = 0 Then
                Control.Visible = False
            End If
            If Val(zlDatabase.GetPara("∑¢ÀÕµ•æ›¿‡–Õ", glngSys, p√≈’Ô“Ω÷ˆœ¬¥Ô)) = 0 And InStr(GetInsidePrivs(p√≈’Ô“Ω÷ˆœ¬¥Ô), "∑¢ÀÕŒ™ ’∑—µ•") = 0 Or _
               Val(zlDatabase.GetPara("∑¢ÀÕµ•æ›¿‡–Õ", glngSys, p√≈’Ô“Ω÷ˆœ¬¥Ô)) = 1 And InStr(GetInsidePrivs(p√≈’Ô“Ω÷ˆœ¬¥Ô), "∑¢ÀÕŒ™º«’ µ•") = 0 Then
                Control.Visible = False
            End If
                Case conMenu_Edit_ViewDrugExplain '≤Èø¥“©∆∑Àµ√˜ È
                Control.Enabled = vsAdvice.RowData(vsAdvice.Row) <> 0 And InStr(",5,6,7,", vsAdvice.TextMatrix(vsAdvice.Row, COL_¿‡±)) > 0
        Case conMenu_Reference
            If GetInsidePrivs(p“©∆∑’Ô¡∆≤Œøº) = "" Then
                Control.Visible = False
            End If
        Case Else
            'µ•¡øœ‘ æ◊¥Ã¨
            blnEnabled = False
            If txtµ•¡ø.Enabled Then
                If InStr(",5,6,", vsAdvice.TextMatrix(vsAdvice.Row, COL_¿‡±)) > 0 Then
                    GetCursorPos vPos
                    GetWindowRect fraAdvice.hWnd, vRect
                    If Between(vPos.X * Screen.TwipsPerPixelX, vRect.Left * Screen.TwipsPerPixelX + lblµ•¡ø.Left, vRect.Left * Screen.TwipsPerPixelX + lblµ•¡ø.Left + lblµ•¡ø.Width) Then
                        If Between(vPos.Y * Screen.TwipsPerPixelY, vRect.Top * Screen.TwipsPerPixelY + lblµ•¡ø.Top, vRect.Top * Screen.TwipsPerPixelY + lblµ•¡ø.Top + lblµ•¡ø.Height) Then
                            blnEnabled = True
                        End If
                    End If
                End If
            End If
            Call Setµ•¡øFace(blnEnabled)
    End Select
End Sub

Private Sub chk√‚ ‘_Click()
    If Not mblnDoCheck Then Exit Sub
    
    chk√‚ ‘.Tag = "1"
    '∏¸–¬ ˝æ›
    Call AdviceChange
End Sub

Private Sub chk√‚ ‘_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        KeyAscii = 0
        Call SeekNextControl
    End If
End Sub

Private Sub cmdAlley_Click()
'π¶ƒ‹£∫∂‘≤°»Àπ˝√Ù ∑/≤°…˙◊¥Ã¨Ω¯––π‹¿Ì
    'Pass
    If mblnPass Then
        Call gobjPass.zlPassCmdAlleyManage(mobjPassMap)
    End If
End Sub

Private Sub cmdLastDiag_Click()
'π¶ƒ‹£∫∂¡»°…œ¥ŒæÕ’Ôµƒ’Ô∂œ–≈œ¢£¨◊∑º”µΩœ÷”–’Ô∂œ∫Û
    Dim strSQL As String, rsTmp As Recordset
    Dim i As Long, strTmp As String
    
    If MsgBox(" «∑Ò∂¡»°…œ¥Œ’Ô∂œ–≈œ¢ÃÌº”µΩœ÷”–’Ô∂œ÷Æ∫Û£ø", vbQuestion + vbYesNo + vbDefaultButton2, Me.Caption) = vbYes Then
        On Error GoTo errH
        strSQL = "Select A.ID,A.º«¬º¿¥‘¥,A.’Ô∂œ¿‡–Õ,A.º≤≤°ID,A.’Ô∂œID,A.÷§∫ÚID,A.’Ô∂œ√Ë ˆ,A. «∑Ò“…’Ô,c.±‡¬Î as ICD¬Î,D.±‡¬Î as ’Ô∂œ±‡¬Î,E.±‡¬Î as ÷§∫Ú±‡¬Î,A.∑¢≤° ±º‰" & vbNewLine & _
            "From ≤°»À’Ô∂œº«¬º A, ≤°»Àπ“∫≈º«¬º B,º≤≤°±‡¬Îƒø¬º C, º≤≤°’Ô∂œƒø¬º D,º≤≤°±‡¬Îƒø¬º E" & vbNewLine & _
            "Where a.≤°»Àid = b.≤°»Àid And a.÷˜“≥id = b.Id And A.º≤≤°ID=C.ID(+)  And a.’Ô∂œid = D.Id(+) And  a.÷§∫ÚID=E.ID(+) And a.≤°»Àid = [1] And (’Ô∂œ¿‡–Õ = 1 Or ’Ô∂œ¿‡–Õ = 11) And" & vbNewLine & _
            "   (d.≥∑µµ ±º‰ Is Null Or d.≥∑µµ ±º‰ = To_Date('3000-01-01', 'YYYY-MM-DD')) And (c.≥∑µµ ±º‰ Is Null Or c.≥∑µµ ±º‰ = To_Date('3000-01-01', 'YYYY-MM-DD')) And b.µ«º« ±º‰ =" & vbNewLine & _
            "      (Select Max(µ«º« ±º‰)" & vbNewLine & _
            "       From ≤°»Àπ“∫≈º«¬º C" & vbNewLine & _
            "       Where c.≤°»Àid = [1] And ID <> [2] And Exists (Select 1 From ≤°»À’Ô∂œº«¬º D Where d.≤°»Àid = [1] And ÷˜“≥id = c.Id))"
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng≤°»ÀID, mlngπ“∫≈ID)
        If rsTmp.RecordCount = 0 Then
            MsgBox "∏√≤°»À‘⁄±æ¥ŒæÕ’Ô÷Æ«∞Œ¥ÃÓ–¥π˝√≈’Ô’Ô∂œªÚ’ﬂÃÓ–¥π˝µƒ’Ô∂œ“—Õ£”√°£", vbInformation
        Else
            With vsDiag
                Do While Not rsTmp.EOF
                    i = -1
                    If Val(rsTmp!’Ô∂œid & "") <> 0 Then i = .FindRow(Val(rsTmp!’Ô∂œid & ""), , col’Ô∂œID)
                    If i = -1 And Val(rsTmp!º≤≤°id & "") <> 0 Then i = .FindRow(Val(rsTmp!º≤≤°id & ""), , colº≤≤°ID)
                    '»Áπ˚µ±«∞“—æ≠ÃÓ–¥£¨‘Ú÷ª∏¸–¬∑¢≤° ±º‰
                    If i <> -1 Then
                        If .TextMatrix(i, col∑¢≤° ±º‰) = "" Then
                            .TextMatrix(i, col∑¢≤° ±º‰) = Format(rsTmp!∑¢≤° ±º‰ & "", "YYYY-MM-DD HH:mm")
                        End If
                    Else
                        If Not (.TextMatrix(1, col’Ô∂œ) = "" And .Rows = 2) Then .AddItem ""
                        i = .Rows - 1
                        Call SetDiagType(i, rsTmp!’Ô∂œ¿‡–Õ)
                        
                        If IsNull(rsTmp!’Ô∂œ√Ë ˆ) Then
                            .TextMatrix(i, col±‡¬Î) = ""
                            .TextMatrix(i, col’Ô∂œ) = ""
                        Else
                            If Mid(rsTmp!’Ô∂œ√Ë ˆ, 1, 1) <> "(" Or (Val(rsTmp!’Ô∂œid & "") = 0 And Val(rsTmp!º≤≤°id & "") = 0) Then '÷–“Ωµƒ’Ô∂œ√Ë ˆ∫Û√Êº”¡À£®∫Ú÷¢£©£¨À˘“‘÷ª≈–∂œµ⁄“ª∏ˆ◊÷∑˚
                                '”…”⁄º≤≤°±‡¬Î∫Õ’Ô∂œø…“‘∂‘”¶£¨»Áπ˚¡Ω∏ˆ∂º≤ªŒ™ø’µƒ ±∫Ú£¨œ»≈–∂œº≤≤°±‡¬Î£¨œ»»°º≤≤°±‡¬Î
                                If Val(rsTmp!º≤≤°id & "") <> 0 Then
                                    .TextMatrix(i, col±‡¬Î) = Nvl(rsTmp!ICD¬Î)
                                ElseIf Val(rsTmp!’Ô∂œid & "") <> 0 Then
                                    .TextMatrix(i, col±‡¬Î) = Nvl(rsTmp!’Ô∂œ±‡¬Î)
                                Else
                                    .TextMatrix(i, col±‡¬Î) = ""
                                End If
                                .TextMatrix(i, col’Ô∂œ) = rsTmp!’Ô∂œ√Ë ˆ
                            Else
                                .TextMatrix(i, col±‡¬Î) = Mid(rsTmp!’Ô∂œ√Ë ˆ, 2, InStr(rsTmp!’Ô∂œ√Ë ˆ, ")") - 2)
                                .TextMatrix(i, col’Ô∂œ) = Mid(rsTmp!’Ô∂œ√Ë ˆ, InStr(rsTmp!’Ô∂œ√Ë ˆ, ")") + 1)
                            End If
                        End If

                        .Cell(flexcpData, i, col“…’Ô) = Val(Nvl(rsTmp! «∑Ò“…’Ô, 0))
                        .Cell(flexcpForeColor, i, col“…’Ô) = IIF(Nvl(rsTmp! «∑Ò“…’Ô, 0) = 1, vbRed, .GridColor)
                        
                        .TextMatrix(i, col’Ô∂œID) = Nvl(rsTmp!’Ô∂œid, 0)
                        .Cell(flexcpData, i, col’Ô∂œID) = Nvl(rsTmp!ID, 0)
                        .TextMatrix(i, colº≤≤°ID) = Nvl(rsTmp!º≤≤°id, 0)
                        .TextMatrix(i, col÷§∫ÚID) = Nvl(rsTmp!÷§∫Úid, 0)
                        .TextMatrix(i, colICD¬Î) = Nvl(rsTmp!ICD¬Î)
                        .TextMatrix(i, col∑¢≤° ±º‰) = Format(rsTmp!∑¢≤° ±º‰ & "", "YYYY-MM-DD HH:mm")
                        '»°÷§∫Ú√˚≥∆
                        If InStr(.TextMatrix(i, col’Ô∂œ), "(") > 0 And InStr(.TextMatrix(i, col’Ô∂œ), ")") > 0 Then
                            strTmp = Mid(.TextMatrix(i, col’Ô∂œ), InStrRev(.TextMatrix(i, col’Ô∂œ), "(") + 1)
                            strTmp = Mid(strTmp, 1, Len(strTmp) - 1)
                            'œ»»°÷§∫Ú
                            .TextMatrix(i, col÷–“Ω÷§∫Ú) = strTmp
                            '»•µÙ’Ô∂œ√Ë ˆµƒ÷§∫Ú
                            .TextMatrix(i, col’Ô∂œ) = Mid(.TextMatrix(i, col’Ô∂œ), 1, InStrRev(.TextMatrix(i, col’Ô∂œ), "(") - 1)
                        Else
                           .TextMatrix(i, col÷–“Ω÷§∫Ú) = ""
                        End If
                        '◊‘”…¬º»Î’Ô∂œµƒ’Ô∂œ√Ë ˆ£¨–Ë“™»•µÙ÷§∫Ú£¨“Ú¥À¥Àæ‰¥˙¬Î∫Û“∆
                        If Not IsNull(rsTmp!º≤≤°id) Or Not IsNull(rsTmp!’Ô∂œid) Then
                            .Cell(flexcpData, i, col’Ô∂œ) = Get’Ô∂œ√Ë ˆ(Val("" & rsTmp!’Ô∂œid), Val("" & rsTmp!º≤≤°id))    'ªÒ»°‘≠ º√˚≥∆“‘±„–ﬁ∏ƒ ±≈–∂œ
                        Else
                            .Cell(flexcpData, i, col’Ô∂œ) = .TextMatrix(i, col’Ô∂œ)
                        End If
                    End If
                    
                    rsTmp.MoveNext
                Loop
                mblnNoSave = True: lbl’Ô∂œ.Tag = "1"
                Call SetDiagHeight
            End With
        End If
    End If
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Sub cmdReason_Click()
    Call ReasonSelect("", 1)
    Call AdviceChange
End Sub

Private Sub cmdExcReason_Click()
    Call ReasonSelect("", 3)
    Call AdviceChange
End Sub

Private Function ReasonSelect(ByVal strFind As String, ByVal intType As Integer) As Boolean
'≥£”√÷ˆÕ–∫Õøπæ˙”√“©¿Ì”…≥¨¡øÀµ√˜—°‘Ò∆˜
'intType  1-øπæ˙”√“©¿Ì”…£¨2-≥£”√÷ˆÕ–£¨3-≥¨¡øÀµ√˜
    Dim blnCancle As Boolean
    Dim strRetrun As String
    Dim lngLeft As Long, lngTop As Long
    Dim strName As String
    
    If intType = 1 Then
        lngLeft = txt”√“©¿Ì”….Left
        lngTop = txt”√“©¿Ì”….Top
        strName = "øπæ˙”√“©¿Ì”…°£"
    ElseIf intType = 2 Then
        lngLeft = cbo“Ω…˙÷ˆÕ–.Left
        lngTop = cbo“Ω…˙÷ˆÕ–.Top
        strName = "≥£”√÷ˆÕ–°£"
    ElseIf intType = 3 Then
        lngLeft = txt≥¨¡øÀµ√˜.Left
        lngTop = txt≥¨¡øÀµ√˜.Top
        strName = "≥¨¡øÀµ√˜°£"
    End If
    
    lngLeft = lngLeft + fraAdvice.Left + Me.Left
    lngTop = lngTop + fraAdvice.Top + Me.Top - 2600
    
    strRetrun = frmKssReasonSelect.ShowMe(Me, strFind, blnCancle, lngLeft, lngTop, intType)
    If Not blnCancle Then
        If strRetrun = "" Then
            If strFind = "" Then
                MsgBox "√ª”–’“µΩø…”√µƒ" & strName, vbInformation, Me.Caption
            End If
        Else
            If intType = 1 Then
                txt”√“©¿Ì”….Text = strRetrun
            ElseIf intType = 2 Then
                cbo“Ω…˙÷ˆÕ–.Text = strRetrun
            ElseIf intType = 3 Then
                txt≥¨¡øÀµ√˜.Text = strRetrun
            End If
        End If
    End If
    ReasonSelect = blnCancle
End Function

Private Sub ReasonSave(ByVal intType As Integer)
'π¶ƒ‹£∫øπæ˙”√“©¿Ì”…∫Õ≥¨¡øÀµ√˜±£¥Ê
'≤Œ ˝£∫intType  0-øπæ˙”√“©¿Ì”…£¨1-≥¨¡øÀµ√˜
    Dim strSQL As String, rsTmp As Recordset
    Dim strTmp As String
    Dim strPar As String
    
    If txt”√“©¿Ì”….Text = "" And intType = 0 Then MsgBox "«Î ‰»Îƒ˙–Ë“™ ’≤ÿµƒ”√“©¿Ì”…°£", vbInformation, Me.Caption: txt”√“©¿Ì”….SetFocus: Exit Sub
    If txt≥¨¡øÀµ√˜.Text = "" And intType = 1 Then MsgBox "«Î ‰»Îƒ˙–Ë“™ ’≤ÿµƒ≥¨¡øÀµ√˜°£", vbInformation, Me.Caption: txt≥¨¡øÀµ√˜.SetFocus: Exit Sub
    
    If intType = 0 Then
        strPar = txt”√“©¿Ì”….Text
        strTmp = "”√“©¿Ì”…"
    ElseIf intType = 1 Then
        strPar = txt≥¨¡øÀµ√˜.Text
        strTmp = "≥¨¡øÀµ√˜"
    End If
    
    On Error GoTo errH
    strSQL = "Select 1 From “Ω÷ˆ≥£”√‘≠“Ú Where √˚≥∆=[1]"
    If intType = 1 Then strSQL = strSQL & " And –‘÷ =1 And »À‘±=[2]"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, strPar, UserInfo.–’√˚)
    '»Áπ˚“—æ≠”–¡À£¨Ã· æ”√ªß «∑ÒºÃ–¯°£
    If rsTmp.RecordCount > 0 Then
        MsgBox "“—æ≠¥Ê‘⁄œ‡Õ¨µƒ" & strTmp & "°£", vbInformation, Me.Caption
        Exit Sub
    End If
    strSQL = "zl_“Ω÷ˆ≥£”√‘≠“Ú_Update(0,Null,'" & strPar & "',Null" & _
        IIF(intType = 1, ",1,'" & UserInfo.–’√˚ & "'", "") & ")"
    zlDatabase.ExecuteProcedure strSQL, Me.Caption
    MsgBox strTmp & " ’≤ÿ≥…π¶°£", vbInformation, Me.Caption
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Sub cmd≥£”√÷ˆÕ–_Click()
    Dim strSQL As String, i As Integer
    Dim rsTmp As Recordset
    
    If Trim(cbo“Ω…˙÷ˆÕ–.Text) = "" Then
        MsgBox "«Î ‰»Î÷ˆÕ–ƒ⁄»›°£", vbInformation, gstrSysName
        If cbo“Ω…˙÷ˆÕ–.Enabled Then cbo“Ω…˙÷ˆÕ–.SetFocus
        Exit Sub
    End If
    On Error GoTo errH
    strSQL = "Select 1 From ≥£”√÷ˆÕ– Where √˚≥∆=[1] And (»À‘±=[2] Or »À‘± is null)"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Trim(cbo“Ω…˙÷ˆÕ–.Text), UserInfo.–’√˚)
    If rsTmp.RecordCount > 0 Then
        MsgBox "∏√÷ˆÕ–ƒ⁄»›“—æ≠‘⁄≥£”√÷ˆÕ–÷–°£", vbInformation, gstrSysName
        If cbo“Ω…˙÷ˆÕ–.Enabled Then cbo“Ω…˙÷ˆÕ–.SetFocus
        Exit Sub
    End If
    
    strSQL = zlCommFun.zlGetSymbol(cbo“Ω…˙÷ˆÕ–.Text, CByte(mintºÚ¬Î))
    strSQL = "zl_≥£”√÷ˆÕ–_Insert('" & Replace(cbo“Ω…˙÷ˆÕ–.Text, "'", "''") & "','" & strSQL & "','" & UserInfo.–’√˚ & "')"
    Call zlDatabase.ExecuteProcedure(strSQL, Me.Caption)
    
    AddComboItem cbo“Ω…˙÷ˆÕ–.hWnd, CB_ADDSTRING, 0, cbo“Ω…˙÷ˆÕ–.Text
    MsgBox "“—…Ë÷√Œ™≥£”√÷ˆÕ–°£", vbInformation, gstrSysName
    If cbo“Ω…˙÷ˆÕ–.Enabled Then cbo“Ω…˙÷ˆÕ–.SetFocus
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Sub cmd∆µ¬ _Click()
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String, blnCancel As Boolean
    Dim int∑∂Œß As Integer, vRect As RECT
    Dim strSeek As String, lng’Ô¡∆œÓƒøID As Long, lngFind As Long
    
    On Error GoTo errH
    
    With vsAdvice
        int∑∂Œß = Get∆µ¬ ∑∂Œß(.Row)
        
        If txt∆µ¬ .Text <> "" Then
            strSQL = "Select ±‡¬Î From ’Ô¡∆∆µ¬ œÓƒø Where √˚≥∆=[1] And   ”√∑∂Œß=[2]"
            Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, txt∆µ¬ .Text, int∑∂Œß)
            If Not rsTmp.EOF Then strSeek = rsTmp!±‡¬Î
        End If
        
        'ø…—°‘Ò∆µ¬ µƒ≥£”√∆µ¬ 
        lng’Ô¡∆œÓƒøID = Val(.TextMatrix(.Row, COL_’Ô¡∆œÓƒøID))
        If RowInºÏ—È––(.Row) Then
            lngFind = .FindRow(CStr(.RowData(.Row)), .FixedRows, COL_œ‡πÿID)
            If lngFind <> -1 Then
                lng’Ô¡∆œÓƒøID = Val(.TextMatrix(lngFind, COL_’Ô¡∆œÓƒøID))
            End If
        ElseIf InStr(",5,6,", .TextMatrix(.Row, COL_¿‡±)) > 0 Then
            lngFind = .FindRow(CLng(.TextMatrix(.Row, COL_œ‡πÿID)), .Row + 1)
            If lngFind <> -1 Then
                lng’Ô¡∆œÓƒøID = Val(.TextMatrix(lngFind, COL_’Ô¡∆œÓƒøID))
            End If
        End If
        strSQL = ""
        If int∑∂Œß = 1 Then
            strSQL = " And (Exists(Select 1 From ’Ô¡∆”√∑®”√¡ø Where œÓƒøID=[2] And ”√∑®ID is NULL And ∆µ¥Œ=A.±‡¬Î And A.  ”√∑∂Œß=1)" & _
                " Or (Select Count(*) From ’Ô¡∆”√∑®”√¡ø Where œÓƒøID=[2] And ”√∑®ID is NULL And ∆µ¥Œ Is Not NULL)<=1)"
        End If
        strSQL = "Select Rownum as ID,A.±‡¬Î,A.√˚≥∆,A.ºÚ¬Î," & _
            " A.”¢Œƒ√˚≥∆,A.∆µ¬ ¥Œ ˝,A.∆µ¬ º‰∏Ù,A.º‰∏Ùµ•Œª" & _
            " From ’Ô¡∆∆µ¬ œÓƒø A Where A.  ”√∑∂Œß=[1]" & strSQL & _
            " Order by A.±‡¬Î"
        vRect = GetControlRect(txt∆µ¬ .hWnd)
        Set rsTmp = zlDatabase.ShowSQLSelect(Me, strSQL, 0, "’Ô¡∆∆µ¬ ", False, strSeek, "", False, False, True, _
            vRect.Left, vRect.Top, txt∆µ¬ .Height, blnCancel, False, True, int∑∂Œß, lng’Ô¡∆œÓƒøID)
        If rsTmp Is Nothing Then
            If Not blnCancel Then
                MsgBox "√ª”–ø…”√µƒ’Ô¡∆∆µ¬ œÓƒø£¨«Îœ»µΩ“Ω÷ˆ∆µ¬ π‹¿Ì÷–…Ë÷√°£", vbInformation, gstrSysName
            End If
            txt∆µ¬ .Text = .TextMatrix(.Row, COL_∆µ¬ )
            Call zlControl.TxtSelAll(txt∆µ¬ )
            txt∆µ¬ .SetFocus: Exit Sub
        End If
        Call Set∆µ¬ Input(rsTmp, int∑∂Œß)
        txt∆µ¬ .SetFocus
        Call SeekNextControl
    End With
    
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Sub cmd∞≤≈≈ ±º‰_Click()
    If IsDate(txt∞≤≈≈ ±º‰.Text) Then
        dtpDate.value = CDate(txt∞≤≈≈ ±º‰.Text)
    ElseIf IsDate(txtø™ º ±º‰.Text) Then
        dtpDate.value = CDate(txtø™ º ±º‰.Text)
    Else
        dtpDate.value = zlDatabase.Currentdate
    End If
    dtpDate.Tag = "∞≤≈≈ ±º‰"
    dtpDate.Left = txt∞≤≈≈ ±º‰.Left + fraAdvice.Left
    dtpDate.Top = txt∞≤≈≈ ±º‰.Top + fraAdvice.Top - dtpDate.Height
    dtpDate.Visible = True
    dtpDate.SetFocus
End Sub

Private Sub cmd ’≤ÿ”√“©¿Ì”…_Click()
    Call ReasonSave(0)
End Sub

Private Sub cmdComExcReason_Click()
    Call ReasonSave(1)
End Sub

Private Sub cmd“Ω…˙÷ˆÕ–_Click()
    If ReasonSelect("", 2) Then Exit Sub
    cbo“Ω…˙÷ˆÕ–.Tag = "1"
    Call AdviceChange
End Sub

Private Sub Form_QueryUnload(Cancel As Integer, UnloadMode As Integer)
    If mblnNoSave Then
        If MsgBox("µ±«∞“Ω÷ˆƒ⁄»›±‡º≠∫Û…–Œ¥±£¥Ê£¨»∑ µ“™ÕÀ≥ˆ¬£ø", vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbNo Then
            Cancel = True
            Exit Sub
        End If
    End If
    If Not mfrmShortCut Is Nothing Then mfrmShortCut.SaveShowState 'œµÕ≥◊‘∂Ø–∂‘ÿ∏√◊”¥∞ÃÂ
End Sub

Private Sub Setµ•¡øFace(ByVal blnOver As Boolean)
    If blnOver Then
        If lblµ•¡ø.BorderStyle = 0 Then
            lblµ•¡ø.BorderStyle = 1
            lblµ•¡ø.BackStyle = 1
        End If
    Else
        If lblµ•¡ø.BorderStyle = 1 Then
            lblµ•¡ø.BorderStyle = 0
            lblµ•¡ø.BackStyle = 0
        End If
    End If
End Sub

Private Sub lblµ•¡ø_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)
    Dim objPopup As CommandBar
    Dim objControl As CommandBarControl
    Dim vRect As RECT, strSQL As String
    Dim strµ•Œª As String
    Dim rsTmp As Recordset
    
    On Error GoTo errH
    
    If Not (InStr(",5,6,", vsAdvice.TextMatrix(vsAdvice.Row, COL_¿‡±)) > 0 And txtµ•¡ø.Enabled) Then Exit Sub
    
    If mrsDrugScale Is Nothing Then
        strSQL = "Select √˚≥∆,±»¿˝ From ≥£”√º¡¡ø±»¿˝ Where √˚≥∆ is Not NULL And ±»¿˝ is Not NULL Order by ±‡¬Î"
        Set mrsDrugScale = zlDatabase.OpenSQLRecord(strSQL, Me.Caption)
        
        If mrsDrugScale.EOF Then
            MsgBox "√ª”–…Ë÷√≥£”√º¡¡ø±»¿˝£¨«Îœ»µΩ◊÷µ‰π‹¿Ìπ§æﬂΩ¯––…Ë÷√°£", vbInformation, gstrSysName
            Exit Sub
        End If
    End If
    If vsAdvice.TextMatrix(vsAdvice.Row, COL_ ’∑—œ∏ƒøID) <> 0 Then
        Set rsTmp = Get ’∑—œÓƒøº«¬º(Val(vsAdvice.TextMatrix(vsAdvice.Row, COL_ ’∑—œ∏ƒøID)))
        strµ•Œª = rsTmp!º∆À„µ•Œª & ""
    End If
    
    Set objPopup = cbsMain.Add("Popup", xtpBarPopup)
    With objPopup.Controls
        mrsDrugScale.MoveFirst
        Do While Not mrsDrugScale.EOF
            Set objControl = .Add(xtpControlButton, conMenu_DrugScale * 100# + .Count + 1, mrsDrugScale!√˚≥∆ & "[" & strµ•Œª & "]")
            objControl.Parameter = mrsDrugScale!±»¿˝
            mrsDrugScale.MoveNext
        Loop
    End With
    GetWindowRect fraAdvice.hWnd, vRect
    objPopup.ShowPopup , vRect.Left * Screen.TwipsPerPixelX + lblµ•¡ø.Left + lblµ•¡ø.Width, vRect.Top * Screen.TwipsPerPixelY + lblµ•¡ø.Top
    
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Sub lblµŒÀŸ_Click()
    Call Load ‰“∫µŒÀŸ(cboµŒÀŸ, lblµŒÀŸµ•Œª, True)
    cboµŒÀŸ.Tag = "1"
    Call AdviceChange
End Sub

Private Sub mfrmPrice_PanelHide()
    Call stbThis_PanelClick(stbThis.Panels("Price"))
End Sub

Private Sub mfrmSend_EditDiagnose(ParentForm As Object, ByVal π“∫≈µ• As String, Succeed As Boolean)
    RaiseEvent EditDiagnose(ParentForm, π“∫≈µ•, Succeed)
End Sub

Private Sub mfrmShortCut_ItemClick(ByVal ¿‡–Õ As Integer, ByVal ∑÷¿‡ID As Long)
    If cmdSel.Enabled And cmdSel.Visible Then
        Call ClinicSelecter(¿‡–Õ, ∑÷¿‡ID)
    End If
End Sub

Private Sub picHelp_Click()
    Dim strTip As String
    
    On Error Resume Next
    If vsAdvice.TextMatrix(vsAdvice.Row, COL_º‰∏Ùµ•Œª) = "÷‹" Then
        strTip = COL_∞¥÷‹÷¥––
    ElseIf vsAdvice.TextMatrix(vsAdvice.Row, COL_º‰∏Ùµ•Œª) = "ÃÏ" Then
        strTip = COL_∞¥ÃÏ÷¥––
    ElseIf vsAdvice.TextMatrix(vsAdvice.Row, COL_º‰∏Ùµ•Œª) = "–° ±" Then
        strTip = COL_∞¥ ±÷¥––
    End If
    MsgBox strTip, vbInformation, Me.Caption
    cbo÷¥–– ±º‰.SetFocus
    mblnIsInHelp = False
End Sub

Private Sub picHelp_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
    Dim strTip As String
    
    On Error Resume Next
    If vsAdvice.TextMatrix(vsAdvice.Row, COL_º‰∏Ùµ•Œª) = "÷‹" Then
        strTip = COL_∞¥÷‹÷¥––
    ElseIf vsAdvice.TextMatrix(vsAdvice.Row, COL_º‰∏Ùµ•Œª) = "ÃÏ" Then
        strTip = COL_∞¥ÃÏ÷¥––
    ElseIf vsAdvice.TextMatrix(vsAdvice.Row, COL_º‰∏Ùµ•Œª) = "–° ±" Then
        strTip = COL_∞¥ ±÷¥––
    End If
    
    zlCommFun.ShowTipInfo picHelp.hWnd, strTip, True
    
    If X >= 0 And X <= picHelp.Width And Y >= 0 And Y <= picHelp.Height Then
        mblnIsInHelp = True
        SetCapture picHelp.hWnd
    Else
        mblnIsInHelp = False
        ReleaseCapture
    End If
End Sub

Private Sub stbThis_PanelClick(ByVal Panel As MSComctlLib.Panel)
    If Panel.Key = "Price" Then
        If Panel.Bevel <> sbrNoBevel Then
            Panel.Bevel = IIF(Panel.Bevel = sbrInset, sbrRaised, sbrInset)
            Panel.Tag = IIF(Panel.Bevel = sbrInset, "1", "")
            Call ShowPrice(vsAdvice.Row)
        End If
    ElseIf Panel.Bevel = sbrRaised And (Panel.Key = "PY" Or Panel.Key = "WB") Then
        '«–ªª≤¢±£¥ÊºÚ¬Î∆•≈‰∑Ω Ω
        Panel.Bevel = IIF(Panel.Bevel = sbrInset, sbrRaised, sbrInset)
        If Panel.Key = "PY" Then
            stbThis.Panels("WB").Bevel = IIF(Panel.Bevel = sbrInset, sbrRaised, sbrInset)
        Else
            stbThis.Panels("PY").Bevel = IIF(Panel.Bevel = sbrInset, sbrRaised, sbrInset)
        End If
        Call zlDatabase.SetPara("ºÚ¬Î∑Ω Ω", IIF(stbThis.Panels("PY").Bevel = sbrInset And stbThis.Panels("WB").Bevel = sbrInset, 2, IIF(stbThis.Panels("WB").Bevel = sbrInset, 1, 0)))
        mintºÚ¬Î = IIF(stbThis.Panels("PY").Bevel = sbrInset And stbThis.Panels("WB").Bevel = sbrInset, 2, IIF(stbThis.Panels("WB").Bevel = sbrInset, 1, 0))
    ElseIf Panel.Key = "KB" Then
        On Error Resume Next
        If mobjKeyBoard Is Nothing Then Set mobjKeyBoard = CreateObject("zlScreenKeyboard.clsKeyBoard")
        Call mobjKeyBoard.StartUp
        Call mobjKeyBoard.SetPos
        err.Clear: On Error GoTo 0
    End If
End Sub

Private Sub txt≥¨¡øÀµ√˜_GotFocus()
    Call zlControl.TxtSelAll(txt≥¨¡øÀµ√˜)
End Sub

Private Sub txt≥¨¡øÀµ√˜_Change()
    txt≥¨¡øÀµ√˜.Tag = "1"
End Sub

Private Sub txt≥¨¡øÀµ√˜_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        KeyAscii = 0
        If txt≥¨¡øÀµ√˜.Text <> "" Then
            If ReasonSelect(txt≥¨¡øÀµ√˜.Text, 3) Then Exit Sub
        End If
        If SeekNextControl Then Call txt≥¨¡øÀµ√˜_Validate(False)
    End If
End Sub

Private Sub txt≥¨¡øÀµ√˜_Validate(Cancel As Boolean)
    Call AdviceChange
End Sub

Private Sub txtµ•¡ø_KeyDown(KeyCode As Integer, Shift As Integer)
    If Shift = vbCtrlMask And KeyCode = 192 Then '~
        Call lblµ•¡ø_MouseDown(1, 0, 0, 0)
    End If
End Sub

Private Sub txtµ•¡ø_LostFocus()
    mblnReturn = False
End Sub

Private Sub txt∆µ¬ _GotFocus()
    Call zlControl.TxtSelAll(txt∆µ¬ )
End Sub

Private Sub txt∆µ¬ _KeyPress(KeyAscii As Integer)
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String, blnCancel As Boolean
    Dim int∑∂Œß As Integer, vRect As RECT
    Dim lng’Ô¡∆œÓƒøID As Long, lngFind As Long
    
    With vsAdvice
        If KeyAscii = 13 Then
            KeyAscii = 0
            If cmd∆µ¬ .Tag <> "" And txt∆µ¬ .Text = .TextMatrix(.Row, COL_∆µ¬ ) And txt∆µ¬ .Text <> "" Then
                Call SeekNextControl
            ElseIf txt∆µ¬ .Text = "" Then
                If cmd∆µ¬ .Enabled And cmd∆µ¬ .Visible Then cmd∆µ¬ _Click
            Else
                int∑∂Œß = Get∆µ¬ ∑∂Œß(.Row)
                
                'ø…—°‘Ò∆µ¬ µƒ≥£”√∆µ¬ 
                lng’Ô¡∆œÓƒøID = Val(.TextMatrix(.Row, COL_’Ô¡∆œÓƒøID))
                If RowInºÏ—È––(.Row) Then
                    lngFind = .FindRow(CStr(.RowData(.Row)), .FixedRows, COL_œ‡πÿID)
                    If lngFind <> -1 Then
                        lng’Ô¡∆œÓƒøID = Val(.TextMatrix(lngFind, COL_’Ô¡∆œÓƒøID))
                    End If
                ElseIf InStr(",5,6,", .TextMatrix(.Row, COL_¿‡±)) > 0 Then
                    lngFind = .FindRow(CLng(.TextMatrix(.Row, COL_œ‡πÿID)), .Row + 1)
                    If lngFind <> -1 Then
                        lng’Ô¡∆œÓƒøID = Val(.TextMatrix(lngFind, COL_’Ô¡∆œÓƒøID))
                    End If
                End If
                strSQL = ""
                If int∑∂Œß = 1 Then
                    strSQL = " And (Exists(Select 1 From ’Ô¡∆”√∑®”√¡ø Where œÓƒøID=[4] And ”√∑®ID is NULL And ∆µ¥Œ=A.±‡¬Î And A.  ”√∑∂Œß=1)" & _
                        " Or (Select Count(*) From ’Ô¡∆”√∑®”√¡ø Where œÓƒøID=[4] And ”√∑®ID is NULL And ∆µ¥Œ Is Not NULL)<=1)"
                End If
                strSQL = "Select Rownum as ID,A.±‡¬Î,A.√˚≥∆,A.ºÚ¬Î," & _
                    " A.”¢Œƒ√˚≥∆,A.∆µ¬ ¥Œ ˝,A.∆µ¬ º‰∏Ù,A.º‰∏Ùµ•Œª" & _
                    " From ’Ô¡∆∆µ¬ œÓƒø A Where A.  ”√∑∂Œß=[3]" & strSQL & _
                    " And (A.±‡¬Î Like [1] Or Upper(A.√˚≥∆) Like [2]" & _
                    " Or Upper(A.ºÚ¬Î) Like [2] Or Upper(A.”¢Œƒ√˚≥∆) Like [2])" & _
                    " Order by A.±‡¬Î"
                vRect = GetControlRect(txt∆µ¬ .hWnd)
                Set rsTmp = zlDatabase.ShowSQLSelect(Me, strSQL, 0, "’Ô¡∆∆µ¬ ", False, "", "", False, False, True, _
                    vRect.Left, vRect.Top, txt∆µ¬ .Height, blnCancel, False, True, UCase(txt∆µ¬ .Text) & "%", mstrLike & UCase(txt∆µ¬ .Text) & "%", int∑∂Œß, lng’Ô¡∆œÓƒøID)
                If rsTmp Is Nothing Then
                    If Not blnCancel Then
                        MsgBox "Œ¥’“µΩ∆•≈‰µƒ’Ô¡∆∆µ¬ œÓƒø°£", vbInformation, gstrSysName
                    End If
                    txt∆µ¬ .Text = .TextMatrix(.Row, COL_∆µ¬ )
                    Call zlControl.TxtSelAll(txt∆µ¬ )
                    txt∆µ¬ .SetFocus: Exit Sub
                End If
                Call Set∆µ¬ Input(rsTmp, int∑∂Œß)
                Call SeekNextControl
            End If
        End If
    End With
End Sub

Private Sub txt∞≤≈≈ ±º‰_Change()
    txt∞≤≈≈ ±º‰.Tag = "1"
End Sub

Private Sub txt∞≤≈≈ ±º‰_GotFocus()
    If txt∞≤≈≈ ±º‰.Text = "" Then txt∞≤≈≈ ±º‰.Text = txtø™ º ±º‰.Text
    zlControl.TxtSelAll txt∞≤≈≈ ±º‰
End Sub

Private Sub txt∞≤≈≈ ±º‰_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        KeyAscii = 0
        If txt∞≤≈≈ ±º‰.Text <> "" Then
            txt∞≤≈≈ ±º‰.Text = GetFullDate(txt∞≤≈≈ ±º‰.Text)
            If SeekNextControl Then Call txt∞≤≈≈ ±º‰_Validate(False)
        End If
    Else
        If InStr("0123456789 /-:" & Chr(8), Chr(KeyAscii)) = 0 Then KeyAscii = 0
    End If
End Sub

Private Sub txt∞≤≈≈ ±º‰_Validate(Cancel As Boolean)
    If txt∞≤≈≈ ±º‰.Locked Then Exit Sub
        
    If Not IsDate(txt∞≤≈≈ ±º‰.Text) Then
        If txt∞≤≈≈ ±º‰.Text <> "" Then
            Cancel = True
            txt∞≤≈≈ ±º‰_GotFocus
            Exit Sub
        ElseIf vsAdvice.RowData(vsAdvice.Row) <> 0 Then
            If IsDate(vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_ø™ º ±º‰)) Then
                'ª÷∏¥»ÀŒ™µƒ«Â≥˝»± °Œ™ø™ º ±º‰
                txt∞≤≈≈ ±º‰.Text = vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_ø™ º ±º‰)
            End If
        End If
    Else
        'ºÏ≤È ±º‰∫œ∑®–‘
        If Not Check∞≤≈≈ ±º‰(txt∞≤≈≈ ±º‰.Text, vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_ø™ º ±º‰), vsAdvice.TextMatrix(vsAdvice.Row, COL_¿‡±)) Then
            Cancel = True
            txt∞≤≈≈ ±º‰_GotFocus
            Exit Sub
        End If
    End If
    
    '∏¸–¬ ˝æ›
    Call AdviceChange
End Sub

Private Sub txtÃÏ ˝_Change()
    With vsAdvice
        If .RowData(.Row) <> 0 Then
            If Val(.TextMatrix(.Row, COL_ÃÏ ˝)) <> Val(txtÃÏ ˝.Text) Then
                txtÃÏ ˝.Tag = "1"
            End If
        Else
            txtÃÏ ˝.Tag = "1"
        End If
    End With
End Sub

Private Sub txtÃÏ ˝_GotFocus()
    Call zlControl.TxtSelAll(txtÃÏ ˝)
End Sub

Private Sub txtÃÏ ˝_KeyPress(KeyAscii As Integer)
    Dim blnCancel As Boolean
    
    If KeyAscii = 13 Then
        KeyAscii = 0
        If Val(txtÃÏ ˝.Text) > 0 Then
            Call txtÃÏ ˝_Validate(blnCancel)
            If Not blnCancel Then mblnReturn = True: Call SeekNextControl
        Else
            If Val(txtÃÏ ˝.Text) = 0 Then txtÃÏ ˝.Text = ""
        End If
    Else
        If InStr("0123456789" & Chr(8), Chr(KeyAscii)) = 0 Then KeyAscii = 0
    End If
End Sub

Private Sub txtÃÏ ˝_LostFocus()
    mblnReturn = False
End Sub

Private Sub txtÃÏ ˝_Validate(Cancel As Boolean)
    Dim sngÃÏ ˝ As Single, i As Long
    Dim strSame As String, strMsg As String
    Dim dbl◊‹¡ø As Double
    Dim strTmpTag As String
    Dim blnº∆À„◊‹¡ø As Boolean
    
    With vsAdvice
        If Val(txtÃÏ ˝.Text) = 0 Then txtÃÏ ˝.Text = ""
        If mblnReturn Then mblnReturn = False: Exit Sub
        If Val(txtÃÏ ˝.Text) <= 0 Then
            Cancel = True: txtÃÏ ˝_GotFocus: Exit Sub
        End If
        
        'ÃÏ ˝÷¡…Ÿ–Ë“™“ª∏ˆ∆µ¬ Õ¨∆⁄µƒÃÏ ˝
        If Val(.TextMatrix(.Row, COL_∆µ¬ º‰∏Ù)) <> 0 Then
            If .TextMatrix(.Row, COL_º‰∏Ùµ•Œª) = "÷‹" Then
                sngÃÏ ˝ = 7
            ElseIf .TextMatrix(.Row, COL_º‰∏Ùµ•Œª) = "ÃÏ" Then
                sngÃÏ ˝ = Val(.TextMatrix(.Row, COL_∆µ¬ º‰∏Ù))
            ElseIf .TextMatrix(.Row, COL_º‰∏Ùµ•Œª) = "–° ±" Then
                sngÃÏ ˝ = Val(.TextMatrix(.Row, COL_∆µ¬ º‰∏Ù)) \ 24
            ElseIf .TextMatrix(.Row, COL_º‰∏Ùµ•Œª) = "∑÷÷”" Then
                sngÃÏ ˝ = Val(.TextMatrix(.Row, COL_∆µ¬ º‰∏Ù)) \ (24 * 60)
            End If
            If Val(txtÃÏ ˝.Text) < sngÃÏ ˝ Then
                If MsgBox("∞¥""" & .TextMatrix(.Row, COL_∆µ¬ ) & """÷¥–– ±£¨÷¡…Ÿ–Ë“™ " & sngÃÏ ˝ & " ÃÏµƒ”√“©£¨“™ºÃ–¯¬£ø", vbQuestion + vbYesNo + vbDefaultButton1, gstrSysName) = vbNo Then
                    Cancel = True: txtÃÏ ˝_GotFocus: Exit Sub
                End If
            End If
        End If
        
        dbl◊‹¡ø = Val(txt◊‹¡ø.Text)
        If mblnÃÏ ˝∑¥À„ Then
            '»Áπ˚◊‹¡øŒ™0ªÚ’ﬂÀµÃÏ ˝±‰¡À‘Úº∆À„œ¬◊‹¡ø
            If dbl◊‹¡ø = 0 Or Val(txtÃÏ ˝.Text) <> msngPreÃÏ ˝ Then
                blnº∆À„◊‹¡ø = True
            End If
        Else
            blnº∆À„◊‹¡ø = True
        End If
        
        If blnº∆À„◊‹¡ø Then
            txt◊‹¡ø.Text = ReGet“©∆∑◊‹¡ø(dbl◊‹¡ø, Val(txtµ•¡ø.Text), Val(txtÃÏ ˝.Text), .Row) '“˛ Ωµ˜”√Change ¬º˛

            Call txt◊‹¡ø_Validate(Cancel)
            If Cancel Then
                txt◊‹¡ø.Text = dbl◊‹¡ø
                Exit Sub
            End If
        End If
                         
        Call CheckDrugOutOfRange(.Row, Val(txtÃÏ ˝.Text))
        
        msngÃÏ ˝ = Val(txtÃÏ ˝.Text)

    End With
    msngPreÃÏ ˝ = Val(txtÃÏ ˝.Text)
    Call AdviceChange
    
    '≥…Ã◊∑Ω∞∏≈˙¡ø¥¶¿Ì
    With vsAdvice
        If CStr(.Cell(flexcpData, .Row, COL_EDIT)) <> "" Then
            strSame = CStr(.Cell(flexcpData, .Row, COL_EDIT))
            If InStr(strSame, ",") > 0 Then
                strMsg = "∏√¥Œ∏¥÷∆µƒÀ˘”–µƒ“©∆∑∂º∞¥’‚∏ˆÃÏ ˝÷¥––¬£ø"
            Else
                strMsg = "∏√≥…Ã◊∑Ω∞∏µƒÀ˘”–“©∆∑∂º∞¥’‚∏ˆÃÏ ˝÷¥––¬£ø"
            End If
            If MsgBox(strMsg, vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbYes Then
                For i = .FixedRows To .Rows - 1
                    If InStr(",5,6,", .TextMatrix(i, COL_¿‡±)) > 0 Then
                        If Not (Val(.TextMatrix(i, COL_œ‡πÿID)) = Val(.TextMatrix(.Row, COL_œ‡πÿID)) _
                            Or .RowData(i) = Val(.TextMatrix(.Row, COL_œ‡πÿID)) Or i = .Row) _
                                And CStr(.Cell(flexcpData, i, COL_EDIT)) = strSame Then
                                
                            If .TextMatrix(i, COL_∆µ¬ ) <> "" And Val(.TextMatrix(i, COL_∆µ¬ ¥Œ ˝)) <> 0 And Val(.TextMatrix(i, COL_∆µ¬ º‰∏Ù)) <> 0 _
                                And Val(.TextMatrix(i, COL_µ•¡ø)) <> 0 And Val(.TextMatrix(i, COL_º¡¡øœµ ˝)) <> 0 And Val(.TextMatrix(i, COL_√≈’Ô∞¸◊∞)) <> 0 Then
                                
                                .TextMatrix(i, COL_ÃÏ ˝) = txtÃÏ ˝.Text
                                .TextMatrix(i, COL_◊‹¡ø) = ReGet“©∆∑◊‹¡ø(Val(.TextMatrix(i, COL_◊‹¡ø)), Val(.TextMatrix(i, COL_µ•¡ø)), Val(txtÃÏ ˝.Text), i)
                                If Val(.TextMatrix(i, COL_œ‡πÿID)) = Val(.RowData(i + 1)) Then
                                    .TextMatrix(i + 1, COL_ÃÏ ˝) = txtÃÏ ˝.Text
                                End If
                            End If
                        End If
                    End If
                Next
            End If
        End If
    End With
End Sub

Private Sub txt”√∑®_KeyPress(KeyAscii As Integer)
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String, blnCancel As Boolean
    Dim int¿‡–Õ As Integer, vRect As RECT
    Dim lngBegin As Long, lngEnd As Long
    Dim strLike As String, i As Long, strWhere As String
        
    With vsAdvice
        If KeyAscii = 13 Then
            KeyAscii = 0
            If Val(cmd”√∑®.Tag) <> 0 And txt”√∑®.Text = IIF(cboµŒÀŸ.Text <> "", Replace(.TextMatrix(.Row, COL_”√∑®), cboµŒÀŸ.Text & lblµŒÀŸµ•Œª.Caption, ""), .TextMatrix(.Row, COL_”√∑®)) And txt”√∑®.Text <> "" Then
                Call SeekNextControl
            ElseIf txt”√∑®.Text = "" Then
                If cmd”√∑®.Enabled And cmd”√∑®.Visible Then cmd”√∑®_Click
            Else
                If InStr(",5,6,", .TextMatrix(.Row, COL_¿‡±)) > 0 Then
                    int¿‡–Õ = 2 '∏¯“©Õææ∂
                ElseIf RowInºÏ—È––(vsAdvice.Row) Then
                    int¿‡–Õ = 6 '≤…ºØ∑Ω∑®
                ElseIf .TextMatrix(.Row, COL_¿‡±) = "K" Then
                    If gbln—™ø‚œµÕ≥ = True Then
                        If Val(.TextMatrix(.Row, COL_ºÏ≤È∑Ω∑®)) = 0 Then
                            int¿‡–Õ = 9 '≤…ºØ ‰—™Õææ∂
                        Else
                            int¿‡–Õ = 8 ' ‰—™Õææ∂
                            strWhere = " And nvl(A.÷¥––∑÷¿‡,0)=1 "
                        End If
                    Else
                        int¿‡–Õ = 8 ' ‰—™Õææ∂
                    End If
                Else
                    int¿‡–Õ = 4 '÷–“©”√∑®
                End If
                If int¿‡–Õ = 2 Then '÷ª»°”––ß∑∂Œßµƒ∏¯“©Õææ∂(Œﬁ…Ë÷√ªÚΩˆ“ª∏ˆ ±ø…»Œ—°)
                    strSQL = " And (A.ID IN(Select ”√∑®ID From ’Ô¡∆”√∑®”√¡ø Where œÓƒøID=[4] And –‘÷ >0)" & _
                        " Or (Select Count(A.”√∑®ID) From ’Ô¡∆”√∑®”√¡ø A,’Ô¡∆œÓƒøƒø¬º B" & _
                            " Where A.”√∑®ID=B.ID And B.∑˛ŒÒ∂‘œÛ IN(1,3) And A.œÓƒøID=[4] And A.–‘÷ >0)<=1)"
                End If
                
                '”≈ªØ
                strLike = mstrLike
                If Len(txt”√∑®.Text) < 2 Then strLike = ""
                
                strSQL = "Select Distinct A.ID,A.±‡¬Î,A.√˚≥∆,A.÷¥––∑÷¿‡ as ÷¥––∑÷¿‡ID" & _
                    " From ’Ô¡∆œÓƒøƒø¬º A,’Ô¡∆œÓƒø±√˚ B" & _
                    " Where A.ID=B.’Ô¡∆œÓƒøID" & _
                    " And A.¿‡±='E' And A.≤Ÿ◊˜¿‡–Õ=[3] And A.∑˛ŒÒ∂‘œÛ IN(1,3)" & strWhere & strSQL & _
                    " And (A.≥∑µµ ±º‰=To_Date('3000-01-01','YYYY-MM-DD') Or A.≥∑µµ ±º‰ IS NULL)" & _
                    " And (A.’æµ„='" & gstrNodeNo & "' Or A.’æµ„ is Null)" & _
                    " And (A.±‡¬Î Like [1] Or B.√˚≥∆ Like [2] Or B.ºÚ¬Î Like [2])" & _
                    " And (Exists(Select 1 From ’Ô¡∆  ”√ø∆ “ Where œÓƒøID=A.ID And ø∆ “ID=[6])" & _
                            " Or Not Exists(Select 1 From ’Ô¡∆  ”√ø∆ “ Where œÓƒøID=A.ID))" & _
                    Decode(mintºÚ¬Î, 0, " And B.¬Î¿‡ IN([5],3)", 1, " And B.¬Î¿‡ IN([5],3)", "") & _
                    " Order by A.±‡¬Î"
                vRect = GetControlRect(txt”√∑®.hWnd)
                Set rsTmp = zlDatabase.ShowSQLSelect(Me, strSQL, 0, lbl”√∑®.Caption, False, "", "", False, False, True, _
                    vRect.Left, vRect.Top, txt”√∑®.Height, blnCancel, False, True, UCase(txt”√∑®.Text) & "%", _
                    strLike & UCase(txt”√∑®.Text) & "%", CStr(int¿‡–Õ), Val(.TextMatrix(.Row, COL_’Ô¡∆œÓƒøID)), mintºÚ¬Î + 1, mlng≤°»Àø∆ “id)
                If rsTmp Is Nothing Then
                    If Not blnCancel Then
                        MsgBox "Œ¥’“µΩ∆•≈‰µƒ" & lbl”√∑®.Caption & "°£", vbInformation, gstrSysName
                    End If
                    txt”√∑®.Text = IIF(cboµŒÀŸ.Text <> "", Replace(.TextMatrix(.Row, COL_”√∑®), cboµŒÀŸ.Text & lblµŒÀŸµ•Œª.Caption, ""), .TextMatrix(.Row, COL_”√∑®))
                    Call zlControl.TxtSelAll(txt”√∑®)
                    txt”√∑®.SetFocus: Exit Sub
                End If
                
                '∂‘“ª≤¢∏¯“©µƒ∆‰À¸“©∆∑µƒø…”√∏¯“©Õææ∂Ω¯––ºÏ≤È
                If int¿‡–Õ = 2 Then
                    Call Get“ª≤¢∏¯“©∑∂Œß(Val(.TextMatrix(.Row, COL_œ‡πÿID)), lngBegin, lngEnd)
                    For i = lngBegin To lngEnd
                        If i <> .Row And .RowData(i) <> 0 Then
                            If Not Check  ”√”√∑®(rsTmp!ID, Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID)), 1) Then
                                .Refresh
                                MsgBox """" & rsTmp!√˚≥∆ & """≤ª  ”√”⁄”Îµ±«∞“©∆∑“ª≤¢∏¯“©µƒ""" & .TextMatrix(i, col_“Ω÷ˆƒ⁄»›) & """°£", vbInformation, gstrSysName
                                .Refresh
                                txt”√∑®.Text = IIF(cboµŒÀŸ.Text <> "", Replace(.TextMatrix(.Row, COL_”√∑®), cboµŒÀŸ.Text & lblµŒÀŸµ•Œª.Caption, ""), .TextMatrix(.Row, COL_”√∑®))
                                Call zlControl.TxtSelAll(txt”√∑®)
                                txt”√∑®.SetFocus: Exit Sub
                            End If
                        End If
                    Next
                End If
                If Val(cmd”√∑®.Tag) <> Val(rsTmp!ID & "") Then .TextMatrix(.Row, COL_µ•º€) = ""
                Call Set”√∑®Input(rsTmp, int¿‡–Õ)
                Call SeekNextControl
            End If
        End If
    End With
End Sub

Private Sub cmd”√∑®_Click()
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String, blnCancel As Boolean
    Dim int¿‡–Õ As Integer, vRect As RECT
    Dim lngBegin As Long, lngEnd As Long, i As Long
    Dim strSeek As String
    Dim strWhere As String
    
    With vsAdvice
        If InStr(",5,6,", .TextMatrix(.Row, COL_¿‡±)) > 0 Then
            int¿‡–Õ = 2 '∏¯“©Õææ∂
            lngBegin = .FindRow(CLng(Val(.TextMatrix(.Row, COL_œ‡πÿID))), .Row + 1)
        ElseIf RowInºÏ—È––(vsAdvice.Row) Then
            int¿‡–Õ = 6 '≤…ºØ∑Ω∑®
            lngBegin = .Row
        ElseIf .TextMatrix(.Row, COL_¿‡±) = "K" Then
            If gbln—™ø‚œµÕ≥ = True Then
                If Val(.TextMatrix(.Row, COL_ºÏ≤È∑Ω∑®)) = 0 Then
                    int¿‡–Õ = 9 '≤…ºØ ‰—™Õææ∂
                Else
                    int¿‡–Õ = 8 ' ‰—™Õææ∂
                    strWhere = " And nvl(A.÷¥––∑÷¿‡,0)=1 "
                End If
            Else
                int¿‡–Õ = 8 ' ‰—™Õææ∂
            End If
            lngBegin = .FindRow(CStr(.RowData(.Row)), .Row + 1, COL_œ‡πÿID)
        Else
            int¿‡–Õ = 4 '÷–“©”√∑®
            lngBegin = .Row
        End If
        If txt”√∑®.Text <> "" And lngBegin <> -1 Then
            strSeek = GetItemField("’Ô¡∆œÓƒøƒø¬º", Val(.TextMatrix(lngBegin, COL_’Ô¡∆œÓƒøID)), "±‡¬Î")
        End If
        
        If int¿‡–Õ = 2 Then '÷ª»°”––ß∑∂Œßµƒ∏¯“©Õææ∂(Œﬁ…Ë÷√ªÚΩˆ“ª∏ˆ ±ø…»Œ—°)
            strSQL = " And (A.ID IN(Select ”√∑®ID From ’Ô¡∆”√∑®”√¡ø Where œÓƒøID=[2] And –‘÷ >0)" & _
                " Or (Select Count(A.”√∑®ID) From ’Ô¡∆”√∑®”√¡ø A,’Ô¡∆œÓƒøƒø¬º B" & _
                    " Where A.”√∑®ID=B.ID And B.∑˛ŒÒ∂‘œÛ IN(1,3) And A.œÓƒøID=[2] And A.–‘÷ >0)<=1)"
        End If
        strSQL = "Select Distinct A.ID,A.±‡¬Î,A.√˚≥∆,C.√˚≥∆ as ∑÷¿‡,A.÷¥––∑÷¿‡ as ÷¥––∑÷¿‡ID" & _
            " From ’Ô¡∆œÓƒøƒø¬º A,’Ô¡∆∑÷¿‡ƒø¬º C" & _
            " Where A.∑÷¿‡ID=C.ID(+) And A.¿‡±='E' And A.≤Ÿ◊˜¿‡–Õ=[1] And A.∑˛ŒÒ∂‘œÛ IN(1,3)" & strWhere & strSQL & _
            " And (A.≥∑µµ ±º‰=To_Date('3000-01-01','YYYY-MM-DD') Or A.≥∑µµ ±º‰ IS NULL)" & _
            " And (A.’æµ„='" & gstrNodeNo & "' Or A.’æµ„ is Null)" & _
            " And (Exists(Select 1 From ’Ô¡∆  ”√ø∆ “ Where œÓƒøID=A.ID And ø∆ “ID=[3])" & _
                            " Or Not Exists(Select 1 From ’Ô¡∆  ”√ø∆ “ Where œÓƒøID=A.ID))" & _
            " Order by A.±‡¬Î"
        vRect = GetControlRect(txt”√∑®.hWnd)
        Set rsTmp = zlDatabase.ShowSQLSelect(Me, strSQL, 0, lbl”√∑®.Caption, False, strSeek, "", False, False, True, _
            vRect.Left, vRect.Top, txt”√∑®.Height, blnCancel, False, True, CStr(int¿‡–Õ), Val(.TextMatrix(.Row, COL_’Ô¡∆œÓƒøID)), mlng≤°»Àø∆ “id)
        If rsTmp Is Nothing Then
            If Not blnCancel Then
                MsgBox "√ª”–ø…”√µƒ" & lbl”√∑®.Caption & "£¨«Îœ»µΩ’Ô¡∆œÓƒøπ‹¿Ì÷–…Ë÷√°£", vbInformation, gstrSysName
            End If
            txt”√∑®.Text = IIF(cboµŒÀŸ.Text <> "", Replace(.TextMatrix(.Row, COL_”√∑®), cboµŒÀŸ.Text & lblµŒÀŸµ•Œª.Caption, ""), .TextMatrix(.Row, COL_”√∑®))
            Call zlControl.TxtSelAll(txt”√∑®)
            txt”√∑®.SetFocus: Exit Sub
        End If
        
        '∂‘“ª≤¢∏¯“©µƒ∆‰À¸“©∆∑µƒø…”√∏¯“©Õææ∂Ω¯––ºÏ≤È
        If int¿‡–Õ = 2 Then
            Call Get“ª≤¢∏¯“©∑∂Œß(Val(.TextMatrix(.Row, COL_œ‡πÿID)), lngBegin, lngEnd)
            For i = lngBegin To lngEnd
                If i <> .Row And .RowData(i) <> 0 Then
                    If Not Check  ”√”√∑®(rsTmp!ID, Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID)), 1) Then
                        .Refresh
                        MsgBox """" & rsTmp!√˚≥∆ & """≤ª  ”√”⁄”Îµ±«∞“©∆∑“ª≤¢∏¯“©µƒ""" & .TextMatrix(i, col_“Ω÷ˆƒ⁄»›) & """°£", vbInformation, gstrSysName
                        .Refresh
                        txt”√∑®.Text = IIF(cboµŒÀŸ.Text <> "", Replace(.TextMatrix(.Row, COL_”√∑®), cboµŒÀŸ.Text & lblµŒÀŸµ•Œª.Caption, ""), .TextMatrix(.Row, COL_”√∑®))
                        Call zlControl.TxtSelAll(txt”√∑®)
                        txt”√∑®.SetFocus: Exit Sub
                    End If
                End If
            Next
        End If
        
        Call Set”√∑®Input(rsTmp, int¿‡–Õ)
        txt”√∑®.SetFocus
        Call SeekNextControl
    End With
End Sub

Private Sub txt”√∑®_GotFocus()
    Call zlControl.TxtSelAll(txt”√∑®)
End Sub

Private Sub txt”√∑®_LostFocus()
    'PASS
    If mblnPass Then
        If gobjPass.zlPassCheck(mobjPassMap) Then
            Call gobjPass.zlPassCloseDrugHint(mobjPassMap)
        End If
    End If
End Sub

Private Sub txt”√∑®_Validate(Cancel As Boolean)
    With vsAdvice
        'ª÷∏¥»ÀŒ™µƒ«Â≥˝
        If Val(cmd”√∑®.Tag) <> 0 And txt”√∑®.Text <> IIF(cboµŒÀŸ.Text <> "", Replace(.TextMatrix(.Row, COL_”√∑®), cboµŒÀŸ.Text & lblµŒÀŸµ•Œª.Caption, ""), .TextMatrix(.Row, COL_”√∑®)) Then
            txt”√∑®.Text = IIF(cboµŒÀŸ.Text <> "", Replace(.TextMatrix(.Row, COL_”√∑®), cboµŒÀŸ.Text & lblµŒÀŸµ•Œª.Caption, ""), .TextMatrix(.Row, COL_”√∑®))
        End If
    End With
End Sub

Private Sub txt∆µ¬ _Validate(Cancel As Boolean)
    With vsAdvice
        'ª÷∏¥»ÀŒ™µƒ«Â≥˝
        If cmd∆µ¬ .Tag <> "" And txt∆µ¬ .Text <> .TextMatrix(.Row, COL_∆µ¬ ) Then
            txt∆µ¬ .Text = .TextMatrix(.Row, COL_∆µ¬ )
        End If
    End With
End Sub

Private Sub cbo”§∂˘_Click()
    If Not Visible Then Exit Sub
    If cbo”§∂˘.ListIndex = -1 Then Exit Sub
    
    If cbo”§∂˘.ListIndex = Val(cbo”§∂˘.Tag) Then Exit Sub
    cbo”§∂˘.Tag = cbo”§∂˘.ListIndex
    
    Call ShowAdvice
    'PASS ”§∂˘∑¢…˙∏ƒ±‰
    If mblnPass Then
        If gobjPass.zlPassCheck(mobjPassMap) Then
            mobjPassMap.PassPati.int”§∂˘ = cbo”§∂˘.ListIndex
        End If
    End If
    vsAdvice.SetFocus
End Sub

Private Sub cbo÷¥––ø∆ “_Click()
    Dim rsTmp As ADODB.Recordset
    Dim lngRow As Long, strSQL As String
    Dim intIdx As Integer, i As Long
    Dim vRect As RECT, blnCancel As Boolean
    Dim lng≈‰÷∆÷––ƒ As Long, str“©∑øIDs As String
    Dim lngBegin As Long, lngEnd As Long, blnNode As Boolean, bln»Î‘∫ As Boolean, bln¡Ùπ€ As Boolean
        
    If cbo÷¥––ø∆ “.ListIndex = -1 Then Exit Sub
    
    If cbo÷¥––ø∆ “.ItemData(cbo÷¥––ø∆ “.ListIndex) = -1 Then
        
        blnNode = True
        If vsAdvice.TextMatrix(vsAdvice.Row, COL_¿‡±) = "Z" Then   '»Î‘∫ªÚ¡Ùπ€
            bln»Î‘∫ = vsAdvice.TextMatrix(vsAdvice.Row, COL_≤Ÿ◊˜¿‡–Õ) = "2"
            bln¡Ùπ€ = vsAdvice.TextMatrix(vsAdvice.Row, COL_≤Ÿ◊˜¿‡–Õ) = "1" 'ø…“‘Œ™√≈’ÔªÚ◊°‘∫¡Ùπ€
            blnNode = Not (bln»Î‘∫ Or bln¡Ùπ€)
        End If
    
        'À˚ø∆÷¥––£¨µØ≥ˆ—°‘Ò÷¥––ø∆ “
        strSQL = "Select Distinct A.ID,A.±‡¬Î,A.√˚≥∆,A.ºÚ¬Î" & _
            " From ≤ø√≈±Ì A,≤ø√≈–‘÷ Àµ√˜ B" & _
            " Where A.ID=B.≤ø√≈ID And B.∑˛ŒÒ∂‘œÛ IN(" & IIF(bln»Î‘∫, "2", IIF(bln¡Ùπ€, "1,2", "1")) & ",3)" & _
            IIF(blnNode, " And (A.’æµ„='" & gstrNodeNo & "' Or A.’æµ„ is Null)", "") & _
            IIF(bln»Î‘∫ Or bln¡Ùπ€, " And B.π§◊˜–‘÷ ='¡Ÿ¥≤'", "") & _
            " And (A.≥∑µµ ±º‰=To_Date('3000-01-01','YYYY-MM-DD') Or A.≥∑µµ ±º‰ is NULL)" & _
            " Order by A.±‡¬Î"
        vRect = GetControlRect(cbo÷¥––ø∆ “.hWnd)
        Set rsTmp = zlDatabase.ShowSelect(Me, strSQL, 0, lbl÷¥––ø∆ “.Caption, , , , , , True, vRect.Left, vRect.Top, cbo÷¥––ø∆ “.Height, blnCancel, , True)
        If Not rsTmp Is Nothing Then
            intIdx = SeekCboIndex(cbo÷¥––ø∆ “, rsTmp!ID)
            If intIdx <> -1 Then
                cbo÷¥––ø∆ “.ListIndex = intIdx
            Else
                cbo÷¥––ø∆ “.AddItem rsTmp!±‡¬Î & "-" & rsTmp!√˚≥∆, cbo÷¥––ø∆ “.ListCount - 1
                cbo÷¥––ø∆ “.ItemData(cbo÷¥––ø∆ “.NewIndex) = rsTmp!ID
                cbo÷¥––ø∆ “.ListIndex = cbo÷¥––ø∆ “.NewIndex
            End If
        Else
            If Not blnCancel Then
                MsgBox "√ª”–ø∆ “ ˝æ›£¨«Îœ»µΩ≤ø√≈π‹¿Ì÷–…Ë÷√°£", vbInformation, gstrSysName
            End If
            'ª÷∏¥≥…œ÷”–µƒø∆ “(≤ª“˝∑¢Click)
            intIdx = SeekCboIndex(cbo÷¥––ø∆ “, Val(vsAdvice.TextMatrix(vsAdvice.Row, COL_÷¥––ø∆ “ID)))
            Call zlControl.CboSetIndex(cbo÷¥––ø∆ “.hWnd, intIdx)
        End If
    Else
        lngRow = vsAdvice.Row
        
        'ºÏ≤È“ª≤¢∏¯“©µƒ≈‰÷∆÷––ƒ
        With vsAdvice
            If InStr(",5,6,", .TextMatrix(lngRow, COL_¿‡±)) > 0 And RowIn“ª≤¢∏¯“©(lngRow) Then
                Call Get“ª≤¢∏¯“©∑∂Œß(Val(.TextMatrix(lngRow, COL_œ‡πÿID)), lngBegin, lngEnd)
                
                'µ±«∞––”…∆’Õ®“©∑øªÚ∆‰À˚≈‰÷∆÷––ƒ∏ƒŒ™≈‰÷∆÷––ƒ
                If Have≤ø√≈–‘÷ (cbo÷¥––ø∆ “.ItemData(cbo÷¥––ø∆ “.ListIndex), "≈‰÷∆÷––ƒ") Then
                    lng≈‰÷∆÷––ƒ = cbo÷¥––ø∆ “.ItemData(cbo÷¥––ø∆ “.ListIndex)
                End If
                'µ±«∞––”…≈‰÷√÷––ƒªÚ∏ƒŒ™∆’Õ®“©∑ø
                If lng≈‰÷∆÷––ƒ = 0 Then
                    For i = lngBegin To lngEnd
                        If i <> lngRow And Val(.TextMatrix(i, COL_œ‡πÿID)) = Val(.TextMatrix(lngRow, COL_œ‡πÿID)) Then
                            '◊‘±∏“©≤ªπ‹À¸
                            If Not (Val(.TextMatrix(i, COL_÷¥––ø∆ “ID)) = 0 And Val(.TextMatrix(i, COL_÷¥–––‘÷ )) = 5) Then
                                If Have≤ø√≈–‘÷ (Val(.TextMatrix(i, COL_÷¥––ø∆ “ID)), "≈‰÷∆÷––ƒ") Then
                                    lng≈‰÷∆÷––ƒ = Val(.TextMatrix(i, COL_÷¥––ø∆ “ID)): Exit For
                                End If
                            End If
                        End If
                    Next
                End If
                '’‚¡Ω÷÷«ÈøˆÀ˘”–“©∆∑∂º÷¥––ø∆ “œ‡Õ¨£¨ºÏ≤È¥Ê¥¢…Ë∂®
                If lng≈‰÷∆÷––ƒ <> 0 Then
                    For i = lngBegin To lngEnd
                        If i <> lngRow And Val(.TextMatrix(i, COL_œ‡πÿID)) = Val(.TextMatrix(lngRow, COL_œ‡πÿID)) Then
                            '◊‘±∏“©≤ªπ‹À¸
                            If Not (Val(.TextMatrix(i, COL_÷¥––ø∆ “ID)) = 0 And Val(.TextMatrix(i, COL_÷¥–––‘÷ )) = 5) Then
                                str“©∑øIDs = Getø…”√“©∑øIDs(.TextMatrix(i, COL_¿‡±), Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID)), Val(.TextMatrix(i, COL_ ’∑—œ∏ƒøID)), mlng≤°»Àø∆ “id, 1)
                                If InStr("," & str“©∑øIDs & ",", "," & cbo÷¥––ø∆ “.ItemData(cbo÷¥––ø∆ “.ListIndex) & ",") = 0 Then
                                    MsgBox "“ª≤¢∏¯“©µƒ“©∆∑÷–£¨""" & .TextMatrix(i, col_“Ω÷ˆƒ⁄»›) & """‘⁄""" & NeedName(cbo÷¥––ø∆ “.Text) & """÷–√ª”–¥Ê¥¢°£", vbInformation, gstrSysName
                                    'ª÷∏¥≥…œ÷”–µƒø∆ “(≤ª“˝∑¢Click)
                                    intIdx = SeekCboIndex(cbo÷¥––ø∆ “, Val(vsAdvice.TextMatrix(vsAdvice.Row, COL_÷¥––ø∆ “ID)))
                                    Call zlControl.CboSetIndex(cbo÷¥––ø∆ “.hWnd, intIdx)
                                    Exit Sub
                                End If
                            End If
                        End If
                    Next
                End If
            End If
        End With
        
        cbo÷¥––ø∆ “.Tag = "1"
        
        '∏¸–¬∏¸∏ƒ¡Àµƒ÷¥––ø∆ ““Ω÷ˆƒ⁄»›
        Call AdviceChange
        
        '÷ÿ–¬ªÒ»°ø‚¥Ê≤¢œ‘ æ£∫“‘√≈’Ôµ•Œª£¨÷–“©≈‰∑Ω≤ªœ‘ æ
        With vsAdvice
            If (.TextMatrix(lngRow, COL_¿‡±) = "4" And Val(.TextMatrix(lngRow, COL_∏˙◊Ÿ‘⁄”√)) = 1 _
                Or InStr(",5,6,", .TextMatrix(lngRow, COL_¿‡±)) > 0) And Val(.TextMatrix(lngRow, COL_ ’∑—œ∏ƒøID)) <> 0 Then
                Call GetDrugStock(lngRow)
                If InStr(GetInsidePrivs(p√≈’Ô“Ω÷ˆœ¬¥Ô), "œ‘ æ“©∆∑ø‚¥Ê") = 0 Then
                    stbThis.Panels(3).Text = IIF(Val(.TextMatrix(lngRow, COL_ø‚¥Ê)) > 0, "”–ø‚¥Ê", "Œﬁø‚¥Ê")
                Else
                    stbThis.Panels(3).Text = "ø‚¥Ê: " & FormatEx(Val(.TextMatrix(lngRow, COL_ø‚¥Ê)), 5) & .TextMatrix(lngRow, COL_√≈’Ôµ•Œª)
                End If
            ElseIf RowIn≈‰∑Ω––(lngRow) Then
                Call GetDrugStock(lngRow)
            End If
        End With
    End If
End Sub

Private Sub cbo÷¥––ø∆ “_GotFocus()
    Call zlControl.TxtSelAll(cbo÷¥––ø∆ “)
End Sub

Private Sub cbo÷¥––ø∆ “_KeyPress(KeyAscii As Integer)
    Dim blnCancel As Boolean
    
    If KeyAscii = 13 Then
        KeyAscii = 0
        If cbo÷¥––ø∆ “.ListIndex = -1 Then
            Call cbo÷¥––ø∆ “_Validate(blnCancel)
            cbo÷¥––ø∆ “.SetFocus
        Else
            If SeekNextControl Then Call cbo÷¥––ø∆ “_Validate(False)
        End If
    End If
End Sub

Private Sub cbo÷¥––ø∆ “_Validate(Cancel As Boolean)
'π¶ƒ‹£∫∏˘æ› ‰»Îµƒƒ⁄»›,◊‘∂Ø∆•≈‰÷¥––ø∆ “
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String, intIdx As Long, i As Long
    Dim blnLimit As Boolean, strInput As String, strIDs As String
    Dim vRect As RECT, blnCancel As Boolean
    Dim blnNode As Boolean, bln√≈’Ô¡Ùπ€ As Boolean, bln»Î‘∫ As Boolean
    
    If cbo÷¥––ø∆ “.ListIndex <> -1 Then Exit Sub '“——°÷–
    If cbo÷¥––ø∆ “.Text = "" Then 'Œﬁ ‰»Î
        If cbo÷¥––ø∆ “.ListCount > 0 Then Cancel = True
        Exit Sub
    End If
    
    On Error GoTo errH
    
    ' «∑Òø…“‘»Œ“‚ªÚ—°‘Òø∆ “
    blnLimit = True
    If cbo÷¥––ø∆ “.ListCount > 0 Then
        If cbo÷¥––ø∆ “.ItemData(cbo÷¥––ø∆ “.ListCount - 1) = -1 Then
            blnLimit = False
        End If
    End If
    blnNode = True
    If vsAdvice.TextMatrix(vsAdvice.Row, COL_¿‡±) = "Z" Then
        If vsAdvice.TextMatrix(vsAdvice.Row, COL_≤Ÿ◊˜¿‡–Õ) = "1" Then
            blnNode = False
            bln√≈’Ô¡Ùπ€ = True
        ElseIf vsAdvice.TextMatrix(vsAdvice.Row, COL_≤Ÿ◊˜¿‡–Õ) = "2" Then
            blnNode = False
            bln»Î‘∫ = True
        End If
    End If
    
    strInput = UCase(NeedName(cbo÷¥––ø∆ “.Text))
    strSQL = "Select Distinct A.ID,A.±‡¬Î,A.√˚≥∆,A.ºÚ¬Î" & _
        " From ≤ø√≈±Ì A,≤ø√≈–‘÷ Àµ√˜ B" & _
        " Where A.ID=B.≤ø√≈ID And B.∑˛ŒÒ∂‘œÛ IN(" & IIF(bln√≈’Ô¡Ùπ€, "1,2", IIF(bln»Î‘∫, "2", "1")) & ",3)" & _
        IIF(blnNode, " And (A.’æµ„='" & gstrNodeNo & "' Or A.’æµ„ is Null)", "") & _
        " And (A.≥∑µµ ±º‰=To_Date('3000-01-01','YYYY-MM-DD') Or A.≥∑µµ ±º‰ is NULL)" & _
        " And (A.±‡¬Î Like [1] Or A.√˚≥∆ Like [2] Or Upper(A.ºÚ¬Î) Like [2])" & _
        " Order by A.±‡¬Î"
    If blnLimit Then
        'Set rsTmp = New ADODB.Recordset
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, strInput & "%", mstrLike & strInput & "%")
        For i = 1 To rsTmp.RecordCount
            intIdx = SeekCboIndex(cbo÷¥––ø∆ “, rsTmp!ID)
            If intIdx <> -1 Then strIDs = strIDs & "," & rsTmp!ID
            rsTmp.MoveNext
        Next
        
        If strIDs <> "" Then
            strIDs = Mid(strIDs, 2)
            If InStr(strIDs, ",") = 0 Then
                intIdx = SeekCboIndex(cbo÷¥––ø∆ “, CLng(strIDs))
                If intIdx <> -1 Then cbo÷¥––ø∆ “.ListIndex = intIdx
            Else
                strSQL = "Select /*+ rule*/ A.ID,A.±‡¬Î,A.√˚≥∆,A.ºÚ¬Î From ≤ø√≈±Ì A,Table(f_num2list([1])) B Where A.ID = B.Column_Value"
        
                vRect = GetControlRect(cbo÷¥––ø∆ “.hWnd)
                Set rsTmp = zlDatabase.ShowSQLSelect(Me, strSQL, 0, lbl÷¥––ø∆ “.Caption, False, "", "", False, False, True, _
                    vRect.Left, vRect.Top, txt”√∑®.Height, blnCancel, False, True, strIDs)
                If Not rsTmp Is Nothing Then
                    intIdx = SeekCboIndex(cbo÷¥––ø∆ “, rsTmp!ID)
                    If intIdx <> -1 Then cbo÷¥––ø∆ “.ListIndex = intIdx
                End If
            End If
        End If
        If cbo÷¥––ø∆ “.ListIndex = -1 Then
            MsgBox "Œ¥µΩ∂‘”¶µƒø∆ “°£", vbInformation, gstrSysName
            Cancel = True: Exit Sub
        End If
    Else
        vRect = GetControlRect(cbo÷¥––ø∆ “.hWnd)
        Set rsTmp = zlDatabase.ShowSQLSelect(Me, strSQL, 0, lbl÷¥––ø∆ “.Caption, False, "", "", False, False, True, _
            vRect.Left, vRect.Top, txt”√∑®.Height, blnCancel, False, True, strInput & "%", mstrLike & strInput & "%")
        If Not rsTmp Is Nothing Then
            intIdx = SeekCboIndex(cbo÷¥––ø∆ “, rsTmp!ID)
            If intIdx <> -1 Then
                cbo÷¥––ø∆ “.ListIndex = intIdx
            Else
                cbo÷¥––ø∆ “.AddItem rsTmp!±‡¬Î & "-" & rsTmp!√˚≥∆, cbo÷¥––ø∆ “.ListCount - 1
                cbo÷¥––ø∆ “.ItemData(cbo÷¥––ø∆ “.NewIndex) = rsTmp!ID
                cbo÷¥––ø∆ “.ListIndex = cbo÷¥––ø∆ “.NewIndex
            End If
        Else
            If Not blnCancel Then
                MsgBox "Œ¥’“µΩ∂‘”¶µƒø∆ “°£", vbInformation, gstrSysName
            End If
            Cancel = True: Exit Sub
        End If
    End If
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Sub cbo÷¥–– ±º‰_Change()
    cbo÷¥–– ±º‰.Tag = "1"
End Sub

Private Sub cbo÷¥–– ±º‰_LostFocus()
    If Not mblnIsInHelp Then picHelp.Visible = False
    mblnIsInHelp = False
End Sub

Private Sub cbo÷¥–– ±º‰_Click()
    'cbo÷¥–– ±º‰_Change
    '∏¸–¬ ˝æ›
    cbo÷¥–– ±º‰.Tag = "1"
    Call AdviceChange
End Sub

Private Sub cbo÷¥–– ±º‰_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        KeyAscii = 0
        If SeekNextControl Then Call cbo÷¥–– ±º‰_Validate(False)
    Else
        If InStr("0123456789:-/" & Chr(8) & Chr(3) & Chr(22), Chr(KeyAscii)) = 0 Then
            KeyAscii = 0
        End If
    End If
End Sub

Private Sub cbo÷¥–– ±º‰_Validate(Cancel As Boolean)
    Dim blnValid As Boolean, lngRow As Long, strTmp As String
    
    lngRow = vsAdvice.Row
        
    With vsAdvice
        If cbo÷¥–– ±º‰.Text <> "" Then
            'ºÏ≤È≥§∂»
            If Len(cbo÷¥–– ±º‰.Text) > 50 Then
                MsgBox " ‰»Îƒ⁄»›≤ªƒ‹≥¨π˝ 50 ∏ˆ◊÷∑˚°£", vbInformation, gstrSysName
                Call cbo÷¥–– ±º‰_GotFocus
                Cancel = True: Exit Sub
            End If
            'ºÏ≤È∫œ∑®–‘
            If .RowData(lngRow) <> 0 Then
                blnValid = ExeTimeValid(cbo÷¥–– ±º‰.Text, Val(.TextMatrix(lngRow, COL_∆µ¬ ¥Œ ˝)), Val(.TextMatrix(lngRow, COL_∆µ¬ º‰∏Ù)), .TextMatrix(lngRow, COL_º‰∏Ùµ•Œª))
                If Not blnValid Then
                    If .TextMatrix(lngRow, COL_º‰∏Ùµ•Œª) = "÷‹" Then
                        strTmp = COL_∞¥÷‹÷¥––
                    ElseIf .TextMatrix(lngRow, COL_º‰∏Ùµ•Œª) = "ÃÏ" Then
                        strTmp = COL_∞¥ÃÏ÷¥––
                    ElseIf .TextMatrix(lngRow, COL_º‰∏Ùµ•Œª) = "–° ±" Then
                        strTmp = COL_∞¥ ±÷¥––
                    End If
                    MsgBox " ‰»Îµƒ÷¥–– ±º‰∑Ω∞∏∏Ò Ω≤ª’˝»∑£¨«ÎºÏ≤È°£" & vbCrLf & vbCrLf & "¿˝£∫" & vbCrLf & strTmp, vbInformation, gstrSysName
                    Call cbo÷¥–– ±º‰_GotFocus
                    Cancel = True: Exit Sub
                End If
            End If
        End If
    End With
    
    '∏¸–¬ ˝æ›
    Call AdviceChange
End Sub

Private Sub cbo÷¥–––‘÷ _Click()
    cbo÷¥–––‘÷ .Tag = "1"
    '∏¸–¬ ˝æ›
    Call AdviceChange
End Sub

Private Sub cbo÷¥–––‘÷ _KeyPress(KeyAscii As Integer)
    Dim lngIdx As Long
    If KeyAscii = 13 Then
        KeyAscii = 0
        If cbo÷¥–––‘÷ .ListIndex <> -1 Then
            Call SeekNextControl
        End If
    ElseIf KeyAscii >= 32 Then
        lngIdx = zlControl.CboMatchIndex(cbo÷¥–––‘÷ .hWnd, KeyAscii)
        If lngIdx = -1 And cbo÷¥–––‘÷ .ListCount > 0 Then lngIdx = 0
        cbo÷¥–––‘÷ .ListIndex = lngIdx
    End If
End Sub

Private Sub chkΩÙº±_Click()
    If Not mblnDoCheck Then Exit Sub
    
    chkΩÙº±.Tag = "1"
    '∏¸–¬ ˝æ›
    Call AdviceChange
    
    If txt”√“©¿Ì”….Enabled And Trim(txt”√“©¿Ì”….Text) = "" Then
        txt”√“©¿Ì”….SetFocus
    End If
End Sub

Private Sub chkZeroBilling_click()
    If Not mblnDoCheck Then Exit Sub
    
    chkZeroBilling.Tag = "1"
    '∏¸–¬ ˝æ›
    Call AdviceChange
End Sub

Private Sub chkΩÙº±_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        KeyAscii = 0
        Call SeekNextControl
    End If
End Sub

Private Sub cmdExt_Click()
'π¶ƒ‹£∫–ﬁ∏ƒœ÷”–“Ω÷ˆµƒ¿©≥‰ƒ⁄»›
    Dim rsCurr As New ADODB.Recordset
    Dim strExtData As String, strAppend As String
    Dim lngRow As Long, lngFirstRow As Long
    Dim lng’Ô¡∆œÓƒøID As Long, lng”√∑®ID As Long
    Dim strMsg As String, vMsg As VbMsgBoxResult
    Dim strTmp As String, lngDiag As Long
    Dim lng≈‰∑ΩID As Long
    Dim t_Pati As TYPE_PatiInfoEx
    Dim lngœÓƒøid As Long, intType As Integer
    Dim blnOK As Boolean
    Dim str ÷ ı≤øŒª As String
    Dim strIDs1 As String, strIDs2 As String, str“Ω÷ˆƒ⁄»› As String
    Dim lngAppType As Long '…Í«Îµ•”¶”√
    Dim objAppPages()  As clsApplicationData
    Dim rsCard As ADODB.Recordset
    Dim lngNo As Long
    Dim lngTmp As Long
    Dim str’™“™ As String '“Ω±£’™“™ GetItemInfo
        Dim strSQL As String, rsTmp As Recordset
    
    lngRow = vsAdvice.Row
    '∂¡»°…Í«Î∏ΩœÓƒ⁄»›£∫≤ªπ‹–¬¬º“Ω÷ˆ£¨‘⁄¬º»Î°¢µ˜≥…Ã◊°¢∏¥÷∆ ±“—∂¡»°
    If vsAdvice.TextMatrix(lngRow, COL_∏ΩœÓ) = "" And Val(vsAdvice.TextMatrix(lngRow, COL_EDIT)) <> 1 Then
        If Not RowIn≈‰∑Ω––(lngRow) Then
            vsAdvice.TextMatrix(lngRow, COL_∏ΩœÓ) = Get≤°»À“Ω÷ˆ∏Ωº˛(vsAdvice.RowData(vsAdvice.Row))
        End If
    End If
    strAppend = vsAdvice.TextMatrix(lngRow, COL_∏ΩœÓ)
    
    lngNo = Val(vsAdvice.TextMatrix(lngRow, COL_…Í«Î–Ú∫≈) & "")
    intType = -1
    lngAppType = -1
        If lngNo <> 0 Then
        strSQL = "Select Œƒº˛ID From “Ω÷ˆ…Í«Îµ•Œƒº˛ Where “Ω÷ˆID=[1] And RowNum<2"
        On Error GoTo errH
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, IIF(Val(vsAdvice.TextMatrix(lngRow, COL_œ‡πÿID)) = 0, Val(vsAdvice.RowData(lngRow)), Val(vsAdvice.TextMatrix(lngRow, COL_œ‡πÿID))))
        If rsTmp.RecordCount > 0 Then Call FuncApplyCustom(1, Val(rsTmp!Œƒº˛ID), lngNo): Exit Sub
    End If
    If vsAdvice.TextMatrix(lngRow, COL_¿‡±) = "D" Then
        If lngNo <> 0 Then
            Call GetDataºÏ≤È…Í«Î(lngRow, objAppPages())
            lngAppType = 0
        Else
            strExtData = GetºÏ≤È≤øŒª∑Ω∑®(lngRow)
            If strExtData = "" Then
                MsgBox "∏√ºÏ≤È“Ω÷ˆ «œµÕ≥…˝º∂“‘«∞œ¬¥Ôµƒ£¨”Îœ÷”–∑Ω Ω≤ªºÊ»›°£«Î÷ÿ–¬œ¬¥Ô∏√ºÏ≤È“Ω÷ˆ°£", vbInformation, gstrSysName
                Exit Sub
            End If
            intType = 0
        End If
    ElseIf vsAdvice.TextMatrix(lngRow, COL_¿‡±) = "F" Then
        strExtData = Get ÷ ı∏Ωº”IDs(lngRow)
        intType = 1
    ElseIf RowIn≈‰∑Ω––(lngRow) Then
        strExtData = Get÷–“©≈‰∑ΩIDs(lngRow)
        intType = 2
    ElseIf RowInºÏ—È––(lngRow) Then
        If lngNo <> 0 Then
            lngAppType = 3
            Call GetDataºÏ—È…Í«Î(lngRow, rsCard)
        Else
            strExtData = GetºÏ—È◊È∫œIDs(lngRow)
            intType = 4
        End If
    ElseIf vsAdvice.TextMatrix(lngRow, COL_¿‡±) = "E" Or vsAdvice.TextMatrix(lngRow, COL_¿‡±) = "K" Or vsAdvice.TextMatrix(lngRow, COL_¿‡±) = "Z" Then
        If CanUseApply(vsAdvice.TextMatrix(lngRow, COL_¿‡±)) Then
            Call GetData ‰—™…Í«Î(lngRow, rsCard)
            lngAppType = 1
        Else
            intType = 5
            If vsAdvice.TextMatrix(lngRow, COL_¿‡±) = "K" And Val(vsAdvice.TextMatrix(lngRow, COL_…Í«Î–Ú∫≈) & "") <> 0 Then
                Call frmBloodApply.ShowMe(Me, mlng≤°»ÀID, 0, 1, 3, Val(vsAdvice.RowData(lngRow)), mlng≤°»Àø∆ “id, , Val(vsAdvice.TextMatrix(lngRow, COL_ø™÷ˆø∆ “ID)), , , mrsDefine, mclsMipModule, 1, mstrπ“∫≈µ•)
                Exit Sub
            End If
        End If
    Else
        Exit Sub 'ºÊ»›“‘«∞µƒºÏ—ÈœÓƒø
    End If
    
    If intType = 4 Then
        lngFirstRow = vsAdvice.FindRow(CStr(vsAdvice.RowData(lngRow)), , COL_œ‡πÿID)
        lngœÓƒøid = Val(vsAdvice.TextMatrix(lngFirstRow, COL_’Ô¡∆œÓƒøID))
    Else
        lngœÓƒøid = Val(vsAdvice.TextMatrix(lngRow, COL_’Ô¡∆œÓƒøID))
    End If
    With t_Pati
        .bln“Ω±£ = InStr(",1,2,", mstr∏∂øÓ¬Î) > 0 And mstr∏∂øÓ¬Î <> ""
        .intœ’¿‡ = mintœ’¿‡
        .int”§∂˘ = mint”§∂˘
        .lng≤°»ÀID = mlng≤°»ÀID
        .lng≤°»Àø∆ “ID = mlng≤°»Àø∆ “id
        .strπ“∫≈µ• = mstrπ“∫≈µ•
        .str–‘± = mstr–‘±
    End With

    On Error Resume Next
    '∏ƒ‘ÏΩ”ø⁄£∫“‘«∞int≥°∫œ¥´Œ¥¥´£¨œ÷‘⁄¥´0£¨bytUseType“‘«∞Œ¥¥´£¨œ÷‘⁄¥´0
    If intType = 2 Then
        blnOK = frmAdviceFormula.ShowMe(Me, gclsInsure, txt“Ω÷ˆƒ⁄»›.hWnd, t_Pati, 0, 0, 1, 1, 1, _
                    lngœÓƒøid, strExtData, str’™“™)
    ElseIf intType <> -1 Then
        blnOK = frmAdviceEditEx.ShowMe(Me, txt“Ω÷ˆƒ⁄»›.hWnd, t_Pati, 0, intType, 0, 1, 1, 1, mblnNewLIS, False, _
                    lngœÓƒøid, strExtData, strAppend, , GetAdviceDiagnosis, str ÷ ı≤øŒª)
    End If
    '…Í«Îµ•
    If lngAppType = 0 Then
        blnOK = ApplyNewºÏ≤È…Í«Î(1, "", objAppPages())
    ElseIf lngAppType = 1 Then
        blnOK = ApplyNew ‰—™…Í«Î(1, "", rsCard)
    ElseIf lngAppType = 3 Then
        blnOK = ApplyNewºÏ—È…Í«Î(1, "", rsCard)
    End If
    On Error GoTo 0
    
    '÷ÿ–¬…Ë÷√œ‡πÿƒ⁄»›
    If blnOK Then
        'ªÒ»°“‘«∞µƒ’Ô∂œπÿ¡™––
        lngDiag = AdviceHaveDiag(lngRow)
        '∏¸–¬ø™÷ˆ ±º‰
        vsAdvice.TextMatrix(lngRow, COL_ø™÷ˆ ±º‰) = Format(zlDatabase.Currentdate, "yyyy-MM-dd HH:mm")
        vsAdvice.Cell(flexcpData, lngRow, COL_ø™÷ˆ ±º‰) = Format(zlDatabase.Currentdate, "yyyy-MM-dd HH:mm")
        vsAdvice.TextMatrix(lngRow, COL_µ•º€) = "" '«Â≥˝÷ÿ–¬º∆À„
        
        If vsAdvice.TextMatrix(lngRow, COL_¿‡±) = "D" Then
            If lngAppType = 0 Then
                Call DeleteºÏ≤È ÷ ı ‰—™(lngRow, True, lngTmp)
                lngRow = lngTmp
                Call AdviceSetºÏ≤È…Í«Î(lngRow, objAppPages())
                strAppend = vsAdvice.TextMatrix(lngRow, COL_∏ΩœÓ)
            Else
                'ºÏ≤È◊È∫œ
                Call AdviceSetºÏ≤È◊È∫œ(lngRow, strExtData)
                vsAdvice.TextMatrix(lngRow, col_“Ω÷ˆƒ⁄»›) = AdviceTextMake(lngRow)
            End If
            txt“Ω÷ˆƒ⁄»›.Text = vsAdvice.TextMatrix(lngRow, col_“Ω÷ˆƒ⁄»›)
        ElseIf vsAdvice.TextMatrix(lngRow, COL_¿‡±) = "F" Then
            '“ª◊È ÷ ı
            Call AdviceSet ÷ ı◊È∫œ(lngRow, strExtData)
            vsAdvice.Cell(flexcpData, lngRow, COL_±Í±æ≤øŒª) = str ÷ ı≤øŒª
            vsAdvice.TextMatrix(lngRow, col_“Ω÷ˆƒ⁄»›) = AdviceTextMake(lngRow)
            txt“Ω÷ˆƒ⁄»›.Text = vsAdvice.TextMatrix(lngRow, col_“Ω÷ˆƒ⁄»›)
        ElseIf lngAppType = 1 Then
            Call DeleteºÏ≤È ÷ ı ‰—™(lngRow)
            Call DeleteRow(lngRow, True)
            Call AdviceSet ‰—™…Í«Î(lngRow, rsCard)
            txt“Ω÷ˆƒ⁄»›.Text = vsAdvice.TextMatrix(lngRow, col_“Ω÷ˆƒ⁄»›)
            strAppend = ""
        ElseIf lngAppType = 3 Then
            Call DeleteºÏ—È…Í«Îµ•(lngRow, True, lngTmp)
            lngRow = lngTmp
            Call AdviceSetºÏ—È…Í«Î(lngRow, rsCard)
            strAppend = vsAdvice.TextMatrix(lngRow, COL_∏ΩœÓ)
            txt“Ω÷ˆƒ⁄»›.Text = vsAdvice.TextMatrix(lngRow, col_“Ω÷ˆƒ⁄»›)
        ElseIf RowInºÏ—È––(lngRow) Then
            'ºÏ—È◊È∫œ
            lngFirstRow = vsAdvice.FindRow(CStr(vsAdvice.RowData(lngRow)), , COL_œ‡πÿID)
            lng”√∑®ID = Val(vsAdvice.TextMatrix(lngRow, COL_’Ô¡∆œÓƒøID))
            
            'œ»ªÒ»°µ±«∞“—æ≠…Ë÷√∫√÷µ
            rsCurr.Fields.Append "Edit", adInteger, , adFldIsNullable
            rsCurr.Fields.Append "“Ω÷ˆID", adBigInt, , adFldIsNullable
            rsCurr.Fields.Append "÷¥––ø∆ “ID", adBigInt, , adFldIsNullable
            rsCurr.Fields.Append "∆µ¬ ", adVarChar, 20, adFldIsNullable
            rsCurr.Fields.Append "∆µ¬ ¥Œ ˝", adInteger, , adFldIsNullable
            rsCurr.Fields.Append "∆µ¬ º‰∏Ù", adInteger, , adFldIsNullable
            rsCurr.Fields.Append "º‰∏Ùµ•Œª", adVarChar, 4, adFldIsNullable
            rsCurr.Fields.Append "◊‹¡ø", adDouble, , adFldIsNullable
            rsCurr.Fields.Append "÷¥–– ±º‰", adVarChar, 50, adFldIsNullable
            rsCurr.Fields.Append "ø™ º ±º‰", adVarChar, 20, adFldIsNullable
            rsCurr.Fields.Append "ø™÷ˆ“Ω…˙", adVarChar, 20, adFldIsNullable
            rsCurr.Fields.Append "ø™÷ˆø∆ “ID", adBigInt, , adFldIsNullable
            rsCurr.Fields.Append "ø™÷ˆ ±º‰", adVarChar, 20, adFldIsNullable
            rsCurr.Fields.Append "“Ω…˙÷ˆÕ–", adVarChar, 100, adFldIsNullable
            rsCurr.Fields.Append "±Í÷æ", adVarChar, 4, adFldIsNullable
            
            rsCurr.CursorLocation = adUseClient
            rsCurr.LockType = adLockOptimistic
            rsCurr.CursorType = adOpenStatic
            rsCurr.Open
            rsCurr.AddNew
                        
            '≤…ºØ∑Ω∑®µƒ÷¥––ø∆ “ø…ƒ‹”ÎºÏ—ÈœÓƒø≤ªÕ¨
            If Val(vsAdvice.TextMatrix(lngFirstRow, COL_÷¥––ø∆ “ID)) <> 0 Then
                rsCurr!÷¥––ø∆ “ID = Val(vsAdvice.TextMatrix(lngFirstRow, COL_÷¥––ø∆ “ID))
            End If
            If Val(vsAdvice.TextMatrix(lngRow, COL_◊‹¡ø)) <> 0 Then
                rsCurr!◊‹¡ø = Val(vsAdvice.TextMatrix(lngRow, COL_◊‹¡ø))
            End If
            rsCurr!÷¥–– ±º‰ = vsAdvice.TextMatrix(lngRow, COL_÷¥–– ±º‰)
            rsCurr!∆µ¬  = vsAdvice.TextMatrix(lngRow, COL_∆µ¬ )
            rsCurr!∆µ¬ ¥Œ ˝ = Val(vsAdvice.TextMatrix(lngRow, COL_∆µ¬ ¥Œ ˝))
            rsCurr!∆µ¬ º‰∏Ù = Val(vsAdvice.TextMatrix(lngRow, COL_∆µ¬ º‰∏Ù))
            rsCurr!º‰∏Ùµ•Œª = vsAdvice.TextMatrix(lngRow, COL_º‰∏Ùµ•Œª)
            rsCurr!ø™ º ±º‰ = vsAdvice.Cell(flexcpData, lngRow, COL_ø™ º ±º‰)
            rsCurr!ø™÷ˆ“Ω…˙ = vsAdvice.TextMatrix(lngRow, COL_ø™÷ˆ“Ω…˙)
            rsCurr!ø™÷ˆø∆ “id = Val(vsAdvice.TextMatrix(lngRow, COL_ø™÷ˆø∆ “ID))
            rsCurr!ø™÷ˆ ±º‰ = vsAdvice.Cell(flexcpData, lngRow, COL_ø™÷ˆ ±º‰)
            rsCurr!“Ω…˙÷ˆÕ– = vsAdvice.TextMatrix(lngRow, COL_“Ω…˙÷ˆÕ–)
            rsCurr!±Í÷æ = vsAdvice.TextMatrix(lngRow, COL_±Í÷æ)
            '–ﬁ∏ƒ¡ÀºÏ—È◊È∫œƒ⁄»›,≤…ºØ∑Ω∑®––”¶±Íº«Œ™–ﬁ∏ƒ
            rsCurr!Edit = Val(vsAdvice.TextMatrix(lngRow, COL_EDIT))
            rsCurr!“Ω÷ˆID = vsAdvice.RowData(lngRow)
            rsCurr.Update
            
            'ÕÍ»´÷ÿ–¬…Ë÷√∏√ºÏ—È◊È∫œ
            '------------------------
            '…æ≥˝ºÏ—ÈœÓƒø––:…æ≥˝÷Æ∫Û÷ÿ–¬∂®Œªµƒµ±«∞––
            lngRow = DeleteºÏ—È◊È∫œ(lngRow)
            '«Â≥˝µ±«∞––(≤…ºØ∑Ω∑®––)
            Call DeleteRow(lngRow, True, False)
            '÷ÿ–¬≤˙…˙:≤˙…˙÷Æ∫Û÷ÿ–¬∂®Œªµƒµ±«∞––
            lngRow = AdviceSetºÏ—È◊È∫œ(lngRow, lng”√∑®ID, strExtData, rsCurr)
        ElseIf RowIn≈‰∑Ω––(lngRow) Then
            '÷–“©≈‰∑Ω
            lngFirstRow = vsAdvice.FindRow(CStr(vsAdvice.RowData(lngRow)), , COL_œ‡πÿID)
            lng’Ô¡∆œÓƒøID = Val(vsAdvice.TextMatrix(lngFirstRow, COL_’Ô¡∆œÓƒøID))
            lng”√∑®ID = Val(vsAdvice.TextMatrix(lngRow, COL_’Ô¡∆œÓƒøID))
            
            'œ»ªÒ»°µ±«∞“—æ≠…Ë÷√∫√÷µ
            rsCurr.Fields.Append "Edit", adInteger, , adFldIsNullable
            rsCurr.Fields.Append "“Ω÷ˆID", adBigInt, , adFldIsNullable
            rsCurr.Fields.Append "÷¥–––‘÷ ", adVarChar, 10, adFldIsNullable
            rsCurr.Fields.Append "÷¥––ø∆ “ID", adBigInt, , adFldIsNullable
            rsCurr.Fields.Append "∆µ¬ ", adVarChar, 20, adFldIsNullable
            rsCurr.Fields.Append "∆µ¬ ¥Œ ˝", adInteger, , adFldIsNullable
            rsCurr.Fields.Append "∆µ¬ º‰∏Ù", adInteger, , adFldIsNullable
            rsCurr.Fields.Append "º‰∏Ùµ•Œª", adVarChar, 4, adFldIsNullable
            rsCurr.Fields.Append "◊‹¡ø", adDouble, , adFldIsNullable
            rsCurr.Fields.Append "÷¥–– ±º‰", adVarChar, 50, adFldIsNullable
            rsCurr.Fields.Append "ø™ º ±º‰", adVarChar, 20, adFldIsNullable
            rsCurr.Fields.Append "ø™÷ˆ“Ω…˙", adVarChar, 20, adFldIsNullable
            rsCurr.Fields.Append "ø™÷ˆø∆ “ID", adBigInt, , adFldIsNullable
            rsCurr.Fields.Append "ø™÷ˆ ±º‰", adVarChar, 20, adFldIsNullable
            rsCurr.Fields.Append "“Ω…˙÷ˆÕ–", adVarChar, 100, adFldIsNullable
            rsCurr.Fields.Append "±Í÷æ", adVarChar, 4, adFldIsNullable
            
            rsCurr.CursorLocation = adUseClient
            rsCurr.LockType = adLockOptimistic
            rsCurr.CursorType = adOpenStatic
            rsCurr.Open
            rsCurr.AddNew
            
            rsCurr!÷¥–––‘÷  = NeedName(cbo÷¥–––‘÷ .Text) '’˝≥£,◊‘±∏“©,¿Î‘∫¥¯“©
            
            '»°≈‰∑ΩΩÁ√Ê—°‘Òµƒ“©∑ø
            rsCurr!÷¥––ø∆ “ID = Val(Split(strExtData, "|")(4))
            
            rsCurr!∆µ¬  = vsAdvice.TextMatrix(lngFirstRow, COL_∆µ¬ )
            rsCurr!∆µ¬ ¥Œ ˝ = Val(vsAdvice.TextMatrix(lngFirstRow, COL_∆µ¬ ¥Œ ˝))
            rsCurr!∆µ¬ º‰∏Ù = Val(vsAdvice.TextMatrix(lngFirstRow, COL_∆µ¬ º‰∏Ù))
            rsCurr!º‰∏Ùµ•Œª = vsAdvice.TextMatrix(lngFirstRow, COL_º‰∏Ùµ•Œª)
            
            '»°≈‰∑ΩΩÁ√Ê—°‘Òµƒ∏∂ ˝
            rsCurr!◊‹¡ø = Val(Split(strExtData, "|")(3))
            
            rsCurr!÷¥–– ±º‰ = vsAdvice.TextMatrix(lngFirstRow, COL_÷¥–– ±º‰)
            rsCurr!ø™ º ±º‰ = vsAdvice.Cell(flexcpData, lngFirstRow, COL_ø™ º ±º‰)
            rsCurr!ø™÷ˆ“Ω…˙ = vsAdvice.TextMatrix(lngFirstRow, COL_ø™÷ˆ“Ω…˙)
            rsCurr!ø™÷ˆø∆ “id = Val(vsAdvice.TextMatrix(lngFirstRow, COL_ø™÷ˆø∆ “ID))
            rsCurr!ø™÷ˆ ±º‰ = vsAdvice.Cell(flexcpData, lngFirstRow, COL_ø™÷ˆ ±º‰)
            rsCurr!“Ω…˙÷ˆÕ– = vsAdvice.TextMatrix(lngRow, COL_“Ω…˙÷ˆÕ–)
            rsCurr!±Í÷æ = vsAdvice.TextMatrix(lngRow, COL_±Í÷æ)
            '–ﬁ∏ƒ¡À≈‰∑Ωƒ⁄»›,”√∑®––”¶±Íº«Œ™–ﬁ∏ƒ
            rsCurr!Edit = Val(vsAdvice.TextMatrix(lngRow, COL_EDIT))
            rsCurr!“Ω÷ˆID = vsAdvice.RowData(lngRow)
            
            rsCurr.Update
            
            'ÕÍ»´÷ÿ–¬…Ë÷√∏√÷–“©≈‰∑Ω––
            '------------------------
            '…æ≥˝◊È≥…Œ∂“©º∞ºÂ∑®––:…æ≥˝÷Æ∫Û÷ÿ–¬∂®Œªµƒµ±«∞––
            lngRow = Delete÷–“©≈‰∑Ω(lngRow)
            '»Áπ˚µ±«∞”√∑®µƒ≈‰∑ΩID≤ªŒ™ø’£¨‘Ú¥´»Î≈‰∑ΩID
            lng≈‰∑ΩID = Val(vsAdvice.TextMatrix(lngRow, COL_≈‰∑ΩID))
            '«Â≥˝µ±«∞––(÷–“©”√∑®––)
            Call DeleteRow(lngRow, True, False)
            '≤˙…˙≈‰∑Ω:≤˙…˙÷Æ∫Û÷ÿ–¬∂®Œªµƒµ±«∞––
            lngRow = AdviceSet÷–“©≈‰∑Ω(lng’Ô¡∆œÓƒøID, lngRow, lng”√∑®ID, strExtData, rsCurr, str’™“™, lng≈‰∑ΩID)
        End If
        
        '∏¸–¬∏Ωº˛ƒ⁄»›:“‘µ±«∞ø…º˚––Œ™◊º
        If strAppend <> "" Then
            vsAdvice.TextMatrix(lngRow, COL_∏ΩœÓ) = strAppend
            vsAdvice.Cell(flexcpData, lngRow, COL_∏ΩœÓ) = 1 '±Ì√˜–Ë“™÷ÿ–¬–¥»Î(–¬‘ˆªÚ–ﬁ∏ƒ)
            Call ReplaceAdviceAppend(lngRow) '»± °ÃÊªª∆‰À˚“Ω÷ˆµƒ…Í«Î∏ΩœÓ
        End If
        
        '«ø––œ‘ æµ±«∞“Ω÷ˆø®∆¨
        Call vsAdvice_AfterRowColChange(-1, -1, vsAdvice.Row, vsAdvice.Col)
                
        Call CalcAdviceMoney 'œ‘ æ–¬ø™“Ω÷ˆΩ∂Ó
        
        If InStr(",0,3,", vsAdvice.TextMatrix(lngRow, COL_EDIT)) > 0 Then
            vsAdvice.TextMatrix(lngRow, COL_EDIT) = 2 '±Íº«Œ™±ª–ﬁ∏ƒ
            vsAdvice.TextMatrix(lngRow, COL_◊¥Ã¨) = 1 '–ﬁ∏ƒ∫Û±‰Œ™–¬ø™
            Call ReSetColor(lngRow)
        End If
        
        '–ﬁ∏ƒ∫Ûπÿ¡™’Ô∂œµƒ±Íº«¥¶¿Ì
        If lngDiag <> -1 Then
            Call SetDiagFlag(vsAdvice.Row, 1, lngDiag)
        End If
        
        mblnNoSave = True '±Íº«Œ™Œ¥±£¥Ê
    End If
    
    Call vsAdvice.AutoSize(col_“Ω÷ˆƒ⁄»›)
    
    '∂‘±£œ’∂‘¬ÎΩ¯––ºÏ≤È
    Call GetInsureStr(strIDs1, strIDs2, str“Ω÷ˆƒ⁄»›, vsAdvice.Row)
    strMsg = CheckAdviceInsure(mintœ’¿‡, mblnÃ·–—∂‘¬Î, mlng≤°»ÀID, 1, strIDs1, strIDs2, str“Ω÷ˆƒ⁄»›)
    If strMsg <> "" Then
        If gint“Ω±£∂‘¬Î = 2 Then strMsg = strMsg & vbCrLf & vbCrLf & "«Îœ»∫Õœ‡πÿ»À‘±¡™œµ¥¶¿Ì£¨∑Ò‘Ú“Ω÷ˆΩ´≤ª‘ –Ì±£¥Ê°£"
        vMsg = frmMsgBox.ShowMsgBox(strMsg, Me, True)
        If vMsg = vbIgnore Then mblnÃ·–—∂‘¬Î = False
    End If
    
    txt“Ω÷ˆƒ⁄»›.SetFocus
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Sub ReplaceAdviceAppend(ByVal lngRow As Long)
'π¶ƒ‹£∫∏˘æ›÷∏∂®––µƒ…Í«Î∏ΩœÓ ‰»Î«Èøˆ£¨∂‘∆‰À˚–¬¬º“Ω÷ˆµƒ…Í«Î∏ΩœÓΩ¯––»± °ÃÊªª
'≤Œ ˝£∫lngRow=≤≈–¬ ‰»ÎªÚ–ﬁ∏ƒµƒø…º˚“Ω÷ˆ––
    Dim strAppend As String, i As Long
    
    With vsAdvice
        If .TextMatrix(lngRow, COL_∏ΩœÓ) = "" Then Exit Sub
        
        For i = .FixedRows To .Rows - 1
            '÷ª’Î∂‘–¬¬º»Îµƒ“Ω÷ˆ£¨–ﬁ∏ƒµƒ“Ω÷ˆ–ﬁ∏ƒ ±“—ºÏ≤È
            '".Cell(flexcpData, i, COL_∏ΩœÓ) = 1"µƒø…ƒ‹ªπ√ª”–‘⁄ ‰»Îπ˝≥Ã÷–ºÏ≤È£¨÷ª «◊‘∂ØÃÊªª¡À
            If .RowData(i) <> 0 And Not .RowHidden(i) And i <> lngRow And Val(.TextMatrix(i, COL_EDIT)) = 1 Then
                If .TextMatrix(i, COL_∏ΩœÓ) <> "" Then
                    strAppend = ReplaceAppend(.TextMatrix(i, COL_∏ΩœÓ), .TextMatrix(lngRow, COL_∏ΩœÓ))
                    If .TextMatrix(i, COL_∏ΩœÓ) <> strAppend Then
                        .TextMatrix(i, COL_∏ΩœÓ) = strAppend
                        .Cell(flexcpData, i, COL_∏ΩœÓ) = 1
                    End If
                End If
            End If
        Next
    End With
End Sub

Private Sub ClinicSelecter(Optional ByVal ¿‡–Õ As Integer, Optional ByVal lng∑÷¿‡id As Long)
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String
    
    If ¿‡–Õ = 8 And lng∑÷¿‡id <> 0 Then
        '÷±Ω”∂¡»°—°‘Òµƒ≥…Ã◊œÓƒø
        On Error GoTo errH
        strSQL = "Select A.¿‡± As ¿‡±ID,A.ID as ’Ô¡∆œÓƒøID,Null as  ’∑—œ∏ƒøID,B.√˚≥∆ As ¿‡±,A.±‡¬Î,A.√˚≥∆,A.º∆À„µ•Œª,A.±Í±æ≤øŒª,NULL as œÓƒøÃÿ–‘" & _
            " From ’Ô¡∆œÓƒøƒø¬º A,’Ô¡∆œÓƒø¿‡± B Where A.¿‡±=B.±‡¬Î And A.ID=[1]"
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng∑÷¿‡id)
    Else
        '¥Úø™—°‘Ò∆˜£¨ø…ƒ‹÷∏∂®¡À≥ı º∑÷¿‡ƒø¬º
        Set rsTmp = frmClinicSelect.ShowSelect(Me, IIF(mlng«∞Ã·ID <> 0, 2, 0), 0, mlng≤°»Àø∆ “id, 1, mstr–‘±, , , 1, lng∑÷¿‡id, mintœ’¿‡)
        If rsTmp Is Nothing Then '»°œ˚ªÚŒﬁ ˝æ›
            zlControl.TxtSelAll txt“Ω÷ˆƒ⁄»›
            txt“Ω÷ˆƒ⁄»›.SetFocus: Exit Sub
        End If
    End If
    
    '∏˘æ›—°‘ÒœÓƒø…Ë÷√»± °“Ω÷ˆ–≈œ¢
    If AdviceInput(rsTmp, vsAdvice.Row) Then
        'œ‘ æ“—»± °…Ë÷√µƒ÷µ
        Call vsAdvice_AfterRowColChange(-1, vsAdvice.Col, vsAdvice.Row, vsAdvice.Col)
        
        Call CalcAdviceMoney 'œ‘ æ–¬ø™“Ω÷ˆΩ∂Ó
        
        '“Ω±£π‹øÿ µ ±º‡≤‚
        If mintœ’¿‡ <> 0 And Val(vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_EDIT)) = 0 Then
            '◊‹¡ø≤ªø… ‰»Î£∫»± °≤¢πÃ∂®◊‹¡øµƒ“Ω÷ˆ£¨“‘º∞≥§÷ˆ
            '≥…Ã◊“Ω÷ˆ≤ª‘⁄’‚¿ÔºÏ≤È
            If gclsInsure.GetCapability(support µ ±º‡øÿ, mlng≤°»ÀID, mintœ’¿‡) And Not txt◊‹¡ø.Enabled Then
                If MakePriceRecord(vsAdvice.Row) Then
                    If Not gclsInsure.CheckItem(mintœ’¿‡, 0, 0, mrsPrice) Then
                        Call AdviceCurRowClear: Exit Sub
                    End If
                End If
                '±Íº«Œ™“—æ≠◊˜¡ÀºÏ≤È
                vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_◊¥Ã¨) = 1
            End If
        End If
                 
        txt“Ω÷ˆƒ⁄»›.SetFocus: Call SeekNextControl '±ÿ–Îœ»∂®Œª
    Else
        'ª÷∏¥‘≠÷µ(AdviceInput∫Ø ˝÷–ø…ƒ‹¥¶¿Ì¡À“ªœ¬)
        txt“Ω÷ˆƒ⁄»›.Text = vsAdvice.TextMatrix(vsAdvice.Row, col_“Ω÷ˆƒ⁄»›)
        txt“Ω÷ˆƒ⁄»›.SetFocus
    End If
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Sub cmdSel_Click()
    Call ClinicSelecter
End Sub

Private Sub cmdø™ º ±º‰_Click()
    If IsDate(txtø™ º ±º‰.Text) Then
        dtpDate.value = CDate(txtø™ º ±º‰.Text)
    Else
        dtpDate.value = zlDatabase.Currentdate
    End If
    dtpDate.Tag = "ø™ º ±º‰"
    dtpDate.Left = txtø™ º ±º‰.Left + fraAdvice.Left
    dtpDate.Top = txtø™ º ±º‰.Top + fraAdvice.Top - dtpDate.Height
    dtpDate.Visible = True
    dtpDate.SetFocus
End Sub

Private Sub dtpDate_DateClick(ByVal DateClicked As Date)
    Dim strDate As String
    
    If dtpDate.Tag = "ø™ º ±º‰" Then
        '»°÷µ
        If IsDate(txtø™ º ±º‰.Text) Then
            strDate = Format(DateClicked, "yyyy-MM-dd") & " " & Mid(Format(txtø™ º ±º‰.Text, "yyyy-MM-dd HH:mm"), 12, 5)
        Else
            strDate = Format(DateClicked, "yyyy-MM-dd") & " " & Mid(Format(zlDatabase.Currentdate, "yyyy-MM-dd HH:mm"), 12, 5)
        End If
        
        '≈–∂œ ±º‰∫œ∑®–‘
        If Not Checkø™ º ±º‰(strDate) Then
            dtpDate.SetFocus: Exit Sub
        End If
        
        txtø™ º ±º‰.Text = strDate
        dtpDate.Tag = ""
        dtpDate.Visible = False
        Call txtø™ º ±º‰_Validate(False) '∏¸–¬ ˝æ›
        txtø™ º ±º‰.SetFocus
    ElseIf dtpDate.Tag = "∞≤≈≈ ±º‰" Then
        '»°÷µ
        If IsDate(txt∞≤≈≈ ±º‰.Text) Then
            strDate = Format(DateClicked, "yyyy-MM-dd") & " " & Mid(Format(txt∞≤≈≈ ±º‰.Text, "yyyy-MM-dd HH:mm"), 12, 5)
        Else
            strDate = Format(DateClicked, "yyyy-MM-dd") & " " & Mid(Format(zlDatabase.Currentdate, "yyyy-MM-dd HH:mm"), 12, 5)
        End If
        
        '≈–∂œ ±º‰∫œ∑®–‘
        If Not Check∞≤≈≈ ±º‰(strDate, txtø™ º ±º‰.Text, vsAdvice.TextMatrix(vsAdvice.Row, COL_¿‡±)) Then
            dtpDate.SetFocus: Exit Sub
        End If
        
        txt∞≤≈≈ ±º‰.Text = strDate
        dtpDate.Tag = ""
        dtpDate.Visible = False
        Call txt∞≤≈≈ ±º‰_Validate(False) '∏¸–¬ ˝æ›
        txt∞≤≈≈ ±º‰.SetFocus
    End If
End Sub

Private Sub dtpDate_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        KeyAscii = 0
        Call dtpDate_DateClick(dtpDate.value)
    End If
End Sub

Private Sub dtpDate_Validate(Cancel As Boolean)
    dtpDate.Visible = False
    dtpDate.Tag = ""
End Sub

Private Sub Form_Activate()
    If mblnRunFirst Then
        mblnRunFirst = False
        If vsDiag.Rows = 2 And vsDiag.TextMatrix(1, col’Ô∂œ) = "" Then
            If vsDiag.Enabled Then
                Call vsDiag_AfterRowColChange(vsDiag.Row, vsDiag.Col, vsDiag.Row, vsDiag.Col)
                vsDiag.SetFocus
            End If
        Else
            If txt“Ω÷ˆƒ⁄»›.Enabled Then txt“Ω÷ˆƒ⁄»›.SetFocus
        End If
        'µ⁄“ª¥ŒΩ¯»Î ±Ω´πˆ∂ØÃı“∆µΩµ±«∞––£¨“ÚŒ™Load÷–≤ªƒ‹“∆∂Øπˆ∂ØÃı,µ˜”√¡Ω¥Œ≤≈…˙–ß°£
        Call vsAdvice.ShowCell(vsAdvice.Row, vsAdvice.Col)
        Call vsAdvice.ShowCell(vsAdvice.Row, vsAdvice.Col)
    End If
End Sub

Private Sub Form_KeyDown(KeyCode As Integer, Shift As Integer)
    Dim str’™“™ As String
    Dim str÷–“©IDs As String
    Dim lngBaseRow As Long, i As Long
    Dim lng ’∑—œ∏ƒøID As Long, str’Ô¡∆œÓƒøID As String
    
    If Shift = vbAltMask Then
        If Between(Chr(KeyCode), "1", "9") And Not mfrmShortCut Is Nothing Then
            Call mfrmShortCut.ShowShortCut(Val(Chr(KeyCode)))
        End If
    ElseIf Shift = vbCtrlMask And KeyCode = vbKeyD Then
        '±£¥Ê≥£”√÷ˆÕ–
        If cmd≥£”√÷ˆÕ–.Enabled And cmd≥£”√÷ˆÕ–.Visible Then
            Call cmd≥£”√÷ˆÕ–_Click
        End If
    ElseIf KeyCode = vbKeyF1 And Shift = vbCtrlMask Then
        'µ˜”√“Ω±£Ã· æ
        With vsAdvice
            If .RowData(.Row) <> 0 Then
                lng ’∑—œ∏ƒøID = Val(.TextMatrix(.Row, COL_ ’∑—œ∏ƒøID))
                str’Ô¡∆œÓƒøID = Val(.TextMatrix(.Row, COL_’Ô¡∆œÓƒøID))
                If RowIn≈‰∑Ω––(.Row) Then
                    'ªÒ»°÷–“©≈‰∑Ωµ⁄“ªŒ∂÷–“©––
                    lngBaseRow = .FindRow(CStr(.RowData(.Row)), , COL_œ‡πÿID)
                    For i = lngBaseRow To .Row
                        If i = lngBaseRow Then lng ’∑—œ∏ƒøID = Val(.TextMatrix(i, COL_ ’∑—œ∏ƒøID))
                        If .TextMatrix(i, COL_¿‡±) = "7" Then
                            str÷–“©IDs = str÷–“©IDs & "," & .TextMatrix(i, COL_’Ô¡∆œÓƒøID)
                        End If
                    Next
                    str÷–“©IDs = Mid(str÷–“©IDs, 2)
                    If UBound(Split(str÷–“©IDs, ",")) <> 0 Then
                        lng ’∑—œ∏ƒøID = 0
                    End If
                    str’Ô¡∆œÓƒøID = str÷–“©IDs
                End If
                '“Ω±£≤°»À ‰»Îƒ⁄»› ±µƒÃ· æ£∫∑«“Ω±£≤°»À“≤“™µ˜(Or And mintœ’¿‡ <> 0)
                str’™“™ = gclsInsure.GetItemInfo(mintœ’¿‡, mlng≤°»ÀID, lng ’∑—œ∏ƒøID, CStr(.Cell(flexcpData, .Row, COL_“Ω…˙÷ˆÕ–)), 0, "", str’Ô¡∆œÓƒøID)
                .Cell(flexcpData, .Row, COL_“Ω…˙÷ˆÕ–) = str’™“™
            End If
        End With
    Else
        Select Case KeyCode
            Case vbKeyEscape
                If dtpDate.Visible Then
                    dtpDate.Visible = False
                    dtpDate.Tag = ""
                End If
            Case vbKeyF4, vbKeyUp, vbKeyDown
                If Me.ActiveControl Is txtø™ º ±º‰ Then
                    If cmdø™ º ±º‰.Visible And cmdø™ º ±º‰.Enabled Then cmdø™ º ±º‰_Click
                ElseIf Me.ActiveControl Is txt∞≤≈≈ ±º‰ Then
                    If cmd∞≤≈≈ ±º‰.Enabled And cmd∞≤≈≈ ±º‰.Visible Then cmd∞≤≈≈ ±º‰_Click
                ElseIf Me.ActiveControl Is txt“Ω÷ˆƒ⁄»› Then
                    If cmdExt.Visible And cmdExt.Enabled Then cmdExt_Click
                ElseIf Me.ActiveControl Is txt”√∑® Then
                    If cmd”√∑®.Visible And cmd”√∑®.Enabled Then cmd”√∑®_Click
                ElseIf Me.ActiveControl Is txt∆µ¬  Then
                    If cmd∆µ¬ .Visible And cmd∆µ¬ .Enabled Then cmd∆µ¬ _Click
                End If
            Case vbKeyF7 '«–ªª ‰»Î∑®
                If stbThis.Panels("WB").Visible And stbThis.Panels("PY").Visible Then
                    If stbThis.Panels("WB").Bevel = sbrRaised Then
                        Call stbThis_PanelClick(stbThis.Panels("WB"))
                    Else
                        Call stbThis_PanelClick(stbThis.Panels("PY"))
                    End If
                End If
            Case vbKeyF8 '«–ªªœ‘ æº∆º€œÓƒø
                If stbThis.Panels("Price").Visible Then
                    Call stbThis_PanelClick(stbThis.Panels("Price"))
                End If
        End Select
    End If
End Sub

Private Sub Form_KeyPress(KeyAscii As Integer)
    If KeyAscii = Asc("'") Then
        KeyAscii = 0
    ElseIf KeyAscii = Asc("`") Then
        KeyAscii = 0
        If Not mfrmShortCut Is Nothing Then Call mfrmShortCut.ShowMe(Me, mint≥°∫œ, 1, 0, mlng≤°»Àø∆ “id)
    ElseIf KeyAscii = vbKeySpace Then
        If Me.ActiveControl Is txtø™ º ±º‰ And txtø™ º ±º‰.SelLength = Len(txtø™ º ±º‰.Text) Then
            KeyAscii = 0
            If cmdø™ º ±º‰.Visible And cmdø™ º ±º‰.Enabled Then cmdø™ º ±º‰_Click
        ElseIf Me.ActiveControl Is txt∞≤≈≈ ±º‰ And txt∞≤≈≈ ±º‰.SelLength = Len(txt∞≤≈≈ ±º‰.Text) Then
            KeyAscii = 0
            If cmd∞≤≈≈ ±º‰.Enabled And cmd∞≤≈≈ ±º‰.Visible Then cmd∞≤≈≈ ±º‰_Click
        ElseIf Me.ActiveControl Is txt“Ω÷ˆƒ⁄»› Then
            KeyAscii = 0
            If cmdExt.Visible And cmdExt.Enabled Then cmdExt_Click
        ElseIf Me.ActiveControl Is txt”√∑® Then
            KeyAscii = 0
            If cmd”√∑®.Visible And cmd”√∑®.Enabled Then cmd”√∑®_Click
        ElseIf Me.ActiveControl Is txt∆µ¬  Then
            KeyAscii = 0
            If cmd∆µ¬ .Visible And cmd∆µ¬ .Enabled Then cmd∆µ¬ _Click
        ElseIf Me.ActiveControl Is cboµŒÀŸ Then
            KeyAscii = 0
            If cboµŒÀŸ.Visible And cboµŒÀŸ.Enabled Then zlCommFun.PressKey (vbKeyF4)
        End If
    End If
End Sub

Private Sub Form_Load()
    Dim lngTmp As Long
    Dim strErr As String
    
    Dim arrTmp As Variant
    Dim strTmp As String
    Dim objForm As Object
    Dim strNames As String
    Dim i As Long
    
    mbln¿©’π“≥«© = False
    
    'Õ‚π“Ã·π©µƒø®∆¨
    Call CreatePlugInOK(p√≈’Ô“Ω÷ˆœ¬¥Ô, mint≥°∫œ)
    If Not gobjPlugIn Is Nothing Then
        Set mcolSubForm = New Collection
        On Error Resume Next
        strTmp = gobjPlugIn.GetFormCaption(glngSys, p√≈’Ô“Ω÷ˆœ¬¥Ô)
        Call zlPlugInErrH(err, "GetFormCaption")
        If strTmp <> "" Then
            arrTmp = Split(strTmp, ",")
            For i = 0 To UBound(arrTmp)
                strTmp = arrTmp(i)
                Set objForm = gobjPlugIn.GetForm(glngSys, p√≈’Ô“Ω÷ˆœ¬¥Ô, strTmp)
                Call zlPlugInErrH(err, "GetForm")
                If Not objForm Is Nothing Then
                    mcolSubForm.Add objForm, "_" & strTmp
                    strNames = strNames & "," & strTmp
                End If
                Set objForm = Nothing
            Next
        End If
        err.Clear: On Error GoTo 0
    End If

    If strNames <> "" Then
        mbln¿©’π“≥«© = True
        strNames = Mid(strNames, 2)
    End If
    
    If mbln¿©’π“≥«© Then
        arrTmp = Split(strNames, ",")
        With tbcSub
            With .PaintManager
                .Appearance = xtpTabAppearancePropertyPage2003
                .ClientFrame = xtpTabFrameSingleLine
                .BoldSelected = True
                .OneNoteColors = True
                .ShowIcons = True
            End With
            
            .InsertItem(0, "“Ω÷ˆ±‡º≠", picSub.hWnd, 0).Tag = "“Ω÷ˆ±‡º≠"
            For i = 0 To UBound(arrTmp)
                strTmp = arrTmp(i)
                .InsertItem(i + 1, strTmp, mcolSubForm("_" & strTmp).hWnd, 0).Tag = strTmp
            Next
        End With
    Else
        tbcSub.Visible = False
    End If
    
    Call InitObjLis(p√≈’Ô“Ω…˙’æ)
    If gobjLIS Is Nothing Then
        mblnNewLIS = False
    Else
        On Error Resume Next
        mblnNewLIS = gobjLIS.GetApplicationFormShowType
        err.Clear: On Error GoTo 0
    End If
    Call InitCommandBar
    Call InitAdviceTable
    If mint≥°∫œ = 0 Then
        '◊÷ÃÂ…Ë÷√
        mbytSize = zlDatabase.GetPara("◊÷ÃÂ", glngSys, p√≈’Ô“Ω…˙’æ, "0")
    ElseIf mint≥°∫œ = 2 Then
        mbytSize = zlDatabase.GetPara("◊÷ÃÂ", glngSys, p“Ωººπ§◊˜’æ, "0")
    End If
    Call SetFontSize(mbytSize)
    Call RestoreWinState(Me, App.ProductName)
    vsAdvice.ColWidth(0) = 14 * Screen.TwipsPerPixelX

    Call zlControl.CboSetHeight(cboµŒÀŸ, Me.Height)
    Call zlControl.CboSetHeight(cbo÷¥––ø∆ “, Me.Height)
    Call zlControl.CboSetWidth(cbo÷¥––ø∆ “.hWnd, cbo÷¥––ø∆ “.Width * 1.3)
    fraPati.BackColor = Me.BackColor
    fra’Ô∂œ.BackColor = Me.BackColor

    mblnOK = False
    mblnNoSave = False
    mblnRowMerge = False
    mblnRunFirst = True
    mblnRowChange = True
    mblnDoCheck = True
    mstrDelIDs = ""
    mstrAduitDelIDs = ""
    mstrDel ‰—™ = ""
    mlngID–Ú¡– = 0
    mblnAddAgent = zlDatabase.GetPara("“™«Ûµ«º«¥˙∞Ï»À", glngSys, p√≈’Ô“Ω÷ˆœ¬¥Ô, "1") = "1"
    mblnFreeInput = Val(zlDatabase.GetPara("’Ô∂œ ÷ ı√˚≥∆◊‘”…µ˜’˚", glngSys, 0)) = 1
    ' ‰»Î∆•≈‰
    mstrLike = IIF(Val(zlDatabase.GetPara(" ‰»Î∆•≈‰")) = 0, "%", "")
    'ºÚ¬Î∆•≈‰∑Ω Ω£∫0-∆¥“Ù,1-ŒÂ± 
    mintºÚ¬Î = Val(zlDatabase.GetPara("ºÚ¬Î∑Ω Ω"))
    '∆Ù”√∆¡ƒªº¸≈Ã
    mblnStaKB = Val(zlDatabase.GetPara("∆Ù”√∆¡ƒªº¸≈Ã", glngSys, p√≈’Ô“Ω…˙’æ)) <> 0
    If Not mblnStaKB Then
        stbThis.Panels("KB").Visible = False
    End If
    stbThis.Panels("KB").ToolTipText = "µ„ª˜∆Ù”√∆¡ƒªº¸≈Ã"
    Select Case mintºÚ¬Î
    Case 0
        stbThis.Panels("PY").Bevel = sbrInset
        stbThis.Panels("WB").Bevel = sbrRaised
    Case 1
        stbThis.Panels("PY").Bevel = sbrRaised
        stbThis.Panels("WB").Bevel = sbrInset
    Case Else
        stbThis.Panels("PY").Bevel = sbrInset
        stbThis.Panels("WB").Bevel = sbrInset
    End Select
    If Not gblnºÚ¬Î∆•≈‰∑Ω Ω«–ªª Then
        stbThis.Panels("PY").Visible = False
        stbThis.Panels("WB").Visible = False
    End If

    'PASSΩ”ø⁄≥ı ºªØ
    Call zlPASSMap
    If mblnPass Then
        If gobjPass.zlPassCheck(mobjPassMap) Then        'Pass
            '≤°»Àπ˝√Ù ∑/≤°…˙◊¥Ã¨ø…”√ºÏ≤‚
            Call gobjPass.zlPassCmdAlleyEnable(mobjPassMap)
        End If
    End If
    '’Ô∂œ ‰»Î¿¥‘¥
    opt’Ô∂œ(Val(zlDatabase.GetPara("√≈’Ô’Ô∂œ ‰»Î", glngSys, p√≈’Ô“Ω…˙’æ, 0, Array(opt’Ô∂œ(0), opt’Ô∂œ(1)), InStr(GetInsidePrivs(p√≈’Ô“Ω÷ˆœ¬¥Ô), "“Ω÷ˆ—°œÓ…Ë÷√") > 0))).value = True
    If gint’Ô∂œ¿¥‘¥ > 1 Then
        opt’Ô∂œ(0).Enabled = False
        opt’Ô∂œ(1).Enabled = False
        If gint’Ô∂œ¿¥‘¥ = 2 Then
            opt’Ô∂œ(0).value = True
        ElseIf gint’Ô∂œ¿¥‘¥ = 3 Then
            opt’Ô∂œ(1).value = True
        End If
    End If
    opt’Ô∂œ(0).TabStop = False
    opt’Ô∂œ(1).TabStop = False

    'º∆º€√Ê∞Â◊¥Ã¨
    If mblnModal Then
        stbThis.Panels("Price").Visible = False
    Else
        Set mfrmPrice = New frmAdvicePrice
        stbThis.Panels("Price").Tag = zlDatabase.GetPara("œ‘ æ“Ω÷ˆº∆º€√Ê∞Â", glngSys, p√≈’Ô“Ω÷ˆœ¬¥Ô)
    End If

    '±ÿ–Î¬º»Î“©∆∑µ•¡ø
    mblnµ•¡ø = Val(zlDatabase.GetPara("±ÿ–Î¬º»Î“©∆∑µ•¡ø", glngSys, p√≈’Ô“Ω÷ˆœ¬¥Ô)) <> 0

    '÷¥––ÃÏ ˝
    mblnÃÏ ˝ = Val(zlDatabase.GetPara("“Ω÷ˆ÷¥––ÃÏ ˝", glngSys, p√≈’Ô“Ω÷ˆœ¬¥Ô)) <> 0
    vsAdvice.ColHidden(COL_ÃÏ ˝) = Not mblnÃÏ ˝
    
    mblnÃÏ ˝∑¥À„ = (gbln∑¥À„ÃÏ ˝ And mblnÃÏ ˝)

    'øπæ˙“©ŒÔ»± °”√“©ƒøµƒ
    mstrPurMed = zlDatabase.GetPara("øπæ˙“©ŒÔ»± °”√“©ƒøµƒ", glngSys, p√≈’Ô“Ω÷ˆœ¬¥Ô, "0")

    '◊‘∂Ø¥¶¿Ì∆§ ‘
    mbln◊‘∂Ø∆§ ‘ = Val(zlDatabase.GetPara("◊‘∂Ø¥¶¿Ì∆§ ‘", glngSys, p√≈’Ô“Ω÷ˆœ¬¥Ô)) <> 0 And mlng«∞Ã·ID = 0

    '◊‘∂Øπÿ±’¥∞ÃÂ
    mblnAutoClose = Val(zlDatabase.GetPara("∑¢ÀÕÕÍ≥…∫Ûπÿ±’“Ω÷ˆ¥∞ÃÂ", glngSys, p√≈’Ô“Ω÷ˆœ¬¥Ô)) <> 0

    '“©∆∑°¢Œ¿≤ƒ≥ˆø‚ºÏ≤È∑Ω Ω
    Set mcolStock1 = GetStockCheck(0)
    Set mcolStock2 = GetStockCheck(1)
    
    With cboDruPur
        .Clear
        .AddItem " "
        .AddItem "‘§∑¿"
        .AddItem "÷Œ¡∆"
    End With
    
    '≥£”√÷ˆÕ–
    Call ReadEnjoin
    '“Ω÷ˆƒ⁄»›∂®“Â
    If CreateScript(mobjVBA, mobjScript) Then
        Set mrsDefine = InitAdviceDefine
    End If
    '--------------------------------------------------
    '∂¡»°≤°»À–≈œ¢
    Call GetPatiInfo
    Call SetBabyVisible(mlng≤°»Àø∆ “id)
    '∂¡»°¥˙∞Ï»À–≈œ¢
    Call GetAgentInfo

    '–ﬁ∏ƒ ±«ø––∂®Œª”§∂˘
    If mlng“Ω÷ˆID = 0 Then    '–¬‘ˆ
        cbo”§∂˘.ListIndex = 0    '»± °–¬‘ˆ≤°»Àµƒ“Ω÷ˆ
    Else    '–ﬁ∏ƒ
        cbo”§∂˘.ListIndex = mint”§∂˘
    End If
    cbo”§∂˘.Tag = cbo”§∂˘.ListIndex

    '∂¡»°≤¢œ‘ æ≤°»À“Ω÷ˆ
    Call ReLoadAdvice(mlng“Ω÷ˆID)

    '¥¶¿ÌøÏΩ› ‰»Î¥∞ÃÂ
        If mblnModal = False Then
        Set mfrmShortCut = New frmClinicShortCut
        mfrmShortCut.ShowMe Me, mint≥°∫œ, 1, 0, mlng≤°»Àø∆ “id, True    '∏˘æ›…œ¥Œ…œ∑Òœ‘ æ
        End If
    vsDiag.AllowUserResizing = flexResizeNone

    If mblnStaKB Then
        On Error Resume Next
        Set mobjKeyBoard = Nothing
        Set mobjKeyBoard = CreateObject("zlScreenKeyboard.clsKeyBoard")
        err.Clear: On Error GoTo 0
        If Not mobjKeyBoard Is Nothing Then
            Call mobjKeyBoard.StartUp
        Else
            stbThis.Panels("KB").Visible = False
            MsgBox "∆¡ƒªº¸≈Ã≤øº˛Œ¥ƒ‹’˝»∑∞≤◊∞£¨≤ªƒ‹ π”√£°", vbInformation, gstrSysName
        End If
    End If
    stbThis.Visible = True
End Sub

Private Function TheStockCheck(ByVal lngø‚∑øID As Long, ByVal str¿‡± As String) As Integer
'π¶ƒ‹£∫ªÒ»°÷∏∂®ø‚∑øµƒ≥ˆø‚ø‚¥ÊºÏ≤È∑Ω Ω
    Dim intStyle As Integer
    
    On Error Resume Next
    If InStr(",5,6,7,", str¿‡±) > 0 Then
        intStyle = mcolStock1("_" & lngø‚∑øID)
    ElseIf str¿‡± = "4" Then
        intStyle = mcolStock2("_" & lngø‚∑øID)
    End If
    err.Clear: On Error GoTo 0
    TheStockCheck = intStyle
End Function

Private Sub ReLoadAdvice(Optional ByVal lng“Ω÷ˆID As Long)
'π¶ƒ‹£∫÷ÿ–¬∂¡»°≤¢œ‘ æ≤°»Àµƒµ±«∞“Ω÷ˆ«Âµ•
'≤Œ ˝£∫lng“Ω÷ˆID=”√”⁄∂®Œª
    Dim lngRow As Long
    
    If LoadAdvice Then
        'œ‘ æπÿ¡™“Ω÷ˆ±Í ∂
        Call ShowDiagFlag(vsDiag.Row)
    
        'œ‘ æø…º˚µƒ“Ω÷ˆ
        Call ShowAdvice
        
        If lng“Ω÷ˆID = 0 Then
            If vsAdvice.RowData(vsAdvice.Row) <> 0 Then
                cbsMain.FindControl(, conMenu_New, True, True).Execute
            End If
        Else
            '–ﬁ∏ƒµƒ“Ω÷ˆID”¶∏√ «œ‘ æ––
            lngRow = vsAdvice.FindRow(lng“Ω÷ˆID)
            If lngRow <> -1 Then
                If Not vsAdvice.RowHidden(lngRow) Then
                    mblnRowChange = False
                    vsAdvice.Col = col_“Ω÷ˆƒ⁄»›: vsAdvice.Row = lngRow
                    Call vsAdvice.ShowCell(vsAdvice.Row, vsAdvice.Col)
                    mblnRowChange = True
                End If
            End If
        End If
        'Ω¯»Î ±∆¡±Œ¡ÀShowAdvice÷–µƒµ˜”√,«ø––Ω¯»Î
        Call vsAdvice_AfterRowColChange(-1, -1, vsAdvice.Row, vsAdvice.Col)
    End If
End Sub

Private Function ReadEnjoin() As Boolean
'π¶ƒ‹£∫∂¡»°≤¢º”»Î≥£”√µŒÀŸ
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String, strPre As String
        
    On Error GoTo errH
    
    '≥£”√µŒÀŸ
    strPre = cboµŒÀŸ.Text 'º”»Î∫Û±£≥÷‘≠”–÷µ
    Call Load ‰“∫µŒÀŸ(cboµŒÀŸ, lblµŒÀŸµ•Œª, False)
    cboµŒÀŸ.Text = strPre
    
    ReadEnjoin = True
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Sub Form_Resize()
    On Error Resume Next
    
    If dtpDate.Visible Then
        dtpDate.Visible = False
        dtpDate.Tag = ""
    End If
    
    If mbln¿©’π“≥«© Then
        tbcSub.Move 0, 0, Me.ScaleWidth, Me.ScaleHeight
    Else
        picSub.Move 0, 0, Me.ScaleWidth, Me.ScaleHeight
    End If
    
    If Me.WindowState = vbMinimized Then Exit Sub
    
    Call cbsMain_Resize
    
    'Pass
    cmdAlley.Left = Me.ScaleWidth - cmdAlley.Width - 2 * Screen.TwipsPerPixelX
    cbo”§∂˘.Left = Me.ScaleWidth - IIF(cmdAlley.Visible, cmdAlley.Width + 30, 0) - cbo”§∂˘.Width - 2 * Screen.TwipsPerPixelX
    lbl”§∂˘.Left = cbo”§∂˘.Left - lbl”§∂˘.Width - 2 * Screen.TwipsPerPixelX
    
    If cmdAlley.Visible Or lbl”§∂˘.Visible Then
        lblPati.Width = IIF(lbl”§∂˘.Visible, lbl”§∂˘.Left, cmdAlley.Left) - lblPati.Left - 6 * Screen.TwipsPerPixelX
    End If
End Sub

Private Sub Form_Unload(Cancel As Integer)
    Dim i As Long
    
    mdatπ“∫≈ ±º‰ = Empty
    msngÃÏ ˝ = 0
    
    Set mobjVBA = Nothing
    Set mobjScript = Nothing
    Set mrsDefine = Nothing
    Set mrsDrugScale = Nothing
    Set mfrmSend = Nothing
    Set mrsPrice = Nothing
    Set mobjKeyBoard = Nothing
    Set mclsMipModule = Nothing
    'º∆º€√Ê∞Â◊¥Ã¨
    If Not mfrmPrice Is Nothing Then
        Unload mfrmPrice
        Set mfrmPrice = Nothing
        Call zlDatabase.SetPara("œ‘ æ“Ω÷ˆº∆º€√Ê∞Â", IIF(Val(stbThis.Panels("Price").Tag) <> 0, 1, 0), glngSys, p√≈’Ô“Ω÷ˆœ¬¥Ô, InStr(GetInsidePrivs(p√≈’Ô“Ω÷ˆœ¬¥Ô), ";“Ω÷ˆ—°œÓ…Ë÷√;") > 0)
    End If
    
    If mbln¿©’π“≥«© Then
        For i = 1 To mcolSubForm.Count
            Unload mcolSubForm(i)
        Next
        Set mcolSubForm = Nothing
    End If
    
    If mblnPass Then
        Call gobjPass.zlPassClearLight(mobjPassMap)
        Set mobjPassMap = Nothing
    End If
     
    Call zlDatabase.SetPara("√≈’Ô’Ô∂œ ‰»Î", IIF(opt’Ô∂œ(0).value, 0, 1), glngSys, p√≈’Ô“Ω…˙’æ, InStr(GetInsidePrivs(p√≈’Ô“Ω…˙’æ), ";≤Œ ˝…Ë÷√;") > 0)
    Call SaveWinState(Me, App.ProductName)
    mblnNoSave = False
    RaiseEvent FormUnload(Cancel)
    Set mrs’Ô∂œ = Nothing
    mlngŒ£º±÷µID = 0
End Sub

Private Function RowCanMerge(ByVal lngRow1 As Long, ByVal lngRow2 As Long, Optional strMsg As String) As Boolean
'π¶ƒ‹£∫≈–∂œ¡Ω–– «∑Òø…“‘“ª≤¢∏¯“©
'≤Œ ˝£∫lngRow1=«∞√Ê“ªÃı“—æ≠ ‰»Îµƒ“©∆∑––
'      lngRow2=µ±«∞––(“— ‰»ÎªÚŒ¥ ‰»Î)
'∑µªÿ£∫»Áπ˚≤ªø…“‘£¨‘ÚstrMsg∑µªÿÃ· æ–≈œ¢
    Dim lngFind As Long, lngRxCount As Long
    Dim lng≈‰÷∆÷––ƒ As Long, str“©∑øIDs As String
    
    With vsAdvice
        strMsg = ""
        If Not Between(lngRow1, .FixedRows, .Rows - 1) Then Exit Function
        If Not Between(lngRow2, .FixedRows, .Rows - 1) Then Exit Function
        If .RowHidden(lngRow1) Or .RowHidden(lngRow2) Then Exit Function
        If .RowData(lngRow1) = 0 Then Exit Function
        
        If .RowData(lngRow2) = 0 Then
            '±ÿ–Î»´≤øŒ™≥…“©«“¿‡±œ‡Õ¨
            If InStr(",5,6,", .TextMatrix(lngRow1, COL_¿‡±)) = 0 Then
                strMsg = "“ª≤¢∏¯“©µƒ“©∆∑±ÿ–Î∂ºŒ™Œ˜≥…“©ªÚ∂ºŒ™÷–≥…“©°£"
                Exit Function
            End If
            
            '≤ªƒ‹∞¸∫¨“—∑¢ÀÕµƒ“Ω÷ˆ
            If Val(.TextMatrix(lngRow1, COL_◊¥Ã¨)) <> 1 Then
                strMsg = "“™…Ë÷√Œ™“ª≤¢∏¯“©µƒ“©∆∑∞¸∫¨“—æ≠∑¢ÀÕµƒ“Ω÷ˆ°£"
                Exit Function
            End If
            '≤ªƒ‹∞¸∫¨“—«©√˚µƒ“Ω÷ˆ
            If Val(.TextMatrix(lngRow1, COL_«©√˚∑Ò)) = 1 Then
                strMsg = "“™…Ë÷√Œ™“ª≤¢∏¯“©µƒ“©∆∑∞¸∫¨“—æ≠«©√˚µƒ“Ω÷ˆ°£"
                Exit Function
            End If
        ElseIf .RowData(lngRow2) <> 0 Then
            If InStr(",5,6,", .TextMatrix(lngRow1, COL_¿‡±)) = 0 _
                Or InStr(",5,6,", .TextMatrix(lngRow2, COL_¿‡±)) = 0 Then
                strMsg = "“ª≤¢∏¯“©µƒ“©∆∑±ÿ–Î∂ºŒ™Œ˜≥…“©ªÚ∂ºŒ™÷–≥…“©°£"
                Exit Function
            End If
            
            '≤ªƒ‹∞¸∫¨“—∑¢ÀÕµƒ“Ω÷ˆ
            If Val(.TextMatrix(lngRow1, COL_◊¥Ã¨)) <> 1 Or Val(.TextMatrix(lngRow2, COL_◊¥Ã¨)) <> 1 Then
                strMsg = "“™…Ë÷√Œ™“ª≤¢∏¯“©µƒ“©∆∑∞¸∫¨“—æ≠∑¢ÀÕµƒ“Ω÷ˆ°£"
                Exit Function
            End If
            '≤ªƒ‹∞¸∫¨“—«©√˚µƒ“Ω÷ˆ
            If Val(.TextMatrix(lngRow1, COL_«©√˚∑Ò)) = 1 Or Val(.TextMatrix(lngRow2, COL_«©√˚∑Ò)) = 1 Then
                strMsg = "“™…Ë÷√Œ™“ª≤¢∏¯“©µƒ“©∆∑∞¸∫¨“—æ≠«©√˚µƒ“Ω÷ˆ°£"
                Exit Function
            End If
            
            '“ª≤¢∏¯“©(«∞√Ê“©∆∑)µƒ∏¯“©Õææ∂ «∑Ò  ”√”⁄µ±«∞“©∆∑
            lngFind = .FindRow(CLng(.TextMatrix(lngRow1, COL_œ‡πÿID)), lngRow1 + 1)
            If lngFind <> -1 Then
                If Not Check  ”√”√∑®(Val(.TextMatrix(lngFind, COL_’Ô¡∆œÓƒøID)), Val(.TextMatrix(lngRow2, COL_’Ô¡∆œÓƒøID)), 1) Then
                    strMsg = """" & .TextMatrix(lngRow2, col_“Ω÷ˆƒ⁄»›) & """≤ªƒ‹ π”√""" & .TextMatrix(lngFind, col_“Ω÷ˆƒ⁄»›) & """∏¯“©Õææ∂£¨" & _
                    vbCrLf & "≤ªƒ‹”Î""" & .TextMatrix(lngRow1, col_“Ω÷ˆƒ⁄»›) & """…Ë÷√Œ™“ª≤¢∏¯“©°£"
                    Exit Function
                End If
            End If
            
            'ºÏ≤È»Áπ˚”–≈‰÷∆÷––ƒ£¨ «∑Ò∂ºø…“‘¥Ê¥¢£¨◊‘±∏“©≤ªπ‹À¸
            If Not (Val(.TextMatrix(lngRow1, COL_÷¥––ø∆ “ID)) = 0 And Val(.TextMatrix(lngRow1, COL_÷¥–––‘÷ )) = 5) Then
                If Have≤ø√≈–‘÷ (Val(.TextMatrix(lngRow1, COL_÷¥––ø∆ “ID)), "≈‰÷∆÷––ƒ") Then
                    lng≈‰÷∆÷––ƒ = Val(.TextMatrix(lngRow1, COL_÷¥––ø∆ “ID))
                End If
            End If
            If lng≈‰÷∆÷––ƒ = 0 Then
                If Not (Val(.TextMatrix(lngRow2, COL_÷¥––ø∆ “ID)) = 0 And Val(.TextMatrix(lngRow2, COL_÷¥–––‘÷ )) = 5) Then
                    If Have≤ø√≈–‘÷ (Val(.TextMatrix(lngRow2, COL_÷¥––ø∆ “ID)), "≈‰÷∆÷––ƒ") Then
                        lng≈‰÷∆÷––ƒ = Val(.TextMatrix(lngRow2, COL_÷¥––ø∆ “ID))
                    End If
                End If
            End If
            If lng≈‰÷∆÷––ƒ <> 0 Then
                If Not (Val(.TextMatrix(lngRow1, COL_÷¥––ø∆ “ID)) = 0 And Val(.TextMatrix(lngRow1, COL_÷¥–––‘÷ )) = 5) Then
                    str“©∑øIDs = Getø…”√“©∑øIDs(.TextMatrix(lngRow1, COL_¿‡±), Val(.TextMatrix(lngRow1, COL_’Ô¡∆œÓƒøID)), Val(.TextMatrix(lngRow1, COL_ ’∑—œ∏ƒøID)), mlng≤°»Àø∆ “id, 1)
                    If InStr("," & str“©∑øIDs & ",", "," & lng≈‰÷∆÷––ƒ & ",") = 0 Then
                        strMsg = "“©∆∑""" & .TextMatrix(lngRow1, col_“Ω÷ˆƒ⁄»›) & """‘⁄≈‰÷∆÷––ƒ""" & Get≤ø√≈√˚≥∆(lng≈‰÷∆÷––ƒ) & """√ª”–¥Ê¥¢°£"
                        Exit Function
                    End If
                End If
                If Not (Val(.TextMatrix(lngRow2, COL_÷¥––ø∆ “ID)) = 0 And Val(.TextMatrix(lngRow2, COL_÷¥–––‘÷ )) = 5) Then
                    str“©∑øIDs = Getø…”√“©∑øIDs(.TextMatrix(lngRow2, COL_¿‡±), Val(.TextMatrix(lngRow2, COL_’Ô¡∆œÓƒøID)), Val(.TextMatrix(lngRow2, COL_ ’∑—œ∏ƒøID)), mlng≤°»Àø∆ “id, 1)
                    If InStr("," & str“©∑øIDs & ",", "," & lng≈‰÷∆÷––ƒ & ",") = 0 Then
                        strMsg = "“©∆∑""" & .TextMatrix(lngRow2, col_“Ω÷ˆƒ⁄»›) & """‘⁄≈‰÷∆÷––ƒ""" & Get≤ø√≈√˚≥∆(lng≈‰÷∆÷––ƒ) & """√ª”–¥Ê¥¢°£"
                        Exit Function
                    End If
                End If
            End If
        End If
        
        'ºÏ≤È¥¶∑Ω“©∆∑÷÷ ˝œﬁ÷∆
        If gintRXCount > 0 Then
            lngFind = .FindRow(.TextMatrix(lngRow1, COL_œ‡πÿID), , COL_œ‡πÿID)
            lngRxCount = GetMergeCount(vsAdvice, lngFind, COL_œ‡πÿID, COL_ ’∑—œ∏ƒøID)
            If lngRxCount >= gintRXCount Then
                strMsg = "“ª≤¢∏¯“©µƒ“©∆∑÷÷ ˝ " & lngRxCount & " ÷÷“—¥ÔµΩªÚ≥¨π˝“©∆∑¥¶∑Ω◊Ó∂‡‘ –Ìµƒ÷÷ ˝ " & gintRXCount & " ÷÷°£"
                Exit Function
            End If
        End If
    End With
    RowCanMerge = True
End Function

Private Sub cbsMain_Execute(ByVal Control As XtremeCommandBars.ICommandBarControl)
    Dim lng“Ω÷ˆID As Long, lngœ‡πÿID As Long
    Dim str¿‡± As String, lngTmp As Long
    Dim lngBegin As Long, lngEnd As Long
    Dim lngPreRow As Long, strMsg As String
    Dim lng’Ô¡∆œÓƒøID As Long, i As Long, j As Long
    Dim lngDiag As Long, lngSeek As Long
    Dim intLoop As Integer
    Dim blnTag As Boolean
    
    Dim lng≤°»ÀID As Long, strπ“∫≈µ• As String, blnMoved As Boolean
    
    Call AdviceChange '«ø÷∆∏¸–¬“Ω÷ˆƒ⁄»›
    
    With vsAdvice
        Select Case Control.ID
            Case conMenu_New
                If .RowData(.Row) = 0 Then
'                    If .Row <> .Rows - 1 Then
'                        MsgBox "µ±«∞––Œﬁƒ⁄»›£¨«Îœ»‘⁄µ±«∞––¬º»Î”––ß“Ω÷ˆªÚ…æ≥˝µ±«∞––°£", vbInformation, gstrSysName
'                    Else
'                        MsgBox "µ±«∞––Œﬁƒ⁄»›£¨«Îœ»‘⁄µ±«∞––¬º»Î”––ß“Ω÷ˆ°£", vbInformation, gstrSysName
'                    End If
'                    Exit Sub
                ElseIf .RowData(.Rows - 1) = 0 Then
                    .Row = .Rows - 1
                Else
                    'œ»…æ≥˝÷–º‰º‰∏Ùµƒø’––
                    mblnRowChange = False
                    For i = .Rows - 1 To .FixedRows Step -1
                        If .RowData(i) = 0 Then .RemoveItem i
                    Next
                    mblnRowChange = True
                    
                    .AddItem "", .Rows
                    .Row = .Rows - 1
                    .Col = .FixedCols
                End If
                Call .ShowCell(.Row, .Col)
                If Visible And txt“Ω÷ˆƒ⁄»›.Enabled Then txt“Ω÷ˆƒ⁄»›.SetFocus
            Case conMenu_Insert
                If .RowData(.Row) = 0 Then
                    MsgBox "µ±«∞––Œﬁƒ⁄»›£¨«Îœ»‘⁄µ±«∞––¬º»Î”––ß“Ω÷ˆ°£", vbInformation, gstrSysName
                    Exit Sub
                End If
                            
                lngPreRow = GetPreRow(.Row)
                            
                '≤Â»Î∫Û≥…◊‘∂Ø≥…Œ™“ª≤¢∏¯“©:≤Â»Î‘⁄“ª≤¢∏¯“©µƒ÷–º‰≤≈––
                If lngPreRow <> -1 Then
                    If Val(.TextMatrix(lngPreRow, COL_œ‡πÿID)) = Val(.TextMatrix(.Row, COL_œ‡πÿID)) _
                        And Val(.TextMatrix(lngPreRow, COL_œ‡πÿID)) <> 0 And InStr(",5,6,", .TextMatrix(.Row, COL_¿‡±)) > 0 Then
                        
                        '≤ªƒ‹‘⁄“—∑¢ÀÕµƒ“ª≤¢∏¯“©÷–≤Â»Î
                        If Val(.TextMatrix(.Row, COL_◊¥Ã¨)) <> 1 Then
                            MsgBox "∏√◊È“ª≤¢∏¯“©µƒ“Ω÷ˆ“—æ≠∑¢ÀÕ£¨≤ªƒ‹‘Ÿ≤Â»Î°£", vbInformation, gstrSysName
                            Exit Sub
                        End If
                        '≤ªƒ‹‘⁄“—«©√˚µƒ“ª≤¢∏¯“©÷–≤Â»Î
                        If Val(.TextMatrix(.Row, COL_«©√˚∑Ò)) = 1 Then
                            MsgBox "∏√◊È“ª≤¢∏¯“©µƒ“Ω÷ˆ“—æ≠«©√˚£¨≤ªƒ‹‘Ÿ≤Â»Î°£", vbInformation, gstrSysName
                            Exit Sub
                        End If
                        
                        lngœ‡πÿID = Val(.TextMatrix(lngPreRow, COL_œ‡πÿID))
                    End If
                End If
                
                'œ»…æ≥˝÷–º‰º‰∏Ùµƒø’––
                mblnRowChange = False
                lng“Ω÷ˆID = .RowData(.Row)
                For i = .Rows - 1 To .FixedRows Step -1
                    If .RowData(i) = 0 Then .RemoveItem i
                Next
                .Row = .FindRow(lng“Ω÷ˆID)
                mblnRowChange = True
                            
                'µ±«∞––÷Æ«∞≤Â»Î–¬––
                '--------------------------------------------------------------
                If RowIn≈‰∑Ω––(.Row) Or RowInºÏ—È––(.Row) Then
                    '÷–“©≈‰∑Ωº∞ºÏ—È◊È∫œ–– ««∞√Êµƒ––“˛≤ÿ
                    lngBegin = .FindRow(CStr(.RowData(.Row)), , COL_œ‡πÿID)
                Else
                    lngBegin = .Row
                End If
                
                mblnRowChange = False
                .AddItem "", lngBegin
                .Row = lngBegin
                .Col = .FixedCols
                mblnRowChange = True
                Call vsAdvice_AfterRowColChange(-1, .Col, .Row, .Col)
                Call .ShowCell(.Row, .Col)
                
                txt“Ω÷ˆƒ⁄»›.SetFocus 'œ»∂®Œª±‹√‚π‚±ÍªŒ
                        Case conMenu_Edit_ViewDrugExplain '≤Èø¥“©∆∑Àµ√˜ È
                Call FuncViewDrugExplain(Val(vsAdvice.TextMatrix(vsAdvice.Row, COL_ ’∑—œ∏ƒøID)), Me)
            Case conMenu_Merge '“ª≤¢∏¯“©
                If Not Control.Checked Then 'œÎ∞¥œ¬
                    lngBegin = GetPreRow(.Row)
                    '«∞√Ê√ª”–––
                    If lngBegin = -1 Then
                        MsgBox "«∞√Ê√ª”–ø…“‘“ª≤¢∏¯“©µƒ“Ω÷ˆ––°£", vbInformation, gstrSysName
                        Exit Sub
                    End If
                    '¡Ω––≤ª∑˚∫œÃıº˛
                    If Not RowCanMerge(lngBegin, .Row, strMsg) Then
                        MsgBox strMsg, vbInformation, gstrSysName
                        Exit Sub
                    End If
                    If .RowData(.Row) = 0 Then
                        'µ±«∞––…–Œ¥ ‰»Îƒ⁄»›µƒ«Èøˆ
                        If DateDiff("n", CDate(.Cell(flexcpData, lngBegin, COL_ø™ º ±º‰)), zlDatabase.Currentdate) <= gint√≈’Ô–¬ø™“Ω÷ˆº‰∏Ù Then
                            txtø™ º ±º‰.Text = .Cell(flexcpData, lngBegin, COL_ø™ º ±º‰)
                        End If
                        mblnRowMerge = True: cbsMain.RecalcLayout '*‘ –Ì∞¥œ¬
                        txt“Ω÷ˆƒ⁄»›.SetFocus: Exit Sub
                    Else
                        '“™∞—µ±«∞––”Î«∞√Ê––“ª∆“ª≤¢∏¯“©
                        Call MergeRow(lngBegin, .Row, False)
                        Call ReSetColor(.Row) '“ª≤¢÷Æ∫Û‘Ÿ“ª≤¢…Ë÷√
                    End If
                Else 'œÎµØ∆
                    If .RowData(.Row) = 0 Then
                        'µ±«∞––…–Œ¥ ‰»Îƒ⁄»›µƒ«Èøˆ
                        If Not RowIn“ª≤¢∏¯“©(.Row) Then
                            mblnRowMerge = False '*‘ –ÌµØ∆
                            cbsMain.RecalcLayout
                        End If
                        Exit Sub
                    Else
                        'µ±«∞–– «“ª≤¢∏¯“©÷–µƒ––
                        Call Get“ª≤¢∏¯“©∑∂Œß(Val(.TextMatrix(.Row, COL_œ‡πÿID)), lngBegin, lngEnd)
                                                
                        'œ»≈–∂œø…∑Ò»°œ˚“ª≤¢∏¯“©
                        '≤ªƒ‹∞¸∫¨“—∑¢ÀÕµƒ“Ω÷ˆ
                        If Val(.TextMatrix(.Row, COL_◊¥Ã¨)) <> 1 Then
                            MsgBox "µ±«∞“Ω÷ˆ“—æ≠∑¢ÀÕ°£", vbInformation, gstrSysName
                            Exit Sub
                        End If
                        '≤ªƒ‹∞¸∫¨“—«©√˚µƒ“Ω÷ˆ
                        If Val(.TextMatrix(.Row, COL_«©√˚∑Ò)) = 1 Then
                            MsgBox "µ±«∞“Ω÷ˆ“—æ≠«©√˚°£", vbInformation, gstrSysName
                            Exit Sub
                        End If
                                                
                        'œ»Ã· æ
                        If Not (.Row = lngEnd And lngEnd - lngBegin > 1) Then
                            '’˚∏ˆ“ª≤¢∏¯“©»°œ˚Œ™µ•∂¿∏¯“©
                            If MsgBox("“™Ω´∏√◊È“ª≤¢∏¯“©µƒ“©∆∑»´≤ø»°œ˚Œ™µ•∂¿∏¯“©¬£ø", vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbNo Then
                                Exit Sub
                            End If
                        End If
                        
                        '…æ≥˝÷–º‰µƒø’––
                        lngTmp = .RowData(.Row)
                        For i = lngEnd To lngBegin Step -1
                            If .RowData(i) = 0 Then
                                .RemoveItem i
                                lngEnd = lngEnd - 1
                            End If
                        Next
                        .Row = .FindRow(lngTmp, lngBegin)
                        
                        'º«¬ºµ±«∞“ª≤¢ ±µƒ’Ô∂œπÿ¡™“‘±„ª÷∏¥
                        lngDiag = AdviceHaveDiag(.Row)
                        lngSeek = .RowData(lngEnd)
                        
                        If .Row = lngEnd And lngEnd - lngBegin > 1 Then
                            '¥”“ª≤¢∏¯“©÷–∑÷¿Î∏√––
                            Call ReSetColor(.Row) '‘⁄»°œ˚÷Æ«∞“ª≤¢…Ë÷√
                            Call SplitRow(.Row)
                        Else
                            '»°œ˚“ª≤¢∏¯“©
                            Call ReSetColor(.Row) '‘⁄»°œ˚÷Æ«∞“ª≤¢…Ë÷√
                            lngTmp = .RowData(.Row) 'º«¬º”√”⁄ª÷∏¥––∂®Œª
                            Call AdviceSetµ•∂¿∏¯“©(lngBegin, lngEnd)
                            .Row = .FindRow(lngTmp)
                        End If
                        
                        '∏˘æ›º«¬ºµƒ’Ô∂œπÿ¡™Ω¯––ª÷∏¥
                        If lngDiag <> -1 Then
                            lngSeek = .FindRow(lngSeek, lngBegin)
                            For i = lngBegin To lngSeek
                                If InStr(",5,6,", .TextMatrix(i, COL_¿‡±)) > 0 _
                                    And Val(.TextMatrix(i, COL_œ‡πÿID)) <> Val(.TextMatrix(i - 1, COL_œ‡πÿID)) _
                                    And Val(.TextMatrix(i, COL_”§∂˘)) = cbo”§∂˘.ListIndex Then
                                    Call SetDiagFlag(i, 1, lngDiag)
                                End If
                            Next
                        End If
                    End If
                End If
                Call vsAdvice_AfterRowColChange(-1, .Col, .Row, .Col)
            Case conMenu_Delete
                If .RowSel <> .Row Then
                    MsgBox "“ª¥Œ÷ªƒ‹…æ≥˝“ªÃı“Ω÷ˆ£¨«Î—°‘Ò“™…æ≥˝µƒ“Ω÷ˆ––°£", vbInformation, gstrSysName
                    Exit Sub
                End If
                If .RowData(.Row) <> 0 Then
                    '“—∑¢ÀÕµƒ“Ω÷ˆ≤ªƒ‹…æ≥˝
                    If Val(.TextMatrix(.Row, COL_◊¥Ã¨)) <> 1 Then
                        MsgBox "∏√Ãı“Ω÷ˆ“—æ≠∑¢ÀÕ£¨≤ªƒ‹…æ≥˝°£", vbInformation, gstrSysName
                        Exit Sub
                    End If
                    '“—«©√˚µƒ“Ω÷ˆ≤ªƒ‹…æ≥˝
                    If Val(.TextMatrix(.Row, COL_«©√˚∑Ò)) = 1 Then
                        MsgBox "∏√Ãı“Ω÷ˆ“—æ≠«©√˚£¨≤ªƒ‹…æ≥˝°£", vbInformation, gstrSysName
                        Exit Sub
                    End If
                    
                    If MsgBox("»∑ µ“™…æ≥˝“Ω÷ˆ""" & .TextMatrix(.Row, col_“Ω÷ˆƒ⁄»›) & """¬£ø", _
                        vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbNo Then Exit Sub
                End If
                
                Call AdviceDelete(.Row) '…æ≥˝µ±«∞––
                Call CalcAdviceMoney 'œ‘ æ–¬ø™“Ω÷ˆΩ∂Ó
                
                vsAdvice.SetFocus
            Case conMenu_Edit_PacsApply, conMenu_Edit_PacsApply * 10# + 1 'ºÏ≤È…Í«Î
                Call AdviceInput…Í«Îµ•(1)
            Case conMenu_Edit_LISApply, conMenu_Edit_LISApply * 10# + 1 'ºÏ—È…Í«Î
                Call AdviceInput…Í«Îµ•(2)
            Case conMenu_Edit_BloodApply, conMenu_Edit_BloodApply * 10# + 1 ' ‰—™…Í«Î
                Call AdviceInput…Í«Îµ•(3)
                        Case conMenu_Edit_ApplyCustom * 100# To conMenu_Edit_ApplyCustom * 101# '◊‘∂®“Â…Í«Îµ•
                FuncApplyCustom 0, Control.Parameter
            Case conMenu_AdvicePay
                Call FuncClinicPay(Me, mlng≤°»ÀID, mstrπ“∫≈µ•)
            Case conMenu_Reference
                If Val(.TextMatrix(.Row, COL_’Ô¡∆œÓƒøID)) <> 0 Then
                    If RowIn≈‰∑Ω––(.Row) Or RowInºÏ—È––(.Row) Then
                        i = .FindRow(CStr(.RowData(.Row)), , COL_œ‡πÿID)
                        If i <> -1 Then
                            lng’Ô¡∆œÓƒøID = Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID))
                        End If
                    Else
                        lng’Ô¡∆œÓƒøID = Val(.TextMatrix(.Row, COL_’Ô¡∆œÓƒøID))
                    End If
                End If
                '’Ô¡∆¥Î ©≤Œøº
                Call frmClinicHelp.ShowMe(IIF(mblnModal, 1, 0), mfrmParent, lng’Ô¡∆œÓƒøID)
            Case conMenu_Copy
                lng≤°»ÀID = mlng≤°»ÀID: strπ“∫≈µ• = mstrπ“∫≈µ•: blnMoved = False
                strMsg = frmAdviceCopy.ShowMe(Me, mMainPrivs, lng≤°»ÀID, strπ“∫≈µ•, blnMoved, False, mlng«∞Ã·ID, , mlng≤°»Àø∆ “id, , , mstr–‘±)
                If strMsg <> "" Then
                    cbsMain.FindControl(, conMenu_New, True, True).Execute
                    Call AdviceSet∏¥÷∆“Ω÷ˆ(lng≤°»ÀID, strπ“∫≈µ•, strMsg, blnMoved)
                End If
            Case conMenu_Scheme, conMenu_Scheme * 10# + 1
                Call frmAdviceScheme.ShowMe(IIF(mlng«∞Ã·ID <> 0, 2, 0), 1, mlng≤°»ÀID, 0, mstrπ“∫≈µ•, cbo”§∂˘.ListIndex, Me)
            Case conMenu_Scheme * 10# + 2
                Call mfrmShortCut.ShowMe(Me, mint≥°∫œ, 1, 0, mlng≤°»Àø∆ “id)
            Case conMenu_Agent
                
                For intLoop = 1 To vsAdvice.Rows - 1
                    If (Val(vsAdvice.TextMatrix(intLoop, COL_◊¥Ã¨)) = 1 And InStr(",¬È◊Ì“©,∂æ–‘“©,æ´…ÒI¿‡,", "," & Trim(vsAdvice.TextMatrix(intLoop, COL_∂æ¿Ì∑÷¿‡)) & ",") > 0) Then
                        blnTag = True: Exit For
                    End If
                Next
                If Not blnTag Then MsgBox "≤°»ÀŒ¥÷¥––µƒ“Ω÷ˆ÷–≤ª¥Ê‘⁄¬È◊Ì“©°¢∂æ–‘“©°¢æ´…ÒI¿‡“©∆∑“Ω÷ˆ£¨≤ª–Ë“™ÃÓ–¥¥˙∞Ï»À–≈œ¢£°", vbInformation, gstrSysName: Exit Sub
                Call GetPatiInfo
                Call frmAgentInfo.ShowMe(Me, mlng≤°»ÀID, mlngπ“∫≈ID, mstr–’√˚, mstr…Ì∑›÷§∫≈, AgentInfo.¥˙∞Ï»À–’√˚, AgentInfo.¥˙∞Ï»À…Ì∑›÷§∫≈)
                Call GetAgentInfo
                Screen.MousePointer = 0
            Case conMenu_Save
                If vsDiag.EditText <> "" Then
                    mblnCancle = False
                    Me.SetFocus
                    If mblnCancle = True Then mblnCancle = False: Exit Sub
                End If
                If Not CheckAdvice Then Exit Sub 'ºÏ≤È÷–¥¶¿Ì¡Àπ‚±Í∂®Œª
                If Not SaveAdvice Then .SetFocus: Exit Sub
            Case conMenu_Send, conMenu_Send * 10# + 1, conMenu_Send * 10# + 2
                '∑¢ÀÕ÷Æ«∞◊‘∂Ø±£¥Ê
                If mblnNoSave Then
                    If Not CheckAdvice Then Exit Sub
                    If Not SaveAdvice Then .SetFocus: Exit Sub
                End If
                If mfrmSend Is Nothing Then Set mfrmSend = New frmOutAdviceSend
                If mfrmSend.ShowMe(Me, mMainPrivs, mlng≤°»ÀID, mstrπ“∫≈µ•, mstr«∞Ã·IDs, _
                    Control.ID = conMenu_Send And Control.Type = xtpControlSplitButtonPopup Or Control.ID = conMenu_Send * 10# + 1, mlng“Ωººø∆ “ID, mint≥°∫œ, mclsMipModule) Then
                    '≤°»À“Ω÷ˆ∑¢ÀÕÕÍ≥…∫Û◊‘∂Øπÿ±’¥∞ÃÂ
                    If mblnAutoClose Then
                        If Not ExistNoSendAdvice(mlng≤°»ÀID, mstrπ“∫≈µ•) Then
                            mblnOK = True: Unload Me: Exit Sub
                        End If
                    End If
                    
                    '÷ÿ–¬∂¡»°œ‘ æ“Ω÷ˆ
                    Call ReLoadAdvice
                    mblnOK = True '«ø––
                    If txt“Ω÷ˆƒ⁄»›.Enabled Then
                        txt“Ω÷ˆƒ⁄»›.SetFocus
                    Else
                        .SetFocus
                    End If
                End If
            Case conMenu_Sign
                Call AdviceSign
            Case conMenu_Help
                ShowHelp App.ProductName, Me.hWnd, Me.Name
            Case conMenu_Exit
                Unload Me
            Case conMenu_DrugScale * 100# + 1 To conMenu_DrugScale * 100# + 99
                With vsAdvice
                    txtµ•¡ø.Text = FormatEx(Val(.TextMatrix(.Row, COL_º¡¡øœµ ˝)) * Val(Control.Parameter), 5)
                    Call zlControl.TxtSelAll(txtµ•¡ø)
                End With
            Case conMenu_Edit_MediAudit * 10# To conMenu_Edit_MediAudit * 10# + 99  'PASS∫œ¿Ì”√“©
                If mblnPass Then
                    Call gobjPass.zlPassCommandBarExe(mobjPassMap, Control.ID - conMenu_Edit_MediAudit * 10#, mblnNoSave)
                End If
            Case conMenu_Tool_PlugIn_Item + 1 To conMenu_Tool_PlugIn_Item + 99 'Õ‚π“π¶ƒ‹÷¥––
                Call ExePlugIn(Control.Parameter)
        End Select
    End With
End Sub

Private Function ExistNoSendAdvice(ByVal lng≤°»ÀID As Long, ByVal strπ“∫≈µ• As String) As Boolean
'π¶ƒ‹£∫ºÏ≤Èµ±«∞≤°»Àµƒ“Ω÷ˆ «∑Ò“—æ≠∑¢ÀÕÕÍ≥…°£
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String
    
    On Error GoTo errH
    
    '∂£÷ˆ°¢√‚ ‘∆§ ‘°¢ª§¿Ìµ»º∂≤ª∑¢ÀÕ
    strSQL = "Select 1 From ≤°»À“Ω÷ˆº«¬º A,’Ô¡∆œÓƒøƒø¬º B" & _
        " Where Nvl(A.∆§ ‘Ω·π˚,'Œﬁ')<>'√‚ ‘' And Not (A.’Ô¡∆¿‡±='H' And B.≤Ÿ◊˜¿‡–Õ='1')" & _
        " And Nvl(A.÷¥–––‘÷ ,0)<>0 And A.ø™ º÷¥–– ±º‰ is Not NULL And A.≤°»À¿¥‘¥<>3" & _
        " And A.’Ô¡∆œÓƒøID=B.ID And A.“Ω÷ˆ◊¥Ã¨=1 And A.≤°»ÀID=[1] And A.π“∫≈µ•=[2] And Rownum=1"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, "ExistNoSendAdvice", lng≤°»ÀID, strπ“∫≈µ•)
    If Not rsTmp.EOF Then ExistNoSendAdvice = True
    
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Sub Get“ª≤¢∏¯“©∑∂Œß(ByVal lngœ‡πÿID As Long, lngBegin As Long, lngEnd As Long)
'π¶ƒ‹£∫∏˘æ›œ‡πÿµƒ∏¯“©Õææ∂“Ω÷ˆID,»∑∂®“ª≤¢∏¯“©µƒ“ª◊È“©∆∑µƒ∆÷π––∫≈
'Àµ√˜£∫÷–º‰ø…ƒ‹∞¸∫¨”–ø’––
    Dim i As Long
    lngBegin = vsAdvice.FindRow(CStr(lngœ‡πÿID), , COL_œ‡πÿID)
    For i = lngBegin To vsAdvice.Rows - 1
        If Not vsAdvice.RowHidden(i) And vsAdvice.RowData(i) <> 0 Then
            If Val(vsAdvice.TextMatrix(i, COL_œ‡πÿID)) = lngœ‡πÿID Then
                lngEnd = i
            Else
                Exit For
            End If
        End If
    Next
End Sub

Private Sub txtµ•¡ø_Change()
    With vsAdvice
        If .RowData(.Row) <> 0 Then
            If Val(.TextMatrix(.Row, COL_µ•¡ø)) <> Val(txtµ•¡ø.Text) Then
                txtµ•¡ø.Tag = "1"
            End If
        Else
            txtµ•¡ø.Tag = "1"
        End If
    End With
    
End Sub

Private Sub txtµ•¡ø_GotFocus()
    zlControl.TxtSelAll txtµ•¡ø
End Sub

Private Sub txtµ•¡ø_KeyPress(KeyAscii As Integer)
    Dim blnCancel As Boolean

    If KeyAscii = 13 Then
        KeyAscii = 0
        If IsNumeric(txtµ•¡ø.Text) And Val(txtµ•¡ø.Text) > 0 _
            Or txtµ•¡ø.Text = "" And (Not mblnµ•¡ø Or InStr(",5,6,", vsAdvice.TextMatrix(vsAdvice.Row, COL_¿‡±)) = 0) Then
            Call txtµ•¡ø_Validate(blnCancel)
            If Not blnCancel Then mblnReturn = True: Call SeekNextControl
        End If
    Else
        If InStr("0123456789." & Chr(8), Chr(KeyAscii)) = 0 Then KeyAscii = 0
    End If
End Sub

Private Sub txtµ•¡ø_Validate(Cancel As Boolean)
    Dim strMsg As String, dbl¥Œ ˝ As Double, sngÃÏ ˝ As Single
    Dim lngFind As Long, blnDo As Boolean
    Dim sng◊‹¡ø As Single
    
    With vsAdvice
        If Val(txtµ•¡ø.Text) = 0 Then txtµ•¡ø.Text = ""
        If mblnReturn Then mblnReturn = False: Exit Sub
        If Not IsNumeric(txtµ•¡ø.Text) Then
            If txtµ•¡ø.Text <> "" Then
                Cancel = True: txtµ•¡ø_GotFocus: Exit Sub
            ElseIf txtµ•¡ø.Text = "" And mblnµ•¡ø And InStr(",5,6,", vsAdvice.TextMatrix(vsAdvice.Row, COL_¿‡±)) > 0 Then
                Cancel = True: txtµ•¡ø_GotFocus: Exit Sub
            End If
        ElseIf CDbl(txtµ•¡ø.Text) <= 0 Then
            Cancel = True: txtµ•¡ø_GotFocus: Exit Sub
        ElseIf CDbl(txtµ•¡ø.Text) > LONG_MAX Then
            Cancel = True: txtµ•¡ø_GotFocus: Exit Sub
        ElseIf txtµ•¡ø.Text <> "" Then
            'µ•¡ø∫œ∑®–‘ºÏ≤È
            If InStr(",5,6,", .TextMatrix(.Row, COL_¿‡±)) > 0 And Val(.TextMatrix(.Row, COL_ ’∑—œ∏ƒøID)) <> 0 Then
                blnDo = Not txtÃÏ ˝.Visible '∏¯“©∑Ω∑®Œ™∂£÷ˆ£¨ªÚ ‰»ÎÃÏ ˝ ±≤ªºÏ≤È
                If blnDo Then
                    lngFind = .FindRow(CLng(Val(.TextMatrix(.Row, COL_œ‡πÿID))), .Row + 1)
                    If lngFind <> -1 Then blnDo = blnDo And Val(.TextMatrix(lngFind, COL_÷¥–––‘÷ )) <> 0
                End If
                If blnDo Then
                    dbl¥Œ ˝ = IIF(Val(.TextMatrix(.Row, COL_◊‹¡ø)) = 0, 1, Val(.TextMatrix(.Row, COL_◊‹¡ø))) * _
                        Val(.TextMatrix(.Row, COL_√≈’Ô∞¸◊∞)) * Val(.TextMatrix(.Row, COL_º¡¡øœµ ˝)) / Val(txtµ•¡ø.Text)
                    If dbl¥Œ ˝ > 200 Then
                        If MsgBox("∏√“©∆∑∞¥√ø¥Œ " & FormatEx(txtµ•¡ø.Text, 5) & .TextMatrix(.Row, COL_µ•¡øµ•Œª) & "  π”√£¨" & _
                            IIF(Val(.TextMatrix(.Row, COL_◊‹¡ø)) = 0, "√ø", Val(.TextMatrix(.Row, COL_◊‹¡ø))) & _
                            .TextMatrix(.Row, COL_√≈’Ôµ•Œª) & "ø…“‘ π”√ " & FormatEx(dbl¥Œ ˝, 5) & " ¥Œ°£" & _
                            vbCrLf & vbCrLf & "ƒ„»∑»œµ•¡ø ‰»Î’˝»∑¬£ø", vbQuestion + vbYesNo + vbDefaultButton1, gstrSysName) = vbNo Then
                            Cancel = True: txtµ•¡ø_GotFocus: Exit Sub
                        End If
                    End If
                End If
            End If
            
            txtµ•¡ø.Text = FormatEx(txtµ•¡ø.Text, 5)
            
            '÷ÿ–¬º∆À„“©∆∑◊‹¡ø(œ» ‰»Îµ•¡ø ±)
            If InStr(",5,6,", .TextMatrix(.Row, COL_¿‡±)) > 0 Then
                If mblnÃÏ ˝ Then
                    If mblnÃÏ ˝∑¥À„ Then
                        If Val(txt◊‹¡ø.Text) <> 0 Then
                            'ø™ º∑¥À„ÃÏ ˝
                            '≤ª ‰ÃÏ ˝ ±£¨∏˘æ›◊‹¡ø°¢µ•¡ø°¢∆µ¬ º∆À„ÃÏ ˝£¨ºÏ≤È «∑Ò≥¨∆⁄
                            If Val(txt◊‹¡ø.Text) <> 0 And Val(txtµ•¡ø.Text) <> 0 <> 0 _
                                And .TextMatrix(.Row, COL_∆µ¬ ) <> "" And Val(.TextMatrix(.Row, COL_∆µ¬ ¥Œ ˝)) <> 0 And Val(.TextMatrix(.Row, COL_∆µ¬ º‰∏Ù)) <> 0 _
                                And Val(.TextMatrix(.Row, COL_º¡¡øœµ ˝)) <> 0 And Val(.TextMatrix(.Row, COL_√≈’Ô∞¸◊∞)) <> 0 Then
                                
                                sngÃÏ ˝ = Calc»± °“©∆∑ÃÏ ˝(Val(txt◊‹¡ø.Text), Val(txtµ•¡ø.Text), _
                                    Val(.TextMatrix(.Row, COL_∆µ¬ ¥Œ ˝)), Val(.TextMatrix(.Row, COL_∆µ¬ º‰∏Ù)), .TextMatrix(.Row, COL_º‰∏Ùµ•Œª), _
                                    Val(.TextMatrix(.Row, COL_º¡¡øœµ ˝)), Val(.TextMatrix(.Row, COL_√≈’Ô∞¸◊∞)), _
                                    Val(.TextMatrix(.Row, COL_ø…∑Ò∑÷¡„)))
                                Call CheckDrugOutOfRange(.Row, sngÃÏ ˝)
                            End If
                        End If
                        If sngÃÏ ˝ = 0 Then sngÃÏ ˝ = 1
                        msngPreÃÏ ˝ = sngÃÏ ˝
                        txtÃÏ ˝.Text = sngÃÏ ˝
                    Else
                        sngÃÏ ˝ = Val(.TextMatrix(.Row, COL_ÃÏ ˝))
                        If sngÃÏ ˝ = 0 Then sngÃÏ ˝ = 1
                        sng◊‹¡ø = Val(txt◊‹¡ø.Text)
                        
                        txt◊‹¡ø.Text = ReGet“©∆∑◊‹¡ø(sng◊‹¡ø, Val(txtµ•¡ø.Text), sngÃÏ ˝, .Row)
                        '“˛ Ωµ˜”√¡ÀChange ¬º˛
                                               
                        Call txt◊‹¡ø_Validate(Cancel)
                        If Cancel Then
                            txt◊‹¡ø.Text = sng◊‹¡ø
                            Exit Sub
                        End If
                    End If
                Else
                    '≤ª ‰ÃÏ ˝ ±£¨∏˘æ›◊‹¡ø°¢µ•¡ø°¢∆µ¬ º∆À„ÃÏ ˝£¨ºÏ≤È «∑Ò≥¨∆⁄
                    If Val(txt◊‹¡ø.Text) <> 0 And Val(txtµ•¡ø.Text) <> 0 <> 0 _
                        And .TextMatrix(.Row, COL_∆µ¬ ) <> "" And Val(.TextMatrix(.Row, COL_∆µ¬ ¥Œ ˝)) <> 0 And Val(.TextMatrix(.Row, COL_∆µ¬ º‰∏Ù)) <> 0 _
                        And Val(.TextMatrix(.Row, COL_º¡¡øœµ ˝)) <> 0 And Val(.TextMatrix(.Row, COL_√≈’Ô∞¸◊∞)) <> 0 Then
                        
                        sngÃÏ ˝ = Calc»± °“©∆∑ÃÏ ˝(Val(txt◊‹¡ø.Text), Val(txtµ•¡ø.Text), _
                            Val(.TextMatrix(.Row, COL_∆µ¬ ¥Œ ˝)), Val(.TextMatrix(.Row, COL_∆µ¬ º‰∏Ù)), .TextMatrix(.Row, COL_º‰∏Ùµ•Œª), _
                            Val(.TextMatrix(.Row, COL_º¡¡øœµ ˝)), Val(.TextMatrix(.Row, COL_√≈’Ô∞¸◊∞)), _
                            Val(.TextMatrix(.Row, COL_ø…∑Ò∑÷¡„)))
                            
                        Call CheckDrugOutOfRange(.Row, sngÃÏ ˝)
                    End If
                End If
            End If
            
            '∏¸–¬ ˝æ›
            Call AdviceChange
        End If
    End With
End Sub

Private Sub txtø™ º ±º‰_Change()
    txtø™ º ±º‰.Tag = "1"
End Sub

Private Sub txtø™ º ±º‰_GotFocus()
    If txtø™ º ±º‰.Text = "" Then txtø™ º ±º‰.Text = GetDefaultTime(vsAdvice.Row)
    zlControl.TxtSelAll txtø™ º ±º‰
End Sub

Private Sub txtø™ º ±º‰_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        KeyAscii = 0
        If txtø™ º ±º‰.Text <> "" Then
            txtø™ º ±º‰.Text = GetFullDate(txtø™ º ±º‰.Text)
            If SeekNextControl Then Call txtø™ º ±º‰_Validate(False)
        End If
    Else
        If InStr("0123456789 /-:" & Chr(8), Chr(KeyAscii)) = 0 Then KeyAscii = 0
    End If
End Sub

Private Sub txtø™ º ±º‰_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)
    If Button = 2 And txtø™ º ±º‰.Locked Then
        glngTXTProc = GetWindowLong(txtø™ º ±º‰.hWnd, GWL_WNDPROC)
        Call SetWindowLong(txtø™ º ±º‰.hWnd, GWL_WNDPROC, AddressOf WndMessage)
    End If
End Sub

Private Sub txtø™ º ±º‰_MouseUp(Button As Integer, Shift As Integer, X As Single, Y As Single)
    If Button = 2 And txtø™ º ±º‰.Locked Then
        Call SetWindowLong(txtø™ º ±º‰.hWnd, GWL_WNDPROC, glngTXTProc)
    End If
End Sub

Private Sub txtø™ º ±º‰_Validate(Cancel As Boolean)
    If txtø™ º ±º‰.Locked Then Exit Sub
        
    If Not IsDate(txtø™ º ±º‰.Text) Then
        If txtø™ º ±º‰.Text <> "" Then
            Cancel = True
            txtø™ º ±º‰_GotFocus
            Exit Sub
        ElseIf vsAdvice.RowData(vsAdvice.Row) <> 0 Then
            If IsDate(vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_ø™ º ±º‰)) Then
                'ª÷∏¥»ÀŒ™µƒ«Â≥˝
                txtø™ º ±º‰.Text = vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_ø™ º ±º‰)
            End If
        End If
    Else
        'ºÏ≤È ±º‰∫œ∑®–‘
        If Not Checkø™ º ±º‰(txtø™ º ±º‰.Text) Then
            Cancel = True
            txtø™ º ±º‰_GotFocus
            Exit Sub
        End If
    End If
    
    '∏¸–¬ ˝æ›
    Call AdviceChange
End Sub

Private Sub cbo“Ω…˙÷ˆÕ–_Change()
    cbo“Ω…˙÷ˆÕ–.Tag = "1"
End Sub

Private Sub cbo“Ω…˙÷ˆÕ–_GotFocus()
    zlControl.TxtSelAll cbo“Ω…˙÷ˆÕ–
    Call zlCommFun.OpenIme(True)
End Sub

Private Sub cbo“Ω…˙÷ˆÕ–_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        KeyAscii = 0
        If cbo“Ω…˙÷ˆÕ–.Text <> "" Then
            If ReasonSelect(cbo“Ω…˙÷ˆÕ–.Text, 2) Then Exit Sub
        End If
        If SeekNextControl Then Call cbo“Ω…˙÷ˆÕ–_Validate(False)
    End If
End Sub

Private Sub cbo“Ω…˙÷ˆÕ–_Validate(Cancel As Boolean)
    If zlCommFun.ActualLen(cbo“Ω…˙÷ˆÕ–.Text) > 100 Then
        MsgBox " ‰»Îƒ⁄»›≤ªπ˝≥¨π˝ 50 ∏ˆ∫∫◊÷ªÚ 100 ∏ˆ◊÷∑˚°£", vbInformation, gstrSysName
        cbo“Ω…˙÷ˆÕ–_GotFocus
        Cancel = True: Exit Sub
    End If
    
    '∏¸–¬ ˝æ›
    Call AdviceChange
End Sub

Private Sub txt“Ω÷ˆƒ⁄»›_DblClick()
    If cmdExt.Visible And cmdExt.Enabled Then cmdExt_Click
End Sub

Private Sub txt“Ω÷ˆƒ⁄»›_GotFocus()
    If txtø™ º ±º‰.Text = "" Then txtø™ º ±º‰_GotFocus
    Call zlControl.TxtSelAll(txt“Ω÷ˆƒ⁄»›)
End Sub

Private Sub txt“Ω÷ˆƒ⁄»›_KeyDown(KeyCode As Integer, Shift As Integer)
    Dim intTmp As Integer
    
    If Shift = vbCtrlMask And KeyCode = vbKeyA Then
        Call zlControl.TxtSelAll(txt“Ω÷ˆƒ⁄»›)
    End If
    If KeyCode = vbKeySpace And txt“Ω÷ˆƒ⁄»›.Text = "" And gblnOut±ÿ”√ Then
        intTmp = ApplySelect
        If intTmp <> 0 Then Call AdviceInput…Í«Îµ•(intTmp)
    End If
End Sub

Private Sub txt“Ω÷ˆƒ⁄»›_KeyPress(KeyAscii As Integer)
    Dim rsTmp As ADODB.Recordset
    Dim rsTmpOther As ADODB.Recordset
    Dim str ‰»Î As String
    Dim blnBarcode As Boolean ' «∑Ò÷√ø’Œ¿≤ƒµƒ ≈˙¥Œ ◊÷∂Œ

    If KeyAscii = 13 Then
        KeyAscii = 0
        If txt“Ω÷ˆƒ⁄»›.Text = "" Then Exit Sub
        If txt“Ω÷ˆƒ⁄»›.Text = vsAdvice.TextMatrix(vsAdvice.Row, col_“Ω÷ˆƒ⁄»›) Then
            Call SeekNextControl
            Exit Sub
        End If
        
        Set rsTmp = frmClinicSelect.ShowSelect(Me, IIF(mlng«∞Ã·ID <> 0, 2, 0), 0, mlng≤°»Àø∆ “id, 1, mstr–‘±, txt“Ω÷ˆƒ⁄»›.Text, txt“Ω÷ˆƒ⁄»›, 1, , mintœ’¿‡)
        If rsTmp Is Nothing Then '»°œ˚ªÚŒﬁ ˝æ›
            'ª÷∏¥‘≠÷µ
            'txt“Ω÷ˆƒ⁄»›.Text = vsAdvice.TextMatrix(vsAdvice.Row, COL_“Ω÷ˆƒ⁄»›)
            zlControl.TxtSelAll txt“Ω÷ˆƒ⁄»›
            txt“Ω÷ˆƒ⁄»›.SetFocus: Exit Sub
        End If
        '–¬œÓƒøµƒ¬º»Î
        '≥…Ã◊œÓƒø÷–»Áπ˚∞¸∫¨≥…“©,‘Ú≤ªƒ‹∞¥πÊ∏Òœ¬“Ω÷ˆ
        
        If Val(rsTmp!¿‡±ID & "") = 4 And rsTmp!≈˙¥Œ & "" <> "" Then
            str ‰»Î = txt“Ω÷ˆƒ⁄»›.Text
            ' π”√Ãı¬Î∆•≈‰µƒπÊ‘Ú£∫1°¢»´ ˝◊÷ªÚ’ﬂ ˝◊÷+◊÷ƒ∏£ª≥§∂»10Œª ˝“‘…œ£ª
            If (Not zlCommFun.IsCharChinese(str ‰»Î)) And Len(str ‰»Î) >= 10 Then
                If InStr("," & rsTmp!±‡¬Î, "," & str ‰»Î) > 0 Then
                    '‘Ú∆•≈‰µƒ «±‡¬Î£¨÷√ø’≈˙¥Œ
                    blnBarcode = True
                End If
            End If
            If IsNumeric(str ‰»Î) Then
                '1X. ‰»Î»´ « ˝◊÷ ±÷ª∆•≈‰±‡¬Î
                If Mid(gstrMatchMode, 1, 1) = "1" Then
                    If Len(str ‰»Î) >= 10 Then
                        If InStr("," & rsTmp!±‡¬Î, "," & str ‰»Î) > 0 Then
                            '‘Ú∆•≈‰µƒ «±‡¬Î£¨÷√ø’≈˙¥Œ
                            blnBarcode = True
                        End If
                    End If
                End If
            ElseIf zlCommFun.IsCharAlpha(str ‰»Î) Then
                'X1. ‰»Î»´ «◊÷ƒ∏ ±÷ª∆•≈‰ºÚ¬Î
                If Mid(gstrMatchMode, 2, 1) = "1" Then
                    If Len(str ‰»Î) >= 10 Then
                        If InStr("," & rsTmp!ºÚ¬Î, "," & str ‰»Î) > 0 Then
                            '‘Ú∆•≈‰µƒ «±‡¬Î£¨÷√ø’≈˙¥Œ
                            blnBarcode = True
                        End If
                    End If
                End If
            End If
        End If
   
        If blnBarcode Then
            Set rsTmpOther = zlDatabase.CopyNewRec(rsTmp)
            rsTmpOther!≈˙¥Œ = Null
            Set rsTmp = Nothing
            Set rsTmp = rsTmpOther
        End If
        
        '∏˘æ›—°‘ÒœÓƒø…Ë÷√»± °“Ω÷ˆ–≈œ¢
        Me.Refresh
        If AdviceInput(rsTmp, vsAdvice.Row) Then
            'œ‘ æ“—»± °…Ë÷√µƒ÷µ
            Call vsAdvice_AfterRowColChange(-1, vsAdvice.Col, vsAdvice.Row, vsAdvice.Col)
                        
            Call CalcAdviceMoney 'œ‘ æ–¬ø™“Ω÷ˆΩ∂Ó
            
            '“Ω±£π‹øÿ µ ±º‡≤‚
            If mintœ’¿‡ <> 0 And Val(vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_EDIT)) = 0 Then
                '◊‹¡ø≤ªø… ‰»Î£∫»± °≤¢πÃ∂®◊‹¡øµƒ“Ω÷ˆ£¨“‘º∞≥§÷ˆ
                '≥…Ã◊“Ω÷ˆ≤ª‘⁄’‚¿ÔºÏ≤È
                If gclsInsure.GetCapability(support µ ±º‡øÿ, mlng≤°»ÀID, mintœ’¿‡) And Not txt◊‹¡ø.Enabled Then
                    If MakePriceRecord(vsAdvice.Row) Then
                        If Not gclsInsure.CheckItem(mintœ’¿‡, 0, 0, mrsPrice) Then
                            Call AdviceCurRowClear: Exit Sub
                        End If
                    End If
                    '±Íº«Œ™“—æ≠◊˜¡ÀºÏ≤È
                    vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_◊¥Ã¨) = 1
                End If
            End If
            
            Call SeekNextControl
        Else
            'ª÷∏¥‘≠÷µ
            'txt“Ω÷ˆƒ⁄»›.Text = vsAdvice.TextMatrix(vsAdvice.Row, COL_“Ω÷ˆƒ⁄»›)
            zlControl.TxtSelAll txt“Ω÷ˆƒ⁄»›
            txt“Ω÷ˆƒ⁄»›.SetFocus: Exit Sub
        End If
    End If
End Sub

Private Sub AdviceCurRowClear()
'π¶ƒ‹£∫«Â≥˝µ±«∞“Ω÷ˆ––µƒƒ⁄»›£¨«Â≥˝∫Ûø…Õ˚∂¯±£¡Ùµ±«∞ ‰»Î––µƒ–¬ ‰»Î◊¥Ã¨
    Dim strø™ º ±º‰ As String
    Dim lngPre As Long
    
    LockWindowUpdate Me.hWnd
    
    'º«¬º÷Æ«∞ª˘±æµƒ ‰»Îƒ⁄»›
    Call GetRowScope(vsAdvice.Row, lngPre, 0)
    strø™ º ±º‰ = txtø™ º ±º‰.Text
    
    '…æ≥˝––
    Call AdviceDelete(vsAdvice.Row)
    
    '‘⁄‘≠Œª÷√≤Â»Î–¬––
    mblnRowChange = False
    vsAdvice.AddItem "", lngPre
    vsAdvice.Row = lngPre: vsAdvice.Col = col_“Ω÷ˆƒ⁄»›
    mblnRowChange = True
    Call vsAdvice_AfterRowColChange(-1, -1, vsAdvice.Row, vsAdvice.Col)
    Call vsAdvice.ShowCell(vsAdvice.Row, vsAdvice.Col)
    
    txtø™ º ±º‰.Text = strø™ º ±º‰
    txt“Ω÷ˆƒ⁄»›.SetFocus
    
    LockWindowUpdate 0
End Sub

Private Sub cbo÷¥–– ±º‰_GotFocus()
    zlControl.TxtSelAll cbo÷¥–– ±º‰
    If vsAdvice.Row < 1 Then Exit Sub
    If vsAdvice.TextMatrix(vsAdvice.Row, COL_º‰∏Ùµ•Œª) = "÷‹" Or vsAdvice.TextMatrix(vsAdvice.Row, COL_º‰∏Ùµ•Œª) = "ÃÏ" Or vsAdvice.TextMatrix(vsAdvice.Row, COL_º‰∏Ùµ•Œª) = "–° ±" Then
        picHelp.Visible = True
    End If
End Sub

Private Sub txt“Ω÷ˆƒ⁄»›_Validate(Cancel As Boolean)
    'ª÷∏¥»ÀŒ™µƒ∏ƒ±‰
    If txt“Ω÷ˆƒ⁄»›.Text <> vsAdvice.TextMatrix(vsAdvice.Row, col_“Ω÷ˆƒ⁄»›) Then
        txt“Ω÷ˆƒ⁄»›.Text = vsAdvice.TextMatrix(vsAdvice.Row, col_“Ω÷ˆƒ⁄»›)
    End If
End Sub

Private Sub txt◊‹¡ø_Change()
    With vsAdvice
        If .RowData(.Row) <> 0 Then
            If Val(.TextMatrix(.Row, COL_◊‹¡ø)) <> Val(txt◊‹¡ø.Text) Then
                txt◊‹¡ø.Tag = "1"
            End If
        Else
            txt◊‹¡ø.Tag = "1"
        End If
    End With
End Sub

Private Sub txt◊‹¡ø_GotFocus()
    zlControl.TxtSelAll txt◊‹¡ø
End Sub

Private Sub txt◊‹¡ø_KeyPress(KeyAscii As Integer)
    Dim strMask As String
    Dim blnCancel As Boolean
    
    If KeyAscii = 13 Then
        KeyAscii = 0
        If IsNumeric(txt◊‹¡ø.Text) Or (txt◊‹¡ø.Text = "" And vsAdvice.TextMatrix(vsAdvice.Row, COL_¿‡±) = "K") Then
            Call txt◊‹¡ø_Validate(blnCancel)
            If Not blnCancel Then mblnReturn = True: Call SeekNextControl
        End If
    Else
        If RowIn≈‰∑Ω––(vsAdvice.Row) Then
            strMask = "0123456789" '÷–“©≈‰∑Ω÷ªƒ‹ ‰»Î’˚ ˝
        ElseIf InStr(",5,6,", vsAdvice.TextMatrix(vsAdvice.Row, COL_¿‡±)) > 0 Then
            If InStr(GetInsidePrivs(p√≈’Ô“Ω÷ˆœ¬¥Ô), "“©∆∑–° ˝ ‰»Î") > 0 _
                And Val(vsAdvice.TextMatrix(vsAdvice.Row, COL_ø…∑Ò∑÷¡„)) = 0 Then
                strMask = "0123456789."
            Else
                strMask = "0123456789"
            End If
        Else
            strMask = "0123456789."
        End If
        If InStr(strMask & Chr(8), Chr(KeyAscii)) = 0 Then KeyAscii = 0
    End If
End Sub

Private Sub txt◊‹¡ø_LostFocus()
    mblnReturn = False
End Sub

Private Sub txt◊‹¡ø_Validate(Cancel As Boolean)
    Dim bln≈‰∑Ω–– As Boolean
    Dim strMsg, strTmp As String
    Dim dbl◊‹¡ø As Double, sngÃÏ ˝ As Single
    Dim blnOutTotal As Boolean '“©∆∑≥¨¡ø
    Dim blnTmp As Boolean
    Dim blnTag As Boolean
 
    With vsAdvice
        If Val(txt◊‹¡ø.Text) = 0 Then txt◊‹¡ø.Text = ""
        If mblnReturn Then mblnReturn = False: Exit Sub
        If Not IsNumeric(txt◊‹¡ø.Text) Then
            If txt◊‹¡ø.Text <> "" Then
                Cancel = True: txt◊‹¡ø_GotFocus: Exit Sub
            ElseIf .RowData(.Row) <> 0 Then
                'ª÷∏¥»ÀŒ™µƒ«Â≥˝£∫ ‰—™¡Ÿ÷ˆ‘ –Ì≤ª ‰»Î◊‹¡ø
                If .TextMatrix(.Row, COL_¿‡±) <> "K" Then
                    If IsNumeric(.TextMatrix(.Row, COL_◊‹¡ø)) Then
                        txt◊‹¡ø.Text = .TextMatrix(.Row, COL_◊‹¡ø)
                    End If
                End If
            End If
        ElseIf CDbl(txt◊‹¡ø.Text) <= 0 Then
            Cancel = True: txt◊‹¡ø_GotFocus: Exit Sub
        ElseIf CDbl(txt◊‹¡ø.Text) > LONG_MAX Then
            Cancel = True: txt◊‹¡ø_GotFocus: Exit Sub
        Else
            txt◊‹¡ø.Text = FormatEx(txt◊‹¡ø.Text, 5)
        End If
        
        bln≈‰∑Ω–– = RowIn≈‰∑Ω––(.Row)
        If IsNumeric(txt◊‹¡ø.Text) Then
            If bln≈‰∑Ω–– Then
                txt◊‹¡ø.Text = CInt(txt◊‹¡ø.Text)
            ElseIf InStr(",5,6,", .TextMatrix(.Row, COL_¿‡±)) > 0 Then
                If InStr(GetInsidePrivs(p√≈’Ô“Ω÷ˆœ¬¥Ô), "“©∆∑–° ˝ ‰»Î") = 0 Then
                    txt◊‹¡ø.Text = IntEx(Val(txt◊‹¡ø.Text))
                ElseIf Val(.TextMatrix(.Row, COL_ø…∑Ò∑÷¡„)) <> 0 Then
                    txt◊‹¡ø.Text = IntEx(Val(txt◊‹¡ø.Text))
                End If
            ElseIf Val(.TextMatrix(.Row, COL_º∆À„∑Ω Ω)) = 3 Then
                'º∆¥ŒœÓƒø◊‹¡øœﬁ÷∆Œ™’˚ ˝°£º∆¥ŒœÓƒø≤ª ‰»Îµ•¡ø,“Ú¥Àµ•¡ø≤ªπ‹
                'txt◊‹¡ø.Text = IntEx(Val(txt◊‹¡ø.Text))
            End If
        End If
        
        'ºÏ≤È◊‹¡øπª∑Ò
        If InStr(",4,5,6,", .TextMatrix(.Row, COL_¿‡±)) > 0 Then
            If .TextMatrix(.Row, COL_∆µ¬ ) <> "" And Val(.TextMatrix(.Row, COL_∆µ¬ ¥Œ ˝)) <> 0 And Val(.TextMatrix(.Row, COL_∆µ¬ º‰∏Ù)) <> 0 _
                And Val(txtµ•¡ø.Text) <> 0 And Val(.TextMatrix(.Row, COL_º¡¡øœµ ˝)) <> 0 And Val(.TextMatrix(.Row, COL_√≈’Ô∞¸◊∞)) <> 0 Then
                
                sngÃÏ ˝ = Val(txtÃÏ ˝.Text)
                If sngÃÏ ˝ = 0 Then sngÃÏ ˝ = 1
                
                dbl◊‹¡ø = FormatEx(Calc»± °“©∆∑◊‹¡ø( _
                    Val(txtµ•¡ø.Text), sngÃÏ ˝, _
                    Val(.TextMatrix(.Row, COL_∆µ¬ ¥Œ ˝)), Val(.TextMatrix(.Row, COL_∆µ¬ º‰∏Ù)), _
                    .TextMatrix(.Row, COL_º‰∏Ùµ•Œª), .TextMatrix(.Row, COL_÷¥–– ±º‰), _
                    Val(.TextMatrix(.Row, COL_º¡¡øœµ ˝)), Val(.TextMatrix(.Row, COL_√≈’Ô∞¸◊∞)), _
                    Val(.TextMatrix(.Row, COL_ø…∑Ò∑÷¡„))), 5)
                    
                If Val(txt◊‹¡ø.Text) < dbl◊‹¡ø Then
                    If MsgBox(.TextMatrix(.Row, COL_√˚≥∆) & "∞¥√ø¥Œ " & _
                        txtµ•¡ø.Text & .TextMatrix(.Row, COL_µ•¡øµ•Œª) & "," & _
                        .TextMatrix(.Row, COL_∆µ¬ ) & IIF(mblnÃÏ ˝ And .TextMatrix(.Row, COL_¿‡±) <> "4", ",”√“© " & sngÃÏ ˝ & " ÃÏ", "") & _
                        "÷¥–– ±,÷¡…Ÿ–Ë“™ " & FormatEx(dbl◊‹¡ø, 5) & .TextMatrix(.Row, COL_◊‹¡øµ•Œª) & ",“™ºÃ–¯¬£ø", _
                        vbQuestion + vbYesNo + vbDefaultButton1, gstrSysName) = vbNo Then
                        Cancel = True: txt◊‹¡ø_GotFocus: Exit Sub
                    End If
                End If
            End If
        End If
        
        'ºÏ≤È¥¶∑Ωœﬁ¡ø
        .TextMatrix(.Row, COL_ «∑Ò≥¨¡ø) = ""
        If InStr(",5,6,", .TextMatrix(.Row, COL_¿‡±)) > 0 And Val(.TextMatrix(.Row, COL_¥¶∑Ωœﬁ¡ø)) <> 0 Then
           dbl◊‹¡ø = Val(txt◊‹¡ø.Text) * Val(.TextMatrix(.Row, COL_√≈’Ô∞¸◊∞)) * Val(.TextMatrix(.Row, COL_º¡¡øœµ ˝))
           If dbl◊‹¡ø > Val(.TextMatrix(.Row, COL_¥¶∑Ωœﬁ¡ø)) And Val(.TextMatrix(.Row, COL_¥¶∑Ωœﬁ¡ø)) > 0 Then
               .TextMatrix(.Row, COL_ «∑Ò≥¨¡ø) = "1"
           End If
    
        ElseIf bln≈‰∑Ω–– Then
            txt◊‹¡ø.Tag = "1" '÷–“©≈‰∑Ω“©∆∑––±ª“˛≤ÿ£¨Õ®π˝µ˜”√AdviceChangeº‰Ω”…ËŒƒ±æøÚø…”√–‘
            blnTmp = CheckCHLimited(.Row, Val(txt◊‹¡ø.Text), blnOutTotal, vsAdvice, COL_œ‡πÿID, COL_’Ô¡∆œÓƒøID, COL_¿‡±, COL_µ•¡ø)
            If blnOutTotal Then .TextMatrix(.Row, COL_ «∑Ò≥¨¡ø) = "1"
            
            'Õ¨ ±ºÏ≤È≤›“©µƒ”√“© «∑Ò≥¨∆⁄
            If Val(txt◊‹¡ø.Text) > IIF(mbytPatiType = 1, conOrdinary, conEmergency) Then
                .TextMatrix(.Row, COL_ «∑Ò≥¨∆⁄) = "1"
            End If
            
        ElseIf InStr(",5,6,7,", .TextMatrix(.Row, COL_¿‡±)) = 0 And Val(.TextMatrix(.Row, COL_¥¶∑Ωœﬁ¡ø)) > 0 Then
            If Val(txt◊‹¡ø.Text) > Val(.TextMatrix(.Row, COL_¥¶∑Ωœﬁ¡ø)) And Val(.TextMatrix(.Row, COL_¥¶∑Ωœﬁ¡ø)) > 0 Then
                .TextMatrix(.Row, COL_ «∑Ò≥¨¡ø) = "1"
            End If
        End If
                
        '◊Ó¥ÛΩ∂ÓÃ· æ
        If gcurMaxMoney > 0 Then
            If .TextMatrix(.Row, COL_µ•º€) = "" Then .TextMatrix(.Row, COL_µ•º€) = GetItemPrice(.Row) '”√""≤ª «¡„
            If Val(.TextMatrix(.Row, COL_µ•º€)) * Val(txt◊‹¡ø.Text) > gcurMaxMoney Then
                If MsgBox("µ±«∞“Ω÷ˆ " & txt◊‹¡ø.Text & lbl◊‹¡øµ•Œª.Caption & " µƒΩ∂Ó¥ÔµΩ¡À£∫" & Format(Val(.TextMatrix(.Row, COL_µ•º€)) * Val(txt◊‹¡ø.Text), "0.00") & "£¨“™ºÃ–¯¬£ø", vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbNo Then
                    Cancel = True: txt◊‹¡ø_GotFocus: Exit Sub
                End If
            End If
        End If
        
        '∑¥À„ÃÏ ˝£®√ª”– ‰»ÎÃÏ ˝≤≈∑¥À„£¨÷–“©≤ªª·œ‘ æÃÏ ˝£©
        If mblnÃÏ ˝∑¥À„ And txt◊‹¡ø.Tag <> "" Then
            If .TextMatrix(.Row, COL_∆µ¬ ) <> "" And Val(.TextMatrix(.Row, COL_∆µ¬ ¥Œ ˝)) <> 0 And Val(.TextMatrix(.Row, COL_∆µ¬ º‰∏Ù)) <> 0 _
                And Val(txtµ•¡ø.Text) <> 0 And Val(.TextMatrix(.Row, COL_∆µ¬ ¥Œ ˝)) <> 0 And Val(.TextMatrix(.Row, COL_∆µ¬ º‰∏Ù)) <> 0 _
                And Val(.TextMatrix(.Row, COL_º¡¡øœµ ˝)) <> 0 And Val(.TextMatrix(.Row, COL_√≈’Ô∞¸◊∞)) <> 0 Then
                
                sngÃÏ ˝ = Calc»± °“©∆∑ÃÏ ˝(Val(txt◊‹¡ø.Text), Val(txtµ•¡ø.Text), _
                    Val(.TextMatrix(.Row, COL_∆µ¬ ¥Œ ˝)), Val(.TextMatrix(.Row, COL_∆µ¬ º‰∏Ù)), .TextMatrix(.Row, COL_º‰∏Ùµ•Œª), _
                    Val(.TextMatrix(.Row, COL_º¡¡øœµ ˝)), Val(.TextMatrix(.Row, COL_√≈’Ô∞¸◊∞)), _
                    Val(.TextMatrix(.Row, COL_ø…∑Ò∑÷¡„)))
                
                Call CheckDrugOutOfRange(.Row, sngÃÏ ˝)
                If sngÃÏ ˝ = 0 Then sngÃÏ ˝ = 1
                msngPreÃÏ ˝ = sngÃÏ ˝
                If sngÃÏ ˝ <> Val(txtÃÏ ˝.Text) Then
                    txtÃÏ ˝.Text = sngÃÏ ˝
                    txtÃÏ ˝.Tag = "1"
                    msngÃÏ ˝ = sngÃÏ ˝
                End If
            End If
        End If
        
        '∏¸–¬ ˝æ›
        blnTag = (txt◊‹¡ø.Tag <> "")
        Call AdviceChange
        '“Ω±£π‹øÿ µ ±º‡≤‚£∫ ◊¥Œ ‰»Î(æ≠π˝)ªÚ’ﬂ∏¸∏ƒ ±ºÏ≤È
        If mintœ’¿‡ <> 0 And (.Cell(flexcpData, .Row, COL_◊¥Ã¨) = 0 Or blnTag) Then
            If gclsInsure.GetCapability(support µ ±º‡øÿ, mlng≤°»ÀID, mintœ’¿‡) Then
                If MakePriceRecord(.Row) Then
                    If Not gclsInsure.CheckItem(mintœ’¿‡, 0, 0, mrsPrice) Then
                        Cancel = True: txt◊‹¡ø_GotFocus: Exit Sub
                    End If
                End If
                '±Íº«Œ™“—æ≠◊˜¡ÀºÏ≤È
                .Cell(flexcpData, .Row, COL_◊¥Ã¨) = 1
            End If
        End If

        Call CalcAdviceMoney 'œ‘ æ–¬ø™“Ω÷ˆΩ∂Ó
        
        '“©∆∑ø‚¥ÊºÏ≤È:÷ªÃ·–—,–ﬁ∏ƒ¡À≤≈Ã·–—
        If InStr(",5,6,", .TextMatrix(.Row, COL_¿‡±)) > 0 Or bln≈‰∑Ω–– _
            Or .TextMatrix(.Row, COL_¿‡±) = "4" And Val(.TextMatrix(.Row, COL_∏˙◊Ÿ‘⁄”√)) = 1 Then
            strMsg = CheckStock(.Row)
            If strMsg <> "" Then MsgBox strMsg, vbInformation, gstrSysName
        End If
        
    End With
End Sub
 
Private Sub ClearAdviceCard()
'π¶ƒ‹£∫«Â≥˝“Ω÷ˆœ‘ æø®∆¨œ‡πÿµƒƒ⁄»›
'≤Œ ˝£∫blnø™ º ±º‰= «∑Ò«Â≥˝ø™ º ±º‰
    Call SetCardEditable(True)
    
    txtø™ º ±º‰.Text = ""
    txt∞≤≈≈ ±º‰.Text = ""
    txt“Ω÷ˆƒ⁄»›.Text = ""
    cbo“Ω…˙÷ˆÕ–.Text = ""
    cbo÷¥––ø∆ “.Clear
    cbo∏Ωº”÷¥––.Clear
    chkΩÙº±.value = 0
    chkΩÙº±.Visible = False ' ‰“Ω÷ˆƒ⁄»›∫Û≤≈ø…”√
    cboµŒÀŸ.Text = ""
    txt≥¨¡øÀµ√˜.Text = ""
    txt”√“©¿Ì”….Text = ""
    
    mblnDoCheck = False
    chkΩÙº±.value = 0
    chkZeroBilling.value = 0
    mblnDoCheck = True
    
    cmdExt.Enabled = False
    Call SetDayState(-1, -1)
    Call SetItemEditable(-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1)
    Call SetStartTime(True)
    
    stbThis.Panels(3).Text = ""
    stbThis.Panels(4).Text = ""
End Sub

Private Sub SetCardEditable(ByVal Editable As Boolean)
'π¶ƒ‹£∫”√—’…´±Í ∂µ±«∞“Ω÷ˆ «∑Òø…“‘±‡º≠
    Dim obj As Object
    
    For Each obj In Controls
        If InStr("Label;TextBox;ComboBox;CheckBox;OptionButton", TypeName(obj)) > 0 Then
            If Not obj.Container Is Nothing Then
                If obj.Container Is fraAdvice Then
                    If Editable Then
                        obj.ForeColor = Me.ForeColor
                    Else
                        obj.ForeColor = &H808080
                    End If
                End If
            End If
        End If
    Next
    fraAdvice.Enabled = Editable
    cmdSel.Enabled = fraAdvice.Enabled
    cmd≥£”√÷ˆÕ–.Enabled = fraAdvice.Enabled
    cmd“Ω…˙÷ˆÕ–.Enabled = fraAdvice.Enabled
End Sub

Private Function Get∆µ¬ ∑∂Œß(ByVal lngRow As Long) As Integer
    Dim lngFind As Long
    
    With vsAdvice
        If RowIn≈‰∑Ω––(lngRow) Then
            Get∆µ¬ ∑∂Œß = 2 '÷–“Ω
        Else
            If RowInºÏ—È––(lngRow) Then '“‘ºÏ—ÈœÓƒø––Œ™◊º
                lngFind = .FindRow(CStr(.RowData(lngRow)), , COL_œ‡πÿID)
                If lngFind <> -1 Then lngRow = lngFind
            End If
            If InStr(",5,6,", .TextMatrix(lngRow, COL_¿‡±)) > 0 Or Val(.TextMatrix(lngRow, COL_∆µ¬ –‘÷ )) = 0 Then
                Get∆µ¬ ∑∂Œß = 1 '≥…“©ªÚø…—°∆µ¬ µƒœÓƒø π”√Œ˜“Ω∆µ¬ œÓƒø
            ElseIf Val(.TextMatrix(lngRow, COL_∆µ¬ –‘÷ )) = 1 Then
                Get∆µ¬ ∑∂Œß = -1 '“ª¥Œ–‘
            ElseIf Val(.TextMatrix(lngRow, COL_∆µ¬ –‘÷ )) = 2 Then
                Get∆µ¬ ∑∂Œß = -2 '≥÷–¯–‘
            End If
        End If
    End With
End Function

Private Function SeekVisibleRow() As Boolean
'π¶ƒ‹£∫µ±«∞––Œ™“˛≤ÿ–– ±£¨∂®ŒªµΩÀ¸À˘ Ùµƒø…º˚––
    Dim lngRow As Long
    
    With vsAdvice
        If Not .RowHidden(.Row) Then Exit Function
        If InStr(",F,G,C,D,E,", .TextMatrix(.Row, COL_¿‡±)) > 0 And Val(.TextMatrix(.Row, COL_œ‡πÿID)) <> 0 Then
            lngRow = .FindRow(CLng(Val(.TextMatrix(.Row, COL_œ‡πÿID))))
        ElseIf .TextMatrix(.Row, COL_¿‡±) = "7" Then
            lngRow = .FindRow(CLng(Val(.TextMatrix(.Row, COL_œ‡πÿID))))
        ElseIf .TextMatrix(.Row, COL_¿‡±) = "E" And Val(.TextMatrix(.Row, COL_œ‡πÿID)) = 0 Then
            lngRow = .Row - 1
        End If
        If lngRow <> -1 Then
            If .RowData(lngRow) <> 0 Then
                .Row = lngRow: SeekVisibleRow = True
            End If
        End If
    End With
End Function

Private Sub FuncApplyCustom(ByVal intType As Integer, ByVal lngŒƒº˛ID As Long, Optional ByVal lng…Í«Î–Ú∫≈ As Long, Optional ByVal lngœÓƒøid As Long)
'π¶ƒ‹£∫◊‘∂®“Â…Í«Îµ•
    Dim objApplyCustom As New frmApplyCustom
    Dim lngOut“Ω÷ˆID As Long

    If mblnNoSave Then
        If Not CheckAdvice Then Exit Sub
        If Not SaveAdvice Then vsAdvice.SetFocus: Exit Sub
    End If
    
    If objApplyCustom.ShowMe(Me, 1, intType, mlng≤°»ÀID, mstrπ“∫≈µ•, 1, lngŒƒº˛ID, lng…Í«Î–Ú∫≈, mlng≤°»Àø∆ “id, mlng≤°»Àø∆ “id, , mrsDefine, , , 1, mclsMipModule, mlng«∞Ã·ID, , mintœ’¿‡, lngOut“Ω÷ˆID, lngœÓƒøid) Then
         '÷ÿ–¬∂¡»°œ‘ æ“Ω÷ˆ
        Call ReLoadAdvice(lngOut“Ω÷ˆID)
        mblnOK = True '«ø––
        If txt“Ω÷ˆƒ⁄»›.Enabled Then
            txt“Ω÷ˆƒ⁄»›.SetFocus
        Else
            vsAdvice.SetFocus
        End If
    End If
End Sub

Private Sub vsAdvice_AfterRowColChange(ByVal OldRow As Long, ByVal OldCol As Long, ByVal NewRow As Long, ByVal NewCol As Long)
'π¶ƒ‹£∫µ±––∏ƒ±‰ ±£¨∏¸–¬ø®∆¨ƒ⁄»›
    Dim rsItem As New ADODB.Recordset
    Dim rsBlood As New ADODB.Recordset
    Dim strSQL As String, lngRow As Long
    Dim lng”√∑®ID As Long, blnEditable As Boolean
    Dim lng“©∆∑ID As Long, lngBaseRow As Long '÷–“©≈‰∑Ωµƒµ⁄“ªŒ∂◊È≥…“©––
    Dim dblPrice As Double, strTmp As String, i As Long
    Dim blnœ‘ æµ•¡ø As Boolean, blnœ‘ æøπæ˙“©ŒÔ As Boolean
    Dim blnEditableTmp As Boolean
    
    If vsAdvice.Col >= vsAdvice.FixedCols Then
        vsAdvice.ForeColorSel = vsAdvice.Cell(flexcpForeColor, NewRow, COL_ø™ º ±º‰)
    End If
    
    If NewRow = OldRow Then Exit Sub
    If Not mblnRowChange Then Exit Sub
    If SeekVisibleRow Then Exit Sub
    'Pass
    If mblnPass And Me.Visible Then
        If NewRow <> OldRow Then
            If gobjPass.zlPassCheck(mobjPassMap) Then
                Call gobjPass.zlPassSetDrug(mobjPassMap)
            End If
        End If
    End If
    
    lngRow = NewRow
     'µ±«∞–– «ø’–– ±£¨»Áπ˚«∞“ª–– «“ª≤¢∏¯“©––£¨‘Ú»± °∞¥œ¬°∞“ª≤¢°±∞¥≈•
    If vsAdvice.RowData(lngRow) = 0 Then
        i = GetPreRow(lngRow)
        If i = -1 Then
            mblnRowMerge = False
        Else
            mblnRowMerge = RowIn“ª≤¢∏¯“©(i)
        End If
    Else
        mblnRowMerge = RowIn“ª≤¢∏¯“©(lngRow)
    End If
    cbsMain.RecalcLayout 'º¥ ±À¢–¬
        
    'œ‘ æªÚ“˛≤ÿ…Û∫À“…Œ Àµ√˜
    Call ShowOrHideQuestion
        
    Me.Refresh
    LockWindowUpdate Me.hWnd
    
    chk√‚ ‘.Visible = False
        
    On Error GoTo errH
    
    With vsAdvice
        If Val(.RowData(lngRow)) = 0 Then
            'Œﬁ–ß––«Â≥˝ø®∆¨ƒ⁄»›
            Call ClearAdviceCard
            
            '»± °ø™ º ±º‰
            Call txtø™ º ±º‰_GotFocus
        Else
            'ø®∆¨±‡º≠
            blnEditable = True
            '“—∑¢ÀÕµƒ“Ω÷ˆ≤ªƒ‹–ﬁ∏ƒ
            If Val(.TextMatrix(lngRow, COL_◊¥Ã¨)) <> 1 Then blnEditable = False
            '“—«©√˚µƒ“Ω÷ˆ≤ªø…–ﬁ∏ƒ
            If Val(.TextMatrix(lngRow, COL_«©√˚∑Ò)) = 1 Then blnEditable = False
            
            If .TextMatrix(lngRow, COL_¿‡±) = "K" And gbln—™ø‚œµÕ≥ Then
                '—™ø‚ª∑Ω⁄
                If Not (Val(.TextMatrix(lngRow, COL_ºÏ≤È∑Ω∑®)) = 1 And Val(.TextMatrix(lngRow, COL_…Û∫À◊¥Ã¨)) = 2) Then
                    'æ…≥Ã 5£≠—™ø‚≈‰—™÷–
                    If Val(.TextMatrix(lngRow, COL_…Û∫À◊¥Ã¨)) = 5 Or Val(.TextMatrix(lngRow, COL_…Û∫À◊¥Ã¨)) = 2 Then blnEditable = False
                End If
            Else
                '…Û∫ÀÕ®π˝µƒ≤ª‘ –Ì–ﬁ∏ƒ
                If Val(.TextMatrix(lngRow, COL_…Û∫À◊¥Ã¨)) = 2 Then blnEditable = False
            End If
            
            ' « ‰—™“Ω÷ˆ ±£¨–¬ø™∫Û÷±Ω”Ω¯»Î4’‚∏ˆ◊¥Ã¨£¨’‚ ±∫Ú «‘ –Ì±‡º≠µƒ£¨∑Ò‘ÚΩ˚÷π
            If Val(.TextMatrix(lngRow, COL_…Û∫À◊¥Ã¨)) = 4 And .TextMatrix(lngRow, COL_¿‡±) = "K" Then
                If CanEditBloodAdvice(Val(.RowData(lngRow)), Val(.TextMatrix(lngRow, COL_…Û∫À◊¥Ã¨)), Val(.TextMatrix(lngRow, COL_±Í÷æ)) = 1, Val(.TextMatrix(lngRow, COL_ºÏ≤È∑Ω∑®)) = 1, False) = False Then blnEditable = False
            End If
            
            'œ‘ æªÚ“˛≤ÿ√‚ ‘±Íº«
            If Val(.TextMatrix(lngRow, COL_≤Ÿ◊˜¿‡–Õ)) = 1 And .TextMatrix(lngRow, COL_¿‡±) = "E" Then chk√‚ ‘.Visible = True
            mblnDoCheck = False
            chk√‚ ‘.value = Val(.TextMatrix(lngRow, COL_√‚ ‘))
            mblnDoCheck = True
            Call SetCardEditable(blnEditable)
            
            'ªÒ»°’Ô¡∆œÓƒøª˘±æ–≈œ¢
            '---------------------
            If InStr(",4,5,6,7,", Val(.TextMatrix(lngRow, COL_¿‡±))) > 0 Then
                lng“©∆∑ID = Val(.TextMatrix(lngRow, COL_ ’∑—œ∏ƒøID))
            End If
            
            
            If RowIn≈‰∑Ω––(lngRow) Then
                txt◊‹¡ø.MaxLength = 3
                'ªÒ»°÷–“©≈‰∑Ωµ⁄“ªŒ∂÷–“©––
                lngBaseRow = .FindRow(CStr(.RowData(lngRow)), , COL_œ‡πÿID)
                lng“©∆∑ID = Val(.TextMatrix(lngBaseRow, COL_ ’∑—œ∏ƒøID))
            ElseIf RowInºÏ—È––(lngRow) Then
                'ªÒ»°“ª≤¢≤…—˘µƒµ⁄“ª∏ˆœÓƒø––
                lngBaseRow = .FindRow(CStr(.RowData(lngRow)), , COL_œ‡πÿID)
                txt◊‹¡ø.MaxLength = txtµ•¡ø.MaxLength
            Else
                lngBaseRow = lngRow
                txt◊‹¡ø.MaxLength = txtµ•¡ø.MaxLength
            End If
            Set rsItem = Get’Ô¡∆œÓƒøº«¬º(Val(.TextMatrix(lngBaseRow, COL_’Ô¡∆œÓƒøID)))
            
            '¿©’π∞¥≈•ø…”√◊¥Ã¨(ºÏ≤È◊È∫œ,ºÏ—È◊È∫œ, ÷ ı,÷–“©≈‰∑Ω)
            cmdExt.Enabled = InStr(",7,C,F,D,", rsItem!¿‡±) > 0
            If rsItem!¿‡± = "E" Or rsItem!¿‡± = "K" Or rsItem!¿‡± = "Z" Then
                If rsItem!¿‡± = "K" And Val(.TextMatrix(lngRow, COL_…Í«Î–Ú∫≈) & "") <> 0 Then
                    cmdExt.Enabled = True
                Else
                    cmdExt.Enabled = CheckApplication(Val(.TextMatrix(lngBaseRow, COL_’Ô¡∆œÓƒøID)), 1)
                End If
            End If
            
            'œ‘ æµ±«∞“Ω÷ˆø®∆¨ƒ⁄»›
            '--------------------------------------------------------------------------------------------
            'ø™ º ±º‰£∫÷ª”––¬‘ˆ“Ω÷ˆ ±ø…“‘–ﬁ∏ƒø™ º ±º‰
            txtø™ º ±º‰.Text = .Cell(flexcpData, lngRow, COL_ø™ º ±º‰)
            Call SetStartTime(.TextMatrix(lngRow, COL_EDIT) = "1")
            
            '“Ω÷ˆƒ⁄»›
            txt“Ω÷ˆƒ⁄»›.Text = .TextMatrix(lngRow, col_“Ω÷ˆƒ⁄»›)
            
            
            '≥¨¡øÀµ√˜
            txt≥¨¡øÀµ√˜.Text = .TextMatrix(lngRow, COL_≥¨¡øÀµ√˜)
            SetItemEditable , , , , , , , , , , , , IIF(.TextMatrix(lngRow, COL_ «∑Ò≥¨¡ø) = "1" Or .TextMatrix(lngRow, COL_ «∑Ò≥¨∆⁄) = "1", 1, -1)
            
            If txt≥¨¡øÀµ√˜.Text <> "" Then
                cmdExcReason.Enabled = blnEditable
                cmdComExcReason.Enabled = blnEditable
            End If
                        
            'µ•¡ø£∫¡Ÿ÷ˆ,≥…“©ªÚø…—°‘Ò∆µ¬ µƒº∆ ±,º∆¡øœÓƒøø…“‘¬º»Î
            '----------------------
            If rsItem!¿‡± = "7" Then '÷–“©≈‰∑Ω(÷–≤›“©)À‰»ª”–µ•¡ø,µ´≤ª‘⁄’‚¿ÔÃÓ–¥
                SetItemEditable -1
            ElseIf (Nvl(rsItem!÷¥––∆µ¬ , 0) = 0 And InStr(",1,2,", Nvl(rsItem!º∆À„∑Ω Ω, 0)) > 0) _
                    Or InStr(",5,6,", rsItem!¿‡±) > 0 Then
                SetItemEditable 1
                blnœ‘ æµ•¡ø = True
                txtµ•¡ø.Text = .TextMatrix(lngRow, COL_µ•¡ø)
                lblµ•¡øµ•Œª.Caption = .TextMatrix(lngRow, COL_µ•¡øµ•Œª)
            Else
                SetItemEditable -1
            End If
            
            'ÃÏ ˝£∫Œ˜“©£¨÷–≥…“©¡Ÿ÷ˆ≤≈ π”√£¨”√”⁄º∆À„◊‹¡ø
            '“ª∞„£∫¡Ÿ÷ˆµƒ“©∆∑(∑«÷–“©)ªÚø…—°‘Ò∆µ¬ µƒº∆ ±,º∆¡øœÓƒøø…“‘ π”√ÃÏ ˝¿¥◊‘∂Øº∆À„◊‹¡ø
            blnEditableTmp = False
            If InStr(",5,6,", rsItem!¿‡±) > 0 Then
                If mblnÃÏ ˝ Then blnEditableTmp = True
            End If
            If blnEditableTmp Then
                SetDayState 1, 1
            Else
                SetDayState -1, -1
            End If
            txtÃÏ ˝.Text = Val(.TextMatrix(lngRow, COL_ÃÏ ˝))
            If Val(txtÃÏ ˝.Text) = 0 Then txtÃÏ ˝.Text = ""
            
            '◊‹¡ø
            '--------------------
            If rsItem!¿‡± = "7" Then
                '÷–“©≈‰∑Ω(÷–≤›“©)ÃÓ–¥Œ™∏∂ ˝
                SetItemEditable , 1
                lbl◊‹¡øµ•Œª.Caption = "∏∂"
                txt◊‹¡ø.Text = .TextMatrix(lngRow, COL_◊‹¡ø) '∏∂ ˝
                If Val(txt◊‹¡ø.Text) > IIF(mbytPatiType = 1, conOrdinary, conEmergency) Then
                    SetItemEditable , , , , , , , , , , , , 1
                End If
                blnœ‘ æµ•¡ø = True
                
                '∑«…¢◊∞–ŒÃ¨£¨÷ª‘ –Ì‘⁄≈‰∑ΩΩÁ√Ê ‰∏∂ ˝
                If Val(.TextMatrix(lngRow, COL_÷–“©–ŒÃ¨)) <> 0 Then
                    txt◊‹¡ø.Enabled = False
                    txt◊‹¡ø.BackColor = Me.BackColor
                End If
            Else
                '¡Ÿ÷ˆ∂º–Ë“™ÃÓ–¥◊‹¡ø:¡Ÿ÷ˆ∑¢ÀÕ“‘◊‹¡øŒ™◊º
                If rsItem!¿‡± = "Z" And Nvl(rsItem!≤Ÿ◊˜¿‡–Õ) <> "0" Then
                    SetItemEditable , -1 'Ãÿ ‚“Ω÷ˆ≤ª‘ –Ì–ﬁ∏ƒ◊‹¡ø(πÃ∂®Œ™1¥Œ)
                ElseIf Nvl(rsItem!÷¥––∆µ¬ , 0) = 1 And Nvl(rsItem!º∆À„∑Ω Ω, 0) = 3 Then
                    SetItemEditable , -1 '“ª¥Œ–‘º∆¥ŒœÓƒø≤ª ‰»Î◊‹¡ø
                Else
                    SetItemEditable , 1
                    blnœ‘ æµ•¡ø = True
                End If
                lbl◊‹¡øµ•Œª.Caption = .TextMatrix(lngRow, COL_◊‹¡øµ•Œª)
                txt◊‹¡ø.Text = .TextMatrix(lngRow, COL_◊‹¡ø)
            End If
            
            '∏¯“©Õææ∂∫Õ÷–“©”√∑®
            '--------------
            If InStr(",5,6,", rsItem!¿‡±) > 0 Then
                SetItemEditable , , 1
                lbl”√∑®.Caption = "∏¯“©Õææ∂"
                '≤È’“∏¯“©Õææ∂∂‘”¶µƒ––:≤È’“µƒRowdata(Variant) ˝æ›“™◊™Œ™Long–Õ,≤≈ƒ‹æ´»∑∆•≈‰
                lng”√∑®ID = .FindRow(CLng(.TextMatrix(lngRow, COL_œ‡πÿID)), lngRow + 1)
                lng”√∑®ID = Val(.TextMatrix(lng”√∑®ID, COL_’Ô¡∆œÓƒøID))
                cmd”√∑®.Tag = lng”√∑®ID
                txt”√∑®.Text = GetœÓƒø√˚≥∆(lng”√∑®ID)
            ElseIf rsItem!¿‡± = "K" Then
                ' ‰—™“Ω÷ˆ£∫“™ºÊ»›“‘«∞√ª”– ‰—™Õææ∂µƒ«Èøˆ
                lng”√∑®ID = .FindRow(CStr(.RowData(lngRow)), lngRow + 1, COL_œ‡πÿID)
                If lng”√∑®ID <> -1 Then
                    SetItemEditable , , 1
                     If Val(.TextMatrix(lngRow, COL_ºÏ≤È∑Ω∑®)) = 0 And gbln—™ø‚œµÕ≥ = True Then
                        lbl”√∑®.Caption = "≤…ºØ∑Ω∑®"
                    Else
                        lbl”√∑®.Caption = " ‰—™Õææ∂"
                    End If
                    
                    lng”√∑®ID = Val(.TextMatrix(lng”√∑®ID, COL_’Ô¡∆œÓƒøID))
                    cmd”√∑®.Tag = lng”√∑®ID
                    txt”√∑®.Text = GetœÓƒø√˚≥∆(lng”√∑®ID)
                Else
                    SetItemEditable , , -1
                End If
            ElseIf rsItem!¿‡± = "7" Then
                SetItemEditable , , 1
                lbl”√∑®.Caption = "÷–“©”√∑®"
                
                '÷–“©≈‰∑Ωœ‘ æ––æÕ «÷–“©”√∑®––
                lng”√∑®ID = Val(.TextMatrix(lngRow, COL_’Ô¡∆œÓƒøID))
                cmd”√∑®.Tag = lng”√∑®ID
                txt”√∑®.Text = GetœÓƒø√˚≥∆(lng”√∑®ID)
            ElseIf RowInºÏ—È––(lngRow) Then '≤ª”√¿‡±≈–∂œ,ºÊ»›“‘«∞µƒºÏ—È
                'ºÏ—È◊È∫œ
                SetItemEditable , , 1
                lbl”√∑®.Caption = "≤…ºØ∑Ω∑®"
                
                'ºÏ—È◊È∫œœ‘ æ––æÕ «≤…ºØ∑Ω∑®––
                lng”√∑®ID = Val(.TextMatrix(lngRow, COL_’Ô¡∆œÓƒøID))
                cmd”√∑®.Tag = lng”√∑®ID
                txt”√∑®.Text = GetœÓƒø√˚≥∆(lng”√∑®ID)
            Else
                SetItemEditable , , -1
            End If
            
            ' ÷ ı ±º‰/ ‰—™ ±º‰£∫÷ª”– ÷ ı/ ‰—™ø…”√(“˛≤ÿ‘⁄”√∑®Œª÷√)
            If rsItem!¿‡± = "F" Or rsItem!¿‡± = "K" Then
                SetItemEditable , , , , , , , , 1
                If IsDate(.TextMatrix(lngRow, COL_ ÷ ı ±º‰)) Then
                    txt∞≤≈≈ ±º‰.Text = .TextMatrix(lngRow, COL_ ÷ ı ±º‰)
                Else
                    txt∞≤≈≈ ±º‰.Text = .Cell(flexcpData, lngRow, COL_ø™ º ±º‰)
                End If
                Call Set∞≤≈≈ ±º‰(rsItem!¿‡±)
            Else
                SetItemEditable , , , , , , , , -1
            End If
            
            '∆µ¬ (¡Ÿ÷ˆ ‰»Î”√”⁄÷∏µº π”√)
            If InStr("F,G,H,I", rsItem!¿‡±) > 0 Or rsItem!¿‡± = "Z" And InStr(",1,2,3,4,5,6,7,8,9,10,11,12,14,", "," & rsItem!≤Ÿ◊˜¿‡–Õ & ",") > 0 Then
                SetItemEditable , , , -1
            Else
                SetItemEditable , , , 1
            End If
            cmd∆µ¬ .Tag = .TextMatrix(lngRow, COL_∆µ¬ )
            txt∆µ¬ .Text = .TextMatrix(lngRow, COL_∆µ¬ )
                    
            '÷¥–– ±º‰£∫"ø…—°∆µ¬ "ªÚ“©∆∑°£
            If (Nvl(rsItem!÷¥––∆µ¬ , 0) = 0 Or InStr(",5,6,7,", rsItem!¿‡±) > 0) And .TextMatrix(lngRow, COL_º‰∏Ùµ•Œª) <> "∑÷÷”" Then
                SetItemEditable , , , , 1
                Call Get ±º‰∑Ω∞∏(cbo÷¥–– ±º‰, Get∆µ¬ ∑∂Œß(lngRow), .TextMatrix(lngRow, COL_∆µ¬ ), lng”√∑®ID)
                cbo÷¥–– ±º‰.Text = .TextMatrix(lngRow, COL_÷¥–– ±º‰)
            Else
                SetItemEditable , , , , -1
            End If
                    
            'µŒÀŸ£∫ ‰“∫¿‡∏¯“©Õææ∂µƒ“©∆∑ø…“‘ ‰»Î
            If InStr(",5,6,", rsItem!¿‡±) > 0 Then
                i = .FindRow(CLng(.TextMatrix(lngRow, COL_œ‡πÿID)), lngRow + 1)
                If Val(.TextMatrix(i, COL_÷¥––∑÷¿‡)) = 1 Then
                    SetItemEditable , , , , , , , , , 1
                    If InStr(.TextMatrix(i, COL_“Ω…˙÷ˆÕ–), "µŒ/∑÷÷”") > 0 Then
                        lblµŒÀŸµ•Œª.Caption = "µŒ/∑÷÷”"
                    ElseIf InStr(.TextMatrix(i, COL_“Ω…˙÷ˆÕ–), "∫¡…˝/–° ±") > 0 Then
                        lblµŒÀŸµ•Œª.Caption = "∫¡…˝/–° ±"
                    End If
                    Call Load ‰“∫µŒÀŸ(cboµŒÀŸ, lblµŒÀŸµ•Œª, False)
                    cboµŒÀŸ.Text = Replace(.TextMatrix(i, COL_“Ω…˙÷ˆÕ–), lblµŒÀŸµ•Œª.Caption, "")
                Else
                    SetItemEditable , , , , , , , , , -1
                End If
            Else
                SetItemEditable , , , , , , , , , -1
            End If
            
            
            '”√“©ƒøµƒ∫Õ”√“©¿Ì”…
            If Val(.TextMatrix(lngRow, COL_øπæ˙µ»º∂)) = 0 Then
                SetItemEditable , , , , , , , , , , -1, -1
            Else
                SetItemEditable , , , , , , , , , , 1, 1
                blnœ‘ æøπæ˙“©ŒÔ = True
                
                If .TextMatrix(lngRow, COL_”√“©ƒøµƒ) = "1" Then
                    Call zlControl.CboSetIndex(cboDruPur.hWnd, 1)
                ElseIf .TextMatrix(lngRow, COL_”√“©ƒøµƒ) = "2" Then
                    Call zlControl.CboSetIndex(cboDruPur.hWnd, 2)
                End If
                
                txt”√“©¿Ì”….Text = .TextMatrix(lngRow, COL_”√“©¿Ì”…)
            End If
            cboDruPur.Enabled = blnEditable
            cmdReason.Enabled = blnEditable
            cmd ’≤ÿ”√“©¿Ì”….Enabled = blnEditable
            
            ' ‰—™“Ω÷ˆœ‘ æ”√“©ƒøµƒ£¨Ω´”√“©ƒøµƒœ‘ æŒ™ ‰—™‘≠“Ú
            If (gbln ‰—™∑÷º∂π‹¿Ì Or gbln—™ø‚œµÕ≥) And .TextMatrix(lngRow, COL_¿‡±) = "K" Then
                blnœ‘ æøπæ˙“©ŒÔ = True
                SetItemEditable , , , , , , , , , , , , , 1
                txt”√“©¿Ì”….Width = cmdExcReason.Left + cmdExcReason.Width - txt”√“©¿Ì”….Left
                If .TextMatrix(lngRow, COL_±Í÷æ) = "1" Then
                    SetItemEditable , , , , , , , , , , , 1
                    txt”√“©¿Ì”….Text = .TextMatrix(lngRow, COL_”√“©¿Ì”…)
                Else
                    SetItemEditable , , , , , , , , , , , -1
                End If
            Else
                SetItemEditable , , , , , , , , , , , , , -1
                txt”√“©¿Ì”….Width = cmdExcReason.Left + cmdExcReason.Width - txt”√“©¿Ì”….Left
                cmd ’≤ÿ”√“©¿Ì”….Left = txt”√“©¿Ì”….Left + txt”√“©¿Ì”….Width + 30
                cmdReason.Left = txt”√“©¿Ì”….Left + txt”√“©¿Ì”….Width - cmdReason.Width
            End If
            
            '“Ω…˙÷ˆÕ–
            cbo“Ω…˙÷ˆÕ–.Text = .TextMatrix(lngRow, COL_“Ω…˙÷ˆÕ–)
                    
            '÷¥–––‘÷ 
            If InStr(",5,6,7,", rsItem!¿‡±) > 0 Then
                '»Áπ˚ «◊‘π‹“©‘ÚπÃ∂®—°‘Ò◊‘±∏“©
                If Val(.TextMatrix(lngRow, COL_¡Ÿ¥≤◊‘π‹“©)) = 1 And InStr(",5,6,", rsItem!¿‡±) > 0 Then
                    strTmp = "◊‘±∏“©"
                Else
                    If rsItem!¿‡± = "7" Then
                        '∂‘”⁄÷–“©≈‰∑Ω,∏˘æ›’Ô¡∆œÓƒøπ‹¿Ì÷–œﬁ÷∆º∞±æ≥Ã–Ú¥¶¿Ì,≤ªø…ƒ‹”√∑®∫ÕºÂ∑®“ª∏ˆŒ™‘∫Õ‚÷¥––,“ª∏ˆ≤ªŒ™
                        If Val(.TextMatrix(lngBaseRow, COL_÷¥–––‘÷ )) = 5 And Val(.TextMatrix(lngRow, COL_÷¥–––‘÷ )) <> 5 Then
                            strTmp = "◊‘±∏“©"
                        ElseIf Val(.TextMatrix(lngBaseRow, COL_÷¥–––‘÷ )) <> 5 And Val(.TextMatrix(lngRow, COL_÷¥–––‘÷ )) = 5 Then
                            strTmp = "¿Î‘∫¥¯“©"
                        Else
                            strTmp = "’˝≥£"
                        End If
                    Else
                        i = .FindRow(CLng(.TextMatrix(lngRow, COL_œ‡πÿID)), lngRow + 1)
                        If Val(.TextMatrix(lngRow, COL_÷¥–––‘÷ )) = 5 And Val(.TextMatrix(i, COL_÷¥–––‘÷ )) <> 5 Then
                            strTmp = "◊‘±∏“©"
                        ElseIf Val(.TextMatrix(lngRow, COL_÷¥–––‘÷ )) <> 5 And Val(.TextMatrix(i, COL_÷¥–––‘÷ )) = 5 Then
                            strTmp = "¿Î‘∫¥¯“©"
                        Else
                            strTmp = "’˝≥£"
                        End If
                    End If
                End If
                Call SetCbo÷¥–––‘÷ (gblnøπæ˙“©ŒÔ π”√◊‘±∏“© Or Not gblnKSSStrict Or Val(.TextMatrix(lngRow, COL_øπæ˙µ»º∂)) = 0, Val(.TextMatrix(lngRow, COL_¡Ÿ¥≤◊‘π‹“©)) = 1 And rsItem!¿‡± & "" <> "7")
                SetItemEditable , , , , , , 1
                Call SeekIndex(cbo÷¥–––‘÷ , strTmp)
            Else
                SetItemEditable , , , , , , -1
            End If
            
            lbl÷¥––ø∆ “.Caption = "÷¥––ø∆ “"
            '÷¥––ø∆ “:¡Ùπ€ªÚ◊°‘∫“Ω÷ˆ”√¡Ÿ¥≤ø∆ “
            If rsItem!¿‡± = "Z" And InStr(",1,2,", Nvl(rsItem!≤Ÿ◊˜¿‡–Õ, 0)) > 0 Then
                SetItemEditable , , , , , 1
                If Nvl(rsItem!≤Ÿ◊˜¿‡–Õ, 0) = 1 Then
                    lbl÷¥––ø∆ “.Caption = "¡Ùπ€ø∆ “"
                    '¡Ùπ€:∞¸∫¨√≈’ÔªÚ◊°‘∫¡Ÿ¥≤ø∆ “,”…∑˛ŒÒ∂‘œÛæˆ∂® «√≈’Ô¡Ùπ€ªÚ◊°‘∫¡Ùπ€
                    Call Get¡Ÿ¥≤ø∆ “(3, , Val(.TextMatrix(lngRow, COL_÷¥––ø∆ “ID)), cbo÷¥––ø∆ “, True, False, True)
                ElseIf Nvl(rsItem!≤Ÿ◊˜¿‡–Õ, 0) = 2 Then
                    lbl÷¥––ø∆ “.Caption = "◊°‘∫ø∆ “"
                    '◊°‘∫:∞¸∫¨◊°‘∫¡Ÿ¥≤ø∆ “
                    Call Get¡Ÿ¥≤ø∆ “(2, , Val(.TextMatrix(lngRow, COL_÷¥––ø∆ “ID)), cbo÷¥––ø∆ “, True, False, True, 1)
                End If
                If Val(.TextMatrix(lngRow, COL_÷¥––ø∆ “ID)) <> 0 And cbo÷¥––ø∆ “.ListIndex = -1 Then .TextMatrix(lngRow, COL_÷¥––ø∆ “ID) = 0
            Else
                ' «“©∆∑‘Ú“‘“©∆∑––Œ™◊ºœ‘ æ,ºÏ—È◊È∫œ“‘ºÏ—ÈœÓƒøŒ™◊ºœ‘ æ
                i = lngRow
                If rsItem!¿‡± = "7" Then
                    i = lngBaseRow
                ElseIf RowInºÏ—È––(lngRow) Then '≤ª”√¿‡±≈–∂œ,ºÊ»›“‘«∞µƒºÏ—È
                    i = lngBaseRow
                End If
                
                If InStr(",0,5,", Val(.TextMatrix(i, COL_÷¥–––‘÷ ))) = 0 Then
                    '∑«∂£÷ˆ∫Õ‘∫Õ‚÷¥–– ±≤≈œ‘ æ∫Õø…“‘—°‘Ò(∞¸¿®“©∆∑)
                    SetItemEditable , , , , , 1
                    Call Get’Ô¡∆÷¥––ø∆ “(mlng≤°»ÀID, 0, cbo÷¥––ø∆ “, rsItem!¿‡±, rsItem!ID, lng“©∆∑ID, Nvl(rsItem!÷¥––ø∆ “, 0), _
                        mlng≤°»Àø∆ “id, Val(.TextMatrix(i, COL_ø™÷ˆø∆ “ID)), Val(.TextMatrix(i, COL_÷¥––ø∆ “ID)), 1, 1, , blnEditable)
                        
                     
                    '∑«…¢◊∞–ŒÃ¨£¨÷ª‘ –Ì‘⁄≈‰∑ΩΩÁ√Ê—°“©∑ø
                    If rsItem!¿‡± = "7" Then
                        If Val(.TextMatrix(lngRow, COL_÷–“©–ŒÃ¨)) <> 0 Then
                            cbo÷¥––ø∆ “.Enabled = False
                            cbo÷¥––ø∆ “.BackColor = Me.BackColor
                        End If
                    End If
                ElseIf InStr(",0,5,", Val(.TextMatrix(i, COL_÷¥–––‘÷ ))) > 0 Then
                    SetItemEditable , , , , , -1
                    If Val(.TextMatrix(i, COL_÷¥–––‘÷ )) = 0 Then
                        cbo÷¥––ø∆ “.AddItem "<Œﬁ÷¥––∂£÷ˆ>"
                    Else
                        cbo÷¥––ø∆ “.AddItem "-"
                    End If
                    Call zlControl.CboSetIndex(cbo÷¥––ø∆ “.hWnd, 0)
                End If
                If Val(.TextMatrix(i, COL_÷¥––ø∆ “ID)) <> 0 And cbo÷¥––ø∆ “.ListIndex = -1 Then .TextMatrix(i, COL_÷¥––ø∆ “ID) = 0
                If InStr("5,6,7", rsItem!¿‡±) > 0 Then lbl÷¥––ø∆ “.Caption = "∑¢“©“©∑ø"
            End If

            If cbo÷¥––ø∆ “.ListIndex = -1 And cbo÷¥––ø∆ “.ListCount = 1 Then
                If Val(.TextMatrix(i, COL_◊¥Ã¨)) < 3 Then
                    cbo÷¥––ø∆ “.ListIndex = 0
                Else
                    Call zlControl.CboSetIndex(cbo÷¥––ø∆ “.hWnd, 0)
                End If
            End If
            
            If cbo÷¥––ø∆ “.ListCount = 1 Then
                If cbo÷¥––ø∆ “.List(cbo÷¥––ø∆ “.ListIndex) <> "[∆‰À¸...]" Then
                    cbo÷¥––ø∆ “.Enabled = False
                Else
                    cbo÷¥––ø∆ “.Enabled = True
                End If
            Else
                cbo÷¥––ø∆ “.Enabled = True
            End If
            
            '∏Ωº”÷¥––:÷∏∏¯“©Õææ∂,÷–“©”√∑®, ÷ ı¬È◊Ì,≤…ºØ∑Ω Ωµƒ÷¥––ø∆ “£¨‘≠“∫∆§ ‘œÓƒø
            If Should∏Ωº”÷¥––(lngRow, i, strTmp) Then
                If .TextMatrix(lngRow, COL_¿‡±) = "E" And .TextMatrix(lngRow, COL_≤Ÿ◊˜¿‡–Õ) = "1" And .TextMatrix(lngRow, COL_÷¥––∑÷¿‡) = "5" Then
                    '∂‘”⁄‘≠“∫∆§ ‘º”‘ÿ“©∑ø
                    lng“©∆∑ID = Get‘≠“∫∆§ ‘“©∆∑(Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID)))
                    If lng“©∆∑ID <> 0 Then
                        SetItemEditable , , , , , , , 1
                        Call Get’Ô¡∆÷¥––ø∆ “(mlng≤°»ÀID, 0, cbo∏Ωº”÷¥––, "5", 0, lng“©∆∑ID, 0, mlng≤°»Àø∆ “id, 0, Val(.TextMatrix(i, COL_”√“©¿Ì”…)), 1, 1, , blnEditable)
                        '»Áπ˚√ª”–—°“©∑ø‘Ú≤ªº”‘ÿ»Œ∫Œƒ¨»œ÷µ
                        If Val(.TextMatrix(i, COL_”√“©¿Ì”…)) = 0 Then cbo∏Ωº”÷¥––.ListIndex = -1
                    Else
                        cbo∏Ωº”÷¥––.Clear
                        SetItemEditable , , , , , , , -1
                    End If
                Else
                    '÷¥––ø∆ “:∑«“©÷ˆ“©∆∑º∞∏˙◊ŸŒ¿≤ƒµƒ◊®√≈»°
                    SetItemEditable , , , , , , , 1
                    Call Get’Ô¡∆÷¥––ø∆ “(mlng≤°»ÀID, 0, cbo∏Ωº”÷¥––, .TextMatrix(i, COL_¿‡±), Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID)), lng“©∆∑ID, _
                        Val(.TextMatrix(i, COL_÷¥–––‘÷ )), mlng≤°»Àø∆ “id, Val(.TextMatrix(i, COL_ø™÷ˆø∆ “ID)), Val(.TextMatrix(i, COL_÷¥––ø∆ “ID)), 1, 1, , blnEditable)
                        
                    If Val(.TextMatrix(i, COL_÷¥––ø∆ “ID)) <> 0 And cbo∏Ωº”÷¥––.ListIndex = -1 Then .TextMatrix(i, COL_÷¥––ø∆ “ID) = 0
                    If cbo∏Ωº”÷¥––.ListIndex = -1 And cbo∏Ωº”÷¥––.ListCount = 1 Then cbo∏Ωº”÷¥––.ListIndex = 0
                End If
            Else
                SetItemEditable , , , , , , , -1
                If i <> -1 Then
                    If InStr(",0,5,", Val(.TextMatrix(i, COL_÷¥–––‘÷ ))) > 0 Then
                        If Val(.TextMatrix(i, COL_÷¥–––‘÷ )) = 0 Then
                            cbo∏Ωº”÷¥––.AddItem "<Œﬁ÷¥––∂£÷ˆ>"
                        ElseIf Val(.TextMatrix(i, COL_÷¥–––‘÷ )) = 5 Then
                            cbo∏Ωº”÷¥––.AddItem "-"
                        End If
                        Call zlControl.CboSetIndex(cbo∏Ωº”÷¥––.hWnd, 0)
                    End If
                End If
            End If
            lbl∏Ωº”÷¥––.Caption = strTmp
            
            'ΩÙº±±Í÷æ
            chkΩÙº±.Visible = True
            mblnDoCheck = False
            chkΩÙº±.value = Val(.TextMatrix(lngRow, COL_±Í÷æ))
            chkZeroBilling.value = Val(.TextMatrix(lngRow, COL_¡„∑—º«’ ))
            mblnDoCheck = True
                        
            
            'œ‘ æ“©∆∑ø‚¥Ê£∫“‘√≈’Ôµ•Œª£¨÷–“©≈‰∑Ω≤ªœ‘ æ
            '----------------------------------------
            If Val(.TextMatrix(lngRow, COL_ ’∑—œ∏ƒøID)) <> 0 _
                And (InStr(",5,6,", rsItem!¿‡±) > 0 Or rsItem!¿‡± = "4" And Val(.TextMatrix(lngRow, COL_∏˙◊Ÿ‘⁄”√)) = 1) Then
                If .TextMatrix(lngRow, COL_ø‚¥Ê) = "" And Val(.TextMatrix(lngRow, COL_÷¥––ø∆ “ID)) <> 0 Then Call GetDrugStock(lngRow)
                If .TextMatrix(lngRow, COL_ø‚¥Ê) <> "" And Val(.TextMatrix(lngRow, COL_÷¥––ø∆ “ID)) = 0 Then .TextMatrix(lngRow, COL_ø‚¥Ê) = ""
                If .TextMatrix(lngRow, COL_ø‚¥Ê) <> "" Then
                    If InStr(GetInsidePrivs(p√≈’Ô“Ω÷ˆœ¬¥Ô), "œ‘ æ“©∆∑ø‚¥Ê") = 0 Then
                        stbThis.Panels(3).Text = IIF(Val(.TextMatrix(lngRow, COL_ø‚¥Ê)) > 0, "”–ø‚¥Ê", "Œﬁø‚¥Ê")
                    Else
                        stbThis.Panels(3).Text = "ø‚¥Ê:" & FormatEx(Val(.TextMatrix(lngRow, COL_ø‚¥Ê)), 5) & .TextMatrix(lngRow, COL_√≈’Ôµ•Œª)
                    End If
                Else
                    stbThis.Panels(3).Text = ""
                End If
            Else
                If rsItem!¿‡± = "7" And Val(.TextMatrix(lngRow, COL_◊¥Ã¨)) = 1 Then
                    Call GetDrugStock(lngRow)
                End If
                stbThis.Panels(3).Text = ""
            End If
            
            'œ‘ æ“Ω÷ˆµ•º€∫Õ∑—”√¿‡–Õ
            If .TextMatrix(lngRow, COL_µ•º€) = "" Then '”√""≤ª «¡„
                .TextMatrix(lngRow, COL_µ•º€) = GetItemPrice(lngRow)
            End If
            dblPrice = Val(.TextMatrix(lngRow, COL_µ•º€))
            If dblPrice <> 0 Then
                If InStr(",4,5,6,", rsItem!¿‡±) > 0 Then
                    stbThis.Panels(4).Text = "√ø" & .TextMatrix(lngRow, COL_√≈’Ôµ•Œª) & ":" & FormatEx(dblPrice, 5) & "‘™"
                ElseIf rsItem!¿‡± = "7" Then
                    stbThis.Panels(4).Text = "√ø∏∂:" & FormatEx(dblPrice, 5) & "‘™"
                Else
                    stbThis.Panels(4).Text = IIF(IsNull(rsItem!º∆À„µ•Œª), "º€∏Ò:", "√ø" & Nvl(rsItem!º∆À„µ•Œª) & ":") & FormatEx(dblPrice, 5) & "‘™"
                End If
            Else
                stbThis.Panels(4).Text = ""
            End If
            
            'œ‘ æ∑—”√¿‡–Õ
            strTmp = Get∑—”√¿‡–Õ(lngRow)
            If strTmp <> "" Then
                stbThis.Panels(4).Text = stbThis.Panels(4).Text & IIF(stbThis.Panels(4).Text <> "", ",", "") & strTmp
            End If
            
            '¥˝…Û∫Àµƒ”√—™“Ω÷ˆ£¨‘Ú≤ª‘ –Ì: ‰—™≥…∑÷°¢÷¥––ø∆ “°¢‘§∂® ‰—™¡ø
            If .TextMatrix(lngRow, COL_¿‡±) = "K" And Val(.TextMatrix(lngRow, COL_ºÏ≤È∑Ω∑®)) = 1 And gbln—™ø‚œµÕ≥ = True And blnEditable Then
                If InitObjBlood = True Then
                    If gobjPublicBlood.GetPrepareBloodRs(Val(.RowData(lngRow)), rsBlood) = True Then
                        If Val(rsBlood!º«¬º–‘÷  & "") = 2 And Val(rsBlood!º«¬º◊¥Ã¨ & "") = 1 Then
                            cmdSel.Enabled = False
                            txt“Ω÷ˆƒ⁄»›.Enabled = False
                            txt◊‹¡ø.Enabled = False
                            cbo÷¥––ø∆ “.Enabled = False
                        End If
                    End If
                End If
            End If
            
        End If
    End With
    
    '«Â≥˝±‡º≠±Í÷æ
    Call ClearItemTag
    
    'œ‘ æªÚ“˛≤ÿ“©∆∑œ‡πÿµƒ¡Ω––œÓƒø
    Call SetMediInfoItem(blnœ‘ æµ•¡ø, blnœ‘ æøπæ˙“©ŒÔ)
    
    'œ‘ æº∆º€¥∞ÃÂ
    Call ShowPrice(lngRow)
    
    'µ˜”√Õ‚π“Ω”ø⁄
    If CreatePlugInOK(p√≈’Ô“Ω÷ˆœ¬¥Ô, mint≥°∫œ) Then
        If OldRow <> NewRow Then
            Call zlPluginAdviceRowChange(NewRow)
            With vsAdvice
                If OldRow <> -1 Then
                    If Val(.RowData(OldRow)) <> 0 Then
                        If Val(.TextMatrix(OldRow, COL_EDIT)) = 1 Or Val(.TextMatrix(OldRow, COL_EDIT)) = 2 Then
                            Call zlPluginAdviceRowChange(OldRow, 1)
                        End If
                    End If
                End If
            End With
        End If
    End If
    
    cbsMain.RecalcLayout 'º¥ ±À¢–¬,”–Lockø…≤ª“™
    LockWindowUpdate 0
    Exit Sub
errH:
    LockWindowUpdate 0
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Sub ShowPrice(ByVal lngRow As Long)
'∏˘æ›µ±«∞––µƒ«Èøˆœ‘ æº∆º€¥∞ÃÂ
    If mblnModal Then Exit Sub
    
    If vsAdvice.RowData(lngRow) = 0 Or Val(vsAdvice.TextMatrix(lngRow, COL_’Ô¡∆œÓƒøID)) = 0 Then
        stbThis.Panels("Price").Bevel = sbrNoBevel
        stbThis.Panels("Price").Visible = False
    ElseIf InStr(",1,2,", Val(vsAdvice.TextMatrix(lngRow, COL_◊¥Ã¨))) = 0 Then
        stbThis.Panels("Price").Bevel = sbrNoBevel
        stbThis.Panels("Price").Visible = False
    ElseIf InStr(",4,5,6,", vsAdvice.TextMatrix(lngRow, COL_¿‡±)) > 0 Then
        stbThis.Panels("Price").Bevel = sbrNoBevel
        stbThis.Panels("Price").Visible = False
    ElseIf RowIn≈‰∑Ω––(lngRow) Then
        stbThis.Panels("Price").Bevel = sbrNoBevel
        stbThis.Panels("Price").Visible = False
    ElseIf stbThis.Panels("Price").Bevel = sbrNoBevel Then
        stbThis.Panels("Price").Visible = True
        If Val(stbThis.Panels("Price").Tag) <> 0 Then
            stbThis.Panels("Price").Bevel = sbrInset
        Else
            stbThis.Panels("Price").Bevel = sbrRaised
        End If
    End If
    
    If stbThis.Panels("Price").Bevel <> sbrInset Then
        'πÿ±’º∆º€¥∞ÃÂ
        mfrmPrice.HideMe
    Else
        Call mfrmPrice.ShowMe(Me, vsAdvice, mlng≤°»ÀID, 0, mlng≤°»Àø∆ “id, 1, mintœ’¿‡, _
            COL_–Ú∫≈ & "," & COL_œ‡πÿID & "," & COL_◊¥Ã¨ & "," & COL_¿‡± & "," & COL_’Ô¡∆œÓƒøID & "," & _
            COL_ ’∑—œ∏ƒøID & "," & COL_±Í±æ≤øŒª & "," & COL_ºÏ≤È∑Ω∑® & "," & COL_÷¥––±Íº« & "," & COL_º∆º€–‘÷  & "," & COL_÷¥–––‘÷  & "," & COL_÷¥––ø∆ “ID)
    End If
End Sub

Private Function Get∑—”√¿‡–Õ(ByVal lngRow As Long) As String
'π¶ƒ‹£∫ªÒ»°÷∏∂®––µƒ∑—”√¿‡–Õ
    Dim rsTmp As New ADODB.Recordset
    Dim strSQL As String, str¿‡–Õ As String, str¥Û¿‡ As String, lng ’∑—œ∏ƒøID As Long
    
    lng ’∑—œ∏ƒøID = Val(vsAdvice.TextMatrix(lngRow, COL_ ’∑—œ∏ƒøID))
    If lng ’∑—œ∏ƒøID <> 0 Then
        '»°“Ω±£µƒ∑—”√¿‡–Õ
        If mintœ’¿‡ <> 0 Then
            str¿‡–Õ = gclsInsure.GetItemInsure(mlng≤°»ÀID, lng ’∑—œ∏ƒøID, 0, True, mintœ’¿‡)
            If str¿‡–Õ <> "" Then
                If UBound(Split(str¿‡–Õ, ";")) >= 5 Then
                    str¿‡–Õ = Split(str¿‡–Õ, ";")(5)
                Else
                    str¿‡–Õ = ""
                End If
            End If
        End If
        '√ª”–‘Ú»°HISµƒ∑—”√¿‡–Õ
        strSQL = "Select A.∑—”√¿‡–Õ,N.√˚≥∆ as “Ω±£¥Û¿‡ From  ’∑—œÓƒøƒø¬º A,±£œ’÷ß∏∂œÓƒø M,±£œ’÷ß∏∂¥Û¿‡ N" & _
            " Where A.ID=[1] And A.ID=M. ’∑—œ∏ƒøID(+) And M.¥Û¿‡ID=N.ID(+) And M.œ’¿‡(+)=[2]"
        On Error GoTo errH
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng ’∑—œ∏ƒøID, mintœ’¿‡)
        If Not rsTmp.EOF Then
            If str¿‡–Õ = "" Then str¿‡–Õ = Nvl(rsTmp!∑—”√¿‡–Õ)
            str¥Û¿‡ = Nvl(rsTmp!“Ω±£¥Û¿‡)
        End If
    End If
        
    Get∑—”√¿‡–Õ = Mid(IIF(str¿‡–Õ <> "", ",¿‡–Õ:" & str¿‡–Õ, "") & IIF(str¥Û¿‡ <> "", ",¥Û¿‡:" & str¥Û¿‡, ""), 2)
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Function Should∏Ωº”÷¥––(ByVal lngRow As Long, lngRow2 As Long, str÷¥––ø∆ “ As String) As Boolean
'π¶ƒ‹£∫≈–∂œ÷∏∂®µƒ“Ω÷ˆ––(ø…º˚––) «∑Òø…“‘…Ë÷√∏Ωº”µƒ÷¥––ø∆ “
'≤Œ ˝£∫lngRow2=∑µªÿ∏Ωº”––µƒ“Ω÷ˆ––∫≈
'      str÷¥––ø∆ “=∏Ωº”÷¥––ø∆ “¿‡–Õ
    Dim i As Long
    
    lngRow2 = -1
    str÷¥––ø∆ “ = "∏Ωº”÷¥––"
    With vsAdvice
        If lngRow = 0 Or .RowData(lngRow) = 0 Then Exit Function
        
        If RowIn≈‰∑Ω––(lngRow) Then
            '÷–“©”√∑®
            lngRow2 = lngRow
            str÷¥––ø∆ “ = "”√∑®÷¥––"
            Should∏Ωº”÷¥–– = True
        ElseIf InStr(",5,6,", .TextMatrix(lngRow, COL_¿‡±)) > 0 Then
            '∏¯“©Õææ∂
            lngRow2 = .FindRow(CLng(.TextMatrix(lngRow, COL_œ‡πÿID)), lngRow + 1)
            str÷¥––ø∆ “ = "∏¯“©÷¥––"
            Should∏Ωº”÷¥–– = True
        ElseIf .TextMatrix(lngRow, COL_¿‡±) = "F" Then
            ' ÷ ı¬È◊Ì
            For i = lngRow + 1 To .Rows - 1
                If Val(.TextMatrix(i, COL_œ‡πÿID)) = .RowData(lngRow) Then
                    If .TextMatrix(i, COL_¿‡±) = "G" Then
                        lngRow2 = i: Exit For
                    End If
                Else
                    Exit For
                End If
            Next
            str÷¥––ø∆ “ = "¬È◊Ì÷¥––"
            If lngRow2 <> -1 Then Should∏Ωº”÷¥–– = True
        ElseIf .TextMatrix(lngRow, COL_¿‡±) = "K" Then
            ' ‰—™Õææ∂
            If Val(.TextMatrix(lngRow, COL_ºÏ≤È∑Ω∑®)) = 0 And gbln—™ø‚œµÕ≥ = True Then
                str÷¥––ø∆ “ = "≤…ºØ÷¥––"
            Else
                str÷¥––ø∆ “ = " ‰—™÷¥––"
            End If
            
            lngRow2 = .FindRow(CStr(.RowData(lngRow)), lngRow + 1, COL_œ‡πÿID)
            If lngRow2 <> -1 Then Should∏Ωº”÷¥–– = True
        ElseIf .TextMatrix(lngRow, COL_¿‡±) = "E" _
            And .TextMatrix(lngRow - 1, COL_¿‡±) = "C" _
            And Val(.TextMatrix(lngRow - 1, COL_œ‡πÿID)) = .RowData(lngRow) Then
            '≤…ºØ∑Ω Ω
            lngRow2 = lngRow
            str÷¥––ø∆ “ = "≤…ºØ÷¥––"
            Should∏Ωº”÷¥–– = True
        ElseIf .TextMatrix(lngRow, COL_¿‡±) = "E" And .TextMatrix(lngRow, COL_≤Ÿ◊˜¿‡–Õ) = "1" And .TextMatrix(lngRow, COL_÷¥––∑÷¿‡) = "5" Then
            '‘≠“∫∆§ ‘“©∑ø
            lngRow2 = lngRow
            str÷¥––ø∆ “ = "‘≠“∫“©∑ø"
            Should∏Ωº”÷¥–– = True
        End If
        
        '∂£÷ˆªÚ‘∫Õ‚÷¥––
        If Should∏Ωº”÷¥–– Then
            If InStr(",0,5,", Val(.TextMatrix(lngRow2, COL_÷¥–––‘÷ ))) > 0 Then
                Should∏Ωº”÷¥–– = False
            End If
        End If
    End With
End Function

Private Function GetItemPrice(ByVal lngRow As Long) As Double
'π¶ƒ‹£∫ªÒ»°µ±«∞“Ω÷ˆ––µƒº€∏Ò(“©∆∑Œ™“ª∏ˆ“©∑ø∞¸◊∞µƒµ•º€,∆‰À¸∏˘æ› ’∑—∂‘’’)
'Àµ√˜£∫“©∆∑≤ª∞¸∫¨∏¯“©Õææ∂º∞÷–“©”√∑®ºÂ∑®
    Dim rsTmp As New ADODB.Recordset
    Dim str“Ω÷ˆIDs As String, strµ•¡øs As String, str’Ô¡∆ ’∑— As String
    Dim strœÓƒøIDs As String, str“Ω÷ˆ As String, strœÓƒøø∆ “ As String, strTmp As String
    Dim strAdviceIDs As String, lng÷¥––ø∆ “ID As Long
    Dim dblPrice As Double, dbl ˝¡ø As Double
    Dim bln“©∆∑ As Boolean, strSQL As String
    Dim strπ‹¬ÎœÓƒø As String, i As Long
    
    With vsAdvice
        bln“©∆∑ = True
        If InStr(",4,5,6,", .TextMatrix(lngRow, COL_¿‡±)) > 0 And Val(.TextMatrix(lngRow, COL_ ’∑—œ∏ƒøID)) <> 0 Then
            'Œ˜“©º∞÷–≥…“©∞¥πÊ∏Òœ¬≤≈ƒ‹º∆À„º€∏Ò
            If Val(.TextMatrix(lngRow, COL_ ’∑—œ∏ƒøID)) <> 0 Then
                strœÓƒøIDs = strœÓƒøIDs & "," & Val(.TextMatrix(lngRow, COL_ ’∑—œ∏ƒøID))
            End If
            lng÷¥––ø∆ “ID = Val(.TextMatrix(lngRow, COL_÷¥––ø∆ “ID))
        ElseIf RowIn≈‰∑Ω––(lngRow) Then
            For i = lngRow - 1 To .FixedRows Step -1
                If Val(.TextMatrix(i, COL_œ‡πÿID)) = .RowData(lngRow) Then
                    If .TextMatrix(i, COL_¿‡±) = "7" And Val(.TextMatrix(i, COL_ ’∑—œ∏ƒøID)) <> 0 Then
                        If lng÷¥––ø∆ “ID = 0 Then
                            lng÷¥––ø∆ “ID = Val(.TextMatrix(i, COL_÷¥––ø∆ “ID))
                        End If
                        strœÓƒøIDs = strœÓƒøIDs & "," & Val(.TextMatrix(i, COL_ ’∑—œ∏ƒøID))
                        strµ•¡øs = strµ•¡øs & ";" & Val(.TextMatrix(i, COL_µ•¡ø))
                    End If
                Else
                    Exit For
                End If
            Next
        Else
            bln“©∆∑ = False
            '∆‰À¸“Ω÷ˆ,Œ¥–£∂‘(º∆º€)µƒ∞¥ ’∑—∂‘’’º∆À„,∑Ò‘Ú÷±Ω”»°“Ω÷ˆº∆º€
            '≤ª∞¸∫¨≤ªº∆º€∫Õ ÷π§º∆º€µƒœÓƒø,≤ª∞¸∫¨∂£÷ˆ∫Õ‘∫Õ‚÷¥––µƒœÓƒø
            If Val(.TextMatrix(lngRow, COL_º∆º€–‘÷ )) = 0 And InStr(",0,5,", Val(.TextMatrix(lngRow, COL_÷¥–––‘÷ ))) = 0 Then
                If InStr(",1,2,", .TextMatrix(lngRow, COL_◊¥Ã¨)) > 0 Then
                    strπ‹¬ÎœÓƒø = Val(.TextMatrix(lngRow, COL_’Ô¡∆œÓƒøID))
                    If RowInºÏ—È––(lngRow) Then
                        i = .FindRow(CStr(.RowData(lngRow)), .FixedRows, COL_œ‡πÿID)
                        If i <> -1 Then
                            strπ‹¬ÎœÓƒø = Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID))
                        End If
                    End If
                    
                    strœÓƒøø∆ “ = strœÓƒøø∆ “ & "," & Val(.TextMatrix(lngRow, COL_’Ô¡∆œÓƒøID)) & ":" & Val(.TextMatrix(lngRow, COL_÷¥––ø∆ “ID))
                    strœÓƒøIDs = strœÓƒøIDs & "," & Val(.TextMatrix(lngRow, COL_’Ô¡∆œÓƒøID))
                    str“Ω÷ˆ = str“Ω÷ˆ & " Union ALL Select " & _
                        IIF(Val(.TextMatrix(lngRow, COL_œ‡πÿID)) = 0, "-NULL", Val(.TextMatrix(lngRow, COL_œ‡πÿID))) & " as œ‡πÿID," & _
                        Val(.TextMatrix(lngRow, COL_’Ô¡∆œÓƒøID)) & " as ’Ô¡∆œÓƒøID," & Val(.TextMatrix(lngRow, COL_÷¥––±Íº«)) & " as ÷¥––±Íº«," & _
                        IIF(.TextMatrix(lngRow, COL_±Í±æ≤øŒª) = "", "NULL", "'" & .TextMatrix(lngRow, COL_±Í±æ≤øŒª) & "'") & " as ±Í±æ≤øŒª," & _
                        IIF(.TextMatrix(lngRow, COL_ºÏ≤È∑Ω∑®) = "", "NULL", "'" & .TextMatrix(lngRow, COL_ºÏ≤È∑Ω∑®) & "'") & " as ºÏ≤È∑Ω∑®," & _
                        strπ‹¬ÎœÓƒø & " as π‹¬ÎœÓƒøID From Dual"
                Else
                    str“Ω÷ˆIDs = str“Ω÷ˆIDs & "," & .RowData(lngRow)
                End If
            End If
            For i = lngRow + 1 To .Rows - 1
                If Val(.TextMatrix(i, COL_œ‡πÿID)) = .RowData(lngRow) Then
                    If Val(.TextMatrix(i, COL_º∆º€–‘÷ )) = 0 And InStr(",0,5,", Val(.TextMatrix(i, COL_÷¥–––‘÷ ))) = 0 Then
                        If InStr(",1,2,", .TextMatrix(i, COL_◊¥Ã¨)) > 0 Then
                            strTmp = Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID)) & ":" & Val(.TextMatrix(i, COL_÷¥––ø∆ “ID))
                            If InStr("," & strœÓƒøø∆ “ & ",", "," & strTmp & ",") = 0 Then strœÓƒøø∆ “ = strœÓƒøø∆ “ & "," & strTmp
                            
                            str“Ω÷ˆ = str“Ω÷ˆ & " Union ALL Select " & _
                                IIF(Val(.TextMatrix(i, COL_œ‡πÿID)) = 0, "-NULL", Val(.TextMatrix(i, COL_œ‡πÿID))) & " as œ‡πÿID," & _
                                Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID)) & " as ’Ô¡∆œÓƒøID," & Val(.TextMatrix(i, COL_÷¥––±Íº«)) & " as ÷¥––±Íº«," & _
                                IIF(.TextMatrix(i, COL_±Í±æ≤øŒª) = "", "NULL", "'" & .TextMatrix(i, COL_±Í±æ≤øŒª) & "'") & " as ±Í±æ≤øŒª," & _
                                IIF(.TextMatrix(i, COL_ºÏ≤È∑Ω∑®) = "", "NULL", "'" & .TextMatrix(i, COL_ºÏ≤È∑Ω∑®) & "'") & " as ºÏ≤È∑Ω∑®," & _
                                Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID)) & " as π‹¬ÎœÓƒøID From Dual"
                        Else
                            str“Ω÷ˆIDs = str“Ω÷ˆIDs & "," & .RowData(i)
                        End If
                    End If
                Else
                    Exit For
                End If
            Next
            For i = lngRow - 1 To .FixedRows Step -1 'ºÏ—È◊È∫œ
                If Val(.TextMatrix(i, COL_œ‡πÿID)) = .RowData(lngRow) Then
                    If Val(.TextMatrix(i, COL_º∆º€–‘÷ )) = 0 And InStr(",0,5,", Val(.TextMatrix(i, COL_÷¥–––‘÷ ))) = 0 Then
                        If InStr(",1,2,", .TextMatrix(i, COL_◊¥Ã¨)) > 0 Then
                            strTmp = Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID)) & ":" & Val(.TextMatrix(i, COL_÷¥––ø∆ “ID))
                            If InStr("," & strœÓƒøø∆ “ & ",", "," & strTmp & ",") = 0 Then strœÓƒøø∆ “ = strœÓƒøø∆ “ & "," & strTmp
                            
                            str“Ω÷ˆ = str“Ω÷ˆ & " Union ALL Select " & _
                                IIF(Val(.TextMatrix(i, COL_œ‡πÿID)) = 0, "-NULL", Val(.TextMatrix(i, COL_œ‡πÿID))) & " as œ‡πÿID," & _
                                Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID)) & " as ’Ô¡∆œÓƒøID," & Val(.TextMatrix(i, COL_÷¥––±Íº«)) & " as ÷¥––±Íº«," & _
                                IIF(.TextMatrix(i, COL_±Í±æ≤øŒª) = "", "NULL", "'" & .TextMatrix(i, COL_±Í±æ≤øŒª) & "'") & " as ±Í±æ≤øŒª," & _
                                IIF(.TextMatrix(i, COL_ºÏ≤È∑Ω∑®) = "", "NULL", "'" & .TextMatrix(i, COL_ºÏ≤È∑Ω∑®) & "'") & " as ºÏ≤È∑Ω∑®," & _
                                Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID)) & " as π‹¬ÎœÓƒøID From Dual"
                        Else
                            str“Ω÷ˆIDs = str“Ω÷ˆIDs & "," & .RowData(i)
                        End If
                    End If
                Else
                    Exit For
                End If
            Next
        End If
    End With
    str“Ω÷ˆIDs = Mid(str“Ω÷ˆIDs, 2)
    strµ•¡øs = Mid(strµ•¡øs, 2)
    strœÓƒøIDs = Mid(strœÓƒøIDs, 2)
    strœÓƒøø∆ “ = Mid(strœÓƒøø∆ “, 2)
    str“Ω÷ˆ = Mid(str“Ω÷ˆ, 12)
    
    On Error GoTo errH
    
    If bln“©∆∑ Then
        If strœÓƒøIDs = "" Then Exit Function
    
        strSQL = "Select Rownum As –Ú∫≈,Column_Value As ID From Table(f_Num2list([1]))"
        strSQL = "Select /*+ RULE */ A.ID,A.¿‡±,A. «∑Ò±‰º€,D.∏˙◊Ÿ‘⁄”√,Nvl(B.√≈’Ô∞¸◊∞,1) as √≈’Ô∞¸◊∞,Nvl(B.º¡¡øœµ ˝,1) as º¡¡øœµ ˝,B.√≈’Ôø…∑Ò∑÷¡„ As ø…∑Ò∑÷¡„" & _
            " From  ’∑—œÓƒøƒø¬º A,“©∆∑πÊ∏Ò B,≤ƒ¡œÃÿ–‘ D,(" & strSQL & ") C" & _
            " Where A.ID=B.“©∆∑ID(+) And A.ID=D.≤ƒ¡œID(+) And A.ID=C.ID Order By C.–Ú∫≈"
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, strœÓƒøIDs)
        For i = 1 To rsTmp.RecordCount
            ' €º€ ˝¡ø
            If strµ•¡øs <> "" Then '÷–“©≈‰∑Ω≤≈π‹√øŒ∂º¡¡ø
                dbl ˝¡ø = Val(Split(strµ•¡øs, ";")(i - 1))
                
                ' €º€ ˝¡ø£∫÷–“©“©∑øµ•Œª∞¥≤ªø…∑÷¡„¥¶¿Ì:√ø∏∂
                If Nvl(rsTmp!ø…∑Ò∑÷¡„, 0) = 0 Then
                    dbl ˝¡ø = Format(dbl ˝¡ø / Nvl(rsTmp!º¡¡øœµ ˝, 1), "0.00000")
                Else
                    dbl ˝¡ø = Format(IntEx(dbl ˝¡ø / Nvl(rsTmp!º¡¡øœµ ˝, 1) / Nvl(rsTmp!√≈’Ô∞¸◊∞, 1)) * Nvl(rsTmp!√≈’Ô∞¸◊∞, 1), "0.00000")
                End If
            Else
                dbl ˝¡ø = Nvl(rsTmp!√≈’Ô∞¸◊∞, 1) '1∏ˆ“©∑øµ•Œªµƒ €º€ ˝¡ø
            End If
            If Nvl(rsTmp! «∑Ò±‰º€, 0) = 1 And (rsTmp!¿‡± = "4" And Nvl(rsTmp!∏˙◊Ÿ‘⁄”√, 0) = 1 Or InStr(",5,6,7,", rsTmp!¿‡±) > 0) Then
                dblPrice = dblPrice + Format(Format(CalcDrugPrice(rsTmp!ID, lng÷¥––ø∆ “ID, dbl ˝¡ø), "0.00000") * dbl ˝¡ø, "0.00000")
            Else
                dblPrice = dblPrice + Format(Format(CalcPrice(rsTmp!ID), "0.00000") * dbl ˝¡ø, "0.00000")
            End If
            
            rsTmp.MoveNext
        Next
    Else
        If str“Ω÷ˆ = "" And str“Ω÷ˆIDs = "" Then Exit Function
    
        If str“Ω÷ˆIDs <> "" Then
            strSQL = _
                " Select /*+ RULE */B. ˝¡ø,Decode(C. «∑Ò±‰º€,1,B.µ•º€,Sum(D.œ÷º€)) as µ•º€" & _
                " From ≤°»À“Ω÷ˆº∆º€ B, ’∑—œÓƒøƒø¬º C, ’∑—º€ƒø D" & _
                " Where B. ’∑—œ∏ƒøID=C.ID And B. ’∑—œ∏ƒøID=D. ’∑—œ∏ƒøID" & _
                " And ((Sysdate Between D.÷¥––»’∆⁄ And D.÷’÷π»’∆⁄) Or (Sysdate>=D.÷¥––»’∆⁄ And D.÷’÷π»’∆⁄ is NULL))" & _
                " And B.“Ω÷ˆID IN(Select Column_Value From Table(f_Num2list([1])))" & _
                " Group by B. ˝¡ø,C. «∑Ò±‰º€,B.µ•º€"
        End If
        If str“Ω÷ˆ <> "" Then
            '”…”⁄√ª”–º”≤øŒªµ»Ãıº˛£¨À˘“‘“™”√Distinct
            str’Ô¡∆ ’∑— = "Select * From (" & _
                "Select Distinct C.’Ô¡∆œÓƒøID,C. ’∑—œÓƒøID,C.ºÏ≤È≤øŒª,C.ºÏ≤È∑Ω∑®,C.∑—”√–‘÷ ,C. ’∑— ˝¡ø,C.πÃ”–∂‘’’,C.¥” ÙœÓƒø,C. ’∑—∑Ω Ω,C.  ”√ø∆ “id" & _
                " ,Max(Nvl(c.  ”√ø∆ “id, 0)) Over(Partition By c.’Ô¡∆œÓƒøid, c.ºÏ≤È≤øŒª, c.ºÏ≤È∑Ω∑®, c.∑—”√–‘÷ ) As Top" & _
                " From ’Ô¡∆ ’∑—πÿœµ C,Table(f_Num2list2([2])) D Where C.’Ô¡∆œÓƒøID=D.c1" & _
                "      And (C.  ”√ø∆ “ID is Null or C.  ”√ø∆ “ID = D.c2 And C.≤°»À¿¥‘¥ = 1)" & _
                " ) Where Nvl(  ”√ø∆ “id, 0) = Top"
                
            strSQL = IIF(strSQL = "", "", strSQL & " Union ALL") & _
                " Select " & IIF(strSQL = "", "/*+ RULE */", "") & "B. ’∑— ˝¡ø as  ˝¡ø,Decode(C. «∑Ò±‰º€,1,Sum(D.»± °º€∏Ò),Sum(D.œ÷º€)) as µ•º€" & _
                " From (" & str“Ω÷ˆ & ") A,(" & str’Ô¡∆ ’∑— & ") B, ’∑—œÓƒøƒø¬º C, ’∑—º€ƒø D,’Ô¡∆œÓƒøƒø¬º E,≤…—™π‹¿‡–Õ F" & _
                " Where A.’Ô¡∆œÓƒøID=B.’Ô¡∆œÓƒøID And B. ’∑—œÓƒøID=C.ID And B. ’∑—œÓƒøID=D. ’∑—œ∏ƒøID" & _
                " And (C.’æµ„='" & gstrNodeNo & "' Or C.’æµ„ is Null) And A.π‹¬ÎœÓƒøID=E.ID And E. ‘π‹±‡¬Î=F.±‡¬Î(+)" & _
                " And (Nvl(B. ’∑—∑Ω Ω,0)=1 And C.¿‡±='4' And B. ’∑—œÓƒøID=F.≤ƒ¡œID Or Not(Nvl(B. ’∑—∑Ω Ω,0)=1 And C.¿‡±='4' And F.≤ƒ¡œID Is Not NULL))" & _
                " And ((Sysdate Between D.÷¥––»’∆⁄ and D.÷’÷π»’∆⁄) or (Sysdate>=D.÷¥––»’∆⁄ And D.÷’÷π»’∆⁄ is NULL))" & _
                " And (A.œ‡πÿID is Null And A.÷¥––±Íº« IN(1,2) And B.∑—”√–‘÷ =1" & _
                "       Or A.±Í±æ≤øŒª=B.ºÏ≤È≤øŒª And A.ºÏ≤È∑Ω∑®=B.ºÏ≤È∑Ω∑® And Nvl(B.∑—”√–‘÷ ,0)=0" & _
                "       Or (A.ºÏ≤È∑Ω∑® is Null Or e.¿‡± = 'E' And e.≤Ÿ◊˜¿‡–Õ='4') And Nvl(B.∑—”√–‘÷ ,0)=0 And B.ºÏ≤È≤øŒª is Null And B.ºÏ≤È∑Ω∑® is Null)" & _
                " Group by B. ’∑— ˝¡ø,C. «∑Ò±‰º€"
        End If
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Name, str“Ω÷ˆIDs, strœÓƒøø∆ “)
        For i = 1 To rsTmp.RecordCount
            dblPrice = dblPrice + Format(Nvl(rsTmp! ˝¡ø, 0) * Nvl(rsTmp!µ•º€, 0), "0.00000")
            rsTmp.MoveNext
        Next
    End If
    
    GetItemPrice = Format(dblPrice, gstrDecPrice)
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Function MakePriceRecord(ByVal lngRow As Long) As Boolean
'π¶ƒ‹£∫∏˘æ›µ±«∞–¬ø™“Ω÷ˆ––ƒ⁄»›£¨…˙≥…∂‘”¶µƒ”√”⁄“Ω±£µƒ∑—”√√˜œ∏º«¬ººØ
'≤Œ ˝£∫lngRow=µ±«∞“Ω÷ˆ––
'∑µªÿ£∫”–º∆º€ ˝æ›º«¬ººØƒ⁄»›≤≈∑µªÿTrue
    Dim rsTmp As New ADODB.Recordset
    Dim strSQL As String, strAdvice As String, strœÓƒøø∆ “ As String, str’Ô¡∆ ’∑— As String
    Dim lngBegin As Long, lngEnd As Long
    Dim lng÷¥––ø∆ “ID As Long, blnLoad As Boolean
    Dim dblµ•º€ As Double, dblΩ∂Ó As Double, dbl µ ’ As Double
    Dim strπ‹¬ÎœÓƒø As String, i As Long
    Dim strœÓƒø As String, blnDo As Boolean
    Dim lng◊ÈID As Long, lng’Ô∂œID As Long, lngº≤≤°ID As Long
    
    On Error GoTo errH
        
    With vsAdvice
        If .RowData(lngRow) = 0 Then Exit Function
        
        If RowInºÏ—È––(lngRow) Then
            i = .FindRow(CStr(.RowData(lngRow)), , COL_œ‡πÿID)
            If i <> -1 Then strπ‹¬ÎœÓƒø = Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID))
        End If
        
        '…˙≥…≤°»À“Ω÷ˆº«¬º¡Ÿ ±±Ì
        Call GetRowScope(lngRow, lngBegin, lngEnd)
        For i = lngBegin To lngEnd
            If Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID)) <> 0 Then
                strœÓƒøø∆ “ = strœÓƒøø∆ “ & "," & Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID)) & ":" & Val(.TextMatrix(i, COL_÷¥––ø∆ “ID))
                strAdvice = strAdvice & " Union ALL " & _
                    "Select " & .RowData(i) & " as ID," & Val(.TextMatrix(i, COL_–Ú∫≈)) & " as –Ú∫≈," & _
                    ZVal(.TextMatrix(i, COL_œ‡πÿID), True) & " as œ‡πÿID,'" & .TextMatrix(i, COL_¿‡±) & "' as ’Ô¡∆¿‡±," & _
                    IIF(strπ‹¬ÎœÓƒø = "", Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID)), strπ‹¬ÎœÓƒø) & " as π‹¬ÎœÓƒøID," & _
                    Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID)) & " as ’Ô¡∆œÓƒøID," & ZVal(.TextMatrix(i, COL_ ’∑—œ∏ƒøID), True) & " as  ’∑—œ∏ƒøID," & _
                    Val(.TextMatrix(i, COL_◊‹¡ø)) & " as ◊‹¡ø," & Val(.TextMatrix(i, COL_µ•¡ø)) & " as µ•¡ø," & _
                    "'" & .TextMatrix(i, COL_±Í±æ≤øŒª) & "' as ±Í±æ≤øŒª,'" & .TextMatrix(i, COL_ºÏ≤È∑Ω∑®) & "' as ºÏ≤È∑Ω∑®," & _
                    Val(.TextMatrix(i, COL_÷¥––±Íº«)) & " as ÷¥––±Íº«," & Val(.TextMatrix(i, COL_º∆º€–‘÷ )) & " as º∆º€Ãÿ–‘," & _
                    IIF(.TextMatrix(i, COL_¿‡±) = "F" And Val(.TextMatrix(i, COL_œ‡πÿID)) <> 0, 1, 0) & " as ∏Ωº” ÷ ı," & _
                    Val(.TextMatrix(i, COL_÷¥–––‘÷ )) & " as ÷¥–––‘÷ ," & ZVal(.TextMatrix(i, COL_÷¥––ø∆ “ID), True) & " as ÷¥––ø∆ “ID From Dual"
            End If
        Next
        strAdvice = Mid(strAdvice, 12)
        strœÓƒøø∆ “ = Mid(strœÓƒøø∆ “, 2)
    End With
    
    blnLoad = True
    
    '“©∆∑°¢Œ¿≤ƒµƒº∆º€£∫∞¥ €º€ ˝¡ø°¢µ•º€º∆À„
    If vsAdvice.TextMatrix(lngRow, COL_¿‡±) = "4" Then
        'Œ¿≤ƒ£∫πÃ∂®∞¥πÊ∏Òœ¬¥Ô
        strSQL = "Select A.–Ú∫≈,A.’Ô¡∆¿‡±,C.¿‡± as  ’∑—¿‡±,A. ’∑—œ∏ƒøID,D. ’»ÎœÓƒøID," & _
            " Decode(A.◊‹¡ø,0,1,A.◊‹¡ø) as  ˝¡ø,Decode(Nvl(C. «∑Ò±‰º€,0),1,D.»± °º€∏Ò,D.œ÷º€) as µ•º€," & _
            " C. «∑Ò±‰º€,C.∆¡±Œ∑—±,B.∏˙◊Ÿ‘⁄”√,A.÷¥––ø∆ “ID,A.∏Ωº” ÷ ı,D.∏Ω ı ’∑—¬ " & _
            " From (" & strAdvice & ") A,≤ƒ¡œÃÿ–‘ B, ’∑—œÓƒøƒø¬º C, ’∑—º€ƒø D" & _
            " Where A.ID=[1] And Nvl(A.÷¥–––‘÷ ,0)<>5 And A. ’∑—œ∏ƒøID=B.≤ƒ¡œID" & _
            " And A. ’∑—œ∏ƒøID=C.ID And C.∑˛ŒÒ∂‘œÛ IN(1,3) And D. ’∑—œ∏ƒøID=C.ID" & _
            " And (C.≥∑µµ ±º‰ is NULL Or C.≥∑µµ ±º‰=To_Date('3000-01-01','YYYY-MM-DD'))" & _
            " And ((Sysdate Between D.÷¥––»’∆⁄ and D.÷’÷π»’∆⁄) or (Sysdate>=D.÷¥––»’∆⁄ And D.÷’÷π»’∆⁄ is NULL))"
        blnLoad = False
    ElseIf InStr(",5,6,", vsAdvice.TextMatrix(lngRow, COL_¿‡±)) > 0 Then
        '÷–,Œ˜≥…“©:ø…ƒ‹∞¥πÊ∏Òœ¬“Ω÷ˆ,º∆À„1∏ˆ“©∑ø∞¸◊∞µƒµ•º€
        strSQL = "Select A.–Ú∫≈,A.’Ô¡∆¿‡±,C.¿‡± as  ’∑—¿‡±,C.ID as  ’∑—œ∏ƒøID,D. ’»ÎœÓƒøID," & _
            " Decode(A.◊‹¡ø,0,1,A.◊‹¡ø)/Decode(1,1,B.√≈’Ô∞¸◊∞,B.◊°‘∫∞¸◊∞) as  ˝¡ø," & _
            " Decode(Nvl(C. «∑Ò±‰º€,0),1,-NULL,D.œ÷º€) as µ•º€,C. «∑Ò±‰º€,C.∆¡±Œ∑—±," & _
            " 0 as ∏˙◊Ÿ‘⁄”√,A.÷¥––ø∆ “ID,A.∏Ωº” ÷ ı,D.∏Ω ı ’∑—¬ " & _
            " From (" & strAdvice & ") A,“©∆∑πÊ∏Ò B, ’∑—œÓƒøƒø¬º C, ’∑—º€ƒø D" & _
            " Where A.ID=[1] And Nvl(A.÷¥–––‘÷ ,0)<>5 And A. ’∑—œ∏ƒøID=B.“©∆∑ID" & _
            " And B.“©∆∑ID=C.ID And C.∑˛ŒÒ∂‘œÛ IN(1,3) And D. ’∑—œ∏ƒøID=C.ID" & _
            " And (C.≥∑µµ ±º‰ is NULL Or C.≥∑µµ ±º‰=To_Date('3000-01-01','YYYY-MM-DD'))" & _
            " And ((Sysdate Between D.÷¥––»’∆⁄ and D.÷’÷π»’∆⁄) or (Sysdate>=D.÷¥––»’∆⁄ And D.÷’÷π»’∆⁄ is NULL))"
            
        'Ωˆ“ª≤¢∏¯“©(»Áπ˚ «)µƒµ⁄“ª≥…“©––≤≈œ‘ æ∏¯“©Õææ∂µƒº∆º€
        blnLoad = Val(vsAdvice.TextMatrix(lngRow - 1, COL_œ‡πÿID)) <> Val(vsAdvice.TextMatrix(lngRow, COL_œ‡πÿID))
    ElseIf RowIn≈‰∑Ω––(lngRow) Then
        '÷–≤›“©:“ª∂®∂‘”¶”–πÊ∏Òº«¬º«“ÃÓ–¥¡À ’∑—œ∏ƒøID
        strSQL = "Select A.–Ú∫≈,A.’Ô¡∆¿‡±,C.¿‡± as  ’∑—¿‡±,C.ID as  ’∑—œ∏ƒøID,D. ’»ÎœÓƒøID," & _
            " Decode(A.◊‹¡ø,0,1,A.◊‹¡ø)*A.µ•¡ø/Nvl(B.º¡¡øœµ ˝,1) as  ˝¡ø," & _
            " Decode(Nvl(C. «∑Ò±‰º€,0),1,-NULL,D.œ÷º€) as µ•º€,C. «∑Ò±‰º€,C.∆¡±Œ∑—±," & _
            " 0 as ∏˙◊Ÿ‘⁄”√,A.÷¥––ø∆ “ID,A.∏Ωº” ÷ ı,D.∏Ω ı ’∑—¬ " & _
            " From (" & strAdvice & ") A,“©∆∑πÊ∏Ò B, ’∑—œÓƒøƒø¬º C, ’∑—º€ƒø D" & _
            " Where A.’Ô¡∆¿‡±='7' And A.œ‡πÿID=[1] And A. ’∑—œ∏ƒøID=B.“©∆∑ID And A. ’∑—œ∏ƒøID=C.ID" & _
            " And C.∑˛ŒÒ∂‘œÛ IN(1,3) And D. ’∑—œ∏ƒøID=C.ID And Nvl(A.÷¥–––‘÷ ,0)<>5" & _
            " And (C.≥∑µµ ±º‰ is NULL Or C.≥∑µµ ±º‰=To_Date('3000-01-01','YYYY-MM-DD'))" & _
            " And ((Sysdate Between D.÷¥––»’∆⁄ and D.÷’÷π»’∆⁄) or (Sysdate>=D.÷¥––»’∆⁄ And D.÷’÷π»’∆⁄ is NULL))"
    End If
    
    '∂¡»°º∆º€πÿœµ£∫≥˝“©∆∑°¢Œ¿≤ƒ“Ω÷ˆÕ‚µƒº∆º€,∞¸∫¨œ‡πÿ“Ω÷ˆº∆º€£ª≤ªº∆º€, ÷π§º∆º€µƒ“Ω÷ˆ≤ª∂¡»°
    If blnLoad Then
        '”…”⁄√ª”–º”≤øŒªµ»Ãıº˛£¨À˘“‘“™”√Distinct
        str’Ô¡∆ ’∑— = "Select * From (" & _
                "Select Distinct C.’Ô¡∆œÓƒøID,C. ’∑—œÓƒøID,C.ºÏ≤È≤øŒª,C.ºÏ≤È∑Ω∑®,C.∑—”√–‘÷ ,C. ’∑— ˝¡ø,C.πÃ”–∂‘’’,C.¥” ÙœÓƒø,C. ’∑—∑Ω Ω,C.  ”√ø∆ “id" & _
                " ,Max(Nvl(c.  ”√ø∆ “id, 0)) Over(Partition By c.’Ô¡∆œÓƒøid, c.ºÏ≤È≤øŒª, c.ºÏ≤È∑Ω∑®, c.∑—”√–‘÷ ) As Top" & _
                " From ’Ô¡∆ ’∑—πÿœµ C,Table(f_Num2list2([3])) D Where C.’Ô¡∆œÓƒøID=D.c1" & _
                "      And (C.  ”√ø∆ “ID is Null or C.  ”√ø∆ “ID = D.c2 And C.≤°»À¿¥‘¥ = 1)" & _
                " ) Where Nvl(  ”√ø∆ “id, 0) = Top"
                
        strSQL = strSQL & IIF(strSQL = "", "", " Union ALL") & _
            " Select A.–Ú∫≈,A.’Ô¡∆¿‡±,C.¿‡± as  ’∑—¿‡±,B. ’∑—œÓƒøID as  ’∑—œ∏ƒøID,D. ’»ÎœÓƒøID," & _
            " Decode(A.◊‹¡ø,0,1,A.◊‹¡ø)*B. ’∑— ˝¡ø as  ˝¡ø,Decode(C. «∑Ò±‰º€,1,D.»± °º€∏Ò,D.œ÷º€) as µ•º€," & _
            " C. «∑Ò±‰º€,C.∆¡±Œ∑—±,0 as ∏˙◊Ÿ‘⁄”√,A.÷¥––ø∆ “ID,A.∏Ωº” ÷ ı,D.∏Ω ı ’∑—¬ " & _
            " From (" & strAdvice & ") A,(" & str’Ô¡∆ ’∑— & ") B, ’∑—œÓƒøƒø¬º C, ’∑—º€ƒø D,’Ô¡∆œÓƒøƒø¬º E,≤…—™π‹¿‡–Õ F" & _
            " Where A.’Ô¡∆¿‡± Not IN('4','5','6','7') And A.’Ô¡∆œÓƒøID=B.’Ô¡∆œÓƒøID" & _
            " And (A.œ‡πÿID is Null And A.÷¥––±Íº« IN(1,2) And B.∑—”√–‘÷ =1" & _
            "       Or A.±Í±æ≤øŒª=B.ºÏ≤È≤øŒª And A.ºÏ≤È∑Ω∑®=B.ºÏ≤È∑Ω∑® And Nvl(B.∑—”√–‘÷ ,0)=0" & _
            "       Or (A.ºÏ≤È∑Ω∑® is Null Or e.¿‡± = 'E' And e.≤Ÿ◊˜¿‡–Õ='4') And Nvl(B.∑—”√–‘÷ ,0)=0 And B.ºÏ≤È≤øŒª is Null And B.ºÏ≤È∑Ω∑® is Null)" & _
            " And A.π‹¬ÎœÓƒøID=E.ID And E. ‘π‹±‡¬Î=F.±‡¬Î(+)" & _
            "   And (Nvl(B. ’∑—∑Ω Ω,0)=1 And C.¿‡±='4' And B. ’∑—œÓƒøID=F.≤ƒ¡œID" & _
            "       Or Not(Nvl(B. ’∑—∑Ω Ω,0)=1 And C.¿‡±='4' And F.≤ƒ¡œID Is Not NULL))" & _
            " And Nvl(A.º∆º€Ãÿ–‘,0)=0 And Nvl(A.÷¥–––‘÷ ,0) Not IN(0,5) And B. ’∑—œÓƒøID=C.ID And B. ’∑—œÓƒøID=D. ’∑—œ∏ƒøID" & _
            " And ((Sysdate Between D.÷¥––»’∆⁄ and D.÷’÷π»’∆⁄) or (Sysdate>=D.÷¥––»’∆⁄ And D.÷’÷π»’∆⁄ is NULL))" & _
            " And (C.≥∑µµ ±º‰ is NULL Or C.≥∑µµ ±º‰=To_Date('3000-01-01','YYYY-MM-DD')) And C.∑˛ŒÒ∂‘œÛ IN(1,3)" & _
            " And (C.’æµ„='" & gstrNodeNo & "' Or C.’æµ„ is Null) And (A.ID=[1] Or A.ID=[2] Or A.œ‡πÿID=[1])"
    End If
    
    strSQL = "Select /*+ RULE */ A.* From (" & strSQL & ") A Order by –Ú∫≈, ’»ÎœÓƒøID"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Name, Val(vsAdvice.RowData(lngRow)), Val(vsAdvice.TextMatrix(lngRow, COL_œ‡πÿID)), strœÓƒøø∆ “)
    If Not rsTmp.EOF Then
        'ªÒ»°º≤≤°ID°¢’Ô∂œID
        With vsDiag
            lng◊ÈID = IIF(Val(vsAdvice.TextMatrix(lngRow, COL_œ‡πÿID)) = 0, vsAdvice.RowData(lngRow), Val(vsAdvice.TextMatrix(lngRow, COL_œ‡πÿID)))
            For i = 1 To .Rows - 1
                If InStr("," & .TextMatrix(i, col“Ω÷ˆID) & ",", "," & lng◊ÈID & ",") > 0 Then
                    lngº≤≤°ID = Val(.TextMatrix(i, colº≤≤°ID))
                    lng’Ô∂œID = Val(.TextMatrix(i, col’Ô∂œID))
                    Exit For
                End If
            Next
        End With
    
        '≥ı ºªØº«¬ººØ
        Set mrsPrice = New ADODB.Recordset
        mrsPrice.Fields.Append "≤°»ÀID", adBigInt
        mrsPrice.Fields.Append "÷˜“≥ID", adBigInt, , adFldIsNullable
        mrsPrice.Fields.Append " ’∑—¿‡±", adVarChar, 1
        mrsPrice.Fields.Append " ’∑—œ∏ƒøID", adBigInt
        mrsPrice.Fields.Append " ˝¡ø", adDouble
        mrsPrice.Fields.Append "µ•º€", adDouble
        mrsPrice.Fields.Append " µ ’Ω∂Ó", adDouble
        mrsPrice.Fields.Append "ø™µ•»À", adVarChar, 100, adFldIsNullable
        mrsPrice.Fields.Append "ø™µ•ø∆ “", adVarChar, 100, adFldIsNullable
        mrsPrice.Fields.Append "º≤≤°ID", adBigInt, , adFldIsNullable
        mrsPrice.Fields.Append "’Ô∂œID", adBigInt, , adFldIsNullable
        mrsPrice.CursorLocation = adUseClient
        mrsPrice.LockType = adLockOptimistic
        mrsPrice.CursorType = adOpenStatic
        mrsPrice.Open
        
        'º”»Î∑—”√√˜œ∏
        dbl µ ’ = 0: blnDo = True
        Do While Not rsTmp.EOF
            '÷¥––ø∆ “
            If blnDo Then
                lng÷¥––ø∆ “ID = Nvl(rsTmp!÷¥––ø∆ “ID, 0)
                If rsTmp! ’∑—¿‡± = "4" And Nvl(rsTmp!∏˙◊Ÿ‘⁄”√, 0) = 1 Or InStr(",5,6,7,", rsTmp! ’∑—¿‡±) > 0 And InStr(",5,6,7,", rsTmp!’Ô¡∆¿‡±) = 0 Then
                    lng÷¥––ø∆ “ID = Get ’∑—÷¥––ø∆ “ID(mlng≤°»ÀID, 0, rsTmp! ’∑—¿‡±, rsTmp! ’∑—œ∏ƒøID, 4, mlng≤°»Àø∆ “id, 0, 2, lng÷¥––ø∆ “ID)
                End If
            End If
            
            'µ•º€
            If InStr(",5,6,7,", rsTmp! ’∑—¿‡±) > 0 And Nvl(rsTmp! «∑Ò±‰º€, 0) = 1 Then
                '“©∆∑ ±º€
                dblµ•º€ = Format(CalcDrugPrice(rsTmp! ’∑—œ∏ƒøID, lng÷¥––ø∆ “ID, Nvl(rsTmp! ˝¡ø, 0)), gstrDecPrice)
            ElseIf rsTmp! ’∑—¿‡± = "4" And Nvl(rsTmp!∏˙◊Ÿ‘⁄”√, 0) = 1 And Nvl(rsTmp! «∑Ò±‰º€, 0) = 1 Then
                '∏˙◊Ÿ‘⁄”√Œ¿≤ƒ ±º€
                dblµ•º€ = Format(CalcDrugPrice(rsTmp! ’∑—œ∏ƒøID, lng÷¥––ø∆ “ID, Nvl(rsTmp! ˝¡ø, 0)), gstrDecPrice)
            Else
                dblµ•º€ = Format(Nvl(rsTmp!µ•º€, 0), gstrDecPrice) '∆‰À˚±‰º€»°µƒ»± °º€∏Ò
            End If
            
            'Ω∂Ó
            dblΩ∂Ó = CCur(Nvl(rsTmp! ˝¡ø, 0) * dblµ•º€)
            If Nvl(rsTmp!∏Ωº” ÷ ı, 0) = 1 Then
                dblΩ∂Ó = dblΩ∂Ó * Nvl(rsTmp!∏Ω ı ’∑—¬ , 100) / 100
            End If
            dblΩ∂Ó = Format(dblΩ∂Ó, gstrDec)
            
            If Nvl(rsTmp!∆¡±Œ∑—±, 0) = 0 And mstr∑—± <> "" Then
                dblΩ∂Ó = ActualMoney(mstr∑—±, rsTmp! ’»ÎœÓƒøID, dblΩ∂Ó, rsTmp! ’∑—œ∏ƒøID, lng÷¥––ø∆ “ID, Nvl(rsTmp! ˝¡ø, 0))
            End If
            
            dbl µ ’ = dbl µ ’ + dblΩ∂Ó
            
            'œÓƒø±‰ªØ ±º”»Î
            strœÓƒø = rsTmp!–Ú∫≈ & "," & rsTmp! ’∑—œ∏ƒøID
            blnDo = False: rsTmp.MoveNext
            If Not rsTmp.EOF Then
                If rsTmp!–Ú∫≈ & "," & rsTmp! ’∑—œ∏ƒøID <> strœÓƒø Then blnDo = True
            Else
                blnDo = True
            End If
            rsTmp.MovePrevious
            
            If blnDo Then
                With vsAdvice
                    mrsPrice.AddNew
                    mrsPrice!≤°»ÀID = mlng≤°»ÀID
                    mrsPrice!÷˜“≥ID = Null
                    mrsPrice! ’∑—¿‡± = rsTmp! ’∑—¿‡±
                    mrsPrice! ’∑—œ∏ƒøID = rsTmp! ’∑—œ∏ƒøID
                    mrsPrice! ˝¡ø = Nvl(rsTmp! ˝¡ø, 0)
                    mrsPrice!µ•º€ = dblµ•º€
                    mrsPrice! µ ’Ω∂Ó = dblΩ∂Ó
                    If .TextMatrix(lngRow, COL_ø™÷ˆ“Ω…˙) <> "" Then
                        mrsPrice!ø™µ•»À = .TextMatrix(lngRow, COL_ø™÷ˆ“Ω…˙)
                    End If
                    If Val(.TextMatrix(lngRow, COL_ø™÷ˆø∆ “ID)) <> 0 Then
                        mrsPrice!ø™µ•ø∆ “ = CStr(GetItemField("≤ø√≈±Ì", Val(.TextMatrix(lngRow, COL_ø™÷ˆø∆ “ID)), "√˚≥∆"))
                    End If
                    If lngº≤≤°ID <> 0 Then mrsPrice!º≤≤°id = lngº≤≤°ID
                    If lng’Ô∂œID <> 0 Then mrsPrice!’Ô∂œid = lng’Ô∂œID
                    mrsPrice.Update
                End With
                dbl µ ’ = 0
            End If
            
            rsTmp.MoveNext
        Loop
        
        mrsPrice.MoveFirst
        MakePriceRecord = True
    End If
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Sub GetDrugStock(ByVal lngRow As Long)
'π¶ƒ‹£∫÷ÿ–¬ªÒ»°÷∏∂®“©∆∑––µƒ“©∆∑ø‚¥Ê
'≤Œ ˝£∫lngRow=Œ¿≤ƒ°¢≥…“©––ªÚ÷–“©”√∑®––
'Àµ√˜£∫»Áπ˚ «÷–“©≈‰∑Ω––,“ª¥Œ–‘ªÒ»°’˚∏ˆ≈‰∑Ω÷–µƒÀ˘”–÷–“©µƒø‚¥Ê
    Dim i As Long
    
    With vsAdvice
        If InStr(",4,5,6,", .TextMatrix(lngRow, COL_¿‡±)) > 0 Then
            If Val(.TextMatrix(lngRow, COL_÷¥––ø∆ “ID)) = 0 Or Val(.TextMatrix(lngRow, COL_ ’∑—œ∏ƒøID)) = 0 _
                Or .TextMatrix(lngRow, COL_¿‡±) = "4" And Val(.TextMatrix(lngRow, COL_∏˙◊Ÿ‘⁄”√)) = 0 Then
                .TextMatrix(lngRow, COL_ø‚¥Ê) = ""
            Else
                .TextMatrix(lngRow, COL_ø‚¥Ê) = GetStock(Val(.TextMatrix(lngRow, COL_ ’∑—œ∏ƒøID)), Val(.TextMatrix(lngRow, COL_÷¥––ø∆ “ID)), 1)
            End If
        ElseIf RowIn≈‰∑Ω––(lngRow) Then
            For i = lngRow - 1 To .FixedRows Step -1
                If Val(.TextMatrix(i, COL_œ‡πÿID)) = .RowData(lngRow) Then
                    If .TextMatrix(i, COL_¿‡±) = "7" Then
                        If Val(.TextMatrix(i, COL_÷¥––ø∆ “ID)) = 0 Or Val(.TextMatrix(i, COL_ ’∑—œ∏ƒøID)) = 0 Then
                            .TextMatrix(i, COL_ø‚¥Ê) = ""
                        Else
                            .TextMatrix(i, COL_ø‚¥Ê) = GetStock(Val(.TextMatrix(i, COL_ ’∑—œ∏ƒøID)), Val(.TextMatrix(i, COL_÷¥––ø∆ “ID)), 1)
                        End If
                    End If
                Else
                    Exit For
                End If
            Next
        End If
    End With
End Sub

Private Sub vsAdvice_AfterUserResize(ByVal Row As Long, ByVal Col As Long)
    Dim lngW As Long
    
    If Row = -1 Then
        lngW = Me.TextWidth(vsAdvice.TextMatrix(0, Col) & "A")
        If vsAdvice.ColWidth(Col) < lngW Then
            vsAdvice.ColWidth(Col) = lngW
        ElseIf vsAdvice.ColWidth(Col) > vsAdvice.Width * 0.5 Then
            vsAdvice.ColWidth(Col) = vsAdvice.Width * 0.5
        End If
        
        If Col = col_“Ω÷ˆƒ⁄»› Then Call vsAdvice.AutoSize(col_“Ω÷ˆƒ⁄»›)
    End If
End Sub

Private Sub vsAdvice_BeforeScroll(ByVal OldTopRow As Long, ByVal OldLeftCol As Long, ByVal NewTopRow As Long, ByVal NewLeftCol As Long, Cancel As Boolean)
    If dtpDate.Visible Then
        Call Form_KeyDown(vbKeyEscape, 0)
        Cancel = True
    End If
    If fraAdvice.Tag <> "" Then
        Cancel = True
    End If
End Sub

Private Sub vsAdvice_BeforeUserResize(ByVal Row As Long, ByVal Col As Long, Cancel As Boolean)
    If Row = -1 Then
        If Col <= vsAdvice.FixedCols - 1 Then
            Cancel = True
        ElseIf Col = COL_æØ æ Then 'Pass
            Cancel = True
        ElseIf Col = COL_’Ô∂œ Then
            Cancel = True
        End If
    End If
End Sub

Private Sub vsAdvice_Click()
    'PASS
    With vsAdvice
        If mblnPass Then
            If gobjPass.zlPassCheck(mobjPassMap) Then
                Call gobjPass.zlPassAdviceMainPoint(mobjPassMap, 1)
            End If
        End If
    
    End With
End Sub

Private Sub vsAdvice_DblClick()
    Dim lngRow As Long, lngCol As Long
    
    With vsAdvice
        lngRow = .MouseRow: lngCol = .MouseCol
        If lngRow >= .FixedRows And lngRow <= .Rows - 1 Then
            If lngCol = COL_’Ô∂œ Then
                Call vsAdvice_KeyPress(32)    '«–ªª’Ô∂œπÿ¡™œ‘ æ
            ElseIf lngCol >= .FixedCols And lngCol <= .Cols - 1 Then
                Call vsAdvice_KeyPress(13)    '∂®ŒªµΩ∂‘”¶µƒ±‡º≠øÿº˛
                'PASS∫œ¿Ì”√“©ºÏ≤‚
                If mblnPass Then
                    If gobjPass.zlPassCheck(mobjPassMap) Then
                        Call gobjPass.zlPassAdviceMainPoint(mobjPassMap)
                    End If
                End If
            ElseIf .MouseCol = COL_F±Í÷æ Then
                'ÃÓ–¥…Í«Î
                '##
            End If
        End If
    End With
End Sub

Private Function RowIsLastVisible(ByVal lngRow As Long) As Boolean
'π¶ƒ‹£∫≈–∂œ÷∏∂®–– «∑Ò◊Ó∫Û“ªø…º˚––
    Dim i As Long
    
    With vsAdvice
        For i = .Rows - 1 To .FixedRows Step -1
            If Not .RowHidden(i) Then Exit For
        Next
        If i >= .FixedRows Then
            RowIsLastVisible = lngRow = i
        End If
    End With
End Function

Private Sub vsAdvice_DrawCell(ByVal hDC As Long, ByVal Row As Long, ByVal Col As Long, ByVal Left As Long, ByVal Top As Long, ByVal Right As Long, ByVal Bottom As Long, Done As Boolean)
'Àµ√˜£∫1.OwnerDraw“™…Ë÷√Œ™Over(ª≠≥ˆµ•‘™À˘”–ƒ⁄»›)
'      2.CellµƒGridLine¥”…œœ¬◊Û”“œÚƒ⁄∂º «¥”µ⁄1∏˘œﬂø™ º
'      3.CellµƒBorder¥”◊Û…œ «¥”µ⁄2∏˘œﬂø™ º,”“œ¬ «¥”µ⁄1∏˘œﬂø™ º
    Dim lngLeft As Long, lngRight As Long
    Dim lngBegin As Long, lngEnd As Long
    Dim vRect As RECT
    
    With vsAdvice
        If Col <= .FixedCols - 1 Then
            '≤¡≥˝πÃ∂®¡–÷–µƒ±Ì∏Òœﬂ
            SetBkColor hDC, OS.SysColor2RGB(.BackColorFixed)

            'Ωˆ◊Û±ﬂ±Ì∏Òœﬂ
            vRect.Left = Left
            vRect.Top = Top
            vRect.Right = Left + 1
            vRect.Bottom = Bottom
            If Row = .Rows - 1 Then vRect.Bottom = vRect.Bottom - 1
            ExtTextOut hDC, vRect.Left, vRect.Top, ETO_OPAQUE, vRect, " ", 1, 0

            'Ωˆ…œ±ﬂ±Ì∏Òœﬂ
            vRect.Left = Left
            vRect.Top = Top
            vRect.Right = Right
            vRect.Bottom = Top + 1
            If Col = .FixedCols - 1 Then vRect.Right = vRect.Right - 1
            ExtTextOut hDC, vRect.Left, vRect.Top, ETO_OPAQUE, vRect, " ", 1, 0

            'Ωˆœ¬±ﬂ±Ì∏Òœﬂ
            vRect.Left = Left
            vRect.Top = Bottom - 1
            vRect.Right = Right
            vRect.Bottom = Bottom
            If RowIsLastVisible(Row) Then vRect.Bottom = vRect.Bottom - 1
            If Col = .FixedCols - 1 Then vRect.Right = vRect.Right - 1
            ExtTextOut hDC, vRect.Left, vRect.Top, ETO_OPAQUE, vRect, " ", 1, 0

            'Ωˆ”“±ﬂ±Ì∏Òœﬂ
            vRect.Left = Right - 1
            vRect.Top = Top
            vRect.Right = Right
            vRect.Bottom = Bottom
            If Row = .Rows - 1 Then vRect.Bottom = vRect.Bottom - 1
            If Col = .FixedCols - 1 Then vRect.Right = vRect.Right - 1
            ExtTextOut hDC, vRect.Left, vRect.Top, ETO_OPAQUE, vRect, " ", 1, 0
        Else
            lngLeft = COL_’Ô∂œ: lngRight = COL_ø™ º ±º‰
            If Not Between(Col, lngLeft, lngRight) Then
                lngLeft = COL_ÃÏ ˝: lngRight = COL_”√∑®
                If Not Between(Col, lngLeft, lngRight) Then Exit Sub
            End If
            
            If Not RowIn“ª≤¢∏¯“©(Row) Then Exit Sub
            If .RowData(Row) = 0 Then
                Call Get“ª≤¢∏¯“©∑∂Œß(Val(.TextMatrix(Row - 1, COL_œ‡πÿID)), lngBegin, lngEnd)
            Else
                Call Get“ª≤¢∏¯“©∑∂Œß(Val(.TextMatrix(Row, COL_œ‡πÿID)), lngBegin, lngEnd)
            End If
            
            vRect.Left = Left '≤¡≥˝◊Û±ﬂ±Ì∏Òœﬂ
            vRect.Right = Right - 1 '±£¡Ù”“±ﬂ±Ì∏Òœﬂ
            If Row = lngBegin Then
                vRect.Top = Bottom - 1 ' ◊––±£¡ÙŒƒ◊÷ƒ⁄»›
                vRect.Bottom = Bottom
            Else
                If Row = lngEnd Then
                    vRect.Top = Top
                    vRect.Bottom = Bottom - 1 'µ◊––±£¡Ùœ¬±ﬂœﬂ
                Else
                    vRect.Top = Top
                    vRect.Bottom = Bottom
                End If
            End If
            
            If Between(Row, .Row, .RowSel) Then
                SetBkColor hDC, OS.SysColor2RGB(.BackColorSel)
            Else
                SetBkColor hDC, OS.SysColor2RGB(.BackColor)
            End If
            ExtTextOut hDC, vRect.Left, vRect.Top, ETO_OPAQUE, vRect, " ", 1, 0
        End If
        Done = True
    End With
End Sub

Private Sub vsAdvice_KeyDown(KeyCode As Integer, Shift As Integer)
    If KeyCode = vbKeyDelete Then
        cbsMain.FindControl(, conMenu_Delete, True, True).Execute
    End If
End Sub

Private Sub vsAdvice_KeyPress(KeyAscii As Integer)
    Dim objEdit As Object
    Dim lngDiag As Long
    
    If KeyAscii = 13 Then
        '∂®ŒªµΩ∂‘”¶µƒ±‡º≠øÿº˛
        KeyAscii = 0
        Select Case vsAdvice.Col
            Case COL_ø™ º ±º‰
                If txtø™ º ±º‰.TabStop Then
                    Set objEdit = txtø™ º ±º‰ '»± °≤ª∂®ŒªµΩø™ º ±º‰
                Else
                    Set objEdit = txt“Ω÷ˆƒ⁄»›
                End If
            Case col_“Ω÷ˆƒ⁄»›
                Set objEdit = txt“Ω÷ˆƒ⁄»›
            Case COL_±Í±æ≤øŒª
                Set objEdit = txt∞≤≈≈ ±º‰
            Case COL_µ•¡ø
                Set objEdit = txtµ•¡ø
            Case COL_ÃÏ ˝
                Set objEdit = txtÃÏ ˝
            Case COL_◊‹¡ø
                Set objEdit = txt◊‹¡ø
            Case COL_”√∑®
                Set objEdit = txt”√∑®
            Case COL_∆µ¬ 
                Set objEdit = txt∆µ¬ 
            Case COL_÷¥–– ±º‰
                Set objEdit = cbo÷¥–– ±º‰
            Case COL_÷¥––ø∆ “ID
                Set objEdit = cbo÷¥––ø∆ “
            Case COL_“Ω…˙÷ˆÕ–
                Set objEdit = cbo“Ω…˙÷ˆÕ–
            Case COL_±Í÷æ
                Set objEdit = chkΩÙº±
            Case COL_≥¨¡øÀµ√˜
                Set objEdit = txt≥¨¡øÀµ√˜
            Case COL_”√“©ƒøµƒ
                Set objEdit = cboDruPur
            Case COL_”√“©¿Ì”…
                Set objEdit = txt”√“©¿Ì”…
        End Select
        If Not objEdit Is Nothing Then
            If objEdit.Enabled And objEdit.Visible Then objEdit.SetFocus
        End If
    ElseIf KeyAscii = 32 Then
        '«–ªª’Ô∂œπÿ¡™
        With vsAdvice
            If .Col = COL_’Ô∂œ And .RowData(.Row) <> 0 And vsDiag.TextMatrix(vsDiag.Row, col’Ô∂œ) <> "" Then
                KeyAscii = 0
                Call SetDiagFlag(.Row, IIF(AdviceHaveDiag(.Row) = vsDiag.Row, 0, 1))
            End If
        End With
    End If
End Sub

Private Sub ClearItemTag()
'π¶ƒ‹£∫«Â≥˝øÿº˛±‡º≠±Í÷æ
    txtø™ º ±º‰.Tag = ""
    txt∞≤≈≈ ±º‰.Tag = ""
    txtµ•¡ø.Tag = ""
    txtÃÏ ˝.Tag = ""
    txt◊‹¡ø.Tag = ""
    txt”√∑®.Tag = ""
    txt∆µ¬ .Tag = ""
    cbo÷¥–– ±º‰.Tag = ""
    cbo“Ω…˙÷ˆÕ–.Tag = ""
    cbo÷¥––ø∆ “.Tag = ""
    cbo÷¥–––‘÷ .Tag = ""
    cbo∏Ωº”÷¥––.Tag = ""
    chkΩÙº±.Tag = ""
    chk√‚ ‘.Tag = ""
    cboµŒÀŸ.Tag = ""
    chkZeroBilling.Tag = ""
    lbl”√“©ƒøµƒ.Tag = ""
    txt”√“©¿Ì”….Tag = ""
    txt≥¨¡øÀµ√˜.Tag = ""
    lbl≥¨¡øÀµ√˜.Tag = ""
End Sub

Private Sub SetStartTime(ByVal Editable As Boolean)
'π¶ƒ‹£∫…Ë÷√ø™ º ±º‰ «∑Ò‘ –Ì±‡º≠
    'txtø™ º ±º‰.TabStop = Editable '»± °≤ª∂®ŒªµΩø™ º ±º‰
    txtø™ º ±º‰.Locked = Not Editable
    cmdø™ º ±º‰.Enabled = Editable
    If Editable Then
        txtø™ º ±º‰.BackColor = vsAdvice.BackColor
    Else
        txtø™ º ±º‰.BackColor = &HE0E0E0
    End If
End Sub

Private Sub SetDayState(Optional ByVal intVisible As Integer, Optional ByVal intEnabled As Integer)
'π¶ƒ‹£∫…Ë÷√÷¥––ÃÏ ˝ø…”√∫ÕªÚº˚◊¥Ã¨
'≤Œ ˝£∫0-±£≥÷≤ª±‰,-1-Ω˚÷π,1-‘ –Ì
    If intEnabled = -1 Then
        txtÃÏ ˝.Enabled = False
        txtÃÏ ˝.BackColor = Me.BackColor
        txtÃÏ ˝.Text = ""
    ElseIf intEnabled = 1 Then
        txtÃÏ ˝.TabStop = True
        txtÃÏ ˝.Enabled = True
        txtÃÏ ˝.BackColor = vsAdvice.BackColor
    End If
    
    If intVisible = -1 Then
        lblÃÏ ˝.Visible = False
        txtÃÏ ˝.Visible = False
        txtÃÏ ˝.Text = ""
        
        lbl◊‹¡ø.Left = lbl”√∑®.Left + lbl”√∑®.Width - lbl◊‹¡ø.Width
        txt◊‹¡ø.Left = txt”√∑®.Left
        txt◊‹¡ø.Width = txt”√∑®.Width - cmd”√∑®.Width - 15
        lbl◊‹¡øµ•Œª.Left = txt◊‹¡ø.Left + txt◊‹¡ø.Width + 30
        
        lblµ•¡ø.Left = lbl∆µ¬ .Left + lbl∆µ¬ .Width - lblµ•¡ø.Width
        txtµ•¡ø.Left = txt∆µ¬ .Left
        txtµ•¡ø.Width = txt∆µ¬ .Width - cmd∆µ¬ .Width - 15
        lblµ•¡øµ•Œª.Left = txtµ•¡ø.Left + txtµ•¡ø.Width + 30
        
        txt◊‹¡ø.TabIndex = cmd∆µ¬ .TabIndex + 1
        txtÃÏ ˝.TabIndex = txt◊‹¡ø.TabIndex + 1
        txtµ•¡ø.TabIndex = txtÃÏ ˝.TabIndex + 1
    ElseIf intVisible = 1 Then
        lblÃÏ ˝.Visible = True
        txtÃÏ ˝.Visible = True
        
        lblµ•¡ø.Left = lbl”√∑®.Left + lbl”√∑®.Width - lblµ•¡ø.Width
        txtµ•¡ø.Left = txt”√∑®.Left
        txtµ•¡ø.Width = txt”√∑®.Width - txtÃÏ ˝.Width - Me.TextWidth("»˝∏ˆ◊÷!") - 15
        lblµ•¡øµ•Œª.Left = txtµ•¡ø.Left + txtµ•¡ø.Width + 30
        
        lbl◊‹¡ø.Left = lbl∆µ¬ .Left + lbl∆µ¬ .Width - lbl◊‹¡ø.Width
        txt◊‹¡ø.Left = txt∆µ¬ .Left
        txt◊‹¡ø.Width = txt∆µ¬ .Width - cmd∆µ¬ .Width - 15
        lbl◊‹¡øµ•Œª.Left = txt◊‹¡ø.Left + txt◊‹¡ø.Width + 30
        
        txtµ•¡ø.TabIndex = cmd∆µ¬ .TabIndex + 1
        txtÃÏ ˝.TabIndex = txtµ•¡ø.TabIndex + 1
        txt◊‹¡ø.TabIndex = txtÃÏ ˝.TabIndex + 1
    End If
End Sub

Private Sub SetItemEditable(Optional intµ•¡ø As Integer, Optional int◊‹¡ø As Integer, _
    Optional int”√∑® As Integer, Optional int∆µ¬  As Integer, _
    Optional int÷¥–– ±º‰ As Integer, Optional int÷¥––ø∆ “ As Integer, _
    Optional int÷¥–––‘÷  As Integer, Optional int∏Ωº”÷¥–– As Integer, _
    Optional int∞≤≈≈ ±º‰ As Integer, Optional intµŒÀŸ As Integer, _
    Optional int”√“©ƒøµƒ As Integer, Optional int”√“©¿Ì”… As Integer, _
    Optional int≥¨¡øÀµ√˜ As Integer, Optional int ‰—™‘≠“Ú As Integer)
'π¶ƒ‹£∫…Ë÷√÷∏∂®±‡º≠œÓµƒø…”√◊¥Ã¨
'≤Œ ˝£∫0-±£≥÷≤ª±‰,-1-Ω˚÷π,1-‘ –Ì,2-À¯∂®
'Àµ√˜£∫Ω˚÷π ±,Õ¨ ±«Â≥˝∏√œÓƒø ˝æ›(≤ª «»´≤ø)

    '“¿¥Œ…Ë÷√Œ™Ω˚÷π ±,ª·“˝∑¢Ωπµ„∏ƒ±‰,¥”∂¯ø…ƒ‹“˝∑¢Validate ¬º˛,À˘“‘œ»Ω˚÷πΩπµ„À≥–Ú
    If intµ•¡ø = -1 Then txtµ•¡ø.TabStop = False
    If int◊‹¡ø = -1 Then txt◊‹¡ø.TabStop = False
    If int”√∑® = -1 Then txt”√∑®.TabStop = False
    If int∆µ¬  = -1 Then txt∆µ¬ .TabStop = False
    If int÷¥–– ±º‰ = -1 Then cbo÷¥–– ±º‰.TabStop = False
    If int÷¥––ø∆ “ = -1 Then cbo÷¥––ø∆ “.TabStop = False
    If int÷¥–––‘÷  = -1 Then cbo÷¥–––‘÷ .TabStop = False
    If int∏Ωº”÷¥–– = -1 Then cbo∏Ωº”÷¥––.TabStop = False
     
    If int”√“©ƒøµƒ = -1 Then cboDruPur.TabStop = False
    If int”√“©¿Ì”… = -1 Then txt”√“©¿Ì”….TabStop = False
    
    If intµ•¡ø = -1 Then
        txtµ•¡ø.Enabled = False
        txtµ•¡ø.BackColor = Me.BackColor
        txtµ•¡ø.Text = ""
        lblµ•¡øµ•Œª.Caption = "" '"µ•Œª"
    ElseIf intµ•¡ø = 1 Then
        txtµ•¡ø.TabStop = True
        txtµ•¡ø.Enabled = True
        txtµ•¡ø.BackColor = vsAdvice.BackColor
    End If

    If int◊‹¡ø = -1 Then
        txt◊‹¡ø.Enabled = False
        txt◊‹¡ø.BackColor = Me.BackColor
        txt◊‹¡ø.Text = ""
        lbl◊‹¡øµ•Œª.Caption = "" '"µ•Œª"
    ElseIf int◊‹¡ø = 1 Then
        txt◊‹¡ø.TabStop = True
        txt◊‹¡ø.Enabled = True
        txt◊‹¡ø.BackColor = vsAdvice.BackColor
    End If
    
    If int”√∑® = -1 Then
        txt”√∑®.Enabled = False
        txt”√∑®.BackColor = Me.BackColor
        txt”√∑®.Text = ""
        cmd”√∑®.Enabled = False
        lbl”√∑®.Caption = "”√∑®"
    ElseIf int”√∑® = 1 Then
        txt”√∑®.TabStop = True
        txt”√∑®.Enabled = True
        cmd”√∑®.Enabled = True
        txt”√∑®.BackColor = vsAdvice.BackColor
    End If

    If int∆µ¬  = -1 Then
        txt∆µ¬ .Enabled = False
        cmd∆µ¬ .Enabled = False
        txt∆µ¬ .BackColor = Me.BackColor
        txt∆µ¬ .Text = ""
    ElseIf int∆µ¬  = 1 Then
        txt∆µ¬ .TabStop = True
        txt∆µ¬ .Enabled = True
        cmd∆µ¬ .Enabled = True
        txt∆µ¬ .BackColor = vsAdvice.BackColor
    End If

    If int÷¥–– ±º‰ = -1 Then
        cbo÷¥–– ±º‰.Text = ""
        cbo÷¥–– ±º‰.Enabled = False
        cbo÷¥–– ±º‰.BackColor = Me.BackColor
        cbo÷¥–– ±º‰.Clear
    ElseIf int÷¥–– ±º‰ = 1 Then
        cbo÷¥–– ±º‰.TabStop = True
        cbo÷¥–– ±º‰.Enabled = True
        cbo÷¥–– ±º‰.BackColor = vsAdvice.BackColor
    End If

    If int÷¥––ø∆ “ = -1 Then
        lbl÷¥––ø∆ “.Caption = "÷¥––ø∆ “"
        cbo÷¥––ø∆ “.Enabled = False
        cbo÷¥––ø∆ “.BackColor = Me.BackColor
        cbo÷¥––ø∆ “.Clear
    ElseIf int÷¥––ø∆ “ = 1 Then
        lbl÷¥––ø∆ “.Caption = "÷¥––ø∆ “"
        cbo÷¥––ø∆ “.TabStop = True
        cbo÷¥––ø∆ “.Enabled = True
        cbo÷¥––ø∆ “.BackColor = vsAdvice.BackColor
    End If

    If int÷¥–––‘÷  = -1 Then
        cbo÷¥–––‘÷ .Enabled = False
        cbo÷¥–––‘÷ .BackColor = Me.BackColor
        Call zlControl.CboSetIndex(cbo÷¥–––‘÷ .hWnd, -1) '≤ª«Â≥˝
    ElseIf int÷¥–––‘÷  = 1 Then
        cbo÷¥–––‘÷ .TabStop = True
        cbo÷¥–––‘÷ .Enabled = True
        cbo÷¥–––‘÷ .BackColor = vsAdvice.BackColor
    End If
    
    If int∏Ωº”÷¥–– = -1 Then
        lbl∏Ωº”÷¥––.Caption = "∏Ωº”÷¥––"
        cbo∏Ωº”÷¥––.Enabled = False
        cbo∏Ωº”÷¥––.BackColor = Me.BackColor
        cbo∏Ωº”÷¥––.Clear
    ElseIf int∏Ωº”÷¥–– = 1 Then
        lbl∏Ωº”÷¥––.Caption = "∏Ωº”÷¥––"
        cbo∏Ωº”÷¥––.TabStop = True
        cbo∏Ωº”÷¥––.Enabled = True
        cbo∏Ωº”÷¥––.BackColor = vsAdvice.BackColor
    End If
    
    If int∞≤≈≈ ±º‰ = -1 Then
        txt∞≤≈≈ ±º‰.Text = ""
        lbl∞≤≈≈ ±º‰.Visible = False
        txt∞≤≈≈ ±º‰.Visible = False
        cmd∞≤≈≈ ±º‰.Visible = False
        lbl”√∑®.Visible = True
        txt”√∑®.Visible = True
        cmd”√∑®.Visible = True
    ElseIf int∞≤≈≈ ±º‰ = 1 Then
        lbl∞≤≈≈ ±º‰.Visible = True
        txt∞≤≈≈ ±º‰.Visible = True
        cmd∞≤≈≈ ±º‰.Visible = True
        lbl”√∑®.Visible = False
        txt”√∑®.Visible = False
        cmd”√∑®.Visible = False
    End If
    
    If intµŒÀŸ = -1 Then
        cboµŒÀŸ.Text = ""
        lblµŒÀŸ.Visible = False
        cboµŒÀŸ.Visible = False
        lblµŒÀŸµ•Œª.Visible = False
    ElseIf intµŒÀŸ = 1 Then
        lblµŒÀŸ.Visible = True
        cboµŒÀŸ.Visible = True
        lblµŒÀŸµ•Œª.Visible = True
    End If
    
    '»± °≤ª—°÷–
    If int”√“©ƒøµƒ = -1 Then
        Call zlControl.CboSetIndex(cboDruPur.hWnd, 0)
        cboDruPur.Enabled = True
    ElseIf int”√“©ƒøµƒ = 1 Then
        Call zlControl.CboSetIndex(cboDruPur.hWnd, 0)
        cboDruPur.Enabled = True
        cboDruPur.TabStop = True
    End If
        
    If int”√“©¿Ì”… = -1 Then
        txt”√“©¿Ì”….Text = ""   '√ª”–“˛≤ÿ£¨À˘“‘–Ë“™«Âø’
        txt”√“©¿Ì”….Enabled = False
        txt”√“©¿Ì”….BackColor = Me.BackColor
        cmd ’≤ÿ”√“©¿Ì”….Enabled = False
        cmdReason.Enabled = False
    ElseIf int”√“©¿Ì”… = 1 Then
        txt”√“©¿Ì”….Enabled = True
        txt”√“©¿Ì”….TabStop = True
        txt”√“©¿Ì”….BackColor = vsAdvice.BackColor
        cmd ’≤ÿ”√“©¿Ì”….Enabled = True
        cmdReason.Enabled = True
    End If
    
    If int≥¨¡øÀµ√˜ = -1 Then
        txt≥¨¡øÀµ√˜.Text = ""   '√ª”–“˛≤ÿ£¨À˘“‘–Ë“™«Âø’
        txt≥¨¡øÀµ√˜.Enabled = False
        txt≥¨¡øÀµ√˜.BackColor = Me.BackColor
        cmdExcReason.Enabled = False
        cmdComExcReason.Enabled = False
    ElseIf int≥¨¡øÀµ√˜ = 1 Then
        txt≥¨¡øÀµ√˜.Enabled = True
        txt≥¨¡øÀµ√˜.TabStop = True
        txt≥¨¡øÀµ√˜.BackColor = vsAdvice.BackColor
        cmdExcReason.Enabled = True
        cmdComExcReason.Enabled = True
    End If
    
    '=1 ‰—™“Ω÷ˆ£¨œ‘ æ ‰—™‘≠“Ú
    If int ‰—™‘≠“Ú = -1 Then
        lbl”√“©ƒøµƒ.Visible = True
        cboDruPur.Visible = True
        cmdReason.Visible = True
        cmd ’≤ÿ”√“©¿Ì”….Visible = True
        lbl”√“©¿Ì”….Caption = "”√“©¿Ì”…"
    ElseIf int ‰—™‘≠“Ú = 1 Then
        lbl”√“©ƒøµƒ.Visible = False
        cboDruPur.Visible = False
        cmdReason.Visible = False
        cmd ’≤ÿ”√“©¿Ì”….Visible = False
        lbl”√“©¿Ì”….Caption = " ‰—™‘≠“Ú"
    End If
End Sub

Private Function Get∫œÕ¨µ•ŒªID() As Long
'π¶ƒ‹£∫ªÒ»°µ±«∞≤°»Àµƒ∫œÕ¨µ•ŒªID
    Dim rsTmp As ADODB.Recordset, strSQL As String
 
    strSQL = "Select Nvl(∫œÕ¨µ•ŒªID,0) as ∫œÕ¨µ•ŒªID From ≤°»À–≈œ¢ Where ≤°»ÀID = [1]"
    On Error GoTo errH
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng≤°»ÀID)
    
    If rsTmp.RecordCount > 0 Then Get∫œÕ¨µ•ŒªID = rsTmp!∫œÕ¨µ•ŒªID
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function


Private Function Get’Ô∂œ√Ë ˆ(ByVal lng’Ô∂œID As Long, ByVal lngº≤≤°ID As Long) As String
'π¶ƒ‹£∫∏˘æ›’Ô∂œIDªÚº≤≤°IDªÒ»°◊÷µ‰±Ì÷–µƒ√˚≥∆£®≤°»À’Ô∂œº«¬º÷–µƒ√˚≥∆ø…“‘ «–ﬁ∏ƒ∫Ûµƒ,‘ –Ìº”«∞◊∫ªÚ∫Û◊∫£©£¨“‘±„‘Ÿ¥Œ–ﬁ∏ƒ ±≈–∂œ
    Dim rsTmp As ADODB.Recordset, strSQL As String
    
    On Error GoTo errH
    If lng’Ô∂œID <> 0 Then
        strSQL = "Select √˚≥∆ From º≤≤°’Ô∂œƒø¬º Where ID = [1]"
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, gstrSysName, lng’Ô∂œID)
        If rsTmp.RecordCount > 0 Then Get’Ô∂œ√Ë ˆ = "" & rsTmp!√˚≥∆
    ElseIf lngº≤≤°ID <> 0 Then
        strSQL = "Select √˚≥∆ From º≤≤°±‡¬Îƒø¬º Where ID = [1]"
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, gstrSysName, lngº≤≤°ID)
        If rsTmp.RecordCount > 0 Then Get’Ô∂œ√Ë ˆ = "" & rsTmp!√˚≥∆
    End If
    
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Function GetPatiInfo() As Boolean
'π¶ƒ‹£∫∂¡»°≤°»À–≈œ¢
    Dim rsTmp As ADODB.Recordset
    Dim rsSub As ADODB.Recordset
    Dim strSQL As String, i As Long
    Dim strTmp As String
    Dim blnMsgOk As Boolean
    
    On Error GoTo errH
    
    strSQL = "Select A.ID,a.º±’Ô,a.∏¥’Ô,A.–’√˚,A.–‘±,A.ƒÍ¡‰,B.≥ˆ…˙»’∆⁄,B.√≈’Ô∫≈,B.∑—±,B.“Ω¡∆∏∂øÓ∑Ω Ω," & _
        " Nvl(D.‘§Ωª”‡∂Ó,0)-Nvl(D.∑—”√”‡∂Ó,0) as ‘§ΩªøÓ,B.œ’¿‡,B.æÕ’Ô’Ô “,A.µ«º« ±º‰," & _
        " A.÷¥––≤ø√≈ID as ≤°»Àø∆ “ID,b.…Ì∑›÷§∫≈" & _
        " From ≤°»Àπ“∫≈º«¬º A,≤°»À–≈œ¢ B,≤°»À”‡∂Ó D" & _
        " Where A.NO=[1] And a.º«¬º–‘÷ =1 And a.º«¬º◊¥Ã¨=1 And A.≤°»ÀID+0=[2]" & _
        " And A.≤°»ÀID=B.≤°»ÀID And B.≤°»ÀID=D.≤°»ÀID(+) And D.–‘÷ (+)=1 And D.¿‡–Õ(+) = 1"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mstrπ“∫≈µ•, mlng≤°»ÀID)
    
    lblPati.Caption = _
        "–’√˚£∫" & rsTmp!–’√˚ & "°°–‘±£∫" & Nvl(rsTmp!–‘±) & "°°ƒÍ¡‰£∫" & Nvl(rsTmp!ƒÍ¡‰) & _
        "°°∑—±£∫" & Nvl(rsTmp!∑—±) & "°° “Ω¡∆∏∂øÓ∑Ω Ω£∫" & Nvl(rsTmp!“Ω¡∆∏∂øÓ∑Ω Ω) & "°°‘§ΩªøÓ£∫" & Format(Nvl(rsTmp!‘§ΩªøÓ, 0), "0.00")
    lblPati.Tag = rsTmp!–’√˚ '”√”⁄“Ω÷ˆ∏¥÷∆Ã· æ
    
    '≤°»Àµƒ◊º»∑ƒÍ¡‰:”√”⁄≈–∂œ
    mlngπ“∫≈ID = rsTmp!ID
    If mblnPass Then
        If gobjPass.zlPassCheck(mobjPassMap) Then
            mdbl√≈’Ô∫≈ = Val(rsTmp!√≈’Ô∫≈ & "")
        End If
    End If
    mintƒÍ¡‰ = GetPatiYear(mlng≤°»ÀID)
    If IsNull(rsTmp!≥ˆ…˙»’∆⁄) Then
        mDat≥ˆ…˙»’∆⁄ = DateAdd("yyyy", -mintƒÍ¡‰, zlDatabase.Currentdate)
    Else
        mDat≥ˆ…˙»’∆⁄ = rsTmp!≥ˆ…˙»’∆⁄
    End If
    mstr–’√˚ = rsTmp!–’√˚
    mstr…Ì∑›÷§∫≈ = "" & rsTmp!…Ì∑›÷§∫≈
    
    mstr–‘± = Nvl(rsTmp!–‘±)
    mstr∑—± = Nvl(rsTmp!∑—±)
    mdatπ“∫≈ ±º‰ = rsTmp!µ«º« ±º‰
    mlng≤°»Àø∆ “id = rsTmp!≤°»Àø∆ “id
    mstr∏∂øÓ¬Î = Get“Ω¡∆∏∂øÓ¬Î(Nvl(rsTmp!“Ω¡∆∏∂øÓ∑Ω Ω))
    mbln÷–“Ω = Have≤ø√≈–‘÷ (rsTmp!≤°»Àø∆ “id, "÷–“Ωø∆")
    mbytPatiType = IIF(Val(Nvl(rsTmp!º±’Ô)) = 0, 1, 2)
    mbln∏¥’Ô = Val(rsTmp!∏¥’Ô & "") <> 0
    
    'PASS ¥´»À≤°»À–≈œ¢
    If mblnPass Then
        If gobjPass.zlPassCheck(mobjPassMap) Then
            Call zlPASSPati
        End If
    End If
    '±£œ’≤°»À”√∫Ï…´œ‘ æ
    mintœ’¿‡ = 0
    If Not IsNull(rsTmp!œ’¿‡) Then
        mintœ’¿‡ = rsTmp!œ’¿‡
        lblPati.ForeColor = vbRed
    End If

    mblnÃ·–—∂‘¬Î = True
    
    '’Ô∂œ∂‘”¶“Ω÷ˆ
    strSQL = "Select B.’Ô∂œID,B.“Ω÷ˆID From ≤°»À’Ô∂œº«¬º A,≤°»À’Ô∂œ“Ω÷ˆ B" & _
        " Where A.ID=B.’Ô∂œID And A.º«¬º¿¥‘¥=3 And A.’Ô∂œ¿‡–Õ IN(1,11) And A.»°œ˚ ±º‰ is Null And A.≤°»ÀID=[1] And A.÷˜“≥ID=[2]"
    Set rsSub = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng≤°»ÀID, mlngπ“∫≈ID)
    
    '≤°»À’Ô∂œ–≈œ¢
    Set vsDiag.Cell(flexcpPicture, 0, col±Í÷æ) = img16.ListImages("’Ô∂œ_µ±«∞").Picture
    vsDiag.Cell(flexcpPictureAlignment, 0, col±Í÷æ) = 4
    
    strSQL = "Select A.ID,A.º«¬º¿¥‘¥,A.’Ô∂œ¥Œ–Ú,A.’Ô∂œ¿‡–Õ,A.º≤≤°ID,A.’Ô∂œID,A.÷§∫ÚID,A.’Ô∂œ√Ë ˆ,A. «∑Ò“…’Ô, a.º«¬º»’∆⁄, a.º«¬º»À,B.±‡¬Î as ICD¬Î,c.±‡¬Î as ’Ô∂œ±‡¬Î,d.±‡¬Î as ÷§∫Ú±‡¬Î,A.∑¢≤° ±º‰," & _
        " b.∏Ω¬Î As º≤≤°∏Ω¬Î, b.¿‡± As º≤≤°¿‡±,d.√˚≥∆ As ÷§∫Ú√˚≥∆ From ≤°»À’Ô∂œº«¬º A,º≤≤°±‡¬Îƒø¬º B, º≤≤°’Ô∂œƒø¬º C,º≤≤°±‡¬Îƒø¬º D" & _
        " Where A.º≤≤°ID=B.ID(+)  And a.’Ô∂œid = c.Id(+) And  a.÷§∫ÚID=d.ID(+)  And A.º«¬º¿¥‘¥ IN(1,3) And A.’Ô∂œ¿‡–Õ IN(1,11)" & _
        " And A.»°œ˚ ±º‰ is Null And A.≤°»ÀID=[1] And A.÷˜“≥ID=[2]" & _
        " Order by A.’Ô∂œ¿‡–Õ,A.’Ô∂œ¥Œ–Ú,a.±‡¬Î–Ú∫≈"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng≤°»ÀID, mlngπ“∫≈ID)
    If Not mclsMipModule Is Nothing Then
        blnMsgOk = mclsMipModule.IsConnect
    End If
    If blnMsgOk Then
        Set mrs’Ô∂œ = New ADODB.Recordset
        mrs’Ô∂œ.Fields.Append "id", adBigInt
        mrs’Ô∂œ.Fields.Append "œ‘ æ±‡¬Î", adVarChar, 120
        mrs’Ô∂œ.Fields.Append "’Ô∂œ±‡¬Î", adVarChar, 120
        mrs’Ô∂œ.Fields.Append "º≤≤°±‡¬Î", adVarChar, 120
        mrs’Ô∂œ.Fields.Append "◊¥Ã¨", adBigInt '0-‘≠ ºº«¬º£¨1-±ª–ﬁ∏ƒ£¨2-–¬‘ˆµƒº«¬º
        mrs’Ô∂œ.CursorLocation = adUseClient
        mrs’Ô∂œ.LockType = adLockOptimistic
        mrs’Ô∂œ.CursorType = adOpenStatic
        mrs’Ô∂œ.Open
    End If
    
    If Not rsTmp.EOF Then
        'Œ˜“Ω’Ô∂œ
        rsTmp.Filter = "º«¬º¿¥‘¥=3 " & IIF(Not mbln÷–“Ω, " And ’Ô∂œ¿‡–Õ=1", "") ' ◊“≥±æ…ÌÃÓ–¥µƒ
        If rsTmp.EOF Then rsTmp.Filter = "º«¬º¿¥‘¥<>3" & IIF(Not mbln÷–“Ω, " And ’Ô∂œ¿‡–Õ=1", "") '∆‰À¸¿¥‘¥µƒ◊˜Œ™»± °œ‘ æ
        With vsDiag
            Set mrsDiag = zlDatabase.CopyNewRec(rsTmp)
            If Not rsTmp.EOF Then
                .Rows = rsTmp.RecordCount + 1
                For i = 1 To rsTmp.RecordCount
                    Call SetDiagType(i, rsTmp!’Ô∂œ¿‡–Õ)
                    
                    If IsNull(rsTmp!’Ô∂œ√Ë ˆ) Then
                        .TextMatrix(i, col±‡¬Î) = ""
                        .TextMatrix(i, col’Ô∂œ) = ""
                    Else
                        If Mid(rsTmp!’Ô∂œ√Ë ˆ, 1, 1) <> "(" Or (Val(rsTmp!’Ô∂œid & "") = 0 And Val(rsTmp!º≤≤°id & "") = 0) Then '÷–“Ωµƒ’Ô∂œ√Ë ˆ∫Û√Êº”¡À£®∫Ú÷¢£©£¨À˘“‘÷ª≈–∂œµ⁄“ª∏ˆ◊÷∑˚
                            '”…”⁄º≤≤°±‡¬Î∫Õ’Ô∂œø…“‘∂‘”¶£¨»Áπ˚¡Ω∏ˆ∂º≤ªŒ™ø’µƒ ±∫Ú£¨œ»≈–∂œº≤≤°±‡¬Î£¨œ»»°º≤≤°±‡¬Î
                            If Val(rsTmp!º≤≤°id & "") <> 0 Then
                                .TextMatrix(i, col±‡¬Î) = Nvl(rsTmp!ICD¬Î)
                            ElseIf Val(rsTmp!’Ô∂œid & "") <> 0 Then
                                .TextMatrix(i, col±‡¬Î) = Nvl(rsTmp!’Ô∂œ±‡¬Î)
                            Else
                                .TextMatrix(i, col±‡¬Î) = ""
                            End If
                            .TextMatrix(i, col’Ô∂œ) = rsTmp!’Ô∂œ√Ë ˆ
                        Else
                            .TextMatrix(i, col±‡¬Î) = Mid(rsTmp!’Ô∂œ√Ë ˆ, 2, InStr(rsTmp!’Ô∂œ√Ë ˆ, ")") - 2)
                            .TextMatrix(i, col’Ô∂œ) = Mid(rsTmp!’Ô∂œ√Ë ˆ, InStr(rsTmp!’Ô∂œ√Ë ˆ, ")") + 1)
                        End If
                    End If
                    
                    '»°÷§∫Ú√˚≥∆
                    If InStr(.TextMatrix(i, col’Ô∂œ), "(") > 0 And InStr(.TextMatrix(i, col’Ô∂œ), ")") > 0 And Val(rsTmp!’Ô∂œ¿‡–Õ & "") = 11 Then
                        strTmp = Mid(.TextMatrix(i, col’Ô∂œ), InStrRev(.TextMatrix(i, col’Ô∂œ), "(") + 1)
                        strTmp = Mid(strTmp, 1, Len(strTmp) - 1)
                        'œ»»°÷§∫Ú
                        .TextMatrix(i, col÷–“Ω÷§∫Ú) = strTmp
                        '»•µÙ’Ô∂œ√Ë ˆµƒ÷§∫Ú
                        .TextMatrix(i, col’Ô∂œ) = Mid(.TextMatrix(i, col’Ô∂œ), 1, InStrRev(.TextMatrix(i, col’Ô∂œ), "(") - 1)
                    Else
                       .TextMatrix(i, col÷–“Ω÷§∫Ú) = ""
                    End If
                    If Not IsNull(rsTmp!º≤≤°id) Or Not IsNull(rsTmp!’Ô∂œid) Then
                        .Cell(flexcpData, i, col’Ô∂œ) = Get’Ô∂œ√Ë ˆ(Val("" & rsTmp!’Ô∂œid), Val("" & rsTmp!º≤≤°id))    'ªÒ»°‘≠ º√˚≥∆“‘±„–ﬁ∏ƒ ±≈–∂œ
                    Else
                        .Cell(flexcpData, i, col’Ô∂œ) = .TextMatrix(i, col’Ô∂œ)
                    End If
                    
                    .Cell(flexcpData, i, col“…’Ô) = Val(Nvl(rsTmp! «∑Ò“…’Ô, 0))
                    .Cell(flexcpForeColor, i, col“…’Ô) = IIF(Nvl(rsTmp! «∑Ò“…’Ô, 0) = 1, vbRed, .GridColor)
                    .TextMatrix(i, col’Ô∂œID) = Nvl(rsTmp!’Ô∂œid, 0)
                    .Cell(flexcpData, i, col’Ô∂œID) = Nvl(rsTmp!ID, 0)
                    .TextMatrix(i, colº≤≤°ID) = Nvl(rsTmp!º≤≤°id, 0)
                    .TextMatrix(i, col÷§∫ÚID) = Nvl(rsTmp!÷§∫Úid, 0)
                    .TextMatrix(i, colICD¬Î) = Nvl(rsTmp!ICD¬Î)
                    .TextMatrix(i, col∑¢≤° ±º‰) = Format(rsTmp!∑¢≤° ±º‰ & "", "YYYY-MM-DD HH:mm")
                  
                    .TextMatrix(i, col’Ô∂œ±‡¬Î) = Nvl(rsTmp!’Ô∂œ±‡¬Î)
                    .TextMatrix(i, colº≤≤°±‡¬Î) = Nvl(rsTmp!ICD¬Î)
                    .TextMatrix(i, colº≤≤°¿‡±) = Nvl(rsTmp!º≤≤°¿‡±)
                    .TextMatrix(i, colº≤≤°∏Ω¬Î) = Nvl(rsTmp!º≤≤°∏Ω¬Î)
                    .TextMatrix(i, col÷§∫Ú±‡¬Î) = Nvl(rsTmp!÷§∫Ú±‡¬Î)
                    
                    If blnMsgOk Then
                        mrs’Ô∂œ.AddNew
                        mrs’Ô∂œ!ID = rsTmp!ID
                        mrs’Ô∂œ!œ‘ æ±‡¬Î = .TextMatrix(i, col±‡¬Î)
                        mrs’Ô∂œ!’Ô∂œ±‡¬Î = .TextMatrix(i, col’Ô∂œ±‡¬Î)
                        mrs’Ô∂œ!º≤≤°±‡¬Î = .TextMatrix(i, colº≤≤°±‡¬Î)
                        mrs’Ô∂œ!◊¥Ã¨ = 0
                        mrs’Ô∂œ.Update
                    End If
                    
                    'ÃÓ–¥∂‘”¶µƒπÿ¡™“Ω÷ˆ
                    strSQL = ""
                    rsSub.Filter = "’Ô∂œID=" & rsTmp!ID
                    Do While Not rsSub.EOF
                        strSQL = strSQL & "," & rsSub!“Ω÷ˆID
                        rsSub.MoveNext
                    Loop
                    .TextMatrix(i, col“Ω÷ˆID) = Mid(strSQL, 2)
                    rsTmp.MoveNext
                Next
            End If
        End With
    Else
        Call SetDiagType(1, IIF(mbln÷–“Ω, 11, 1))
    End If
    
    'Œ˜“Ω ±÷ª ‰»ÎŒ˜“Ω’Ô∂œ
    vsDiag.ColHidden(col÷–“Ω) = Not mbln÷–“Ω
    vsDiag.ColHidden(COLŒ˜“Ω) = Not mbln÷–“Ω
    vsDiag.ColHidden(col÷–“Ω÷§∫Ú) = Not mbln÷–“Ω
    vsDiag.ColWidth(col’Ô∂œ) = IIF(mbln÷–“Ω, 2760, 4360)
    vsDiag.ColHidden(COLDEL) = False
    vsDiag.ColWidth(COLDEL) = vsDiag.ColWidth(col‘ˆº”)
 
    vsDiag.Col = col’Ô∂œ: vsDiag.Row = vsDiag.Rows - 1
    Call vsDiag_AfterRowColChange(-1, -1, vsDiag.Row, vsDiag.Col)
    Call SetDiagHeight
    'PASS’Ô∂œ¥´»À
    If mblnPass Then
        zlPassDrags
    End If
    GetPatiInfo = True
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Sub SetDiagType(ByVal lngRow As Long, ByVal int’Ô∂œ¿‡–Õ As Integer)
'π¶ƒ‹£∫…Ë÷√ƒ≥“ª’Ô∂œ––µƒ’Ô∂œ¿‡–Õ
    With vsDiag
        .TextMatrix(lngRow, col÷–“Ω) = "÷–"
        .TextMatrix(lngRow, COLŒ˜“Ω) = "Œ˜"
        
        .Cell(flexcpData, lngRow, col÷–“Ω) = IIF(int’Ô∂œ¿‡–Õ = 11, 1, 0)
        .Cell(flexcpForeColor, lngRow, col÷–“Ω) = IIF(int’Ô∂œ¿‡–Õ = 11, .ForeColor, .GridColor)
        .Cell(flexcpFontBold, lngRow, col÷–“Ω) = IIF(int’Ô∂œ¿‡–Õ = 11, True, False)
        
        .Cell(flexcpData, lngRow, COLŒ˜“Ω) = IIF(int’Ô∂œ¿‡–Õ = 1, 1, 0)
        .Cell(flexcpForeColor, lngRow, COLŒ˜“Ω) = IIF(int’Ô∂œ¿‡–Õ = 1, .ForeColor, .GridColor)
        .Cell(flexcpFontBold, lngRow, COLŒ˜“Ω) = IIF(int’Ô∂œ¿‡–Õ = 1, True, False)
    End With
End Sub

Private Function GetPreRow(ByVal lngRow As Long) As Long
'π¶ƒ‹£∫»°…œ“ª◊ÓΩ¸”––ßø…º˚––
'∑µªÿ£∫Œﬁ”––ß–– ±,∑µªÿ-1
    Dim lngTmp As Long, i As Long
    
    lngTmp = -1
    For i = lngRow - 1 To vsAdvice.FixedRows Step -1
        If vsAdvice.RowData(i) <> 0 And Not vsAdvice.RowHidden(i) Then
            lngTmp = i: Exit For
        End If
    Next
    GetPreRow = lngTmp
End Function

Private Function GetNextRow(ByVal lngRow As Long) As Long
'π¶ƒ‹£∫»°œ¬“ª◊ÓΩ¸”––ßø…º˚––
'∑µªÿ£∫Œﬁ”––ß–– ±,∑µªÿ-1
    Dim lngTmp As Long, i As Long
    
    lngTmp = -1
    For i = lngRow + 1 To vsAdvice.Rows - 1
        If vsAdvice.RowData(i) <> 0 And Not vsAdvice.RowHidden(i) Then
            lngTmp = i: Exit For
        End If
    Next
    GetNextRow = lngTmp
End Function

Private Function GetDefaultTime(lngRow As Long) As String
'π¶ƒ‹£∫ªÒ»°–¬ø™“Ω÷ˆµƒ»± °ø™ º ±º‰
'Àµ√˜£∫
'      ◊ÓΩ¸“ªÃı”––ß ±º‰Œ™µ±ÃÏ£¨«“º‰∏Ùœ÷‘⁄‘⁄≤π¬ºº‰∏Ù“‘ƒ⁄
'      »Áπ˚√ª”–,‘Ú»°◊ÓΩ¸–¬ø™“ªÃıµƒ ±º‰
'      »Áπ˚√ª”–,‘Ú»°µ±«∞ ±º‰
    Dim curDate As Date, strDate As String, i As Long
    
    curDate = zlDatabase.Currentdate
    
    With vsAdvice
        'œ»¥”µ±«∞––œÚªÿ’“
        For i = lngRow - 1 To .FixedRows Step -1
            If .RowData(i) <> 0 And Not .RowHidden(i) And IsDate(.Cell(flexcpData, i, COL_ø™ º ±º‰)) Then
                If Format(.Cell(flexcpData, i, COL_ø™ º ±º‰), "yyyy-MM-dd") = Format(curDate, "yyyy-MM-dd") Then
                    If DateAdd("n", gint√≈’Ô–¬ø™“Ω÷ˆº‰∏Ù, CDate(.Cell(flexcpData, i, COL_ø™ º ±º‰))) >= curDate Then
                        strDate = Format(.Cell(flexcpData, i, COL_ø™ º ±º‰), "yyyy-MM-dd HH:mm")
                        Exit For
                    End If
                End If
            End If
        Next
            
        '‘Ÿ¥”◊Ó∫Û––œÚªÿ’“
        If strDate = "" Then
            For i = .Rows - 1 To lngRow + 1 Step -1
                If .RowData(i) <> 0 And Not .RowHidden(i) And IsDate(.Cell(flexcpData, i, COL_ø™ º ±º‰)) Then
                    If Format(.Cell(flexcpData, i, COL_ø™ º ±º‰), "yyyy-MM-dd") = Format(curDate, "yyyy-MM-dd") Then
                        If DateAdd("n", gint√≈’Ô–¬ø™“Ω÷ˆº‰∏Ù, CDate(.Cell(flexcpData, i, COL_ø™ º ±º‰))) >= curDate Then
                            strDate = Format(.Cell(flexcpData, i, COL_ø™ º ±º‰), "yyyy-MM-dd HH:mm")
                            Exit For
                        End If
                    End If
                End If
            Next
        End If
        
        If strDate = "" Then
            'œ»¥”µ±«∞––œÚªÿ’“
            For i = lngRow - 1 To .FixedRows Step -1
                If .RowData(i) <> 0 And Not .RowHidden(i) And IsDate(.Cell(flexcpData, i, COL_ø™ º ±º‰)) _
                    And Val(.TextMatrix(i, COL_EDIT)) = 1 Then
                    strDate = Format(.Cell(flexcpData, i, COL_ø™ º ±º‰), "yyyy-MM-dd HH:mm")
                    Exit For
                End If
            Next
            '‘Ÿ¥”◊Ó∫Û––œÚªÿ’“
            If strDate = "" Then
                For i = .Rows - 1 To lngRow + 1 Step -1
                    If .RowData(i) <> 0 And Not .RowHidden(i) And IsDate(.Cell(flexcpData, i, COL_ø™ º ±º‰)) _
                        And Val(.TextMatrix(i, COL_EDIT)) = 1 Then
                        strDate = Format(.Cell(flexcpData, i, COL_ø™ º ±º‰), "yyyy-MM-dd HH:mm")
                        Exit For
                    End If
                Next
            End If
        End If
    End With
    If strDate = "" Then strDate = Format(curDate, "yyyy-MM-dd HH:mm")
    GetDefaultTime = strDate
End Function

Private Function GetCurRow–Ú∫≈(lngRow As Long) As Long
'π¶ƒ‹£∫ªÒ»°÷∏∂®––ø…”√µƒµƒ–Ú∫≈
'≤Œ ˝£∫lngRow=“™»°–Ú∫≈µƒ––
    Dim rsTmp As New ADODB.Recordset
    Dim strSQL As String, lng–Ú∫≈ As Long, i As Long
    Dim lng–Ú∫≈1 As Long, lng–Ú∫≈2 As Long
            
    '»°÷Æ∫Û◊ÓΩ¸“ª∏ˆ”––ß–Ú∫≈,÷±Ω” π”√
    For i = lngRow + 1 To vsAdvice.Rows - 1
        If vsAdvice.RowData(i) <> 0 Then
            If Val(vsAdvice.TextMatrix(i, COL_”§∂˘)) = cbo”§∂˘.ListIndex _
                And IsNumeric(vsAdvice.TextMatrix(i, COL_–Ú∫≈)) Then
                lng–Ú∫≈ = Val(vsAdvice.TextMatrix(i, COL_–Ú∫≈))
                Exit For
            End If
        End If
    Next
    If lng–Ú∫≈ = 0 Then
        '∫Û√Ê√ª”–,‘Ú»° ˝æ›ø‚÷Æ÷–µƒ◊Ó¥Û–Ú∫≈”Î÷Æ«∞µƒ◊Ó¥Û–Ú∫≈±»Ωœ
        On Error GoTo errH
        strSQL = "Select Max(–Ú∫≈) as –Ú∫≈ From ≤°»À“Ω÷ˆº«¬º Where ≤°»ÀID+0=[1] And π“∫≈µ•=[2] And Nvl(”§∂˘,0)=[3]"
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng≤°»ÀID, mstrπ“∫≈µ•, cbo”§∂˘.ListIndex)
        If Not rsTmp.EOF Then lng–Ú∫≈1 = Nvl(rsTmp!–Ú∫≈, 0)
        On Error GoTo 0
        
        For i = lngRow - 1 To vsAdvice.FixedRows Step -1
            If vsAdvice.RowData(i) <> 0 Then
                If Val(vsAdvice.TextMatrix(i, COL_”§∂˘)) = cbo”§∂˘.ListIndex _
                    And IsNumeric(vsAdvice.TextMatrix(i, COL_–Ú∫≈)) Then
                    lng–Ú∫≈2 = Val(vsAdvice.TextMatrix(i, COL_–Ú∫≈))
                    Exit For
                End If
            End If
        Next
        
        If lng–Ú∫≈1 > lng–Ú∫≈2 Then
            lng–Ú∫≈ = lng–Ú∫≈1
        Else
            lng–Ú∫≈ = lng–Ú∫≈2
        End If

        If lng–Ú∫≈ <> 0 Then lng–Ú∫≈ = lng–Ú∫≈ + 1 '◊Ó¥Û–Ú∫≈+1
    End If
    If lng–Ú∫≈ = 0 Then lng–Ú∫≈ = 1
    GetCurRow–Ú∫≈ = lng–Ú∫≈
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Sub AdviceSet“Ω÷ˆ–Ú∫≈(lngRow As Long, intStep As Integer)
'π¶ƒ‹£∫Ω´µ±«∞≤°»À“Ω÷ˆº«¬º÷––Ú∫≈«∞“∆ªÚ∫Û“∆
'≤Œ ˝£∫lngRow=∆ ºµ˜’˚––,intStep=µ˜’˚≤Ω≥§,»Á1ªÚ-1
    Dim i As Long
    
    For i = lngRow To vsAdvice.Rows - 1
        If vsAdvice.RowData(i) <> 0 Then
            If Val(vsAdvice.TextMatrix(i, COL_”§∂˘)) = cbo”§∂˘.ListIndex _
                And IsNumeric(vsAdvice.TextMatrix(i, COL_–Ú∫≈)) Then
                vsAdvice.TextMatrix(i, COL_–Ú∫≈) = Val(vsAdvice.TextMatrix(i, COL_–Ú∫≈)) + intStep
                If Val(vsAdvice.TextMatrix(i, COL_EDIT)) = 0 Then
                    vsAdvice.TextMatrix(i, COL_EDIT) = 3 '±Í÷æ–ﬁ∏ƒ¡À–Ú∫≈
                End If
            End If
        End If
    Next
End Sub

Private Sub AdviceDelete(ByVal lngRow As Long)
'π¶ƒ‹£∫÷∏∂®µƒ“Ω÷ˆ…æ≥˝¥¶¿Ì
    Dim lngBegin As Long, lngEnd As Long
    Dim lngœ‡πÿID As Long, blnGroup As Boolean
    Dim lng“Ω÷ˆID As Long, i As Integer
    Dim lngDiag As Long, lng…Û∫À◊¥Ã¨ As Long
    
    lngDiag = -1
    mblnRowChange = False
    vsAdvice.Redraw = flexRDNone
    
    If vsAdvice.RowData(lngRow) <> 0 Then
        'µ˜”√…æ≥˝«∞Õ‚π“Ω”ø⁄
        On Error Resume Next
        If Val(vsAdvice.TextMatrix(lngRow, COL_EDIT)) <> 1 Then
            If CreatePlugInOK(p√≈’Ô“Ω÷ˆœ¬¥Ô, mint≥°∫œ) Then
                If gobjPlugIn.AdviceDeletBefor(glngSys, p√≈’Ô“Ω÷ˆœ¬¥Ô, mlng≤°»ÀID, mlngπ“∫≈ID, Val(vsAdvice.RowData(lngRow)), mint≥°∫œ) = False Then
                    If err.Number = 0 Then Exit Sub
                End If
                Call zlPlugInErrH(err, "AdviceDeletBefor")
            End If
        End If
        If err.Number <> 0 Then err.Clear
        On Error GoTo 0
        
        If InStr(",5,6,", vsAdvice.TextMatrix(lngRow, COL_¿‡±)) > 0 Then
            lng“Ω÷ˆID = vsAdvice.RowData(lngRow)
            lngœ‡πÿID = Val(vsAdvice.TextMatrix(lngRow, COL_œ‡πÿID))
            blnGroup = RowIn“ª≤¢∏¯“©(lngRow)
            If blnGroup Then
                'œ»…æ≥˝“ª≤¢∏¯“©÷–µƒø’––(“ª∂®“™…æ)
                Call Get“ª≤¢∏¯“©∑∂Œß(lngœ‡πÿID, lngBegin, lngEnd)
                For i = lngEnd To lngBegin Step -1 '±ÿ–Î∑¥œÚ
                    If vsAdvice.RowData(i) = 0 Then Call DeleteRow(i)
                Next
                
                '…æ≥˝÷Æ∫Ûµ±«∞––∫≈ø…ƒ‹±‰¡À
                lngRow = vsAdvice.FindRow(lng“Ω÷ˆID, lngBegin)
                    
                '“ª≤¢∏¯“©÷ª…æ≥˝µ±«∞––
                lngDiag = AdviceHaveDiag(lngRow) 'º«¬º’‚“ª––µƒπÿ¡™’Ô∂œ
                lng…Û∫À◊¥Ã¨ = Val(vsAdvice.TextMatrix(lngRow, COL_…Û∫À◊¥Ã¨))
                Call DeleteRow(lngRow)
                
                If lng…Û∫À◊¥Ã¨ <> 0 Then
                    lngRow = vsAdvice.FindRow(lngœ‡πÿID, lngBegin)
                    Call ReSet…Û∫À◊¥Ã¨Õº±Í(lngRow)
                End If
            Else
                'µ•∂¿µƒ≥…“©£∫…æ≥˝∏¯“©Õææ∂––º∞µ±«∞––
                i = vsAdvice.FindRow(CLng(vsAdvice.TextMatrix(lngRow, COL_œ‡πÿID)), lngRow + 1)
                Call DeleteRow(i)
                Call DeleteRow(lngRow)
            End If
        ElseIf InStr(",D,F,K,", vsAdvice.TextMatrix(lngRow, COL_¿‡±)) > 0 Then
            Call DeleteºÏ≤È ÷ ı ‰—™(lngRow)
            Call DeleteRow(lngRow)
        ElseIf RowIn≈‰∑Ω––(lngRow) Then
            '…æ≥˝◊È≥…Œ∂“©º∞ºÂ∑®––:…æ≥˝÷Æ∫Û÷ÿ–¬∂®Œªµƒµ±«∞––
            lngRow = Delete÷–“©≈‰∑Ω(lngRow)
            '…æ≥˝µ±«∞––(÷–“©”√∑®––)
            Call DeleteRow(lngRow)
        ElseIf RowInºÏ—È––(lngRow) Then
            lngRow = DeleteºÏ—È◊È∫œ(lngRow)
            Call DeleteRow(lngRow)
        Else
            Call DeleteRow(lngRow)
        End If
        
        mblnNoSave = True '±Íº«Œ™Œ¥±£¥Ê
    Else
        'ø’––÷±Ω”…æ≥˝
        Call DeleteRow(lngRow)
    End If
    
    '÷ÿ–¬∂®Œª––
    If vsAdvice.RowHidden(vsAdvice.Row) Then
        i = GetPreRow(vsAdvice.Row)
        If i = -1 Then i = GetNextRow(vsAdvice.Row)
        If i <> -1 Then vsAdvice.Row = i
    End If
    
    'ª÷∏¥“ª≤¢∏¯“©µƒ’Ô∂œπÿ¡™
    If lngDiag <> -1 Then
        Call SetDiagFlag(vsAdvice.FindRow(lngœ‡πÿID), 1, lngDiag) 'µ±«∞––“≤”¶ «ª÷∏¥‘⁄“ª≤¢∏¯“©÷–µƒ
    End If
    
    Call vsAdvice.ShowCell(vsAdvice.Row, vsAdvice.Col)
    
    mblnRowChange = True
    vsAdvice.Redraw = flexRDDirect
    Call vsAdvice_AfterRowColChange(-1, vsAdvice.Col, vsAdvice.Row, vsAdvice.Col)
End Sub

Private Sub DeleteRow(ByVal lngRow As Long, Optional ByVal blnClear As Boolean, Optional blnDelID As Boolean = True)
'π¶ƒ‹£∫…æ≥˝±Ì∏Ò÷–µƒ“ª––,µ´≤ª∏ƒ±‰µ±«∞––
'≤Œ ˝£∫blnClear= «∑ÒΩˆ«Â≥˝∏√––ƒ⁄»›,≤ª…æ≥˝
'      blnDelID= «∑Òº«¬º“™…æ≥˝µƒ“Ω÷ˆID
    Dim lngCol As Long, blnDraw As Boolean, blnChange As Boolean
    
    With vsAdvice
        lngCol = .Col
        blnDraw = .Redraw
        blnChange = mblnRowChange
        
        mblnRowChange = False
        .Redraw = flexRDNone
        
        If .RowData(lngRow) <> 0 Then
            'µ˜’˚–Ú∫≈
            Call AdviceSet“Ω÷ˆ–Ú∫≈(lngRow + 1, -1)
            
            'º«¬º“™…æ≥˝µƒID(≥˝¡À≤≈–¬‘ˆµƒ)
            If Val(.TextMatrix(lngRow, COL_EDIT)) <> 1 And blnDelID Then
                If .TextMatrix(lngRow, COL_¥¶∑Ω…Û≤È◊¥Ã¨) = "1" Or .TextMatrix(lngRow, COL_¥¶∑Ω…Û≤È◊¥Ã¨) = "2" Then
                    If InStr("," & mstrAduitDelIDs & ",", "," & .TextMatrix(lngRow, COL_œ‡πÿID) & ",") = 0 And .TextMatrix(lngRow, COL_œ‡πÿID) <> "" Then
                        mstrAduitDelIDs = mstrAduitDelIDs & "," & .TextMatrix(lngRow, COL_œ‡πÿID)
                        mstrDelIDs = Replace(mstrDelIDs, "," & .TextMatrix(lngRow, COL_œ‡πÿID), "")
                    End If
                Else
                    mstrDelIDs = mstrDelIDs & "," & .RowData(lngRow)
                End If
                If .TextMatrix(lngRow, COL_¿‡±) = "K" And gbln—™ø‚œµÕ≥ Then
                    mstrDel ‰—™ = mstrDel ‰—™ & "," & .RowData(lngRow)
                End If
            End If
            
            '…æ≥˝∫Ûπÿ¡™’Ô∂œµƒ±Íº«¥¶¿Ì£∫ø…ƒ‹ «‘ˆ∏ƒ“ª◊È“Ω÷ˆ ±µƒ≤ø∑÷––…æ≥˝£¨√ªπÿœµ£¨‘ˆ∏ƒ∫Û¡¢º¥ª·‘Ÿ±Íº«…œ
            Call SetDiagFlag(lngRow, 0)
        End If
            
        '»Áπ˚Œ™––1«“Ωˆ £––1ªÚΩˆ«Â≥˝,‘Ú±£¡Ù
        If Not (lngRow = .FixedRows And .Rows = .FixedRows + 1) And Not blnClear Then
            .RemoveItem lngRow
        Else
            '«Â≥˝∏√–– ˝æ›
            .RowData(lngRow) = Empty
            .Cell(flexcpText, lngRow, 0, lngRow, .Cols - 1) = "" 'Œƒ◊÷
            .Cell(flexcpData, lngRow, 0, lngRow, .Cols - 1) = Empty ' ˝æ›
            .Cell(flexcpFontBold, lngRow, .FixedCols, lngRow, .Cols - 1) = False '¥÷ÃÂ
            .Cell(flexcpForeColor, lngRow, .FixedCols, lngRow, .Cols - 1) = .ForeColor 'Œƒ◊÷…´
            .Cell(flexcpForeColor, lngRow, 0, lngRow, .FixedCols - 1) = .ForeColorFixed 'πÃ∂®¡–Œƒ◊÷…´
            .Cell(flexcpBackColor, lngRow, 0, lngRow, .FixedCols - 1) = .BackColorFixed 'πÃ∂®¡–±≥æ∞…´
            Set .Cell(flexcpPicture, lngRow, 0, lngRow, .Cols - 1) = Nothing 'µ•‘™Õº∆¨
            Set .Cell(flexcpPicture, lngRow, COL_æØ æ) = Nothing 'PassæØ æµ∆
            
            'µ•‘™∏Ò±ﬂøÚ
            .Select lngRow, .FixedCols, lngRow, COL_±Í÷æ
            .CellBorder vbRed, 0, 0, 0, 0, 0, 0
        End If
        
        .Col = lngCol '“ÚŒ™”–…æ≥˝––,À˘“‘µ˜”√≥Ã–Úøœ∂®”–––∂®Œª,À˘“‘≤ª±ÿª÷∏¥––
        .Redraw = blnDraw
        mblnRowChange = blnChange
    End With
End Sub

Private Sub DeleteºÏ≤È ÷ ı ‰—™(ByVal lngRow As Long, Optional ByVal bln…Í«Î–Ú∫≈ As Boolean, Optional ByRef lngTmpRow As Long)
'π¶ƒ‹£∫1.…æ≥˝ºÏ≤È◊È∫œœÓƒøµƒ≤øŒª––
'      2.…æ≥˝ ÷ ıœÓƒøµƒ∏Ωº” ÷ ı––º∞¬È◊ÌœÓƒø––
'      3.…æ≥˝ ‰—™œÓƒøµƒ ‰—™Õææ∂––
    Dim lngBegin As Long, lngEnd As Long, i As Long
    Dim lngNo As Long
    Dim strRows As String
    Dim varArr As Variant
    Dim lngTmp As Long
    On Error GoTo errH
    With vsAdvice
        If bln…Í«Î–Ú∫≈ Then
            lngNo = Val(.TextMatrix(lngRow, COL_…Í«Î–Ú∫≈))
        End If
        If lngNo = 0 Then
            i = vsAdvice.FindRow(CStr(vsAdvice.RowData(lngRow)), lngRow + 1, COL_œ‡πÿID) '≤ª“ª∂®”–,À˘“‘”√≤È’“
            If i <> -1 Then
                lngBegin = i
                For i = lngBegin To vsAdvice.Rows - 1
                    If Val(vsAdvice.TextMatrix(i, COL_œ‡πÿID)) = vsAdvice.RowData(lngRow) Then
                        lngEnd = i
                    Else
                        Exit For
                    End If
                Next
                For i = lngEnd To lngBegin Step -1
                    Call DeleteRow(i)
                Next
            End If
        Else
            lngTmp = -1
            For i = .FixedRows To .Rows - 1
                If Val(.TextMatrix(i, COL_◊¥Ã¨)) < 2 Then
                    If lngNo = Val(.TextMatrix(i, COL_…Í«Î–Ú∫≈)) Then
                        strRows = i & IIF(strRows = "", "", "," & strRows)
                    End If
                End If
                If i > lngRow Then
                    If lngNo <> Val(.TextMatrix(i, COL_…Í«Î–Ú∫≈)) Then
                        If lngTmp = -1 Then
                            lngTmp = vsAdvice.RowData(i)
                        End If
                    End If
                End If
            Next
            varArr = Split(strRows, ",")
            For i = 0 To UBound(varArr)
                Call DeleteRow(Val(varArr(i)))
            Next
            
            If lngTmp = -1 Then
                'œ»…æ≥˝÷–º‰º‰∏Ùµƒø’––
                mblnRowChange = False
                For i = .Rows - 1 To .FixedRows Step -1
                    If .RowData(i) = 0 Then .RemoveItem i
                Next
                mblnRowChange = True
                .AddItem "", .Rows
                .Row = .Rows - 1
                .Col = .FixedCols
                lngTmpRow = .Row
            Else
                For i = .FixedRows To .Rows - 1
                    If lngTmp = Val(vsAdvice.RowData(i)) Then
                        lngTmp = i
                        Exit For
                    End If
                Next
                i = lngTmp
                If i <> -1 Then
                    .AddItem "", i
                    .Row = i
                    lngTmpRow = i
                Else
                    'œ»…æ≥˝÷–º‰º‰∏Ùµƒø’––
                    mblnRowChange = False
                    For i = .Rows - 1 To .FixedRows Step -1
                        If .RowData(i) = 0 Then .RemoveItem i
                    Next
                    mblnRowChange = True
                    .AddItem "", .Rows
                    .Row = .Rows - 1
                    .Col = .FixedCols
                    lngTmpRow = .Row
                End If
            End If
        End If
    End With
    Exit Sub
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Sub DeleteºÏ—È…Í«Îµ•(ByVal lngRow As Long, Optional ByVal bln…Í«Î–Ú∫≈ As Boolean, Optional ByRef lngTmpRow As Long)
'π¶ƒ‹£∫1.…æ≥˝ºÏ≤È◊È∫œœÓƒøµƒ≤øŒª––
'      2.…æ≥˝ ÷ ıœÓƒøµƒ∏Ωº” ÷ ı––º∞¬È◊ÌœÓƒø––
'      3.…æ≥˝ ‰—™œÓƒøµƒ ‰—™Õææ∂––
    Dim lngBegin As Long, lngEnd As Long, i As Long
    Dim lngNo As Long
    Dim strRows As String
    Dim varArr As Variant
    Dim lngTmp As Long
    On Error GoTo errH
    With vsAdvice
        If bln…Í«Î–Ú∫≈ Then
            lngNo = Val(.TextMatrix(lngRow, COL_…Í«Î–Ú∫≈))
        End If
        If lngNo = 0 Then
            lngTmpRow = DeleteºÏ—È◊È∫œ(lngRow)
        Else
            lngTmp = -1
            For i = .FixedRows To .Rows - 1
                If Val(.TextMatrix(i, COL_◊¥Ã¨)) < 2 Then
                    If lngNo = Val(.TextMatrix(i, COL_…Í«Î–Ú∫≈)) Then
                        strRows = i & IIF(strRows = "", "", "," & strRows)
                    End If
                End If
                If i > lngRow Then
                    If lngNo <> Val(.TextMatrix(i, COL_…Í«Î–Ú∫≈)) Then
                        If lngTmp = -1 Then
                            lngTmp = vsAdvice.RowData(i)
                        End If
                    End If
                End If
            Next
            varArr = Split(strRows, ",")
            For i = 0 To UBound(varArr)
                Call DeleteRow(Val(varArr(i)))
            Next
            
            If lngTmp = -1 Then
                'œ»…æ≥˝÷–º‰º‰∏Ùµƒø’––
                mblnRowChange = False
                For i = .Rows - 1 To .FixedRows Step -1
                    If .RowData(i) = 0 Then .RemoveItem i
                Next
                mblnRowChange = True
                .AddItem "", .Rows
                .Row = .Rows - 1
                .Col = .FixedCols
                lngTmpRow = .Row
            Else
                For i = .FixedRows To .Rows - 1
                    If lngTmp = Val(vsAdvice.RowData(i)) Then
                        lngTmp = i
                        Exit For
                    End If
                Next
                i = lngTmp
                If i <> -1 Then
                    .AddItem "", i
                    .Row = i
                    lngTmpRow = i
                Else
                    'œ»…æ≥˝÷–º‰º‰∏Ùµƒø’––
                    mblnRowChange = False
                    For i = .Rows - 1 To .FixedRows Step -1
                        If .RowData(i) = 0 Then .RemoveItem i
                    Next
                    mblnRowChange = True
                    .AddItem "", .Rows
                    .Row = .Rows - 1
                    .Col = .FixedCols
                    lngTmpRow = .Row
                End If
            End If
        End If
    End With
    Exit Sub
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Function Delete÷–“©≈‰∑Ω(ByVal lngRow As Long) As Long
'π¶ƒ‹£∫…æ≥˝÷–“©≈‰∑Ωµƒ◊È≥…Œ∂“©º∞ºÂ∑®––
'≤Œ ˝£∫lngRow=÷–“©≈‰∑Ω”√∑®––(ø…º˚)
'∑µªÿ£∫…æ≥˝÷Æ∫Û÷ÿ–¬∂®Œªµƒµ±«∞––(÷–“©”√∑®––)
    Dim lngBegin As Long, lngEnd As Long
    Dim lng“Ω÷ˆID As Long, i As Long
    
    lng“Ω÷ˆID = vsAdvice.RowData(lngRow)
    
    lngEnd = lngRow - 1
    For i = lngEnd To vsAdvice.FixedRows Step -1
        If Val(vsAdvice.TextMatrix(i, COL_œ‡πÿID)) = lng“Ω÷ˆID Then
            lngBegin = i
        Else
            Exit For
        End If
    Next
    
    mblnRowChange = False
    For i = lngEnd To lngBegin Step -1
        Call DeleteRow(i)
    Next
    
    '“ÚŒ™ «‘⁄«∞√Ê…æ≥˝,–Ë“™÷ÿ–¬∂®ŒªµΩ÷–“©”√∑®––
    i = vsAdvice.FindRow(lng“Ω÷ˆID)
    vsAdvice.Row = i '≤ªø…ƒ‹’“≤ªµΩ
    
    mblnRowChange = True
    
    Delete÷–“©≈‰∑Ω = vsAdvice.Row
End Function

Private Function DeleteºÏ—È◊È∫œ(ByVal lngRow As Long) As Long
'π¶ƒ‹£∫…æ≥˝“ª≤¢≤…ºØµƒ∂‡∏ˆºÏ—ÈœÓƒø––
'≤Œ ˝£∫lngRow=≤…ºØ∑Ω∑®––(ø…º˚)
'∑µªÿ£∫…æ≥˝÷Æ∫Û÷ÿ–¬∂®Œªµƒµ±«∞––(≤…ºØ∑Ω∑®––)
    Dim lngBegin As Long, lngEnd As Long
    Dim lng“Ω÷ˆID As Long, i As Long
    
    lng“Ω÷ˆID = vsAdvice.RowData(lngRow)
    
    lngEnd = lngRow - 1
    For i = lngEnd To vsAdvice.FixedRows Step -1
        If Val(vsAdvice.TextMatrix(i, COL_œ‡πÿID)) = lng“Ω÷ˆID Then
            lngBegin = i
        Else
            Exit For
        End If
    Next
    
    mblnRowChange = False
    For i = lngEnd To lngBegin Step -1
        Call DeleteRow(i)
    Next
    
    '“ÚŒ™ «‘⁄«∞√Ê…æ≥˝,–Ë“™÷ÿ–¬∂®ŒªµΩ≤…ºØ∑Ω∑®––
    i = vsAdvice.FindRow(lng“Ω÷ˆID)
    vsAdvice.Row = i '≤ªø…ƒ‹’“≤ªµΩ
    
    mblnRowChange = True
    
    DeleteºÏ—È◊È∫œ = vsAdvice.Row
End Function

Private Function GetºÏ≤È≤øŒª∑Ω∑®(ByVal lngRow As Long) As String
'π¶ƒ‹£∫ªÒ»°÷∏∂®––µƒºÏ≤È≤øŒª∑Ω∑®¥Æ
'≤Œ ˝£∫lngRow=ºÏ≤È“Ω÷ˆµƒø…º˚––
'∑µªÿ£∫"≤øŒª√˚1;∑Ω∑®√˚1,∑Ω∑®√˚2|≤øŒª√˚2;∑Ω∑®√˚1,∑Ω∑®√˚2|...<vbTab>0-≥£πÊ/1-¥≤≈‘/2- ı÷–"
'      »Áπ˚ «¿œµƒºÏ≤È◊È∫œ∑Ω Ω£¨ªÚ’ﬂ «“‘«∞µƒµ•≤øŒªºÏ≤È£¨‘Ú∑µªÿø’“‘±„≥Ã–Ú ∂±
    Dim str≤øŒª As String, str≤øŒªLast As String
    Dim str∑Ω∑® As String, i As Long
    
    With vsAdvice
        For i = lngRow + 1 To .Rows - 1
            If Val(.TextMatrix(i, COL_œ‡πÿID)) = .RowData(lngRow) Then
                If Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID)) <> Val(.TextMatrix(lngRow, COL_’Ô¡∆œÓƒøID)) Then Exit Function '¿œµƒ∑Ω Ω
                
                If .TextMatrix(i, COL_±Í±æ≤øŒª) <> "" Then
                    If .TextMatrix(i, COL_±Í±æ≤øŒª) <> str≤øŒªLast And str≤øŒªLast <> "" Then
                        str≤øŒª = str≤øŒª & "|" & str≤øŒªLast & IIF(str∑Ω∑® <> "", ";" & Mid(str∑Ω∑®, 2), "")
                        str∑Ω∑® = ""
                    End If
                    If .TextMatrix(i, COL_ºÏ≤È∑Ω∑®) <> "" Then
                        str∑Ω∑® = str∑Ω∑® & "," & .TextMatrix(i, COL_ºÏ≤È∑Ω∑®)
                    End If
                    
                    str≤øŒªLast = .TextMatrix(i, COL_±Í±æ≤øŒª)
                End If
            Else
                Exit For
            End If
        Next
        If str≤øŒªLast <> "" Then
            str≤øŒª = str≤øŒª & "|" & str≤øŒªLast & IIF(str∑Ω∑® <> "", ";" & Mid(str∑Ω∑®, 2), "")
        End If
        GetºÏ≤È≤øŒª∑Ω∑® = Mid(str≤øŒª, 2) & vbTab & Val(.TextMatrix(lngRow, COL_÷¥––±Íº«))
    End With
End Function

Private Function Get ÷ ı∏Ωº”IDs(ByVal lngRow As Long) As String
'π¶ƒ‹£∫ªÒ»°÷∏∂® ÷ ı––µƒ∏Ωº” ÷ ıº∞¬È◊ÌœÓƒøID¥Æ
'∑µªÿ£∫" ÷ ıID1, ÷ ıID2,...;¬È◊ÌID",∆‰÷–ø…ƒ‹√ª”–∏Ωº” ÷ ı∫Õ¬È◊Ì
    Dim strTmp As String, lng¬È◊ÌID As Long, i As Long
    
    i = vsAdvice.FindRow(CStr(vsAdvice.RowData(lngRow)), lngRow + 1, COL_œ‡πÿID)
    If i <> -1 Then
        For i = i To vsAdvice.Rows - 1
            If Val(vsAdvice.TextMatrix(i, COL_œ‡πÿID)) = vsAdvice.RowData(lngRow) Then
                If vsAdvice.TextMatrix(i, COL_¿‡±) = "G" Then
                    lng¬È◊ÌID = Val(vsAdvice.TextMatrix(i, COL_’Ô¡∆œÓƒøID))
                Else
                    strTmp = strTmp & "," & Val(vsAdvice.TextMatrix(i, COL_’Ô¡∆œÓƒøID))
                End If
            Else
                Exit For
            End If
        Next
    End If
    Get ÷ ı∏Ωº”IDs = Mid(strTmp, 2) & ";" & IIF(lng¬È◊ÌID = 0, "", lng¬È◊ÌID)
End Function

Private Function Get÷–“©≈‰∑ΩIDs(ByVal lngRow As Long) As String
'π¶ƒ‹£∫ªÒ»°÷–“©≈‰∑Ωµƒ◊È≥…Œ∂“©º∞ºÂ∑®ID¥Æ
'∑µªÿ£∫"÷–“©ID1,µ•¡ø1,Ω≈◊¢1;÷–“©ID2,µ•¡ø2,Ω≈◊¢2;...|ºÂ∑®ID"
    Dim lngºÂ∑®ID As Long, str÷–“©IDs As String, i As Long, lng–ŒÃ¨ As Long
    Dim lng∏∂ ˝ As Long, lng“©∑øID As Long
    Dim strTmp As String
    
    With vsAdvice
        lng–ŒÃ¨ = Val(.TextMatrix(lngRow, COL_÷–“©–ŒÃ¨))    '”√∑®––
        For i = lngRow - 1 To .FixedRows Step -1
            If Val(.TextMatrix(i, COL_œ‡πÿID)) = .RowData(lngRow) Then
                If .TextMatrix(i, COL_¿‡±) = "E" Then
                    lngºÂ∑®ID = Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID))
                    strTmp = .TextMatrix(i, COL_±Í±æ≤øŒª) '¥˙±Ì÷–“©µƒ ºÂ¡ø
                ElseIf .TextMatrix(i, COL_¿‡±) = "7" Then
                    str÷–“©IDs = Val(.TextMatrix(i, COL_ ’∑—œ∏ƒøID)) & "," & _
                        .TextMatrix(i, COL_µ•¡ø) & "," & .TextMatrix(i, COL_“Ω…˙÷ˆÕ–) & _
                        ";" & str÷–“©IDs
                    If lng“©∑øID = 0 Then
                        lng“©∑øID = .TextMatrix(i, COL_÷¥––ø∆ “ID)
                        lng∏∂ ˝ = .TextMatrix(i, COL_◊‹¡ø)
                    End If
                End If
            Else
                Exit For
            End If
        Next
        Get÷–“©≈‰∑ΩIDs = Mid(str÷–“©IDs, 1, Len(str÷–“©IDs) - 1) & "|" & lngºÂ∑®ID & "|" & lng–ŒÃ¨ & "|" & lng∏∂ ˝ & "|" & lng“©∑øID & "|" & strTmp
    End With
End Function

Private Function GetºÏ—È◊È∫œIDs(ByVal lngRow As Long) As String
'π¶ƒ‹£∫ªÒ»°“ª≤¢≤…ºØµƒºÏ—È◊È∫œœÓƒøIDº∞±Í±æ
'∑µªÿ£∫"'      ºÏ—È◊È∫œ="œÓƒøID1,œÓƒøID2,...;ºÏ—È±Í±æ" »Áπ˚ «–¬∞ÊLISµƒƒ£ Ω‘Ú «£∫"œÓƒøID1|÷∏±Í1|÷∏±Í2...,œÓƒøID2|÷∏±Í1|÷∏±Í2...,...;ºÏ—È±Í±æ""
    Dim strœÓƒøIDs As String, str±Í±æ As String, i As Long
    Dim j As Long
    
    With vsAdvice
        For i = lngRow - 1 To .FixedRows Step -1
            If Val(.TextMatrix(i, COL_œ‡πÿID)) = .RowData(lngRow) Then
                If Val(.TextMatrix(i, COL_◊È∫œœÓƒøID)) = 0 And mblnNewLIS Then
                    For j = lngRow - 1 To .FixedRows Step -1
                        If Val(.TextMatrix(j, COL_œ‡πÿID)) = .RowData(lngRow) Then
                            If Val(.TextMatrix(j, COL_◊È∫œœÓƒøID)) = Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID)) And Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID)) <> 0 Then
                                strœÓƒøIDs = "|" & Val(.TextMatrix(j, COL_’Ô¡∆œÓƒøID)) & strœÓƒøIDs
                            End If
                        Else
                            Exit For
                        End If
                    Next
                    strœÓƒøIDs = "," & Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID)) & strœÓƒøIDs
                Else
                    If Not mblnNewLIS Then
                        strœÓƒøIDs = "," & Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID)) & strœÓƒøIDs
                    End If
                End If
                str±Í±æ = .TextMatrix(i, COL_±Í±æ≤øŒª)
            Else
                Exit For
            End If
        Next
    End With
    GetºÏ—È◊È∫œIDs = Right(strœÓƒøIDs, Len(strœÓƒøIDs) - 1) & ";" & str±Í±æ
End Function

Private Function RowInºÏ—È––(ByVal lngRow As Long) As Boolean
'π¶ƒ‹£∫≈–∂œ÷∏∂®–– «∑Ò Ù”⁄ºÏ—È◊È∫œ÷–µƒ“ª––
'Àµ√˜£∫≤ªπ‹––µ±«∞ «∑Ò“˛≤ÿ
    If lngRow = -1 Then Exit Function
    If vsAdvice.RowData(lngRow) = 0 Then Exit Function
    
    With vsAdvice
        If .TextMatrix(lngRow, COL_¿‡±) = "E" And Val(.TextMatrix(lngRow, COL_œ‡πÿID)) = 0 Then
            '≤…ºØ∑Ω∑®––
            If .TextMatrix(lngRow - 1, COL_¿‡±) = "C" _
                And Val(.TextMatrix(lngRow - 1, COL_œ‡πÿID)) = .RowData(lngRow) Then
                RowInºÏ—È–– = True: Exit Function
            End If
        ElseIf .TextMatrix(lngRow, COL_¿‡±) = "C" And Val(.TextMatrix(lngRow, COL_œ‡πÿID)) <> 0 Then
            'ºÏ—ÈœÓƒø––
            RowInºÏ—È–– = True: Exit Function
        End If
    End With
End Function

Private Function RowIn≈‰∑Ω––(ByVal lngRow As Long) As Boolean
'π¶ƒ‹£∫≈–∂œ÷∏∂®–– «∑Ò Ù”⁄÷–“©≈‰∑Ω÷–µƒ“ª––
'Àµ√˜£∫≤ªπ‹––µ±«∞ «∑Ò“˛≤ÿ
    If lngRow = -1 Then Exit Function
    If vsAdvice.RowData(lngRow) = 0 Then Exit Function
    
    With vsAdvice
        If .TextMatrix(lngRow, COL_¿‡±) = "E" Then
            If Val(.TextMatrix(lngRow, COL_œ‡πÿID)) = 0 Then
                '”√∑®––
                If Val(.TextMatrix(lngRow - 1, COL_œ‡πÿID)) = .RowData(lngRow) _
                    And .TextMatrix(lngRow - 1, COL_¿‡±) = "E" Then
                    RowIn≈‰∑Ω–– = True: Exit Function
                End If
            Else
                'ºÂ∑®––
                If .TextMatrix(lngRow - 1, COL_¿‡±) = "7" _
                    And Val(.TextMatrix(lngRow - 1, COL_œ‡πÿID)) = Val(.TextMatrix(lngRow, COL_œ‡πÿID)) Then
                    RowIn≈‰∑Ω–– = True: Exit Function
                End If
            End If
        ElseIf .TextMatrix(lngRow, COL_¿‡±) = "7" And Val(.TextMatrix(lngRow, COL_œ‡πÿID)) <> 0 Then
            '÷–“©––
            RowIn≈‰∑Ω–– = True: Exit Function
        End If
    End With
End Function

Private Function RowIn“ª≤¢∏¯“©(ByVal lngRow As Long) As Boolean
'π¶ƒ‹£∫≈–∂œ÷∏∂®–– «∑Ò‘⁄“ª≤¢∏¯“©µƒ∑∂Œß÷–
'≤Œ ˝£∫lngRow=ø…º˚µƒ––,ø…ƒ‹ «ø’––
'Àµ√˜£∫“ª≤¢∏¯“©µƒ∑∂Œß÷–ø…ƒ‹¥Ê‘⁄ø’––
    Dim lngPreRow As Long, lngNextRow As Long
    Dim lngœ‡πÿID As Long, blnGroup As Boolean, i As Long
    
    lngPreRow = GetPreRow(lngRow)
    lngNextRow = GetNextRow(lngRow)
    
    With vsAdvice
        If .RowData(lngRow) = 0 Then
            If lngPreRow <> -1 And lngNextRow <> -1 Then
                If Val(.TextMatrix(lngPreRow, COL_œ‡πÿID)) = Val(.TextMatrix(lngNextRow, COL_œ‡πÿID)) _
                    And Val(.TextMatrix(lngPreRow, COL_œ‡πÿID)) <> 0 _
                    And InStr(",5,6,", .TextMatrix(lngPreRow, COL_¿‡±)) > 0 _
                    And InStr(",5,6,", .TextMatrix(lngNextRow, COL_¿‡±)) > 0 Then
                    blnGroup = True
                End If
            End If
        ElseIf InStr(",5,6,", .TextMatrix(lngRow, COL_¿‡±)) > 0 _
            And Val(.TextMatrix(lngRow, COL_œ‡πÿID)) <> 0 Then
            
            lngœ‡πÿID = Val(.TextMatrix(lngRow, COL_œ‡πÿID))
            If lngPreRow <> -1 Then
                If InStr(",5,6,", .TextMatrix(lngPreRow, COL_¿‡±)) > 0 _
                    And Val(.TextMatrix(lngPreRow, COL_œ‡πÿID)) = lngœ‡πÿID Then blnGroup = True
            End If
            If Not blnGroup And lngNextRow <> -1 Then
                If InStr(",5,6,", .TextMatrix(lngNextRow, COL_¿‡±)) > 0 _
                    And Val(.TextMatrix(lngNextRow, COL_œ‡πÿID)) = lngœ‡πÿID Then blnGroup = True
            End If
        End If
    End With
    RowIn“ª≤¢∏¯“© = blnGroup
End Function

Private Function AdviceSetπ˝√Ù ‘—È(ByVal lngRow As Long, ByVal lng∆§ ‘ID As Long) As Boolean
'π¶ƒ‹£∫◊‘∂Ø‘ˆº”∆§ ‘––
'≤Œ ˝£∫lngRow=µ±«∞ ‰»Î––,“—æ≠ ‰»ÎŒ˜“©ªÚ÷–≥…“©
'      lng∆§ ‘ID=“™‘ˆº”µƒ∆§ ‘œÓƒøID
'Àµ√˜£∫◊‘∂Ø‘ˆº”÷Æ∫Û,µ±«∞––º∞π‚±Í»‘∂®Œª‘⁄“—∏’ ‰»Îµƒ“©∆∑––Œª÷√
    Dim rsInput As New ADODB.Recordset
    Dim strSQL As String, i As Long
    
    On Error GoTo errH
        
    '¿‡±ID,√˚≥∆,’Ô¡∆œÓƒøID, ’∑—œ∏ƒøID,πÊ∏Ò,≤˙µÿ
    strSQL = "Select ¿‡± as ¿‡±ID,√˚≥∆,ID as ’Ô¡∆œÓƒøID,NULL as  ’∑—œ∏ƒøID,NULL as πÊ∏Ò,NULL as ≤˙µÿ,NULL as œÓƒøÃÿ–‘ From ’Ô¡∆œÓƒøƒø¬º Where ID=[1]"
    Set rsInput = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng∆§ ‘ID)
        
    '—∞’“ µº “™º”»Î∆§ ‘µƒ––:“ª≤¢∏¯“©µƒ«Èøˆ
    With vsAdvice
        For i = lngRow - 1 To .FixedRows - 1 Step -1 'ø…ƒ‹ «‘ˆº”‘⁄◊Ó«∞√Ê
            If Val(.TextMatrix(i, COL_œ‡πÿID)) <> Val(.TextMatrix(lngRow, COL_œ‡πÿID)) Then
                lngRow = i + 1: Exit For '–¬‘ˆ––µƒ––∫≈
            End If
        Next
    End With
    
    'º”»Îø’––
    vsAdvice.AddItem "", lngRow
    
    '‘ˆº”∆§ ‘
    Call AdviceInput(rsInput, lngRow, True)
    
    '÷ÿ–¬∂®ŒªµΩ ‰»Îµƒ“©∆∑––
    mblnRowChange = False
    vsAdvice.Row = vsAdvice.Row + 1
    mblnRowChange = True
    
    AdviceSetπ˝√Ù ‘—È = True
    Exit Function
errH:
    If ErrCenter = 1 Then Resume
    Call SaveErrLog
End Function

Private Function AdviceInput(rsInput As ADODB.Recordset, ByVal lngRow As Long, Optional ByVal blnBy∆§ ‘ As Boolean) As Boolean
'π¶ƒ‹£∫∏˘æ›–¬ ‰µƒ’Ô¡∆œÓƒø(–¬‘ˆªÚ∏¸ªª)…Ë÷√»± °µƒ“Ω÷ˆ ˝æ›
'≤Œ ˝£∫rsInput= ‰»ÎªÚ—°‘Ò∑µªÿµƒº«¬ººØ,lngRow=µ±«∞ ‰»Î––,blnBy∆§ ‘= «∑Ò◊‘∂Ø‘ˆº”∆§ ‘ ‰»Î
'∑µªÿ£∫±æ¥Œ¬º»Î «∑Ò”––ß
    Dim strπ˝√Ù As String, blnGroup As Boolean, i As Long
    Dim lng”√∑®ID As Long, lngGroupRow As Long, lngRowID As Long
    Dim lng∆§ ‘ID As Long, bln∆§ ‘–– As Boolean
    Dim lngPreRow As Long, lngNextRow As Long
    Dim strExtData As String, strAppend As String
    Dim intType As Integer, str’™“™ As String, lng…Û∫À◊¥Ã¨ As Long, str’™“™Out As String
    Dim strMsg As String, vMsg As VbMsgBoxResult
    Dim objControl As CommandBarControl
    Dim lngPreRow÷–“©∑ø As Long, lng“©∆∑ID As Long
    Dim blnOK As Boolean
    Dim t_Pati As TYPE_PatiInfoEx
    Dim str ÷ ı≤øŒª As String
    Dim strIDs1 As String, strIDs2 As String, str“Ω÷ˆƒ⁄»› As String
    Dim lngBegin As Long, lngEnd As Long, sngÃÏ ˝ As Single
    Dim lngAppType As Long '…Í«Îµ•”¶”√
    Dim objAppPages()  As clsApplicationData
    Dim rsCard As ADODB.Recordset
    Dim lngTmpRow As Long
    Dim bln±∏—™ As Boolean ' «∑ÒŒ™±∏—™“Ω÷ˆ ±∏—™=0£¨”√—™=1,¥Ê”⁄K¿‡±“Ω÷ˆ––µƒ ºÏ≤È∑Ω∑®  ◊÷∂Œ;±∏—™-≤…ºØ∑Ω Ω / ”√—™- ‰—™Õææ∂
    Dim strWhere As String
        Dim lngApplyID As Long
    
    On Error GoTo errH
        
    lngPreRow = GetPreRow(lngRow) '»°…œ“ª”––ß––,ƒ≥–©ƒ⁄»›»± °”Î…œ“ª––œ‡Õ¨
    lngNextRow = GetNextRow(lngRow) '»°œ¬“ª”––ß––
    
    'œÓƒø∏Ωº” ˝æ› ‰»Îº∞ ‰»Î∫œ∑®–‘ºÏ≤È
    '---------------------------------------------------------------------------------------------------------------
    txt“Ω÷ˆƒ⁄»›.Text = rsInput!√˚≥∆ '‘› ±œ‘ æ
    
    '“©∆∑¥¶∑Ω÷∞ŒÒºÏ≤È(ª§ ø’æ‘⁄±£¥Ê ±ºÏ≤È)
    If InStr(",5,6,7,", rsInput!¿‡±ID) > 0 Then
        strMsg = CheckOneDuty(rsInput!√˚≥∆, Nvl(rsInput!¥¶∑Ω÷∞ŒÒID), UserInfo.–’√˚, InStr(",1,2,", mstr∏∂øÓ¬Î) > 0 And mstr∏∂øÓ¬Î <> "")
        If strMsg <> "" Then
            vsAdvice.Refresh
            MsgBox strMsg, vbInformation, gstrSysName
            vsAdvice.Refresh: Exit Function
        End If
        If mblnPass Then
            If gobjPass.zlPassCheck(mobjPassMap) Then
                Call gobjPass.zlPassAdviceInput(mobjPassMap, Val(rsInput!’Ô¡∆œÓƒøID & ""), Val(rsInput! ’∑—œ∏ƒøID & ""), rsInput!√˚≥∆ & "")
            End If
        End If
    End If
    With vsAdvice
        'ºÏ≤È «∑Ò¥Ê‘⁄”––ßµƒ◊°‘∫“Ω÷ˆªÚ¡Ùπ€“Ω÷ˆ
        If rsInput!¿‡±ID = "Z" And InStr(",¡Ùπ€,◊°‘∫,", "," & rsInput!œÓƒøÃÿ–‘ & ",") > 0 Then
            If CheckInHosAdvice Then
                Exit Function
            End If
        End If
        
        '“Ω±£≤°»À ‰»Îƒ⁄»› ±µƒÃ· æ£∫∑«“Ω±£≤°»À“≤“™µ˜(Or And mintœ’¿‡ <> 0)
        If InStr(",7,8,9,", rsInput!¿‡±ID) = 0 Then '≥…Ã◊£¨≈‰∑Ω£¨µ•Œ∂÷–“©≤ª‘⁄’‚¿ÔÃ· æ
            str’™“™ = gclsInsure.GetItemInfo(mintœ’¿‡, mlng≤°»ÀID, Nvl(rsInput! ’∑—œ∏ƒøID, 0), "", 0, "", rsInput!’Ô¡∆œÓƒøID)
        End If
    
        
        'ºÏ—ÈœÓƒø£∫≤…ºØ∑Ω∑®≈–∂œ
        If rsInput!¿‡±ID = "C" Then
            'À˘”– ˝æ›÷–»°“ª∏ˆ»± °µƒ≤…ºØ∑Ω∑®,Õ¨ ±≈–∂œ «∑Ò”–≤…ºØ∑Ω∑® ˝æ›
            lng”√∑®ID = Get»± °”√∑®ID(6, 1)
            If lng”√∑®ID = 0 Then
                .Refresh
                MsgBox "√ª”–ø…”√µƒ±Í±æ≤…ºØ∑Ω∑®,«Îœ»µΩ’Ô¡∆œÓƒøπ‹¿Ì÷–…Ë÷√£°", vbInformation, gstrSysName
                .Refresh: Exit Function
            End If
            '»± °”Î…œ“ª––œ‡Õ¨
            If lngPreRow <> -1 Then
                If RowInºÏ—È––(lngPreRow) Then
                    If Val(.TextMatrix(lngPreRow, COL_ «∑ÒÕ£”√)) = 0 Then lng”√∑®ID = Val(.TextMatrix(lngPreRow, COL_’Ô¡∆œÓƒøID))
                End If
            End If
        End If
        
        '÷–“©≈‰∑Ω£∫∏¯≥…”Î÷–“©”√∑®≈–∂œ
        If InStr(",7,8,", rsInput!¿‡±ID) > 0 Then
            If rsInput!¿‡±ID = "8" Then
                If GetGroupCount(rsInput!’Ô¡∆œÓƒøID, 1, False) = 0 Then
                    .Refresh
                    MsgBox """" & rsInput!√˚≥∆ & """ «“ª∏ˆ÷–“©≈‰∑Ω£¨µ´√ª”–…Ë÷√”––ßµƒ◊È≥…÷–“©°£" & vbCrLf & "«Îœ»µΩ’Ô¡∆œÓƒøπ‹¿Ì÷–…Ë÷√°£", vbInformation, gstrSysName
                    .Refresh: Exit Function
                End If
            
                '≤ø∑›“©Œﬁ–ßµƒÃ· æ
                strMsg = GetGroupNone(rsInput!’Ô¡∆œÓƒøID, 1)
                If strMsg <> "" Then
                    .Refresh
                    MsgBox "≈‰∑Ω""" & rsInput!√˚≥∆ & """÷–“‘œ¬“©∆∑“—≥∑µµªÚ∑˛ŒÒ∂‘œÛ≤ª∆•≈‰£∫" & _
                        vbCrLf & vbCrLf & vbTab & strMsg & vbCrLf & vbCrLf & "’‚–©“©∆∑Ω´≤ªª·≥ˆœ÷‘⁄≈‰∑Ω÷–°£", vbInformation, gstrSysName
                    .Refresh
                End If
            End If
        
            'À˘”– ˝æ›÷–»°“ª∏ˆ»± °µƒ÷–“©”√∑®,Õ¨ ±≈–∂œ «∑Ò”–÷–“©”√∑® ˝æ›
            lng”√∑®ID = Get»± °”√∑®ID(4, 1)
            If lng”√∑®ID = 0 Then
                .Refresh
                MsgBox "√ª”–ø…”√µƒ÷–“©”√(∑˛)∑®,«Îœ»µΩ’Ô¡∆œÓƒøπ‹¿Ì÷–…Ë÷√£°", vbInformation, gstrSysName
                .Refresh: Exit Function
            End If
            '÷–“©”√∑®»± °”Î…œ“ª––œ‡Õ¨
            If RowIn≈‰∑Ω––(lngPreRow) Then
                If Val(.TextMatrix(lngPreRow, COL_ «∑ÒÕ£”√)) = 0 Then lng”√∑®ID = Val(.TextMatrix(lngPreRow, COL_’Ô¡∆œÓƒøID))
            End If
        End If
        
        ' ‰—™“Ω÷ˆ£∫ ‰—™Õææ∂≈–∂œ
        If rsInput!¿‡±ID = "K" Then
            If gbln—™ø‚œµÕ≥ Then
                vMsg = frmMsgBox.ShowMsgBox("«Î—°‘Ò ‰—™“Ω÷ˆ¿‡–Õ°£", Me, , 2)
                If vMsg = vbNo Then
                    bln±∏—™ = True
                ElseIf vMsg = vbCancel Then
                    Exit Function
                End If
            Else
                bln±∏—™ = True
            End If
            strWhere = ""
            If bln±∏—™ = False And gbln—™ø‚œµÕ≥ = True Then
                strWhere = " And NVL(÷¥––∑÷¿‡,0)=1 "
            End If
            'À˘”– ˝æ›÷–»°“ª∏ˆ»± °µƒ ‰—™Õææ∂
            lng”√∑®ID = Get»± °”√∑®ID(IIF(bln±∏—™ And gbln—™ø‚œµÕ≥, 9, 8), 2, strWhere)
            If lng”√∑®ID = 0 Then
                .Refresh
                MsgBox "√ª”–ø…”√µƒ ‰—™" & IIF(bln±∏—™ And gbln—™ø‚œµÕ≥, "≤…ºØ∑Ω∑®", "Õææ∂") & ",«Îœ»µΩ’Ô¡∆œÓƒøπ‹¿Ì÷–…Ë÷√£°", vbInformation, gstrSysName
                .Refresh: Exit Function
            End If
            '»± °”Î…œ“ª––œ‡Õ¨
            If lngPreRow <> -1 Then
                If .TextMatrix(lngPreRow, COL_¿‡±) = "K" And Val(.TextMatrix(lngPreRow, COL_ºÏ≤È∑Ω∑®)) = IIF(bln±∏—™, "0", "1") Then
                    i = .FindRow(CStr(.RowData(lngPreRow)), lngPreRow + 1, COL_œ‡πÿID)
                    If i <> -1 Then
                        If Val(.TextMatrix(i, COL_ «∑ÒÕ£”√)) = 0 Then lng”√∑®ID = Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID))
                    End If
                End If
            End If
        End If
        
        '÷–Œ˜≥…“©£∫∏¯“©Õææ∂≈–∂œ
        If InStr(",5,6,", rsInput!¿‡±ID) > 0 Then
'            'À˘”– ˝æ›÷–»°“ª∏ˆ»± °µƒ∏¯“©Õææ∂,Õ¨ ±≈–∂œ «∑Ò”–∏¯“©Õææ∂ ˝æ›
'            lng”√∑®ID = Get»± °”√∑®ID(2, 1)
'            If lng”√∑®ID = 0 Then
'                .Refresh
'                MsgBox "√ª”–ø…”√µƒ∏¯“©Õææ∂,«Îœ»µΩ’Ô¡∆œÓƒøπ‹¿Ì÷–…Ë÷√£°", vbInformation, gstrSysName
'                .Refresh: Exit Function
'            End If
            '∏¯“©Õææ∂»± °”Î…œ“ª∏ˆ––œ‡Õ¨º¡–Õµƒœ‡Õ¨
            If lngPreRow <> -1 And Not IsNull(rsInput!“©∆∑º¡–Õ) Then
                If InStr(",5,6,", .TextMatrix(lngPreRow, COL_¿‡±)) > 0 And .TextMatrix(lngPreRow, COL_“©∆∑º¡–Õ) = Nvl(rsInput!“©∆∑º¡–Õ) Then
                    i = .FindRow(CLng(.TextMatrix(lngPreRow, COL_œ‡πÿID)), lngPreRow + 1)
                    If i <> -1 Then
                        If Val(.TextMatrix(i, COL_ «∑ÒÕ£”√)) = 0 Then lng”√∑®ID = Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID))
                    End If
                End If
            End If
        End If
        
        '÷–Œ˜≥…“©£∫π˝√Ù ‘—ÈºÏ≤È
        If InStr(",5,6,", rsInput!¿‡±ID) > 0 And gintπ˝√Ùµ«º«”––ßÃÏ ˝ <> 0 Then
            strπ˝√Ù = Checkπ˝√Ù ‘—È(Me, txt“Ω÷ˆƒ⁄»›, mlng≤°»ÀID, rsInput!’Ô¡∆œÓƒøID, rsInput!√˚≥∆, mbln◊‘∂Ø∆§ ‘, lng∆§ ‘ID)
            If strπ˝√Ù <> "" Then
                .Refresh
                If MsgBox(strπ˝√Ù, vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbNo Then
                    .Refresh: Exit Function
                End If
            End If
            
            '◊‘∂ØÃÌº”∆§ ‘
            If lng∆§ ‘ID <> 0 Then
                'œ»ºÏ≤È «∑Ò“—”–∏√∆§ ‘(‘⁄”––ß ±º‰ƒ⁄ ÷π§ªÚ◊‘∂ØÃÌº”µƒ,∞¸¿®√‚ ‘∆§ ‘)
                i = .FixedRows - 1
                Do
                    i = .FindRow(CStr(lng∆§ ‘ID), i + 1, COL_’Ô¡∆œÓƒøID)
                    If i <> -1 Then
                        If Not .RowHidden(i) Then
                            If Int(CDate(.Cell(flexcpData, i, COL_ø™ º ±º‰))) >= Int(zlDatabase.Currentdate - gintπ˝√Ùµ«º«”––ßÃÏ ˝) Then
                                bln∆§ ‘–– = True: Exit Do 'º«¬º“‘◊˜±Í÷æ,µ±«∞–– ‰»ÎÕÍ≥…∫Û‘Ÿ‘ˆº”
                            End If
                        End If
                    End If
                Loop Until i = -1
            End If
        End If
        
        '÷–Œ˜≥…“©£∫“ª≤¢∏¯“©µƒ≈–∂œ,–¬––»± ° «∞¥œ¬“ª≤¢µƒ£®»Áπ˚…œ“ª–– «“ª≤¢£©
        blnGroup = RowIn“ª≤¢∏¯“©(lngRow) And Not blnBy∆§ ‘
        If blnGroup Then
            If rsInput!¿‡±ID = "9" Then
                .Refresh
                MsgBox "≤ªƒ‹‘⁄“ª≤¢∏¯“©µƒ“©∆∑÷–÷±Ω” ‰»Î≥…Ã◊∑Ω∞∏°£", vbInformation, gstrSysName
                .Refresh: Exit Function
            End If
        
            If .RowData(lngRow) = 0 Then
                '“ª≤¢∏¯“©÷–µƒ¥˝ ‰»Îø’––£∫÷ª”–≤Â»Î‘⁄“ª≤¢∏¯“©µƒ÷–º‰,≤≈ƒ‹◊‘∂Ø≥…Œ™“ª≤¢∏¯“©
                lngGroupRow = lngPreRow
            Else
                '“ª≤¢∏¯“©÷–µƒ“©∆∑––£∫ø…ƒ‹ «µ⁄“ª––ªÚ◊Ó∫Û“ª––'»°µ±«∞––µƒœ¬“ª––£¨±‹√‚‘⁄≤Ÿ◊˜“—”–“Ω÷ˆ ±÷ÿ—°’Ô¡∆œÓƒø≤Ÿ◊˜ ±£¨µ±«∞––µƒƒ⁄»›±ª…æ≥˝£¨∫Û–¯π˝≥ÃŒﬁ∑®»°µΩ∆‰÷–µƒ÷µ
                If lngPreRow = -1 Then
                    lngGroupRow = vsAdvice.FindRow(.TextMatrix(lngRow, COL_œ‡πÿID), lngRow + 1, COL_œ‡πÿID)
                Else
                    If InStr(",5,6,", .TextMatrix(lngPreRow, COL_¿‡±)) > 0 _
                        And Val(.TextMatrix(lngPreRow, COL_œ‡πÿID)) = Val(.TextMatrix(lngRow, COL_œ‡πÿID)) Then
                        lngGroupRow = lngPreRow
                    Else
                        lngGroupRow = lngNextRow
                    End If
                End If
            End If
            
            '“ª≤¢∏¯“©µƒ,¿‡±£¨±ÿ–Îœ‡Õ¨
            If Decode(rsInput!¿‡±ID, "5", "Y", "6", "Y", "N") <> Decode(.TextMatrix(lngGroupRow, COL_¿‡±), "5", "Y", "6", "Y", "N") Then
                .Refresh
                MsgBox "∏√◊È“ª≤¢∏¯“©µƒ“©∆∑±ÿ–Î∂ºŒ™Œ˜≥…“©ªÚ÷–≥…“©°£", vbInformation, gstrSysName
                .Refresh: Exit Function
            End If
            
            i = .FindRow(CLng(.TextMatrix(lngGroupRow, COL_œ‡πÿID)), lngGroupRow + 1)
            lng”√∑®ID = Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID)) '“ª≤¢∏¯“©µƒ∏¯“©Õææ∂œ‡Õ¨
            
            'ºÏ≤È“ª≤¢∏¯“©µƒµƒ∏¯“©Õææ∂ «∑Ò  ∫œ”⁄µ±«∞ ‰»Î“©∆∑(∑«“ª≤¢∏¯“©µƒ»± °”√∑®‘⁄ ‰»Î∫Ø ˝÷–◊˜¡À≈–∂œ¥¶¿Ì)
            If Not Check  ”√”√∑®(lng”√∑®ID, rsInput!’Ô¡∆œÓƒøID, 1) Then
                .Refresh
                MsgBox "“ª≤¢µƒ∏¯“©Õææ∂Œ™""" & .TextMatrix(i, col_“Ω÷ˆƒ⁄»›) & """£¨≤ª  ”√”⁄µ±«∞ ‰»Î“©∆∑°£", vbInformation, gstrSysName
                .Refresh: Exit Function
            End If
            
        End If
    
        '≥…Ã◊œÓƒø
        If rsInput!¿‡±ID = "9" Then
            If GetGroupCount(rsInput!’Ô¡∆œÓƒøID, 1) = 0 Then
                .Refresh
                MsgBox """" & rsInput!√˚≥∆ & """ «“ª∏ˆ≥…Ã◊∑Ω∞∏£¨µ´√ª”–…Ë÷√”––ßµƒ◊È≥…œÓƒø°£" & vbCrLf & "«Îœ»µΩ’Ô¡∆œÓƒøπ‹¿Ì÷–…Ë÷√°£", vbInformation, gstrSysName
                .Refresh: Exit Function
            End If
            strExtData = frmSchemeSelect.ShowMe(Me, rsInput!’Ô¡∆œÓƒøID, 1, mlng≤°»Àø∆ “id, mstr–‘±)
            If strExtData = "" Then .Refresh: Exit Function
        End If
    
        '–Ë“™ ‰»Î∏¸∂‡ ˝æ›µƒ“ª–©œÓƒø
        '---------------------------------------------------------------------------------------------------------------
        intType = -1
        lngAppType = -1
        If rsInput!¿‡±ID <> "9" Then strExtData = ""
        If rsInput!¿‡±ID = "D" Then
            If gblnOut±ÿ”√ And CanUseApply("D", Val(rsInput!’Ô¡∆œÓƒøID & "")) Then
                lngAppType = 0
            Else
                'ºÏ≤ÈœÓƒø£∫∂º“™¿©’π±‡º≠¡À£¨≤ªœÛ“‘«∞ªπ”–µ•≤øŒªœÓƒø
                intType = 0
            End If
        ElseIf rsInput!¿‡±ID = "F" Then
            ' ÷ ı£∫–Ë“™ ‰»Î¬È◊ÌœÓƒø£¨º∞ø…—°‘Ò∏Ωº” ÷ ı
            intType = 1
        ElseIf InStr(",7,8,", rsInput!¿‡±ID) > 0 Then
            '÷–“©≈‰∑Ω(µ•Œ∂≤›“©µ±≈‰∑Ω¥¶¿Ì)
            intType = 2
        ElseIf rsInput!¿‡±ID = "C" Then
            If gblnOut±ÿ”√ And CanUseApply("C", Val(rsInput!’Ô¡∆œÓƒøID & ""), rsInput!±‡¬Î & "") Then
                lngAppType = 3
            Else
                ' ‰»Î“ª≤¢≤…ºØµƒ∂‡∏ˆºÏ—ÈœÓƒøº∞ºÏ—È±Í±æ
                intType = 4
                strExtData = rsInput!’Ô¡∆œÓƒøID & ";" & Nvl(rsInput!πÊ∏Ò) 'œÓƒø;±Í±æ
            End If
        ElseIf rsInput!¿‡±ID = "K" Or rsInput!¿‡±ID = "E" Or rsInput!¿‡±ID = "Z" Then
            If gblnOut±ÿ”√ And CanUseApply(rsInput!¿‡±ID) Then
                lngAppType = 1
            ElseIf CheckApplication(Val(rsInput!’Ô¡∆œÓƒøID & ""), 1) Then
                '÷Œ¡∆∫Õ ‰—™¿‡µƒ»Áπ˚”–…Í«Î∏ΩœÓ‘ÚÃÓ–¥
                intType = 5
            End If
        End If
        '≈–∂œµ±«∞œÓƒø «∑Ò∞Û∂®”–◊‘∂®“Â…Í«Îµ•£¨»Áπ˚”–‘ÚµØ≥ˆ
        lngApplyID = GetApplyCustom(Val(rsInput!’Ô¡∆œÓƒøID & ""))
        If intType <> -1 And lngApplyID = 0 Then
            With t_Pati
                .bln“Ω±£ = InStr(",1,2,", mstr∏∂øÓ¬Î) > 0 And mstr∏∂øÓ¬Î <> ""
                .intœ’¿‡ = mintœ’¿‡
                .int”§∂˘ = mint”§∂˘
                .lng≤°»ÀID = mlng≤°»ÀID
                .lng≤°»Àø∆ “ID = mlng≤°»Àø∆ “id
                .strπ“∫≈µ• = mstrπ“∫≈µ•
                .str–‘± = mstr–‘±
            End With
            If intType = 2 Then
                lngPreRow÷–“©∑ø = GetPreRow÷–“©∑ø(lngRow)
                lng“©∆∑ID = Val("" & rsInput! ’∑—œ∏ƒøID)   '“ª◊È≈‰∑Ω ±Œ™ø’
            End If
            On Error Resume Next
            '∏ƒ‘ÏΩ”ø⁄£∫“‘«∞int≥°∫œ¥´Œ¥¥´£¨œ÷‘⁄¥´0£¨bytUseType“‘«∞Œ¥¥´£¨œ÷‘⁄¥´0
            If intType = 2 Then
                blnOK = frmAdviceFormula.ShowMe(Me, gclsInsure, txt“Ω÷ˆƒ⁄»›.hWnd, t_Pati, 0, 0, 1, 1, 1, rsInput!’Ô¡∆œÓƒøID, strExtData, _
                             str’™“™Out, lng“©∆∑ID, lngPreRow÷–“©∑ø)
            Else
                blnOK = frmAdviceEditEx.ShowMe(Me, txt“Ω÷ˆƒ⁄»›.hWnd, t_Pati, 0, intType, 0, 1, 1, 1, mblnNewLIS, True, rsInput!’Ô¡∆œÓƒøID, strExtData, _
                            strAppend, GetAdviceAppendItem, GetAdviceDiagnosis, str ÷ ı≤øŒª)
            End If
            
            On Error GoTo errH
            If intType = 2 Then str’™“™ = str’™“™Out
            If Not blnOK Then Exit Function
        End If
        
        If lngAppType <> -1 Or lngApplyID <> 0 Then
            On Error Resume Next
            If lngAppType = 0 Then
                blnOK = ApplyNewºÏ≤È…Í«Î(0, rsInput!’Ô¡∆œÓƒøID & "", objAppPages())
            ElseIf lngAppType = 1 Then
                blnOK = ApplyNew ‰—™…Í«Î(0, rsInput!’Ô¡∆œÓƒøID & "", rsCard, bln±∏—™)
            ElseIf lngAppType = 3 Then
                blnOK = ApplyNewºÏ—È…Í«Î(0, rsInput!±‡¬Î & "", rsCard)
                        ElseIf lngApplyID <> 0 Then
                FuncApplyCustom 0, lngApplyID, , Val(rsInput!’Ô¡∆œÓƒøID & "")
            End If
            On Error GoTo errH
            If Not blnOK Then Exit Function
        End If
        
        '–ﬁ∏ƒ“—”–œÓƒø ±,œ»…æ≥˝µ±«∞“Ω÷ˆµƒƒ⁄»›
        '---------------------------------------------------------------------------------------------------------------
        If .RowData(lngRow) <> 0 Then
            If InStr(",5,6,", .TextMatrix(lngRow, COL_¿‡±)) > 0 Then
                'Œ˜≥…“©°¢÷–≥…“©
                If Not blnGroup Then
                    'µ•∏ˆ≥…“©…æ≥˝∏¯“©Õææ∂––,≤¢«Â≥˝µ±«∞––
                    i = .FindRow(CLng(.TextMatrix(lngRow, COL_œ‡πÿID)), lngRow + 1)
                    Call DeleteRow(i)
                    Call DeleteRow(lngRow, True)
                Else
                    '“ª◊È≥…“© ±,÷ª«Â≥˝µ±«∞––
                    lng…Û∫À◊¥Ã¨ = Val(vsAdvice.TextMatrix(lngRow, COL_…Û∫À◊¥Ã¨))
                    Call DeleteRow(lngRow, True)
                    If lng…Û∫À◊¥Ã¨ <> 0 Then Call ReSet…Û∫À◊¥Ã¨Õº±Í(lngGroupRow)
                End If
            ElseIf InStr(",D,F,K,", .TextMatrix(lngRow, COL_¿‡±)) > 0 Then
                If .TextMatrix(lngRow, COL_¿‡±) = "D" And 0 <> Val(.TextMatrix(lngRow, COL_…Í«Î–Ú∫≈)) Then
                    Call DeleteºÏ≤È ÷ ı ‰—™(lngRow, True, lngTmpRow)
                    lngRow = lngTmpRow
                Else
                    'ºÏ≤È◊È∫œœÓƒø£¨ ÷ ıœÓƒø£¨ ‰—™“Ω÷ˆ
                    '…æ≥˝≤øŒª––£¨ªÚ ÷ ı∏Ωº”––(∏Ωº” ÷ ı,¬È◊ÌœÓƒø)£¨ªÚ ‰—™Õææ∂
                    Call DeleteºÏ≤È ÷ ı ‰—™(lngRow)
                    '«Â≥˝µ±«∞––
                    Call DeleteRow(lngRow, True)
                End If
            ElseIf RowIn≈‰∑Ω––(lngRow) Then
                '÷–“©≈‰∑Ω£∫À≥–Ú(–Ú∫≈)“™«Û±ÿ–Î—œ∏Òøÿ÷∆
                '…æ≥˝◊È≥…Œ∂“©º∞ºÂ∑®––:…æ≥˝÷Æ∫Û÷ÿ–¬∂®Œªµƒµ±«∞––
                lngRow = Delete÷–“©≈‰∑Ω(lngRow)
                '«Â≥˝µ±«∞––(÷–“©”√∑®––)
                Call DeleteRow(lngRow, True)
            ElseIf RowInºÏ—È––(lngRow) Then
                If lngAppType = 3 Then
                    Call DeleteºÏ—È…Í«Îµ•(lngRow, True, lngTmpRow)
                    lngRow = lngTmpRow
                Else
                    '…æ≥˝ºÏ—ÈœÓƒø––:…æ≥˝÷Æ∫Û÷ÿ–¬∂®Œªµƒµ±«∞––
                    lngRow = DeleteºÏ—È◊È∫œ(lngRow)
                    '«Â≥˝µ±«∞––(≤…ºØ∑Ω∑®––)
                    Call DeleteRow(lngRow, True)
                End If
            Else
                '∆‰À¸œÓƒø÷±Ω”«Â≥˝µ±«∞––ƒ⁄»›
                Call DeleteRow(lngRow, True)
            End If
        End If
        
        'µ±«∞–––¬‘ˆ“Ω÷ˆ
        '---------------------------------------------------------------------------------------------------------------
        If InStr(",7,8,", rsInput!¿‡±ID) > 0 Then
            '÷–“©≈‰∑Ω(µ•Œ∂≤›“©µ±≈‰∑Ω¥¶¿Ì):¥¶¿Ì÷Æ∫Û÷ÿ–¬∂®Œªµƒµ±«∞––
            lngRow = AdviceSet÷–“©≈‰∑Ω(rsInput!’Ô¡∆œÓƒøID, lngRow, lng”√∑®ID, strExtData, , str’™“™)
    
            '–¬‘ˆ∫Ûπÿ¡™’Ô∂œµƒ±Íº«¥¶¿Ì
            Call SetDiagFlag(vsAdvice.Row, 1)
        ElseIf rsInput!¿‡±ID = "9" Then
            '≥…Ã◊“Ω÷ˆ–Ë“™∑÷Ω‚Œ™∂‡∏ˆœÓƒøº”»Î
            Call AdviceSet≥…Ã◊œÓƒø(rsInput!’Ô¡∆œÓƒøID, lngRow, strExtData)
            
            '–¬‘ˆ∫Ûπÿ¡™’Ô∂œµƒ±Íº«¥¶¿Ì
            '≥…Ã◊∫Õ∏¥÷∆ ±‘⁄◊”π˝≥Ã÷–≈˙¡ø¥¶¿Ì¡À
        ElseIf rsInput!¿‡±ID = "C" Then
            If lngAppType = 3 Then
                Call AdviceSetºÏ—È…Í«Î(lngRow, rsCard)
            Else
                'ºÏ—È◊È∫œ
                lngRow = AdviceSetºÏ—È◊È∫œ(lngRow, lng”√∑®ID, strExtData, , str’™“™)
            
                '–¬‘ˆ∫Ûπÿ¡™’Ô∂œµƒ±Íº«¥¶¿Ì
                Call SetDiagFlag(vsAdvice.Row, 1)
            End If
        ElseIf lngAppType = 0 Then
            'º”»ÎºÏ≤È…Í«Îµ•
            lngRow = AdviceSetºÏ≤È…Í«Î(lngRow, objAppPages())
            Call SetDiagFlag(vsAdvice.Row, 1)
        ElseIf lngAppType = 1 Then
            lngRow = AdviceSet ‰—™…Í«Î(lngRow, rsCard)
            Call SetDiagFlag(vsAdvice.Row, 1)
        Else
            ' ‰—™“Ω÷ˆºÏ≤È£¨±ÿ–Î÷–º∂º∞“‘…œ◊®“µºº ı÷∞ŒÒµƒ“Ω ¶≤≈‘ –Ìœ¬¥Ô
            If rsInput!¿‡±ID & "" = "K" And gbln ‰—™…Í«Î÷–º∂“‘…œ Then
                If UserInfo.◊®“µºº ı÷∞ŒÒ <> "÷˜÷Œ“Ω ¶" And UserInfo.◊®“µºº ı÷∞ŒÒ <> "÷˜»Œ“Ω ¶" And UserInfo.◊®“µºº ı÷∞ŒÒ <> "∏±÷˜»Œ“Ω ¶" Then
                    MsgBox "∆Ù”√¡À ‰—™∑÷º∂π‹¿Ì∫Û£¨ ‰—™“Ω÷ˆ÷ª”–÷–º∂º∞“‘…œ◊®“µºº ı÷∞ŒÒ“Ω ¶≤≈ƒ‹œ¬¥Ô°£", vbInformation, Me.Caption
                    Exit Function
                End If
            End If
            '÷–°¢Œ˜≥…“©£¨Œ¿≤ƒ£¨ºÏ≤È(◊È∫œ)£¨ ÷ ı(◊È∫œ)£¨ ‰—™£¨º∞∆‰À¸’Ô¡∆œÓƒø
            Call AdviceSet’Ô¡∆œÓƒø(rsInput, lngRow, lng”√∑®ID, lngGroupRow, strExtData, str’™“™, str ÷ ı≤øŒª, bln±∏—™)
            
            '–¬‘ˆ∫Ûπÿ¡™’Ô∂œµƒ±Íº«¥¶¿Ì
            Call SetDiagFlag(vsAdvice.Row, 1)
            
            '◊‘∂Ø…Ë÷√“ª≤¢∏¯“©
            If InStr(",5,6,", rsInput!¿‡±ID) > 0 Then
                i = CheckAutoMerge(lngRow)
                If i = 1 Then
                    mblnRowMerge = True
                ElseIf i = 2 Then
                    mblnRowMerge = False
                    Set objControl = cbsMain.FindControl(, conMenu_Merge, , True)
                    objControl.Checked = False
                End If
                If Not RowIn“ª≤¢∏¯“©(lngRow) Then
                    If mblnRowMerge Then
                        ' ÷π§ π“ª≤¢∏¯“©
                        lngRowID = .RowData(lngRow)
                        Call MergeRow(lngPreRow, lngRow) '±æ¿¥æÕ «œ‘ æµ±«∞––µƒƒ⁄»›,≤ª”√‘Ÿ«ø––RowChange
                        lngRow = .FindRow(lngRowID, lngPreRow + 1)
                        'øπæ˙“©ŒÔ–¬‘ˆ“ª–– ±“ª≤¢∏¯“©µƒ£¨”¶∏√»± °”Î…œ“ª––µƒ°∞”√“©ƒøµƒ°±∫Õ°∞”√“©¿Ì”…°±œ‡Õ¨°£
                        If Val(.TextMatrix(lngRow, COL_øπæ˙µ»º∂)) <> 0 Then
                            If lngRow > 1 Then
                                txt”√“©¿Ì”….Text = .TextMatrix(lngRow - 1, COL_”√“©¿Ì”…)
                                If Val(.TextMatrix(lngRow - 1, COL_”√“©ƒøµƒ)) <> 0 Then
                                    cboDruPur.ListIndex = Val(.TextMatrix(lngRow - 1, COL_”√“©ƒøµƒ))
                                End If
                            End If
                        End If
                        '–¬¬º»Îµƒ“©∆∑“ª≤¢∏¯“© ±£¨»Áπ˚√ª”–∆Ù”√ÃÏ ˝¬º»Î≤Œ ˝£¨µ´”√∑®”√¡ø÷∏∂®¡Àµ•¡ø‘Ú◊‘∂Ø∑¥À„◊‹¡ø£¨∏˘æ›µ⁄“ªÃı“Ω÷ˆµƒÃÏ ˝¿¥∑¥À„
                        If Val(.TextMatrix(lngRow, COL_µ•¡ø)) > 0 And mblnÃÏ ˝ = False Then
                            Call GetRowScope(lngRow, lngBegin, lngEnd)
                            If Val(.TextMatrix(lngBegin, COL_◊‹¡ø)) > 0 And Val(.TextMatrix(lngBegin, COL_µ•¡ø)) > 0 And .TextMatrix(lngBegin, COL_∆µ¬ ) <> "" _
                                And Val(.TextMatrix(lngBegin, COL_∆µ¬ ¥Œ ˝)) <> 0 And Val(.TextMatrix(lngBegin, COL_∆µ¬ º‰∏Ù)) <> 0 _
                                And Val(.TextMatrix(lngBegin, COL_º¡¡øœµ ˝)) <> 0 And Val(.TextMatrix(lngBegin, COL_√≈’Ô∞¸◊∞)) <> 0 Then
                                sngÃÏ ˝ = Calc»± °“©∆∑ÃÏ ˝(Val(.TextMatrix(lngBegin, COL_◊‹¡ø)), Val(.TextMatrix(lngBegin, COL_µ•¡ø)), _
                                                Val(.TextMatrix(lngBegin, COL_∆µ¬ ¥Œ ˝)), Val(.TextMatrix(lngBegin, COL_∆µ¬ º‰∏Ù)), .TextMatrix(lngBegin, COL_º‰∏Ùµ•Œª), _
                                                Val(.TextMatrix(lngBegin, COL_º¡¡øœµ ˝)), Val(.TextMatrix(lngBegin, COL_√≈’Ô∞¸◊∞)), _
                                                Val(.TextMatrix(lngBegin, COL_ø…∑Ò∑÷¡„)))
                                .TextMatrix(lngRow, COL_◊‹¡ø) = ReGet“©∆∑◊‹¡ø(Val(.TextMatrix(lngRow, COL_◊‹¡ø)), Val(.TextMatrix(lngRow, COL_µ•¡ø)), sngÃÏ ˝, lngRow)
                            End If
                        End If
                    ElseIf lngPreRow <> -1 Then
                        '◊‘∂Ø π“ª≤¢∏¯“©
                        Set objControl = cbsMain.FindControl(, conMenu_Merge, , True)
                        If objControl.Checked = True Then
                            If .TextMatrix(lngPreRow, COL_¿‡±) = rsInput!¿‡±ID Then
                                If RowIn“ª≤¢∏¯“©(lngPreRow) And RowCanMerge(lngPreRow, lngRow) And GetNextRow(lngRow) = -1 Then
                                    mblnRowMerge = True
                                    cbsMain.RecalcLayout 'º¥ ±À¢–¬
                                    lngRowID = .RowData(lngRow)
                                    Call MergeRow(lngPreRow, lngRow, False)
                                    lngRow = .FindRow(lngRowID, lngPreRow + 1)
                                End If
                            End If
                        End If
                    End If
                End If
            End If
        End If
        
        '∏¸–¬∏Ωº˛ƒ⁄»›:“‘µ±«∞ø…º˚––Œ™◊º
        If strAppend <> "" Then
            .TextMatrix(.Row, COL_∏ΩœÓ) = strAppend
            .Cell(flexcpData, .Row, COL_∏ΩœÓ) = 1 '±Ì√˜–Ë“™÷ÿ–¬–¥»Î(–¬‘ˆªÚ–ﬁ∏ƒ)
            Call ReplaceAdviceAppend(.Row) '»± °ÃÊªª∆‰À˚“Ω÷ˆµƒ…Í«Î∏ΩœÓ
        End If
        
        ' ‰»ÎŒ˜“©ø…≥…“© ±◊‘∂Ø‘ˆº”∆§ ‘––:‘ˆº”÷Æ∫Û»‘∂®Œª‘⁄µ±«∞“©∆∑
        If lng∆§ ‘ID <> 0 And Not bln∆§ ‘–– Then
            Call AdviceSetπ˝√Ù ‘—È(.Row, lng∆§ ‘ID) '◊¢“‚”√µ±«∞––,“ÚŒ™“ª≤¢÷Æ∫Û∂®Œª∏ƒ±‰
        End If
        
        '÷ÿ–¬◊‘∂Øµ˜’˚––∏ﬂ
        Call .AutoSize(col_“Ω÷ˆƒ⁄»›)
    End With
    
    mblnNoSave = True '±Íº«Œ™Œ¥±£¥Ê
    
    '∂‘±£œ’∂‘¬ÎΩ¯––ºÏ≤È
    Call GetInsureStr(strIDs1, strIDs2, str“Ω÷ˆƒ⁄»›, vsAdvice.Row)
    strMsg = CheckAdviceInsure(mintœ’¿‡, mblnÃ·–—∂‘¬Î, mlng≤°»ÀID, 1, strIDs1, strIDs2, str“Ω÷ˆƒ⁄»›)
    If strMsg <> "" Then
        If gint“Ω±£∂‘¬Î = 2 Then strMsg = strMsg & vbCrLf & vbCrLf & "«Îœ»∫Õœ‡πÿ»À‘±¡™œµ¥¶¿Ì£¨∑Ò‘Ú“Ω÷ˆΩ´≤ª‘ –Ì±£¥Ê°£"
        vMsg = frmMsgBox.ShowMsgBox(strMsg, Me, True)
        If vMsg = vbIgnore Then mblnÃ·–—∂‘¬Î = False
    End If
    
    'µ˜”√Õ‚π“Ω”ø⁄
    If CreatePlugInOK(p√≈’Ô“Ω÷ˆœ¬¥Ô, mint≥°∫œ) Then
        If zlPluginAdviceEnter(vsAdvice.Row) = False Then
            vsAdvice.Refresh: Exit Function
        End If
    End If
    
    AdviceInput = True
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Sub zlPASSMap()
'π¶ƒ‹:…Ë÷√Pass VsAdvieº∞¡–”≥…‰
'◊¢“‚:…æ≥˝ªÚ–ﬁ∏ƒœ¬√Ê¡–÷– ˝æ› ±£¨«ÎºÏ≤È∫œ¿Ì”√“©≤øº˛÷–µƒπÿ¡™¥¶¿Ì°£
    If mobjPassMap Is Nothing Then
        Set mobjPassMap = DynamicCreate("zlPassInterface.clsPassMap", "∫œ¿Ì”√“©º‡≤‚", True)
        mblnPass = Not mobjPassMap Is Nothing And Not gobjPass Is Nothing
    End If
    
    If mblnPass Then
        With mobjPassMap
            .lngModel = PM_√≈’Ô±‡º≠
            .int≥°∫œ = mint≥°∫œ
            Set .frmMain = Me
            Set .vsAdvice = vsAdvice
            Set .objCmdBar = cmdAlley
            
            Set .diags = .GetDiags
            
            Set .VSCOL = .GetVSCOL( _
                , COL_œ‡πÿID, COL_¿‡±, COL_’Ô¡∆œÓƒøID, COL_ ’∑—œ∏ƒøID, col_“Ω÷ˆƒ⁄»›, , COL_µ•¡ø, COL_µ•¡øµ•Œª, COL_”√∑®, _
                COL_ÃÏ ˝, COL_”§∂˘, COL_ø™÷ˆ ±º‰, COL_ø™÷ˆ“Ω…˙, COL_ø™ º ±º‰, COL_ø™÷ˆø∆ “ID, , COL_∆µ¬ , COL_∆µ¬ ¥Œ ˝, COL_∆µ¬ º‰∏Ù, _
                COL_º‰∏Ùµ•Œª, COL_æØ æ, COL_–Ú∫≈, COL_◊¥Ã¨, COL_EDIT, , , , COL_÷¥–––‘÷ , COL_±Í±æ≤øŒª, _
                , , , , , COL_◊‹¡ø, COL_◊‹¡øµ•Œª, COL_“Ω…˙÷ˆÕ–, COL_”√“©ƒøµƒ, COL_≤Ÿ◊˜¿‡–Õ, , _
                COL_”√“©¿Ì”…, COL_±Í÷æ, COL_¥¶∑Ω–Ú∫≈, COL_÷¥––∑÷¿‡)
            Set .PassPati = .GetPatient()
            Call zlPASSPati
        End With
    End If
End Sub

Private Sub zlPASSPati()
'π¶ƒ‹:…Ë÷√≤°»À–≈œ¢
    If Not mobjPassMap Is Nothing Then
        With mobjPassMap.PassPati
            .int”§∂˘ = IIF(cbo”§∂˘.ListIndex = -1, 0, cbo”§∂˘.ListIndex)  '»± °–¬‘ˆ≤°»ÀŒ™0
            .dbl±Í ∂∫≈ = mdbl√≈’Ô∫≈
            .Dat≥ˆ…˙»’∆⁄ = mDat≥ˆ…˙»’∆⁄
            .lng≤°»ÀID = mlng≤°»ÀID
            .lngπ“∫≈ID = mlngπ“∫≈ID
            .strπ“∫≈µ• = mstrπ“∫≈µ•
            .str–‘± = mstr–‘±
            .str–’√˚ = mstr–’√˚
        End With
    End If
End Sub

Private Sub zlPassDrags()
'π¶ƒ‹:…Ë÷√≤°»À’Ô∂œ–≈œ¢
    Dim i As Long
    
    If Not mobjPassMap Is Nothing Then
        Set mobjPassMap.diags = Nothing '«Âø’÷ÿ–¬∏≥÷µ
        Set mobjPassMap.diags = mobjPassMap.GetDiags
        With vsDiag
            For i = .FixedRows To .Rows - 1
                mobjPassMap.diags.Add .TextMatrix(i, col’Ô∂œ), .TextMatrix(i, col’Ô∂œ±‡¬Î), .TextMatrix(i, colº≤≤°±‡¬Î), "_" & i
            Next
        End With
    End If
End Sub

Private Sub MergeRow(ByVal lngRow1 As Long, ByVal lngRow2 As Long, Optional ByVal blnCheck As Boolean = True)
'π¶ƒ‹£∫Ω´¡Ω––…Ë÷√Œ™“ª≤¢∏¯“©
'≤Œ ˝£∫lngRow1=«∞√Ê––,ø…ƒ‹±æ¿¥“—æ≠ Ù”⁄“ª≤¢∏¯“©
'      lngRow2=µ±«∞––
'Àµ√˜£∫…Ë÷√ÕÍ≥…∫Û,±Ì∏Ò»‘∂®Œª‘⁄‘≠lngRow2µƒµ±«∞––
    Dim lngBegin As Long, lngEnd As Long
    Dim blnDo As Boolean, lngTmp As Long
    Dim lngDiag As Long
    
    With vsAdvice
        If blnCheck Then
            blnDo = RowCanMerge(lngRow1, lngRow2)
        Else
            blnDo = True
        End If
        If blnDo Then
            mblnRowChange = False: .Redraw = flexRDNone
            
            'º«¬ºµ±«∞––µƒπÿ¡™’Ô∂œ,“ª≤¢∫Û“‘¥ÀŒ™◊º
            lngDiag = AdviceHaveDiag(lngRow2)
            
            lngTmp = .RowData(lngRow2) 'º«¬º“‘‘Ÿ∂®ŒªµΩµ±«∞––
            'œ»»°œ˚÷Æ«∞µƒ“ª≤¢∏¯“©
            If RowIn“ª≤¢∏¯“©(lngRow1) Then
                Call Get“ª≤¢∏¯“©∑∂Œß(Val(.TextMatrix(lngRow1, COL_œ‡πÿID)), lngBegin, lngEnd)
                Call AdviceSetµ•∂¿∏¯“©(lngBegin, lngEnd)
                lngRow1 = lngBegin
                lngRow2 = .FindRow(lngTmp, lngBegin + 1)
            End If
            Call AdviceSet“ª≤¢∏¯“©(lngRow1, lngRow2)
            lngRow2 = .FindRow(lngTmp, lngBegin + 1)
            .Row = lngRow2
            
            '“‘“ª≤¢÷Æ«∞µƒµ±«∞––Œ™◊ºª÷∏¥πÿ¡™’Ô∂œ
            '“ª≤¢π˝≥Ã÷–«∞√Êµƒ“©∆∑’Ô∂œπÿ¡™“—±ªDeleteRow“∆≥˝
            If lngDiag <> -1 Then
                Call SetDiagFlag(.Row, 1, lngDiag)
            End If
            
            mblnRowChange = True: .Redraw = flexRDDirect
        End If
    End With
End Sub

Private Sub SplitRow(ByVal lngRow As Long)
'π¶ƒ‹£∫Ω´÷∏∂®––¥”“ª≤¢∏¯“©÷–∂¿¡¢≥ˆ¿¥(∏√◊È“ª≤¢∏¯“©±ÿ–Î÷¡…Ÿ∞¸∫¨»˝––)
'≤Œ ˝£∫lngRow=µ±«∞––,«“Œ™“ª≤¢∏¯“©÷–µƒ◊Ó∫Û“ª“©∆∑––
'Àµ√˜£∫…Ë÷√ÕÍ≥…∫Û,±Ì∏Ò»‘∂®Œª‘⁄‘≠lngRowµƒµ±«∞––
    Dim lngBegin As Long, lngEnd As Long, lngTmp As Long
    
    With vsAdvice
        mblnRowChange = False: .Redraw = flexRDNone
        lngTmp = .RowData(lngRow) 'º«¬º”√”⁄ª÷∏¥∂®Œªµ±«∞––
        Call Get“ª≤¢∏¯“©∑∂Œß(Val(.TextMatrix(lngRow, COL_œ‡πÿID)), lngBegin, lngEnd)
        
        'œ»»°œ˚’˚∏ˆµƒ“ª≤¢∏¯“©
        Call AdviceSetµ•∂¿∏¯“©(lngBegin, lngEnd)
        
        '‘Ÿ…Ë÷√≥˝◊Ó∫Û––Õ‚µƒ––Œ™“ª≤¢∏¯“©
        lngRow = .FindRow(lngTmp, lngBegin + 1)
        lngEnd = GetPreRow(lngRow)
        Call AdviceSet“ª≤¢∏¯“©(lngBegin, lngEnd)
        
        'ª÷∏¥µ±«∞––
        lngRow = .FindRow(lngTmp, lngBegin + 1)
        .Row = lngRow
        mblnRowChange = True: .Redraw = flexRDDirect
    End With
End Sub

Private Sub AdviceSet∏¥÷∆“Ω÷ˆ(ByVal lng≤°»ÀID As Long, ByVal strπ“∫≈µ• As String, ByVal strIDs As String, Optional ByVal blnHistory As Boolean)
'π¶ƒ‹£∫∏¥÷∆÷∏∂®≤°»Àµƒ÷∏∂®“Ω÷ˆ≤˙…˙≥…Œ™–¬“Ω÷ˆ
'Àµ√˜£∫ø…π©Õ‚≤øµ˜”√,µ˜”√÷Æ«∞¥¶”⁄–¬‘ˆ“Ω÷ˆ––
    Dim rsTmp As New ADODB.Recordset
    Dim strSQL As String, bln≈‰∑Ω As Boolean
    Dim lngBegin As Long, lngEnd As Long
    Dim curDate As Date, blnHide As Boolean
    Dim lngø™÷ˆø∆ “ID As Long, dblœ‡πÿID As Double
    Dim lng–Ú∫≈ As Long, intCount As Integer
    Dim lngRow As Long
    Dim i As Long, j As Long
    
    Dim lngŒ˜“©∑øID As Long, lng≥…“©∑øID As Long, lng÷–“©∑øID As Long, lng∑¢¡œ≤ø√≈ID As Long
    Dim str“©∑øIDs As String, str∏ΩœÓ As String
    Dim bln“©∆∑–° ˝ ‰»Î As Boolean
    Dim str∏ﬂŒ£“©∆∑ As String
    
    Screen.MousePointer = 11
    
    On Error GoTo errH
    
    strSQL = _
        " Select a.ID+0.1 As ID,Decode(a.œ‡πÿid,Null,Null,a.œ‡πÿid+0.1) As œ‡πÿid,Nvl(A.”§∂˘,0) as ”§∂˘,A.–Ú∫≈,A.“Ω÷ˆ∆⁄–ß," & _
        " A.“Ω÷ˆ◊¥Ã¨,A.’Ô¡∆¿‡±,A.’Ô¡∆œÓƒøID,B.√˚≥∆,A.±Í±æ≤øŒª,A.ºÏ≤È∑Ω∑®,A.÷¥––±Íº«,A. ’∑—œ∏ƒøID," & _
        " A.ø™ º÷¥–– ±º‰,Nvl(B.√˚≥∆,A.“Ω÷ˆƒ⁄»›) “Ω÷ˆƒ⁄»›,A.“Ω…˙÷ˆÕ–,A.µ•¥Œ”√¡ø,A.ÃÏ ˝,A.◊‹∏¯”Ë¡ø,B.º∆À„µ•Œª," & _
        " A.÷¥––∆µ¥Œ,A.∆µ¬ ¥Œ ˝,A.∆µ¬ º‰∏Ù,A.º‰∏Ùµ•Œª,B.º∆À„∑Ω Ω,B.÷¥––∆µ¬ ,B.≤Ÿ◊˜¿‡–Õ,B.µ•∂¿”¶”√,B.÷¥––∑÷¿‡," & _
        " B.º∆º€–‘÷ ,A.÷¥–– ±º‰∑Ω∞∏,Decode(nvl(Instr(',5,6,7,',a.’Ô¡∆¿‡±),0),0,b.÷¥––ø∆ “,a.÷¥–––‘÷ ) as ÷¥–––‘÷ ,A.÷¥––ø∆ “ID,A.ø™÷ˆø∆ “ID,A.ø™÷ˆ“Ω…˙,A.ø™÷ˆ ±º‰," & _
        " A.ΩÙº±±Í÷æ,C.∂æ¿Ì∑÷¿‡,C.øπ…˙Àÿ,C.“©∆∑º¡–Õ,B.¬º»Îœﬁ¡ø,C.¥¶∑Ωœﬁ¡ø,C.¥¶∑Ω÷∞ŒÒ," & _
        " D.º¡¡øœµ ˝,D.√≈’Ô∞¸◊∞,D.√≈’Ôµ•Œª,F.º∆À„µ•Œª as …¢◊∞µ•Œª,E.∏˙◊Ÿ‘⁄”√,D.√≈’Ôø…∑Ò∑÷¡„ As ø…∑Ò∑÷¡„,a.≈‰∑ΩID,c.¡Ÿ¥≤◊‘π‹“©,d.∏ﬂŒ£“©∆∑,a.◊È∫œœÓƒøID,c.»‹√Ω,d.ª˘±æ“©ŒÔ" & _
        " From ≤°»À“Ω÷ˆº«¬º A,’Ô¡∆œÓƒøƒø¬º B,“©∆∑Ãÿ–‘ C,“©∆∑πÊ∏Ò D,≤ƒ¡œÃÿ–‘ E, ’∑—œÓƒøƒø¬º F" & _
        " Where Nvl(A.“Ω÷ˆ∆⁄–ß,0)=1 And A.’Ô¡∆œÓƒøID=B.ID" & _
        " And A.’Ô¡∆œÓƒøID=C.“©√˚ID(+) And A. ’∑—œ∏ƒøID=D.“©∆∑ID(+)" & _
        " And A. ’∑—œ∏ƒøID=E.≤ƒ¡œID(+) And E.≤ƒ¡œID=F.ID(+)" & _
        " And A.≤°»ÀID+0=[1] And A.π“∫≈µ•=[2]" & _
        " And Instr([3],','||A.ID||',')>0" & _
        " Order by ”§∂˘,–Ú∫≈"
    If blnHistory Then
        strSQL = Replace(strSQL, "≤°»À“Ω÷ˆº«¬º", "H≤°»À“Ω÷ˆº«¬º")
    End If
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng≤°»ÀID, strπ“∫≈µ•, "," & strIDs & ",")
    On Error GoTo 0
    
    If Not rsTmp.EOF Then
        If rsTmp!’Ô¡∆¿‡± = "Z" And (rsTmp!≤Ÿ◊˜¿‡–Õ = "1" Or rsTmp!≤Ÿ◊˜¿‡–Õ = "2") Then
            If CheckInHosAdvice Then
                Screen.MousePointer = 0
                Exit Sub
            End If
        End If
        
    
        lngBegin = vsAdvice.Row 'ø™ º–¬‘ˆ––
        lng–Ú∫≈ = GetCurRow–Ú∫≈(lngBegin) '∆ º–Ú∫≈
        intCount = 0 '“—æ≠…Ë÷√µƒ–– ˝
        curDate = zlDatabase.Currentdate
        lngø™÷ˆø∆ “ID = Getø™÷ˆø∆ “ID(UserInfo.ID, mlng“Ωººø∆ “ID, mlng≤°»Àø∆ “id, 1)
        '“©∆∑◊‹¡ø «∑Òø…“‘ ‰»Î–° ˝£¨÷–“©≤ªø…“‘ ‰»Î–° ˝£¨“Ú¥À÷ªºÏ≤ÈŒ˜“©”Î÷–≥…“©
        bln“©∆∑–° ˝ ‰»Î = InStr(GetInsidePrivs(p◊°‘∫“Ω÷ˆœ¬¥Ô), "“©∆∑–° ˝ ‰»Î") > 0
            
        mblnRowChange = False
        With vsAdvice
            .Redraw = flexRDNone
            For i = lngBegin To rsTmp.RecordCount + lngBegin - 1
                If i > lngBegin Then .AddItem "", i

                bln≈‰∑Ω = False
                
                .RowData(i) = -1 * rsTmp!ID
                If Not IsNull(rsTmp!œ‡πÿID) Then
                    .TextMatrix(i, COL_œ‡πÿID) = -1 * rsTmp!œ‡πÿID
                End If
                .TextMatrix(i, COL_–Ú∫≈) = lng–Ú∫≈ + intCount
                
                .TextMatrix(i, COL_EDIT) = 1 '–¬‘ˆ
                .Cell(flexcpData, i, COL_EDIT) = CStr(lng≤°»ÀID & "," & strπ“∫≈µ•) 'º«¬ºœ‡πÿµƒ∏¥÷∆œÓƒø
                .TextMatrix(i, COL_◊¥Ã¨) = 1 '–¬ø™
                .TextMatrix(i, COL_”§∂˘) = cbo”§∂˘.ListIndex
                .TextMatrix(i, COL_¿‡±) = rsTmp!’Ô¡∆¿‡±
                .TextMatrix(i, COL_’Ô¡∆œÓƒøID) = rsTmp!’Ô¡∆œÓƒøID
                .TextMatrix(i, COL_√˚≥∆) = rsTmp!√˚≥∆
                .TextMatrix(i, COL_±Í±æ≤øŒª) = Nvl(rsTmp!±Í±æ≤øŒª)
                .TextMatrix(i, COL_ºÏ≤È∑Ω∑®) = Nvl(rsTmp!ºÏ≤È∑Ω∑®)
                .TextMatrix(i, COL_÷¥––±Íº«) = Nvl(rsTmp!÷¥––±Íº«, 0)
                .TextMatrix(i, COL_ ’∑—œ∏ƒøID) = Nvl(rsTmp! ’∑—œ∏ƒøID)
                .TextMatrix(i, col_“Ω÷ˆƒ⁄»›) = Nvl(rsTmp!“Ω÷ˆƒ⁄»›)
                .TextMatrix(i, COL_“Ω…˙÷ˆÕ–) = Nvl(rsTmp!“Ω…˙÷ˆÕ–)
                .Cell(flexcpData, i, COL_“Ω…˙÷ˆÕ–) = gclsInsure.GetItemInfo(mintœ’¿‡, mlng≤°»ÀID, Val(.TextMatrix(i, COL_ ’∑—œ∏ƒøID)), "", 0, "", .TextMatrix(i, COL_’Ô¡∆œÓƒøID))
                
                .TextMatrix(i, COL_º∆º€–‘÷ ) = Nvl(rsTmp!º∆º€–‘÷ , 0)
                .TextMatrix(i, COL_º∆À„∑Ω Ω) = Nvl(rsTmp!º∆À„∑Ω Ω, 0)
                .TextMatrix(i, COL_∆µ¬ –‘÷ ) = Nvl(rsTmp!÷¥––∆µ¬ , 0)
                .TextMatrix(i, COL_≤Ÿ◊˜¿‡–Õ) = Nvl(rsTmp!≤Ÿ◊˜¿‡–Õ)
                .TextMatrix(i, COL_µ•∂¿”¶”√) = Nvl(rsTmp!µ•∂¿”¶”√)
                .TextMatrix(i, COL_÷¥––∑÷¿‡) = Nvl(rsTmp!÷¥––∑÷¿‡, 0)
                .TextMatrix(i, COL_∂æ¿Ì∑÷¿‡) = Nvl(rsTmp!∂æ¿Ì∑÷¿‡)
                .TextMatrix(i, COL_øπæ˙µ»º∂) = Val("" & rsTmp!øπ…˙Àÿ)
                .TextMatrix(i, COL_≈‰∑ΩID) = Nvl(rsTmp!≈‰∑ΩID)
                .TextMatrix(i, COL_¡Ÿ¥≤◊‘π‹“©) = rsTmp!¡Ÿ¥≤◊‘π‹“© & ""
                .TextMatrix(i, COL_◊È∫œœÓƒøID) = rsTmp!◊È∫œœÓƒøID & ""
                .TextMatrix(i, COL_∏ﬂŒ£“©∆∑) = Val(rsTmp!∏ﬂŒ£“©∆∑ & "")
                .TextMatrix(i, COL_ «∑Ò»‹√Ω) = Val(rsTmp!»‹√Ω & "")
                .TextMatrix(i, COL_ª˘±æ“©ŒÔ) = rsTmp!ª˘±æ“©ŒÔ & ""
                If Val(.TextMatrix(i, COL_∏ﬂŒ£“©∆∑)) <> 0 Then
                    str∏ﬂŒ£“©∆∑ = str∏ﬂŒ£“©∆∑ & vbCrLf & .TextMatrix(i, col_“Ω÷ˆƒ⁄»›) & ":" & Decode(Val(.TextMatrix(i, COL_∏ﬂŒ£“©∆∑)), 1, "A", 2, "B", 3, "C", "") & "º∂£ª"
                End If
                
                .TextMatrix(i, COL_“©∆∑º¡–Õ) = Nvl(rsTmp!“©∆∑º¡–Õ)
                If InStr(",5,6,7,", rsTmp!’Ô¡∆¿‡±) > 0 Then
                    .TextMatrix(i, COL_¥¶∑Ωœﬁ¡ø) = Nvl(rsTmp!¥¶∑Ωœﬁ¡ø)
                Else
                    .TextMatrix(i, COL_¥¶∑Ωœﬁ¡ø) = Nvl(rsTmp!¬º»Îœﬁ¡ø)
                End If
                .TextMatrix(i, COL_¥¶∑Ω÷∞ŒÒ) = Nvl(rsTmp!¥¶∑Ω÷∞ŒÒ)
                
                If InStr(",5,6,7,", .TextMatrix(i, COL_¿‡±)) > 0 Then
                    .TextMatrix(i, COL_º¡¡øœµ ˝) = Nvl(rsTmp!º¡¡øœµ ˝)
                    .TextMatrix(i, COL_√≈’Ô∞¸◊∞) = Nvl(rsTmp!√≈’Ô∞¸◊∞)
                    .TextMatrix(i, COL_√≈’Ôµ•Œª) = Nvl(rsTmp!√≈’Ôµ•Œª)
                    If Not IsNull(rsTmp!º¡¡øœµ ˝) Then
                        .TextMatrix(i, COL_ø…∑Ò∑÷¡„) = Nvl(rsTmp!ø…∑Ò∑÷¡„, 0)
                    End If
                ElseIf .TextMatrix(i, COL_¿‡±) = "4" Then
                    .TextMatrix(i, COL_º¡¡øœµ ˝) = 1
                    .TextMatrix(i, COL_√≈’Ô∞¸◊∞) = 1
                    .TextMatrix(i, COL_√≈’Ôµ•Œª) = Nvl(rsTmp!…¢◊∞µ•Œª)
                    .TextMatrix(i, COL_∏˙◊Ÿ‘⁄”√) = Nvl(rsTmp!∏˙◊Ÿ‘⁄”√)
                End If
                
                If IsDate(txtø™ º ±º‰.Text) Then
                    .TextMatrix(i, COL_ø™ º ±º‰) = Format(txtø™ º ±º‰.Text, "yyyy-MM-dd HH:mm")
                    .Cell(flexcpData, i, COL_ø™ º ±º‰) = txtø™ º ±º‰.Text
                    
                    ' ÷ ı/ ‰—™ ±º‰£∫∏¥÷∆ ±»± °”Îø™ º ±º‰œ‡Õ¨,‘⁄±Í±æ≤øŒª¥¶¿Ì∫Û
                    If rsTmp!’Ô¡∆¿‡± = "K" Or rsTmp!’Ô¡∆¿‡± = "F" Or rsTmp!’Ô¡∆¿‡± = "G" _
                        And Val(.TextMatrix(i, COL_œ‡πÿID)) = Val(.TextMatrix(i - 1, COL_œ‡πÿID)) Then
                        .TextMatrix(i, COL_ ÷ ı ±º‰) = txtø™ º ±º‰.Text
                    End If
                End If
                
                .TextMatrix(i, COL_∆µ¬ ) = Nvl(rsTmp!÷¥––∆µ¥Œ)
                .TextMatrix(i, COL_∆µ¬ ¥Œ ˝) = Nvl(rsTmp!∆µ¬ ¥Œ ˝)
                .TextMatrix(i, COL_∆µ¬ º‰∏Ù) = Nvl(rsTmp!∆µ¬ º‰∏Ù)
                .TextMatrix(i, COL_º‰∏Ùµ•Œª) = Nvl(rsTmp!º‰∏Ùµ•Œª)
                .TextMatrix(i, COL_÷¥–– ±º‰) = Nvl(rsTmp!÷¥–– ±º‰∑Ω∞∏)
                
                .TextMatrix(i, COL_÷¥–––‘÷ ) = Nvl(rsTmp!÷¥–––‘÷ , 0)
                
                '¥¶¿Ì÷¥––ø∆ “
                If rsTmp!’Ô¡∆¿‡± = "Z" Then
                    .TextMatrix(i, COL_÷¥––ø∆ “ID) = Nvl(rsTmp!÷¥––ø∆ “ID)
                ElseIf InStr(",0,5,", Nvl(rsTmp!÷¥–––‘÷ , 0)) = 0 Then
                    If Nvl(rsTmp!÷¥––ø∆ “ID, 0) <> 0 Then
                        If InStr(",5,6,7,", rsTmp!’Ô¡∆¿‡±) > 0 Then
                            str“©∑øIDs = Getø…”√“©∑øIDs(rsTmp!’Ô¡∆¿‡±, rsTmp!’Ô¡∆œÓƒøID, Nvl(rsTmp! ’∑—œ∏ƒøID, 0), mlng≤°»Àø∆ “id, 1)
                            If InStr("," & str“©∑øIDs & ",", "," & rsTmp!÷¥––ø∆ “ID & ",") > 0 Then
                                .TextMatrix(i, COL_÷¥––ø∆ “ID) = Nvl(rsTmp!÷¥––ø∆ “ID, 0)
                            End If
                        ElseIf Nvl(rsTmp!’Ô¡∆¿‡±) = "4" Then
                            str“©∑øIDs = Getø…”√∑¢¡œ≤ø√≈IDs(Nvl(rsTmp! ’∑—œ∏ƒøID, 0), mlng≤°»Àø∆ “id, 1)
                            If InStr("," & str“©∑øIDs & ",", "," & rsTmp!÷¥––ø∆ “ID & ",") > 0 Then
                                .TextMatrix(i, COL_÷¥––ø∆ “ID) = Nvl(rsTmp!÷¥––ø∆ “ID, 0)
                            End If
                        ElseIf Val(.TextMatrix(i, COL_÷¥–––‘÷ )) = 4 Then
                            '4-÷∏∂®ø∆ “ ±≤≈»°,∆‰À¸µƒπÃ∂®…˙≥…
                            .TextMatrix(i, COL_÷¥––ø∆ “ID) = Nvl(rsTmp!÷¥––ø∆ “ID, 0)
                            
                            'ºÏ≤È÷¥––ø∆ “µƒ”––ß–‘
                            If Val(.TextMatrix(i, COL_÷¥––ø∆ “ID)) <> 0 Then
                                If CheckExecDeptValidate(Val(.TextMatrix(i, COL_÷¥––ø∆ “ID)), mlng≤°»Àø∆ “id, 1, Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID))) = False Then
                                    .TextMatrix(i, COL_÷¥––ø∆ “ID) = 0
                                End If
                            End If
                        End If
                    End If
                    If Val(.TextMatrix(i, COL_÷¥––ø∆ “ID)) = 0 Then
                        '“©∆∑°¢Œ¿≤ƒ¿‡µƒ’˚∏ˆ≥…Ã◊œ‡Õ¨
                        If rsTmp!’Ô¡∆¿‡± = "5" Then
                            If lngŒ˜“©∑øID = 0 Then
                                lngŒ˜“©∑øID = Get’Ô¡∆÷¥––ø∆ “ID(mlng≤°»ÀID, 0, rsTmp!’Ô¡∆¿‡±, rsTmp!’Ô¡∆œÓƒøID, Nvl(rsTmp! ’∑—œ∏ƒøID, 0), 4, mlng≤°»Àø∆ “id, 0, 1, 1, True)
                            End If
                            .TextMatrix(i, COL_÷¥––ø∆ “ID) = lngŒ˜“©∑øID
                        ElseIf rsTmp!’Ô¡∆¿‡± = "6" Then
                            If lng≥…“©∑øID = 0 Then
                                lng≥…“©∑øID = Get’Ô¡∆÷¥––ø∆ “ID(mlng≤°»ÀID, 0, rsTmp!’Ô¡∆¿‡±, rsTmp!’Ô¡∆œÓƒøID, Nvl(rsTmp! ’∑—œ∏ƒøID, 0), 4, mlng≤°»Àø∆ “id, 0, 1, 1, True)
                            End If
                            .TextMatrix(i, COL_÷¥––ø∆ “ID) = lng≥…“©∑øID
                        ElseIf rsTmp!’Ô¡∆¿‡± = "7" Then
                            If lng÷–“©∑øID = 0 Then
                                lng÷–“©∑øID = Get’Ô¡∆÷¥––ø∆ “ID(mlng≤°»ÀID, 0, rsTmp!’Ô¡∆¿‡±, rsTmp!’Ô¡∆œÓƒøID, Nvl(rsTmp! ’∑—œ∏ƒøID, 0), 4, mlng≤°»Àø∆ “id, 0, 1, 1, True)
                            End If
                            .TextMatrix(i, COL_÷¥––ø∆ “ID) = lng÷–“©∑øID
                        ElseIf Nvl(rsTmp!’Ô¡∆¿‡±) = "4" Then
                            If lng∑¢¡œ≤ø√≈ID = 0 Then
                                lng∑¢¡œ≤ø√≈ID = Get ’∑—÷¥––ø∆ “ID(mlng≤°»ÀID, 0, rsTmp!’Ô¡∆¿‡±, Nvl(rsTmp! ’∑—œ∏ƒøID, 0), 4, mlng≤°»Àø∆ “id, lngø™÷ˆø∆ “ID, 1, , 1)
                            End If
                            .TextMatrix(i, COL_÷¥––ø∆ “ID) = lng∑¢¡œ≤ø√≈ID
                        Else
                            .TextMatrix(i, COL_÷¥––ø∆ “ID) = Get’Ô¡∆÷¥––ø∆ “ID(mlng≤°»ÀID, 0, rsTmp!’Ô¡∆¿‡±, rsTmp!’Ô¡∆œÓƒøID, 0, Nvl(rsTmp!÷¥–––‘÷ , 0), mlng≤°»Àø∆ “id, lngø™÷ˆø∆ “ID, 1, 1)
                        End If
                    End If
                End If
                
                If rsTmp!’Ô¡∆¿‡± = "E" Then
                    If Nvl(rsTmp!œ‡πÿID, 0) = 0 And Val(.TextMatrix(i - 1, COL_œ‡πÿID)) = -1 * rsTmp!ID Then
                        If InStr(",5,6,", .TextMatrix(i - 1, COL_¿‡±)) > 0 Then
                            'µ±«∞º«¬º «≥…“©µƒ∏¯“©Õææ∂,ø…ƒ‹ «“ª≤¢∏¯“©µƒ
                            For j = i - 1 To .FixedRows Step -1
                                If Val(.TextMatrix(j, COL_œ‡πÿID)) = -1 * rsTmp!ID Then
                                    'œ‘ æ∏¯“©Õææ∂
                                    .TextMatrix(j, COL_”√∑®) = rsTmp!√˚≥∆ & rsTmp!“Ω…˙÷ˆÕ–
                                Else
                                    Exit For
                                End If
                            Next
                        ElseIf InStr(",E,7,", .TextMatrix(i - 1, COL_¿‡±)) > 0 Then
                            'µ±«∞º«¬º «÷–“©≈‰∑Ωµƒ”√∑®,º¥≈‰∑Ωœ‘ æ––
                            .TextMatrix(i, COL_”√∑®) = rsTmp!√˚≥∆
                            bln≈‰∑Ω = True
                        ElseIf .TextMatrix(i - 1, COL_¿‡±) = "C" Then
                            .TextMatrix(i, COL_”√∑®) = rsTmp!√˚≥∆
                        End If
                    ElseIf Not IsNull(rsTmp!œ‡πÿID) And .TextMatrix(i - 1, COL_¿‡±) = "K" And -1 * Nvl(rsTmp!œ‡πÿID, 0) = .RowData(i - 1) Then
                        'µ±«∞º«¬º « ‰—™Õææ∂––
                        .TextMatrix(i - 1, COL_”√∑®) = rsTmp!√˚≥∆
                    ElseIf Not IsNull(rsTmp!œ‡πÿID) Then
                        'µ±«∞º«¬º «÷–“©≈‰∑ΩºÂ∑®––
                        bln≈‰∑Ω = True
                    End If
                ElseIf rsTmp!’Ô¡∆¿‡± = "7" Then
                    bln≈‰∑Ω = True
                End If
                
                'µ•¡ø
                .TextMatrix(i, COL_µ•¡ø) = FormatEx(Nvl(rsTmp!µ•¥Œ”√¡ø), 5)
                If Nvl(rsTmp!’Ô¡∆¿‡±) = "4" Then
                    .TextMatrix(i, COL_µ•¡øµ•Œª) = Nvl(rsTmp!…¢◊∞µ•Œª)
                ElseIf InStr(",5,6,7,", rsTmp!’Ô¡∆¿‡±) > 0 _
                    Or (Val(.TextMatrix(i, COL_∆µ¬ –‘÷ )) = 0 And InStr(",1,2,", Nvl(rsTmp!º∆À„∑Ω Ω, 0)) > 0) Then
                    .TextMatrix(i, COL_µ•¡øµ•Œª) = Nvl(rsTmp!º∆À„µ•Œª)
                End If
                
                'ÃÏ ˝
                If mblnÃÏ ˝ Then
                    .TextMatrix(i, COL_ÃÏ ˝) = Nvl(rsTmp!ÃÏ ˝)
                End If

                '◊‹¡ø
                If InStr(",5,6,", rsTmp!’Ô¡∆¿‡±) > 0 Then
                    '≥…“©¡Ÿ÷ˆ”–◊‹¡ø,“‘¡„ €µ•Œª¥Ê∑≈,√≈’Ôµ•Œªœ‘ æ
                    If Not IsNull(rsTmp!◊‹∏¯”Ë¡ø) And Not IsNull(rsTmp!√≈’Ô∞¸◊∞) Then
                        .TextMatrix(i, COL_◊‹¡ø) = FormatEx(rsTmp!◊‹∏¯”Ë¡ø / rsTmp!√≈’Ô∞¸◊∞, 5)
                    End If
                    .TextMatrix(i, COL_◊‹¡øµ•Œª) = Nvl(rsTmp!√≈’Ôµ•Œª)
                    
                    If Val(.TextMatrix(i, COL_ø…∑Ò∑÷¡„)) = 0 And Not bln“©∆∑–° ˝ ‰»Î And InStr(.TextMatrix(i, COL_◊‹¡ø), ".") > 0 Then
                        .TextMatrix(i, COL_◊‹¡ø) = IntEx(Val(.TextMatrix(i, COL_◊‹¡ø)))
                    End If
                    
                    '≥¨¡øÀµ√˜≤ª∏¥÷∆
                    Call Set”√“©ÃÏ ˝ «∑Ò≥¨∆⁄(i)
                ElseIf bln≈‰∑Ω Then
                    If Not IsNull(rsTmp!◊‹∏¯”Ë¡ø) Then .TextMatrix(i, COL_◊‹¡ø) = rsTmp!◊‹∏¯”Ë¡ø
                    
                    .TextMatrix(i, COL_◊‹¡øµ•Œª) = "∏∂" '÷–“©≈‰∑Ω◊‹¡øµ•ŒªŒ™"∏∂"
                    
                    If rsTmp!’Ô¡∆¿‡± = "E" And rsTmp!≤Ÿ◊˜¿‡–Õ = "4" Then   '÷–“©”√∑®
                        Call Set”√“©ÃÏ ˝ «∑Ò≥¨∆⁄(i)
                    End If
                Else
                    '∆‰À¸¡Ÿ÷ˆ
                    If Not IsNull(rsTmp!◊‹∏¯”Ë¡ø) Then .TextMatrix(i, COL_◊‹¡ø) = rsTmp!◊‹∏¯”Ë¡ø
                        
                    If Nvl(rsTmp!’Ô¡∆¿‡±) = "4" Then
                        .TextMatrix(i, COL_◊‹¡øµ•Œª) = Nvl(rsTmp!…¢◊∞µ•Œª)
                    Else
                        .TextMatrix(i, COL_◊‹¡øµ•Œª) = Nvl(rsTmp!º∆À„µ•Œª)
                    End If
                End If
                
                'øπæ˙“©ŒÔ»± °”√“©ƒøµƒ
                If Val(.TextMatrix(i, COL_øπæ˙µ»º∂)) > 0 Then .TextMatrix(i, COL_”√“©ƒøµƒ) = mstrPurMed
                
                .TextMatrix(i, COL_±Í÷æ) = chkΩÙº±.value 'ø…“‘‘⁄ΩÁ√Êœ»Õ≥“ª…Ë÷√Œ™ΩÙº±
                If gblnKSSStrict And UserInfo.”√“©º∂± < Val(.TextMatrix(i, COL_øπæ˙µ»º∂)) And .TextMatrix(i, COL_±Í÷æ) <> "1" Then

                    .TextMatrix(i, COL_…Û∫À◊¥Ã¨) = 1
                End If
                '¥¶¿Ì ‰—™“Ω÷ˆ…Û∫À◊¥Ã¨
                If .TextMatrix(i, COL_¿‡±) = "E" And .TextMatrix(i, COL_≤Ÿ◊˜¿‡–Õ) = "8" And Val(.TextMatrix(i, COL_œ‡πÿID)) <> 0 Then
                    strSQL = ""
                    strSQL = GetBloodState(IIF(.TextMatrix(i, COL_±Í÷æ) = "1", 1, 0), Val(.TextMatrix(i, COL_÷¥––∑÷¿‡)))
                    .TextMatrix(i - 1, COL_…Û∫À◊¥Ã¨) = strSQL
                    .TextMatrix(i, COL_…Û∫À◊¥Ã¨) = strSQL
                End If
                
                .TextMatrix(i, COL_ø™÷ˆ“Ω…˙) = UserInfo.–’√˚
                .TextMatrix(i, COL_ø™÷ˆø∆ “ID) = lngø™÷ˆø∆ “ID
                .TextMatrix(i, COL_ø™÷ˆ ±º‰) = Format(curDate, "yyyy-MM-dd HH:mm")
                .Cell(flexcpData, i, COL_ø™÷ˆ ±º‰) = Format(curDate, "yyyy-MM-dd HH:mm")
                
                Call SetRow±Í÷æÕº±Í(i, 1)
                
                
                '∂æ¬Èæ´“©∆∑±Í ∂:÷–“©≈‰∑Ωº∞◊È≥…Œ∂÷–“©≤ª¥¶¿Ì
                If InStr(",5,6,", rsTmp!’Ô¡∆¿‡±) > 0 And Not IsNull(rsTmp!∂æ¿Ì∑÷¿‡) Then
                    If InStr(",¬È◊Ì“©,∂æ–‘“©,æ´…Ò“©,æ´…ÒI¿‡,æ´…ÒII¿‡,", rsTmp!∂æ¿Ì∑÷¿‡) > 0 Then
                        .Cell(flexcpFontBold, i, col_“Ω÷ˆƒ⁄»›) = True
                    End If
                End If
                
                lngEnd = i
                intCount = intCount + 1
                
                rsTmp.MoveNext
            Next
            
            '≤˙…˙ºŸ“Ω÷ˆID
            For i = lngBegin To lngEnd
                dblœ‡πÿID = .RowData(i)
                .RowData(i) = GetNext“Ω÷ˆID
                For j = i - 1 To lngBegin Step -1
                    If Val(.TextMatrix(j, COL_œ‡πÿID)) = dblœ‡πÿID Then
                        .TextMatrix(j, COL_œ‡πÿID) = .RowData(i)
                    Else
                        Exit For
                    End If
                Next
                For j = i + 1 To lngEnd
                    If Val(.TextMatrix(j, COL_œ‡πÿID)) = dblœ‡πÿID Then
                        .TextMatrix(j, COL_œ‡πÿID) = .RowData(i)
                    Else
                        Exit For
                    End If
                Next
            Next
            If gblnOut±ÿ”√ Then Call MakeAppNo(2, lngBegin, lngEnd)
            Call Set“Ω÷ˆ≥¨¡ø(lngBegin, lngEnd)
            'µ˜’˚ ‹”∞œÏ––µƒ–Ú∫≈
            Call AdviceSet“Ω÷ˆ–Ú∫≈(lngEnd + 1, intCount)
            
            'œ‘ æ/“˛≤ÿ––
            lngRow = 0
            For i = lngBegin To lngEnd
                blnHide = False
                If .TextMatrix(i, COL_¿‡±) = "E" And Val(.TextMatrix(i, COL_œ‡πÿID)) = 0 Then
                    If Val(.TextMatrix(i - 1, COL_œ‡πÿID)) = .RowData(i) _
                        And InStr(",5,6,", .TextMatrix(i - 1, COL_¿‡±)) > 0 Then
                        blnHide = True
                    End If
                End If
                If InStr(",F,G,D,7,E,C,", .TextMatrix(i, COL_¿‡±)) > 0 _
                    And Val(.TextMatrix(i, COL_œ‡πÿID)) <> 0 Then
                    blnHide = True
                End If
                                
                .RowHidden(i) = blnHide
                If Not blnHide And lngRow = 0 Then lngRow = i
                
                '¥¶¿Ì“Ω÷ˆƒ⁄»›µƒ±‰ªØ
                If Not .RowHidden(i) Then
                    .TextMatrix(i, col_“Ω÷ˆƒ⁄»›) = AdviceTextMake(i)
                End If
                
                '‘§œ»º∆À„’Ô¡∆µ•º€
                If Not .RowHidden(i) And .TextMatrix(i, COL_µ•º€) = "" Then
                    .TextMatrix(i, COL_µ•º€) = GetItemPrice(i)
                End If
                
                '≤˙…˙–¬÷ˆ ±£¨‘⁄ø…º˚––∂¡»°’Ô¡∆œÓƒø∏ΩœÓ¥Æ£¨”√”⁄ºÏ≤È£¨≤ª”√”⁄±£¥Ê
                If Not .RowHidden(i) Then
                    If Not RowIn≈‰∑Ω––(i) Then
                        If RowInºÏ—È––(i) Then
                            j = .FindRow(CStr(.RowData(i)), , COL_œ‡πÿID)
                            If j <> -1 Then
                                .TextMatrix(i, COL_∏ΩœÓ) = Get“Ω÷ˆœÓƒø∏Ωº˛(Val(.TextMatrix(j, COL_’Ô¡∆œÓƒøID)), 1)
                            End If
                        Else
                            .TextMatrix(i, COL_∏ΩœÓ) = Get“Ω÷ˆœÓƒø∏Ωº˛(Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID)), 1)
                        End If
                        If .TextMatrix(i, COL_∏ΩœÓ) <> "" Then
                            str∏ΩœÓ = str∏ΩœÓ & vbCrLf & "°Ò" & .TextMatrix(i, col_“Ω÷ˆƒ⁄»›)
                        End If
                    End If
                End If
                
                '–¬‘ˆ∫Ûπÿ¡™’Ô∂œµƒ±Íº«¥¶¿Ì
                If Not .RowHidden(i) Then
                    Call SetDiagFlag(i, 1)
                End If
            Next
            
            'Õº±Í∂‘∆Î:…Ë÷√Œ™÷–∂‘∆Î,≤ª»ª≤¡±ﬂøÚ ±ø…ƒ‹”–Œ Ã‚
            .Cell(flexcpPictureAlignment, .FixedRows, 0, .Rows - 1, .FixedCols - 1) = 4
            
            .Row = lngRow: .Col = col_“Ω÷ˆƒ⁄»›
            
            Call .AutoSize(col_“Ω÷ˆƒ⁄»›)
            .Redraw = flexRDDirect
        End With
        mblnRowChange = True
        mblnNoSave = True '±Íº«Œ™Œ¥±£¥Ê
    End If

    Call vsAdvice_AfterRowColChange(-1, -1, vsAdvice.Row, vsAdvice.Col)
    Call CalcAdviceMoney 'œ‘ æ–¬ø™“Ω÷ˆΩ∂Ó

    Screen.MousePointer = 0
    
    If str∏ΩœÓ <> "" Then
        MsgBox "“‘œ¬“Ω÷ˆ–Ë“™ÃÓ–¥…Í«Î∏ΩœÓ£¨«Î◊¢“‚ÃÓ–¥£∫" & vbCrLf & str∏ΩœÓ, vbInformation, gstrSysName
    End If
    If str∏ﬂŒ£“©∆∑ <> "" Then
        MsgBox "“‘œ¬“Ω÷ˆ «∏ﬂŒ£“©∆∑£∫" & str∏ﬂŒ£“©∆∑, vbInformation, gstrSysName
    End If
    Exit Sub
errH:
    Screen.MousePointer = 0
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Sub AdviceSet≥…Ã◊œÓƒø(ByVal lng≥…Ã◊ID As Long, ByVal lngRow As Long, Optional ByVal str–Ú∫≈ As String)
'π¶ƒ‹£∫ ‰»Î≥…Ã◊œÓƒø(∞¸¿®“ª≤¢∏¯“©,ºÏ≤È◊È∫œ, ÷ ı∏Ωº”,÷–“©≈‰∑Ω)
'≤Œ ˝£∫lngRow=ø’µƒ ‰»Î––(ø…ƒ‹ «≤Â»Îµƒ–¬––,µ´≤ªŒª”⁄“ª≤¢∏¯“©÷–º‰)
    Dim rsItems As New ADODB.Recordset
    Dim rsπÊ∏Ò As New ADODB.Recordset
    Dim rs≤ƒ¡œ As New ADODB.Recordset
    Dim rs¡∆≥Ã As New ADODB.Recordset
    Dim strSQL As String, i As Long, j As Long
    
    Dim lngCurRow As Long, intCount As Integer, lng–Ú∫≈ As Long
    Dim lngPreRow As Long, vCurDate As Date, lngTmp As Long
    Dim int∆µ¬ ¥Œ ˝ As Integer, int∆µ¬ º‰∏Ù As Integer, strº‰∏Ùµ•Œª As String
    Dim bln∏¯“©Õææ∂ As Boolean, bln≤…ºØ∑Ω∑® As Boolean, bln ‰—™Õææ∂ As Boolean
    Dim bln÷–“©”√∑® As Boolean, bln÷–“©ºÂ∑® As Boolean, bln≈‰∑Ω As Boolean
    Dim lngŒ˜“©∑øID As Long, lng≥…“©∑øID As Long, lng÷–“©∑øID As Long
    Dim dblœ‡πÿID As Double, int  ”√∑∂Œß As Integer, str∆µ¬  As String
    Dim str“Ω…˙ As String, lng“Ω…˙ID As Long
    Dim lng±∂ ˝ As Long, vBookMark As Variant, str“©∑øIDs As String
    Dim sngÃÏ ˝ As Single, strSQL–Ú∫≈ As String, str∏ΩœÓ As String
    Dim int∆µ¬ –‘÷  As Integer, lng∑¢¡œ≤ø√≈ID As Long, blnAdd As Boolean
    Dim str∏ﬂŒ£“©∆∑ As String
    Dim rsTmp As ADODB.Recordset
    
    On Error GoTo errH
    Screen.MousePointer = 11
    Me.Refresh
    
    '≤˙…˙–Ú∫≈π˝¬À¥Æ
    If str–Ú∫≈ <> "" Then
        If Left(str–Ú∫≈, 1) = "+" Then
            strSQL–Ú∫≈ = " And Instr([2],','||A.–Ú∫≈||',')>0"
        ElseIf Left(str–Ú∫≈, 1) = "-" Then
            strSQL–Ú∫≈ = " And Instr([2],','||A.–Ú∫≈||',')=0"
        End If
    End If
    
    '“©∆∑πÊ∏Ò–≈œ¢:À‰»ª¥Ê¡À ’∑—œ∏ƒøID,µ´“‘«∞µƒ ˝æ›√ª¥Ê
    strSQL = "Select A.–Ú∫≈,B.“©√˚ID,B.“©∆∑ID,B.º¡¡øœµ ˝,B.√≈’Ô∞¸◊∞,B.√≈’Ôµ•Œª,b.ª˘±æ“©ŒÔ," & _
        " B.√≈’Ôø…∑Ò∑÷¡„ As ø…∑Ò∑÷¡„,C.±‡¬Î,Nvl(D.√˚≥∆,C.√˚≥∆) as √˚≥∆,C.πÊ∏Ò,C.≤˙µÿ,b.∏ﬂŒ£“©∆∑" & _
        " From ’Ô¡∆œÓƒø◊È∫œ A,“©∆∑πÊ∏Ò B, ’∑—œÓƒøƒø¬º C, ’∑—œÓƒø±√˚ D" & _
        " Where A.’Ô¡∆œÓƒøID=B.“©√˚ID And B.“©∆∑ID=C.ID" & _
        " And C.ID=D. ’∑—œ∏ƒøID(+) And D.¬Î¿‡(+)=1 And D.–‘÷ (+)=[3]" & _
        " And A.’Ô¡∆◊È∫œID=[1]" & strSQL–Ú∫≈ & _
        " Order by A.–Ú∫≈,C.±‡¬Î"
    Set rsπÊ∏Ò = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng≥…Ã◊ID, "," & Mid(str–Ú∫≈, 2) & ",", IIF(gbyt“©∆∑√˚≥∆œ‘ æ = 0, 1, 3))
    
    'Œ¿≤ƒ–≈œ¢
    strSQL = "Select A.–Ú∫≈,B.≤ƒ¡œID,B.∏˙◊Ÿ‘⁄”√,C.√˚≥∆,C.º∆À„µ•Œª" & _
        " From ’Ô¡∆œÓƒø◊È∫œ A,≤ƒ¡œÃÿ–‘ B, ’∑—œÓƒøƒø¬º C" & _
        " Where A. ’∑—œ∏ƒøID=B.≤ƒ¡œID And B.≤ƒ¡œID=C.ID" & _
        " And A.’Ô¡∆◊È∫œID=[1]" & strSQL–Ú∫≈ & _
        " Order by A.–Ú∫≈,C.±‡¬Î"
    Set rs≤ƒ¡œ = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng≥…Ã◊ID, "," & Mid(str–Ú∫≈, 2) & ",")
    
    '≥…“©¡∆≥Ã–≈œ¢(“Ú≥…Ã◊÷–Œﬁ÷±Ω”∂‘”¶≈‰∑Ω,÷–“©»°≤ªµΩ¡∆≥Ã)
    strSQL = "Select Distinct A.’Ô¡∆œÓƒøID,C.¡∆≥Ã" & _
        " From ’Ô¡∆œÓƒø◊È∫œ A,’Ô¡∆œÓƒøƒø¬º B,’Ô¡∆”√∑®”√¡ø C" & _
        " Where A.’Ô¡∆œÓƒøID=B.ID And B.¿‡± IN('5','6')" & _
        " And A.’Ô¡∆œÓƒøID=C.œÓƒøID And A.’Ô¡∆◊È∫œID=[1]" & strSQL–Ú∫≈
    Set rs¡∆≥Ã = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng≥…Ã◊ID, "," & Mid(str–Ú∫≈, 2) & ",")
    
    '∞¥–Ú∫≈≈≈¡–∫Û”¶∏√”Î“Ω÷ˆ±‡º≠ ±µƒ¥Œ–Ú“ª÷¬
    '≈≈ø™÷¥––∆µ¬ Œ™≥÷–¯–‘µƒ≥§÷ˆ(’‚÷÷∑Ω∑®≤ª∂‘,÷ª»°¡Ÿ÷ˆ),À˘”–∑Ω∞∏◊™Œ™¡Ÿ÷ˆ¥¶¿Ì
    strSQL = "Select 1 as ∆⁄–ß,a.–Ú∫≈+0.1 As –Ú∫≈,Decode(a.œ‡πÿ–Ú∫≈,Null,Null,a.œ‡πÿ–Ú∫≈+0.1) As œ‡πÿ–Ú∫≈,A.’Ô¡∆œÓƒøID,A. ’∑—œ∏ƒøID,A.“Ω÷ˆƒ⁄»›,A.ÃÏ ˝,A.◊‹∏¯”Ë¡ø,A.µ•¥Œ”√¡ø," & _
        " A.“Ω…˙÷ˆÕ–,A.÷¥––∆µ¥Œ,A.∆µ¬ ¥Œ ˝,A.∆µ¬ º‰∏Ù,A.º‰∏Ùµ•Œª,A.÷¥––ø∆ “ID,Nvl(B.¿‡±,'*') ¿‡±,B.√˚≥∆," & _
        " B.º∆À„µ•Œª,Decode(B.¿‡±,'D',A.±Í±æ≤øŒª,Nvl(A.±Í±æ≤øŒª,B.±Í±æ≤øŒª)) as ±Í±æ≤øŒª,A.ºÏ≤È∑Ω∑®," & _
        " A. ±º‰∑Ω∞∏,Nvl(A.÷¥–––‘÷ ,B.÷¥––ø∆ “) as ÷¥–––‘÷ ,B.º∆º€–‘÷ ,B.µ•∂¿”¶”√,B.≤Ÿ◊˜¿‡–Õ,B.÷¥––∑÷¿‡,B.º∆À„∑Ω Ω," & _
        " B.÷¥––∆µ¬ ,B.¬º»Îœﬁ¡ø,C.¥¶∑Ωœﬁ¡ø,C.¥¶∑Ω÷∞ŒÒ,C.∂æ¿Ì∑÷¿‡,C.øπ…˙Àÿ,C.“©∆∑º¡–Õ,A.≈‰∑ΩID,C.¡Ÿ¥≤◊‘π‹“©,A.◊È∫œœÓƒøID,C.»‹√Ω" & _
        " From ’Ô¡∆œÓƒø◊È∫œ A,’Ô¡∆œÓƒøƒø¬º B,“©∆∑Ãÿ–‘ C, ’∑—œÓƒøƒø¬º D" & _
        " Where A.’Ô¡∆œÓƒøID=B.ID(+) And A.’Ô¡∆œÓƒøID=C.“©√˚ID(+)  And d.id(+)=a. ’∑—œ∏ƒøID " & _
        " And A.∆⁄–ß=1 And A.’Ô¡∆◊È∫œID=[1]" & strSQL–Ú∫≈ & _
        " And (NVL(d.≥∑µµ ±º‰,b.≥∑µµ ±º‰) is null or NVL(d.≥∑µµ ±º‰,b.≥∑µµ ±º‰) = To_Date('3000/1/1', 'yyyy/mm/dd') Or Not (b.¿‡± = '7' Or b.¿‡± = 'E' And b.÷¥––∑÷¿‡ = 0 And b.≤Ÿ◊˜¿‡–Õ = '3'))" & _
        " Order by A.–Ú∫≈"
    Set rsItems = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng≥…Ã◊ID, "," & Mid(str–Ú∫≈, 2) & ",")
    With vsAdvice
        mblnRowChange = False
        .Redraw = flexRDNone
        
        lngPreRow = GetPreRow(lngRow) '«∞“ª≤Œ’’––
        intCount = 0 '“—æ≠…Ë÷√µƒ–– ˝
        lng–Ú∫≈ = GetCurRow–Ú∫≈(lngRow) '∆ º–Ú∫≈
        vCurDate = zlDatabase.Currentdate
        
        For i = 1 To rsItems.RecordCount
            blnAdd = True
            
            'ºÏ≤È «∑Ò¥Ê‘⁄”––ßµƒ◊°‘∫“Ω÷ˆªÚ¡Ùπ€“Ω÷ˆ
            If rsItems!¿‡± = "Z" And InStr(",1,2,", "," & rsItems!≤Ÿ◊˜¿‡–Õ & ",") > 0 Then
                If CheckInHosAdvice Then
                    blnAdd = False
                End If
            End If
            
            If blnAdd Then
                lngCurRow = lngRow + intCount
                If lngCurRow > lngRow Then .AddItem "", lngCurRow
                 
                'º«¬ºœ‡∂‘ID
                .RowData(lngCurRow) = -1 * rsItems!–Ú∫≈
                If Not IsNull(rsItems!œ‡πÿ–Ú∫≈) Then
                    .TextMatrix(lngCurRow, COL_œ‡πÿID) = -1 * rsItems!œ‡πÿ–Ú∫≈
                End If
                
                .TextMatrix(lngCurRow, COL_EDIT) = 1 '–¬‘ˆµƒ
                .Cell(flexcpData, lngCurRow, COL_EDIT) = lng≥…Ã◊ID 'º«¬ºœ‡πÿµƒ≥…Ã◊œÓƒø
                
                .TextMatrix(lngCurRow, COL_”§∂˘) = cbo”§∂˘.ListIndex
                .TextMatrix(lngCurRow, COL_–Ú∫≈) = lng–Ú∫≈ + intCount
                .TextMatrix(lngCurRow, COL_◊¥Ã¨) = 1 '–¬ø™
                .TextMatrix(lngCurRow, COL_¿‡±) = rsItems!¿‡±
                .TextMatrix(lngCurRow, COL_’Ô¡∆œÓƒøID) = Nvl(rsItems!’Ô¡∆œÓƒøID, 0)
                .TextMatrix(lngCurRow, COL_√˚≥∆) = Nvl(rsItems!√˚≥∆)
                .TextMatrix(lngCurRow, COL_±Í±æ≤øŒª) = Nvl(rsItems!±Í±æ≤øŒª)
                .TextMatrix(lngCurRow, COL_ºÏ≤È∑Ω∑®) = Nvl(rsItems!ºÏ≤È∑Ω∑®)
                
                If IsDate(txtø™ º ±º‰.Text) Then
                    .TextMatrix(lngCurRow, COL_ø™ º ±º‰) = Format(txtø™ º ±º‰.Text, "yyyy-MM-dd HH:mm")
                    .Cell(flexcpData, lngCurRow, COL_ø™ º ±º‰) = Format(txtø™ º ±º‰.Text, "yyyy-MM-dd HH:mm")
                    
                    ' ÷ ı/ ‰—™ ±º‰£∫∏¥÷∆ ±»± °”Îø™ º ±º‰œ‡Õ¨,‘⁄±Í±æ≤øŒª¥¶¿Ì∫Û
                    If rsItems!¿‡± = "K" Or rsItems!¿‡± = "F" Or rsItems!¿‡± = "G" _
                        And Val(.TextMatrix(lngCurRow, COL_œ‡πÿID)) = Val(.TextMatrix(lngCurRow - 1, COL_œ‡πÿID)) Then
                        .TextMatrix(lngCurRow, COL_ ÷ ı ±º‰) = Format(txtø™ º ±º‰.Text, "yyyy-MM-dd HH:mm")
                    End If
                End If
                
                '∆‰À¸
                .TextMatrix(lngCurRow, COL_º∆º€–‘÷ ) = Nvl(rsItems!º∆º€–‘÷ , 0)
                .TextMatrix(lngCurRow, COL_º∆À„∑Ω Ω) = Nvl(rsItems!º∆À„∑Ω Ω, 0)
                .TextMatrix(lngCurRow, COL_≤Ÿ◊˜¿‡–Õ) = Nvl(rsItems!≤Ÿ◊˜¿‡–Õ)
                .TextMatrix(lngCurRow, COL_µ•∂¿”¶”√) = Nvl(rsItems!µ•∂¿”¶”√)
                .TextMatrix(lngCurRow, COL_÷¥––∑÷¿‡) = Nvl(rsItems!÷¥––∑÷¿‡, 0)
                .TextMatrix(lngCurRow, COL_∂æ¿Ì∑÷¿‡) = Nvl(rsItems!∂æ¿Ì∑÷¿‡)
                .TextMatrix(lngCurRow, COL_øπæ˙µ»º∂) = Val("" & rsItems!øπ…˙Àÿ)
                .TextMatrix(lngCurRow, COL_≈‰∑ΩID) = Nvl(rsItems!≈‰∑ΩID)
                .TextMatrix(lngCurRow, COL_¡Ÿ¥≤◊‘π‹“©) = rsItems!¡Ÿ¥≤◊‘π‹“© & ""
                .TextMatrix(lngCurRow, COL_◊È∫œœÓƒøID) = rsItems!◊È∫œœÓƒøID & ""
                .TextMatrix(lngCurRow, COL_ «∑Ò»‹√Ω) = Val(rsItems!»‹√Ω & "")
                
                .TextMatrix(lngCurRow, COL_“©∆∑º¡–Õ) = Nvl(rsItems!“©∆∑º¡–Õ)
                If InStr(",5,6,7,", rsItems!¿‡±) > 0 Then
                    .TextMatrix(lngCurRow, COL_¥¶∑Ωœﬁ¡ø) = Nvl(rsItems!¥¶∑Ωœﬁ¡ø)
                Else
                    .TextMatrix(lngCurRow, COL_¥¶∑Ωœﬁ¡ø) = Nvl(rsItems!¬º»Îœﬁ¡ø)
                End If
                .TextMatrix(lngCurRow, COL_¥¶∑Ω÷∞ŒÒ) = Nvl(rsItems!¥¶∑Ω÷∞ŒÒ)
                
                '“©∆∑πÊ∏Ò–≈œ¢:÷–≤›“©øœ∂®”–,≥…“©∞¥µ•¡ø”Îº¡¡øµ•Œª◊‘∂Ø∆•≈‰
                lng±∂ ˝ = 0: vBookMark = 0
                If rsItems!¿‡± = "7" Or (InStr(",5,6,", rsItems!¿‡±) > 0) Then
                    If Not IsNull(rsItems! ’∑—œ∏ƒøID) Then 'ø…ƒ‹“‘«∞Œ¥±£¥Ê ’∑—œ∏ƒøID
                        rsπÊ∏Ò.Filter = "“©∆∑ID=" & rsItems! ’∑—œ∏ƒøID
                    Else
                        rsπÊ∏Ò.Filter = "“©√˚ID=" & rsItems!’Ô¡∆œÓƒøID
                    End If
                    If Not rsπÊ∏Ò.EOF Then
                        If IsNull(rsItems! ’∑—œ∏ƒøID) Then
                            '»°º¡¡øœµ ˝Œ™µ•¡øµƒ◊Ó–°’˚±∂ ˝µƒƒ«“ª∏ˆπÊ∏Ò
                            If CInt(Nvl(rsItems!µ•¥Œ”√¡ø, 0)) <> 0 Then
                                Do While Not rsπÊ∏Ò.EOF
                                    If rsπÊ∏Ò!º¡¡øœµ ˝ / rsItems!µ•¥Œ”√¡ø = Int(rsπÊ∏Ò!º¡¡øœµ ˝ / rsItems!µ•¥Œ”√¡ø) Then
                                        If rsπÊ∏Ò!º¡¡øœµ ˝ / rsItems!µ•¥Œ”√¡ø < lng±∂ ˝ Or lng±∂ ˝ = 0 Then
                                            vBookMark = rsπÊ∏Ò.Bookmark
                                            lng±∂ ˝ = rsπÊ∏Ò!º¡¡øœµ ˝ / rsItems!µ•¥Œ”√¡ø
                                        End If
                                    End If
                                    rsπÊ∏Ò.MoveNext
                                Loop
                                If vBookMark <> 0 Then rsπÊ∏Ò.Bookmark = vBookMark
                            End If
                            If rsπÊ∏Ò.EOF Then rsπÊ∏Ò.MoveFirst
                        End If
                        .TextMatrix(lngCurRow, COL_√˚≥∆) = Nvl(rsπÊ∏Ò!√˚≥∆)
                        .TextMatrix(lngCurRow, COL_ ’∑—œ∏ƒøID) = rsπÊ∏Ò!“©∆∑ID
                        .TextMatrix(lngCurRow, COL_º¡¡øœµ ˝) = Nvl(rsπÊ∏Ò!º¡¡øœµ ˝)
                        .TextMatrix(lngCurRow, COL_√≈’Ô∞¸◊∞) = Nvl(rsπÊ∏Ò!√≈’Ô∞¸◊∞)
                        .TextMatrix(lngCurRow, COL_√≈’Ôµ•Œª) = Nvl(rsπÊ∏Ò!√≈’Ôµ•Œª)
                        .TextMatrix(lngCurRow, COL_ø…∑Ò∑÷¡„) = Nvl(rsπÊ∏Ò!ø…∑Ò∑÷¡„, 0)
                        .TextMatrix(lngCurRow, COL_∏ﬂŒ£“©∆∑) = Nvl(rsπÊ∏Ò!∏ﬂŒ£“©∆∑, 0)
                        .TextMatrix(lngCurRow, COL_ª˘±æ“©ŒÔ) = rsπÊ∏Ò!ª˘±æ“©ŒÔ & ""
                        If Val(.TextMatrix(lngCurRow, COL_∏ﬂŒ£“©∆∑)) <> 0 Then
                            str∏ﬂŒ£“©∆∑ = str∏ﬂŒ£“©∆∑ & vbCrLf & rsItems!√˚≥∆ & ":" & Decode(Val(.TextMatrix(lngCurRow, COL_∏ﬂŒ£“©∆∑)), 1, "A", 2, "B", 3, "C", "") & "º∂£ª"
                        End If
                    End If
                ElseIf rsItems!¿‡± = "4" Then
                    rs≤ƒ¡œ.Filter = "≤ƒ¡œID=" & Nvl(rsItems! ’∑—œ∏ƒøID, 0)
                    If Not rs≤ƒ¡œ.EOF Then
                        .TextMatrix(lngCurRow, COL_√˚≥∆) = Nvl(rs≤ƒ¡œ!√˚≥∆)
                        .TextMatrix(lngCurRow, COL_√≈’Ôµ•Œª) = Nvl(rs≤ƒ¡œ!º∆À„µ•Œª) '…¢◊∞µ•Œª
                        .TextMatrix(lngCurRow, COL_∏˙◊Ÿ‘⁄”√) = Nvl(rs≤ƒ¡œ!∏˙◊Ÿ‘⁄”√, 0)
                    End If
                    .TextMatrix(lngCurRow, COL_º¡¡øœµ ˝) = 1
                    .TextMatrix(lngCurRow, COL_√≈’Ô∞¸◊∞) = 1
                    .TextMatrix(lngCurRow, COL_ ’∑—œ∏ƒøID) = Nvl(rsItems! ’∑—œ∏ƒøID, 0)
                End If
                                    
                '≈–∂œ «∑ÒÃÿ∂®––
                bln∏¯“©Õææ∂ = False: bln≤…ºØ∑Ω∑® = False: bln ‰—™Õææ∂ = False
                bln÷–“©”√∑® = False: bln÷–“©ºÂ∑® = False: bln≈‰∑Ω = False
                If rsItems!¿‡± = "E" Then
                    If IsNull(rsItems!œ‡πÿ–Ú∫≈) Then
                        If Val(.TextMatrix(lngCurRow - 1, COL_œ‡πÿID)) = .RowData(lngCurRow) Then
                            If InStr(",5,6,", .TextMatrix(lngCurRow - 1, COL_¿‡±)) > 0 Then
                                bln∏¯“©Õææ∂ = True
                            ElseIf .TextMatrix(lngCurRow - 1, COL_¿‡±) = "C" Then
                                bln≤…ºØ∑Ω∑® = True
                            Else
                                bln÷–“©”√∑® = True
                            End If
                        End If
                    ElseIf .TextMatrix(lngCurRow - 1, COL_¿‡±) = "K" And .RowData(lngCurRow - 1) = Val(.TextMatrix(lngCurRow, COL_œ‡πÿID)) Then
                        bln ‰—™Õææ∂ = True
                    Else
                        bln÷–“©ºÂ∑® = True
                    End If
                End If
                If rsItems!¿‡± = "7" Or bln÷–“©ºÂ∑® Or bln÷–“©”√∑® Then bln≈‰∑Ω = True
                        
                'ªÒ»°µ±«∞œÓƒøµƒ  ”√∑∂Œß
                If bln≤…ºØ∑Ω∑® Then
                    '≤…ºØ∑Ω∑®“‘ºÏ—ÈœÓƒøµƒŒ™◊º
                    lngTmp = .FindRow(CStr(.RowData(lngCurRow)), , COL_œ‡πÿID)
                    int∆µ¬ –‘÷  = .TextMatrix(lngTmp, COL_∆µ¬ –‘÷ )
                Else
                    int∆µ¬ –‘÷  = Nvl(rsItems!÷¥––∆µ¬ , 0)
                End If
                If bln≈‰∑Ω Then
                    int  ”√∑∂Œß = 2 '÷–“©≈‰∑Ω(∞¸¿®ºÂ∑®,”√∑®)”√÷–“Ω
    '            ElseIf bln≤…ºØ∑Ω∑® Then
    '                int  ”√∑∂Œß = -1 '…Ë÷√”ÎºÏ—ÈœÓƒøœ‡Õ¨:“ª¥Œ–‘
                ElseIf int∆µ¬ –‘÷  = 0 Or bln∏¯“©Õææ∂ _
                    Or InStr(",5,6,", .TextMatrix(lngCurRow, COL_¿‡±)) > 0 Then
                    int  ”√∑∂Œß = 1 '"ø…—°∆µ¬ "ªÚ≥…“©(∞¸¿®∏¯“©Õææ∂)”√Œ˜“Ω
                ElseIf int∆µ¬ –‘÷  = 1 Then
                    int  ”√∑∂Œß = -1 '“ª¥Œ–‘
                ElseIf int∆µ¬ –‘÷  = 2 Then
                    int  ”√∑∂Œß = -2 '≥÷–¯–‘
                End If
                        
                '∆µ¬ ,∆µ¬ ¥Œ ˝,∆µ¬ º‰∏Ù,º‰∏Ùµ•Œª
                .TextMatrix(lngCurRow, COL_∆µ¬ –‘÷ ) = int∆µ¬ –‘÷ 
                If Not IsNull(rsItems!÷¥––∆µ¥Œ) Then
                    If Check∆µ¬ ø…”√(Nvl(rsItems!’Ô¡∆œÓƒøID, 0), int  ”√∑∂Œß, Nvl(rsItems!÷¥––∆µ¥Œ)) Then
                        If Get∆µ¬ –≈œ¢_√˚≥∆(rsItems!÷¥––∆µ¥Œ, int∆µ¬ ¥Œ ˝, int∆µ¬ º‰∏Ù, strº‰∏Ùµ•Œª, CStr(int  ”√∑∂Œß)) Then
                            .TextMatrix(lngCurRow, COL_∆µ¬ ) = rsItems!÷¥––∆µ¥Œ
                            .TextMatrix(lngCurRow, COL_∆µ¬ ¥Œ ˝) = int∆µ¬ ¥Œ ˝
                            .TextMatrix(lngCurRow, COL_∆µ¬ º‰∏Ù) = int∆µ¬ º‰∏Ù
                            .TextMatrix(lngCurRow, COL_º‰∏Ùµ•Œª) = strº‰∏Ùµ•Œª
                        End If
                    End If
                End If
                If .TextMatrix(lngCurRow, COL_∆µ¬ ) = "" And Not IsNull(rsItems!’Ô¡∆œÓƒøID) Then '»°»± °µƒ
                    Call Get»± °∆µ¬ (Nvl(rsItems!’Ô¡∆œÓƒøID, 0), int  ”√∑∂Œß, str∆µ¬ , int∆µ¬ ¥Œ ˝, int∆µ¬ º‰∏Ù, strº‰∏Ùµ•Œª)
                    .TextMatrix(lngCurRow, COL_∆µ¬ ) = str∆µ¬ 
                    .TextMatrix(lngCurRow, COL_∆µ¬ ¥Œ ˝) = int∆µ¬ ¥Œ ˝
                    .TextMatrix(lngCurRow, COL_∆µ¬ º‰∏Ù) = int∆µ¬ º‰∏Ù
                    .TextMatrix(lngCurRow, COL_º‰∏Ùµ•Œª) = strº‰∏Ùµ•Œª
                End If
                
                'µ•¡ø
                .TextMatrix(lngCurRow, COL_µ•¡ø) = FormatEx(Nvl(rsItems!µ•¥Œ”√¡ø), 5)
                If rsItems!¿‡± = "4" Then
                    .TextMatrix(lngCurRow, COL_µ•¡øµ•Œª) = .TextMatrix(lngCurRow, COL_√≈’Ôµ•Œª) '…¢◊∞µ•Œª
                ElseIf bln÷–“©”√∑® Then
                    .TextMatrix(lngCurRow, COL_µ•¡øµ•Œª) = ""
                Else
                    If InStr(",5,6,7,", rsItems!¿‡±) > 0 Or (int∆µ¬ –‘÷  = 0 And InStr(",1,2,", Nvl(rsItems!º∆À„∑Ω Ω, 0)) > 0) Then
                        .TextMatrix(lngCurRow, COL_µ•¡øµ•Œª) = Nvl(rsItems!º∆À„µ•Œª)
                    End If
                End If
                
                '◊‹¡ø
                If InStr(",5,6,", rsItems!¿‡±) > 0 Then
                    '≥…“©¡Ÿ÷ˆ(”–∂‘”¶πÊ∏Ò)
                    .TextMatrix(lngCurRow, COL_◊‹¡øµ•Œª) = .TextMatrix(lngCurRow, COL_√≈’Ôµ•Œª)
                                        
                    sngÃÏ ˝ = Nvl(rsItems!ÃÏ ˝, msngÃÏ ˝)
                    If mblnÃÏ ˝ Then
                        If .TextMatrix(lngCurRow, COL_º‰∏Ùµ•Œª) = "÷‹" Then
                            If 7 > sngÃÏ ˝ Then sngÃÏ ˝ = 7
                        ElseIf .TextMatrix(lngCurRow, COL_º‰∏Ùµ•Œª) = "ÃÏ" Then
                            If Val(.TextMatrix(lngCurRow, COL_∆µ¬ º‰∏Ù)) > sngÃÏ ˝ Then
                                sngÃÏ ˝ = Val(.TextMatrix(lngCurRow, COL_∆µ¬ º‰∏Ù))
                            End If
                        ElseIf .TextMatrix(lngCurRow, COL_º‰∏Ùµ•Œª) = "–° ±" Then
                            If Val(.TextMatrix(lngCurRow, COL_∆µ¬ º‰∏Ù)) \ 24 > sngÃÏ ˝ Then
                                sngÃÏ ˝ = Val(.TextMatrix(lngCurRow, COL_∆µ¬ º‰∏Ù)) \ 24
                            End If
                        ElseIf .TextMatrix(lngCurRow, COL_º‰∏Ùµ•Œª) = "∑÷÷”" Then
                            If sngÃÏ ˝ = 0 Then sngÃÏ ˝ = 1
                        End If
                        If sngÃÏ ˝ = 0 Then sngÃÏ ˝ = 1
                    End If
                    
                    If Not IsNull(rsItems!◊‹∏¯”Ë¡ø) Then
                        '◊™ªªŒ™√≈’Ôµ•Œª
                        .TextMatrix(lngCurRow, COL_◊‹¡ø) = FormatEx(rsItems!◊‹∏¯”Ë¡ø / Val(.TextMatrix(lngCurRow, COL_√≈’Ô∞¸◊∞)), 5)
                    ElseIf .TextMatrix(lngCurRow, COL_∆µ¬ ) <> "" Then
                        'º∆À„»± °◊‹¡ø
                        rs¡∆≥Ã.Filter = "’Ô¡∆œÓƒøID=" & rsItems!’Ô¡∆œÓƒøID
                        If Not rs¡∆≥Ã.EOF Then
                            If Nvl(rs¡∆≥Ã!¡∆≥Ã, 1) > sngÃÏ ˝ Then sngÃÏ ˝ = Nvl(rs¡∆≥Ã!¡∆≥Ã, 1)
                        End If
                    
                        If (Val(.TextMatrix(lngCurRow, COL_µ•¡ø)) <> 0 _
                            And Val(.TextMatrix(lngCurRow, COL_√≈’Ô∞¸◊∞)) <> 0 _
                            And Val(.TextMatrix(lngCurRow, COL_º¡¡øœµ ˝)) <> 0) Then
                            
                            .TextMatrix(lngCurRow, COL_◊‹¡ø) = FormatEx(Calc»± °“©∆∑◊‹¡ø( _
                                    Val(.TextMatrix(lngCurRow, COL_µ•¡ø)), sngÃÏ ˝, _
                                    Val(.TextMatrix(lngCurRow, COL_∆µ¬ ¥Œ ˝)), _
                                    Val(.TextMatrix(lngCurRow, COL_∆µ¬ º‰∏Ù)), _
                                    .TextMatrix(lngCurRow, COL_º‰∏Ùµ•Œª), _
                                    .TextMatrix(lngCurRow, COL_÷¥–– ±º‰), _
                                    Val(.TextMatrix(lngCurRow, COL_º¡¡øœµ ˝)), _
                                    Val(.TextMatrix(lngCurRow, COL_√≈’Ô∞¸◊∞)), _
                                    Val(.TextMatrix(lngCurRow, COL_ø…∑Ò∑÷¡„))), 5)
                            If Val(.TextMatrix(lngCurRow, COL_ø…∑Ò∑÷¡„)) <> 0 Then
                                .TextMatrix(lngCurRow, COL_◊‹¡ø) = IntEx(Val(.TextMatrix(lngCurRow, COL_◊‹¡ø)))
                            End If
                        End If
                    End If
                    
                    If InStr(GetInsidePrivs(p√≈’Ô“Ω÷ˆœ¬¥Ô), "“©∆∑–° ˝ ‰»Î") = 0 Then
                        .TextMatrix(lngCurRow, COL_◊‹¡ø) = IntEx(Val(.TextMatrix(lngCurRow, COL_◊‹¡ø)))
                    End If
                    
                    '¥¶∑Ωœﬁ¡ø
                    If Val(.TextMatrix(lngCurRow, COL_¥¶∑Ωœﬁ¡ø)) <> 0 Then
                        If Val(.TextMatrix(lngCurRow, COL_◊‹¡ø)) > FormatEx(Val(.TextMatrix(lngCurRow, COL_¥¶∑Ωœﬁ¡ø)) / Val(.TextMatrix(lngCurRow, COL_º¡¡øœµ ˝)) / Val(.TextMatrix(lngCurRow, COL_√≈’Ô∞¸◊∞)), 5) Then
                            .TextMatrix(lngCurRow, COL_ «∑Ò≥¨¡ø) = "1"
                        End If
                    End If
                     
                    If mblnÃÏ ˝ Then
                        .TextMatrix(lngCurRow, COL_ÃÏ ˝) = IIF(sngÃÏ ˝ = 0, "", sngÃÏ ˝)
                    End If
                    Call Set”√“©ÃÏ ˝ «∑Ò≥¨∆⁄(lngCurRow)
                    
                ElseIf bln≈‰∑Ω Then
                    If rsItems!¿‡± = "7" Then
                        .TextMatrix(lngCurRow, COL_◊‹¡øµ•Œª) = "∏∂"
                                                
                        If Not IsNull(rsItems!◊‹∏¯”Ë¡ø) Then
                            .TextMatrix(lngCurRow, COL_◊‹¡ø) = rsItems!◊‹∏¯”Ë¡ø
                        ElseIf .TextMatrix(lngCurRow, COL_∆µ¬ ) <> "" Then
                             .TextMatrix(lngCurRow, COL_◊‹¡ø) = Calc»± °“©∆∑◊‹¡ø(1, 1, Val(.TextMatrix(lngCurRow, COL_∆µ¬ ¥Œ ˝)), _
                                        Val(.TextMatrix(lngCurRow, COL_∆µ¬ º‰∏Ù)), .TextMatrix(lngCurRow, COL_º‰∏Ùµ•Œª))
                        End If
                    Else
                        '÷–“©ºÂ∑®,”√∑®µƒ◊‹¡ø”Î◊È≥…“©œ‡Õ¨(Œ™¡Àœ‘ æ)
                        .TextMatrix(lngCurRow, COL_◊‹¡ø) = .TextMatrix(lngCurRow - 1, COL_◊‹¡ø)
                        .TextMatrix(lngCurRow, COL_◊‹¡øµ•Œª) = .TextMatrix(lngCurRow - 1, COL_◊‹¡øµ•Œª)
                         
                    End If
                Else
                    '∆‰À¸¡Ÿ÷ˆ∂º–Ë“™◊‹¡ø
                    '»Áπ˚Œ™“ª¥Œ–‘ªÚº∆¥Œ¡Ÿ÷ˆ»± °◊‹¡øŒ™1
                    If Not IsNull(rsItems!◊‹∏¯”Ë¡ø) Then
                        vsAdvice.TextMatrix(lngCurRow, COL_◊‹¡ø) = rsItems!◊‹∏¯”Ë¡ø
                    ElseIf int∆µ¬ –‘÷  = 1 Or Nvl(rsItems!º∆À„∑Ω Ω, 0) = 3 Then
                        vsAdvice.TextMatrix(lngCurRow, COL_◊‹¡ø) = 1
                    End If
                    If rsItems!¿‡± = "4" Then
                        .TextMatrix(lngCurRow, COL_◊‹¡øµ•Œª) = .TextMatrix(lngCurRow, COL_√≈’Ôµ•Œª) '…¢◊∞µ•Œª
                    Else
                        .TextMatrix(lngCurRow, COL_◊‹¡øµ•Œª) = Nvl(rsItems!º∆À„µ•Œª)
                    End If
                End If
                
                'øπæ˙“©ŒÔ»± °”√“©ƒøµƒ
                If Val(.TextMatrix(lngCurRow, COL_øπæ˙µ»º∂)) > 0 Then .TextMatrix(lngCurRow, COL_”√“©ƒøµƒ) = mstrPurMed
                        
                '÷¥–– ±º‰(◊‹¡ø,∆µ¬ ,÷¥–– ±º‰÷Æ∫Û)
                If .TextMatrix(lngCurRow, COL_∆µ¬ ) <> "" Then
                    'ø…ƒ‹«Û≥ˆ»± °÷¥–– ±º‰∑Ω∞∏
                    If bln∏¯“©Õææ∂ Or bln÷–“©”√∑® Then
                        If Not IsNull(rsItems! ±º‰∑Ω∞∏) Then
                            If ExeTimeValid(rsItems! ±º‰∑Ω∞∏, Val(.TextMatrix(lngCurRow, COL_∆µ¬ ¥Œ ˝)), _
                                Val(.TextMatrix(lngCurRow, COL_∆µ¬ º‰∏Ù)), .TextMatrix(lngCurRow, COL_º‰∏Ùµ•Œª)) Then
                                .TextMatrix(lngCurRow, COL_÷¥–– ±º‰) = rsItems! ±º‰∑Ω∞∏
                            End If
                        End If
                        If .TextMatrix(lngCurRow, COL_÷¥–– ±º‰) = "" Then
                            .TextMatrix(lngCurRow, COL_÷¥–– ±º‰) = Get»± ° ±º‰(int  ”√∑∂Œß, .TextMatrix(lngCurRow, COL_∆µ¬ ), rsItems!’Ô¡∆œÓƒøID)
                        End If
                    ElseIf int∆µ¬ –‘÷  = 0 Then
                        If Not IsNull(rsItems! ±º‰∑Ω∞∏) Then
                            If ExeTimeValid(rsItems! ±º‰∑Ω∞∏, Val(.TextMatrix(lngCurRow, COL_∆µ¬ ¥Œ ˝)), _
                                Val(.TextMatrix(lngCurRow, COL_∆µ¬ º‰∏Ù)), .TextMatrix(lngCurRow, COL_º‰∏Ùµ•Œª)) Then
                                .TextMatrix(lngCurRow, COL_÷¥–– ±º‰) = rsItems! ±º‰∑Ω∞∏
                            End If
                        End If
                        If .TextMatrix(lngCurRow, COL_÷¥–– ±º‰) = "" Then
                            .TextMatrix(lngCurRow, COL_÷¥–– ±º‰) = Get»± ° ±º‰(int  ”√∑∂Œß, .TextMatrix(lngCurRow, COL_∆µ¬ ))
                        End If
                    End If
                    If bln≤…ºØ∑Ω∑® Then
                        .TextMatrix(lngCurRow, COL_”√∑®) = rsItems!√˚≥∆
                    ElseIf bln∏¯“©Õææ∂ Or bln÷–“©”√∑® Then
                        '≥…“©∫Õ÷–“©≈‰∑Ωµƒ”√∑®,÷¥–– ±º‰
                        If bln÷–“©”√∑® Then
                            .TextMatrix(lngCurRow, COL_”√∑®) = rsItems!√˚≥∆
                        End If
                        For j = lngCurRow - 1 To lngRow Step -1
                            If Val(.TextMatrix(j, COL_œ‡πÿID)) = .RowData(lngCurRow) Then
                                If bln∏¯“©Õææ∂ Then .TextMatrix(j, COL_”√∑®) = rsItems!√˚≥∆ & rsItems!“Ω…˙÷ˆÕ–
                                .TextMatrix(j, COL_÷¥–– ±º‰) = .TextMatrix(lngCurRow, COL_÷¥–– ±º‰)
                            Else
                                Exit For
                            End If
                        Next
                    ElseIf bln ‰—™Õææ∂ Then
                        .TextMatrix(lngCurRow - 1, COL_”√∑®) = rsItems!√˚≥∆
                    End If
                End If
                
                'ø™÷ˆ“Ω…˙∫Õø™÷ˆø∆ “
                .TextMatrix(lngCurRow, COL_ø™÷ˆ“Ω…˙) = UserInfo.–’√˚
                .TextMatrix(lngCurRow, COL_ø™÷ˆø∆ “ID) = Getø™÷ˆø∆ “ID(UserInfo.ID, mlng“Ωººø∆ “ID, mlng≤°»Àø∆ “id, 1)
                                    
                '÷¥–––‘÷ 
                If InStr(",5,6,7,", rsItems!¿‡±) > 0 Then
                    If Nvl(rsItems!÷¥–––‘÷ , 0) = 5 Then
                        .TextMatrix(lngCurRow, COL_÷¥–––‘÷ ) = 5
                    Else
                        .TextMatrix(lngCurRow, COL_÷¥–––‘÷ ) = 4
                    End If
                ElseIf rsItems!¿‡± = "4" Then
                    .TextMatrix(lngCurRow, COL_÷¥–––‘÷ ) = 4
                ElseIf bln∏¯“©Õææ∂ Or bln÷–“©ºÂ∑® Or bln÷–“©”√∑® Or bln≤…ºØ∑Ω∑® Then
                    .TextMatrix(lngCurRow, COL_÷¥–––‘÷ ) = Nvl(rsItems!÷¥–––‘÷ , 0)
                Else
                    .TextMatrix(lngCurRow, COL_÷¥–––‘÷ ) = Nvl(rsItems!÷¥–––‘÷ , 0)
                End If
                
                '÷¥––ø∆ “ID:Œ™0-∂£÷ˆ,5-‘∫Õ‚÷¥–– ±»°≥ˆŒ™0
                If rsItems!¿‡± = "Z" And InStr(",1,2,", Nvl(rsItems!≤Ÿ◊˜¿‡–Õ, 0)) > 0 Then
                    If Nvl(rsItems!÷¥––ø∆ “ID, 0) <> 0 Then
                        .TextMatrix(lngCurRow, COL_÷¥––ø∆ “ID) = Nvl(rsItems!÷¥––ø∆ “ID, 0)
                    Else
                        '¡Ùπ€ªÚ◊°‘∫“Ω÷ˆ»°¡Ÿ¥≤ø∆ “(≤ªπ‹÷¥–––‘÷ )
                        If Nvl(rsItems!≤Ÿ◊˜¿‡–Õ, 0) = 1 Then
                            '¡Ùπ€:∞¸∫¨√≈’ÔªÚ◊°‘∫¡Ÿ¥≤ø∆ “
                            Call Get¡Ÿ¥≤ø∆ “(3, , lngTmp, , True, False, True)
                        ElseIf Nvl(rsItems!≤Ÿ◊˜¿‡–Õ, 0) = 2 Then
                            '◊°‘∫:∞¸∫¨◊°‘∫¡Ÿ¥≤ø∆ “
                            Call Get¡Ÿ¥≤ø∆ “(2, , lngTmp, , True, False, True)
                        End If
                        .TextMatrix(lngCurRow, COL_÷¥––ø∆ “ID) = lngTmp
                    End If
                ElseIf InStr(",0,5,", Val(.TextMatrix(lngCurRow, COL_÷¥–––‘÷ ))) = 0 Then
                    If Nvl(rsItems!÷¥––ø∆ “ID, 0) <> 0 Then
                        If InStr(",5,6,7,", rsItems!¿‡±) > 0 Then
                            str“©∑øIDs = Getø…”√“©∑øIDs(rsItems!¿‡±, rsItems!’Ô¡∆œÓƒøID, Val(.TextMatrix(lngCurRow, COL_ ’∑—œ∏ƒøID)), mlng≤°»Àø∆ “id, 1)
                            If InStr("," & str“©∑øIDs & ",", "," & rsItems!÷¥––ø∆ “ID & ",") > 0 Then
                                .TextMatrix(lngCurRow, COL_÷¥––ø∆ “ID) = Nvl(rsItems!÷¥––ø∆ “ID, 0)
                            End If
                        ElseIf rsItems!¿‡± = "4" Then
                            str“©∑øIDs = Getø…”√∑¢¡œ≤ø√≈IDs(Val(.TextMatrix(lngCurRow, COL_ ’∑—œ∏ƒøID)), mlng≤°»Àø∆ “id, 1)
                            If InStr("," & str“©∑øIDs & ",", "," & rsItems!÷¥––ø∆ “ID & ",") > 0 Then
                                .TextMatrix(lngCurRow, COL_÷¥––ø∆ “ID) = Nvl(rsItems!÷¥––ø∆ “ID, 0)
                            End If
                        ElseIf Val(.TextMatrix(lngCurRow, COL_÷¥–––‘÷ )) = 4 Then
                            '4-÷∏∂®ø∆ “ ±≤≈»°,∆‰À¸µƒπÃ∂®…˙≥…
                            .TextMatrix(lngCurRow, COL_÷¥––ø∆ “ID) = Nvl(rsItems!÷¥––ø∆ “ID, 0)
                            
                            'ºÏ≤È÷¥––ø∆ “µƒ”––ß–‘
                            If Val(.TextMatrix(lngCurRow, COL_÷¥––ø∆ “ID)) <> 0 Then
                                If CheckExecDeptValidate(Val(.TextMatrix(lngCurRow, COL_÷¥––ø∆ “ID)), mlng≤°»Àø∆ “id, 1, Val(.TextMatrix(lngCurRow, COL_’Ô¡∆œÓƒøID))) = False Then
                                    .TextMatrix(lngCurRow, COL_÷¥––ø∆ “ID) = 0
                                End If
                            End If
                        End If
                    End If
                    If Val(.TextMatrix(lngCurRow, COL_÷¥––ø∆ “ID)) = 0 Then
                        '“©∆∑¿‡µƒ’˚∏ˆ≥…Ã◊œ‡Õ¨
                        If rsItems!¿‡± = "5" Then
                            If lngŒ˜“©∑øID = 0 Then
                                lngŒ˜“©∑øID = Get’Ô¡∆÷¥––ø∆ “ID(mlng≤°»ÀID, 0, rsItems!¿‡±, rsItems!’Ô¡∆œÓƒøID, Val(.TextMatrix(lngCurRow, COL_ ’∑—œ∏ƒøID)), 4, mlng≤°»Àø∆ “id, 0, 1, 1, True)
                            End If
                            .TextMatrix(lngCurRow, COL_÷¥––ø∆ “ID) = lngŒ˜“©∑øID
                        ElseIf rsItems!¿‡± = "6" Then
                            If lng≥…“©∑øID = 0 Then
                                lng≥…“©∑øID = Get’Ô¡∆÷¥––ø∆ “ID(mlng≤°»ÀID, 0, rsItems!¿‡±, rsItems!’Ô¡∆œÓƒøID, Val(.TextMatrix(lngCurRow, COL_ ’∑—œ∏ƒøID)), 4, mlng≤°»Àø∆ “id, 0, 1, 1, True)
                            End If
                            .TextMatrix(lngCurRow, COL_÷¥––ø∆ “ID) = lng≥…“©∑øID
                        ElseIf rsItems!¿‡± = "7" Then
                            If lng÷–“©∑øID = 0 Then
                                lng÷–“©∑øID = Get’Ô¡∆÷¥––ø∆ “ID(mlng≤°»ÀID, 0, rsItems!¿‡±, rsItems!’Ô¡∆œÓƒøID, Val(.TextMatrix(lngCurRow, COL_ ’∑—œ∏ƒøID)), 4, mlng≤°»Àø∆ “id, 0, 1, 1, True)
                            End If
                            .TextMatrix(lngCurRow, COL_÷¥––ø∆ “ID) = lng÷–“©∑øID
                        ElseIf rsItems!¿‡± = "4" Then
                            If lng∑¢¡œ≤ø√≈ID = 0 Then
                                lng∑¢¡œ≤ø√≈ID = Get ’∑—÷¥––ø∆ “ID(mlng≤°»ÀID, 0, rsItems!¿‡±, Val(.TextMatrix(lngCurRow, COL_ ’∑—œ∏ƒøID)), 4, mlng≤°»Àø∆ “id, 0, 1, , 1)
                            End If
                            .TextMatrix(lngCurRow, COL_÷¥––ø∆ “ID) = lng∑¢¡œ≤ø√≈ID
                        Else
                            '÷Æ«∞œ»«Ûø™÷ˆø∆ “ID
                            .TextMatrix(lngCurRow, COL_÷¥––ø∆ “ID) = Get’Ô¡∆÷¥––ø∆ “ID(mlng≤°»ÀID, 0, rsItems!¿‡±, rsItems!’Ô¡∆œÓƒøID, 0, _
                                Val(.TextMatrix(lngCurRow, COL_÷¥–––‘÷ )), mlng≤°»Àø∆ “id, Val(.TextMatrix(lngCurRow, COL_ø™÷ˆø∆ “ID)), 1, 1)
                        End If
                    End If
                End If
                
                '“Ω…˙÷ˆÕ–
                .TextMatrix(lngCurRow, COL_“Ω…˙÷ˆÕ–) = Nvl(rsItems!“Ω…˙÷ˆÕ–)
                .Cell(flexcpData, lngCurRow, COL_“Ω…˙÷ˆÕ–) = gclsInsure.GetItemInfo(mintœ’¿‡, mlng≤°»ÀID, Val(.TextMatrix(lngCurRow, COL_ ’∑—œ∏ƒøID)), "", 0, "", .TextMatrix(lngCurRow, COL_’Ô¡∆œÓƒøID) & "|1")
                
                
                'ø™÷ˆ ±º‰
                .TextMatrix(lngCurRow, COL_ø™÷ˆ ±º‰) = Format(vCurDate, "yyyy-MM-dd HH:mm")
                .Cell(flexcpData, lngCurRow, COL_ø™÷ˆ ±º‰) = Format(vCurDate, "yyyy-MM-dd HH:mm")
                
                'ΩÙº±±Í÷æ
                .TextMatrix(lngCurRow, COL_±Í÷æ) = chkΩÙº±.value 'ø…“‘‘⁄ΩÁ√Êœ»Õ≥“ª…Ë÷√Œ™ΩÙº±
                If gblnKSSStrict And UserInfo.”√“©º∂± < Val(.TextMatrix(lngCurRow, COL_øπæ˙µ»º∂)) And .TextMatrix(lngCurRow, COL_±Í÷æ) <> "1" Then

                    .TextMatrix(lngCurRow, COL_…Û∫À◊¥Ã¨) = 1
                End If
                
                If .TextMatrix(lngCurRow, COL_¿‡±) = "E" And .TextMatrix(lngCurRow, COL_≤Ÿ◊˜¿‡–Õ) = "8" And Val(.TextMatrix(lngCurRow, COL_œ‡πÿID)) <> 0 Then
                    strSQL = ""
                    strSQL = GetBloodState(IIF(.TextMatrix(lngCurRow, COL_±Í÷æ) = "1", 1, 0), Val(.TextMatrix(lngCurRow, COL_÷¥––∑÷¿‡)))
                    .TextMatrix(lngCurRow - 1, COL_…Û∫À◊¥Ã¨) = strSQL
                    .TextMatrix(lngCurRow, COL_…Û∫À◊¥Ã¨) = strSQL
                End If
                Call SetRow±Í÷æÕº±Í(lngCurRow, 1)
                
                '∂¡»°“©∆∑ø‚¥Ê
                If InStr(",5,6,7,", .TextMatrix(lngCurRow, COL_¿‡±)) > 0 Or .TextMatrix(lngCurRow, COL_¿‡±) = "4" And Val(.TextMatrix(lngCurRow, COL_∏˙◊Ÿ‘⁄”√)) = 1 Then
                    If Val(.TextMatrix(lngCurRow, COL_ ’∑—œ∏ƒøID)) <> 0 And Val(.TextMatrix(lngCurRow, COL_÷¥––ø∆ “ID)) <> 0 Then
                        .TextMatrix(lngCurRow, COL_ø‚¥Ê) = GetStock(Val(.TextMatrix(lngCurRow, COL_ ’∑—œ∏ƒøID)), Val(.TextMatrix(lngCurRow, COL_÷¥––ø∆ “ID)), 1)
                    End If
                End If
                
                '----------------------
                '∂æ¬Èæ´“©∆∑±Í ∂:÷–“©≈‰∑Ωº∞◊È≥…Œ∂÷–“©≤ª¥¶¿Ì
                If InStr(",5,6,", .TextMatrix(lngCurRow, COL_¿‡±)) > 0 And .TextMatrix(lngCurRow, COL_∂æ¿Ì∑÷¿‡) <> "" Then
                    If InStr(",¬È◊Ì“©,∂æ–‘“©,æ´…Ò“©,æ´…ÒI¿‡,æ´…ÒII¿‡,", .TextMatrix(lngCurRow, COL_∂æ¿Ì∑÷¿‡)) > 0 Then
                        .Cell(flexcpFontBold, lngCurRow, col_“Ω÷ˆƒ⁄»›) = True
                    End If
                End If
                
                '“˛±Œ“ª–©∏Ωº”––
                If (InStr(",F,G,D,7,E,C,", rsItems!¿‡±) > 0 And Not IsNull(rsItems!œ‡πÿ–Ú∫≈)) Or bln∏¯“©Õææ∂ Then
                    .RowHidden(lngCurRow) = True
                End If
                
                '“Ω÷ˆƒ⁄»›
                If Not .RowHidden(lngCurRow) Then
                    If IsNull(rsItems!’Ô¡∆œÓƒøID) Then
                        .TextMatrix(lngCurRow, col_“Ω÷ˆƒ⁄»›) = rsItems!“Ω÷ˆƒ⁄»› '◊‘”…¬º»Î“Ω÷ˆ
                    ElseIf InStr(",F,D,", rsItems!¿‡±) > 0 And IsNull(rsItems!œ‡πÿ–Ú∫≈) Then
                        .TextMatrix(lngCurRow, col_“Ω÷ˆƒ⁄»›) = rsItems!√˚≥∆ '¡Ÿ ±
                    Else
                        .TextMatrix(lngCurRow, col_“Ω÷ˆƒ⁄»›) = AdviceTextMake(lngCurRow)
                    End If
                Else
                    .TextMatrix(lngCurRow, col_“Ω÷ˆƒ⁄»›) = rsItems!√˚≥∆
                End If
                
                '≤˙…˙–¬÷ˆ ±£¨‘⁄ø…º˚––∂¡»°’Ô¡∆œÓƒø∏ΩœÓ¥Æ£¨”√”⁄ºÏ≤È£¨≤ª”√”⁄±£¥Ê
                If Not .RowHidden(lngCurRow) Then
                    If Not bln÷–“©”√∑® Then
                        If bln≤…ºØ∑Ω∑® Then
                            j = .FindRow(CStr(.RowData(lngCurRow)), , COL_œ‡πÿID)
                            If j <> -1 Then
                                .TextMatrix(lngCurRow, COL_∏ΩœÓ) = Get“Ω÷ˆœÓƒø∏Ωº˛(Val(.TextMatrix(j, COL_’Ô¡∆œÓƒøID)), 1)
                            End If
                        Else
                            .TextMatrix(lngCurRow, COL_∏ΩœÓ) = Get“Ω÷ˆœÓƒø∏Ωº˛(Val(.TextMatrix(lngCurRow, COL_’Ô¡∆œÓƒøID)), 1)
                        End If
                        If .TextMatrix(lngCurRow, COL_∏ΩœÓ) <> "" Then
                            str∏ΩœÓ = str∏ΩœÓ & vbCrLf & "°Ò" & .TextMatrix(lngCurRow, col_“Ω÷ˆƒ⁄»›)
                        End If
                    End If
                End If
                
                If lngPreRow = -1 And Not .RowHidden(lngCurRow) Then lngPreRow = lngCurRow
                            
                '----------------------
                intCount = intCount + 1
            End If
            rsItems.MoveNext
        Next
        
        '--------------------------------------------------
        '∆‰À¸∏Ωº”¥¶¿Ì
        For i = lngRow To lngCurRow
            '»°ºÏ≤È∫Õ ÷ ıµƒ“Ω÷ˆƒ⁄»›
            If InStr(",F,D,", .TextMatrix(i, COL_¿‡±)) > 0 And Val(.TextMatrix(i, COL_œ‡πÿID)) = 0 Then
                .TextMatrix(i, col_“Ω÷ˆƒ⁄»›) = AdviceTextMake(i)
            End If
            
            'º∆À„’Ô¡∆µ•º€
            If Not .RowHidden(i) And .TextMatrix(i, COL_µ•º€) = "" Then
                .TextMatrix(i, COL_µ•º€) = GetItemPrice(i)
            End If
        Next
        
        'µ˜’˚ ‹”∞œÏ––µƒ–Ú∫≈
        Call AdviceSet“Ω÷ˆ–Ú∫≈(lngCurRow + 1, intCount)
        '≤˙…˙ºŸ“Ω÷ˆID
        For i = lngRow To lngCurRow
            dblœ‡πÿID = .RowData(i)
            .RowData(i) = GetNext“Ω÷ˆID
            For j = i - 1 To lngRow Step -1
                If Val(.TextMatrix(j, COL_œ‡πÿID)) = dblœ‡πÿID Then
                    .TextMatrix(j, COL_œ‡πÿID) = .RowData(i)
                Else
                    Exit For
                End If
            Next
            For j = i + 1 To lngCurRow
                If Val(.TextMatrix(j, COL_œ‡πÿID)) = dblœ‡πÿID Then
                    .TextMatrix(j, COL_œ‡πÿID) = .RowData(i)
                Else
                    Exit For
                End If
            Next
            
            '–¬‘ˆ∫Ûπÿ¡™’Ô∂œµƒ±Íº«¥¶¿Ì
            If Val(.TextMatrix(i, COL_œ‡πÿID)) = 0 Then '“‘◊È––¥¶¿Ì∫ÛŒ™◊º
                Call SetDiagFlag(i, 1)
            End If
        Next
        If gblnOut±ÿ”√ Then Call MakeAppNo(2, lngRow, lngCurRow)
        Call Set“Ω÷ˆ≥¨¡ø(lngRow, lngCurRow)
        
        '--------------------------------------------------
        If .RowHidden(lngRow) Then '—∞’“ø…º˚––(»Á≈‰∑Ω∫ÕºÏ—È÷Æ∫Û)
            For i = lngRow + 1 To .Rows - 1
                If Not .RowHidden(i) And .RowData(i) <> 0 Then
                    lngRow = i: Exit For
                End If
            Next
        End If
        '∂®ŒªµΩ≥…Ã◊∑Ω∞∏µƒµ⁄“ª––£¨ «“ÚŒ™“Ω…˙µ˜”√≥…Ã◊∫Ûª·ºÏ≤ÈªÚ–ﬁ∏ƒ“Ω÷ˆ£¨µ⁄“ª––÷Æ∫Ûµƒ“Ω÷ˆŒ™≥…Ã◊∑Ω∞∏µ˜”√µƒ“Ω÷ˆ
        .Row = lngRow: .Col = col_“Ω÷ˆƒ⁄»›
        Call .ShowCell(.Row, .Col)
        .Redraw = flexRDDirect
        mblnRowChange = True
    End With
    Screen.MousePointer = 0
    
    If str∏ΩœÓ <> "" Then
        MsgBox "“‘œ¬“Ω÷ˆ–Ë“™ÃÓ–¥…Í«Î∏ΩœÓ£¨«Î◊¢“‚ÃÓ–¥£∫" & vbCrLf & str∏ΩœÓ, vbInformation, gstrSysName
    End If
    If str∏ﬂŒ£“©∆∑ <> "" Then
        MsgBox "“‘œ¬“Ω÷ˆ «∏ﬂŒ£“©∆∑£∫" & str∏ﬂŒ£“©∆∑, vbInformation, gstrSysName
    End If
    Exit Sub
errH:
    Screen.MousePointer = 0
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Function GetPreRow÷–“©∑ø(lngRow As Long) As Long
'π¶ƒ‹£∫ªÒ»°…œ“ªªÚœ¬“ª÷–“©––µƒ÷¥––ø∆ “
    Dim lngDrugRow As Long, lngCopyRow As Long
    
    lngDrugRow = -1
    lngCopyRow = GetPreRow(lngRow)
    If lngCopyRow = -1 Then lngCopyRow = GetNextRow(lngRow)
    If lngCopyRow <> -1 Then
        If RowIn≈‰∑Ω––(lngCopyRow) Then
            '»Áπ˚…œ“ª”––ß–– «÷–“©≈‰∑Ωµƒ,‘Ú»°À¸µƒµ⁄“ª÷–“©––
            lngDrugRow = vsAdvice.FindRow(CStr(vsAdvice.RowData(lngCopyRow)), , COL_œ‡πÿID)
        End If
    End If
    
    If lngDrugRow <> -1 Then '»± °”Î…œ“ª≈‰∑Ω––œ‡Õ¨
        GetPreRow÷–“©∑ø = Val("" & vsAdvice.TextMatrix(lngDrugRow, COL_÷¥––ø∆ “ID))
    End If
End Function

Private Function AdviceSet÷–“©≈‰∑Ω(lng’Ô¡∆œÓƒøID As Long, ByVal lngRow As Long, ByVal lng”√∑®ID As Long, _
    ByVal strExtData As String, Optional rsCurr As ADODB.Recordset, Optional ByVal str’™“™ As String, Optional ByVal lng≈‰∑ΩID As Long) As Long
'π¶ƒ‹£∫(÷ÿ–¬)¥¶¿Ì÷–“©≈‰∑Ωµƒ»± °“Ω÷ˆ ˝æ›
'≤Œ ˝£∫lng’Ô¡∆œÓƒøID= ‰»Îµƒ÷–“©≈‰∑ΩIDªÚµ•Œ∂÷–“©ID
'      lngRow=µ±«∞ ‰»Î––
'      lng”√∑®ID=»± °÷–“©”√∑®ID
'      strExtData=∞¸∫¨≈‰∑Ω◊È≥…Œ∂“©º∞ºÂ∑® ˝æ›:πÊ∏ÒID1, ˝¡ø,Ω≈◊¢;πÊ∏ÒID2, ˝¡ø,Ω≈◊¢...|÷–“©ºÂ∑®|÷–“©–ŒÃ¨|∏∂ ˝|“©∑øID|ºÂ¡ø"
'      rsCurr=»Áπ˚ «–ﬁ∏ƒ¡À≈‰∑Ωƒ⁄»›∫Ûµ˜”√,‘Ú∞¸∫¨“™±£≥÷µƒ“ª–©µ±«∞÷µ
'      str’™“™=“Ω±£’™“™
'∑µªÿ£∫¥¶¿Ì∫Ûµƒ÷–“©≈‰∑Ωµƒµ±«∞œ‘ æ––∫≈
    Dim rsItems As New ADODB.Recordset '÷–“©œÍœ∏–≈œ¢
    Dim rsUse As New ADODB.Recordset '÷–“©”√∑®–≈œ¢
    Dim rsºÂ∑® As New ADODB.Recordset '÷–“©ºÂ∑®œÓƒø–≈œ¢
    Dim rs”√∑® As New ADODB.Recordset '÷–“©”√∑®œÓƒø–≈œ¢
    Dim arr÷–“©s As Variant, str÷–“©IDs As String, lngœ‡πÿID As Long
    Dim lngCopyRow As Long '»± °≤Œ’’––
    Dim lngDrugRow As Long '»Áπ˚»± °≤Œ’’–– «÷–“©≈‰∑Ω,‘ÚŒ™∏√≈‰∑Ωµƒµ⁄“ª∏ˆ÷–“©––
    Dim lngFirstRow As Long 'µ±«∞≈‰∑Ωµƒµ⁄“ª∏ˆ÷–“©––
    Dim strSQL As String, i As Long
    Dim blnOutOfRange As Boolean
    
    Dim str∆µ¬  As String, int∆µ¬ ¥Œ ˝ As Integer, int∆µ¬ º‰∏Ù As Integer, strº‰∏Ùµ•Œª As String
    Dim lngºÂ∑®ID As Long, int¡∆≥Ã As Integer
    Dim str“Ω…˙ As String, lng“Ω…˙ID As Long
    Dim lng–ŒÃ¨ As Long
    Dim str∏ﬂŒ£“©∆∑ As String, strºÂ¡ø As String
        
    On Error GoTo errH
    
    '»°…œ“ªªÚœ¬“ª”––ß––,ƒ≥–©ƒ⁄»›»± °”Î∏√––œ‡Õ¨
    lngDrugRow = -1
    lngCopyRow = GetPreRow(lngRow)
    If lngCopyRow = -1 Then lngCopyRow = GetNextRow(lngRow)
    If lngCopyRow <> -1 Then
        If RowIn≈‰∑Ω––(lngCopyRow) Then
            '»Áπ˚…œ“ª”––ß–– «÷–“©≈‰∑Ωµƒ,‘Ú»°À¸µƒµ⁄“ª÷–“©––
            lngDrugRow = vsAdvice.FindRow(CStr(vsAdvice.RowData(lngCopyRow)), , COL_œ‡πÿID)
        End If
    End If
    
    'ªÒ»°œ‡πÿ ˝æ›ø‚–≈œ¢
    '------------------
    arr÷–“©s = Split(Split(strExtData, "|")(0), ";")
    For i = 0 To UBound(arr÷–“©s)
        str÷–“©IDs = str÷–“©IDs & "," & CStr(Split(arr÷–“©s(i), ",")(0))
    Next
    str÷–“©IDs = Mid(str÷–“©IDs, 2)
    lngºÂ∑®ID = Val(Split(strExtData, "|")(1))
    lng–ŒÃ¨ = Val(Split(strExtData, "|")(2))
    strºÂ¡ø = Split(strExtData, "|")(5)

    
    '≈‰∑Ω”√∑®–≈œ¢:÷±Ω” ‰»Î≈‰∑Ω ±≤≈”–ø…ƒ‹”–, ‰»Îµ•Œ∂÷–“©Œﬁ
    strSQL = "Select A.”√∑®ID,A.∆µ¥Œ,A.¡∆≥Ã,A.“Ω…˙÷ˆÕ–" & _
        " From ’Ô¡∆”√∑®”√¡ø A,’Ô¡∆œÓƒøƒø¬º B" & _
        " Where A.”√∑®ID=B.ID And B.∑˛ŒÒ∂‘œÛ IN(1,3)" & _
        " And Nvl(A.–‘÷ ,0)=0 And A.œÓƒøID=[1]" & _
        " And (B.’æµ„='" & gstrNodeNo & "' Or B.’æµ„ is Null)" & _
        " And (b.≥∑µµ ±º‰=To_Date('3000-01-01','YYYY-MM-DD') Or b.≥∑µµ ±º‰ is NULL)"
    Set rsUse = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng’Ô¡∆œÓƒøID)
    If Not rsUse.EOF Then lng”√∑®ID = rsUse!”√∑®ID '»± °…Ë÷√µƒ÷–“©≈‰∑Ω”√∑®”≈œ»
    
    '≈‰∑Ω◊È≥…Œ∂÷–“©–≈œ¢:÷–“©ŒﬁπÊ∏Ò∏≈ƒÓ,∂‘”¶µƒµƒπÊ∏Òº«¬º“ª∂®”–«“÷ª”–“ªÃı
    strSQL = "Select /*+ rule*/A.º∆À„πÊ‘Ú,A.’æµ„,A.¿‡±,A.∑÷¿‡ID,A.ID,A.±‡¬Î,A.√˚≥∆,A.±Í±æ≤øŒª,A.º∆À„µ•Œª,A.º∆À„∑Ω Ω,A.÷¥––∆µ¬ ,A.  ”√–‘±," & _
        "A.µ•∂¿”¶”√,A.◊È∫œœÓƒø,A.≤Ÿ◊˜¿‡–Õ,A.÷¥––∞≤≈≈,A.÷¥––ø∆ “,A.∑˛ŒÒ∂‘œÛ,A.º∆º€–‘÷ ,A.≤Œøºƒø¬ºID,A.»À‘±ID,A.Ω®µµ ±º‰,A.≥∑µµ ±º‰," & _
        "A.¬º»Îœﬁ¡ø,A. ‘π‹±‡¬Î,A.÷¥––∑÷¿‡,A.÷¥––±Íº«,B.“©∆∑ID,B.º¡¡øœµ ˝,B.√≈’Ô∞¸◊∞,B.√≈’Ôµ•Œª,B.√≈’Ôø…∑Ò∑÷¡„ As ø…∑Ò∑÷¡„,C.¥¶∑Ωœﬁ¡ø,C.¥¶∑Ω÷∞ŒÒ,c.¡Ÿ¥≤◊‘π‹“©,b.∏ﬂŒ£“©∆∑" & _
        " From ’Ô¡∆œÓƒøƒø¬º A,“©∆∑πÊ∏Ò B,“©∆∑Ãÿ–‘ C" & _
        " Where A.ID=B.“©√˚ID And A.ID=C.“©√˚ID And B.“©∆∑ID IN(Select Column_Value From Table(f_Num2list([1])))"
    Set rsItems = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, str÷–“©IDs)
    
    '≈‰∑ΩºÂ∑®œÓƒø–≈œ¢
    Set rsºÂ∑® = Get’Ô¡∆œÓƒøº«¬º(lngºÂ∑®ID)
    
    '≈‰∑Ω”√∑®œÓƒø–≈œ¢
    Set rs”√∑® = Get’Ô¡∆œÓƒøº«¬º(lng”√∑®ID)
    
    'º”»Î≈‰∑Ω◊È≥…Œ∂÷–“©––:∞¥’’”√ªß ‰»ÎÀ≥–Ú
    '--------------------------------------------------------------------------------------
    '--------------------------------------------------------------------------------------
    mblnRowChange = False
    
    '÷–“©”√∑®µƒ“Ω÷ˆID,IDÀ≥–Ú”Î–Ú∫≈≤ª“ª∂®“ª÷¬
    If Not rsCurr Is Nothing Then
        '–ﬁ∏ƒ¡À≈‰∑Ω÷–µƒƒ⁄»›,”√∑®––±Íº«Œ™–ﬁ∏ƒ,“Ω÷ˆID≤ª±‰
        lngœ‡πÿID = rsCurr!“Ω÷ˆID
    Else
        '–¬ ‰»Îµƒ÷–“©≈‰∑Ω
        lngœ‡πÿID = GetNext“Ω÷ˆID
    End If
    
    For i = 0 To UBound(arr÷–“©s)
        rsItems.Filter = "“©∆∑ID=" & CStr(Split(arr÷–“©s(i), ",")(0)) '”¶∏√øœ∂®”–
        
        vsAdvice.AddItem "", lngRow
        
        vsAdvice.RowHidden(lngRow) = True
        vsAdvice.RowData(lngRow) = GetNext“Ω÷ˆID
        vsAdvice.TextMatrix(lngRow, COL_œ‡πÿID) = lngœ‡πÿID '∂‘”¶µΩ∫Û√Êµƒ÷–“©”√∑®––
        vsAdvice.TextMatrix(lngRow, COL_EDIT) = 1 '–¬‘ˆ
        vsAdvice.TextMatrix(lngRow, COL_”§∂˘) = cbo”§∂˘.ListIndex
        vsAdvice.TextMatrix(lngRow, COL_◊¥Ã¨) = 1 '–¬ø™
        vsAdvice.TextMatrix(lngRow, COL_–Ú∫≈) = GetCurRow–Ú∫≈(lngRow)
        Call AdviceSet“Ω÷ˆ–Ú∫≈(lngRow + 1, 1) 'µ˜’˚–Ú∫≈
        
        vsAdvice.TextMatrix(lngRow, COL_¿‡±) = rsItems!¿‡±
        vsAdvice.TextMatrix(lngRow, col_“Ω÷ˆƒ⁄»›) = rsItems!√˚≥∆
        vsAdvice.TextMatrix(lngRow, COL_’Ô¡∆œÓƒøID) = rsItems!ID
        vsAdvice.TextMatrix(lngRow, COL_º∆À„∑Ω Ω) = Nvl(rsItems!º∆À„∑Ω Ω, 0)
        vsAdvice.TextMatrix(lngRow, COL_∆µ¬ –‘÷ ) = Nvl(rsItems!÷¥––∆µ¬ , 0)
        vsAdvice.TextMatrix(lngRow, COL_≤Ÿ◊˜¿‡–Õ) = Nvl(rsItems!≤Ÿ◊˜¿‡–Õ)
        vsAdvice.TextMatrix(lngRow, COL_µ•∂¿”¶”√) = Nvl(rsItems!µ•∂¿”¶”√)
        vsAdvice.TextMatrix(lngRow, COL_÷¥––∑÷¿‡) = Nvl(rsItems!÷¥––∑÷¿‡, 0)
        
        vsAdvice.TextMatrix(lngRow, COL_µ•¡ø) = FormatEx(Val(Split(arr÷–“©s(i), ",")(1)), 5) 'µ•Œ∂“©µƒµ•¥Œ”√¡ø
        vsAdvice.TextMatrix(lngRow, COL_µ•¡øµ•Œª) = Nvl(rsItems!º∆À„µ•Œª)
        vsAdvice.TextMatrix(lngRow, COL_“Ω…˙÷ˆÕ–) = CStr(Split(arr÷–“©s(i), ",")(2)) 'µ•Œ∂“©µƒΩ≈◊¢
        vsAdvice.Cell(flexcpData, lngRow, COL_“Ω…˙÷ˆÕ–) = str’™“™
        
        'πÊ∏Ò–≈œ¢:÷–“©≤ª¥Ê‘⁄πÊ∏Ò∏≈ƒÓ,“ª∂®”–
        vsAdvice.TextMatrix(lngRow, COL_ ’∑—œ∏ƒøID) = rsItems!“©∆∑ID
        vsAdvice.TextMatrix(lngRow, COL_¥¶∑Ωœﬁ¡ø) = Nvl(rsItems!¥¶∑Ωœﬁ¡ø)
        vsAdvice.TextMatrix(lngRow, COL_º¡¡øœµ ˝) = rsItems!º¡¡øœµ ˝
        vsAdvice.TextMatrix(lngRow, COL_√≈’Ôµ•Œª) = rsItems!√≈’Ôµ•Œª
        vsAdvice.TextMatrix(lngRow, COL_√≈’Ô∞¸◊∞) = rsItems!√≈’Ô∞¸◊∞
        vsAdvice.TextMatrix(lngRow, COL_ø…∑Ò∑÷¡„) = Nvl(rsItems!ø…∑Ò∑÷¡„, 0) '∂‘÷–“© µº …œŒﬁ”√
        vsAdvice.TextMatrix(lngRow, COL_¥¶∑Ω÷∞ŒÒ) = Nvl(rsItems!¥¶∑Ω÷∞ŒÒ)
        vsAdvice.TextMatrix(lngRow, COL_¡Ÿ¥≤◊‘π‹“©) = rsItems!¡Ÿ¥≤◊‘π‹“© & ""
        vsAdvice.TextMatrix(lngRow, COL_∏ﬂŒ£“©∆∑) = rsItems!∏ﬂŒ£“©∆∑ & ""
        If Val(vsAdvice.TextMatrix(lngRow, COL_∏ﬂŒ£“©∆∑)) <> 0 Then
            str∏ﬂŒ£“©∆∑ = str∏ﬂŒ£“©∆∑ & vbCrLf & vsAdvice.TextMatrix(lngRow, col_“Ω÷ˆƒ⁄»›) & ":" & Decode(Val(vsAdvice.TextMatrix(lngRow, COL_∏ﬂŒ£“©∆∑)), 1, "A", 2, "B", 3, "C", "") & "º∂£ª"
        End If
        vsAdvice.Cell(flexcpData, lngRow, COL_“Ω…˙÷ˆÕ–) = gclsInsure.GetItemInfo(mintœ’¿‡, mlng≤°»ÀID, Val(vsAdvice.TextMatrix(lngRow, COL_ ’∑—œ∏ƒøID)), "", 0, "", vsAdvice.TextMatrix(lngRow, COL_’Ô¡∆œÓƒøID))

        'º∆º€–‘÷ :∏˜◊‘∂¿¡¢
        vsAdvice.TextMatrix(lngRow, COL_º∆º€–‘÷ ) = Nvl(rsItems!º∆º€–‘÷ , 0)
        
        If lngFirstRow <> 0 Then
            '”Î…œ“ª––“—…Ë÷√µƒ◊È≥…÷–“©œ‡Õ¨
            vsAdvice.TextMatrix(lngRow, COL_÷¥–––‘÷ ) = vsAdvice.TextMatrix(lngFirstRow, COL_÷¥–––‘÷ )
            vsAdvice.TextMatrix(lngRow, COL_÷¥––ø∆ “ID) = vsAdvice.TextMatrix(lngFirstRow, COL_÷¥––ø∆ “ID)
            vsAdvice.TextMatrix(lngRow, COL_∆µ¬ ) = vsAdvice.TextMatrix(lngFirstRow, COL_∆µ¬ )
            vsAdvice.TextMatrix(lngRow, COL_∆µ¬ ¥Œ ˝) = vsAdvice.TextMatrix(lngFirstRow, COL_∆µ¬ ¥Œ ˝)
            vsAdvice.TextMatrix(lngRow, COL_∆µ¬ º‰∏Ù) = vsAdvice.TextMatrix(lngFirstRow, COL_∆µ¬ º‰∏Ù)
            vsAdvice.TextMatrix(lngRow, COL_º‰∏Ùµ•Œª) = vsAdvice.TextMatrix(lngFirstRow, COL_º‰∏Ùµ•Œª)
            vsAdvice.TextMatrix(lngRow, COL_◊‹¡ø) = vsAdvice.TextMatrix(lngFirstRow, COL_◊‹¡ø)
            vsAdvice.TextMatrix(lngRow, COL_÷¥–– ±º‰) = vsAdvice.TextMatrix(lngFirstRow, COL_÷¥–– ±º‰)
            
            vsAdvice.TextMatrix(lngRow, COL_ø™ º ±º‰) = vsAdvice.TextMatrix(lngFirstRow, COL_ø™ º ±º‰)
            vsAdvice.Cell(flexcpData, lngRow, COL_ø™ º ±º‰) = vsAdvice.Cell(flexcpData, lngFirstRow, COL_ø™ º ±º‰)
            
            vsAdvice.TextMatrix(lngRow, COL_ø™÷ˆ“Ω…˙) = vsAdvice.TextMatrix(lngFirstRow, COL_ø™÷ˆ“Ω…˙)
            vsAdvice.TextMatrix(lngRow, COL_ø™÷ˆø∆ “ID) = vsAdvice.TextMatrix(lngFirstRow, COL_ø™÷ˆø∆ “ID)
            
            vsAdvice.TextMatrix(lngRow, COL_ø™÷ˆ ±º‰) = vsAdvice.TextMatrix(lngFirstRow, COL_ø™÷ˆ ±º‰)
            vsAdvice.Cell(flexcpData, lngRow, COL_ø™÷ˆ ±º‰) = vsAdvice.Cell(flexcpData, lngFirstRow, COL_ø™÷ˆ ±º‰)
            
            vsAdvice.TextMatrix(lngRow, COL_±Í÷æ) = vsAdvice.TextMatrix(lngFirstRow, COL_±Í÷æ)
        ElseIf Not rsCurr Is Nothing Then
            '–ﬁ∏ƒ¡À≈‰∑Ωƒ⁄»›∫Û÷ÿ–¬…Ë÷√,±£≥÷”Îµ±«∞µƒ÷µ
            
            '÷¥–––‘÷ :–ﬁ∏ƒ ±∏˘æ›µ±«∞ΩÁ√Ê…Ë÷√æˆ∂®
            vsAdvice.TextMatrix(lngRow, COL_÷¥–––‘÷ ) = Decode(Nvl(rsCurr!÷¥–––‘÷ ), "◊‘±∏“©", 5, 4)
            '÷¥––ø∆ “
            vsAdvice.TextMatrix(lngRow, COL_÷¥––ø∆ “ID) = IIF(Val(vsAdvice.TextMatrix(lngRow, COL_÷¥–––‘÷ )) = 5, 0, Val("" & rsCurr!÷¥––ø∆ “ID))
            
            vsAdvice.TextMatrix(lngRow, COL_∆µ¬ ) = Nvl(rsCurr!∆µ¬ )
            vsAdvice.TextMatrix(lngRow, COL_∆µ¬ ¥Œ ˝) = Nvl(rsCurr!∆µ¬ ¥Œ ˝)
            vsAdvice.TextMatrix(lngRow, COL_∆µ¬ º‰∏Ù) = Nvl(rsCurr!∆µ¬ º‰∏Ù)
            vsAdvice.TextMatrix(lngRow, COL_º‰∏Ùµ•Œª) = Nvl(rsCurr!º‰∏Ùµ•Œª)
            vsAdvice.TextMatrix(lngRow, COL_◊‹¡ø) = Nvl(rsCurr!◊‹¡ø)
            vsAdvice.TextMatrix(lngRow, COL_÷¥–– ±º‰) = Nvl(rsCurr!÷¥–– ±º‰)
            
            vsAdvice.TextMatrix(lngRow, COL_ø™ º ±º‰) = Format(Nvl(rsCurr!ø™ º ±º‰), "yyyy-MM-dd HH:mm")
            vsAdvice.Cell(flexcpData, lngRow, COL_ø™ º ±º‰) = CStr(Nvl(rsCurr!ø™ º ±º‰))
            
            vsAdvice.TextMatrix(lngRow, COL_ø™÷ˆ“Ω…˙) = Nvl(rsCurr!ø™÷ˆ“Ω…˙)
            vsAdvice.TextMatrix(lngRow, COL_ø™÷ˆø∆ “ID) = Nvl(rsCurr!ø™÷ˆø∆ “id)
            
            vsAdvice.TextMatrix(lngRow, COL_ø™÷ˆ ±º‰) = Format(Nvl(rsCurr!ø™÷ˆ ±º‰), "yyyy-MM-dd HH:mm")
            vsAdvice.Cell(flexcpData, lngRow, COL_ø™÷ˆ ±º‰) = CStr(Nvl(rsCurr!ø™÷ˆ ±º‰))
            
            vsAdvice.TextMatrix(lngRow, COL_±Í÷æ) = Nvl(rsCurr!±Í÷æ)
        Else
            '÷¥–––‘÷ :÷–“©≈‰∑Ω◊È≥…÷–“©œ‡Õ¨,»± °=4-÷∏∂®ø∆ “,5-◊‘±∏“©
            vsAdvice.TextMatrix(lngRow, COL_÷¥–––‘÷ ) = IIF(Val(vsAdvice.TextMatrix(lngRow, COL_¡Ÿ¥≤◊‘π‹“©)) = 1, 5, 4)
        
            '÷¥––ø∆ “(œ»‘⁄≈‰∑ΩΩÁ√Ê—°‘Ò)
            vsAdvice.TextMatrix(lngRow, COL_÷¥––ø∆ “ID) = IIF(Val(vsAdvice.TextMatrix(lngRow, COL_÷¥–––‘÷ )) = 5, 0, Val(Split(strExtData, "|")(4)))
            
            '÷¥––∆µ¬ 
            '∏˘æ›”√∑®¿Ô√Ê…Ë÷√µƒ”≈œ»
            If Not rsUse.EOF Then
                If Not IsNull(rsUse!∆µ¥Œ) Then
                    Call Get∆µ¬ –≈œ¢_±‡¬Î(rsUse!∆µ¥Œ, str∆µ¬ , int∆µ¬ ¥Œ ˝, int∆µ¬ º‰∏Ù, strº‰∏Ùµ•Œª)
                    vsAdvice.TextMatrix(lngRow, COL_∆µ¬ ) = str∆µ¬ 
                    vsAdvice.TextMatrix(lngRow, COL_∆µ¬ ¥Œ ˝) = int∆µ¬ ¥Œ ˝
                    vsAdvice.TextMatrix(lngRow, COL_∆µ¬ º‰∏Ù) = int∆µ¬ º‰∏Ù
                    vsAdvice.TextMatrix(lngRow, COL_º‰∏Ùµ•Œª) = strº‰∏Ùµ•Œª
                End If
            End If
            'ªÚ»± °”Î…œ“ª––œ‡Õ¨
            If vsAdvice.TextMatrix(lngRow, COL_∆µ¬ ) = "" And lngDrugRow <> -1 Then
                If Val(vsAdvice.TextMatrix(lngDrugRow, COL_EDIT)) = 1 And vsAdvice.TextMatrix(lngDrugRow, COL_∆µ¬ ) <> "" Then
                    vsAdvice.TextMatrix(lngRow, COL_∆µ¬ ) = vsAdvice.TextMatrix(lngDrugRow, COL_∆µ¬ )
                    vsAdvice.TextMatrix(lngRow, COL_∆µ¬ ¥Œ ˝) = vsAdvice.TextMatrix(lngDrugRow, COL_∆µ¬ ¥Œ ˝)
                    vsAdvice.TextMatrix(lngRow, COL_∆µ¬ º‰∏Ù) = vsAdvice.TextMatrix(lngDrugRow, COL_∆µ¬ º‰∏Ù)
                    vsAdvice.TextMatrix(lngRow, COL_º‰∏Ùµ•Œª) = vsAdvice.TextMatrix(lngDrugRow, COL_º‰∏Ùµ•Œª)
                End If
            End If
            'ªÚ»°»± °÷µ
            If vsAdvice.TextMatrix(lngRow, COL_∆µ¬ ) = "" Then
                Call Get»± °∆µ¬ (Nvl(rsItems!ID, 0), 2, str∆µ¬ , int∆µ¬ ¥Œ ˝, int∆µ¬ º‰∏Ù, strº‰∏Ùµ•Œª)
                vsAdvice.TextMatrix(lngRow, COL_∆µ¬ ) = str∆µ¬ 
                vsAdvice.TextMatrix(lngRow, COL_∆µ¬ ¥Œ ˝) = int∆µ¬ ¥Œ ˝
                vsAdvice.TextMatrix(lngRow, COL_∆µ¬ º‰∏Ù) = int∆µ¬ º‰∏Ù
                vsAdvice.TextMatrix(lngRow, COL_º‰∏Ùµ•Œª) = strº‰∏Ùµ•Œª
            End If
            
            '◊‹¡ø(∏∂ ˝):∑«…¢◊∞–ŒÃ¨“—»∑∂®∏∂ ˝
            If Val(Split(strExtData, "|")(3)) > 1 Or lng–ŒÃ¨ <> 0 Then
                vsAdvice.TextMatrix(lngRow, COL_◊‹¡ø) = Val(Split(strExtData, "|")(3))
            Else
                If vsAdvice.TextMatrix(lngRow, COL_∆µ¬ ) <> "" Then
                    int¡∆≥Ã = 1
                    If Not rsUse.EOF Then int¡∆≥Ã = Nvl(rsUse!¡∆≥Ã, 1)
                    '≈‰∑Ω∏∂ ˝
                    vsAdvice.TextMatrix(lngRow, COL_◊‹¡ø) = Calc»± °“©∆∑◊‹¡ø(1, int¡∆≥Ã, _
                            Val(vsAdvice.TextMatrix(lngRow, COL_∆µ¬ ¥Œ ˝)), _
                            Val(vsAdvice.TextMatrix(lngRow, COL_∆µ¬ º‰∏Ù)), _
                            vsAdvice.TextMatrix(lngRow, COL_º‰∏Ùµ•Œª))
                End If
            End If
            
            '÷¥–– ±º‰
            If lngDrugRow <> -1 Then '»± °”Î…œ“ª––œ‡Õ¨
                If vsAdvice.TextMatrix(lngRow, COL_∆µ¬ ) = vsAdvice.TextMatrix(lngDrugRow, COL_∆µ¬ ) Then
                    vsAdvice.TextMatrix(lngRow, COL_÷¥–– ±º‰) = vsAdvice.TextMatrix(lngDrugRow, COL_÷¥–– ±º‰)
                End If
            End If
            If vsAdvice.TextMatrix(lngRow, COL_÷¥–– ±º‰) = "" Then '»± ° ±º‰∑Ω∞∏
                vsAdvice.TextMatrix(lngRow, COL_÷¥–– ±º‰) = Get»± ° ±º‰(2, vsAdvice.TextMatrix(lngRow, COL_∆µ¬ ), lng”√∑®ID)
            End If
            
            'ø™ º ±º‰
            If IsDate(txtø™ º ±º‰.Text) Then
                vsAdvice.TextMatrix(lngRow, COL_ø™ º ±º‰) = Format(txtø™ º ±º‰.Text, "yyyy-MM-dd HH:mm")
                vsAdvice.Cell(flexcpData, lngRow, COL_ø™ º ±º‰) = txtø™ º ±º‰.Text
            End If
            
            'ø™÷ˆ“Ω…˙
            vsAdvice.TextMatrix(lngRow, COL_ø™÷ˆ“Ω…˙) = UserInfo.–’√˚
            vsAdvice.TextMatrix(lngRow, COL_ø™÷ˆø∆ “ID) = Getø™÷ˆø∆ “ID(UserInfo.ID, mlng“Ωººø∆ “ID, mlng≤°»Àø∆ “id, 1)
            
            vsAdvice.TextMatrix(lngRow, COL_ø™÷ˆ ±º‰) = Format(zlDatabase.Currentdate, "yyyy-MM-dd HH:mm")
            vsAdvice.Cell(flexcpData, lngRow, COL_ø™÷ˆ ±º‰) = Format(zlDatabase.Currentdate, "yyyy-MM-dd HH:mm")
            vsAdvice.TextMatrix(lngRow, COL_±Í÷æ) = chkΩÙº±.value
        End If
        
        '---------------------------------------
        If lngFirstRow = 0 Then lngFirstRow = lngRow '∏√÷–“©≈‰∑Ωµƒµ⁄“ª∏ˆ◊È≥…÷–“©––
        
        lngRow = lngRow + 1 '±£≥÷µ±«∞ ‰»Î––Œª÷√
    Next
    
    'º”»Î÷–“©≈‰∑ΩºÂ∑®––
    '--------------------------------------------------------------------------------------
    '--------------------------------------------------------------------------------------
    vsAdvice.AddItem "", lngRow
    vsAdvice.RowHidden(lngRow) = True
    vsAdvice.RowData(lngRow) = GetNext“Ω÷ˆID
    vsAdvice.TextMatrix(lngRow, COL_œ‡πÿID) = lngœ‡πÿID
    vsAdvice.TextMatrix(lngRow, COL_EDIT) = 1 '–¬‘ˆ
    vsAdvice.TextMatrix(lngRow, COL_”§∂˘) = cbo”§∂˘.ListIndex
    vsAdvice.TextMatrix(lngRow, COL_◊¥Ã¨) = 1 '–¬ø™
    vsAdvice.TextMatrix(lngRow, COL_–Ú∫≈) = GetCurRow–Ú∫≈(lngRow)
    Call AdviceSet“Ω÷ˆ–Ú∫≈(lngRow + 1, 1) 'µ˜’˚–Ú∫≈
    vsAdvice.TextMatrix(lngRow, COL_¿‡±) = rsºÂ∑®!¿‡±
    vsAdvice.TextMatrix(lngRow, COL_’Ô¡∆œÓƒøID) = lngºÂ∑®ID
    vsAdvice.TextMatrix(lngRow, COL_±Í±æ≤øŒª) = strºÂ¡ø
    vsAdvice.Cell(flexcpData, lngRow, COL_“Ω…˙÷ˆÕ–) = gclsInsure.GetItemInfo(mintœ’¿‡, mlng≤°»ÀID, 0, "", 0, "", vsAdvice.TextMatrix(lngRow, COL_’Ô¡∆œÓƒøID))
    
    vsAdvice.TextMatrix(lngRow, COL_º∆À„∑Ω Ω) = Nvl(rsºÂ∑®!º∆À„∑Ω Ω, 0)
    vsAdvice.TextMatrix(lngRow, COL_∆µ¬ –‘÷ ) = Nvl(rsºÂ∑®!÷¥––∆µ¬ , 0)
    vsAdvice.TextMatrix(lngRow, COL_≤Ÿ◊˜¿‡–Õ) = Nvl(rsºÂ∑®!≤Ÿ◊˜¿‡–Õ)
    vsAdvice.TextMatrix(lngRow, COL_µ•∂¿”¶”√) = Nvl(rsºÂ∑®!µ•∂¿”¶”√)
    vsAdvice.TextMatrix(lngRow, COL_÷¥––∑÷¿‡) = Nvl(rsºÂ∑®!÷¥––∑÷¿‡, 0)
    
    '!÷–“©ºÂ∑®÷–“≤¥Ê∑≈÷–“©µƒ∏∂ ˝
    vsAdvice.TextMatrix(lngRow, COL_◊‹¡ø) = vsAdvice.TextMatrix(lngFirstRow, COL_◊‹¡ø)
    
    vsAdvice.TextMatrix(lngRow, col_“Ω÷ˆƒ⁄»›) = rsºÂ∑®!√˚≥∆
    
    vsAdvice.TextMatrix(lngRow, COL_ø™ º ±º‰) = vsAdvice.TextMatrix(lngFirstRow, COL_ø™ º ±º‰)
    vsAdvice.Cell(flexcpData, lngRow, COL_ø™ º ±º‰) = vsAdvice.Cell(flexcpData, lngFirstRow, COL_ø™ º ±º‰)
    
    vsAdvice.TextMatrix(lngRow, COL_∆µ¬ ) = vsAdvice.TextMatrix(lngFirstRow, COL_∆µ¬ )
    vsAdvice.TextMatrix(lngRow, COL_∆µ¬ ¥Œ ˝) = vsAdvice.TextMatrix(lngFirstRow, COL_∆µ¬ ¥Œ ˝)
    vsAdvice.TextMatrix(lngRow, COL_∆µ¬ º‰∏Ù) = vsAdvice.TextMatrix(lngFirstRow, COL_∆µ¬ º‰∏Ù)
    vsAdvice.TextMatrix(lngRow, COL_º‰∏Ùµ•Œª) = vsAdvice.TextMatrix(lngFirstRow, COL_º‰∏Ùµ•Œª)
    vsAdvice.TextMatrix(lngRow, COL_÷¥–– ±º‰) = vsAdvice.TextMatrix(lngFirstRow, COL_÷¥–– ±º‰)
    
    '÷¥–––‘÷ :»± °∏˘æ›œÓƒø…Ë÷√(≤ªø…ƒ‹Œ™‘∫Õ‚÷¥––),–ﬁ∏ƒ ±∏˘æ›µ±«∞ΩÁ√Ê…Ë÷√
    If rsCurr Is Nothing Then
        vsAdvice.TextMatrix(lngRow, COL_÷¥–––‘÷ ) = Nvl(rsºÂ∑®!÷¥––ø∆ “, 0)
    Else
        vsAdvice.TextMatrix(lngRow, COL_÷¥–––‘÷ ) = Decode(Nvl(rsCurr!÷¥–––‘÷ ), "¿Î‘∫¥¯“©", 5, Nvl(rsºÂ∑®!÷¥––ø∆ “, 0))
    End If
    
    '÷–“©ºÂ∑®»Áπ˚Œ¥…Ë÷√÷¥––ø∆ “,‘Ú»± °Œ™≤°»ÀÀ˘‘⁄≤°«¯(√≈’Ô“™∏ƒŒ™≤°»ÀÀ˘‘⁄ø∆ “!!)
    If InStr(",0,5,", Val(vsAdvice.TextMatrix(lngRow, COL_÷¥–––‘÷ ))) = 0 Then
        vsAdvice.TextMatrix(lngRow, COL_÷¥––ø∆ “ID) = Get’Ô¡∆÷¥––ø∆ “ID(mlng≤°»ÀID, 0, rsºÂ∑®!¿‡±, lngºÂ∑®ID, 0, _
            Nvl(rsºÂ∑®!÷¥––ø∆ “, 0), mlng≤°»Àø∆ “id, Val(vsAdvice.TextMatrix(lngFirstRow, COL_ø™÷ˆø∆ “ID)), 1, 1)
    End If
    
    vsAdvice.TextMatrix(lngRow, COL_º∆º€–‘÷ ) = Nvl(rsºÂ∑®!º∆º€–‘÷ , 0)
    vsAdvice.TextMatrix(lngRow, COL_ø™÷ˆø∆ “ID) = vsAdvice.TextMatrix(lngFirstRow, COL_ø™÷ˆø∆ “ID)
    vsAdvice.TextMatrix(lngRow, COL_ø™÷ˆ“Ω…˙) = vsAdvice.TextMatrix(lngFirstRow, COL_ø™÷ˆ“Ω…˙)
    
    vsAdvice.TextMatrix(lngRow, COL_ø™÷ˆ ±º‰) = vsAdvice.TextMatrix(lngFirstRow, COL_ø™÷ˆ ±º‰)
    vsAdvice.Cell(flexcpData, lngRow, COL_ø™÷ˆ ±º‰) = vsAdvice.Cell(flexcpData, lngFirstRow, COL_ø™÷ˆ ±º‰)
    
    vsAdvice.TextMatrix(lngRow, COL_±Í÷æ) = vsAdvice.TextMatrix(lngFirstRow, COL_±Í÷æ)
    
    '±£≥÷µ±«∞ ‰»Î––Œª÷√
    lngRow = lngRow + 1
    
    '…Ë÷√÷–“©≈‰∑Ω”√∑®––:÷–“©≈‰∑Ωµƒœ‘ æ––
    '--------------------------------------------------------------------------------------
    '--------------------------------------------------------------------------------------
    vsAdvice.RowData(lngRow) = lngœ‡πÿID
    If Get’Ô¡∆œÓƒøº«¬º(lng’Ô¡∆œÓƒøID)!¿‡± & "" = "8" Then
        vsAdvice.TextMatrix(lngRow, COL_≈‰∑ΩID) = lng’Ô¡∆œÓƒøID
    End If
    If lng≈‰∑ΩID <> 0 Then
        vsAdvice.TextMatrix(lngRow, COL_≈‰∑ΩID) = lng≈‰∑ΩID
    End If
    
    If Not rsCurr Is Nothing Then
        '–ﬁ∏ƒ¡À≈‰∑Ωƒ⁄»›,±Íº«Œ™–ﬁ∏ƒ
        If InStr(",0,3,", rsCurr!Edit) > 0 Then
            vsAdvice.TextMatrix(lngRow, COL_EDIT) = 2 '±Íº«Œ™±ª–ﬁ∏ƒ
        Else
            vsAdvice.TextMatrix(lngRow, COL_EDIT) = rsCurr!Edit '±æ¿¥æÕ «–¬‘ˆªÚ–ﬁ∏ƒ
        End If
    Else
        '–¬ ‰»Îµƒ÷–“©≈‰∑Ω,Œ™–¬‘ˆ
        vsAdvice.TextMatrix(lngRow, COL_EDIT) = 1
    End If
    
    vsAdvice.TextMatrix(lngRow, COL_”§∂˘) = cbo”§∂˘.ListIndex
    vsAdvice.TextMatrix(lngRow, COL_◊¥Ã¨) = 1 '–¬ø™
    vsAdvice.TextMatrix(lngRow, COL_–Ú∫≈) = GetCurRow–Ú∫≈(lngRow)
    Call AdviceSet“Ω÷ˆ–Ú∫≈(lngRow + 1, 1) 'µ˜’˚–Ú∫≈
    vsAdvice.TextMatrix(lngRow, COL_¿‡±) = rs”√∑®!¿‡±
    vsAdvice.TextMatrix(lngRow, COL_’Ô¡∆œÓƒøID) = lng”√∑®ID
    vsAdvice.Cell(flexcpData, lngRow, COL_“Ω…˙÷ˆÕ–) = gclsInsure.GetItemInfo(mintœ’¿‡, mlng≤°»ÀID, 0, "", 0, "", vsAdvice.TextMatrix(lngRow, COL_’Ô¡∆œÓƒøID))
    
    vsAdvice.TextMatrix(lngRow, COL_º∆À„∑Ω Ω) = Nvl(rs”√∑®!º∆À„∑Ω Ω, 0)
    vsAdvice.TextMatrix(lngRow, COL_∆µ¬ –‘÷ ) = Nvl(rs”√∑®!÷¥––∆µ¬ , 0)
    vsAdvice.TextMatrix(lngRow, COL_≤Ÿ◊˜¿‡–Õ) = Nvl(rs”√∑®!≤Ÿ◊˜¿‡–Õ)
    vsAdvice.TextMatrix(lngRow, COL_µ•∂¿”¶”√) = Nvl(rs”√∑®!µ•∂¿”¶”√)
    vsAdvice.TextMatrix(lngRow, COL_÷¥––∑÷¿‡) = Nvl(rs”√∑®!÷¥––∑÷¿‡, 0)
    
    '!÷–“©”√∑®÷–“≤¥Ê∑≈÷–“©µƒ∏∂ ˝
    vsAdvice.TextMatrix(lngRow, COL_◊‹¡ø) = vsAdvice.TextMatrix(lngFirstRow, COL_◊‹¡ø)
    vsAdvice.TextMatrix(lngRow, COL_◊‹¡øµ•Œª) = "∏∂"
    
    vsAdvice.TextMatrix(lngRow, COL_ø™ º ±º‰) = vsAdvice.TextMatrix(lngFirstRow, COL_ø™ º ±º‰)
    vsAdvice.Cell(flexcpData, lngRow, COL_ø™ º ±º‰) = vsAdvice.Cell(flexcpData, lngFirstRow, COL_ø™ º ±º‰)
    
    vsAdvice.TextMatrix(lngRow, COL_√˚≥∆) = rs”√∑®!√˚≥∆
    vsAdvice.TextMatrix(lngRow, COL_”√∑®) = rs”√∑®!√˚≥∆
    vsAdvice.TextMatrix(lngRow, COL_∆µ¬ ) = vsAdvice.TextMatrix(lngFirstRow, COL_∆µ¬ )
    vsAdvice.TextMatrix(lngRow, COL_∆µ¬ ¥Œ ˝) = vsAdvice.TextMatrix(lngFirstRow, COL_∆µ¬ ¥Œ ˝)
    vsAdvice.TextMatrix(lngRow, COL_∆µ¬ º‰∏Ù) = vsAdvice.TextMatrix(lngFirstRow, COL_∆µ¬ º‰∏Ù)
    vsAdvice.TextMatrix(lngRow, COL_º‰∏Ùµ•Œª) = vsAdvice.TextMatrix(lngFirstRow, COL_º‰∏Ùµ•Œª)
    vsAdvice.TextMatrix(lngRow, COL_÷¥–– ±º‰) = vsAdvice.TextMatrix(lngFirstRow, COL_÷¥–– ±º‰)
    
    '÷¥–––‘÷ :»± °∏˘æ›œÓƒø…Ë÷√(≤ªø…ƒ‹Œ™‘∫Õ‚÷¥––),–ﬁ∏ƒ ±∏˘æ›µ±«∞ΩÁ√Ê…Ë÷√
    If rsCurr Is Nothing Then
        vsAdvice.TextMatrix(lngRow, COL_÷¥–––‘÷ ) = Nvl(rs”√∑®!÷¥––ø∆ “, 0)
    Else
        vsAdvice.TextMatrix(lngRow, COL_÷¥–––‘÷ ) = Decode(Nvl(rsCurr!÷¥–––‘÷ ), "¿Î‘∫¥¯“©", 5, Nvl(rs”√∑®!÷¥––ø∆ “, 0))
    End If
    
    '÷–“©”√∑®»Áπ˚Œ¥…Ë÷√÷¥––ø∆ “,‘Ú»± °Œ™≤°»ÀÀ˘‘⁄≤°«¯(√≈’Ô“™∏ƒŒ™≤°»ÀÀ˘‘⁄ø∆ “!!)
    If InStr(",0,5,", Val(vsAdvice.TextMatrix(lngRow, COL_÷¥–––‘÷ ))) = 0 Then
        vsAdvice.TextMatrix(lngRow, COL_÷¥––ø∆ “ID) = Get’Ô¡∆÷¥––ø∆ “ID(mlng≤°»ÀID, 0, rs”√∑®!¿‡±, lng”√∑®ID, 0, _
            Nvl(rs”√∑®!÷¥––ø∆ “, 0), mlng≤°»Àø∆ “id, Val(vsAdvice.TextMatrix(lngFirstRow, COL_ø™÷ˆø∆ “ID)), 1, 1)
    End If
    
    vsAdvice.TextMatrix(lngRow, COL_º∆º€–‘÷ ) = Nvl(rs”√∑®!º∆º€–‘÷ , 0)
    vsAdvice.TextMatrix(lngRow, COL_ø™÷ˆø∆ “ID) = vsAdvice.TextMatrix(lngFirstRow, COL_ø™÷ˆø∆ “ID)
    vsAdvice.TextMatrix(lngRow, COL_ø™÷ˆ“Ω…˙) = vsAdvice.TextMatrix(lngFirstRow, COL_ø™÷ˆ“Ω…˙)
    
    vsAdvice.TextMatrix(lngRow, COL_ø™÷ˆ ±º‰) = vsAdvice.TextMatrix(lngFirstRow, COL_ø™÷ˆ ±º‰)
    vsAdvice.Cell(flexcpData, lngRow, COL_ø™÷ˆ ±º‰) = vsAdvice.Cell(flexcpData, lngFirstRow, COL_ø™÷ˆ ±º‰)
    
    vsAdvice.TextMatrix(lngRow, COL_±Í÷æ) = vsAdvice.TextMatrix(lngFirstRow, COL_±Í÷æ)
    Call SetRow±Í÷æÕº±Í(lngRow)
        
    If Not rsCurr Is Nothing Then
        vsAdvice.TextMatrix(lngRow, COL_“Ω…˙÷ˆÕ–) = Nvl(rsCurr!“Ω…˙÷ˆÕ–)
    ElseIf Not rsUse.EOF Then
        vsAdvice.TextMatrix(lngRow, COL_“Ω…˙÷ˆÕ–) = Nvl(rsUse!“Ω…˙÷ˆÕ–)
    End If
    '÷–“©–ŒÃ¨(”√”⁄AdviceTextMake÷–)
    vsAdvice.TextMatrix(lngRow, COL_÷–“©–ŒÃ¨) = lng–ŒÃ¨
    '¥¶∑Ωœﬁ¡øºÏ≤È
    Call CheckCHLimited(lngRow, vsAdvice.TextMatrix(lngRow, COL_◊‹¡ø), blnOutOfRange, vsAdvice, COL_œ‡πÿID, COL_’Ô¡∆œÓƒøID, COL_¿‡±, COL_µ•¡ø)
    If blnOutOfRange Then vsAdvice.TextMatrix(lngRow, COL_ «∑Ò≥¨¡ø) = "1"
    '÷–“©≈‰∑Ωµƒ÷–“©ø‚¥Ê
    Call GetDrugStock(lngRow)
    
    '÷–“©≈‰∑Ω“Ω÷ˆƒ⁄»›
    vsAdvice.TextMatrix(lngRow, col_“Ω÷ˆƒ⁄»›) = AdviceTextMake(lngRow)
    
    '-------------------
    vsAdvice.Row = lngRow
    mblnRowChange = True
    
    If str∏ﬂŒ£“©∆∑ <> "" Then
        MsgBox "“‘œ¬“Ω÷ˆ «∏ﬂŒ£“©∆∑£∫" & str∏ﬂŒ£“©∆∑, vbInformation, gstrSysName
    End If
        
    AdviceSet÷–“©≈‰∑Ω = lngRow
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Function AdviceSetºÏ—È◊È∫œ(ByVal lngRow As Long, ByVal lng≤…ºØ∑Ω∑®ID As Long, ByVal strExtData As String, Optional rsCurr As ADODB.Recordset, Optional ByVal str’™“™ As String, Optional ByVal bln…Í«Îµ• As Boolean) As Long
'π¶ƒ‹£∫¥¶¿Ì–¬‘ˆµƒºÏ—È(◊È∫œ)
'≤Œ ˝£∫rsItems= ‰»ÎªÚ—°‘Ò∑µªÿµƒº«¬ººØ
'      lngRow=µ±«∞ ‰»Î––
'      lng≤…ºØ∑Ω∑®ID=»± °µƒ≤…ºØ∑Ω∑®
'      strExtData=ºÏ≤È:"œÓƒøID1,œÓƒøID2,...;ºÏ—È±Í±æ"»Áπ˚ «–¬∞ÊLISµƒƒ£ Ω‘Ú «£∫"œÓƒøID1|÷∏±Í1|÷∏±Í2...,œÓƒøID2|÷∏±Í1|÷∏±Í2...,...;ºÏ—È±Í±æ"
'      rsCurr=–ﬁ∏ƒºÏ—ÈœÓƒø ±”√
'      str’™“™=“Ω±£’™“™
'      bln…Í«Îµ• …Í«Îµ•±£¥Ê∫Ûµ˜”√
'∑µªÿ£∫¥¶¿Ì÷Æ∫Ûµƒµ±«∞œ‘ æ––∫≈
    Dim rsMore As New ADODB.Recordset '≤…ºØ∑Ω∑®–≈œ¢
    Dim rsItems As New ADODB.Recordset 'ºÏ—ÈœÓƒø–≈œ¢
    Dim arrItems As Variant, strItems As String
    Dim strSQL As String, curDate As Date
    Dim str“Ω…˙ As String, lng“Ω…˙ID As Long
    Dim str∆µ¬  As String, int∆µ¬ ¥Œ ˝ As Integer
    Dim int∆µ¬ º‰∏Ù As Integer, strº‰∏Ùµ•Œª As String
    Dim lngœ‡πÿID As Long, str“Ω÷ˆƒ⁄»› As String
    Dim lngCopyRow As Long, lngFirstRow As Long, i As Long
    Dim rsLIS As New ADODB.Recordset
    Dim strTmp As String
    Dim Y As Long
    Dim blnLis As Boolean
    
    On Error GoTo errH
    
    '»°…œ“ªªÚœ¬“ª”––ß––,ƒ≥–©ƒ⁄»›»± °”Î∏√––œ‡Õ¨
    lngCopyRow = GetPreRow(lngRow)
    If lngCopyRow = -1 Then lngCopyRow = GetNextRow(lngRow)
    'µ±«∞ ±º‰
    curDate = zlDatabase.Currentdate
    
    'ºÏ—ÈœÓƒø–≈œ¢
    '----------------------------------------------------------------------------
    '∏˜∏ˆºÏ—ÈœÓƒø–≈œ¢:∞¥ ‰»ÎÀ≥–Ú
    arrItems = Split(Split(strExtData, ";")(0), ",")
    For i = UBound(arrItems) To 0 Step -1
        If mblnNewLIS Then
            strTmp = arrItems(i)
            If InStr(strTmp, "|") > 0 Then
                For Y = 0 To UBound(Split(strTmp, "|"))
                    strItems = strItems & "," & Val(Split(strTmp, "|")(Y))
                    If Y > 0 Then
                        strSQL = strSQL & " Union All " & " Select '" & Val(Split(strTmp, "|")(Y)) & "' as ◊”œÓ,'" & Val(Split(strTmp, "|")(0)) & "' as ∏∏œÓ From Dual "
                    End If
                Next
            Else
                strItems = strItems & "," & Val(strTmp)
            End If
        Else
            strItems = strItems & "," & Val(arrItems(i))
        End If
    Next
    If strSQL <> "" Then
        Set rsLIS = zlDatabase.OpenSQLRecord(Mid(strSQL, 11), Me.Caption)
        blnLis = True
    End If
    Set rsItems = Get’Ô¡∆œÓƒøº«¬º(0, Mid(strItems, 2))
    
        If Not bln…Í«Îµ• Then
    '»°ƒ≥∏ˆºÏ—ÈœÓƒøµƒ≤…ºØ∑Ω∑®
    strSQL = "Select /*+ RULE */ A.œÓƒøID,Nvl(A.–‘÷ ,0) as –Ú∫≈,A.”√∑®ID" & _
        " From ’Ô¡∆”√∑®”√¡ø A,’Ô¡∆œÓƒøƒø¬º B" & _
        " Where A.”√∑®ID=B.ID And B.∑˛ŒÒ∂‘œÛ IN(1,3)" & _
        " And A.œÓƒøID IN(Select Column_Value From Table(f_Num2list([1])))" & _
        " And (B.’æµ„='" & gstrNodeNo & "' Or B.’æµ„ is Null)" & _
        " And (b.≥∑µµ ±º‰=To_Date('3000-01-01','YYYY-MM-DD') Or b.≥∑µµ ±º‰ is NULL)" & _
        " Order by A.œÓƒøID,Nvl(A.–‘÷ ,0)"
    Set rsMore = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Mid(strItems, 2))
    If Not rsMore.EOF Then
        If rsCurr Is Nothing Or lng≤…ºØ∑Ω∑®ID = 0 Then
            lng≤…ºØ∑Ω∑®ID = rsMore!”√∑®ID '–ﬁ∏ƒ ±≤ª±‰
        End If
    End If
        End If

    Set rsMore = Get’Ô¡∆œÓƒøº«¬º(lng≤…ºØ∑Ω∑®ID)
    
    mblnRowChange = False
    
    '…Ë÷√∏˜––ºÏ—ÈœÓƒø
    '----------------------------------------------------------------------------
    '≤…ºØ∑Ω∑®“Ω÷ˆID,IDÀ≥–Ú”Î–Ú∫≈≤ª“ª∂®“ª÷¬
    If Not rsCurr Is Nothing Then
        '–ﬁ∏ƒ¡ÀºÏ—È◊È∫œ÷–µƒƒ⁄»›,≤…ºØ∑Ω∑®––±Íº«Œ™–ﬁ∏ƒ,“Ω÷ˆID≤ª±‰
        lngœ‡πÿID = rsCurr!“Ω÷ˆID
    Else
        '–¬ ‰»Îµƒ
        lngœ‡πÿID = GetNext“Ω÷ˆID
    End If
    With vsAdvice
        For i = 1 To rsItems.RecordCount
            .AddItem "", lngRow
            
            .RowHidden(lngRow) = True
            .RowData(lngRow) = GetNext“Ω÷ˆID
            .TextMatrix(lngRow, COL_œ‡πÿID) = lngœ‡πÿID '∂‘”¶µΩ≤…ºØ∑Ω∑®––
            .TextMatrix(lngRow, COL_EDIT) = 1 '–¬‘ˆ
            .TextMatrix(lngRow, COL_”§∂˘) = cbo”§∂˘.ListIndex
            .TextMatrix(lngRow, COL_◊¥Ã¨) = 1 '–¬ø™
            
            .TextMatrix(lngRow, COL_–Ú∫≈) = GetCurRow–Ú∫≈(lngRow)
            Call AdviceSet“Ω÷ˆ–Ú∫≈(lngRow + 1, 1) 'µ˜’˚–Ú∫≈
            
            .TextMatrix(lngRow, COL_¿‡±) = rsItems!¿‡±
            .TextMatrix(lngRow, col_“Ω÷ˆƒ⁄»›) = rsItems!√˚≥∆
            .TextMatrix(lngRow, COL_’Ô¡∆œÓƒøID) = rsItems!ID
            .TextMatrix(lngRow, COL_º∆À„∑Ω Ω) = Nvl(rsItems!º∆À„∑Ω Ω, 0)
            .TextMatrix(lngRow, COL_∆µ¬ –‘÷ ) = Nvl(rsItems!÷¥––∆µ¬ , 0)
            .TextMatrix(lngRow, COL_≤Ÿ◊˜¿‡–Õ) = Nvl(rsItems!≤Ÿ◊˜¿‡–Õ)
            .TextMatrix(lngRow, COL_µ•∂¿”¶”√) = Nvl(rsItems!µ•∂¿”¶”√)
            .TextMatrix(lngRow, COL_÷¥––∑÷¿‡) = Nvl(rsItems!÷¥––∑÷¿‡, 0)
            .TextMatrix(lngRow, COL_¥¶∑Ωœﬁ¡ø) = Nvl(rsItems!¬º»Îœﬁ¡ø)
            .TextMatrix(lngRow, COL_º∆º€–‘÷ ) = Nvl(rsItems!º∆º€–‘÷ , 0)
            .TextMatrix(lngRow, COL_÷¥–––‘÷ ) = Nvl(rsItems!÷¥––ø∆ “, 0)
            'ºÏ—È±Í±æ
            .TextMatrix(lngRow, COL_±Í±æ≤øŒª) = Split(strExtData, ";")(1)
            If mblnNewLIS And rsItems!ID & "" <> "" And blnLis Then
                rsLIS.Filter = "◊”œÓ=" & rsItems!ID
                If rsLIS.EOF = False Then
                    .TextMatrix(lngRow, COL_◊È∫œœÓƒøID) = rsLIS!∏∏œÓ & ""
                End If
            End If
            
            .Cell(flexcpData, lngRow, COL_“Ω…˙÷ˆÕ–) = str’™“™
            
            '≤ø∑›ƒ⁄»›“ª≤¢≤…ºØµƒºÏ—ÈœÓƒøœ‡Õ¨
            If lngFirstRow <> 0 Then
                .TextMatrix(lngRow, COL_◊‹¡ø) = .TextMatrix(lngFirstRow, COL_◊‹¡ø)
                
                '“ª≤¢≤…ºØµƒºÏ—ÈœÓƒø”¶∏√œ‡Õ¨
                If InStr(",0,5,", Val(.TextMatrix(lngRow, COL_÷¥–––‘÷ ))) = 0 Then
                    .TextMatrix(lngRow, COL_÷¥––ø∆ “ID) = .TextMatrix(lngFirstRow, COL_÷¥––ø∆ “ID)
                End If
                .TextMatrix(lngRow, COL_∆µ¬ ) = .TextMatrix(lngFirstRow, COL_∆µ¬ )
                .TextMatrix(lngRow, COL_∆µ¬ ¥Œ ˝) = .TextMatrix(lngFirstRow, COL_∆µ¬ ¥Œ ˝)
                .TextMatrix(lngRow, COL_∆µ¬ º‰∏Ù) = .TextMatrix(lngFirstRow, COL_∆µ¬ º‰∏Ù)
                .TextMatrix(lngRow, COL_º‰∏Ùµ•Œª) = .TextMatrix(lngFirstRow, COL_º‰∏Ùµ•Œª)
                .TextMatrix(lngRow, COL_÷¥–– ±º‰) = .TextMatrix(lngFirstRow, COL_÷¥–– ±º‰)
                
                .TextMatrix(lngRow, COL_ø™ º ±º‰) = .TextMatrix(lngFirstRow, COL_ø™ º ±º‰)
                .Cell(flexcpData, lngRow, COL_ø™ º ±º‰) = .Cell(flexcpData, lngFirstRow, COL_ø™ º ±º‰)
                
                .TextMatrix(lngRow, COL_ø™÷ˆ“Ω…˙) = .TextMatrix(lngFirstRow, COL_ø™÷ˆ“Ω…˙)
                .TextMatrix(lngRow, COL_ø™÷ˆø∆ “ID) = .TextMatrix(lngFirstRow, COL_ø™÷ˆø∆ “ID)
                
                .TextMatrix(lngRow, COL_ø™÷ˆ ±º‰) = .TextMatrix(lngFirstRow, COL_ø™÷ˆ ±º‰)
                .Cell(flexcpData, lngRow, COL_ø™÷ˆ ±º‰) = .Cell(flexcpData, lngFirstRow, COL_ø™÷ˆ ±º‰)
                
                .TextMatrix(lngRow, COL_±Í÷æ) = .TextMatrix(lngFirstRow, COL_±Í÷æ)
            ElseIf Not rsCurr Is Nothing Then
                .TextMatrix(lngRow, COL_◊‹¡ø) = Nvl(rsCurr!◊‹¡ø, 1)
                
                '÷¥––ø∆ “:÷¥–––‘÷ Œ™(0-∂£÷ˆ,5-‘∫Õ‚÷¥––)Œﬁ÷¥––ø∆ “
                If InStr(",0,5,", Val(.TextMatrix(lngRow, COL_÷¥–––‘÷ ))) = 0 Then
                    If Nvl(rsCurr!÷¥––ø∆ “ID, 0) <> 0 Then
                        .TextMatrix(lngRow, COL_÷¥––ø∆ “ID) = rsCurr!÷¥––ø∆ “ID
                    Else
                        .TextMatrix(lngRow, COL_÷¥––ø∆ “ID) = Get’Ô¡∆÷¥––ø∆ “ID(mlng≤°»ÀID, 0, rsItems!¿‡±, rsItems!ID, 0, _
                            Nvl(rsItems!÷¥––ø∆ “, 0), mlng≤°»Àø∆ “id, Nvl(rsCurr!ø™÷ˆø∆ “id, 0), 1, 1)
                    End If
                End If
                
                '÷¥––∆µ¬ 
                .TextMatrix(lngRow, COL_∆µ¬ ) = Nvl(rsCurr!∆µ¬ )
                .TextMatrix(lngRow, COL_∆µ¬ ¥Œ ˝) = Nvl(rsCurr!∆µ¬ ¥Œ ˝)
                .TextMatrix(lngRow, COL_∆µ¬ º‰∏Ù) = Nvl(rsCurr!∆µ¬ º‰∏Ù)
                .TextMatrix(lngRow, COL_º‰∏Ùµ•Œª) = Nvl(rsCurr!º‰∏Ùµ•Œª)
                .TextMatrix(lngRow, COL_÷¥–– ±º‰) = Nvl(rsCurr!÷¥–– ±º‰)
                
                ' ±º‰/ø∆ “/“Ω…˙
                .TextMatrix(lngRow, COL_ø™ º ±º‰) = Format(Nvl(rsCurr!ø™ º ±º‰), "yyyy-MM-dd HH:mm")
                .Cell(flexcpData, lngRow, COL_ø™ º ±º‰) = CStr(Nvl(rsCurr!ø™ º ±º‰))
                
                .TextMatrix(lngRow, COL_ø™÷ˆ ±º‰) = Format(Nvl(rsCurr!ø™÷ˆ ±º‰), "yyyy-MM-dd HH:mm")
                .Cell(flexcpData, lngRow, COL_ø™÷ˆ ±º‰) = CStr(Nvl(rsCurr!ø™÷ˆ ±º‰))
                
                .TextMatrix(lngRow, COL_ø™÷ˆ“Ω…˙) = Nvl(rsCurr!ø™÷ˆ“Ω…˙)
                .TextMatrix(lngRow, COL_ø™÷ˆø∆ “ID) = Nvl(rsCurr!ø™÷ˆø∆ “id)
                
                .TextMatrix(lngRow, COL_±Í÷æ) = Nvl(rsCurr!±Í÷æ)
            Else
                .TextMatrix(lngRow, COL_◊‹¡ø) = 1 '»± °Œ™1(¥Œ)
                
                'ø™÷ˆ“Ω…˙
                .TextMatrix(lngRow, COL_ø™÷ˆ“Ω…˙) = UserInfo.–’√˚
                .TextMatrix(lngRow, COL_ø™÷ˆø∆ “ID) = Getø™÷ˆø∆ “ID(UserInfo.ID, mlng“Ωººø∆ “ID, mlng≤°»Àø∆ “id, 1)
                
                '÷¥––ø∆ “:÷¥–––‘÷ Œ™(0-∂£÷ˆ,5-‘∫Õ‚÷¥––)Œﬁ÷¥––ø∆ “
                If InStr(",0,5,", Val(.TextMatrix(lngRow, COL_÷¥–––‘÷ ))) = 0 Then
                    '÷Æ«∞“™«Û≥ˆø™÷ˆø∆ “ID
                    .TextMatrix(lngRow, COL_÷¥––ø∆ “ID) = Get’Ô¡∆÷¥––ø∆ “ID(mlng≤°»ÀID, 0, rsItems!¿‡±, rsItems!ID, 0, _
                        Nvl(rsItems!÷¥––ø∆ “, 0), mlng≤°»Àø∆ “id, Val(.TextMatrix(lngRow, COL_ø™÷ˆø∆ “ID)), 1, 1)
                End If
                
                '÷¥––∆µ¬ 
                Call Get»± °∆µ¬ (Nvl(rsItems!ID, 0), Get∆µ¬ ∑∂Œß(lngRow), str∆µ¬ , int∆µ¬ ¥Œ ˝, int∆µ¬ º‰∏Ù, strº‰∏Ùµ•Œª)
                .TextMatrix(lngRow, COL_∆µ¬ ) = str∆µ¬ 
                .TextMatrix(lngRow, COL_∆µ¬ ¥Œ ˝) = int∆µ¬ ¥Œ ˝
                .TextMatrix(lngRow, COL_∆µ¬ º‰∏Ù) = int∆µ¬ º‰∏Ù
                .TextMatrix(lngRow, COL_º‰∏Ùµ•Œª) = strº‰∏Ùµ•Œª
                
                '÷¥–– ±º‰:"ø…—°∆µ¬ "(“©∆∑ «ø…—°∆µ¬ ,µ´ø…ƒ‹…Ë÷√Œ™“ª¥Œ–‘)
                If Val(.TextMatrix(lngRow, COL_∆µ¬ –‘÷ )) = 0 Then
                    If lngCopyRow <> -1 Then '”Î…œ“ª––œ‡Õ¨
                        If .TextMatrix(lngRow, COL_∆µ¬ ) = .TextMatrix(lngCopyRow, COL_∆µ¬ ) Then
                            .TextMatrix(lngRow, COL_÷¥–– ±º‰) = .TextMatrix(lngCopyRow, COL_÷¥–– ±º‰)
                        End If
                    End If
                    If .TextMatrix(lngRow, COL_÷¥–– ±º‰) = "" Then  '»± ° ±º‰∑Ω∞∏
                        .TextMatrix(lngRow, COL_÷¥–– ±º‰) = Get»± ° ±º‰(1, .TextMatrix(lngRow, COL_∆µ¬ ))
                    End If
                End If
            
                'ø™ º ±º‰
                If IsDate(txtø™ º ±º‰.Text) Then
                    .TextMatrix(lngRow, COL_ø™ º ±º‰) = Format(txtø™ º ±º‰.Text, "yyyy-MM-dd HH:mm")
                    .Cell(flexcpData, lngRow, COL_ø™ º ±º‰) = txtø™ º ±º‰.Text
                End If
                
                'ø™÷ˆ ±º‰
                .TextMatrix(lngRow, COL_ø™÷ˆ ±º‰) = Format(curDate, "yyyy-MM-dd HH:mm")
                .Cell(flexcpData, lngRow, COL_ø™÷ˆ ±º‰) = Format(curDate, "yyyy-MM-dd HH:mm")
                
                'ΩÙº±±Í÷æ
                .TextMatrix(lngRow, COL_±Í÷æ) = chkΩÙº±.value
            End If
            
            str“Ω÷ˆƒ⁄»› = str“Ω÷ˆƒ⁄»› & "," & rsItems!√˚≥∆ '“Ω÷ˆƒ⁄»›
            If lngFirstRow = 0 Then lngFirstRow = lngRow 'µ⁄“ªœÓƒø––
            lngRow = lngRow + 1 '±£≥÷µ±«∞ ‰»Î––Œª÷√
            
            rsItems.MoveNext
        Next
        
        '…Ë÷√±Í±æµƒ≤…ºØ∑Ω∑®
        '----------------------------------------------------------------------------
        rsItems.MoveFirst
        .RowData(lngRow) = lngœ‡πÿID
        
        If Not rsCurr Is Nothing Then
            '–ﬁ∏ƒ¡ÀºÏ—È◊È∫œƒ⁄»›,±Íº«Œ™–ﬁ∏ƒ
            If InStr(",0,3,", rsCurr!Edit) > 0 Then
                vsAdvice.TextMatrix(lngRow, COL_EDIT) = 2 '±Íº«Œ™±ª–ﬁ∏ƒ
            Else
                vsAdvice.TextMatrix(lngRow, COL_EDIT) = rsCurr!Edit '±æ¿¥æÕ «–¬‘ˆªÚ–ﬁ∏ƒ
            End If
        Else
            '–¬ ‰»ÎµƒºÏ—È◊È∫œ,Œ™–¬‘ˆ
            vsAdvice.TextMatrix(lngRow, COL_EDIT) = 1
        End If
        
        .TextMatrix(lngRow, COL_”§∂˘) = cbo”§∂˘.ListIndex
        .TextMatrix(lngRow, COL_◊¥Ã¨) = 1 '–¬ø™
        
        .TextMatrix(lngRow, COL_–Ú∫≈) = GetCurRow–Ú∫≈(lngRow)
        Call AdviceSet“Ω÷ˆ–Ú∫≈(lngRow + 1, 1) 'µ˜’˚–Ú∫≈
        
        .TextMatrix(lngRow, COL_¿‡±) = rsMore!¿‡±
        .TextMatrix(lngRow, COL_√˚≥∆) = rsMore!√˚≥∆
        .TextMatrix(lngRow, COL_”√∑®) = rsMore!√˚≥∆
        .TextMatrix(lngRow, COL_’Ô¡∆œÓƒøID) = rsMore!ID
        .TextMatrix(lngRow, COL_º∆À„∑Ω Ω) = Nvl(rsMore!º∆À„∑Ω Ω, 0)
        .TextMatrix(lngRow, COL_∆µ¬ –‘÷ ) = Nvl(rsMore!÷¥––∆µ¬ , 0)
        .TextMatrix(lngRow, COL_≤Ÿ◊˜¿‡–Õ) = Nvl(rsMore!≤Ÿ◊˜¿‡–Õ)
        .TextMatrix(lngRow, COL_µ•∂¿”¶”√) = Nvl(rsMore!µ•∂¿”¶”√)
        .TextMatrix(lngRow, COL_÷¥––∑÷¿‡) = Nvl(rsMore!÷¥––∑÷¿‡, 0)
        .TextMatrix(lngRow, COL_º∆º€–‘÷ ) = Nvl(rsMore!º∆º€–‘÷ , 0)
        .TextMatrix(lngRow, COL_±Í±æ≤øŒª) = .TextMatrix(lngFirstRow, COL_±Í±æ≤øŒª)
        
        '◊‹¡øŒ™ºÏ—ÈœÓƒøµƒ,”ÎºÏ—ÈœÓƒøœ‡Õ¨
        .TextMatrix(lngRow, COL_◊‹¡ø) = .TextMatrix(lngFirstRow, COL_◊‹¡ø)
        .TextMatrix(lngRow, COL_◊‹¡øµ•Œª) = Nvl(rsMore!º∆À„µ•Œª)
        
        '÷¥––∆µ¬ 
        .TextMatrix(lngRow, COL_∆µ¬ ) = .TextMatrix(lngFirstRow, COL_∆µ¬ )
        .TextMatrix(lngRow, COL_∆µ¬ ¥Œ ˝) = .TextMatrix(lngFirstRow, COL_∆µ¬ ¥Œ ˝)
        .TextMatrix(lngRow, COL_∆µ¬ º‰∏Ù) = .TextMatrix(lngFirstRow, COL_∆µ¬ º‰∏Ù)
        .TextMatrix(lngRow, COL_º‰∏Ùµ•Œª) = .TextMatrix(lngFirstRow, COL_º‰∏Ùµ•Œª)
        .TextMatrix(lngRow, COL_÷¥–– ±º‰) = .TextMatrix(lngFirstRow, COL_÷¥–– ±º‰)
        .TextMatrix(lngRow, COL_÷¥–––‘÷ ) = Nvl(rsMore!÷¥––ø∆ “, 0)
        
        '÷¥––ø∆ “:÷¥–––‘÷ Œ™(0-∂£÷ˆ,5-‘∫Õ‚÷¥––)Œﬁ÷¥––ø∆ “
        If InStr(",0,5,", Val(.TextMatrix(lngRow, COL_÷¥–––‘÷ ))) = 0 Then
            .TextMatrix(lngRow, COL_÷¥––ø∆ “ID) = Get’Ô¡∆÷¥––ø∆ “ID(mlng≤°»ÀID, 0, rsMore!¿‡±, rsMore!ID, 0, _
                Nvl(rsMore!÷¥––ø∆ “, 0), mlng≤°»Àø∆ “id, Val(.TextMatrix(lngFirstRow, COL_ø™÷ˆø∆ “ID)), 1, 1)
        End If
        
        ' ±º‰/ø∆ “/“Ω…˙
        .TextMatrix(lngRow, COL_ø™ º ±º‰) = .TextMatrix(lngFirstRow, COL_ø™ º ±º‰)
        .Cell(flexcpData, lngRow, COL_ø™ º ±º‰) = .Cell(flexcpData, lngFirstRow, COL_ø™ º ±º‰)
        .TextMatrix(lngRow, COL_ø™÷ˆ ±º‰) = .TextMatrix(lngFirstRow, COL_ø™÷ˆ ±º‰)
        .Cell(flexcpData, lngRow, COL_ø™÷ˆ ±º‰) = .Cell(flexcpData, lngFirstRow, COL_ø™÷ˆ ±º‰)
        .TextMatrix(lngRow, COL_ø™÷ˆø∆ “ID) = .TextMatrix(lngFirstRow, COL_ø™÷ˆø∆ “ID)
        .TextMatrix(lngRow, COL_ø™÷ˆ“Ω…˙) = .TextMatrix(lngFirstRow, COL_ø™÷ˆ“Ω…˙)
        
        'œ‘ æΩÙº±±Í÷æ
        .TextMatrix(lngRow, COL_±Í÷æ) = .TextMatrix(lngFirstRow, COL_±Í÷æ)
        Call SetRow±Í÷æÕº±Í(lngRow)
                
        If Not rsCurr Is Nothing Then
            .TextMatrix(lngRow, COL_“Ω…˙÷ˆÕ–) = Nvl(rsCurr!“Ω…˙÷ˆÕ–)
        End If
        .Cell(flexcpData, lngRow, COL_“Ω…˙÷ˆÕ–) = gclsInsure.GetItemInfo(mintœ’¿‡, mlng≤°»ÀID, 0, "", 0, "", .TextMatrix(lngRow, COL_’Ô¡∆œÓƒøID))
        
        '“Ω÷ˆƒ⁄»›:ºÏ—È1,ºÏ—È2(±Í±æ ≤…ºØ∑Ω∑®)
        .TextMatrix(lngRow, col_“Ω÷ˆƒ⁄»›) = AdviceTextMake(lngRow)
        
        .Row = lngRow
    End With
    mblnRowChange = True
    AdviceSetºÏ—È◊È∫œ = lngRow
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Sub AdviceSet’Ô¡∆œÓƒø(rsInput As ADODB.Recordset, ByVal lngRow As Long, ByVal lng∏¯“©Õææ∂ID As Long, ByVal lngGroupRow As Long, _
        ByVal strExtData As String, ByVal str’™“™ As String, Optional ByVal str ÷ ı≤øŒª As String, Optional ByVal bln±∏—™ As Boolean = True)
'π¶ƒ‹£∫¥¶¿Ì–¬‘ˆ(≤Â»Î)µƒ÷–°¢Œ˜≥…“©£¨ºÏ≤È(◊È∫œ)£¨ ÷ ı(◊È∫œ)£¨Œ¿≤ƒ£¨ ‰—™£¨º∞∆‰À¸’Ô¡∆œÓƒøµƒ»± °“Ω÷ˆ ˝æ›
'≤Œ ˝£∫rsInput= ‰»ÎªÚ—°‘Ò∑µªÿµƒº«¬ººØ
'      lngRow=µ±«∞ ‰»Î––
'      lng∏¯“©Õææ∂ID=»± °∏¯“©Õææ∂ID,ªÚ“ª≤¢∏¯“© ±µƒ∏¯“©Õææ∂ID
'      lngGroupRow=‘⁄“ª≤¢∏¯“©µƒ“ª◊È≥…“©÷–≤Â»Î–¬µƒ≥…“©–– ±,∂‘”¶“ª≤¢∏¯“©µƒ“ª––––∫≈
'      strExtData=ºÏ≤È:∞¸∫¨ºÏ≤È≤øŒª–≈œ¢, ÷ ı:∞¸∫¨∏Ωº” ÷ ıº∞¬È◊Ìµƒ–≈œ¢,ø…ƒ‹Œﬁ∏Ωº” ÷ ı
'      str’™“™=“Ω±£’™“™
'      str ÷ ı≤øŒª=…Í«Î∏ΩœÓ÷–µƒ ÷ ı≤øŒª
'      bln±∏—™ µ±«∞µƒ ‰—™“Ω÷ˆŒ™±∏—™“Ω÷ˆ£¨Ωˆ∂‘¿‡±Œ™Kµƒ’Ô¡∆œÓƒø
    Dim rsTmp As New ADODB.Recordset
    Dim rsMore As New ADODB.Recordset '’Ô¡∆œÓƒøœÍœ∏–≈œ¢
    Dim strSQL As String, lngCopyRow As Long
    Dim lngTmp As Long, i As Long
    Dim str“Ω…˙ As String, lng“Ω…˙ID As Long
    Dim str“©∑øIDs As String, sngÃÏ ˝ As Single
    Dim lng÷¥––ø∆ “ID As Long, vCurDate As Date
    
    Dim str∆µ¬  As String, int∆µ¬ ¥Œ ˝ As Integer, int∆µ¬ º‰∏Ù As Integer, strº‰∏Ùµ•Œª As String
    Dim bln«ø÷∆»± ° As Boolean, strƒ¨»œ“©∑ø As String

    On Error GoTo errH
    
    '»°…œ“ªªÚœ¬“ª”––ß––,ƒ≥–©ƒ⁄»›»± °”Î∏√––œ‡Õ¨
    lngCopyRow = GetPreRow(lngRow)
    If lngCopyRow = -1 Then lngCopyRow = GetNextRow(lngRow)
                
    With vsAdvice
        'ø™ º…Ë÷√“Ω÷ˆ»± °ƒ⁄»›
        .RowData(lngRow) = GetNext“Ω÷ˆID
        .TextMatrix(lngRow, COL_EDIT) = 1 '–¬‘ˆ
        .TextMatrix(lngRow, COL_”§∂˘) = cbo”§∂˘.ListIndex
        .TextMatrix(lngRow, COL_◊¥Ã¨) = 1 '–¬ø™
        
        '–Ú∫≈:±£≥÷¡¨–¯,µ±«∞––’º”√–¬–Ú∫≈∫Û,∫Û√Êµƒ–Ú∫≈œÚ∫Û“∆
        .TextMatrix(lngRow, COL_–Ú∫≈) = GetCurRow–Ú∫≈(lngRow)
        Call AdviceSet“Ω÷ˆ–Ú∫≈(lngRow + 1, 1)
        
        .TextMatrix(lngRow, COL_¿‡±) = rsInput!¿‡±ID
        .TextMatrix(lngRow, COL_√˚≥∆) = rsInput!√˚≥∆ '∏√√˚≥∆ø…ƒ‹ «±√˚
        .TextMatrix(lngRow, COL_’Ô¡∆œÓƒøID) = rsInput!’Ô¡∆œÓƒøID
        .TextMatrix(lngRow, COL_ ’∑—œ∏ƒøID) = Nvl(rsInput! ’∑—œ∏ƒøID)
        .Cell(flexcpData, lngRow, COL_“Ω…˙÷ˆÕ–) = str’™“™
        '“©∆∑°¢Œ¿≤ƒµƒπÊ∏Ò–≈œ¢
        If Not IsNull(rsInput! ’∑—œ∏ƒøID) Then
            If InStr(",5,6,", rsInput!¿‡±ID) > 0 Then
                strSQL = "Select Nvl(C.√˚≥∆,A.√˚≥∆) as √˚≥∆,b.ª˘±æ“©ŒÔ," & _
                    " B.º¡¡øœµ ˝,B.√≈’Ôµ•Œª,B.√≈’Ô∞¸◊∞,B.√≈’Ôø…∑Ò∑÷¡„ As ø…∑Ò∑÷¡„,b.∏ﬂŒ£“©∆∑" & _
                    " From  ’∑—œÓƒøƒø¬º A,“©∆∑πÊ∏Ò B, ’∑—œÓƒø±√˚ C" & _
                    " Where A.ID=B.“©∆∑ID And A.ID=[1]" & _
                    " And A.ID=C. ’∑—œ∏ƒøID(+) And C.¬Î¿‡(+)=1 And C.–‘÷ (+)=[2]"
                Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(rsInput! ’∑—œ∏ƒøID), IIF(gbyt“©∆∑√˚≥∆œ‘ æ = 0, 1, 3))
                .TextMatrix(lngRow, COL_√˚≥∆) = rsTmp!√˚≥∆ 'Ω´±√˚ªª≥…’˝ ΩπÊ∏Ò√˚≥∆
                .TextMatrix(lngRow, COL_º¡¡øœµ ˝) = rsTmp!º¡¡øœµ ˝
                .TextMatrix(lngRow, COL_√≈’Ôµ•Œª) = rsTmp!√≈’Ôµ•Œª
                .TextMatrix(lngRow, COL_√≈’Ô∞¸◊∞) = rsTmp!√≈’Ô∞¸◊∞
                .TextMatrix(lngRow, COL_ø…∑Ò∑÷¡„) = Nvl(rsTmp!ø…∑Ò∑÷¡„, 0)
                .TextMatrix(lngRow, COL_∏ﬂŒ£“©∆∑) = Nvl(rsTmp!∏ﬂŒ£“©∆∑, 0)
                .TextMatrix(lngRow, COL_ª˘±æ“©ŒÔ) = rsTmp!ª˘±æ“©ŒÔ & ""
                If Val(.TextMatrix(lngRow, COL_∏ﬂŒ£“©∆∑)) <> 0 Then
                    MsgBox "µ±«∞–¬ø™µƒ «" & Decode(Val(.TextMatrix(lngRow, COL_∏ﬂŒ£“©∆∑)), 1, "A", 2, "B", 3, "C", "") & "º∂∏ﬂŒ£“©∆∑£¨«ÎΩ˜…˜ π”√°£", vbInformation, Me.Caption
                End If
            ElseIf rsInput!¿‡±ID = "4" Then
                strSQL = "Select A.∏˙◊Ÿ‘⁄”√,B.√˚≥∆,B.º∆À„µ•Œª From ≤ƒ¡œÃÿ–‘ A, ’∑—œÓƒøƒø¬º B Where A.≤ƒ¡œID=B.ID And A.≤ƒ¡œID=[1]"
                Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(rsInput! ’∑—œ∏ƒøID))
                .TextMatrix(lngRow, COL_√˚≥∆) = rsTmp!√˚≥∆ 'Ω´±√˚ªª≥…’˝ ΩπÊ∏Ò√˚≥∆
                .TextMatrix(lngRow, COL_º¡¡øœµ ˝) = 1
                .TextMatrix(lngRow, COL_√≈’Ô∞¸◊∞) = 1
                .TextMatrix(lngRow, COL_√≈’Ôµ•Œª) = Nvl(rsTmp!º∆À„µ•Œª) '…¢◊∞µ•Œª
                .TextMatrix(lngRow, COL_∏˙◊Ÿ‘⁄”√) = Nvl(rsTmp!∏˙◊Ÿ‘⁄”√, 0)
                .TextMatrix(lngRow, COL_ºÏ≤È∑Ω∑®) = rsInput!≈˙¥Œ & ""
            End If
        End If
        
        '“©∆∑Ãÿ–‘
        If InStr(",5,6,", rsInput!¿‡±ID) > 0 Then
            strSQL = "Select ∂æ¿Ì∑÷¿‡,øπ…˙Àÿ,“©∆∑º¡–Õ,¥¶∑Ωœﬁ¡ø,¥¶∑Ω÷∞ŒÒ,¡Ÿ¥≤◊‘π‹“©,»‹√Ω From “©∆∑Ãÿ–‘ Where “©√˚ID=[1]"
            Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(rsInput!’Ô¡∆œÓƒøID))
            If Not rsTmp.EOF Then
                .TextMatrix(lngRow, COL_∂æ¿Ì∑÷¿‡) = Nvl(rsTmp!∂æ¿Ì∑÷¿‡)
                .TextMatrix(lngRow, COL_øπæ˙µ»º∂) = Val("" & rsTmp!øπ…˙Àÿ)
                .TextMatrix(lngRow, COL_“©∆∑º¡–Õ) = Nvl(rsTmp!“©∆∑º¡–Õ)
                .TextMatrix(lngRow, COL_¥¶∑Ωœﬁ¡ø) = Nvl(rsTmp!¥¶∑Ωœﬁ¡ø)
                .TextMatrix(lngRow, COL_¥¶∑Ω÷∞ŒÒ) = Nvl(rsTmp!¥¶∑Ω÷∞ŒÒ)
                .TextMatrix(lngRow, COL_¡Ÿ¥≤◊‘π‹“©) = rsTmp!¡Ÿ¥≤◊‘π‹“© & ""
                .TextMatrix(lngRow, COL_ «∑Ò»‹√Ω) = Val(rsTmp!»‹√Ω & "")
                
                If gblnKSSStrict And UserInfo.”√“©º∂± < Val("" & rsTmp!øπ…˙Àÿ) Then
                    .TextMatrix(lngRow, COL_…Û∫À◊¥Ã¨) = 1
                End If
            End If
        End If
        
        If rsInput!¿‡±ID & "" <> "K" Then
            If chkΩÙº±.value = 1 Then
                If Val(.TextMatrix(lngRow, COL_…Û∫À◊¥Ã¨)) = 1 Then .TextMatrix(lngRow, COL_…Û∫À◊¥Ã¨) = ""
            Else
                If gblnKSSStrict And UserInfo.”√“©º∂± < Val(.TextMatrix(lngRow, COL_øπæ˙µ»º∂)) Then .TextMatrix(lngRow, COL_…Û∫À◊¥Ã¨) = 1
            End If
        End If
        
        'ªÒ»°∏¸∂‡’Ô¡∆œÓƒø–≈œ¢
        '----------------------------------------------------------------------------
        strSQL = "Select A.*" & _
            " From ’Ô¡∆”√∑®”√¡ø A,’Ô¡∆œÓƒøƒø¬º B" & _
            " Where A.”√∑®ID=B.ID And (Nvl(A.–‘÷ ,0)=0 Or B.∑˛ŒÒ∂‘œÛ IN(1,3))" & _
            " And (B.’æµ„='" & gstrNodeNo & "' Or B.’æµ„ is Null)" & _
            " And A.œÓƒøID=[1]"
        strSQL = "Select A.*,Nvl(B.–‘÷ ,0) as –‘÷ ,B.”√∑®ID," & _
            " B.∆µ¥Œ,B.≥…»Àº¡¡ø,B.–°∂˘º¡¡ø,B.“Ω…˙÷ˆÕ–,B.¡∆≥Ã" & _
            " From ’Ô¡∆œÓƒøƒø¬º A,(" & strSQL & ") B" & _
            " Where A.ID=B.œÓƒøID(+) And A.ID=[1]" & _
            " Order by –‘÷ "
        Set rsMore = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(rsInput!’Ô¡∆œÓƒøID))
                
        If IsNull(rsInput! ’∑—œ∏ƒøID) Then 'Ω´±√˚ªª≥…’˝ Ω’Ô¡∆√˚≥∆
            .TextMatrix(lngRow, COL_√˚≥∆) = rsMore!√˚≥∆
        End If
                
        If rsInput!¿‡±ID = "4" Then
            .TextMatrix(lngRow, COL_µ•¡øµ•Œª) = .TextMatrix(lngRow, COL_√≈’Ôµ•Œª) '…¢◊∞µ•Œª
        ElseIf InStr(",5,6,", rsInput!¿‡±ID) > 0 Or (Nvl(rsMore!÷¥––∆µ¬ , 0) = 0 And InStr(",1,2,", Nvl(rsMore!º∆À„∑Ω Ω, 0)) > 0) Then
            .TextMatrix(lngRow, COL_µ•¡øµ•Œª) = Nvl(rsMore!º∆À„µ•Œª) '“©∆∑Œ™º¡¡øµ•Œª
        End If
        
        If InStr(",5,6,", rsInput!¿‡±ID) > 0 Then
            '÷–°¢Œ˜≥…“©¡Ÿ÷ˆµƒ◊‹¡øµ•ŒªæÕ «√≈’Ôµ•Œª
            .TextMatrix(lngRow, COL_◊‹¡øµ•Œª) = .TextMatrix(lngRow, COL_√≈’Ôµ•Œª)
        ElseIf rsInput!¿‡±ID = "4" Then
            .TextMatrix(lngRow, COL_◊‹¡øµ•Œª) = .TextMatrix(lngRow, COL_√≈’Ôµ•Œª) '…¢◊∞µ•Œª
        Else
            '∆‰À¸¡Ÿ÷ˆ“™ ‰»Î◊‹¡ø(º∆À„µ•Œª)
            '»Áπ˚Œ™“ª¥Œ–‘ªÚº∆¥Œ¡Ÿ÷ˆ»± °◊‹¡øŒ™1
            If Nvl(rsMore!÷¥––∆µ¬ , 0) = 1 Or Nvl(rsMore!º∆À„∑Ω Ω, 0) = 3 Then
                .TextMatrix(lngRow, COL_◊‹¡ø) = 1
            End If
            .TextMatrix(lngRow, COL_◊‹¡øµ•Œª) = Nvl(rsMore!º∆À„µ•Œª)
        End If
        
        'øπæ˙“©ŒÔ»± °”√“©ƒøµƒ
        If Val(.TextMatrix(lngRow, COL_øπæ˙µ»º∂)) > 0 Then .TextMatrix(lngRow, COL_”√“©ƒøµƒ) = mstrPurMed
        
        .TextMatrix(lngRow, COL_º∆À„∑Ω Ω) = Nvl(rsMore!º∆À„∑Ω Ω, 0)
        .TextMatrix(lngRow, COL_∆µ¬ –‘÷ ) = Nvl(rsMore!÷¥––∆µ¬ , 0)
        .TextMatrix(lngRow, COL_≤Ÿ◊˜¿‡–Õ) = Nvl(rsMore!≤Ÿ◊˜¿‡–Õ)
        .TextMatrix(lngRow, COL_µ•∂¿”¶”√) = Nvl(rsMore!µ•∂¿”¶”√)
        .TextMatrix(lngRow, COL_÷¥––∑÷¿‡) = Nvl(rsMore!÷¥––∑÷¿‡, 0)
        If InStr(",5,6,7,", rsInput!¿‡±ID) = 0 Then
            .TextMatrix(lngRow, COL_¥¶∑Ωœﬁ¡ø) = Nvl(rsMore!¬º»Îœﬁ¡ø)
        End If
        
        '±Í±æ≤øŒª
        If InStr(",4,5,6,", rsInput!¿‡±ID) > 0 Then
            .TextMatrix(lngRow, COL_±Í±æ≤øŒª) = rsInput!√˚≥∆ 'º«¬º“©∆∑°¢Œ¿≤ƒ ‰»Î ±—°‘Òµƒ√˚≥∆
        ElseIf rsInput!¿‡±ID = "F" Or rsInput!¿‡±ID = "K" Then
            .TextMatrix(lngRow, COL_ ÷ ı ±º‰) = "" 'º«¬º ÷ ı/ ‰—™ ±º‰
        ElseIf rsInput!¿‡±ID <> "D" Then
            .TextMatrix(lngRow, COL_±Í±æ≤øŒª) = Nvl(rsMore!±Í±æ≤øŒª)
        End If
        
        'º∆º€–‘÷ 
        .TextMatrix(lngRow, COL_º∆º€–‘÷ ) = Nvl(rsMore!º∆º€–‘÷ , 0)
    
        '÷¥–––‘÷ :–¬‘ˆœÓƒø ±∏˘æ›œÓƒø…Ë÷√,“©∆∑°¢Œ¿≤ƒ=4-÷∏∂®ø∆ “,“ª≤¢∏¯“©µƒœ‡Õ¨
        If InStr(",5,6,", rsInput!¿‡±ID) > 0 Then
            If lngGroupRow <> 0 Then
                .TextMatrix(lngRow, COL_÷¥–––‘÷ ) = .TextMatrix(lngGroupRow, COL_÷¥–––‘÷ )
            Else
                .TextMatrix(lngRow, COL_÷¥–––‘÷ ) = IIF(Val(.TextMatrix(lngRow, COL_¡Ÿ¥≤◊‘π‹“©)) = 1, 5, 4) '◊‘±∏“©…ËŒ™‘∫Õ‚÷¥––
            End If
        ElseIf rsInput!¿‡±ID = "4" Then
            .TextMatrix(lngRow, COL_÷¥–––‘÷ ) = 4
        Else
            .TextMatrix(lngRow, COL_÷¥–––‘÷ ) = Nvl(rsMore!÷¥––ø∆ “, 0)
        End If
            
        'ø™÷ˆ“Ω…˙∫Õø∆ “
        If lngGroupRow = 0 Then
            .TextMatrix(lngRow, COL_ø™÷ˆ“Ω…˙) = UserInfo.–’√˚
            .TextMatrix(lngRow, COL_ø™÷ˆø∆ “ID) = Getø™÷ˆø∆ “ID(UserInfo.ID, mlng“Ωººø∆ “ID, mlng≤°»Àø∆ “id, 1)
        Else
            .TextMatrix(lngRow, COL_ø™÷ˆ“Ω…˙) = .TextMatrix(lngGroupRow, COL_ø™÷ˆ“Ω…˙)
            .TextMatrix(lngRow, COL_ø™÷ˆø∆ “ID) = .TextMatrix(lngGroupRow, COL_ø™÷ˆø∆ “ID)
        End If
    
        '÷¥––ø∆ “:“©∆∑»± °”Î…œ“ª––œ‡Õ¨,“ª≤¢∏¯“©µƒœ‡Õ¨
        lng÷¥––ø∆ “ID = 0
        If InStr(",5,6,", rsInput!¿‡±ID) > 0 Then
            If Val(.TextMatrix(lngRow, COL_÷¥–––‘÷ )) = 5 Then
                .TextMatrix(lngRow, COL_÷¥––ø∆ “ID) = 0
            Else

                str“©∑øIDs = Getø…”√“©∑øIDs(rsInput!¿‡±ID, rsInput!’Ô¡∆œÓƒøID, Nvl(rsInput! ’∑—œ∏ƒøID, 0), mlng≤°»Àø∆ “id, 1)
                If lngGroupRow <> 0 Then
                    If InStr("," & str“©∑øIDs & ",", "," & .TextMatrix(lngGroupRow, COL_÷¥––ø∆ “ID) & ",") > 0 Then
                        .TextMatrix(lngRow, COL_÷¥––ø∆ “ID) = .TextMatrix(lngGroupRow, COL_÷¥––ø∆ “ID)
                    End If
                ElseIf lngCopyRow <> -1 Then
                    bln«ø÷∆»± ° = Val(zlDatabase.GetPara("√≈’Ô“Ω÷ˆœ¬¥Ô«ø÷∆»± °“©∑ø", glngSys, p√≈’Ô“Ω÷ˆœ¬¥Ô, 1)) = 1
                    strƒ¨»œ“©∑ø = zlDatabase.GetPara("√≈’Ô»± °" & IIF(Val(rsInput!¿‡±ID) = 5, "Œ˜", "≥…") & "“©∑ø", glngSys, p√≈’Ô“Ω÷ˆœ¬¥Ô, mlng≤°»Àø∆ “id)
                    If bln«ø÷∆»± ° And InStr(str“©∑øIDs, strƒ¨»œ“©∑ø) > 0 And strƒ¨»œ“©∑ø <> "" Then
                        lng÷¥––ø∆ “ID = 0
                    Else
                        If rsInput!¿‡±ID = .TextMatrix(lngCopyRow, COL_¿‡±) Then
                            lng÷¥––ø∆ “ID = Val(.TextMatrix(lngCopyRow, COL_÷¥––ø∆ “ID))
                        End If
                    End If
                End If
            End If
        End If

        If Val(.TextMatrix(lngRow, COL_÷¥––ø∆ “ID)) = 0 Then
            If rsInput!¿‡±ID = "Z" And InStr(",1,2,", Nvl(rsMore!≤Ÿ◊˜¿‡–Õ, 0)) > 0 Then
                '¡Ùπ€ªÚ◊°‘∫“Ω÷ˆ≤ª»± °
                If Nvl(rsMore!≤Ÿ◊˜¿‡–Õ, 0) = 1 Then
                    '¡Ùπ€:∞¸∫¨√≈’ÔªÚ◊°‘∫µƒ¡Ÿ¥≤ø∆ “
                    Call Get¡Ÿ¥≤ø∆ “(3, , lngTmp, , True, False, True)
                ElseIf Nvl(rsMore!≤Ÿ◊˜¿‡–Õ, 0) = 2 Then
                    '◊°‘∫:◊°‘∫¡Ÿ¥≤ø∆ “
                    Call Get¡Ÿ¥≤ø∆ “(2, , lngTmp, , True, False, True)
                End If
                .TextMatrix(lngRow, COL_÷¥––ø∆ “ID) = lngTmp
            ElseIf InStr(",0,5,", Val(.TextMatrix(lngRow, COL_÷¥–––‘÷ ))) = 0 Then
                '÷¥–––‘÷ Œ™(0-∂£÷ˆ,5-‘∫Õ‚÷¥––)Œﬁ÷¥––ø∆ “
                '÷Æ«∞œ»«Û≥ˆø™÷ˆø∆ “ID
                If rsInput!¿‡±ID = "4" Then
                    .TextMatrix(lngRow, COL_÷¥––ø∆ “ID) = Get ’∑—÷¥––ø∆ “ID(mlng≤°»ÀID, 0, _
                        rsInput!¿‡±ID, Nvl(rsInput! ’∑—œ∏ƒøID, 0), 4, mlng≤°»Àø∆ “id, Val(.TextMatrix(lngRow, COL_ø™÷ˆø∆ “ID)), 1, , 1)
                Else
                    .TextMatrix(lngRow, COL_÷¥––ø∆ “ID) = Get’Ô¡∆÷¥––ø∆ “ID(mlng≤°»ÀID, 0, rsInput!¿‡±ID, rsInput!’Ô¡∆œÓƒøID, _
                        Nvl(rsInput! ’∑—œ∏ƒøID, 0), Nvl(rsMore!÷¥––ø∆ “, 0), mlng≤°»Àø∆ “id, Val(.TextMatrix(lngRow, COL_ø™÷ˆø∆ “ID)), 1, 1, InStr(",5,6,", rsInput!¿‡±ID) > 0, lng÷¥––ø∆ “ID)
                End If
            End If
        End If
        
        '“©∆∑ø‚¥Ê
        If (InStr(",5,6,", rsInput!¿‡±ID) > 0 Or rsInput!¿‡±ID = "4" And Val(.TextMatrix(lngRow, COL_∏˙◊Ÿ‘⁄”√)) = 1) And Nvl(rsInput! ’∑—œ∏ƒøID, 0) <> 0 Then
            Call GetDrugStock(lngRow)
        End If
        
        '÷¥––∆µ¬ :ø…—°∆µ¬ ,“ª¥Œ–‘ªÚ≥÷–¯–‘
        
        '»± °”Î…œ“ª–¬‘ˆ––œ‡Õ¨
        If lngCopyRow <> -1 Then
            If Get∆µ¬ ∑∂Œß(lngRow) = Get∆µ¬ ∑∂Œß(lngCopyRow) Then
                If Val(.TextMatrix(lngCopyRow, COL_EDIT)) = 1 And .TextMatrix(lngCopyRow, COL_∆µ¬ ) <> "" _
                    And Not (.TextMatrix(lngRow, COL_¿‡±) = "7" And Not RowIn≈‰∑Ω––(lngCopyRow)) _
                    And Not (.TextMatrix(lngRow, COL_¿‡±) <> "7" And RowIn≈‰∑Ω––(lngCopyRow)) _
                    And Check∆µ¬ ø…”√(Nvl(rsInput!’Ô¡∆œÓƒøID, 0), Get∆µ¬ ∑∂Œß(lngRow), .TextMatrix(lngCopyRow, COL_∆µ¬ )) Then
                    .TextMatrix(lngRow, COL_∆µ¬ ) = .TextMatrix(lngCopyRow, COL_∆µ¬ )
                    .TextMatrix(lngRow, COL_∆µ¬ ¥Œ ˝) = .TextMatrix(lngCopyRow, COL_∆µ¬ ¥Œ ˝)
                    .TextMatrix(lngRow, COL_∆µ¬ º‰∏Ù) = .TextMatrix(lngCopyRow, COL_∆µ¬ º‰∏Ù)
                    .TextMatrix(lngRow, COL_º‰∏Ùµ•Œª) = .TextMatrix(lngCopyRow, COL_º‰∏Ùµ•Œª)
                End If
            End If
        End If
        'ªÚ»°»± °∆µ¬ 
        If .TextMatrix(lngRow, COL_∆µ¬ ) = "" Then
            Call Get»± °∆µ¬ (Nvl(rsInput!’Ô¡∆œÓƒøID, 0), Get∆µ¬ ∑∂Œß(lngRow), str∆µ¬ , int∆µ¬ ¥Œ ˝, int∆µ¬ º‰∏Ù, strº‰∏Ùµ•Œª)
            .TextMatrix(lngRow, COL_∆µ¬ ) = str∆µ¬ 
            .TextMatrix(lngRow, COL_∆µ¬ ¥Œ ˝) = int∆µ¬ ¥Œ ˝
            .TextMatrix(lngRow, COL_∆µ¬ º‰∏Ù) = int∆µ¬ º‰∏Ù
            .TextMatrix(lngRow, COL_º‰∏Ùµ•Œª) = strº‰∏Ùµ•Œª
        End If
        
        
        '÷–£¨Œ˜≥…“©µƒ“ª–©»± °–≈œ¢
        If InStr(",5,6,", rsInput!¿‡±ID) > 0 Then
            '÷¥––∆µ¬ 
            If lngGroupRow <> 0 Then
                '“ª≤¢∏¯“©µƒœ‡Õ¨
                .TextMatrix(lngRow, COL_∆µ¬ ) = .TextMatrix(lngGroupRow, COL_∆µ¬ )
                .TextMatrix(lngRow, COL_∆µ¬ ¥Œ ˝) = .TextMatrix(lngGroupRow, COL_∆µ¬ ¥Œ ˝)
                .TextMatrix(lngRow, COL_∆µ¬ º‰∏Ù) = .TextMatrix(lngGroupRow, COL_∆µ¬ º‰∏Ù)
                .TextMatrix(lngRow, COL_º‰∏Ùµ•Œª) = .TextMatrix(lngGroupRow, COL_º‰∏Ùµ•Œª)
                .TextMatrix(lngRow, COL_÷¥–– ±º‰) = .TextMatrix(lngGroupRow, COL_÷¥–– ±º‰)
                
                If Val(.TextMatrix(lngRow, COL_øπæ˙µ»º∂)) > 0 Then
                    .TextMatrix(lngRow, COL_”√“©ƒøµƒ) = .TextMatrix(lngGroupRow, COL_”√“©ƒøµƒ)
                    .TextMatrix(lngRow, COL_”√“©¿Ì”…) = .TextMatrix(lngGroupRow, COL_”√“©¿Ì”…)
                End If
            End If
            
            '»∑∂®¡Ÿ÷ˆ”√“©ÃÏ ˝£∫
            '1.◊Ó…ŸŒ™“ª∏ˆ∆µ¬ ÷‹∆⁄ÃÏ ˝
            '2-”–¡∆≥Ã‘ÚŒ™¡∆≥ÃÃÏ ˝(”¶¥Û”⁄“ª∏ˆ∆µ¬ ÷‹∆⁄ÃÏ ˝)
            sngÃÏ ˝ = msngÃÏ ˝
            If mblnÃÏ ˝ Then
                If .TextMatrix(lngRow, COL_º‰∏Ùµ•Œª) = "÷‹" Then
                    If 7 > sngÃÏ ˝ Then sngÃÏ ˝ = 7
                ElseIf .TextMatrix(lngRow, COL_º‰∏Ùµ•Œª) = "ÃÏ" Then
                    If Val(.TextMatrix(lngRow, COL_∆µ¬ º‰∏Ù)) > sngÃÏ ˝ Then
                        sngÃÏ ˝ = Val(.TextMatrix(lngRow, COL_∆µ¬ º‰∏Ù))
                    End If
                ElseIf .TextMatrix(lngRow, COL_º‰∏Ùµ•Œª) = "–° ±" Then
                    If Val(.TextMatrix(lngRow, COL_∆µ¬ º‰∏Ù)) \ 24 > sngÃÏ ˝ Then
                        sngÃÏ ˝ = Val(.TextMatrix(lngRow, COL_∆µ¬ º‰∏Ù)) \ 24
                    End If
                ElseIf .TextMatrix(lngRow, COL_º‰∏Ùµ•Œª) = "∑÷÷”" Then
                    If sngÃÏ ˝ = 0 Then sngÃÏ ˝ = 1
                End If
                If sngÃÏ ˝ = 0 Then sngÃÏ ˝ = 1
            End If
            
            rsMore.Filter = "–‘÷ >0" '»°µ⁄“ª÷÷∏¯“©Õææ∂”√Œ™»± °…Ë÷√
            If Not rsMore.EOF Then
                '≤ª «“ª≤¢∏¯“© ±,…Ë÷√µƒ»± °”√∑®∆µ¬ ”≈œ»
                If lngGroupRow = 0 Then
                    If Not IsNull(rsMore!”√∑®ID) Then lng∏¯“©Õææ∂ID = rsMore!”√∑®ID
                    If Not IsNull(rsMore!∆µ¥Œ) Then
                        Call Get∆µ¬ –≈œ¢_±‡¬Î(rsMore!∆µ¥Œ, str∆µ¬ , int∆µ¬ ¥Œ ˝, int∆µ¬ º‰∏Ù, strº‰∏Ùµ•Œª)
                        .TextMatrix(lngRow, COL_∆µ¬ ) = str∆µ¬ 
                        .TextMatrix(lngRow, COL_∆µ¬ ¥Œ ˝) = int∆µ¬ ¥Œ ˝
                        .TextMatrix(lngRow, COL_∆µ¬ º‰∏Ù) = int∆µ¬ º‰∏Ù
                        .TextMatrix(lngRow, COL_º‰∏Ùµ•Œª) = strº‰∏Ùµ•Œª
                    End If
                End If
                
                '“Ω…˙÷ˆÕ–
                .TextMatrix(lngRow, COL_“Ω…˙÷ˆÕ–) = Nvl(rsMore!“Ω…˙÷ˆÕ–) '“ª∞„Œ™∏¯“©Õææ∂µƒÀµ√˜
                
                '“©∆∑µ•¡ø
                If mintƒÍ¡‰ > 12 Then
                    If Nvl(rsMore!≥…»Àº¡¡ø, 0) <> 0 Then
                        .TextMatrix(lngRow, COL_µ•¡ø) = FormatEx(rsMore!≥…»Àº¡¡ø, 5)
                    End If
                Else
                    If Nvl(rsMore!–°∂˘º¡¡ø, 0) <> 0 Then
                        .TextMatrix(lngRow, COL_µ•¡ø) = FormatEx(rsMore!–°∂˘º¡¡ø, 5)
                    ElseIf Nvl(rsMore!≥…»Àº¡¡ø, 0) <> 0 Then
                        .TextMatrix(lngRow, COL_µ•¡ø) = FormatEx(rsMore!≥…»Àº¡¡ø * (mintƒÍ¡‰ + 2) * 5 / 100, 5)
                    End If
                End If
                If Val(.TextMatrix(lngRow, COL_µ•¡ø)) = 0 Then .TextMatrix(lngRow, COL_µ•¡ø) = ""
                
                '“©∆∑¡Ÿ÷ˆ◊‹¡ø:√≈’Ô∞¸◊∞
                If Nvl(rsMore!¡∆≥Ã, 1) > sngÃÏ ˝ Then sngÃÏ ˝ = Nvl(rsMore!¡∆≥Ã, 1)
                If .TextMatrix(lngRow, COL_∆µ¬ ) <> "" And Val(.TextMatrix(lngRow, COL_µ•¡ø)) <> 0 _
                    And Val(.TextMatrix(lngRow, COL_º¡¡øœµ ˝)) <> 0 And Val(.TextMatrix(lngRow, COL_√≈’Ô∞¸◊∞)) <> 0 Then
                    'Ωˆ∞¥¡∆≥ÃÀ„∏ƒŒ™∞¥◊Ó…Ÿ”√“©ÃÏ ˝À„
                    .TextMatrix(lngRow, COL_◊‹¡ø) = FormatEx(Calc»± °“©∆∑◊‹¡ø( _
                            Val(.TextMatrix(lngRow, COL_µ•¡ø)), sngÃÏ ˝, _
                            Val(.TextMatrix(lngRow, COL_∆µ¬ ¥Œ ˝)), _
                            Val(.TextMatrix(lngRow, COL_∆µ¬ º‰∏Ù)), _
                            .TextMatrix(lngRow, COL_º‰∏Ùµ•Œª), _
                            .TextMatrix(lngRow, COL_÷¥–– ±º‰), _
                            Val(.TextMatrix(lngRow, COL_º¡¡øœµ ˝)), _
                            Val(.TextMatrix(lngRow, COL_√≈’Ô∞¸◊∞)), _
                            Val(.TextMatrix(lngRow, COL_ø…∑Ò∑÷¡„))), 5)
                    If InStr(GetInsidePrivs(p√≈’Ô“Ω÷ˆœ¬¥Ô), "“©∆∑–° ˝ ‰»Î") = 0 Then
                        .TextMatrix(lngRow, COL_◊‹¡ø) = IntEx(Val(.TextMatrix(lngRow, COL_◊‹¡ø)))
                    ElseIf Val(.TextMatrix(lngRow, COL_ø…∑Ò∑÷¡„)) <> 0 Then
                        .TextMatrix(lngRow, COL_◊‹¡ø) = IntEx(Val(.TextMatrix(lngRow, COL_◊‹¡ø)))
                    End If
                End If
            End If
            
            'º«¬º»± °ÃÏ ˝
            If mblnÃÏ ˝ Then .TextMatrix(lngRow, COL_ÃÏ ˝) = IIF(sngÃÏ ˝ = 0, "", sngÃÏ ˝)
            'µ±◊‹¡ø£¨£®ÃÏ ˝£©£¨µ•¡ø£¨ø…ƒ‹±ª≥Ã–Ú◊‘∂Ø£®≤ª « ÷∂Ø¬º»Î£©…Ë÷µ£¨»Á…Ë÷√¡À”√∑®”√¡ø£¨‘Ú≤ªª·÷¥––≥¨¡øºÏ≤Èµƒ¥˙¬Î£®øÿº˛Validate ¬º˛£©
            Call Set”√“©ÃÏ ˝ «∑Ò≥¨∆⁄(lngRow)
            If Val(.TextMatrix(lngRow, COL_¥¶∑Ωœﬁ¡ø)) <> 0 And Val(.TextMatrix(lngRow, COL_◊‹¡ø)) <> 0 Then
                If Val(.TextMatrix(lngRow, COL_◊‹¡ø)) * Val(.TextMatrix(lngRow, COL_√≈’Ô∞¸◊∞)) * Val(.TextMatrix(lngRow, COL_º¡¡øœµ ˝)) > Val(.TextMatrix(lngRow, COL_¥¶∑Ωœﬁ¡ø)) Then
                    .TextMatrix(lngRow, COL_ «∑Ò≥¨¡ø) = "1"
                End If
            End If
        End If
        
        If rsMore.Filter <> 0 Then rsMore.Filter = 0
        
        '÷¥–– ±º‰:"ø…—°∆µ¬ "ªÚ“©∆∑
        If Nvl(rsMore!÷¥––∆µ¬ , 0) = 0 Or InStr(",5,6,", rsInput!¿‡±ID) > 0 Then
            If .TextMatrix(lngRow, COL_÷¥–– ±º‰) = "" Then
                If lngCopyRow <> -1 Then '”Î…œ“ª––œ‡Õ¨
                    If .TextMatrix(lngRow, COL_∆µ¬ ) = .TextMatrix(lngCopyRow, COL_∆µ¬ ) Then
                        .TextMatrix(lngRow, COL_÷¥–– ±º‰) = .TextMatrix(lngCopyRow, COL_÷¥–– ±º‰)
                    End If
                End If
                If .TextMatrix(lngRow, COL_÷¥–– ±º‰) = "" Then '»± ° ±º‰∑Ω∞∏
                    .TextMatrix(lngRow, COL_÷¥–– ±º‰) = Get»± ° ±º‰(1, .TextMatrix(lngRow, COL_∆µ¬ ), lng∏¯“©Õææ∂ID)
                End If
            End If
        End If
        
        '∆‰À¸(”ÎœÓƒøŒﬁπÿ)
        '---------------------------------------------------------------------
        If lngGroupRow = 0 Then
            vCurDate = zlDatabase.Currentdate
            If IsDate(txtø™ º ±º‰.Text) Then
                .TextMatrix(lngRow, COL_ø™ º ±º‰) = Format(txtø™ º ±º‰.Text, "yyyy-MM-dd HH:mm")
                .Cell(flexcpData, lngRow, COL_ø™ º ±º‰) = txtø™ º ±º‰.Text
            
                ' ÷ ı/ ‰—™ ±º‰»± °Œ™ø™ º ±º‰
                If rsInput!¿‡±ID = "F" Or rsInput!¿‡±ID = "K" Then
                    .TextMatrix(lngRow, COL_ ÷ ı ±º‰) = txtø™ º ±º‰.Text
                End If
            End If
            
            .TextMatrix(lngRow, COL_ø™÷ˆ ±º‰) = Format(vCurDate, "yyyy-MM-dd HH:mm")
            .Cell(flexcpData, lngRow, COL_ø™÷ˆ ±º‰) = Format(vCurDate, "yyyy-MM-dd HH:mm")
    
            .TextMatrix(lngRow, COL_±Í÷æ) = chkΩÙº±.value
        Else
            .TextMatrix(lngRow, COL_ø™ º ±º‰) = .TextMatrix(lngGroupRow, COL_ø™ º ±º‰)
            .Cell(flexcpData, lngRow, COL_ø™ º ±º‰) = .Cell(flexcpData, lngGroupRow, COL_ø™ º ±º‰)
            
            .TextMatrix(lngRow, COL_ø™÷ˆ ±º‰) = .TextMatrix(lngGroupRow, COL_ø™÷ˆ ±º‰)
            .Cell(flexcpData, lngRow, COL_ø™÷ˆ ±º‰) = .Cell(flexcpData, lngGroupRow, COL_ø™÷ˆ ±º‰)
            
            .TextMatrix(lngRow, COL_±Í÷æ) = .TextMatrix(lngGroupRow, COL_±Í÷æ)
        End If
                        
        
        '‘⁄÷˜––¥¶¿ÌÕÍ≥…÷Æ∫Û¥¶¿Ì∏Ωº”––,≤¢◊È∫œ“Ω÷ˆƒ⁄»›
        '-------------------------------------------------------------------------
        If InStr(",5,6,", rsInput!¿‡±ID) > 0 Then
            '–¬‘ˆ“ª∏ˆ∏¯“©Õææ∂œÓƒø,≤¢…Ë÷√œ‡πÿ
            If lng∏¯“©Õææ∂ID <> 0 Then
                .TextMatrix(lngRow, COL_”√∑®) = GetœÓƒø√˚≥∆(lng∏¯“©Õææ∂ID)
            End If
            If lngGroupRow <> 0 Then
                '“ª≤¢∏¯“©µƒπÿ¡™œ‡Õ¨µƒ∏¯“©Õææ∂––
                lngTmp = .FindRow(CLng(.TextMatrix(lngGroupRow, COL_œ‡πÿID)), lngGroupRow + 1)
                If lngTmp > lngRow Then
                    .TextMatrix(lngRow, COL_œ‡πÿID) = .TextMatrix(lngGroupRow, COL_œ‡πÿID)
                Else
                    '’‚÷÷«Èøˆ «ΩˆŒ™¡À π”√“ª≤¢∏¯“©µƒœ‡Õ¨…Ë÷√
                    .TextMatrix(lngRow, COL_œ‡πÿID) = AdviceSet∏¯“©Õææ∂(lngRow, lng∏¯“©Õææ∂ID)
                End If
            Else '∂¿¡¢–¬‘ˆµƒ≥…“©πÿ¡™∂¿¡¢µƒ∏¯“©Õææ∂––
                .TextMatrix(lngRow, COL_œ‡πÿID) = AdviceSet∏¯“©Õææ∂(lngRow, lng∏¯“©Õææ∂ID)
            End If
            
            '∂æ¬Èæ´µƒ—’…´±Í ∂
            If InStr(",¬È◊Ì“©,∂æ–‘“©,æ´…Ò“©,æ´…ÒI¿‡,æ´…ÒII¿‡,", .TextMatrix(lngRow, COL_∂æ¿Ì∑÷¿‡)) > 0 _
                And .TextMatrix(lngRow, COL_∂æ¿Ì∑÷¿‡) <> "" Then
                .Cell(flexcpFontBold, lngRow, col_“Ω÷ˆƒ⁄»›) = True
            End If
        ElseIf rsInput!¿‡±ID = "D" And strExtData <> "" Then
            'ºÏ≤Èµƒ◊È∫œ≤øŒª––
            Call AdviceSetºÏ≤È◊È∫œ(lngRow, strExtData)
        ElseIf rsInput!¿‡±ID = "F" And strExtData <> "" Then
            ' ÷ ıµƒ∏Ωº” ÷ ıº∞¬È◊ÌœÓƒø––
            Call AdviceSet ÷ ı◊È∫œ(lngRow, strExtData)
            vsAdvice.Cell(flexcpData, lngRow, COL_±Í±æ≤øŒª) = str ÷ ı≤øŒª
        ElseIf rsInput!¿‡±ID = "K" Then
            If bln±∏—™ Then
                .TextMatrix(lngRow, COL_ºÏ≤È∑Ω∑®) = ""
            Else
                .TextMatrix(lngRow, COL_ºÏ≤È∑Ω∑®) = 1
            End If
            ' ‰—™µƒÕææ∂––
            If lng∏¯“©Õææ∂ID <> 0 Then
                If gbln—™ø‚œµÕ≥ = True Then
                    strSQL = "Select a.√˚≥∆,a.≤Ÿ◊˜¿‡–Õ,a.÷¥––∑÷¿‡ From ’Ô¡∆œÓƒøƒø¬º A where a.id=[1]"
                    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng∏¯“©Õææ∂ID)
                    .TextMatrix(lngRow, COL_”√∑®) = rsTmp!√˚≥∆ & ""
                    If Val(rsTmp!≤Ÿ◊˜¿‡–Õ & "") = 8 And Val(rsTmp!÷¥––∑÷¿‡ & "") = 1 Then '»Áπ˚ «±‡º≠ΩÁ√Ê”√…Í«Îµ• ±–Ë“™÷ÿ…Ë“ª¥Œ
                        .TextMatrix(lngRow, COL_ºÏ≤È∑Ω∑®) = 1
                    Else
                        .TextMatrix(lngRow, COL_ºÏ≤È∑Ω∑®) = ""
                    End If
                Else
                    .TextMatrix(lngRow, COL_”√∑®) = GetœÓƒø√˚≥∆(lng∏¯“©Õææ∂ID)
                End If
                Call AdviceSet ‰—™Õææ∂(lngRow, lng∏¯“©Õææ∂ID)
            End If
        End If
        
        'ΩÙº±±Í÷æ
        If lngGroupRow <> 0 And .TextMatrix(lngRow, COL_…Û∫À◊¥Ã¨) <> "" Then
            Call SetRow±Í÷æÕº±Í(lngRow, 0)
        Else
            Call SetRow±Í÷æÕº±Í(lngRow, 1)
        End If
        
        .TextMatrix(lngRow, col_“Ω÷ˆƒ⁄»›) = AdviceTextMake(lngRow)
    End With
    Exit Sub
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Sub AdviceSetºÏ≤È◊È∫œ(ByVal lngRow As Long, ByVal strExData As String)
'π¶ƒ‹£∫÷ÿ–¬…Ë÷√÷∏∂®ºÏ≤È◊È∫œœÓƒøµƒ≤øŒª∑Ω∑®––,”√”⁄–¬ ‰»ÎºÏ≤È◊È∫œœÓƒøªÚ–ﬁ∏ƒ≤øŒª∑Ω∑®
'≤Œ ˝£∫lngRow=µ±«∞ ‰»Î––
'      strExData=∞¸∫¨ºÏ≤È≤øŒª∑Ω∑®µ»–≈œ¢,∏Ò ΩŒ™:"≤øŒª√˚1;∑Ω∑®√˚1,∑Ω∑®√˚2|≤øŒª√˚2;∑Ω∑®√˚1,∑Ω∑®√˚2|...<vbTab>0-≥£πÊ/1-¥≤≈‘/2- ı÷–"
    Dim arrItems As Variant, arrMethod As Variant
    Dim int÷¥––±Íº« As Integer, strºÏ≤È≤øŒª As String
    Dim i As Integer, j As Integer, k As Integer
    
    '…æ≥˝œ÷”–µƒºÏ≤È≤øŒª∑Ω∑®––
    Call DeleteºÏ≤È ÷ ı ‰—™(lngRow)
    
    '÷ÿ–¬º”»Î≤øŒª∑Ω∑®––
    If strExData <> "" Then
        '÷¥––±Íº«
        If UBound(Split(strExData, vbTab)) >= 1 Then
            int÷¥––±Íº« = Val(Split(strExData, vbTab)(1))
        End If
        vsAdvice.TextMatrix(lngRow, COL_÷¥––±Íº«) = int÷¥––±Íº« '‘⁄’‚¿ÔÕ≥“ª∏¸–¬÷˜––µƒ÷¥––±Íº«
        
        arrItems = Split(Split(strExData, vbTab)(0), "|")
        For i = 0 To UBound(arrItems)
            strºÏ≤È≤øŒª = Split(arrItems(i), ";")(0)
            arrMethod = Split(Split(arrItems(i), ";")(1), ",")
            For j = 0 To UBound(arrMethod)
                k = k + 1
                With vsAdvice
                    .AddItem "", lngRow + k
                    .RowHidden(lngRow + k) = True
                    
                    .RowData(lngRow + k) = GetNext“Ω÷ˆID
                    .TextMatrix(lngRow + k, COL_œ‡πÿID) = .RowData(lngRow)
                    
                    .TextMatrix(lngRow + k, COL_EDIT) = 1 '–¬‘ˆ
                    
                    .TextMatrix(lngRow + k, COL_”§∂˘) = cbo”§∂˘.ListIndex
                    .TextMatrix(lngRow + k, COL_–Ú∫≈) = Val(.TextMatrix(lngRow, COL_–Ú∫≈)) + k
                    .TextMatrix(lngRow + k, COL_◊¥Ã¨) = 1 '–¬ø™
                    
                    .TextMatrix(lngRow + k, COL_¿‡±) = .TextMatrix(lngRow, COL_¿‡±)
                    .TextMatrix(lngRow + k, COL_’Ô¡∆œÓƒøID) = .TextMatrix(lngRow, COL_’Ô¡∆œÓƒøID) 'Œ™Õ¨“ª∏ˆºÏ≤ÈœÓƒø
                    
                    .TextMatrix(lngRow + k, COL_º∆À„∑Ω Ω) = .TextMatrix(lngRow, COL_º∆À„∑Ω Ω)
                    .TextMatrix(lngRow + k, COL_∆µ¬ –‘÷ ) = .TextMatrix(lngRow, COL_∆µ¬ –‘÷ )
                    .TextMatrix(lngRow + k, COL_≤Ÿ◊˜¿‡–Õ) = .TextMatrix(lngRow, COL_≤Ÿ◊˜¿‡–Õ)
                    .TextMatrix(lngRow + k, COL_µ•∂¿”¶”√) = .TextMatrix(lngRow, COL_µ•∂¿”¶”√)
                    .TextMatrix(lngRow + k, COL_÷¥––∑÷¿‡) = .TextMatrix(lngRow, COL_÷¥––∑÷¿‡)
                    .TextMatrix(lngRow + k, COL_¥¶∑Ωœﬁ¡ø) = .TextMatrix(lngRow, COL_¥¶∑Ωœﬁ¡ø)
                    
                    .TextMatrix(lngRow + k, col_“Ω÷ˆƒ⁄»›) = .TextMatrix(lngRow, COL_√˚≥∆) 'º«¬ºŒ™ºÏ≤ÈœÓƒø√˚≥∆
                    .TextMatrix(lngRow + k, COL_±Í±æ≤øŒª) = strºÏ≤È≤øŒª
                    .TextMatrix(lngRow + k, COL_ºÏ≤È∑Ω∑®) = arrMethod(j)
                    .TextMatrix(lngRow + k, COL_÷¥––±Íº«) = int÷¥––±Íº«
                    
                    .TextMatrix(lngRow + k, COL_º∆º€–‘÷ ) = .TextMatrix(lngRow, COL_º∆º€–‘÷ )
                    
                    .TextMatrix(lngRow + k, COL_µ•¡ø) = .TextMatrix(lngRow, COL_µ•¡ø)
                    .TextMatrix(lngRow + k, COL_◊‹¡ø) = .TextMatrix(lngRow, COL_◊‹¡ø)
                    
                    .TextMatrix(lngRow + k, COL_÷¥–– ±º‰) = .TextMatrix(lngRow, COL_÷¥–– ±º‰)
                    .TextMatrix(lngRow + k, COL_∆µ¬ ) = .TextMatrix(lngRow, COL_∆µ¬ )
                    .TextMatrix(lngRow + k, COL_∆µ¬ ¥Œ ˝) = .TextMatrix(lngRow, COL_∆µ¬ ¥Œ ˝)
                    .TextMatrix(lngRow + k, COL_∆µ¬ º‰∏Ù) = .TextMatrix(lngRow, COL_∆µ¬ º‰∏Ù)
                    .TextMatrix(lngRow + k, COL_º‰∏Ùµ•Œª) = .TextMatrix(lngRow, COL_º‰∏Ùµ•Œª)
                    
                    .TextMatrix(lngRow + k, COL_÷¥–––‘÷ ) = .TextMatrix(lngRow, COL_÷¥–––‘÷ )
                    .TextMatrix(lngRow + k, COL_÷¥––ø∆ “ID) = .TextMatrix(lngRow, COL_÷¥––ø∆ “ID)
                    
                    .TextMatrix(lngRow + k, COL_ø™ º ±º‰) = .TextMatrix(lngRow, COL_ø™ º ±º‰)
                    .Cell(flexcpData, lngRow + k, COL_ø™ º ±º‰) = .Cell(flexcpData, lngRow, COL_ø™ º ±º‰)
                    
                    .TextMatrix(lngRow + k, COL_ø™÷ˆø∆ “ID) = .TextMatrix(lngRow, COL_ø™÷ˆø∆ “ID)
                    .TextMatrix(lngRow + k, COL_ø™÷ˆ“Ω…˙) = .TextMatrix(lngRow, COL_ø™÷ˆ“Ω…˙)
                    
                    .TextMatrix(lngRow + k, COL_ø™÷ˆ ±º‰) = .TextMatrix(lngRow, COL_ø™÷ˆ ±º‰)
                    .Cell(flexcpData, lngRow + k, COL_ø™÷ˆ ±º‰) = .Cell(flexcpData, lngRow, COL_ø™÷ˆ ±º‰)
                    
                    .TextMatrix(lngRow + k, COL_±Í÷æ) = .TextMatrix(lngRow, COL_±Í÷æ)
                End With
            Next
        Next
                
        'µ˜’˚∫Û√Ê“Ω÷ˆµƒ–Ú∫≈
        Call AdviceSet“Ω÷ˆ–Ú∫≈(lngRow + k + 1, k)
    End If
End Sub

Private Sub AdviceSet ÷ ı◊È∫œ(ByVal lngRow As Long, ByVal strDataIDs As String)
'π¶ƒ‹£∫÷ÿ–¬…Ë÷√÷∏∂® ÷ ıœÓƒøµƒ∏Ωº” ÷ ıº∞¬È◊ÌœÓƒø––,”√”⁄–¬ ‰»Î ÷ ıœÓƒøªÚ ÷ ıœÓƒøµƒ∏Ωº” ÷ ıº∞¬È◊ÌœÓƒø
'≤Œ ˝£∫lngRow=µ±«∞ ‰»Î––
'      strDataIDs=∞¸∫¨∏Ωº” ÷ ıº∞¬È◊ÌœÓƒø–≈œ¢,∆‰÷–ø…ƒ‹√ª”–∏Ωº” ÷ ı∫Õ¬È◊Ì
    Dim rsTmp As New ADODB.Recordset
    Dim strSQL As String, i As Long
    Dim arrIDs As Variant
    
    On Error GoTo errH
            
    '…æ≥˝œ÷”–µƒ∏Ωº” ÷ ıº∞¬È◊ÌœÓƒø––
    Call DeleteºÏ≤È ÷ ı ‰—™(lngRow)
    
    '÷ÿ–¬º”»Î∏Ωº” ÷ ı––º∞¬È◊ÌœÓƒø––
    strDataIDs = Trim(Replace(strDataIDs, ";", ","))
    If Left(strDataIDs, 1) = "," Then strDataIDs = Mid(strDataIDs, 2)
    If Right(strDataIDs, 1) = "," Then strDataIDs = Mid(strDataIDs, 1, Len(strDataIDs) - 1)
    
    If strDataIDs <> "" Then
        Set rsTmp = Get’Ô¡∆œÓƒøº«¬º(0, strDataIDs)
        If Not rsTmp.EOF Then
            arrIDs = Split(strDataIDs, ",")
            For i = 0 To UBound(arrIDs) '∞¥”√ªß ‰»ÎœÓƒøÀ≥–Ú
                rsTmp.Filter = "ID=" & CStr(arrIDs(i)) '≤ªø…ƒ‹EOF
                
                With vsAdvice
                    .AddItem "", lngRow + i + 1
                    .RowHidden(lngRow + i + 1) = True
                    
                    .RowData(lngRow + i + 1) = GetNext“Ω÷ˆID
                    .TextMatrix(lngRow + i + 1, COL_œ‡πÿID) = .RowData(lngRow)
                    
                    .TextMatrix(lngRow + i + 1, COL_EDIT) = 1 '–¬‘ˆ
                    
                    .TextMatrix(lngRow + i + 1, COL_”§∂˘) = cbo”§∂˘.ListIndex
                    .TextMatrix(lngRow + i + 1, COL_–Ú∫≈) = Val(.TextMatrix(lngRow, COL_–Ú∫≈)) + i + 1
                    .TextMatrix(lngRow + i + 1, COL_◊¥Ã¨) = 1 '–¬ø™
                    
                    .TextMatrix(lngRow + i + 1, COL_¿‡±) = rsTmp!¿‡±
                    .TextMatrix(lngRow + i + 1, COL_’Ô¡∆œÓƒøID) = rsTmp!ID
                    .Cell(flexcpData, lngRow + i + 1, COL_“Ω…˙÷ˆÕ–) = gclsInsure.GetItemInfo(mintœ’¿‡, mlng≤°»ÀID, 0, "", 0, "", .TextMatrix(lngRow + i + 1, COL_’Ô¡∆œÓƒøID))
                    
                    .TextMatrix(lngRow + i + 1, COL_º∆À„∑Ω Ω) = Nvl(rsTmp!º∆À„∑Ω Ω, 0)
                    .TextMatrix(lngRow + i + 1, COL_∆µ¬ –‘÷ ) = Nvl(rsTmp!÷¥––∆µ¬ , 0)
                    .TextMatrix(lngRow + i + 1, COL_≤Ÿ◊˜¿‡–Õ) = Nvl(rsTmp!≤Ÿ◊˜¿‡–Õ)
                    .TextMatrix(lngRow + i + 1, COL_µ•∂¿”¶”√) = Nvl(rsTmp!µ•∂¿”¶”√)
                    .TextMatrix(lngRow + i + 1, COL_÷¥––∑÷¿‡) = Nvl(rsTmp!÷¥––∑÷¿‡, 0)
                    .TextMatrix(lngRow + i + 1, COL_¥¶∑Ωœﬁ¡ø) = Nvl(rsTmp!¬º»Îœﬁ¡ø)
                    
                    .TextMatrix(lngRow + i + 1, COL_ ÷ ı ±º‰) = .TextMatrix(lngRow, COL_ ÷ ı ±º‰) ' ÷ ı/ ‰—™ ±º‰
                    .TextMatrix(lngRow + i + 1, col_“Ω÷ˆƒ⁄»›) = rsTmp!√˚≥∆
                    
                    .TextMatrix(lngRow + i + 1, COL_º∆º€–‘÷ ) = Nvl(rsTmp!º∆º€–‘÷ , 0)
                    
                    .TextMatrix(lngRow + i + 1, COL_µ•¡ø) = .TextMatrix(lngRow, COL_µ•¡ø)
                    .TextMatrix(lngRow + i + 1, COL_◊‹¡ø) = .TextMatrix(lngRow, COL_◊‹¡ø)
    
                    .TextMatrix(lngRow + i + 1, COL_÷¥–– ±º‰) = .TextMatrix(lngRow, COL_÷¥–– ±º‰)
                    .TextMatrix(lngRow + i + 1, COL_∆µ¬ ) = .TextMatrix(lngRow, COL_∆µ¬ )
                    .TextMatrix(lngRow + i + 1, COL_∆µ¬ ¥Œ ˝) = .TextMatrix(lngRow, COL_∆µ¬ ¥Œ ˝)
                    .TextMatrix(lngRow + i + 1, COL_∆µ¬ º‰∏Ù) = .TextMatrix(lngRow, COL_∆µ¬ º‰∏Ù)
                    .TextMatrix(lngRow + i + 1, COL_º‰∏Ùµ•Œª) = .TextMatrix(lngRow, COL_º‰∏Ùµ•Œª)
                    
                    '÷¥–––‘÷ :∏˘æ›œÓƒø◊‘…Ì…Ë÷√
                    .TextMatrix(lngRow + i + 1, COL_÷¥–––‘÷ ) = Nvl(rsTmp!÷¥––ø∆ “, 0)
                    
                    '∂£÷ˆ∫Õ‘∫Õ‚÷¥––Œﬁ÷¥––ø∆ “, ÷ ı¬È◊Ìµ•∂¿÷¥––ø∆ “
                    '∑Ò‘Ú≤ªπ‹∆‰÷¥––ø∆ “…Ë÷√,“ª∏ˆ ÷ ı◊È∫œ”¶∏√œ‡Õ¨
                    If InStr(",0,5,", Nvl(rsTmp!÷¥––ø∆ “, 0)) > 0 Then
                        .TextMatrix(lngRow + i + 1, COL_÷¥––ø∆ “ID) = 0
                    Else
                        If rsTmp!¿‡± = "G" Then
                            .TextMatrix(lngRow + i + 1, COL_÷¥––ø∆ “ID) = Get’Ô¡∆÷¥––ø∆ “ID(mlng≤°»ÀID, 0, rsTmp!¿‡±, rsTmp!ID, 0, _
                                Nvl(rsTmp!÷¥––ø∆ “, 0), mlng≤°»Àø∆ “id, Val(.TextMatrix(lngRow, COL_ø™÷ˆø∆ “ID)), 1, 1)
                        Else
                            .TextMatrix(lngRow + i + 1, COL_÷¥––ø∆ “ID) = .TextMatrix(lngRow, COL_÷¥––ø∆ “ID)
                        End If
                    End If
                    
                    .TextMatrix(lngRow + i + 1, COL_ø™ º ±º‰) = .TextMatrix(lngRow, COL_ø™ º ±º‰)
                    .Cell(flexcpData, lngRow + i + 1, COL_ø™ º ±º‰) = .Cell(flexcpData, lngRow, COL_ø™ º ±º‰)
                    
                    .TextMatrix(lngRow + i + 1, COL_ø™÷ˆø∆ “ID) = .TextMatrix(lngRow, COL_ø™÷ˆø∆ “ID)
                    .TextMatrix(lngRow + i + 1, COL_ø™÷ˆ“Ω…˙) = .TextMatrix(lngRow, COL_ø™÷ˆ“Ω…˙)
                    
                    .TextMatrix(lngRow + i + 1, COL_ø™÷ˆ ±º‰) = .TextMatrix(lngRow, COL_ø™÷ˆ ±º‰)
                    .Cell(flexcpData, lngRow + i + 1, COL_ø™÷ˆ ±º‰) = .Cell(flexcpData, lngRow, COL_ø™÷ˆ ±º‰)
                    
                    .TextMatrix(lngRow + i + 1, COL_±Í÷æ) = .TextMatrix(lngRow, COL_±Í÷æ)
                End With
            Next
                
            'µ˜’˚–Ú∫≈
            Call AdviceSet“Ω÷ˆ–Ú∫≈(lngRow + UBound(arrIDs) + 2, UBound(arrIDs) + 1)
        End If
    End If
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Function AdviceSet∏¯“©Õææ∂(ByVal lngRow As Long, ByVal lng∏¯“©Õææ∂ID As Long, _
    Optional ByVal str÷¥–––‘÷  As String, Optional ByVal lng∏¯“©÷¥––ID As Long, Optional ByVal strµŒÀŸ As String) As Long
'π¶ƒ‹£∫Œ™¬º»Îµƒ÷–£¨Œ˜≥…“©…Ë÷√∂‘”¶µƒ∏¯“©Õææ∂––(–¬‘ˆªÚ–ﬁ∏ƒ)
'≤Œ ˝£∫lngRow=“™¥¶¿Ì∏¯“©Õææ∂µƒ“©∆∑––
'      lng∏¯“©Õææ∂ID=∏¯“©Õææ∂ID
'      str÷¥–––‘÷ =–ﬁ∏ƒ∏¯“©Õææ∂ ±,µ±«∞ΩÁ√Ê…Ë÷√µƒ÷¥–––‘÷ 
'      lng∏¯“©÷¥––ID=–ﬁ∏ƒ∏¯“©Õææ∂ ±,µ±«∞ΩÁ√Ê…Ë÷√µƒ÷¥––ø∆ “
'      strµŒÀŸ=–ﬁ∏ƒ∏¯“©Õææ∂ ±,µ±«∞ΩÁ√Ê…Ë÷√µƒµŒÀŸ
'∑µªÿ£∫±ª…Ë÷√µƒ∏¯“©Õææ∂––µƒ“Ω÷ˆID
    Dim rsTmp As New ADODB.Recordset
    Dim strSQL As String, lngNewRow As Long
    Dim blnNew As Boolean
    
    On Error GoTo errH
    Set rsTmp = Get’Ô¡∆œÓƒøº«¬º(lng∏¯“©Õææ∂ID)
    If rsTmp.EOF Then lng∏¯“©Õææ∂ID = 0 '√ª”– ˝æ›£¨œ»…Ë÷√“‘±£≥÷πÿœµ
        
    With vsAdvice
        If Val(.TextMatrix(lngRow, COL_œ‡πÿID)) = 0 Then 'Œ¥…Ë÷√"œ‡πÿID" ±
            blnNew = True
            lngNewRow = lngRow + 1
            .AddItem "", lngNewRow
            .RowHidden(lngNewRow) = True
        Else
            '–ﬁ∏ƒ“Ω÷ˆµƒƒ⁄»› ±÷ÿ–¬…Ë÷√∏¯“©Õææ∂ƒ⁄»›(≤ª «∏¸ªª’Ô¡∆œÓƒø)
            blnNew = False
            lngNewRow = .FindRow(CLng(.TextMatrix(lngRow, COL_œ‡πÿID)), lngRow + 1)
        End If
        
        'Œﬁ–ßƒ⁄»›£∫√˚≥∆, ’∑—œ∏ƒøID,º¡¡øœµ ˝,√≈’Ôµ•Œª,√≈’Ô∞¸◊∞,±Í±æ≤øŒª,“Ω…˙÷ˆÕ–,µ•¡ø,◊‹¡ø,”√∑®
        If blnNew Then
            .RowData(lngNewRow) = GetNext“Ω÷ˆID
            .TextMatrix(lngNewRow, COL_EDIT) = 1 '–¬‘ˆ
            .TextMatrix(lngNewRow, COL_–Ú∫≈) = Val(.TextMatrix(lngRow, COL_–Ú∫≈)) + 1
        Else
            '“Ω÷ˆID(RowData),–Ú∫≈:±£≥÷≤ª±‰
            If InStr(",0,3,", .TextMatrix(lngNewRow, COL_EDIT)) > 0 Then
                .TextMatrix(lngNewRow, COL_EDIT) = 2 '±Í÷æŒ™ƒ⁄»›–ﬁ∏ƒ
                .TextMatrix(lngNewRow, COL_◊¥Ã¨) = 1 '–ﬁ∏ƒ∫Û±‰Œ™–¬ø™
            End If
        End If
        
        .TextMatrix(lngNewRow, COL_”§∂˘) = cbo”§∂˘.ListIndex
        .TextMatrix(lngNewRow, COL_◊¥Ã¨) = 1 '–¬ø™
        
        .TextMatrix(lngNewRow, COL_¿‡±) = "E" '∏¯“©Õææ∂ Ù”⁄÷Œ¡∆
        .TextMatrix(lngNewRow, COL_’Ô¡∆œÓƒøID) = lng∏¯“©Õææ∂ID
        '»Áπ˚√ª”–»∑∂®∏¯“©Õææ∂£¨‘› ±≤ª…Ë÷√µƒƒ⁄»›
        If Not rsTmp.EOF Then
            .TextMatrix(lngNewRow, COL_º∆À„∑Ω Ω) = Nvl(rsTmp!º∆À„∑Ω Ω, 0)
            .TextMatrix(lngNewRow, COL_∆µ¬ –‘÷ ) = Nvl(rsTmp!÷¥––∆µ¬ , 0)
            .TextMatrix(lngNewRow, COL_≤Ÿ◊˜¿‡–Õ) = Nvl(rsTmp!≤Ÿ◊˜¿‡–Õ)
            .TextMatrix(lngNewRow, COL_µ•∂¿”¶”√) = Nvl(rsTmp!µ•∂¿”¶”√)
            .TextMatrix(lngNewRow, COL_÷¥––∑÷¿‡) = Nvl(rsTmp!÷¥––∑÷¿‡, 0)
            .TextMatrix(lngNewRow, col_“Ω÷ˆƒ⁄»›) = rsTmp!√˚≥∆
            
            .TextMatrix(lngNewRow, COL_º∆º€–‘÷ ) = Nvl(rsTmp!º∆º€–‘÷ , 0)
            
            'µŒÀŸ
            If strµŒÀŸ <> "" Then
                .TextMatrix(lngNewRow, COL_“Ω…˙÷ˆÕ–) = strµŒÀŸ
            End If
            .Cell(flexcpData, lngNewRow, COL_“Ω…˙÷ˆÕ–) = gclsInsure.GetItemInfo(mintœ’¿‡, mlng≤°»ÀID, 0, "", 0, "", .TextMatrix(lngNewRow, COL_’Ô¡∆œÓƒøID))
            
            '÷¥–––‘÷ :»± °∏˘æ›œÓƒø…Ë÷√,–ﬁ∏ƒ ±∏˘æ›µ±«∞ΩÁ√Ê…Ë÷√
            If str÷¥–––‘÷  = "" Then
                .TextMatrix(lngNewRow, COL_÷¥–––‘÷ ) = Nvl(rsTmp!÷¥––ø∆ “, 0)
            Else
                .TextMatrix(lngNewRow, COL_÷¥–––‘÷ ) = Decode(str÷¥–––‘÷ , "¿Î‘∫¥¯“©", 5, Nvl(rsTmp!÷¥––ø∆ “, 0))
            End If
            
            '∏¯“©Õææ∂»Áπ˚Œ¥…Ë÷√÷¥––ø∆ “,‘Ú»± °Œ™≤°»ÀÀ˘‘⁄≤°«¯(√≈’Ô“™∏ƒŒ™≤°»ÀÀ˘‘⁄ø∆ “!!)
            If InStr(",0,5,", Val(.TextMatrix(lngNewRow, COL_÷¥–––‘÷ ))) = 0 Then
                If lng∏¯“©÷¥––ID <> 0 Then
                    .TextMatrix(lngNewRow, COL_÷¥––ø∆ “ID) = lng∏¯“©÷¥––ID
                Else
                    .TextMatrix(lngNewRow, COL_÷¥––ø∆ “ID) = Get’Ô¡∆÷¥––ø∆ “ID(mlng≤°»ÀID, 0, "E", lng∏¯“©Õææ∂ID, 0, _
                        Nvl(rsTmp!÷¥––ø∆ “, 0), mlng≤°»Àø∆ “id, Val(.TextMatrix(lngRow, COL_ø™÷ˆø∆ “ID)), 1, 1)
                End If
            Else
                .TextMatrix(lngNewRow, COL_÷¥––ø∆ “ID) = 0
            End If
        End If
        
        '∏¯“©Õææ∂ÃÏ ˝”Î“©∆∑œ‡Õ¨
        .TextMatrix(lngNewRow, COL_ÃÏ ˝) = .TextMatrix(lngRow, COL_ÃÏ ˝)
        
        .TextMatrix(lngNewRow, COL_∆µ¬ ) = .TextMatrix(lngRow, COL_∆µ¬ )
        .TextMatrix(lngNewRow, COL_∆µ¬ ¥Œ ˝) = .TextMatrix(lngRow, COL_∆µ¬ ¥Œ ˝)
        .TextMatrix(lngNewRow, COL_∆µ¬ º‰∏Ù) = .TextMatrix(lngRow, COL_∆µ¬ º‰∏Ù)
        .TextMatrix(lngNewRow, COL_º‰∏Ùµ•Œª) = .TextMatrix(lngRow, COL_º‰∏Ùµ•Œª)
        .TextMatrix(lngNewRow, COL_÷¥–– ±º‰) = .TextMatrix(lngRow, COL_÷¥–– ±º‰)
        
        .TextMatrix(lngNewRow, COL_ø™ º ±º‰) = .TextMatrix(lngRow, COL_ø™ º ±º‰)
        .Cell(flexcpData, lngNewRow, COL_ø™ º ±º‰) = .Cell(flexcpData, lngRow, COL_ø™ º ±º‰)
        
        .TextMatrix(lngNewRow, COL_ø™÷ˆø∆ “ID) = .TextMatrix(lngRow, COL_ø™÷ˆø∆ “ID)
        .TextMatrix(lngNewRow, COL_ø™÷ˆ“Ω…˙) = .TextMatrix(lngRow, COL_ø™÷ˆ“Ω…˙)
        
        .TextMatrix(lngNewRow, COL_ø™÷ˆ ±º‰) = .TextMatrix(lngRow, COL_ø™÷ˆ ±º‰)
        .Cell(flexcpData, lngNewRow, COL_ø™÷ˆ ±º‰) = .Cell(flexcpData, lngRow, COL_ø™÷ˆ ±º‰)
        
        .TextMatrix(lngNewRow, COL_±Í÷æ) = .TextMatrix(lngRow, COL_±Í÷æ)
        .TextMatrix(lngNewRow, COL_…Û∫À◊¥Ã¨) = .TextMatrix(lngRow, COL_…Û∫À◊¥Ã¨)
            
        'Õ˘∫Ûµ˜’˚–Ú∫≈
        If blnNew Then Call AdviceSet“Ω÷ˆ–Ú∫≈(lngNewRow + 1, 1)
        
        AdviceSet∏¯“©Õææ∂ = .RowData(lngNewRow)
    End With
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Function AdviceSet ‰—™Õææ∂(ByVal lngRow As Long, ByVal lng ‰—™Õææ∂ID As Long, Optional ByVal lng ‰—™÷¥––ID As Long) As Long
'π¶ƒ‹£∫Œ™¬º»Îµƒ÷–£¨Œ˜≥…“©…Ë÷√∂‘”¶µƒ∏¯“©Õææ∂––(–¬‘ˆªÚ–ﬁ∏ƒ)
'≤Œ ˝£∫lngRow=“™¥¶¿Ì ‰—™Õææ∂µƒ ‰—™“Ω÷ˆ––
'      lng ‰—™Õææ∂ID= ‰—™Õææ∂ID
'      lng ‰—™÷¥––ID=–ﬁ∏ƒ ‰—™Õææ∂ ±,µ±«∞ΩÁ√Ê…Ë÷√µƒ÷¥––ø∆ “
'∑µªÿ£∫±ª…Ë÷√µƒ ‰—™Õææ∂––µƒ“Ω÷ˆID
    Dim rsTmp As New ADODB.Recordset
    Dim strTmp As String, lngNewRow As Long
    Dim blnNew As Boolean
    
    On Error GoTo errH
    Set rsTmp = Get’Ô¡∆œÓƒøº«¬º(lng ‰—™Õææ∂ID)
    
    With vsAdvice
        lngNewRow = .FindRow(CStr(.RowData(lngRow)), lngRow + 1, COL_œ‡πÿID)
        If lngNewRow = -1 Then '…–Œ¥…Ë÷√ ‰—™Õææ∂ ±
            blnNew = True
            lngNewRow = lngRow + 1
            .AddItem "", lngNewRow
            .RowHidden(lngNewRow) = True
        End If
        
        'Œﬁ–ßƒ⁄»›£∫√˚≥∆, ’∑—œ∏ƒøID,º¡¡øœµ ˝,√≈’Ôµ•Œª,√≈’Ô∞¸◊∞,±Í±æ≤øŒª,“Ω…˙÷ˆÕ–,µ•¡ø,◊‹¡ø,”√∑®
        If blnNew Then
            .RowData(lngNewRow) = GetNext“Ω÷ˆID
            .TextMatrix(lngNewRow, COL_œ‡πÿID) = .RowData(lngRow)
            .TextMatrix(lngNewRow, COL_EDIT) = 1 '–¬‘ˆ
            .TextMatrix(lngNewRow, COL_–Ú∫≈) = Val(.TextMatrix(lngRow, COL_–Ú∫≈)) + 1
        Else
            '“Ω÷ˆID(RowData),–Ú∫≈:±£≥÷≤ª±‰
            If InStr(",0,3,", .TextMatrix(lngNewRow, COL_EDIT)) > 0 Then
                .TextMatrix(lngNewRow, COL_EDIT) = 2 '±Í÷æŒ™ƒ⁄»›–ﬁ∏ƒ
                .TextMatrix(lngNewRow, COL_◊¥Ã¨) = 1 '–ﬁ∏ƒ∫Û±‰Œ™–¬ø™
            End If
        End If
        
        .TextMatrix(lngNewRow, COL_”§∂˘) = cbo”§∂˘.ListIndex
        .TextMatrix(lngNewRow, COL_◊¥Ã¨) = 1 '–¬ø™
        
        .TextMatrix(lngNewRow, COL_¿‡±) = "E" ' ‰—™Õææ∂ Ù”⁄÷Œ¡∆
        .TextMatrix(lngNewRow, COL_’Ô¡∆œÓƒøID) = lng ‰—™Õææ∂ID
        .Cell(flexcpData, lngNewRow, COL_“Ω…˙÷ˆÕ–) = gclsInsure.GetItemInfo(mintœ’¿‡, mlng≤°»ÀID, 0, "", 0, "", .TextMatrix(lngNewRow, COL_’Ô¡∆œÓƒøID))
        
        .TextMatrix(lngNewRow, COL_º∆À„∑Ω Ω) = Nvl(rsTmp!º∆À„∑Ω Ω, 0)
        .TextMatrix(lngNewRow, COL_≤Ÿ◊˜¿‡–Õ) = Nvl(rsTmp!≤Ÿ◊˜¿‡–Õ)
        .TextMatrix(lngNewRow, COL_µ•∂¿”¶”√) = Nvl(rsTmp!µ•∂¿”¶”√)
        .TextMatrix(lngNewRow, COL_÷¥––∑÷¿‡) = Nvl(rsTmp!÷¥––∑÷¿‡, 0)
        .TextMatrix(lngNewRow, col_“Ω÷ˆƒ⁄»›) = rsTmp!√˚≥∆
        
        .TextMatrix(lngNewRow, COL_º∆º€–‘÷ ) = Nvl(rsTmp!º∆º€–‘÷ , 0)
        .TextMatrix(lngNewRow, COL_÷¥–––‘÷ ) = Nvl(rsTmp!÷¥––ø∆ “, 0)
        
        If InStr(",0,5,", Val(.TextMatrix(lngNewRow, COL_÷¥–––‘÷ ))) = 0 Then
            If lng ‰—™÷¥––ID <> 0 Then
                .TextMatrix(lngNewRow, COL_÷¥––ø∆ “ID) = lng ‰—™÷¥––ID
            Else
                .TextMatrix(lngNewRow, COL_÷¥––ø∆ “ID) = Get’Ô¡∆÷¥––ø∆ “ID(mlng≤°»ÀID, 0, "E", lng ‰—™Õææ∂ID, 0, _
                    Nvl(rsTmp!÷¥––ø∆ “, 0), mlng≤°»Àø∆ “id, Val(.TextMatrix(lngRow, COL_ø™÷ˆø∆ “ID)), 1, 1)
            End If
        Else
            .TextMatrix(lngNewRow, COL_÷¥––ø∆ “ID) = 0
        End If
        
        .TextMatrix(lngNewRow, COL_∆µ¬ –‘÷ ) = .TextMatrix(lngRow, COL_∆µ¬ –‘÷ ) '“‘“©∆∑µƒŒ™◊º
        .TextMatrix(lngNewRow, COL_∆µ¬ ) = .TextMatrix(lngRow, COL_∆µ¬ )
        .TextMatrix(lngNewRow, COL_∆µ¬ ¥Œ ˝) = .TextMatrix(lngRow, COL_∆µ¬ ¥Œ ˝)
        .TextMatrix(lngNewRow, COL_∆µ¬ º‰∏Ù) = .TextMatrix(lngRow, COL_∆µ¬ º‰∏Ù)
        .TextMatrix(lngNewRow, COL_º‰∏Ùµ•Œª) = .TextMatrix(lngRow, COL_º‰∏Ùµ•Œª)
        .TextMatrix(lngNewRow, COL_÷¥–– ±º‰) = .TextMatrix(lngRow, COL_÷¥–– ±º‰)
        .TextMatrix(lngNewRow, COL_…Û∫À◊¥Ã¨) = .TextMatrix(lngRow, COL_…Û∫À◊¥Ã¨)
        
        .TextMatrix(lngNewRow, COL_ø™ º ±º‰) = .TextMatrix(lngRow, COL_ø™ º ±º‰)
        .Cell(flexcpData, lngNewRow, COL_ø™ º ±º‰) = .Cell(flexcpData, lngRow, COL_ø™ º ±º‰)
        
        .TextMatrix(lngNewRow, COL_ø™÷ˆø∆ “ID) = .TextMatrix(lngRow, COL_ø™÷ˆø∆ “ID)
        .TextMatrix(lngNewRow, COL_ø™÷ˆ“Ω…˙) = .TextMatrix(lngRow, COL_ø™÷ˆ“Ω…˙)
        
        .TextMatrix(lngNewRow, COL_ø™÷ˆ ±º‰) = .TextMatrix(lngRow, COL_ø™÷ˆ ±º‰)
        .Cell(flexcpData, lngNewRow, COL_ø™÷ˆ ±º‰) = .Cell(flexcpData, lngRow, COL_ø™÷ˆ ±º‰)
        
        .TextMatrix(lngNewRow, COL_±Í÷æ) = .TextMatrix(lngRow, COL_±Í÷æ)
            
        'Õ˘∫Ûµ˜’˚–Ú∫≈
        If blnNew Then Call AdviceSet“Ω÷ˆ–Ú∫≈(lngNewRow + 1, 1)
        
        AdviceSet ‰—™Õææ∂ = .RowData(lngNewRow)
        
        '∏˙æ› ‰—™Õææ∂¿¥÷ÿ…Ë ‰—™“Ω÷ˆµƒ…Û∫À◊¥Ã¨
        strTmp = GetBloodState(IIF(Val(.TextMatrix(lngNewRow, COL_±Í÷æ)) = 1, 1, 0), Val(.TextMatrix(lngNewRow, COL_÷¥––∑÷¿‡)))
        
        .TextMatrix(lngNewRow, COL_…Û∫À◊¥Ã¨) = strTmp
        .TextMatrix(lngRow, COL_…Û∫À◊¥Ã¨) = strTmp
        Call SetRow±Í÷æÕº±Í(lngRow, 2)
    End With
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Sub AdviceChange()
'π¶ƒ‹£∫∏˘æ›µ±«∞“Ω÷ˆø®∆¨÷–µƒƒ⁄»›£¨∏¸–¬µ±«∞“Ω÷ˆƒ⁄»›
'Àµ√˜£∫∂‘”⁄ListIndex=-1∂¯∂‘”¶“Ω÷ˆœÓ”÷”–ƒ⁄»›µƒ£¨±£≥÷‘≠ƒ⁄»›≤ª∏¸–¬
    Dim lngRow As Long, lngBeginRow As Long, lngEndRow As Long
    Dim int∆µ¬ ¥Œ ˝ As Integer, int∆µ¬ º‰∏Ù As Integer, strº‰∏Ùµ•Œª As String
    Dim blnCurDo As Boolean, blnOtherDo As Boolean
    Dim lngTmp As Long, strTmp As String, blnTmp As Boolean
    Dim strCurDate As String, lngø™÷ˆø∆ “ID As Long
    Dim blnReInRow As Boolean, i As Long, j As Long
    Dim lng÷¥––ø∆ “ID As Long, lngBegin As Long, lngEnd As Long
    Dim blnReSet≥¨¡øÀµ√˜ As Boolean
    Dim dbl◊‹¡ø As Double
    
    With vsAdvice
        lngRow = .Row
        
        If .RowData(lngRow) = 0 Then Call ClearItemTag: Exit Sub '«Â≥˝±‡º≠±Í÷æ
        
        If RowIn≈‰∑Ω––(lngRow) Then
            '÷–“©≈‰∑Ω
            lngBeginRow = .FindRow(CStr(.RowData(lngRow)), , COL_œ‡πÿID)
            For i = lngBeginRow To lngRow
                '–ﬁ∏ƒ¥¶¿Ì≈‰∑ΩµƒÀ˘”–––ƒ⁄»›(∞¸¿®ºÂ∑®∫Õ”√∑®)
                If IsDate(txtø™ º ±º‰.Text) And txtø™ º ±º‰.Tag <> "" Then
                    .TextMatrix(i, COL_ø™ º ±º‰) = Format(txtø™ º ±º‰.Text, "yyyy-MM-dd HH:mm")
                    .Cell(flexcpData, i, COL_ø™ º ±º‰) = txtø™ º ±º‰.Text
                    blnCurDo = True
                End If
                If chkΩÙº±.Visible And chkΩÙº±.Tag <> "" Then
                    .TextMatrix(i, COL_±Í÷æ) = chkΩÙº±.value
                    If i = lngRow Then '”√∑®––œ‘ æΩÙº±±Í÷æ
                         Call SetRow±Í÷æÕº±Í(i, 0)
                    End If
                    blnCurDo = True
                End If
                If txt◊‹¡ø.Enabled And txt◊‹¡ø.Tag <> "" Then
                    .TextMatrix(i, COL_◊‹¡ø) = FormatEx(IIF(Val(txt◊‹¡ø.Text) = 0, "", Val(txt◊‹¡ø.Text)), 5)
                    
                    '◊‹¡ø±‰¡À£¨–Ë“™∏˘æ› «∑Ò≥¨¡ø…Ë÷√≥¨¡øÀµ√˜µƒø…”√–‘
                    blnReSet≥¨¡øÀµ√˜ = True
                    blnCurDo = True
                End If
                If txt∆µ¬ .Enabled And cmd∆µ¬ .Tag <> "" And txt∆µ¬ .Tag <> "" Then
                    .TextMatrix(i, COL_∆µ¬ ) = txt∆µ¬ .Text
                    Call Get∆µ¬ –≈œ¢_√˚≥∆(txt∆µ¬ .Text, int∆µ¬ ¥Œ ˝, int∆µ¬ º‰∏Ù, strº‰∏Ùµ•Œª, 2) '÷–“Ω∑∂Œß
                    .TextMatrix(i, COL_∆µ¬ ¥Œ ˝) = int∆µ¬ ¥Œ ˝
                    .TextMatrix(i, COL_∆µ¬ º‰∏Ù) = int∆µ¬ º‰∏Ù
                    .TextMatrix(i, COL_º‰∏Ùµ•Œª) = strº‰∏Ùµ•Œª
                    blnCurDo = True
                End If
                If cbo÷¥–– ±º‰.Tag <> "" Then
                    .TextMatrix(i, COL_÷¥–– ±º‰) = cbo÷¥–– ±º‰.Text
                    blnCurDo = True
                End If
                
                If .TextMatrix(i, COL_¿‡±) = "7" Then
                    '∏¸∏ƒµƒ «◊È≥…÷–“©µƒ÷¥––ø∆ “(”√∑®ºÂ∑®µƒ∏ƒ≤ªµΩ)
                    If cbo÷¥––ø∆ “.ListIndex <> -1 And cbo÷¥––ø∆ “.Tag <> "" Then
                        .TextMatrix(i, COL_÷¥––ø∆ “ID) = cbo÷¥––ø∆ “.ItemData(cbo÷¥––ø∆ “.ListIndex)
                        blnCurDo = True
                    End If
                    
                    '÷¥–––‘÷ :≈‰∑Ω÷–À˘”–◊È≥…µƒ÷–“©œ‡Õ¨
                    If cbo÷¥–––‘÷ .Tag <> "" Then
                        .TextMatrix(i, COL_÷¥–––‘÷ ) = Decode(NeedName(cbo÷¥–––‘÷ .Text), "◊‘±∏“©", 5, 4)
                        If Val(.TextMatrix(i, COL_÷¥–––‘÷ )) = 5 Then
                            .TextMatrix(i, COL_÷¥––ø∆ “ID) = 0
                        ElseIf Val(.TextMatrix(i, COL_÷¥––ø∆ “ID)) = 0 Then
                            'ª÷∏¥»± °÷¥––ø∆ “,»± °”Î«∞√Êœ‡Õ¨
                            If i = lngBeginRow Then
                                For j = i - 1 To .FixedRows Step -1
                                    If .TextMatrix(j, COL_¿‡±) = "7" And Val(.TextMatrix(j, COL_÷¥––ø∆ “ID)) <> 0 Then
                                        .TextMatrix(i, COL_÷¥––ø∆ “ID) = .TextMatrix(j, COL_÷¥––ø∆ “ID)
                                        Exit For
                                    End If
                                Next
                                If Val(.TextMatrix(i, COL_÷¥––ø∆ “ID)) = 0 Then
                                    .TextMatrix(i, COL_÷¥––ø∆ “ID) = Get’Ô¡∆÷¥––ø∆ “ID(mlng≤°»ÀID, 0, .TextMatrix(i, COL_¿‡±), Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID)), Val(.TextMatrix(i, COL_ ’∑—œ∏ƒøID)), 4, mlng≤°»Àø∆ “id, 0, 1, 1, True)
                                End If
                            Else
                                .TextMatrix(i, COL_÷¥––ø∆ “ID) = .TextMatrix(lngBeginRow, COL_÷¥––ø∆ “ID)
                            End If
                        End If
                        blnReInRow = True 'ΩÁ√Ê÷¥––ø∆ “±‡º≠–‘±‰ªØ
                        blnCurDo = True
                    End If
                End If
                
                '–ﬁ∏ƒ ±◊‘∂Ø∏¸–¬≤ø∑›ƒ⁄»›
                blnTmp = False
                If cbo“Ω…˙÷ˆÕ–.Tag <> "" Or cbo÷¥–––‘÷ .Tag <> "" _
                    Or (Val(cmd”√∑®.Tag) <> 0 And txt”√∑®.Tag <> "") Then
                    blnTmp = True
                End If
                If blnCurDo Or blnTmp Then
                    '–ﬁ∏ƒ¡Àƒ⁄»›‘Ú∏¸–¬ø™÷ˆ ±º‰
                    If strCurDate = "" Then
                        strCurDate = Format(zlDatabase.Currentdate, "yyyy-MM-dd HH:mm")
                    End If
                    .TextMatrix(i, COL_ø™÷ˆ ±º‰) = Format(strCurDate, "yyyy-MM-dd HH:mm")
                    .Cell(flexcpData, i, COL_ø™÷ˆ ±º‰) = strCurDate
                    
                    'ºÏ≤Èø™÷ˆ“Ω…˙
                    If .TextMatrix(i, COL_ø™÷ˆ“Ω…˙) <> UserInfo.–’√˚ Then
                        .TextMatrix(i, COL_ø™÷ˆ“Ω…˙) = UserInfo.–’√˚
                        If lngø™÷ˆø∆ “ID = 0 Then
                            lngø™÷ˆø∆ “ID = Getø™÷ˆø∆ “ID(UserInfo.ID, mlng“Ωººø∆ “ID, mlng≤°»Àø∆ “id, 1)
                        End If
                        .TextMatrix(i, COL_ø™÷ˆø∆ “ID) = lngø™÷ˆø∆ “ID
                    End If
                End If
                                                    
                If .TextMatrix(i, COL_¿‡±) = "E" And i <> lngRow Then lngTmp = i 'ºÂ∑®––∫≈
                                                    
                '---------------
                If blnCurDo Then '±Íº«Œ™–ﬁ∏ƒ:0-‘≠ ºµƒ,1-–¬‘ˆµƒ,2-–ﬁ∏ƒ¡Àƒ⁄»›,3-–ﬁ∏ƒ¡À–Ú∫≈
                    If InStr(",0,3,", .TextMatrix(i, COL_EDIT)) > 0 Then
                        .TextMatrix(i, COL_EDIT) = 2
                        .TextMatrix(i, COL_◊¥Ã¨) = 1 '–ﬁ∏ƒ∫Û±‰Œ™–¬ø™
                        If Not .RowHidden(i) Then Call ReSetColor(i) '”√∑®––≤≈…Ë÷√
                    End If
                    mblnNoSave = True '±Íº«Œ™Œ¥±£¥Ê
                End If
            Next
            
            '…Êº∞÷–“©”√∑®––µƒƒ⁄»›:÷±Ω”∏¸∏ƒµ±«∞––µƒƒ⁄»›(ºÂ∑®––‘⁄≈‰∑Ω±‡º≠÷–≤≈ƒ‹∏ƒ)
            '-----------------------------------------------------------
            blnCurDo = False
                    
            '“Ω…˙÷ˆÕ–: «∑≈‘⁄÷–“©”√∑®––(œ‘ æ––)÷–µƒ
            If cbo“Ω…˙÷ˆÕ–.Tag <> "" Then
                .TextMatrix(lngRow, COL_“Ω…˙÷ˆÕ–) = cbo“Ω…˙÷ˆÕ–.Text
                blnCurDo = True
            End If
        
            '÷–“©”√∑®
            If Val(cmd”√∑®.Tag) <> 0 And txt”√∑®.Tag <> "" Then
                .TextMatrix(lngRow, COL_’Ô¡∆œÓƒøID) = Val(cmd”√∑®.Tag)
                .TextMatrix(lngRow, COL_”√∑®) = txt”√∑®.Text
                
                'Õ¨ ±∏¸∏ƒº∆º€–‘÷ ∫Õ÷¥–––‘÷ 
                .TextMatrix(lngRow, COL_º∆º€–‘÷ ) = Nvl(GetItemField("’Ô¡∆œÓƒøƒø¬º", Val(cmd”√∑®.Tag), "º∆º€–‘÷ "), 0)
                i = Nvl(GetItemField("’Ô¡∆œÓƒøƒø¬º", Val(cmd”√∑®.Tag), "÷¥––ø∆ “"), 0)
                .TextMatrix(lngRow, COL_÷¥–––‘÷ ) = Decode(NeedName(cbo÷¥–––‘÷ .Text), "¿Î‘∫¥¯“©", 5, i)
                If Val(.TextMatrix(lngRow, COL_÷¥–––‘÷ )) = 5 Then
                    .TextMatrix(lngRow, COL_÷¥––ø∆ “ID) = 0
                Else
                    .TextMatrix(lngRow, COL_÷¥––ø∆ “ID) = Get’Ô¡∆÷¥––ø∆ “ID(mlng≤°»ÀID, 0, "E", Val(cmd”√∑®.Tag), 0, _
                        Val(.TextMatrix(lngRow, COL_÷¥–––‘÷ )), mlng≤°»Àø∆ “id, Val(.TextMatrix(lngRow, COL_ø™÷ˆø∆ “ID)), 1, 1)
                End If
                
                blnReInRow = True '–Ë“™À¢–¬÷–“©”√∑®÷¥––ø∆ “
                blnCurDo = True
            End If
            
            '”√∑®∫ÕºÂ∑®µƒ÷¥–––‘÷ 
            If cbo÷¥–––‘÷ .Tag <> "" Then
                '”√∑®
                i = Nvl(GetItemField("’Ô¡∆œÓƒøƒø¬º", Val(.TextMatrix(lngRow, COL_’Ô¡∆œÓƒøID)), "÷¥––ø∆ “"), 0)
                .TextMatrix(lngRow, COL_÷¥–––‘÷ ) = Decode(NeedName(cbo÷¥–––‘÷ .Text), "¿Î‘∫¥¯“©", 5, i)
                If Val(.TextMatrix(lngRow, COL_÷¥–––‘÷ )) = 5 Then
                    .TextMatrix(lngRow, COL_÷¥––ø∆ “ID) = 0
                Else
                    .TextMatrix(lngRow, COL_÷¥––ø∆ “ID) = Get’Ô¡∆÷¥––ø∆ “ID(mlng≤°»ÀID, 0, .TextMatrix(lngRow, COL_¿‡±), _
                        Val(.TextMatrix(lngRow, COL_’Ô¡∆œÓƒøID)), 0, Val(.TextMatrix(lngRow, COL_÷¥–––‘÷ )), _
                        mlng≤°»Àø∆ “id, Val(Val(.TextMatrix(lngRow, COL_ø™÷ˆø∆ “ID))), 1, 1)
                End If
                
                'ºÂ∑®
                i = Nvl(GetItemField("’Ô¡∆œÓƒøƒø¬º", Val(.TextMatrix(lngTmp, COL_’Ô¡∆œÓƒøID)), "÷¥––ø∆ “"), 0)
                .TextMatrix(lngTmp, COL_÷¥–––‘÷ ) = Decode(NeedName(cbo÷¥–––‘÷ .Text), "¿Î‘∫¥¯“©", 5, i)
                If Val(.TextMatrix(lngTmp, COL_÷¥–––‘÷ )) = 5 Then
                    .TextMatrix(lngTmp, COL_÷¥––ø∆ “ID) = 0
                Else
                    .TextMatrix(lngTmp, COL_÷¥––ø∆ “ID) = Get’Ô¡∆÷¥––ø∆ “ID(mlng≤°»ÀID, 0, .TextMatrix(lngTmp, COL_¿‡±), _
                        Val(.TextMatrix(lngTmp, COL_’Ô¡∆œÓƒøID)), 0, Val(.TextMatrix(lngTmp, COL_÷¥–––‘÷ )), _
                        mlng≤°»Àø∆ “id, Val(.TextMatrix(lngTmp, COL_ø™÷ˆø∆ “ID)), 1, 1)
                End If
                
                If InStr(",0,3,", .TextMatrix(lngTmp, COL_EDIT)) > 0 Then
                    .TextMatrix(lngTmp, COL_EDIT) = 2
                    .TextMatrix(lngTmp, COL_◊¥Ã¨) = 1 '–ﬁ∏ƒ∫Û±‰Œ™–¬ø™
                End If
                mblnNoSave = True '±Íº«Œ™Œ¥±£¥Ê
                
                blnCurDo = True
            End If
            
            '÷–“©”√∑®÷¥––ø∆ “:º¥≈‰∑Ωµ±«∞œ‘ æ––µƒ÷¥––ø∆ “
            If cbo∏Ωº”÷¥––.ListIndex <> -1 And cbo∏Ωº”÷¥––.Tag <> "" Then
                .TextMatrix(lngRow, COL_÷¥––ø∆ “ID) = cbo∏Ωº”÷¥––.ItemData(cbo∏Ωº”÷¥––.ListIndex)
                blnCurDo = True
            End If
            
            Call Set”√“©ÃÏ ˝ «∑Ò≥¨∆⁄(lngRow)
            
        Else '∆‰À¸’Ô¡∆œÓƒø
            If IsDate(txtø™ º ±º‰.Text) And txtø™ º ±º‰.Tag <> "" Then
                .TextMatrix(lngRow, COL_ø™ º ±º‰) = Format(txtø™ º ±º‰.Text, "yyyy-MM-dd HH:mm")
                .Cell(flexcpData, lngRow, COL_ø™ º ±º‰) = txtø™ º ±º‰.Text
                blnCurDo = True
            End If
            If IsDate(txt∞≤≈≈ ±º‰.Text) And txt∞≤≈≈ ±º‰.Tag <> "" Then
                .TextMatrix(lngRow, COL_ ÷ ı ±º‰) = txt∞≤≈≈ ±º‰.Text
                blnCurDo = True
            End If
            '√‚ ‘±Íº«
            If chk√‚ ‘.Visible And chk√‚ ‘.Tag <> "" Then
                .TextMatrix(lngRow, COL_√‚ ‘) = chk√‚ ‘.value
                blnCurDo = True
            End If
            
            If chkΩÙº±.Visible And chkΩÙº±.Tag <> "" Then
                .TextMatrix(lngRow, COL_±Í÷æ) = chkΩÙº±.value
                
                '∫Û√Ê¥¶¿Ì“ª≤¢∏¯“©÷–µƒ∆‰À˚––£¨¥˝…Û∫Àµƒ∏ƒŒ™Œﬁ–Ë…Û∫À
                If Not (.TextMatrix(lngRow, COL_¿‡±) = "K") Then
                    If chkΩÙº±.value = 1 Then
                        If Val(.TextMatrix(lngRow, COL_…Û∫À◊¥Ã¨)) = 1 Then .TextMatrix(lngRow, COL_…Û∫À◊¥Ã¨) = ""
                    Else
                        If gblnKSSStrict And UserInfo.”√“©º∂± < Val(.TextMatrix(lngRow, COL_øπæ˙µ»º∂)) Then .TextMatrix(lngRow, COL_…Û∫À◊¥Ã¨) = 1
                    End If
                End If
                If (gbln ‰—™∑÷º∂π‹¿Ì Or gbln—™ø‚œµÕ≥) And .TextMatrix(lngRow, COL_¿‡±) = "K" Then
                    blnReInRow = True
                End If
                'œ‘ æΩÙº±±Í÷æ,“ª≤¢∏¯“©œ‘ æ‘⁄µ⁄“ª––
                Call SetRow±Í÷æÕº±Í(lngRow, 0)
                                
                blnCurDo = True
            End If
            If txtµ•¡ø.Enabled And (IsNumeric(txtµ•¡ø.Text) Or txtµ•¡ø.Text = "") And txtµ•¡ø.Tag <> "" Then
                .TextMatrix(lngRow, COL_µ•¡ø) = FormatEx(txtµ•¡ø.Text, 5)
                If Not mblnÃÏ ˝ Then Call Set”√“©ÃÏ ˝ «∑Ò≥¨∆⁄(lngRow): blnReSet≥¨¡øÀµ√˜ = True
                               
                blnCurDo = True
            End If
            
            If txtÃÏ ˝.Visible And txtÃÏ ˝.Enabled And txtÃÏ ˝.Tag <> "" Then
                .TextMatrix(lngRow, COL_ÃÏ ˝) = txtÃÏ ˝.Text
                
                If Val(txtÃÏ ˝.Text) > IIF(mbytPatiType = 1, conOrdinary, conEmergency) Then
                    .TextMatrix(lngRow, COL_ «∑Ò≥¨∆⁄) = "1"
                Else
                    .TextMatrix(lngRow, COL_ «∑Ò≥¨∆⁄) = ""
                End If
                blnReSet≥¨¡øÀµ√˜ = True
                
                blnCurDo = True
            End If
            
            If txt◊‹¡ø.Enabled And (IsNumeric(txt◊‹¡ø.Text) Or txt◊‹¡ø.Text = "") And txt◊‹¡ø.Tag <> "" Then
                .TextMatrix(lngRow, COL_◊‹¡ø) = FormatEx(txt◊‹¡ø.Text, 5)
                If Not mblnÃÏ ˝ Then Call Set”√“©ÃÏ ˝ «∑Ò≥¨∆⁄(lngRow)
                
                '◊‹¡ø±‰ªØ–Ë…Ë÷√≥¨¡øÀµ√˜µƒø…”√–‘
                blnReSet≥¨¡øÀµ√˜ = True
                               
                blnCurDo = True
            End If
            
            If txt∆µ¬ .Enabled And cmd∆µ¬ .Tag <> "" And txt∆µ¬ .Tag <> "" Then
                .TextMatrix(lngRow, COL_∆µ¬ ) = txt∆µ¬ .Text
                Call Get∆µ¬ –≈œ¢_√˚≥∆(txt∆µ¬ .Text, int∆µ¬ ¥Œ ˝, int∆µ¬ º‰∏Ù, strº‰∏Ùµ•Œª, Get∆µ¬ ∑∂Œß(lngRow))
                .TextMatrix(lngRow, COL_∆µ¬ ¥Œ ˝) = int∆µ¬ ¥Œ ˝
                .TextMatrix(lngRow, COL_∆µ¬ º‰∏Ù) = int∆µ¬ º‰∏Ù
                .TextMatrix(lngRow, COL_º‰∏Ùµ•Œª) = strº‰∏Ùµ•Œª
                
                If Not mblnÃÏ ˝ Then Call Set”√“©ÃÏ ˝ «∑Ò≥¨∆⁄(lngRow): blnReSet≥¨¡øÀµ√˜ = True
                
                blnCurDo = True
            End If
            
            If cbo÷¥–– ±º‰.Tag <> "" Then
                .TextMatrix(lngRow, COL_÷¥–– ±º‰) = cbo÷¥–– ±º‰.Text
                blnCurDo = True
            End If
            If cbo“Ω…˙÷ˆÕ–.Tag <> "" Then
                .TextMatrix(lngRow, COL_“Ω…˙÷ˆÕ–) = cbo“Ω…˙÷ˆÕ–.Text
                blnCurDo = True
            End If
            
            If cbo÷¥––ø∆ “.ListIndex <> -1 And cbo÷¥––ø∆ “.Tag <> "" Then
                If Not RowInºÏ—È––(lngRow) Then '≤…ºØ∑Ω∑®µƒ÷¥––ø∆ “≤ªÕ¨
                    .TextMatrix(lngRow, COL_÷¥––ø∆ “ID) = cbo÷¥––ø∆ “.ItemData(cbo÷¥––ø∆ “.ListIndex)
                End If
                blnCurDo = True
            End If
            
            
            '”√“©ƒøµƒ∫Õ¿Ì”…
            If lbl”√“©ƒøµƒ.Tag <> "" Then
                .TextMatrix(lngRow, COL_”√“©ƒøµƒ) = cboDruPur.ListIndex
                blnCurDo = True
            End If
            If txt”√“©¿Ì”….Tag <> "" Then
                .TextMatrix(lngRow, COL_”√“©¿Ì”…) = Trim(txt”√“©¿Ì”….Text)
                blnCurDo = True
            End If
            
            'µŒÀŸ£∫ ‰“∫“©∆∑
            If cboµŒÀŸ.Tag <> "" Then
                lngTmp = .FindRow(CLng(.TextMatrix(lngRow, COL_œ‡πÿID)), lngRow + 1)
                If lngTmp <> -1 Then
                    If cboµŒÀŸ.Text <> "" Then
                        .TextMatrix(lngTmp, COL_“Ω…˙÷ˆÕ–) = cboµŒÀŸ.Text & lblµŒÀŸµ•Œª.Caption
                    Else
                        .TextMatrix(lngTmp, COL_“Ω…˙÷ˆÕ–) = ""
                    End If
                    If InStr(",0,3,", .TextMatrix(lngTmp, COL_EDIT)) > 0 Then
                        .TextMatrix(lngTmp, COL_EDIT) = 2
                        .TextMatrix(lngTmp, COL_◊¥Ã¨) = 1 '–ﬁ∏ƒ∫Û±‰Œ™–¬ø™
                    End If
                    'mblnNoSave = True '±Íº«Œ™Œ¥±£¥Ê
                    blnCurDo = True
                End If
                'œ‘ æ∏¯“©Õææ∂
                If cboµŒÀŸ.Text <> "" Then
                    .TextMatrix(lngRow, COL_”√∑®) = txt”√∑®.Text & cboµŒÀŸ.Text & lblµŒÀŸµ•Œª.Caption
                Else
                    .TextMatrix(lngRow, COL_”√∑®) = txt”√∑®.Text
                End If
            End If
            
            '∏Ωº”÷¥––ø∆ “£∫∏¯“©Õææ∂, ÷ ı¬È◊Ì,≤…ºØ∑Ω∑®£¨‘≠“∫∆§ ‘œÓƒø
            If cbo∏Ωº”÷¥––.ListIndex <> -1 And cbo∏Ωº”÷¥––.Tag <> "" Then
                lngTmp = -1
                If InStr(",5,6,", .TextMatrix(lngRow, COL_¿‡±)) > 0 Then
                    lngTmp = .FindRow(CLng(.TextMatrix(lngRow, COL_œ‡πÿID)), lngRow + 1)
                ElseIf .TextMatrix(lngRow, COL_¿‡±) = "E" And .TextMatrix(lngRow, COL_≤Ÿ◊˜¿‡–Õ) = "1" And .TextMatrix(lngRow, COL_÷¥––∑÷¿‡) = "5" Then
                    lngTmp = lngRow '‘≠“∫∆§ ‘œÓƒø
                ElseIf .TextMatrix(lngRow, COL_¿‡±) = "F" Then
                    For i = lngRow + 1 To .Rows - 1
                        If Val(.TextMatrix(i, COL_œ‡πÿID)) = .RowData(lngRow) Then
                            If .TextMatrix(i, COL_¿‡±) = "G" Then
                                lngTmp = i: Exit For
                            End If
                        Else
                            Exit For
                        End If
                    Next
                ElseIf .TextMatrix(lngRow, COL_¿‡±) = "E" _
                    And .TextMatrix(lngRow - 1, COL_¿‡±) = "C" _
                    And Val(.TextMatrix(lngRow - 1, COL_œ‡πÿID)) = .RowData(lngRow) Then
                    lngTmp = lngRow
                ElseIf .TextMatrix(lngRow, COL_¿‡±) = "K" _
                    And .TextMatrix(lngRow + 1, COL_¿‡±) = "E" _
                    And Val(.TextMatrix(lngRow + 1, COL_œ‡πÿID)) = .RowData(lngRow) Then
                    lngTmp = lngRow + 1
                End If
                
                '÷ª∏¸–¬∂‘”¶––,≤ª”∞œÏ∆‰À¸––
                If lngTmp <> -1 Then
                    '‘≠“∫∆§ ‘
                    If Not (.TextMatrix(lngRow, COL_¿‡±) = "E" And .TextMatrix(lngRow, COL_≤Ÿ◊˜¿‡–Õ) = "1" And .TextMatrix(lngRow, COL_÷¥––∑÷¿‡) = "5") Then
                        .TextMatrix(lngTmp, COL_÷¥––ø∆ “ID) = cbo∏Ωº”÷¥––.ItemData(cbo∏Ωº”÷¥––.ListIndex)
                    End If
                    
                    If InStr(",0,3,", .TextMatrix(lngTmp, COL_EDIT)) > 0 Then
                        .TextMatrix(lngTmp, COL_EDIT) = 2
                        .TextMatrix(lngTmp, COL_◊¥Ã¨) = 1 '–ﬁ∏ƒ∫Û±‰Œ™–¬ø™
                    End If
                    'mblnNoSave = True '±Íº«Œ™Œ¥±£¥Ê
                    blnCurDo = True
                End If
            End If
            
            '‘≠“∫∆§ ‘œÓƒøø…“‘≤ª÷∏∂®∏Ωº”µƒ“©∑øø∆ “
            If cbo∏Ωº”÷¥––.Tag <> "" Then
                If .TextMatrix(lngRow, COL_¿‡±) = "E" And .TextMatrix(lngRow, COL_≤Ÿ◊˜¿‡–Õ) = "1" And .TextMatrix(lngRow, COL_÷¥––∑÷¿‡) = "5" Then
                    lngTmp = lngRow
                    If InStr(",0,3,", .TextMatrix(lngTmp, COL_EDIT)) > 0 Then
                        .TextMatrix(lngTmp, COL_EDIT) = 2
                        .TextMatrix(lngTmp, COL_◊¥Ã¨) = 1 '–ﬁ∏ƒ∫Û±‰Œ™–¬ø™
                    End If
                    'mblnNoSave = True '±Íº«Œ™Œ¥±£¥Ê
                    blnCurDo = True
                End If
            End If
            
            '÷¥–––‘÷ ,∏¯“©Õææ∂:Œ™∏¸–¬ø™÷ˆ ±º‰(∞¸¿®∏¯“©Õææ∂µƒÕ¨≤Ω∏¸∏ƒ),œ»≈–∂œ «∑Ò∏ƒ±‰
            If InStr(",5,6,K,", .TextMatrix(lngRow, COL_¿‡±)) > 0 Then
                If cbo÷¥–––‘÷ .Tag <> "" Then blnCurDo = True
                If Val(cmd”√∑®.Tag) <> 0 And txt”√∑®.Tag <> "" Then blnCurDo = True
            End If
                                    
            '–ﬁ∏ƒ ±◊‘∂Ø∏¸–¬≤ø∑›ƒ⁄»›
            blnTmp = False
            If cbo÷¥–––‘÷ .Tag <> "" Or (Val(cmd”√∑®.Tag) <> 0 And txt”√∑®.Tag <> "") Then
                blnReInRow = True '–Ë“™À¢–¬∏¯“©Õææ∂,≤…ºØ∑Ω Ωµƒ÷¥––ø∆ “
                blnTmp = True
            End If
            If blnCurDo Or blnTmp Then
                '–ﬁ∏ƒ¡Àƒ⁄»›‘Ú∏¸–¬ø™÷ˆ ±º‰
                strCurDate = Format(zlDatabase.Currentdate, "yyyy-MM-dd HH:mm")
                .TextMatrix(lngRow, COL_ø™÷ˆ ±º‰) = Format(strCurDate, "yyyy-MM-dd HH:mm")
                .Cell(flexcpData, lngRow, COL_ø™÷ˆ ±º‰) = strCurDate
                
                'ºÏ≤Èø™÷ˆ“Ω…˙
                If .TextMatrix(lngRow, COL_ø™÷ˆ“Ω…˙) <> UserInfo.–’√˚ Then
                    .TextMatrix(lngRow, COL_ø™÷ˆ“Ω…˙) = UserInfo.–’√˚
                    If lngø™÷ˆø∆ “ID = 0 Then
                        lngø™÷ˆø∆ “ID = Getø™÷ˆø∆ “ID(UserInfo.ID, mlng“Ωººø∆ “ID, mlng≤°»Àø∆ “id, 1)
                    End If
                    .TextMatrix(lngRow, COL_ø™÷ˆø∆ “ID) = lngø™÷ˆø∆ “ID
                End If
            End If
                                    
            '∆‰À¸–Ë“™Õ¨≤Ω¥¶¿Ìµƒπÿ¡™––
            '----------------------------------------------------------------
            If RowInºÏ—È––(lngRow) Then
                '≤…ºØ∑Ω∑®
                If Val(cmd”√∑®.Tag) <> 0 And txt”√∑®.Tag <> "" Then
                    .TextMatrix(lngRow, COL_’Ô¡∆œÓƒøID) = Val(cmd”√∑®.Tag)
                    .TextMatrix(lngRow, COL_”√∑®) = txt”√∑®.Text
                    .TextMatrix(lngRow, COL_√˚≥∆) = txt”√∑®.Text
                    
                    'Õ¨ ±∏¸∏ƒº∆º€–‘÷ ∫Õ÷¥–––‘÷ 
                    .TextMatrix(lngRow, COL_º∆º€–‘÷ ) = Nvl(GetItemField("’Ô¡∆œÓƒøƒø¬º", Val(cmd”√∑®.Tag), "º∆º€–‘÷ "), 0)
                    .TextMatrix(lngRow, COL_÷¥–––‘÷ ) = Nvl(GetItemField("’Ô¡∆œÓƒøƒø¬º", Val(cmd”√∑®.Tag), "÷¥––ø∆ “"), 0)
                    If InStr(",0,5,", Val(.TextMatrix(lngRow, COL_÷¥–––‘÷ ))) = 0 Then
                        .TextMatrix(lngRow, COL_÷¥––ø∆ “ID) = Get’Ô¡∆÷¥––ø∆ “ID(mlng≤°»ÀID, 0, "E", Val(cmd”√∑®.Tag), 0, _
                            Val(.TextMatrix(lngRow, COL_÷¥–––‘÷ )), mlng≤°»Àø∆ “id, Val(.TextMatrix(lngRow, COL_ø™÷ˆø∆ “ID)), 1, 1)
                    Else
                        .TextMatrix(lngRow, COL_÷¥––ø∆ “ID) = 0
                    End If

                    blnCurDo = True
                End If
                
                '…Ë÷√“ª≤¢≤…ºØµƒ∏˜∏ˆºÏ—ÈœÓƒø
                If blnCurDo Then
                    For i = lngRow - 1 To .FixedRows Step -1
                        If Val(.TextMatrix(i, COL_œ‡πÿID)) = .RowData(lngRow) Then
                            If txt◊‹¡ø.Tag <> "" Then
                                .TextMatrix(i, COL_◊‹¡ø) = .TextMatrix(lngRow, COL_◊‹¡ø)
                                blnOtherDo = True
                            End If
                            If txt∆µ¬ .Tag <> "" Then
                                .TextMatrix(i, COL_∆µ¬ ) = .TextMatrix(lngRow, COL_∆µ¬ )
                                .TextMatrix(i, COL_∆µ¬ ¥Œ ˝) = .TextMatrix(lngRow, COL_∆µ¬ ¥Œ ˝)
                                .TextMatrix(i, COL_∆µ¬ º‰∏Ù) = .TextMatrix(lngRow, COL_∆µ¬ º‰∏Ù)
                                .TextMatrix(i, COL_º‰∏Ùµ•Œª) = .TextMatrix(lngRow, COL_º‰∏Ùµ•Œª)
                                blnOtherDo = True
                            End If
                            If cbo÷¥––ø∆ “.Tag <> "" And cbo÷¥––ø∆ “.ListIndex <> -1 Then
                                If InStr(",0,5,", Val(.TextMatrix(i, COL_÷¥–––‘÷ ))) > 0 Then
                                    .TextMatrix(i, COL_÷¥––ø∆ “ID) = 0
                                Else
                                    .TextMatrix(i, COL_÷¥––ø∆ “ID) = cbo÷¥––ø∆ “.ItemData(cbo÷¥––ø∆ “.ListIndex)
                                End If
                                blnOtherDo = True
                            End If
                            If cbo÷¥–– ±º‰.Tag <> "" Then
                                .TextMatrix(i, COL_÷¥–– ±º‰) = .TextMatrix(lngRow, COL_÷¥–– ±º‰)
                                blnOtherDo = True
                            End If
                            If txtø™ º ±º‰.Tag <> "" Then
                                .TextMatrix(i, COL_ø™ º ±º‰) = .TextMatrix(lngRow, COL_ø™ º ±º‰)
                                .Cell(flexcpData, i, COL_ø™ º ±º‰) = .Cell(flexcpData, lngRow, COL_ø™ º ±º‰)
                                blnOtherDo = True
                            End If
                            If chkΩÙº±.Tag <> "" Then
                                .TextMatrix(i, COL_±Í÷æ) = .TextMatrix(lngRow, COL_±Í÷æ)
                                blnOtherDo = True
                            End If
                                            
                            'ø™÷ˆ ±º‰
                            If .TextMatrix(i, COL_ø™÷ˆ ±º‰) <> .TextMatrix(lngRow, COL_ø™÷ˆ ±º‰) Then
                                .TextMatrix(i, COL_ø™÷ˆ ±º‰) = .TextMatrix(lngRow, COL_ø™÷ˆ ±º‰)
                                .Cell(flexcpData, i, COL_ø™÷ˆ ±º‰) = .Cell(flexcpData, lngRow, COL_ø™÷ˆ ±º‰)
                                blnOtherDo = True
                            End If
                            
                            'ø™÷ˆ“Ω…˙
                            If .TextMatrix(i, COL_ø™÷ˆ“Ω…˙) <> .TextMatrix(lngRow, COL_ø™÷ˆ“Ω…˙) Then
                                .TextMatrix(i, COL_ø™÷ˆ“Ω…˙) = .TextMatrix(lngRow, COL_ø™÷ˆ“Ω…˙)
                                blnOtherDo = True
                            End If
                                            
                            'ø™÷ˆø∆ “ID
                            If .TextMatrix(i, COL_ø™÷ˆø∆ “ID) <> .TextMatrix(lngRow, COL_ø™÷ˆø∆ “ID) Then
                                .TextMatrix(i, COL_ø™÷ˆø∆ “ID) = .TextMatrix(lngRow, COL_ø™÷ˆø∆ “ID)
                                blnOtherDo = True
                            End If
                            
                            '±Íº«Œ™–ﬁ∏ƒ
                            If blnOtherDo And InStr(",0,3,", .TextMatrix(i, COL_EDIT)) > 0 Then
                                .TextMatrix(i, COL_EDIT) = 2
                                .TextMatrix(i, COL_◊¥Ã¨) = 1 '–ﬁ∏ƒ∫Û±‰Œ™–¬ø™
                            End If
                        Else
                            Exit For
                        End If
                    Next
                End If
            ElseIf InStr(",5,6,", .TextMatrix(lngRow, COL_¿‡±)) > 0 Then
                '÷–°¢Œ˜≥…“©¥¶¿Ì∏¯“©Õææ∂º∞“ª≤¢∏¯“©µƒ«Èøˆ
                
                '÷¥–––‘÷ 
                If cbo÷¥–––‘÷ .Tag <> "" Then
                    .TextMatrix(lngRow, COL_÷¥–––‘÷ ) = Decode(NeedName(cbo÷¥–––‘÷ .Text), "◊‘±∏“©", 5, 4)
                    If Val(.TextMatrix(lngRow, COL_÷¥–––‘÷ )) = 5 Then
                        .TextMatrix(lngRow, COL_÷¥––ø∆ “ID) = 0
                    ElseIf Val(.TextMatrix(lngRow, COL_÷¥––ø∆ “ID)) = 0 Then
                        'ª÷∏¥»± °“©∑ø,»± °”Î«∞√Êµƒ≥…“©œ‡Õ¨
                        strTmp = Getø…”√“©∑øIDs(.TextMatrix(lngRow, COL_¿‡±), Val(.TextMatrix(lngRow, COL_’Ô¡∆œÓƒøID)), Val(.TextMatrix(lngRow, COL_ ’∑—œ∏ƒøID)), mlng≤°»Àø∆ “id, 1)
                        For i = lngRow - 1 To .FixedRows Step -1
                            'Œ˜≥…“©∫Õ÷–≥…“©µƒ“©∑øø…ƒ‹≤ªÕ¨,À˘“‘¿‡±“™œ‡Õ¨
                            If .TextMatrix(i, COL_¿‡±) = .TextMatrix(lngRow, COL_¿‡±) And Val(.TextMatrix(i, COL_÷¥––ø∆ “ID)) <> 0 Then
                                If InStr("," & strTmp & ",", "," & Val(.TextMatrix(i, COL_÷¥––ø∆ “ID)) & ",") > 0 Then
                                    .TextMatrix(lngRow, COL_÷¥––ø∆ “ID) = Val(.TextMatrix(i, COL_÷¥––ø∆ “ID))
                                    Exit For
                                End If
                            End If
                        Next
                        If Val(.TextMatrix(lngRow, COL_÷¥––ø∆ “ID)) = 0 Then
                            .TextMatrix(lngRow, COL_÷¥––ø∆ “ID) = Get’Ô¡∆÷¥––ø∆ “ID(mlng≤°»ÀID, 0, .TextMatrix(lngRow, COL_¿‡±), Val(.TextMatrix(lngRow, COL_’Ô¡∆œÓƒøID)), Val(.TextMatrix(lngRow, COL_ ’∑—œ∏ƒøID)), 4, mlng≤°»Àø∆ “id, 0, 1, 1, True)
                        End If
                    End If
                    cbo÷¥––ø∆ “.Tag = "1" '±Í√˜÷¥––ø∆ ““ª≤¢∏¯“©µƒ“™Õ¨≤Ω±‰
                    blnReInRow = True 'ΩÁ√Ê÷¥––ø∆ “±‡º≠–‘±‰ªØ
                End If
                
                '∏¯“©Õææ∂±æ…Ìº∞∆‰À¸œ‡πÿ ˝æ›Õ¨≤Ω∏¸∏ƒ
                lng÷¥––ø∆ “ID = 0
                If cbo∏Ωº”÷¥––.ListIndex <> -1 Then
                    lng÷¥––ø∆ “ID = cbo∏Ωº”÷¥––.ItemData(cbo∏Ωº”÷¥––.ListIndex)
                End If
                strTmp = ""
                If Trim(cboµŒÀŸ.Text) <> "" Then
                    strTmp = cboµŒÀŸ.Text & lblµŒÀŸµ•Œª.Caption
                End If
                If Val(cmd”√∑®.Tag) <> 0 And txt”√∑®.Tag <> "" Then
                    .TextMatrix(lngRow, COL_”√∑®) = txt”√∑®.Text & strTmp
                    
                    If CheckExecDeptValidate(lng÷¥––ø∆ “ID, mlng≤°»Àø∆ “id, 1, Val(cmd”√∑®.Tag)) = False Then
                        lng÷¥––ø∆ “ID = 0
                    End If
                    
                    Call AdviceSet∏¯“©Õææ∂(lngRow, Val(cmd”√∑®.Tag), NeedName(cbo÷¥–––‘÷ .Text), lng÷¥––ø∆ “ID, strTmp)
                ElseIf blnCurDo Then 'cbo÷¥–––‘÷ .Tag <> "" Then
                    '»Áπ˚÷¥–––‘÷ ∏¸∏ƒ¡À,–Ë“™«ø–––ﬁ∏ƒ∂‘”¶µƒ∏¯“©Õææ∂µƒ÷¥–––‘÷ ∫Õ÷¥––ø∆ “
                    lngTmp = .FindRow(CLng(.TextMatrix(lngRow, COL_œ‡πÿID)), lngRow + 1)
                    Call AdviceSet∏¯“©Õææ∂(lngRow, Val(.TextMatrix(lngTmp, COL_’Ô¡∆œÓƒøID)), NeedName(cbo÷¥–––‘÷ .Text), lng÷¥––ø∆ “ID, strTmp)
                End If
                
                '“ª≤¢∏¯“©:≤ª¥¶¿Ì∏¯“©Õææ∂,«∞√Ê“—µ•∂¿…Ë÷√
                If blnCurDo Then
                    lngBeginRow = .FindRow(.TextMatrix(lngRow, COL_œ‡πÿID), , COL_œ‡πÿID)
                    If cbo÷¥––ø∆ “.Tag <> "" Then
                        For i = lngBeginRow To .Rows - 1
                            If .TextMatrix(i, COL_œ‡πÿID) = "" Then
                                lngTmp = i: Exit For
                            End If
                        Next
                    End If
                    For i = lngBeginRow To .Rows - 1
                        If i <> lngRow And .RowData(i) <> 0 _
                            And Val(.TextMatrix(i, COL_”§∂˘)) = Val(.TextMatrix(lngRow, COL_”§∂˘)) Then 'ø…ƒ‹œ÷‘⁄÷–º‰”–ø’––
                            If Val(.TextMatrix(i, COL_œ‡πÿID)) = Val(.TextMatrix(lngRow, COL_œ‡πÿID)) Then
                                If txtø™ º ±º‰.Tag <> "" Then
                                    .TextMatrix(i, COL_ø™ º ±º‰) = .TextMatrix(lngRow, COL_ø™ º ±º‰)
                                    .Cell(flexcpData, i, COL_ø™ º ±º‰) = .Cell(flexcpData, lngRow, COL_ø™ º ±º‰)
                                    blnOtherDo = True
                                End If
                                If txt”√∑®.Tag <> "" Then
                                    .TextMatrix(i, COL_”√∑®) = .TextMatrix(lngRow, COL_”√∑®)
                                    blnOtherDo = True
                                End If
                                If txt∆µ¬ .Tag <> "" Then
                                    .TextMatrix(i, COL_∆µ¬ ) = .TextMatrix(lngRow, COL_∆µ¬ )
                                    .TextMatrix(i, COL_∆µ¬ ¥Œ ˝) = .TextMatrix(lngRow, COL_∆µ¬ ¥Œ ˝)
                                    .TextMatrix(i, COL_∆µ¬ º‰∏Ù) = .TextMatrix(lngRow, COL_∆µ¬ º‰∏Ù)
                                    .TextMatrix(i, COL_º‰∏Ùµ•Œª) = .TextMatrix(lngRow, COL_º‰∏Ùµ•Œª)
                                    blnOtherDo = True
                                End If
                                
                                'Ω´µŒÀŸ≤πÃÓµΩ“ª≤¢∏¯“©µƒ∆‰À˚––÷–
                                If cboµŒÀŸ.Tag <> "" Then
                                    .TextMatrix(i, COL_”√∑®) = txt”√∑®.Text & strTmp
                                    blnOtherDo = True
                                End If
                                
                                '“ª≤¢∏¯“©µƒ,ÃÏ ˝œ‡Õ¨±‰ªØ,◊‹¡ø÷ÿ–¬º∆À„
                                If txtÃÏ ˝.Tag <> "" Then
                                    .TextMatrix(i, COL_ÃÏ ˝) = .TextMatrix(lngRow, COL_ÃÏ ˝)
                                    If .TextMatrix(i, COL_∆µ¬ ) <> "" _
                                        And Val(.TextMatrix(i, COL_µ•¡ø)) <> 0 _
                                        And Val(.TextMatrix(i, COL_º¡¡øœµ ˝)) <> 0 _
                                        And Val(.TextMatrix(i, COL_√≈’Ô∞¸◊∞)) <> 0 Then
                                        
                                        .TextMatrix(i, COL_◊‹¡ø) = FormatEx(Calc»± °“©∆∑◊‹¡ø( _
                                            Val(.TextMatrix(i, COL_µ•¡ø)), Val(.TextMatrix(i, COL_ÃÏ ˝)), _
                                            Val(.TextMatrix(i, COL_∆µ¬ ¥Œ ˝)), Val(.TextMatrix(i, COL_∆µ¬ º‰∏Ù)), _
                                            .TextMatrix(i, COL_º‰∏Ùµ•Œª), .TextMatrix(i, COL_÷¥–– ±º‰), _
                                            Val(.TextMatrix(i, COL_º¡¡øœµ ˝)), Val(.TextMatrix(i, COL_√≈’Ô∞¸◊∞)), _
                                            Val(.TextMatrix(i, COL_ø…∑Ò∑÷¡„))), 5)
                                        If InStr(GetInsidePrivs(p√≈’Ô“Ω÷ˆœ¬¥Ô), "“©∆∑–° ˝ ‰»Î") = 0 Then
                                            .TextMatrix(i, COL_◊‹¡ø) = IntEx(Val(.TextMatrix(i, COL_◊‹¡ø)))
                                        ElseIf Val(.TextMatrix(i, COL_ø…∑Ò∑÷¡„)) <> 0 Then
                                            .TextMatrix(i, COL_◊‹¡ø) = IntEx(Val(.TextMatrix(i, COL_◊‹¡ø)))
                                        End If
                                    End If
                                    '÷ÿ–¬ºÏ≤È¥¶∑Ωœﬁ¡ø≥¨ÃÏ
                                    .TextMatrix(i, COL_ «∑Ò≥¨∆⁄) = "": .TextMatrix(i, COL_ «∑Ò≥¨¡ø) = ""
                                    If Val(.TextMatrix(i, COL_¥¶∑Ωœﬁ¡ø)) <> 0 Then
                                        dbl◊‹¡ø = Val(.TextMatrix(i, COL_◊‹¡ø)) * Val(.TextMatrix(i, COL_√≈’Ô∞¸◊∞)) * Val(.TextMatrix(i, COL_º¡¡øœµ ˝))
                                        If dbl◊‹¡ø > Val(.TextMatrix(i, COL_¥¶∑Ωœﬁ¡ø)) Then .TextMatrix(i, COL_ «∑Ò≥¨¡ø) = "1"
                                    End If
                                    
                                    If Val(.TextMatrix(i, COL_ÃÏ ˝)) > IIF(mbytPatiType = 1, conOrdinary, conEmergency) Then
                                        .TextMatrix(i, COL_ «∑Ò≥¨∆⁄) = "1"
                                    End If
                                    
                                    If .TextMatrix(i, COL_ «∑Ò≥¨∆⁄) = "" And .TextMatrix(i, COL_ «∑Ò≥¨¡ø) = "" Then .TextMatrix(i, COL_≥¨¡øÀµ√˜) = ""
                                    
                                    blnOtherDo = True
                                End If
                                
                                If cbo÷¥–– ±º‰.Tag <> "" Then
                                    .TextMatrix(i, COL_÷¥–– ±º‰) = .TextMatrix(lngRow, COL_÷¥–– ±º‰)
                                    blnOtherDo = True
                                End If
                                
                                '÷¥–––‘÷ :¿Î‘∫¥¯“©‘⁄“ª≤¢∏¯“©÷––Ë“ª÷¬£¨∆‰À¸ø…µ•∂¿…Ë÷√
                                If cbo÷¥–––‘÷ .Tag <> "" And NeedName(cbo÷¥–––‘÷ .Text) = "¿Î‘∫¥¯“©" Then
                                    .TextMatrix(i, COL_÷¥–––‘÷ ) = .TextMatrix(lngRow, COL_÷¥–––‘÷ )
                                    '”…◊‘±∏“©◊™π˝¿¥ ±–Ë“™÷ÿ–¬…Ë÷√÷¥––ø∆ “
                                    If Val(.TextMatrix(i, COL_÷¥––ø∆ “ID)) = 0 Then
                                        .TextMatrix(i, COL_÷¥––ø∆ “ID) = .TextMatrix(lngRow, COL_÷¥––ø∆ “ID)
                                    End If
                                    blnOtherDo = True
                                End If
                                
                                '÷¥––ø∆ “:÷¥––ø∆ “(“©∑ø)ø…“‘≤ªÕ¨,≥˝∑« «≈‰÷∆÷––ƒ
                                If cbo÷¥––ø∆ “.Tag <> "" Then
                                    ' ‰»Î––∏ƒŒ™◊‘±∏“©£¨ªÚƒ≥––Œ™◊‘±∏“©µƒ«Èøˆ≤ªπ‹À¸
                                    If Not (Val(.TextMatrix(lngRow, COL_÷¥––ø∆ “ID)) = 0 And Val(.TextMatrix(lngRow, COL_÷¥–––‘÷ )) = 5) _
                                        And Not (Val(.TextMatrix(i, COL_÷¥––ø∆ “ID)) = 0 And Val(.TextMatrix(i, COL_÷¥–––‘÷ )) = 5) Then
                                        If .TextMatrix(lngTmp, COL_¿‡±) = "E" And .TextMatrix(lngTmp, COL_≤Ÿ◊˜¿‡–Õ) = "2" And .TextMatrix(lngTmp, COL_÷¥––∑÷¿‡) = "1" Then
                                            If Have≤ø√≈–‘÷ (Val(.TextMatrix(lngRow, COL_÷¥––ø∆ “ID)), "≈‰÷∆÷––ƒ") Then
                                                ' ‰»Î––“©∆∑”…∆’Õ®“©∑øªÚ∆‰À˚≈‰÷∆÷––ƒ∏ƒŒ™–¬µƒ≈‰÷∆÷––ƒ,‘Ú∏√◊È“©∂º∏ƒŒ™∏√≈‰÷∆÷––ƒ
                                                .TextMatrix(i, COL_÷¥––ø∆ “ID) = .TextMatrix(lngRow, COL_÷¥––ø∆ “ID)
                                                blnOtherDo = True
                                            ElseIf Have≤ø√≈–‘÷ (Val(.TextMatrix(i, COL_÷¥––ø∆ “ID)), "≈‰÷∆÷––ƒ") Then
                                                ' ‰»Î––“©∆∑”…≈‰÷∆÷––ƒ∏ƒ≥…∆’Õ®“©∑ø,‘Ú∏√◊È“©∂º∏ƒŒ™∏√∆’Õ®“©∑ø
                                                .TextMatrix(i, COL_÷¥––ø∆ “ID) = .TextMatrix(lngRow, COL_÷¥––ø∆ “ID)
                                                blnOtherDo = True
                                            End If
                                        End If
                                    End If
                                End If
                                
                                'ΩÙº±±Í÷æ
                                If chkΩÙº±.Tag <> "" Then
                                    .TextMatrix(i, COL_±Í÷æ) = .TextMatrix(lngRow, COL_±Í÷æ)
                                    .TextMatrix(i, COL_…Û∫À◊¥Ã¨) = .TextMatrix(lngRow, COL_…Û∫À◊¥Ã¨)
                                    blnOtherDo = True
                                End If
                                
                                'ø™÷ˆ ±º‰
                                If .TextMatrix(i, COL_ø™÷ˆ ±º‰) <> .TextMatrix(lngRow, COL_ø™÷ˆ ±º‰) Then
                                    .TextMatrix(i, COL_ø™÷ˆ ±º‰) = .TextMatrix(lngRow, COL_ø™÷ˆ ±º‰)
                                    .Cell(flexcpData, i, COL_ø™÷ˆ ±º‰) = .Cell(flexcpData, lngRow, COL_ø™÷ˆ ±º‰)
                                    blnOtherDo = True
                                End If
                                
                                'ø™÷ˆ“Ω…˙
                                If .TextMatrix(i, COL_ø™÷ˆ“Ω…˙) <> .TextMatrix(lngRow, COL_ø™÷ˆ“Ω…˙) Then
                                    .TextMatrix(i, COL_ø™÷ˆ“Ω…˙) = .TextMatrix(lngRow, COL_ø™÷ˆ“Ω…˙)
                                    blnOtherDo = True
                                End If
                                
                                'ø™÷ˆø∆ “ID
                                If .TextMatrix(i, COL_ø™÷ˆø∆ “ID) <> .TextMatrix(lngRow, COL_ø™÷ˆø∆ “ID) Then
                                    .TextMatrix(i, COL_ø™÷ˆø∆ “ID) = .TextMatrix(lngRow, COL_ø™÷ˆø∆ “ID)
                                    blnOtherDo = True
                                End If
                                
                                '±Íº«Œ™–ﬁ∏ƒ
                                If blnOtherDo And InStr(",0,3,", .TextMatrix(i, COL_EDIT)) > 0 Then
                                    .TextMatrix(i, COL_EDIT) = 2
                                    .TextMatrix(i, COL_◊¥Ã¨) = 1 '–ﬁ∏ƒ∫Û±‰Œ™–¬ø™
                                End If
                            Else
                                Exit For
                            End If
                        End If
                    Next
                End If
            ElseIf .TextMatrix(lngRow, COL_¿‡±) = "K" Then
                ' ‰—™“Ω÷ˆµƒ¥¶¿Ì(«∞√Ê“—¥¶¿Ì ‰—™ ±º‰(∞≤≈≈ ±º‰)µƒ–ﬁ∏ƒ)
                
                lng÷¥––ø∆ “ID = 0
                If cbo∏Ωº”÷¥––.ListIndex <> -1 Then
                    lng÷¥––ø∆ “ID = cbo∏Ωº”÷¥––.ItemData(cbo∏Ωº”÷¥––.ListIndex)
                End If
                If Val(cmd”√∑®.Tag) <> 0 And txt”√∑®.Tag <> "" Then
                    .TextMatrix(lngRow, COL_”√∑®) = txt”√∑®.Text
                    Call AdviceSet ‰—™Õææ∂(lngRow, Val(cmd”√∑®.Tag), lng÷¥––ø∆ “ID)
                ElseIf blnCurDo Then
                    lngTmp = .FindRow(CStr(.RowData(lngRow)), lngRow + 1, COL_œ‡πÿID)
                    If lngTmp <> -1 Then
                        Call AdviceSet ‰—™Õææ∂(lngRow, Val(.TextMatrix(lngTmp, COL_’Ô¡∆œÓƒøID)), lng÷¥––ø∆ “ID)
                    End If
                End If
            ElseIf InStr(",D,F,", .TextMatrix(lngRow, COL_¿‡±)) > 0 And blnCurDo Then
                'ºÏ≤È◊È∫œœÓƒø––ªÚ ÷ ı∏Ωº”––
                lngBeginRow = .FindRow(CStr(.RowData(lngRow)), lngRow + 1, COL_œ‡πÿID)
                If lngBeginRow <> -1 Then
                    For i = lngBeginRow To .Rows - 1
                        If Val(.TextMatrix(i, COL_œ‡πÿID)) = .RowData(lngRow) Then
                            If txtµ•¡ø.Tag <> "" Then
                                .TextMatrix(i, COL_µ•¡ø) = .TextMatrix(lngRow, COL_µ•¡ø)
                                blnOtherDo = True
                            End If
                            If txt◊‹¡ø.Tag <> "" Then
                                .TextMatrix(i, COL_◊‹¡ø) = .TextMatrix(lngRow, COL_◊‹¡ø)
                                blnOtherDo = True
                            End If
                            
                            If cbo÷¥–– ±º‰.Tag <> "" Then
                                .TextMatrix(i, COL_÷¥–– ±º‰) = .TextMatrix(lngRow, COL_÷¥–– ±º‰)
                                blnOtherDo = True
                            End If
                            If txt∆µ¬ .Tag <> "" Then
                                .TextMatrix(i, COL_∆µ¬ ) = .TextMatrix(lngRow, COL_∆µ¬ )
                                .TextMatrix(i, COL_∆µ¬ ¥Œ ˝) = .TextMatrix(lngRow, COL_∆µ¬ ¥Œ ˝)
                                .TextMatrix(i, COL_∆µ¬ º‰∏Ù) = .TextMatrix(lngRow, COL_∆µ¬ º‰∏Ù)
                                .TextMatrix(i, COL_º‰∏Ùµ•Œª) = .TextMatrix(lngRow, COL_º‰∏Ùµ•Œª)
                                blnOtherDo = True
                            End If
                            If cbo÷¥––ø∆ “.Tag <> "" Then
                                If InStr(",0,5,", Val(.TextMatrix(i, COL_÷¥–––‘÷ ))) > 0 Then
                                    .TextMatrix(i, COL_÷¥––ø∆ “ID) = 0
                                ElseIf .TextMatrix(i, COL_¿‡±) <> "G" Then ' ÷ ı¬È◊Ìµƒ÷¥––ø∆ “Œ™µ•∂¿
                                    .TextMatrix(i, COL_÷¥––ø∆ “ID) = .TextMatrix(lngRow, COL_÷¥––ø∆ “ID)
                                End If
                                blnOtherDo = True
                            End If
                            If txtø™ º ±º‰.Tag <> "" Then
                                .TextMatrix(i, COL_ø™ º ±º‰) = .TextMatrix(lngRow, COL_ø™ º ±º‰)
                                .Cell(flexcpData, i, COL_ø™ º ±º‰) = .Cell(flexcpData, lngRow, COL_ø™ º ±º‰)
                                blnOtherDo = True
                            End If
                            If txt∞≤≈≈ ±º‰.Tag <> "" Then
                                .TextMatrix(i, COL_ ÷ ı ±º‰) = .TextMatrix(lngRow, COL_ ÷ ı ±º‰)
                                blnOtherDo = True
                            End If
                            If chkΩÙº±.Tag <> "" Then
                                .TextMatrix(i, COL_±Í÷æ) = .TextMatrix(lngRow, COL_±Í÷æ)
                                blnOtherDo = True
                            End If
                            
                            'ø™÷ˆ ±º‰
                            If .TextMatrix(i, COL_ø™÷ˆ ±º‰) <> .TextMatrix(lngRow, COL_ø™÷ˆ ±º‰) Then
                                .TextMatrix(i, COL_ø™÷ˆ ±º‰) = .TextMatrix(lngRow, COL_ø™÷ˆ ±º‰)
                                .Cell(flexcpData, i, COL_ø™÷ˆ ±º‰) = .Cell(flexcpData, lngRow, COL_ø™÷ˆ ±º‰)
                                blnOtherDo = True
                            End If
                            
                            'ø™÷ˆ“Ω…˙
                            If .TextMatrix(i, COL_ø™÷ˆ“Ω…˙) <> .TextMatrix(lngRow, COL_ø™÷ˆ“Ω…˙) Then
                                .TextMatrix(i, COL_ø™÷ˆ“Ω…˙) = .TextMatrix(lngRow, COL_ø™÷ˆ“Ω…˙)
                                blnOtherDo = True
                            End If
                            
                            'ø™÷ˆø∆ “ID
                            If .TextMatrix(i, COL_ø™÷ˆø∆ “ID) <> .TextMatrix(lngRow, COL_ø™÷ˆø∆ “ID) Then
                                .TextMatrix(i, COL_ø™÷ˆø∆ “ID) = .TextMatrix(lngRow, COL_ø™÷ˆø∆ “ID)
                                blnOtherDo = True
                            End If
                            
                            '±Íº«Œ™–ﬁ∏ƒ
                            If blnOtherDo And InStr(",0,3,", .TextMatrix(i, COL_EDIT)) > 0 Then
                                .TextMatrix(i, COL_EDIT) = 2
                                .TextMatrix(i, COL_◊¥Ã¨) = 1 '–ﬁ∏ƒ∫Û±‰Œ™–¬ø™
                            End If
                        Else
                            Exit For
                        End If
                    Next
                End If
            ElseIf .TextMatrix(lngRow, COL_¿‡±) = "E" And .TextMatrix(lngRow, COL_≤Ÿ◊˜¿‡–Õ) = "1" And .TextMatrix(lngRow, COL_÷¥––∑÷¿‡) = "5" Then
                '‘≠“∫∆§ ‘
                If cbo∏Ωº”÷¥––.Tag <> "" Then
                    lng÷¥––ø∆ “ID = 0
                    If cbo∏Ωº”÷¥––.ListIndex <> -1 Then
                        lng÷¥––ø∆ “ID = cbo∏Ωº”÷¥––.ItemData(cbo∏Ωº”÷¥––.ListIndex)
                    End If
                    .TextMatrix(lngRow, COL_”√“©¿Ì”…) = lng÷¥––ø∆ “ID
                End If
            End If
        End If
        
        '≈‰∑Ω∫Õ∆‰À˚’Ô¡∆œÓƒø∂ºø…ƒ‹¥Ê‘⁄≥¨∆⁄
        If txt≥¨¡øÀµ√˜.Enabled And txt≥¨¡øÀµ√˜.Tag <> "" Then
            .TextMatrix(lngRow, COL_≥¨¡øÀµ√˜) = txt≥¨¡øÀµ√˜.Text
            blnCurDo = True
        End If
        If lbl≥¨¡øÀµ√˜.Tag <> "" Then
            blnReSet≥¨¡øÀµ√˜ = True
        End If
        'Õ≥“ª¥¶¿Ìœ‡πÿ––µƒ Ù–‘±‰ªØ
        If chkZeroBilling.Tag <> "" Then
            Call GetRowScope(lngRow, lngBegin, lngEnd)
            For i = lngBegin To lngEnd
                .TextMatrix(i, COL_¡„∑—º«’ ) = chkZeroBilling.value
            Next
            blnCurDo = True
        End If
                    
        '---------------
        If blnCurDo Then '±Íº«Œ™–ﬁ∏ƒ:0-‘≠ ºµƒ,1-–¬‘ˆµƒ,2-–ﬁ∏ƒ¡Àƒ⁄»›,3-–ﬁ∏ƒ¡À–Ú∫≈
            If InStr(",0,2,3,", .TextMatrix(lngRow, COL_EDIT)) > 0 Then
                 '…Û∫ÀŒ¥Õ®π˝µƒ «“ª◊È“©∆∑,‘Ú–Ë“™∏ƒ±‰◊Èƒ⁄∆‰À˚––µƒ…Û∫À◊¥Ã¨Œ™Œ¥…Û∫ÀªÚŒﬁ–Ë…Û∫À
                If Val(.TextMatrix(lngRow, COL_…Û∫À◊¥Ã¨)) <> 2 And .TextMatrix(lngRow, COL_¿‡±) <> "K" Then
                    Call GetRowScope(lngRow, lngBeginRow, lngEndRow)
                    For i = lngBeginRow To lngEndRow
                        '»Áπ˚ «ΩÙº±“Ω÷ˆ£¨‘ÚŒﬁ–Î…Û∫À
                        If gblnKSSStrict And UserInfo.”√“©º∂± < Val(.TextMatrix(i, COL_øπæ˙µ»º∂)) And .TextMatrix(i, COL_±Í÷æ) <> 1 Then
                            .TextMatrix(i, COL_…Û∫À◊¥Ã¨) = 1
                        Else
                            .TextMatrix(i, COL_…Û∫À◊¥Ã¨) = ""
                        End If
                        Call SetRow±Í÷æÕº±Í(i, 2)
                    Next
                End If
                
                .TextMatrix(lngRow, COL_EDIT) = 2
                .TextMatrix(lngRow, COL_◊¥Ã¨) = 1 '–ﬁ∏ƒ∫Û±‰Œ™–¬ø™
                Call ReSetColor(lngRow)
            End If
            mblnNoSave = True '±Íº«Œ™Œ¥±£¥Ê
        End If
        
        '∏¸–¬“Ω÷ˆƒ⁄»›
        If AdviceTextChange(lngRow) Then
            .TextMatrix(lngRow, col_“Ω÷ˆƒ⁄»›) = AdviceTextMake(lngRow)
            txt“Ω÷ˆƒ⁄»›.Text = .TextMatrix(lngRow, col_“Ω÷ˆƒ⁄»›)
        End If
    End With
        
    '«Â≥˝±‡º≠±Í÷æ
    Call ClearItemTag
    
    'ƒ≥–©«Èøˆœ¬–Ë“™÷ÿ–¬…Ë÷√ø®∆¨µƒœÓƒø±‡º≠–‘(»Á–ﬁ∏ƒ¡À÷¥–––‘÷  ±)
    If blnReInRow Then
        Call vsAdvice_AfterRowColChange(-1, -1, vsAdvice.Row, vsAdvice.Col)
        If vsAdvice.TextMatrix(lngRow, COL_ «∑Ò≥¨¡ø) = "" And vsAdvice.TextMatrix(lngRow, COL_ «∑Ò≥¨∆⁄) = "" Then vsAdvice.TextMatrix(lngRow, COL_≥¨¡øÀµ√˜) = ""
    ElseIf blnReSet≥¨¡øÀµ√˜ Then
        SetItemEditable , , , , , , , , , , , , IIF(vsAdvice.TextMatrix(lngRow, COL_ «∑Ò≥¨¡ø) = "1" Or vsAdvice.TextMatrix(lngRow, COL_ «∑Ò≥¨∆⁄) = "1", 1, -1)
        If vsAdvice.TextMatrix(lngRow, COL_ «∑Ò≥¨¡ø) = "" And vsAdvice.TextMatrix(lngRow, COL_ «∑Ò≥¨∆⁄) = "" Then vsAdvice.TextMatrix(lngRow, COL_≥¨¡øÀµ√˜) = ""
    End If
End Sub

Private Sub ReSetColor(ByVal lngRow As Long)
'π¶ƒ‹£∫÷ÿ–¬…Ë÷√÷∏∂®––µƒ—’…´
'Àµ√˜£∫
    Dim lngBegin As Long, lngEnd As Long, i As Long
    
    With vsAdvice
        '“ª≤¢∏¯“©∑∂Œß
        lngBegin = lngRow: lngEnd = lngRow
        If InStr(",5,6,", .TextMatrix(lngRow, COL_¿‡±)) > 0 Then
            If RowIn“ª≤¢∏¯“©(lngRow) Then
                Call Get“ª≤¢∏¯“©∑∂Œß(Val(.TextMatrix(lngRow, COL_œ‡πÿID)), lngBegin, lngEnd)
            End If
        End If
        'ª÷∏¥≥…’˝≥£…´
        For i = lngBegin To lngEnd
            .Cell(flexcpForeColor, i, .FixedCols, i, COL_ø™÷ˆ“Ω…˙) = .ForeColor
            '∂æ¬Èæ´µƒ—’…´±Í ∂
            If InStr(",¬È◊Ì“©,∂æ–‘“©,æ´…Ò“©,æ´…ÒI¿‡,æ´…ÒII¿‡,", .TextMatrix(i, COL_∂æ¿Ì∑÷¿‡)) > 0 _
                And .TextMatrix(i, COL_∂æ¿Ì∑÷¿‡) <> "" Then
                .Cell(flexcpFontBold, i, col_“Ω÷ˆƒ⁄»›) = True
            End If
        Next
        .ForeColorSel = .Cell(flexcpForeColor, lngRow, COL_ø™ º ±º‰)
    End With
End Sub

Private Sub AdviceSet“ª≤¢∏¯“©(ByVal lngBegin As Long, ByVal lngEnd As Long)
'π¶ƒ‹£∫Ω´—°‘Ò∑∂Œßƒ⁄µƒ“©∆∑…Ë÷√Œ™“ª≤¢∏¯“©
'≤Œ ˝£∫∆÷π––∫≈,÷–º‰≤ª∞¸∫¨ø’––,≤ª∞¸∫¨◊Ó∫Û“ª––“©∆∑µƒ∏¯“©Õææ∂––
'Àµ√˜£∫“‘µ⁄“ª––“©∆∑µƒ∏¯“©Õææ∂Œ™◊º,µ´Œª÷√∑≈‘⁄◊Ó∫Û“ª––“©∆∑÷Æ∫Û
    Dim varTmp1 As Variant, varTmp2 As Variant
    Dim lngRow1 As Long, lngRow2 As Long
    Dim lngœ‡πÿID As Long, i As Long
    Dim strStart As String, curDate As Date
    Dim lng≈‰÷∆÷––ƒ As Long
        
    With vsAdvice
        lngRow1 = .FindRow(CLng(.TextMatrix(lngBegin, COL_œ‡πÿID)), lngBegin + 1) 'µ⁄“ª∏¯“©Õææ∂––
        lngRow2 = .FindRow(CLng(.TextMatrix(lngEnd, COL_œ‡πÿID)), lngEnd + 1) '◊Ó∫Û∏¯“©Õææ∂––
        
        
        '…æ≥˝∏¯“©Õææ∂––÷Æ«∞º«¬º÷¥–––‘÷ ,“‘±„∫Û√Ê◊˜≈–∂œ
        For i = lngRow2 To lngRow1 Step -1
            If Val(.TextMatrix(i, COL_”§∂˘)) = cbo”§∂˘.ListIndex And .RowHidden(i) Then
                .Cell(flexcpData, i - 1, COL_÷¥–––‘÷ ) = Val(.TextMatrix(i, COL_÷¥–––‘÷ ))
            End If
        Next
        
        '∏¥÷∆µ⁄“ª––µƒ∏¯“©Õææ∂µΩ◊Ó∫Û“ª––µƒ∏¯“©Õææ∂
        For i = .FixedCols To .Cols - 1
            If i <> COL_EDIT And i <> COL_œ‡πÿID And i <> COL_–Ú∫≈ And i <> COL_◊¥Ã¨ Then
                .TextMatrix(lngRow2, i) = .TextMatrix(lngRow1, i)
            End If
        Next
        .Cell(flexcpData, lngRow2, COL_ø™ º ±º‰) = .TextMatrix(lngRow2, COL_ø™ º ±º‰)
        
        '±‡º≠±Í÷æ£∫0-‘≠ ºµƒ,1-–¬‘ˆµƒ,2-–ﬁ∏ƒ¡Àƒ⁄»›,3-–ﬁ∏ƒ¡À–Ú∫≈
        If InStr(",0,3,", .TextMatrix(lngRow2, COL_EDIT)) > 0 Then
            .TextMatrix(lngRow2, COL_EDIT) = 2 '±Íº«Œ™“—–ﬁ∏ƒ
            .TextMatrix(lngRow2, COL_◊¥Ã¨) = 1 '–ﬁ∏ƒ∫Û±‰Œ™–¬ø™
        End If
        lngœ‡πÿID = .RowData(lngRow2)
        
        varTmp1 = mblnRowChange: varTmp2 = .Redraw
        mblnRowChange = False: .Redraw = flexRDNone
        
        '…æ≥˝≥˝◊Ó∫Û“ª––∏¯“©Õææ∂Õ‚µƒ∆‰À¸∏¯“©Õææ∂
        For i = lngEnd To lngBegin Step -1
            If Val(.TextMatrix(i, COL_”§∂˘)) = cbo”§∂˘.ListIndex Then
                If .RowHidden(i) Then
                    Call DeleteRow(i)
                Else
                    .TextMatrix(i, COL_œ‡πÿID) = lngœ‡πÿID
                    If InStr(",0,3,", .TextMatrix(i, COL_EDIT)) > 0 Then
                        .TextMatrix(i, COL_EDIT) = 2 '±Íº«Œ™“—–ﬁ∏ƒ
                        .TextMatrix(i, COL_◊¥Ã¨) = 1 '–ﬁ∏ƒ∫Û±‰Œ™–¬ø™
                    End If
                End If
            End If
        Next
        
        '––∫≈“—±‰∏¸
        lngRow1 = lngBegin 'ø™ º“ª≤¢∏¯“©––
        curDate = zlDatabase.Currentdate
        
        'ºÏ≤È“Ω…˙ «∑Ò±‰∏¸
        If .TextMatrix(lngRow1, COL_ø™÷ˆ“Ω…˙) <> UserInfo.–’√˚ Then
            '∏¸–¬œ‡πÿ–≈œ¢:«∞√Ê“—±Íº«Œ™–ﬁ∏ƒ,«“ ÷π§≤Ÿ◊˜ÕÍ≥… ±“—”–Ω¯»ÎΩÁ√ÊÀ¢–¬
            .TextMatrix(lngRow1, COL_ø™÷ˆ“Ω…˙) = UserInfo.–’√˚
            .TextMatrix(lngRow1, COL_ø™÷ˆø∆ “ID) = Getø™÷ˆø∆ “ID(UserInfo.ID, mlng“Ωººø∆ “ID, mlng≤°»Àø∆ “id, 1)
            
            .TextMatrix(lngRow1, COL_ø™÷ˆ ±º‰) = Format(curDate, "yyyy-MM-dd HH:mm")
            .Cell(flexcpData, lngRow1, COL_ø™÷ˆ ±º‰) = Format(curDate, "yyyy-MM-dd HH:mm")
        End If
        
        '¥¶¿Ì“ª≤¢∏¯“©∆‰À˚––µƒœ‡Õ¨–≈œ¢
        For i = lngRow1 + 1 To .Rows - 1
            If Val(.TextMatrix(i, COL_”§∂˘)) = cbo”§∂˘.ListIndex Then
                If Val(.TextMatrix(i, COL_œ‡πÿID)) = lngœ‡πÿID Then
                    lngRow2 = i 'º«¬º–¬µƒΩ· ¯––∫≈
                    
                    '“ª≤¢∏¯“©µƒ≤ø∑÷–≈œ¢œ‡Õ¨
                    .TextMatrix(i, COL_ø™ º ±º‰) = .TextMatrix(lngRow1, COL_ø™ º ±º‰)
                    .Cell(flexcpData, i, COL_ø™ º ±º‰) = .Cell(flexcpData, lngRow1, COL_ø™ º ±º‰)
                    
                    .TextMatrix(i, COL_ø™÷ˆ“Ω…˙) = .TextMatrix(lngRow1, COL_ø™÷ˆ“Ω…˙)
                    .TextMatrix(i, COL_ø™÷ˆø∆ “ID) = .TextMatrix(lngRow1, COL_ø™÷ˆø∆ “ID)
                    
                    .TextMatrix(i, COL_ø™÷ˆ ±º‰) = .TextMatrix(lngRow1, COL_ø™÷ˆ ±º‰) '“ª≤¢∏¯“©µƒø™÷ˆ ±º‰œ‡Õ¨
                    .Cell(flexcpData, i, COL_ø™÷ˆ ±º‰) = .Cell(flexcpData, lngRow1, COL_ø™÷ˆ ±º‰)
                    
                    .TextMatrix(i, COL_ÃÏ ˝) = .TextMatrix(lngRow1, COL_ÃÏ ˝)
                    
                    .TextMatrix(i, COL_”√∑®) = .TextMatrix(lngRow1, COL_”√∑®)
                    
                    .TextMatrix(i, COL_∆µ¬ ) = .TextMatrix(lngRow1, COL_∆µ¬ )
                    .TextMatrix(i, COL_∆µ¬ ¥Œ ˝) = .TextMatrix(lngRow1, COL_∆µ¬ ¥Œ ˝)
                    .TextMatrix(i, COL_∆µ¬ º‰∏Ù) = .TextMatrix(lngRow1, COL_∆µ¬ º‰∏Ù)
                    .TextMatrix(i, COL_º‰∏Ùµ•Œª) = .TextMatrix(lngRow1, COL_º‰∏Ùµ•Œª)
                    .TextMatrix(i, COL_÷¥–– ±º‰) = .TextMatrix(lngRow1, COL_÷¥–– ±º‰)
                    
                    '∆Ù”√¡ÀÃÏ ˝øÿ÷∆≤≈∑¥À„£®71152£©
                    If mblnÃÏ ˝ Then .TextMatrix(i, COL_◊‹¡ø) = ReGet“©∆∑◊‹¡ø(Val(.TextMatrix(i, COL_◊‹¡ø)), Val(.TextMatrix(i, COL_µ•¡ø)), Val(.TextMatrix(i, COL_ÃÏ ˝)), i)
                    
                    
                    '¥¶∑Ωœﬁ¡ø
                    .TextMatrix(i, COL_ «∑Ò≥¨¡ø) = ""
                    If Val(.TextMatrix(i, COL_¥¶∑Ωœﬁ¡ø)) <> 0 Then
                        If Val(.TextMatrix(i, COL_◊‹¡ø)) > FormatEx(Val(.TextMatrix(i, COL_¥¶∑Ωœﬁ¡ø)) / Val(.TextMatrix(i, COL_º¡¡øœµ ˝)) / Val(.TextMatrix(i, COL_√≈’Ô∞¸◊∞)), 5) Then
                            .TextMatrix(i, COL_ «∑Ò≥¨¡ø) = "1"
                        End If
                    End If
                    
                    .TextMatrix(i, COL_ «∑Ò≥¨∆⁄) = ""
                    Call Set”√“©ÃÏ ˝ «∑Ò≥¨∆⁄(i)
                    
                    .TextMatrix(i, COL_±Í÷æ) = .TextMatrix(lngRow1, COL_±Í÷æ)
                    Set .Cell(flexcpPicture, i, COL_F±Í÷æ) = Nothing '‘⁄ø™ º––œ‘ æ
                    
                    '¿Î‘∫¥¯“©“ª◊Èœ‡Õ¨
                    If Val(.TextMatrix(lngRow1, COL_÷¥–––‘÷ )) <> 5 And Val(.Cell(flexcpData, lngRow1, COL_÷¥–––‘÷ )) = 5 Then
                        'µ⁄“ª–– «¿Î‘∫¥¯“©,»´≤ø…Ë÷√Œ™¿Î‘∫¥¯“©
                        .TextMatrix(i, COL_÷¥–––‘÷ ) = .TextMatrix(lngRow1, COL_÷¥–––‘÷ )
                        If Val(.TextMatrix(i, COL_÷¥––ø∆ “ID)) = 0 Then '÷¥––ø∆ “ø…“‘≤ªÕ¨,√ª”– ±≤≈»± °œ‡Õ¨
                            .TextMatrix(i, COL_÷¥––ø∆ “ID) = .TextMatrix(lngRow1, COL_÷¥––ø∆ “ID)
                        End If
                    ElseIf Val(.TextMatrix(i, COL_÷¥–––‘÷ )) <> 5 And Val(.Cell(flexcpData, i, COL_÷¥–––‘÷ )) = 5 Then
                        'µ±«∞–– «¿Î‘∫¥¯“©,‘Ú…Ë÷√Œ™”Îµ⁄“ª––œ‡Õ¨
                        .TextMatrix(i, COL_÷¥–––‘÷ ) = .TextMatrix(lngRow1, COL_÷¥–––‘÷ )
                        If Val(.TextMatrix(i, COL_÷¥––ø∆ “ID)) = 0 Then
                            .TextMatrix(i, COL_÷¥––ø∆ “ID) = .TextMatrix(lngRow1, COL_÷¥––ø∆ “ID)
                        End If
                    Else
                        '∑Ò‘Ú±£≥÷≤ª±‰
                    End If
                    
                    '±Íº«Œ™–ﬁ∏ƒ:0-‘≠ ºµƒ,1-–¬‘ˆµƒ,2-–ﬁ∏ƒ¡Àƒ⁄»›,3-–ﬁ∏ƒ¡À–Ú∫≈
                    If InStr(",0,3,", .TextMatrix(i, COL_EDIT)) > 0 Then
                        .TextMatrix(i, COL_EDIT) = 2
                        .TextMatrix(i, COL_◊¥Ã¨) = 1 '–ﬁ∏ƒ∫Û±‰Œ™–¬ø™
                    End If
                Else
                    Exit For
                End If
            End If
        Next
    
        'ºÏ≤È’‚–©“©∆∑÷– «∑Ò¥Ê‘⁄≈‰÷∆÷––ƒƒ√“©µƒ£¨“‘µ⁄“ª∏ˆŒ™◊º
        For i = lngRow1 To .Rows - 1
            If Val(.TextMatrix(i, COL_”§∂˘)) = cbo”§∂˘.ListIndex Then
                If Val(.TextMatrix(i, COL_œ‡πÿID)) = lngœ‡πÿID Then
                    '◊‘±∏“©µƒ«Èøˆ≤ªπ‹À¸
                    If Not (Val(.TextMatrix(i, COL_÷¥––ø∆ “ID)) = 0 And Val(.TextMatrix(i, COL_÷¥–––‘÷ )) = 5) Then
                        If Have≤ø√≈–‘÷ (Val(.TextMatrix(i, COL_÷¥––ø∆ “ID)), "≈‰÷∆÷––ƒ") Then
                            lng≈‰÷∆÷––ƒ = Val(.TextMatrix(i, COL_÷¥––ø∆ “ID)): Exit For
                        End If
                    End If
                Else
                    Exit For
                End If
            End If
        Next
        '≈‰÷∆÷––ƒ“ª◊Èœ‡Õ¨
        If lng≈‰÷∆÷––ƒ <> 0 Then
            For i = lngRow1 To .Rows - 1
                If Val(.TextMatrix(i, COL_”§∂˘)) = cbo”§∂˘.ListIndex Then
                    If Val(.TextMatrix(i, COL_œ‡πÿID)) = lngœ‡πÿID Then
                        '◊‘±∏“©µƒ«Èøˆ≤ªπ‹À¸
                        If Not (Val(.TextMatrix(i, COL_÷¥––ø∆ “ID)) = 0 And Val(.TextMatrix(i, COL_÷¥–––‘÷ )) = 5) Then
                            .TextMatrix(i, COL_÷¥––ø∆ “ID) = lng≈‰÷∆÷––ƒ
                            
                            '±Íº«Œ™–ﬁ∏ƒ:0-‘≠ ºµƒ,1-–¬‘ˆµƒ,2-–ﬁ∏ƒ¡Àƒ⁄»›,3-–ﬁ∏ƒ¡À–Ú∫≈
                            If InStr(",0,3,", .TextMatrix(i, COL_EDIT)) > 0 Then
                                .TextMatrix(i, COL_EDIT) = 2
                                .TextMatrix(i, COL_◊¥Ã¨) = 1 '–ﬁ∏ƒ∫Û±‰Œ™–¬ø™
                            End If
                        End If
                    Else
                        Exit For
                    End If
                End If
            Next
        End If
        
        'ø™ º÷¥–– ±º‰¥¶¿Ì(–¬ø™µƒ≤ªƒ‹Ã´‘Á)
        strStart = ""
        For i = lngRow1 To lngRow2
            If Val(.TextMatrix(i, COL_”§∂˘)) = cbo”§∂˘.ListIndex Then
                If Val(.TextMatrix(i, COL_EDIT)) = 1 Then
                    If DateDiff("n", CDate(.Cell(flexcpData, i, COL_ø™ º ±º‰)), curDate) > gint√≈’Ô–¬ø™“Ω÷ˆº‰∏Ù Then
                        strStart = GetDefaultTime(i): Exit For
                    End If
                End If
            End If
        Next
        If strStart <> "" Then
            For i = lngRow1 To lngRow2 + 1
                If Val(.TextMatrix(i, COL_”§∂˘)) = cbo”§∂˘.ListIndex Then
                    .Cell(flexcpData, i, COL_ø™ º ±º‰) = strStart
                    .TextMatrix(i, COL_ø™ º ±º‰) = Format(strStart, "yyyy-MM-dd HH:mm")
                End If
            Next
        End If
        
        Call ReSet…Û∫À◊¥Ã¨Õº±Í(lngBegin)
    
        mblnRowChange = varTmp1: .Redraw = varTmp2
        mblnNoSave = True '±Íº«Œ™Œ¥±£¥Ê
    End With
End Sub

Private Sub AdviceSetµ•∂¿∏¯“©(ByVal lngBegin As Long, ByVal lngEnd As Long)
'π¶ƒ‹£∫»°œ˚“ª◊È“©∆∑µƒ“ª≤¢∏¯“©
'≤Œ ˝£∫∆÷π––∫≈,÷–º‰≤ª∞¸∫¨ø’––,≤ª∞¸∫¨◊Ó∫Û“ª––“©∆∑µƒ∏¯“©Õææ∂––
    Dim varTmp1 As Variant, varTmp2 As Variant
    Dim lng∏¯“©Õææ∂ID As Long, lng∏¯“©÷¥––ID As Long, i As Long
    Dim int÷¥–––‘÷  As Integer, str÷¥–––‘÷  As String, strµŒÀŸ As String
    Dim lngRow As Long, curDate As Date, blnUpdate As Boolean
    
    With vsAdvice
        varTmp1 = mblnRowChange: varTmp2 = .Redraw
        mblnRowChange = False: .Redraw = flexRDNone
        
        '“ª≤¢∏¯“©Õææ∂
        lngRow = .FindRow(CLng(.TextMatrix(lngEnd, COL_œ‡πÿID)), lngEnd + 1)
        lng∏¯“©Õææ∂ID = Val(.TextMatrix(lngRow, COL_’Ô¡∆œÓƒøID))
        lng∏¯“©÷¥––ID = Val(.TextMatrix(lngRow, COL_÷¥––ø∆ “ID))
        int÷¥–––‘÷  = Val(.TextMatrix(lngRow, COL_÷¥–––‘÷ ))
        strµŒÀŸ = .TextMatrix(lngRow, COL_“Ω…˙÷ˆÕ–)
                
        'ºÏ≤È“Ω…˙±‰∏¸:“‘∏¯“©Õææ∂––Œ™◊º±‰ªØ
        If .TextMatrix(lngRow, COL_ø™÷ˆ“Ω…˙) <> UserInfo.–’√˚ Then
            '∏¸–¬œ‡πÿ–≈œ¢: ÷π§≤Ÿ◊˜ÕÍ≥… ±”–Ω¯»ÎΩÁ√ÊÀ¢–¬
            .TextMatrix(lngRow, COL_ø™÷ˆ“Ω…˙) = UserInfo.–’√˚
            .TextMatrix(lngRow, COL_ø™÷ˆø∆ “ID) = Getø™÷ˆø∆ “ID(UserInfo.ID, mlng“Ωººø∆ “ID, mlng≤°»Àø∆ “id, 1)
            curDate = zlDatabase.Currentdate
            .TextMatrix(lngRow, COL_ø™÷ˆ ±º‰) = Format(curDate, "yyyy-MM-dd HH:mm")
            .Cell(flexcpData, lngRow, COL_ø™÷ˆ ±º‰) = Format(curDate, "yyyy-MM-dd HH:mm")
            
            If InStr(",0,3,", .TextMatrix(lngRow, COL_EDIT)) > 0 Then
                .TextMatrix(lngRow, COL_EDIT) = 2 '±Íº«Œ™“—–ﬁ∏ƒ
                .TextMatrix(lngRow, COL_◊¥Ã¨) = 1 '–ﬁ∏ƒ∫Û±‰Œ™–¬ø™
            End If
            blnUpdate = True
        End If
                
        'œ‘ æΩÙº±±Í÷æ:√ø“ª––
        For i = lngBegin To lngEnd
            If Val(.TextMatrix(i, COL_”§∂˘)) = cbo”§∂˘.ListIndex Then
                '“©∆∑––œ‡”¶±‰ªØ
                If blnUpdate Then
                    .TextMatrix(i, COL_ø™÷ˆ“Ω…˙) = .TextMatrix(lngRow, COL_ø™÷ˆ“Ω…˙)
                    .TextMatrix(i, COL_ø™÷ˆø∆ “ID) = .TextMatrix(lngRow, COL_ø™÷ˆø∆ “ID)
                    .TextMatrix(i, COL_ø™÷ˆ ±º‰) = .TextMatrix(lngRow, COL_ø™÷ˆ ±º‰)
                    .Cell(flexcpData, i, COL_ø™÷ˆ ±º‰) = .Cell(flexcpData, lngRow, COL_ø™÷ˆ ±º‰)
                    If InStr(",0,3,", .TextMatrix(i, COL_EDIT)) > 0 Then
                        .TextMatrix(i, COL_EDIT) = 2 '±Íº«Œ™“—–ﬁ∏ƒ
                        .TextMatrix(i, COL_◊¥Ã¨) = 1 '–ﬁ∏ƒ∫Û±‰Œ™–¬ø™
                    End If
                End If
                If gblnKSSStrict And UserInfo.”√“©º∂± < Val(.TextMatrix(i, COL_øπæ˙µ»º∂)) And .TextMatrix(i, COL_±Í÷æ) <> "1" Then
                    .TextMatrix(i, COL_…Û∫À◊¥Ã¨) = 1
                Else
                    .TextMatrix(i, COL_…Û∫À◊¥Ã¨) = ""
                End If
                Call SetRow±Í÷æÕº±Í(i, 2)
            End If
        Next
        
        For i = lngEnd - 1 To lngBegin Step -1 '±ÿ–Î∑¥œÚ
            If Val(.TextMatrix(i, COL_”§∂˘)) = cbo”§∂˘.ListIndex Then
                '…Ë÷√∏¯“©Õææ∂––
                If Val(.TextMatrix(i, COL_÷¥–––‘÷ )) = 5 And int÷¥–––‘÷  <> 5 Then
                    str÷¥–––‘÷  = "◊‘±∏“©"
                ElseIf Val(.TextMatrix(i, COL_÷¥–––‘÷ )) <> 5 And int÷¥–––‘÷  = 5 Then
                    str÷¥–––‘÷  = "¿Î‘∫¥¯“©"
                Else
                    str÷¥–––‘÷  = ""
                End If
                .TextMatrix(i, COL_œ‡πÿID) = "" '±ÿ–Î«Â≥˝◊˜Œ™±Í÷æ
                .TextMatrix(i, COL_œ‡πÿID) = AdviceSet∏¯“©Õææ∂(i, lng∏¯“©Õææ∂ID, str÷¥–––‘÷ , lng∏¯“©÷¥––ID, strµŒÀŸ)
                
                If InStr(",0,3,", .TextMatrix(i, COL_EDIT)) > 0 Then
                    .TextMatrix(i, COL_EDIT) = 2 '±Íº«Œ™“—–ﬁ∏ƒ
                    .TextMatrix(i, COL_◊¥Ã¨) = 1 '–ﬁ∏ƒ∫Û±‰Œ™–¬ø™
                End If
            End If
        Next
        
        mblnRowChange = varTmp1: .Redraw = varTmp2
        mblnNoSave = True '±Íº«Œ™Œ¥±£¥Ê
    End With
End Sub

Private Sub ShowAdvice()
'π¶ƒ‹£∫œ‘ æµ±«∞ΩÁ√ÊÃıº˛œ¬µƒ“Ω÷ˆº«¬º
'Àµ√˜£∫1.∏˘æ›≥Ã–Ú±‡º≠∑Ω Ω,œ‡πÿµƒ ˝æ›–– «∞¥–Ú∫≈—œ∏Ò≈≈¡–‘⁄“ª‘⁄µƒ°£
'      2.’‚¿Ô≤ª¥¶¿Ì“ª≤¢∏¯“©µƒ±ﬂøÚº∞≈‰∑Ω––∏ﬂ£¨◊¥Ã¨—’…´µ»∏Ò Ωƒ⁄»›,À¸√«“—‘⁄∂¡»°ªÚ±‡º≠ ±…Ë÷√
    Dim lngRow As Long, blnHide As Boolean, i As Long
    
    Screen.MousePointer = 11
    mblnRowChange = False
    vsAdvice.Redraw = flexRDNone
        
    'œ»…æ≥˝Œﬁ–ß––
    For i = vsAdvice.Rows - 1 To vsAdvice.FixedRows Step -1
        If vsAdvice.RowData(i) = 0 Then vsAdvice.RemoveItem i
    Next
    
    '∏˘æ›µ±«∞∆⁄–ß,”§∂˘œ‘ æ
    With vsAdvice
        For i = .FixedRows To .Rows - 1
            If Val(.TextMatrix(i, COL_”§∂˘)) = cbo”§∂˘.ListIndex Then
                blnHide = False
                '“˛≤ÿ“‘œ¬ ˝æ›––£∫
                '1.≥…“©µƒ∏¯“©Õææ∂––
                '2. ÷ ıµƒ∏Ωº” ÷ ıº∞¬È◊ÌœÓƒø––
                '3.ºÏ≤È◊È∫œµƒ≤øŒª––
                '4.÷–“©≈‰∑Ωµƒ◊È≥…Œ∂÷–“©º∞÷–“©ºÂ∑®––
                '5.(“ª≤¢≤…ºØµƒ)ºÏ—ÈœÓƒø
                '6. ‰—™œÓƒøµƒ ‰—™Õææ∂
                If .TextMatrix(i, COL_¿‡±) = "E" And Val(.TextMatrix(i, COL_œ‡πÿID)) = 0 Then
                    If Val(.TextMatrix(i - 1, COL_œ‡πÿID)) = .RowData(i) _
                        And InStr(",5,6,", .TextMatrix(i - 1, COL_¿‡±)) > 0 Then
                        blnHide = True
                    End If
                End If
                If InStr(",F,G,D,7,E,C,", .TextMatrix(i, COL_¿‡±)) > 0 _
                    And Val(.TextMatrix(i, COL_œ‡πÿID)) <> 0 Then
                    blnHide = True
                End If
                                
                .RowHidden(i) = blnHide
                If Not blnHide And lngRow = 0 Then lngRow = i
                
                'º∆À„’Ô¡∆µ•º€:’‚¿ÔŒ™º”øÏÀŸ∂»,÷ª∂¡»°–¬ø™µƒ,∆‰À¸µƒΩ¯»Î‘Ÿ∂¡
                If Not .RowHidden(i) _
                    And Val(.TextMatrix(i, COL_◊¥Ã¨)) = 1 And .TextMatrix(i, COL_µ•º€) = "" Then
                    .TextMatrix(i, COL_µ•º€) = GetItemPrice(i)
                End If
            Else
                .RowHidden(i) = True
            End If
        Next
    End With
    
    '√ª”– ˝æ›––,ÃÌº”“ª––ø’
    If lngRow = 0 Then
        vsAdvice.AddItem ""
        lngRow = vsAdvice.Rows - 1
    End If
    
    vsAdvice.Row = lngRow
    If vsAdvice.RowData(lngRow) = 0 Then
        vsAdvice.Col = vsAdvice.FixedCols
    Else
        vsAdvice.Col = col_“Ω÷ˆƒ⁄»›
    End If
    vsAdvice.Redraw = flexRDDirect
    mblnRowChange = True
    
    'œ‘ æµ±«∞––:Ω¯»Î ±‘⁄FormLoad÷–¥¶¿Ì,“‘º”øÏÀŸ∂»
    If Me.Visible Then Call vsAdvice_AfterRowColChange(-1, -1, vsAdvice.Row, vsAdvice.Col)
    
    Call CalcAdviceMoney 'œ‘ æ–¬ø™“Ω÷ˆΩ∂Ó
    
    Screen.MousePointer = 0
End Sub

Private Function SaveAdvice() As Boolean
'π¶ƒ‹£∫±£¥Êµ±«∞≤°»Àµƒ“Ω÷ˆº«¬º
    Dim arrSQL As Variant, arrDelID() As String
    Dim strSQL As String, dbl◊‹¡ø As Double
    Dim arrAppend As Variant, i As Long, j As Long
    Dim blnChecked As Boolean
    Dim curDate As Date
    Dim blnTrans As Boolean
    Dim blnDiagChange As Boolean, blnRecipeNo As Boolean
    Dim strFilter As String, strTmp As String
    Dim rsMsg As ADODB.Recordset
    Dim blnMsgOk As Boolean
    Dim lng’Ô∂œº«¬ºid As Long
    Dim strº«¬º»À As String
    Dim str∏¯“©IDs As String
    Dim lngœ‡πÿID As Long
    Dim str≥∑œ˙∏¯“©IDs As String
    Dim rsCard As ADODB.Recordset
    Dim rsBlood As ADODB.Recordset, intBloodState As Integer
    Dim varTmp As Variant
    Dim blnRIS As Boolean 'RISΩ”ø⁄
    Dim strNewAdvice As String '–¬‘ˆ∫Õ–ﬁ∏ƒ∫Ûµƒ“Ω÷ˆ ∏Ò Ω “Ω÷ˆID:’Ô¡∆œÓƒøID,....
    Dim str±æ¥Œ±‰∂Ø As String '±æ¥Œ…æ≥˝∫Õ–ﬁ∏ƒµƒ“Ω÷ˆ£¨”√”⁄≈–∂œRIS‘§‘ºµƒ“Ω÷ˆ «∑Ò“—æ≠±ª‘§‘º£¨“—æ≠±ª‘§‘ºµƒ“Ω÷ˆ≤ªƒ‹…æ
    Dim rsTmp As ADODB.Recordset
    Dim rs ‰—™ As ADODB.Recordset ' ‰—™“Ω÷ˆ—™ø‚Ω”ø⁄µ˜”√ ±µƒ≤Œ ˝–≈œ¢
    Dim bln—™ø‚ As Boolean ' «∑Ò–Ë“™Ω¯––—™ø‚Ω”ø⁄µ˜”√
    Dim strAdvices ‰—™ As String
    Dim strErr As String
    Dim bln”√—™…Û∫À As Boolean
    
    If HaveRIS And gbln∆Ù”√”∞œÒ–≈œ¢œµÕ≥‘§‘º Then
        blnRIS = True
    ElseIf gbln∆Ù”√”∞œÒ–≈œ¢œµÕ≥Ω”ø⁄ = True And gbln∆Ù”√”∞œÒ–≈œ¢œµÕ≥‘§‘º = True Then
        MsgBox "RISΩ”ø⁄¥¥Ω® ß∞‹£¨≤ªƒ‹ºÃ–¯µ±«∞≤Ÿ◊˜°£ø…ƒ‹ «Ω”ø⁄Œƒº˛∞≤◊∞ªÚ◊¢≤·≤ª’˝≥££¨«Î”ÎœµÕ≥π‹¿Ì‘±¡™œµ°£", vbInformation, gstrSysName
        Exit Function
    End If
    
    'ÃÊªª≥…’Ê µµƒ“Ω÷ˆID£¨∞¸¿®’Ô∂œ“Ω÷ˆ∂‘”¶
    Call MakeRealID
    
    'Pass◊‘∂Ø”√“©…Û≤È
    If mblnPass Then
        If gobjPass.HaveRecipNo() Then
            Call UpdateRecipeNo '∫º÷›“›Í◊
            blnRecipeNo = True
        End If
        If gobjPass.zlPassCheck(mobjPassMap) Then
            If Not gobjPass.zlPassAdviceSave(mobjPassMap, mblnNoSave) Then Exit Function
        End If
    End If

    'µ˜”√Õ‚π“Ω”ø⁄
    If CreatePlugInOK(p√≈’Ô“Ω÷ˆœ¬¥Ô, mint≥°∫œ) Then
        If zlPluginAdviceSave = False Then Exit Function
    End If

    Screen.MousePointer = 11
    
    If gbln—™ø‚œµÕ≥ Then bln—™ø‚ = InitObjBlood()
    Set rs ‰—™ = New ADODB.Recordset
    With rs ‰—™
        .Fields.Append "“Ω÷ˆID", adBigInt
        .Fields.Append "¿‡–Õ", adInteger '0£≠–¬ø™£¨1£≠–ﬁ∏ƒ£¨2£≠…æ≥˝
        .Fields.Append "◊¥Ã¨", adInteger '0-µ˜”√—™ø‚Ω”ø⁄,1-≤ªµÙ”√—™ø‚Ω”ø⁄(”√—™“Ω÷ˆ…Û∫À)
        .CursorLocation = adUseClient
        .LockType = adLockOptimistic
        .CursorType = adOpenStatic
        .Open
    End With
    If mstrDel ‰—™ <> "" Then
        arrDelID = Split(mstrDel ‰—™, ",")
        For i = 0 To UBound(arrDelID)
            If Val(arrDelID(i)) <> 0 Then
                Call rs ‰—™.AddNew(Array("“Ω÷ˆID", "¿‡–Õ"), Array(Val(arrDelID(i)), 2))
            End If
        Next
    End If
    
    If Not (mclsMipModule Is Nothing) Then
        blnMsgOk = mclsMipModule.IsConnect
    Else
        blnMsgOk = False
    End If
    
    '…˙≥…SQL
    arrSQL = Array()
    curDate = zlDatabase.Currentdate

        '¥¶∑Ω…Û≤ÈœµÕ≥
    If InitObjRecipeAudit(p√≈’Ô“Ω÷ˆœ¬¥Ô) Then
        For i = vsAdvice.FixedRows To vsAdvice.Rows - 1
            If Val(vsAdvice.TextMatrix(i, COL_EDIT)) = 2 Then
                If vsAdvice.TextMatrix(i, COL_¿‡±) = "5" Or vsAdvice.TextMatrix(i, COL_¿‡±) = "6" Or vsAdvice.TextMatrix(i, COL_¿‡±) = "7" Then
                    If vsAdvice.TextMatrix(i, COL_¥¶∑Ω…Û≤È◊¥Ã¨) = "1" Or vsAdvice.TextMatrix(i, COL_¥¶∑Ω…Û≤È◊¥Ã¨) = "2" Then
                        If InStr("," & mstrAduitDelIDs & ",", "," & vsAdvice.TextMatrix(i, COL_œ‡πÿID) & ",") = 0 And vsAdvice.TextMatrix(i, COL_œ‡πÿID) <> "" Then
                            mstrAduitDelIDs = mstrAduitDelIDs & "," & vsAdvice.TextMatrix(i, COL_œ‡πÿID)
                        End If
                    End If
                    If vsAdvice.TextMatrix(i, COL_¥¶∑Ω…Û≤È◊¥Ã¨) <> "" Then
                        If InStr("," & str≥∑œ˙∏¯“©IDs & ",", "," & vsAdvice.TextMatrix(i, COL_œ‡πÿID) & ",") = 0 And vsAdvice.TextMatrix(i, COL_œ‡πÿID) <> "" Then
                            str≥∑œ˙∏¯“©IDs = str≥∑œ˙∏¯“©IDs & "," & vsAdvice.TextMatrix(i, COL_œ‡πÿID)
                        End If
                    End If
                End If
            End If
        Next
        mstrAduitDelIDs = Mid(mstrAduitDelIDs, 2)
        For i = 0 To UBound(Split(mstrAduitDelIDs, ","))
            If InStr("," & str≥∑œ˙∏¯“©IDs & ",", "," & Split(mstrAduitDelIDs, ",")(i) & ",") = 0 Then
                str≥∑œ˙∏¯“©IDs = str≥∑œ˙∏¯“©IDs & "," & Split(mstrAduitDelIDs, ",")(i)
            End If
        Next
        str≥∑œ˙∏¯“©IDs = Mid(str≥∑œ˙∏¯“©IDs, 2)
        '»Áπ˚”–“ª∏ˆ±ªºŸ…æ≥˝£¨‘Ú’˚◊ÈºŸ…æ≥˝
        If mstrAduitDelIDs <> "" Then
            For i = vsAdvice.FixedRows To vsAdvice.Rows - 1
                If InStr("," & mstrAduitDelIDs & ",", "," & vsAdvice.RowData(i) & ",") > 0 Then
                    lngœ‡πÿID = vsAdvice.RowData(i)
                    vsAdvice.RowData(i) = zlDatabase.GetNextID("≤°»À“Ω÷ˆº«¬º")
                    vsAdvice.TextMatrix(i, COL_EDIT) = 1
                    For j = i - 1 To vsAdvice.FixedRows Step -1
                        If Val(vsAdvice.TextMatrix(j, COL_œ‡πÿID)) <> lngœ‡πÿID Then Exit For
                        vsAdvice.TextMatrix(j, COL_œ‡πÿID) = vsAdvice.RowData(i)
                        vsAdvice.RowData(j) = zlDatabase.GetNextID("≤°»À“Ω÷ˆº«¬º")
                        vsAdvice.TextMatrix(j, COL_EDIT) = 1
                    Next
                End If
            Next

            ReDim Preserve arrSQL(UBound(arrSQL) + 1)
            arrSQL(UBound(arrSQL)) = "Zl_≤°»À“Ω÷ˆº«¬º_¥¶∑Ω…Û≤È…æ≥˝('" & mstrAduitDelIDs & "')"
        End If
        If str≥∑œ˙∏¯“©IDs <> "" Then
            '≤˙…˙¡À¥¶∑Ω…Û≤È ˝æ›µƒ∂º“™≥∑œ˙
            Call gobjRecipeAudit.CancelData(str≥∑œ˙∏¯“©IDs, "")
        End If
    End If
    
    '…æ≥˝¡Àµƒº«¬º
    arrDelID = Split(mstrDelIDs, ",")
    For i = 0 To UBound(arrDelID)
        If Val(arrDelID(i)) <> 0 Then
            ReDim Preserve arrSQL(UBound(arrSQL) + 1)
            arrSQL(UBound(arrSQL)) = "ZL_≤°»À“Ω÷ˆº«¬º_Delete(" & Val(arrDelID(i)) & ")"
            If blnRIS Then str±æ¥Œ±‰∂Ø = str±æ¥Œ±‰∂Ø & "," & Val(arrDelID(i))
        End If
    Next

    '±‡º≠±Í÷æ£∫0-‘≠ ºµƒ,1-–¬‘ˆµƒ,2-–ﬁ∏ƒ¡Àƒ⁄»›,3-–ﬁ∏ƒ¡À–Ú∫≈
    With vsAdvice
        For i = .FixedRows To .Rows - 1
            If .RowData(i) <> 0 Then    'À˘”–“Ω÷ˆº«¬º
                '◊‹¡ø◊™ªª
                dbl◊‹¡ø = 0
                If InStr(",1,2,", .TextMatrix(i, COL_EDIT)) > 0 Then
                    If Val(.TextMatrix(i, COL_◊‹¡ø)) <> 0 Then
                        If InStr(",5,6,", .TextMatrix(i, COL_¿‡±)) > 0 Then
                            '≥…“©◊™ªª≥…¡„ €µ•Œª
                            dbl◊‹¡ø = Format(Val(.TextMatrix(i, COL_◊‹¡ø)) * Val(.TextMatrix(i, COL_√≈’Ô∞¸◊∞)), "0.00000")
                        Else
                            '÷–“©≈‰∑Ω∏∂ ˝ªÚ∑«“©¡Ÿ÷ˆ◊‹¡ø,≤ª◊™ªª
                            dbl◊‹¡ø = Val(.TextMatrix(i, COL_◊‹¡ø))
                        End If
                    End If
                End If

                '33629
                '¬È◊Ì“©∆∑∫Õµ⁄“ª¿‡æ´…Ò“©∆∑¥¶∑Ωªπ”¶µ±∞¸¿®ªº’ﬂ…Ì∑›÷§√˜±‡∫≈£¨¥˙∞Ï»À–’√˚°¢…Ì∑›÷§√˜±‡∫≈°£
                If blnChecked = False And mblnAddAgent Then
                    If .RowHidden(i) = False And AgentInfo.±æ¥ŒæÕ’Ô“—¬º»Î = False Then
                        If Val(.TextMatrix(i, COL_◊¥Ã¨)) = 1 And InStr(",¬È◊Ì“©,∂æ–‘“©,æ´…ÒI¿‡,", "," & Trim(.TextMatrix(i, COL_∂æ¿Ì∑÷¿‡)) & ",") > 0 Then
                            blnChecked = frmAgentInfo.ShowMe(Me, mlng≤°»ÀID, mlngπ“∫≈ID, mstr–’√˚, mstr…Ì∑›÷§∫≈, AgentInfo.¥˙∞Ï»À–’√˚, AgentInfo.¥˙∞Ï»À…Ì∑›÷§∫≈)
                            If blnChecked Then
                                Call GetAgentInfo
                            Else
                                Screen.MousePointer = 0
                                Exit Function
                            End If
                        End If
                    End If
                End If
                
                If .TextMatrix(i, COL_¿‡±) = "K" And bln—™ø‚ Then
                    If Val(.TextMatrix(i, COL_EDIT)) = 2 Then
                        intBloodState = 0
                        '”√—™“Ω÷ˆ“—æ≠∑¢—™£¨‘Ú–ﬁ∏ƒ“Ω÷ˆ…Û∫À◊¥Ã¨Œ™2
                        If Val(.TextMatrix(i, COL_ºÏ≤È∑Ω∑®)) = 1 Then
                            If gobjPublicBlood.GetPrepareBloodRs(Val(.RowData(i)), rsBlood) = True Then
                                If Val(rsBlood!º«¬º–‘÷  & "") = 2 And Val(rsBlood!º«¬º◊¥Ã¨ & "") = 1 Then
                                    .TextMatrix(i, COL_…Û∫À◊¥Ã¨) = 2
                                    intBloodState = 1
                                    bln”√—™…Û∫À = True
                                End If
                            End If
                        End If
                        Call rs ‰—™.AddNew(Array("“Ω÷ˆID", "¿‡–Õ", "◊¥Ã¨"), Array(Val(.RowData(i)), 1, intBloodState))
                    ElseIf Val(.TextMatrix(i, COL_EDIT)) = 1 Then
                        Call rs ‰—™.AddNew(Array("“Ω÷ˆID", "¿‡–Õ"), Array(Val(.RowData(i)), 0))
                    End If
                End If
                
                If Val(.TextMatrix(i, COL_EDIT)) = 3 Then    '–ﬁ∏ƒ¡À–Ú∫≈µƒº«¬º
                    ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                    arrSQL(UBound(arrSQL)) = "ZL_≤°»À“Ω÷ˆº«¬º_∏¸–¬–Ú∫≈(" & .RowData(i) & "," & Val(.TextMatrix(i, COL_–Ú∫≈)) & ")"
                ElseIf Val(.TextMatrix(i, COL_EDIT)) = 2 Then    '–ﬁ∏ƒ¡Àƒ⁄»›µƒº«¬º
                    ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                    arrSQL(UBound(arrSQL)) = "ZL_≤°»À“Ω÷ˆº«¬º_Update(" & _
                                             .RowData(i) & "," & ZVal(.TextMatrix(i, COL_œ‡πÿID)) & "," & _
                                             Val(.TextMatrix(i, COL_–Ú∫≈)) & "," & Val(.TextMatrix(i, COL_◊¥Ã¨)) & ",1," & _
                                             Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID)) & "," & ZVal(.TextMatrix(i, COL_ ’∑—œ∏ƒøID)) & "," & _
                                             ZVal(.TextMatrix(i, COL_ÃÏ ˝)) & "," & ZVal(.TextMatrix(i, COL_µ•¡ø)) & "," & ZVal(dbl◊‹¡ø) & "," & _
                                             "'" & Replace(.TextMatrix(i, col_“Ω÷ˆƒ⁄»›), "'", "''") & "','" & Replace(.TextMatrix(i, COL_“Ω…˙÷ˆÕ–), "'", "''") & "'," & _
                                             "'" & .TextMatrix(i, COL_±Í±æ≤øŒª) & "','" & .TextMatrix(i, COL_∆µ¬ ) & "'," & _
                                             ZVal(.TextMatrix(i, COL_∆µ¬ ¥Œ ˝)) & "," & ZVal(.TextMatrix(i, COL_∆µ¬ º‰∏Ù)) & "," & _
                                             "'" & .TextMatrix(i, COL_º‰∏Ùµ•Œª) & "','" & .TextMatrix(i, COL_÷¥–– ±º‰) & "'," & _
                                             Val(.TextMatrix(i, COL_º∆º€–‘÷ )) & "," & ZVal(.TextMatrix(i, COL_÷¥––ø∆ “ID)) & "," & _
                                             Val(.TextMatrix(i, COL_÷¥–––‘÷ )) & "," & Val(.TextMatrix(i, COL_±Í÷æ)) & "," & _
                                             "To_Date('" & Format(.Cell(flexcpData, i, COL_ø™ º ±º‰), "yyyy-MM-dd HH:mm") & "','YYYY-MM-DD HH24:MI'),NULL," & _
                                             mlng≤°»Àø∆ “id & "," & Val(.TextMatrix(i, COL_ø™÷ˆø∆ “ID)) & ",'" & .TextMatrix(i, COL_ø™÷ˆ“Ω…˙) & "'," & _
                                             "To_Date('" & Format(.Cell(flexcpData, i, COL_ø™÷ˆ ±º‰), "yyyy-MM-dd HH:mm") & "','YYYY-MM-DD HH24:MI')," & _
                                             "'" & .TextMatrix(i, COL_ºÏ≤È∑Ω∑®) & "'," & Val(.TextMatrix(i, COL_÷¥––±Íº«)) & "," & _
                                             "NULL,'" & .Cell(flexcpData, i, COL_“Ω…˙÷ˆÕ–) & "','" & UserInfo.–’√˚ & "'," & ZVal(.TextMatrix(i, COL_¡„∑—º«’ )) & "," & _
                                             ZVal(Val(.TextMatrix(i, COL_”√“©ƒøµƒ))) & ",'" & .TextMatrix(i, COL_”√“©¿Ì”…) & "'," & ZVal(Val(.TextMatrix(i, COL_…Û∫À◊¥Ã¨))) & ",'" & .TextMatrix(i, COL_≥¨¡øÀµ√˜) & "'" & _
                                             ",'',Null," & ZVal(Val(.TextMatrix(i, COL_◊È∫œœÓƒøID))) & ",NULL," & IIF(blnRecipeNo, Val(.TextMatrix(i, COL_¥¶∑Ω–Ú∫≈)), "NULL") & ")"
                ElseIf Val(.TextMatrix(i, COL_EDIT)) = 1 Then    '–¬‘ˆµƒº«¬º
                
                    If .TextMatrix(i, COL_¿‡±) = "K" Then
                        ' ‰—™¿‡“Ω÷ˆ¥”–¬ªÒ»°“Ω÷ˆ…Û∫À◊¥Ã¨
                        If TypeName(.Cell(flexcpData, i, COL_…Í«Î–Ú∫≈)) = "Recordset" Then
                            Set rsCard = zlDatabase.CopyNewRec(.Cell(flexcpData, i, COL_…Í«Î–Ú∫≈))
                            If Not rsCard.EOF Then
                                rsCard.MoveFirst
                                strTmp = Nvl(rsCard!…Í«ÎœÓƒø & "", .TextMatrix(i, COL_’Ô¡∆œÓƒøID) & "," & dbl◊‹¡ø)
                                .TextMatrix(i, COL_…Û∫À◊¥Ã¨) = GetBloodVerifyState(1, mlng≤°»ÀID, mlngπ“∫≈ID, .TextMatrix(i, COL_±Í±æ≤øŒª), GetBloodTotalByML(strTmp), Val(.TextMatrix(i, COL_±Í÷æ)), Val(.TextMatrix(i, COL_ºÏ≤È∑Ω∑®)), Val(.TextMatrix(i, COL_”§∂˘)), .RowData(i), strTmp)
                                If i < .Rows - 1 Then
                                    If Val(.TextMatrix(i + 1, COL_œ‡πÿID)) = .RowData(i) Then
                                        .TextMatrix(i + 1, COL_…Û∫À◊¥Ã¨) = .TextMatrix(i, COL_…Û∫À◊¥Ã¨)
                                    End If
                                End If
                                Call SetRow±Í÷æÕº±Í(i, 2)
                            End If
                        Else
                            '∑«…Í«Îµ•œ¬¥Ôµƒ“Ω÷ˆ
                            If bln—™ø‚ Then
                                strTmp = .TextMatrix(i, COL_’Ô¡∆œÓƒøID) & "," & dbl◊‹¡ø
                                .TextMatrix(i, COL_…Û∫À◊¥Ã¨) = GetBloodVerifyState(1, mlng≤°»ÀID, mlngπ“∫≈ID, .TextMatrix(i, COL_±Í±æ≤øŒª), GetBloodTotalByML(strTmp), Val(.TextMatrix(i, COL_±Í÷æ)), Val(.TextMatrix(i, COL_ºÏ≤È∑Ω∑®)), Val(.TextMatrix(i, COL_”§∂˘)), .RowData(i), strTmp)
                                If i < .Rows - 1 Then
                                    If Val(.TextMatrix(i + 1, COL_œ‡πÿID)) = .RowData(i) Then
                                        .TextMatrix(i + 1, COL_…Û∫À◊¥Ã¨) = .TextMatrix(i, COL_…Û∫À◊¥Ã¨)
                                    End If
                                End If
                                Call SetRow±Í÷æÕº±Í(i, 2)
                            End If
                        End If
                    End If
                    
                    ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                    arrSQL(UBound(arrSQL)) = "ZL_≤°»À“Ω÷ˆº«¬º_Insert(" & _
                                             .RowData(i) & "," & ZVal(.TextMatrix(i, COL_œ‡πÿID)) & "," & _
                                             Val(.TextMatrix(i, COL_–Ú∫≈)) & ",1," & mlng≤°»ÀID & ",NULL," & _
                                             Val(.TextMatrix(i, COL_”§∂˘)) & "," & Val(.TextMatrix(i, COL_◊¥Ã¨)) & ",1," & _
                                             "'" & IIF(.TextMatrix(i, COL_¿‡±) = "*", "", .TextMatrix(i, COL_¿‡±)) & "'," & Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID)) & "," & _
                                             ZVal(.TextMatrix(i, COL_ ’∑—œ∏ƒøID)) & "," & _
                                             ZVal(.TextMatrix(i, COL_ÃÏ ˝)) & "," & ZVal(.TextMatrix(i, COL_µ•¡ø)) & "," & ZVal(dbl◊‹¡ø) & "," & _
                                             "'" & Replace(.TextMatrix(i, col_“Ω÷ˆƒ⁄»›), "'", "''") & "','" & Replace(.TextMatrix(i, COL_“Ω…˙÷ˆÕ–), "'", "''") & "'," & _
                                             "'" & .TextMatrix(i, COL_±Í±æ≤øŒª) & "','" & .TextMatrix(i, COL_∆µ¬ ) & "'," & _
                                             ZVal(.TextMatrix(i, COL_∆µ¬ ¥Œ ˝)) & "," & ZVal(.TextMatrix(i, COL_∆µ¬ º‰∏Ù)) & "," & _
                                             "'" & .TextMatrix(i, COL_º‰∏Ùµ•Œª) & "','" & .TextMatrix(i, COL_÷¥–– ±º‰) & "'," & _
                                             Val(.TextMatrix(i, COL_º∆º€–‘÷ )) & "," & ZVal(.TextMatrix(i, COL_÷¥––ø∆ “ID)) & "," & _
                                             Val(.TextMatrix(i, COL_÷¥–––‘÷ )) & "," & Val(.TextMatrix(i, COL_±Í÷æ)) & "," & _
                                             "To_Date('" & Format(.Cell(flexcpData, i, COL_ø™ º ±º‰), "yyyy-MM-dd HH:mm") & "','YYYY-MM-DD HH24:MI'),NULL," & _
                                             mlng≤°»Àø∆ “id & "," & Val(.TextMatrix(i, COL_ø™÷ˆø∆ “ID)) & ",'" & .TextMatrix(i, COL_ø™÷ˆ“Ω…˙) & "'," & _
                                             "To_Date('" & Format(.Cell(flexcpData, i, COL_ø™÷ˆ ±º‰), "yyyy-MM-dd HH:mm") & "','YYYY-MM-DD HH24:MI')," & _
                                             "'" & mstrπ“∫≈µ• & "'," & ZVal(mlng«∞Ã·ID) & ",'" & .TextMatrix(i, COL_ºÏ≤È∑Ω∑®) & "'," & _
                                             Val(.TextMatrix(i, COL_÷¥––±Íº«)) & ",NULL,'" & .Cell(flexcpData, i, COL_“Ω…˙÷ˆÕ–) & "','" & UserInfo.–’√˚ & "'," & ZVal(.TextMatrix(i, COL_¡„∑—º«’ )) & "," & _
                                             ZVal(Val(.TextMatrix(i, COL_”√“©ƒøµƒ))) & ",'" & .TextMatrix(i, COL_”√“©¿Ì”…) & "'," & ZVal(Val(.TextMatrix(i, COL_…Û∫À◊¥Ã¨))) & "," & ZVal(Val(.TextMatrix(i, COL_…Í«Î–Ú∫≈))) & ",'" & .TextMatrix(i, COL_≥¨¡øÀµ√˜) & _
                                             "',Null," & ZVal(Val(.TextMatrix(i, COL_≈‰∑ΩID))) & ",Null," & ZVal(Val(.TextMatrix(i, COL_◊È∫œœÓƒøID))) & ",NULL," & IIF(blnRecipeNo, Val(.TextMatrix(i, COL_¥¶∑Ω–Ú∫≈)), "NULL") & ")"
                    
                    
                    ' ’ºØ±æ¥Œ–¬‘ˆµƒ“Ω÷ˆ”√”⁄πÿ¡™≤°»ÀŒ£º±÷µº«¬º
                    If mlngŒ£º±÷µID <> 0 Then
                        If Val(.TextMatrix(i, COL_œ‡πÿID)) = 0 Then
                            ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                            arrSQL(UBound(arrSQL)) = "Zl_≤°»ÀŒ£º±÷µ“Ω÷ˆ_Update(1," & mlngŒ£º±÷µID & "," & .RowData(i) & ")"
                        End If
                    End If
                    
                    ' ‰—™…Í«Îµ•µƒ∂ÓÕ‚ ˝æ›±£¥Ê
                    If .TextMatrix(i, COL_¿‡±) = "K" Then
                        If TypeName(.Cell(flexcpData, i, COL_…Í«Î–Ú∫≈)) = "Recordset" Then
                            Set rsCard = zlDatabase.CopyNewRec(.Cell(flexcpData, i, COL_…Í«Î–Ú∫≈))
                            If Not rsCard.EOF Then
                                rsCard.MoveFirst
                                strTmp = rsCard!…Í«Î∆‰À˚œÓƒøSQL & ""
                                If strTmp <> "" Then
                                    strTmp = Replace(strTmp, "[œ‡πÿID]", .RowData(i))
                                    ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                                    arrSQL(UBound(arrSQL)) = strTmp
                                End If
                                strTmp = rsCard!ºÏ—ÈœÓƒøSQL & ""
                                If strTmp <> "" Then
                                    strTmp = Replace(strTmp, "[œ‡πÿID]", .RowData(i))
                                    varTmp = Split(strTmp, "<splitSQL>")
                                    For j = 0 To UBound(varTmp)
                                        If varTmp(j) <> "" Then
                                            ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                                            arrSQL(UBound(arrSQL)) = varTmp(j)
                                        End If
                                    Next
                                End If
                                strTmp = rsCard!’Ô∂œπÿ¡™–≈œ¢SQL & ""
                                If strTmp <> "" Then
                                    strTmp = Replace(strTmp, "[œ‡πÿID]", .RowData(i))
                                    varTmp = Split(strTmp, "<splitSQL>")
                                    For j = 0 To UBound(varTmp)
                                        If j = 1 Then
                                            If varTmp(j) <> "" Then
                                                ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                                                arrSQL(UBound(arrSQL)) = varTmp(j)
                                            End If
                                        End If
                                    Next
                                End If
                            End If
                        End If
                    End If
                End If
                
                If blnRIS Then
                    If InStr(",F,D,", .TextMatrix(i, COL_¿‡±)) > 0 Or InStr(",0,5,", Val(.TextMatrix(i, COL_≤Ÿ◊˜¿‡–Õ))) > 0 And .TextMatrix(i, COL_¿‡±) = "E" Then
                        If Val(.TextMatrix(i, COL_œ‡πÿID)) = 0 Then
                            If Val(.TextMatrix(i, COL_EDIT)) = 2 Then
                                str±æ¥Œ±‰∂Ø = str±æ¥Œ±‰∂Ø & "," & .RowData(i)
                            End If
                            If InStr(",1,2,", Val(.TextMatrix(i, COL_EDIT))) > 0 And Val(.TextMatrix(i, COL_±Í÷æ)) <> 1 Then
                                strNewAdvice = strNewAdvice & "," & .RowData(i) & ":" & Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID))
                            End If
                        End If
                    End If
                End If
                
                '±Íº«√‚ ‘µƒ
                If .Cell(flexcpData, i, COL_√‚ ‘) & "" <> "" & .TextMatrix(i, COL_√‚ ‘) Then
                    If .TextMatrix(i, COL_√‚ ‘) = "1" Then
                        ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                        arrSQL(UBound(arrSQL)) = "ZL_≤°»À“Ω÷ˆº«¬º_∆§ ‘(" & Val(.RowData(i)) & ",'√‚ ‘',NULL)"
                    ElseIf .TextMatrix(i, COL_√‚ ‘) = "0" Then
                        ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                        arrSQL(UBound(arrSQL)) = "ZL_≤°»À“Ω÷ˆº«¬º_∆§ ‘(" & Val(.RowData(i)) & ",'',NULL)"
                    End If
                End If
                'µ•æ›…Í«Î∏ΩœÓ
                If .TextMatrix(i, COL_∏ΩœÓ) <> "" And .Cell(flexcpData, i, COL_∏ΩœÓ) = 1 Then
                    arrAppend = Split(.TextMatrix(i, COL_∏ΩœÓ), "<Split1>")
                    For j = 0 To UBound(arrAppend)
                        ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                        arrSQL(UBound(arrSQL)) = "Zl_≤°»À“Ω÷ˆ∏Ωº˛_Insert(" & .RowData(i) & "," & _
                                                 "'" & Split(arrAppend(j), "<Split2>")(0) & "'," & Val(Split(arrAppend(j), "<Split2>")(1)) & "," & _
                                                 j + 1 & "," & ZVal(Split(arrAppend(j), "<Split2>")(2)) & ",'" & Replace(Split(arrAppend(j), "<Split2>")(3), "'", "''") & "'" & _
                                                 IIF(j = 0, ",1", "") & ")"
                    Next
                End If

                'Pass:∏¸–¬…Û≤ÈΩ·π˚
                If Val(.Cell(flexcpData, i, COL_–Ú∫≈)) = 1 Then
                    ReDim Preserve arrSQL(UBound(arrSQL) + 1)
                    arrSQL(UBound(arrSQL)) = "ZL_≤°»À“Ω÷ˆº«¬º_∏¸–¬…Û≤È(" & .RowData(i) & "," & _
                                             IIF(CStr(.Cell(flexcpData, i, COL_æØ æ)) = "", "NULL", Val(.Cell(flexcpData, i, COL_æØ æ))) & ")"
                End If
            End If
        Next
    End With

    '’Ô∂œ≤ø∑÷ƒ⁄»›(œ»“™±£¥Ê“Ω÷ˆID ˝æ›)
    If lbl’Ô∂œ.Tag = "1" Then
        ReDim Preserve arrSQL(UBound(arrSQL) + 1)
        arrSQL(UBound(arrSQL)) = "ZL_≤°»À’Ô∂œº«¬º_Delete(" & mlng≤°»ÀID & "," & mlngπ“∫≈ID & ",3,Null,'1,11')"
        If blnMsgOk Then Call InitRsMsg(rsMsg)
        With vsDiag
            j = 0
            For i = 1 To .Rows - 1
                If Trim(.TextMatrix(i, col’Ô∂œ)) <> "" Then
                    blnDiagChange = True
                    If Val(.Cell(flexcpData, i, col’Ô∂œID)) > 0 And Not mrsDiag Is Nothing Then
                        strFilter = "’Ô∂œ¿‡–Õ=" & IIF(.Cell(flexcpData, i, col÷–“Ω) = 1, "11", "1") & " And º«¬º¿¥‘¥=3 And º≤≤°id=" & ZVal(.TextMatrix(i, colº≤≤°ID)) & " And ’Ô∂œid=" & ZVal(.TextMatrix(i, col’Ô∂œID))
                        strTmp = IIF(.TextMatrix(i, col±‡¬Î) <> "", "(" & .TextMatrix(i, col±‡¬Î) & ")", "") & .TextMatrix(i, col’Ô∂œ) & IIF(.TextMatrix(i, col÷–“Ω÷§∫Ú) <> "", "(" & .TextMatrix(i, col÷–“Ω÷§∫Ú) & ")", "")
                        strFilter = strFilter & " And ’Ô∂œ√Ë ˆ= '" & strTmp & "'"
                        If IsDate(.TextMatrix(i, col∑¢≤° ±º‰)) Then
                            strFilter = strFilter & " And  ∑¢≤° ±º‰= '" & Format(.TextMatrix(i, col∑¢≤° ±º‰), "yyyy-MM-dd HH:mm") & "'"
                        Else
                            strFilter = strFilter & " And  ∑¢≤° ±º‰= Null "
                        End If

                        strFilter = strFilter & " And  ÷§∫ÚID= " & ZVal(.TextMatrix(i, col÷§∫ÚID))

                        strFilter = strFilter & " And  «∑Ò“…’Ô=" & Val(.Cell(flexcpData, i, col“…’Ô))
                        mrsDiag.Filter = strFilter
                        blnDiagChange = mrsDiag.EOF
                    End If
                    lng’Ô∂œº«¬ºid = zlDatabase.GetNextID("≤°»À’Ô∂œº«¬º")
                    strTmp = .TextMatrix(i, col“Ω÷ˆID)
                    If Len(strTmp) > 4000 Then
                        strTmp = ""
                    End If
                    ReDim Preserve arrSQL(UBound(arrSQL) + 1): j = j + 1
                    If blnDiagChange Then
                        strº«¬º»À = UserInfo.–’√˚
                        arrSQL(UBound(arrSQL)) = "ZL_≤°»À’Ô∂œº«¬º_INSERT(" & mlng≤°»ÀID & "," & mlngπ“∫≈ID & ",3," & _
                                                 "Null," & IIF(.Cell(flexcpData, i, col÷–“Ω) = 1, "11", "1") & "," & ZVal(.TextMatrix(i, colº≤≤°ID)) & "," & _
                                                 ZVal(.TextMatrix(i, col’Ô∂œID)) & "," & ZVal(.TextMatrix(i, col÷§∫ÚID)) & "," & _
                                                 "'" & IIF(.TextMatrix(i, col±‡¬Î) <> "", "(" & .TextMatrix(i, col±‡¬Î) & ")", "") & .TextMatrix(i, col’Ô∂œ) & IIF(.TextMatrix(i, col÷–“Ω÷§∫Ú) <> "", "(" & .TextMatrix(i, col÷–“Ω÷§∫Ú) & ")", "") & "',Null,Null," & Val(.Cell(flexcpData, i, col“…’Ô)) & "," & _
                                                 "To_Date('" & Format(curDate, "yyyy-MM-dd HH:mm:ss") & "','YYYY-MM-DD HH24:MI:SS')," & _
                                                 IIF(strTmp = "", "null", "'" & strTmp & "'") & "," & j & ",Null,Null,To_date('" & Format(.TextMatrix(i, col∑¢≤° ±º‰), "yyyy-MM-dd HH:mm") & "','yyyy-MM-dd HH24:mi'),'" & UserInfo.–’√˚ & "'," & lng’Ô∂œº«¬ºid & ")"
                    Else
                        strº«¬º»À = mrsDiag!º«¬º»À
                        arrSQL(UBound(arrSQL)) = "ZL_≤°»À’Ô∂œº«¬º_INSERT(" & mlng≤°»ÀID & "," & mlngπ“∫≈ID & ",3," & _
                                                 "Null," & IIF(.Cell(flexcpData, i, col÷–“Ω) = 1, "11", "1") & "," & ZVal(.TextMatrix(i, colº≤≤°ID)) & "," & _
                                                 ZVal(.TextMatrix(i, col’Ô∂œID)) & "," & ZVal(.TextMatrix(i, col÷§∫ÚID)) & "," & _
                                                 "'" & IIF(.TextMatrix(i, col±‡¬Î) <> "", "(" & .TextMatrix(i, col±‡¬Î) & ")", "") & .TextMatrix(i, col’Ô∂œ) & IIF(.TextMatrix(i, col÷–“Ω÷§∫Ú) <> "", "(" & .TextMatrix(i, col÷–“Ω÷§∫Ú) & ")", "") & "',Null,Null," & Val(.Cell(flexcpData, i, col“…’Ô)) & "," & _
                                                 "To_Date('" & Format(CDate(mrsDiag!º«¬º»’∆⁄), "yyyy-MM-dd HH:mm:ss") & "','YYYY-MM-DD HH24:MI:SS')," & _
                                                 IIF(strTmp = "", "null", "'" & strTmp & "'") & "," & j & ",Null,Null,To_date('" & Format(.TextMatrix(i, col∑¢≤° ±º‰), "yyyy-MM-dd HH:mm") & "','yyyy-MM-dd HH24:mi'),'" & mrsDiag!º«¬º»À & "'," & lng’Ô∂œº«¬ºid & ")"
                    End If
                    strTmp = .TextMatrix(i, col“Ω÷ˆID)
                    If Len(strTmp) > 4000 Then Call Make’Ô∂œ“Ω÷ˆ∂‘”¶(arrSQL, strTmp, lng’Ô∂œº«¬ºid)
                    If blnMsgOk Then
                        Call SendMsg’Ô∂œ(i, j, lng’Ô∂œº«¬ºid, strº«¬º»À, rsMsg)
                    End If
                End If
            Next
        End With
    End If
    
    If bln—™ø‚ Then
        bln—™ø‚ = rs ‰—™.RecordCount > 0
        If bln—™ø‚ Then rs ‰—™.MoveFirst
    End If
    
    If blnRIS Then
        If str±æ¥Œ±‰∂Ø <> "" Then
            str±æ¥Œ±‰∂Ø = Mid(str±æ¥Œ±‰∂Ø, 2)
            Set rsTmp = GetDataRIS‘§‘º(str±æ¥Œ±‰∂Ø)
            If rsTmp.RecordCount > 0 Then
                str±æ¥Œ±‰∂Ø = "”– ˝æ›"
            Else
                str±æ¥Œ±‰∂Ø = ""
            End If
        End If
    Else
        str±æ¥Œ±‰∂Ø = ""
    End If
    '¥¶¿ÌRISµƒ»°œ˚‘§‘º
    If str±æ¥Œ±‰∂Ø <> "" Then
        On Error Resume Next
        For i = 1 To rsTmp.RecordCount
            If 0 <> gobjRis.HISSchedulingEx(Val(rsTmp!ID & ""), Val(rsTmp!‘§‘ºid & "")) Then
                MsgBox "µ±«∞∆Ù”√¡À”∞œÒ–≈œ¢œµÕ≥Ω”ø⁄£¨±æ¥Œ≤Ÿ◊˜…æ≥˝ªÚ–ﬁ∏ƒ¡À“—æ≠‘§‘º“Ω÷ˆ£¨µ´”…”⁄”∞œÒ–≈œ¢œµÕ≥Ω”ø⁄(HISSchedulingEx)»°œ˚œ¢‘§‘ºŒ¥µ˜”√≥…π¶£¨«Î”ÎœµÕ≥π‹¿Ì‘±¡™œµ°£", vbInformation, gstrSysName
            End If
            rsTmp.MoveNext
        Next
        err.Clear: On Error GoTo 0
    End If
    'Ã·Ωª ˝æ›
    On Error GoTo errH
    gcnOracle.BeginTrans: blnTrans = True
    For i = 0 To UBound(arrSQL)
        zlDatabase.ExecuteProcedure CStr(arrSQL(i)), Me.Caption
    Next
    '¥¶¿Ì—™ø‚µƒΩ”ø⁄
    If bln—™ø‚ Then
        For i = 1 To rs ‰—™.RecordCount
            If Val("" & rs ‰—™!◊¥Ã¨) <> 1 Then
                If gobjPublicBlood.AdviceOperation(p√≈’Ô“Ω÷ˆœ¬¥Ô, Val(rs ‰—™!“Ω÷ˆID & ""), Val(rs ‰—™!¿‡–Õ & ""), , strErr) = False Then
                    gcnOracle.RollbackTrans: blnTrans = False
                    Screen.MousePointer = 0
                    MsgBox "—™ø‚œµÕ≥Ω”ø⁄µ˜”√ ß∞‹£∫" & strErr, vbInformation, gstrSysName
                    Exit Function
                End If
            End If
            rs ‰—™.MoveNext
        Next
    End If
    gcnOracle.CommitTrans: blnTrans = False
    On Error GoTo 0
    mlngID–Ú¡– = 0
    'Pass◊‘∂Ø”√“©…Û≤È…œ¥´¥¶∑Ω
    If mblnPass Then
        Call gobjPass.zlPassUpLoad(mobjPassMap)
    End If
    
    If blnMsgOk Then
        If Not (mrs’Ô∂œ Is Nothing) Then
            mrs’Ô∂œ.Filter = "◊¥Ã¨ = 0"
            If Not mrs’Ô∂œ.EOF Then
                For i = 1 To mrs’Ô∂œ.RecordCount
                    Call ZLHIS_CIS_011(mclsMipModule, mlng≤°»ÀID, mstr–’√˚, 1, mlngπ“∫≈ID, mlng≤°»Àø∆ “id, mrs’Ô∂œ!ID, mrs’Ô∂œ!’Ô∂œ±‡¬Î, mrs’Ô∂œ!º≤≤°±‡¬Î)
                    mrs’Ô∂œ.Delete
                    mrs’Ô∂œ.MoveNext
                Next
            End If
            mrs’Ô∂œ.Filter = "◊¥Ã¨ <> 0"
            If Not mrs’Ô∂œ.EOF Then
                For i = 1 To mrs’Ô∂œ.RecordCount
                    mrs’Ô∂œ!◊¥Ã¨ = 0
                    mrs’Ô∂œ.MoveNext
                Next
            End If
            mrs’Ô∂œ.Filter = 0
        End If
        If Not (rsMsg Is Nothing) Then
            rsMsg.Filter = "◊¥Ã¨ = 1"
            If Not rsMsg.EOF Then
                For i = 1 To rsMsg.RecordCount
                    Call ZLHIS_CIS_010(mclsMipModule, mlng≤°»ÀID, mstr–’√˚, 1, mlngπ“∫≈ID, mlng≤°»Àø∆ “id, _
                        rsMsg!’Ô∂œid, rsMsg!’Ô∂œ¿‡–Õ, rsMsg! «∑Ò“…’Ô, rsMsg!’Ô∂œ¥Œ–Ú, rsMsg!’Ô∂œ±‡¬Î, rsMsg!º≤≤°±‡¬Î, rsMsg!º≤≤°∏Ω¬Î, rsMsg!º≤≤°¿‡±, rsMsg!÷§∫Ú±‡¬Î, rsMsg!÷§∫Ú√˚≥∆, rsMsg!º«¬º»’∆⁄, rsMsg!º«¬º»À‘±)
                    rsMsg.MoveNext
                Next
            End If
        End If
    End If
    
    If bln”√—™…Û∫À Then Call ReadMsg
    
    Call CreatePlugInOK(p√≈’Ô“Ω÷ˆœ¬¥Ô, mint≥°∫œ)
    'µ˜”√…æ≥˝∫ÛÕ‚π“Ω”ø⁄
    On Error Resume Next
    For i = 0 To UBound(arrDelID)
        If Val(arrDelID(i)) <> 0 Then
            If Not gobjPlugIn Is Nothing Then
                Call gobjPlugIn.AdviceDeleted(glngSys, p√≈’Ô“Ω÷ˆœ¬¥Ô, mlng≤°»ÀID, mlngπ“∫≈ID, Val(arrDelID(i)), mint≥°∫œ)
                Call zlPlugInErrH(err, "AdviceDeleted")
            End If
        End If
    Next
    If err.Number <> 0 Then err.Clear
    On Error GoTo 0

    'µ˜”√¥¶∑Ω…Û≤ÈœµÕ≥ºÏ≤È
    If InitObjRecipeAudit(p√≈’Ô“Ω÷ˆœ¬¥Ô) And mblnNoSave Then
        For i = vsAdvice.FixedRows To vsAdvice.Rows - 1
            If vsAdvice.TextMatrix(i, COL_¿‡±) = "E" And vsAdvice.TextMatrix(i, COL_≤Ÿ◊˜¿‡–Õ) = "2" Then
                'µ±«∞–¬ø™◊¥Ã¨µƒ“Ω÷ˆ¥¯–Ë“™¥´»Î
                If Val(vsAdvice.TextMatrix(i, COL_◊¥Ã¨)) = 1 Then
                    str∏¯“©IDs = str∏¯“©IDs & "," & vsAdvice.RowData(i)
                End If
            End If
        Next
        If Mid(str∏¯“©IDs, 2) <> "" Then
            Call gobjRecipeAudit.AutoAudit(Me, 1, Mid(str∏¯“©IDs, 2), mlng≤°»Àø∆ “id, 0, mlng≤°»ÀID, mlngπ“∫≈ID)
        End If
    End If

    '±£¥Ê≥…π¶∫Û,À˘”–º«¬º±‰≥…‘≠ ºº«¬º
    With vsAdvice
        For i = vsAdvice.FixedRows To vsAdvice.Rows - 1
            If .RowData(i) <> 0 Then
                .TextMatrix(i, COL_EDIT) = 0
                .Cell(flexcpData, i, COL_–Ú∫≈) = Empty    'Pass:±£¥Ê∫Û«Â≥˝±Í÷æ
                .Cell(flexcpData, i, COL_∏ΩœÓ) = 0    '∏ΩœÓ:±£¥Ê∫Û«Â≥˝±Í÷æ
            End If
        Next
    End With

    '±£¥Ê∫Û÷ÿ–¬Ω¯»Î––(±»»Áø™ º ±º‰≤ª◊º∏ƒ¡À)
    Call vsAdvice_AfterRowColChange(-1, -1, vsAdvice.Row, vsAdvice.Col)
    
    Screen.MousePointer = 0
    lbl’Ô∂œ.Tag = ""
    mblnNoSave = False
    mstrDelIDs = ""
    mstrAduitDelIDs = ""
    mstrDel ‰—™ = ""
    SaveAdvice = True
    mblnOK = True
    mlngŒ£º±÷µID = 0
    
    '“Ω÷ˆ ˝æ›±£¥ÊÃ·Ωª∫Û£¨‘ŸRIS‘§‘º£¨÷ª”–∆’ƒ‹≤°»À≤≈‘§‘º
    If blnRIS And mbytPatiType = 1 Then
        If strNewAdvice <> "" Then
            strTmp = Mid(strNewAdvice, 2)
            varTmp = Split(strTmp, ",")
            On Error Resume Next
            For i = 0 To UBound(varTmp)
                strTmp = varTmp(i)
                Call gobjRis.HISScheduling(1, Val(Split(strTmp, ":")(0)), Val(Split(strTmp, ":")(1)))
            Next
            err.Clear: On Error GoTo 0
        End If
    End If
    
    Exit Function
errH:
    Screen.MousePointer = 0
    If blnTrans Then gcnOracle.RollbackTrans
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Sub SendMsg’Ô∂œ(ByVal lngRow As Long, ByVal lng¥Œ–Ú As Long, ByVal lngID As Long, ByVal strº«¬º»À As String, ByRef rsMsg As ADODB.Recordset)
    Dim i As Long
    With vsDiag
        rsMsg.AddNew
        rsMsg!’Ô∂œid = lngID
        rsMsg!’Ô∂œ¿‡–Õ = IIF(.Cell(flexcpData, lngRow, col÷–“Ω) = 1, "11", "1")
        rsMsg! «∑Ò“…’Ô = Val(.Cell(flexcpData, lngRow, col“…’Ô))
        rsMsg!’Ô∂œ¥Œ–Ú = lng¥Œ–Ú
        rsMsg!’Ô∂œ±‡¬Î = .TextMatrix(lngRow, col’Ô∂œ±‡¬Î)
        rsMsg!º≤≤°±‡¬Î = .TextMatrix(lngRow, colº≤≤°±‡¬Î)
        rsMsg!º≤≤°∏Ω¬Î = .TextMatrix(lngRow, colº≤≤°∏Ω¬Î)
        rsMsg!º≤≤°¿‡± = .TextMatrix(lngRow, colº≤≤°¿‡±)
        rsMsg!÷§∫Ú±‡¬Î = .TextMatrix(lngRow, col÷§∫Ú±‡¬Î)
        rsMsg!÷§∫Ú√˚≥∆ = .TextMatrix(lngRow, col÷–“Ω÷§∫Ú)
        rsMsg!º«¬º»’∆⁄ = Format(.TextMatrix(lngRow, col∑¢≤° ±º‰), "yyyy-MM-dd HH:mm:ss")
        rsMsg!º«¬º»À‘± = strº«¬º»À
        rsMsg!◊¥Ã¨ = 1
        
        mrs’Ô∂œ.Filter = "œ‘ æ±‡¬Î='" & .TextMatrix(lngRow, col±‡¬Î) & "'"
        
        If mrs’Ô∂œ.EOF Then
            mrs’Ô∂œ.AddNew
            mrs’Ô∂œ!ID = lngID
            mrs’Ô∂œ!œ‘ æ±‡¬Î = .TextMatrix(lngRow, col±‡¬Î)
            mrs’Ô∂œ!’Ô∂œ±‡¬Î = .TextMatrix(lngRow, col’Ô∂œ±‡¬Î)
            mrs’Ô∂œ!º≤≤°±‡¬Î = .TextMatrix(lngRow, colº≤≤°±‡¬Î)
            mrs’Ô∂œ!◊¥Ã¨ = 2
            mrs’Ô∂œ.Update
        Else
            rsMsg!◊¥Ã¨ = 0
            mrs’Ô∂œ!◊¥Ã¨ = 1
            mrs’Ô∂œ!ID = lngID
        End If
        rsMsg.Update
    End With
End Sub

Private Sub InitRsMsg(ByRef rsMsg As ADODB.Recordset)
'π¶ƒ‹£∫≥ı ºªØœ˚œ¢º«¬ººØ
    Set rsMsg = New ADODB.Recordset
    rsMsg.Fields.Append "’Ô∂œid", adBigInt
    rsMsg.Fields.Append "’Ô∂œ¿‡–Õ", adVarChar, 6
    rsMsg.Fields.Append " «∑Ò“…’Ô", adVarChar, 6
    rsMsg.Fields.Append "’Ô∂œ¥Œ–Ú", adBigInt
    rsMsg.Fields.Append "’Ô∂œ±‡¬Î", adVarChar, 60
    rsMsg.Fields.Append "º≤≤°±‡¬Î", adVarChar, 60
    rsMsg.Fields.Append "º≤≤°∏Ω¬Î", adVarChar, 60
    rsMsg.Fields.Append "º≤≤°¿‡±", adVarChar, 60
    rsMsg.Fields.Append "÷§∫Ú±‡¬Î", adVarChar, 60
    rsMsg.Fields.Append "÷§∫Ú√˚≥∆", adVarChar, 120
    rsMsg.Fields.Append "º«¬º»’∆⁄", adVarChar, 60
    rsMsg.Fields.Append "º«¬º»À‘±", adVarChar, 120
    rsMsg.Fields.Append "◊¥Ã¨", adBigInt '1 £≠–¬‘ˆ
    rsMsg.CursorLocation = adUseClient
    rsMsg.LockType = adLockOptimistic
    rsMsg.CursorType = adOpenStatic
    rsMsg.Open
End Sub

Private Function LoadAdvice() As Boolean
''π¶ƒ‹£∫∂¡»°µ±«∞≤°»Àµƒ“Ω÷ˆº«¬º
    Dim rsTmp As New ADODB.Recordset
    Dim strSQL As String, bln≈‰∑Ω As Boolean
    Dim i As Long, j As Long, lngœ‡πÿID As Long

    Screen.MousePointer = 11

    On Error GoTo errH

    'œ¬“Ω÷ˆ»± °µƒÃÏ ˝
    If msngÃÏ ˝ = 0 Then msngÃÏ ˝ = 1

    '¡Ÿ¥≤∫Õ“Ωºº≤ªª•œ‡±‡º≠
    strSQL = " And Nvl(A.«∞Ã·ID,0) in (Select /*+cardinality(x,10)*/ x.Column_Value From Table(Cast(f_Num2list([3]) As zlTools.t_Numlist)) X)"
    
    '∂¡»°"1-–¬ø™,8-“—Õ£÷π(“—∑¢ÀÕ)"µƒ“Ω÷ˆ
    strSQL = _
    " Select A.ID,A.œ‡πÿID,Nvl(A.”§∂˘,0) as ”§∂˘,A.–Ú∫≈,A.“Ω÷ˆ∆⁄–ß,A.“Ω÷ˆ◊¥Ã¨,A.’Ô¡∆¿‡±,A.’Ô¡∆œÓƒøID,B.√˚≥∆,A.±Í±æ≤øŒª,A.ºÏ≤È∑Ω∑®," & _
             " A.÷¥––±Íº«,A. ’∑—œ∏ƒøID,A.ø™ º÷¥–– ±º‰,A.“Ω÷ˆƒ⁄»›,A.“Ω…˙÷ˆÕ–,A.µ•¥Œ”√¡ø,A.ÃÏ ˝,A.◊‹∏¯”Ë¡ø,B.º∆À„µ•Œª,A.÷¥––∆µ¥Œ," & _
             " A.∆µ¬ ¥Œ ˝,A.∆µ¬ º‰∏Ù,A.º‰∏Ùµ•Œª,B.º∆À„∑Ω Ω,B.÷¥––∆µ¬ ,B.≤Ÿ◊˜¿‡–Õ,B.µ•∂¿”¶”√,B.÷¥––∑÷¿‡,A.º∆º€Ãÿ–‘,A.÷¥–– ±º‰∑Ω∞∏,A.÷¥–––‘÷ ," & _
             " A.÷¥––ø∆ “ID,A.ø™÷ˆø∆ “ID,A.ø™÷ˆ“Ω…˙,A.ø™÷ˆ ±º‰,A.ΩÙº±±Í÷æ,Decode(Nvl(c.¥¶∑Ωœﬁ¡ø, 0), 0, b.¬º»Îœﬁ¡ø, c.¥¶∑Ωœﬁ¡ø) As ¥¶∑Ωœﬁ¡ø,C.¥¶∑Ω÷∞ŒÒ,C.∂æ¿Ì∑÷¿‡,C.øπ…˙Àÿ,C.“©∆∑º¡–Õ," & _
             " D.º¡¡øœµ ˝,D.√≈’Ô∞¸◊∞,D.√≈’Ôµ•Œª,F.º∆À„µ•Œª as …¢◊∞µ•Œª,E.∏˙◊Ÿ‘⁄”√,D.√≈’Ôø…∑Ò∑÷¡„ As ø…∑Ò∑÷¡„,A.…Û≤ÈΩ·π˚," & _
             " Decode(A.–¬ø™«©√˚ID,NULL,0,1) as «©√˚∑Ò,A.’™“™,A.¡„∑—º«’ ,A.”√“©ƒøµƒ,A.”√“©¿Ì”…,A.…Û∫À◊¥Ã¨,A.∆§ ‘Ω·π˚,A.≥¨¡øÀµ√˜," & _
             " a.≈‰∑ΩID,c.¡Ÿ¥≤◊‘π‹“©,d.∏ﬂŒ£“©∆∑,a.◊È∫œœÓƒøID,b.≥∑µµ ±º‰,C.»‹√Ω,a.…Í«Î–Ú∫≈,J.◊¥Ã¨ as ¥¶∑Ω…Û≤È◊¥Ã¨,J.…Û≤ÈΩ·π˚ as ¥¶∑Ω…Û≤ÈΩ·π˚,A.¥¶∑Ω–Ú∫≈,d.ª˘±æ“©ŒÔ,Nvl(Max(g.Œ£º±÷µid), Max(h.Œ£º±÷µid)) As Œ£º±÷µid" & _
             " From ≤°»À“Ω÷ˆº«¬º A,’Ô¡∆œÓƒøƒø¬º B,“©∆∑Ãÿ–‘ C,“©∆∑πÊ∏Ò D,≤ƒ¡œÃÿ–‘ E, ’∑—œÓƒøƒø¬º F, ¥¶∑Ω…Û≤È√˜œ∏ I, ¥¶∑Ω…Û≤Èº«¬º J, ≤°»ÀŒ£º±÷µ“Ω÷ˆ G,≤°»ÀŒ£º±÷µ“Ω÷ˆ H" & _
             " Where Nvl(A.“Ω÷ˆ∆⁄–ß,0)=1 And A.’Ô¡∆œÓƒøID=B.ID And A.’Ô¡∆œÓƒøID=C.“©√˚ID(+)  And a.ID = i.“Ω÷ˆID(+) And I.…Û∑ΩID = J.ID(+) and (I.◊Ó∫ÛÃ·Ωª =1 Or I.…Û∑ΩID is NULL) And Nvl(A.÷¥––±Íº«,0)<>-1 And a.ID = h.“Ω÷ˆID(+) and a.œ‡πÿID=g.“Ω÷ˆID(+)  " & _
             " And A. ’∑—œ∏ƒøID=D.“©∆∑ID(+) And A. ’∑—œ∏ƒøID=E.≤ƒ¡œID(+) And E.≤ƒ¡œID=F.ID(+) And A.“Ω÷ˆ◊¥Ã¨ IN(1,8)" & strSQL & _
             " And A.≤°»ÀID+0=[1] And A.π“∫≈µ•=[2] And A.ø™ º÷¥–– ±º‰ is Not NULL And A.≤°»À¿¥‘¥<>3"
    strSQL = strSQL & " " & _
            "Group By a.Id, a.œ‡πÿid, a.”§∂˘, a.–Ú∫≈, a.“Ω÷ˆ∆⁄–ß, a.“Ω÷ˆ◊¥Ã¨, a.’Ô¡∆¿‡±, a.’Ô¡∆œÓƒøid, b.√˚≥∆, a.±Í±æ≤øŒª, a.ºÏ≤È∑Ω∑®, a.÷¥––±Íº«, a. ’∑—œ∏ƒøid, a.ø™ º÷¥–– ±º‰," & vbNewLine & _
            "         a.“Ω÷ˆƒ⁄»›, a.“Ω…˙÷ˆÕ–, a.µ•¥Œ”√¡ø, a.ÃÏ ˝, a.◊‹∏¯”Ë¡ø, b.º∆À„µ•Œª, a.÷¥––∆µ¥Œ, a.∆µ¬ ¥Œ ˝, a.∆µ¬ º‰∏Ù, a.º‰∏Ùµ•Œª, b.º∆À„∑Ω Ω, b.÷¥––∆µ¬ , b.≤Ÿ◊˜¿‡–Õ,b.µ•∂¿”¶”√, b.÷¥––∑÷¿‡," & vbNewLine & _
            "         a.º∆º€Ãÿ–‘, a.÷¥–– ±º‰∑Ω∞∏, a.÷¥–––‘÷ , a.÷¥––ø∆ “id, a.ø™÷ˆø∆ “id, a.ø™÷ˆ“Ω…˙, a.ø™÷ˆ ±º‰, a.ΩÙº±±Í÷æ, c.¥¶∑Ωœﬁ¡ø, c.¥¶∑Ω÷∞ŒÒ, c.∂æ¿Ì∑÷¿‡, c.øπ…˙Àÿ, c.“©∆∑º¡–Õ," & vbNewLine & _
            "         d.º¡¡øœµ ˝, d.√≈’Ô∞¸◊∞, d.√≈’Ôµ•Œª, f.º∆À„µ•Œª, e.∏˙◊Ÿ‘⁄”√, d.√≈’Ôø…∑Ò∑÷¡„, a.…Û≤ÈΩ·π˚, a.–¬ø™«©√˚id, a.’™“™, a.¡„∑—º«’ , a.”√“©ƒøµƒ, a.”√“©¿Ì”…, a.…Û∫À◊¥Ã¨," & vbNewLine & _
            "         a.∆§ ‘Ω·π˚, a.≥¨¡øÀµ√˜, a.≈‰∑Ωid, c.¡Ÿ¥≤◊‘π‹“©, d.∏ﬂŒ£“©∆∑, a.◊È∫œœÓƒøid, b.≥∑µµ ±º‰, c.»‹√Ω, a.…Í«Î–Ú∫≈, j.◊¥Ã¨, j.…Û≤ÈΩ·π˚,d.ª˘±æ“©ŒÔ, a.¥¶∑Ω–Ú∫≈,b.¬º»Îœﬁ¡ø" & vbNewLine & _
            "Order By a.”§∂˘, a.–Ú∫≈"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng≤°»ÀID, mstrπ“∫≈µ•, IIF(mstr«∞Ã·IDs = "", "0", mstr«∞Ã·IDs))
    On Error GoTo 0

    If Not rsTmp.EOF Then
        mblnRowChange = False
        With vsAdvice
            .Redraw = flexRDNone
            .Rows = .FixedRows + rsTmp.RecordCount
            For i = 1 To rsTmp.RecordCount
                bln≈‰∑Ω = False

                .RowData(i) = CLng(rsTmp!ID)
                .TextMatrix(i, COL_EDIT) = 0    '‘≠ ºº«¬º
                .TextMatrix(i, COL_œ‡πÿID) = Nvl(rsTmp!œ‡πÿID)
                .TextMatrix(i, COL_”§∂˘) = Nvl(rsTmp!”§∂˘, 0)
                .TextMatrix(i, COL_–Ú∫≈) = rsTmp!–Ú∫≈
                .TextMatrix(i, COL_◊¥Ã¨) = Nvl(rsTmp!“Ω÷ˆ◊¥Ã¨, 0)

                .TextMatrix(i, COL_¿‡±) = rsTmp!’Ô¡∆¿‡±
                .TextMatrix(i, COL_’Ô¡∆œÓƒøID) = rsTmp!’Ô¡∆œÓƒøID
                .TextMatrix(i, COL_√˚≥∆) = rsTmp!√˚≥∆
                .TextMatrix(i, COL_±Í±æ≤øŒª) = Nvl(rsTmp!±Í±æ≤øŒª)
                .TextMatrix(i, COL_ºÏ≤È∑Ω∑®) = Nvl(rsTmp!ºÏ≤È∑Ω∑®)
                .TextMatrix(i, COL_÷¥––±Íº«) = Nvl(rsTmp!÷¥––±Íº«, 0)
                .TextMatrix(i, COL_ ’∑—œ∏ƒøID) = Nvl(rsTmp! ’∑—œ∏ƒøID)
                .TextMatrix(i, col_“Ω÷ˆƒ⁄»›) = Nvl(rsTmp!“Ω÷ˆƒ⁄»›)
                .TextMatrix(i, COL_“Ω…˙÷ˆÕ–) = Nvl(rsTmp!“Ω…˙÷ˆÕ–)
                .Cell(flexcpData, i, COL_“Ω…˙÷ˆÕ–) = CStr(Nvl(rsTmp!’™“™))

                .TextMatrix(i, COL_º∆º€–‘÷ ) = Nvl(rsTmp!º∆º€Ãÿ–‘, 0)
                .TextMatrix(i, COL_º∆À„∑Ω Ω) = Nvl(rsTmp!º∆À„∑Ω Ω, 0)
                .TextMatrix(i, COL_∆µ¬ –‘÷ ) = Nvl(rsTmp!÷¥––∆µ¬ , 0)
                .TextMatrix(i, COL_≤Ÿ◊˜¿‡–Õ) = Nvl(rsTmp!≤Ÿ◊˜¿‡–Õ)
                .TextMatrix(i, COL_µ•∂¿”¶”√) = Nvl(rsTmp!µ•∂¿”¶”√)
                .TextMatrix(i, COL_÷¥––∑÷¿‡) = Nvl(rsTmp!÷¥––∑÷¿‡, 0)
                .TextMatrix(i, COL_∂æ¿Ì∑÷¿‡) = Nvl(rsTmp!∂æ¿Ì∑÷¿‡)
                .TextMatrix(i, COL_øπæ˙µ»º∂) = Val("" & rsTmp!øπ…˙Àÿ)
                .TextMatrix(i, COL_“©∆∑º¡–Õ) = Nvl(rsTmp!“©∆∑º¡–Õ)
                .TextMatrix(i, COL_¥¶∑Ωœﬁ¡ø) = Nvl(rsTmp!¥¶∑Ωœﬁ¡ø)
                .TextMatrix(i, COL_¥¶∑Ω÷∞ŒÒ) = Nvl(rsTmp!¥¶∑Ω÷∞ŒÒ)
                .TextMatrix(i, COL_ª˘±æ“©ŒÔ) = rsTmp!ª˘±æ“©ŒÔ & ""
                If gblnKSSStrict Or gbln ‰—™∑÷º∂π‹¿Ì Or gbln—™ø‚œµÕ≥ Then
                    .TextMatrix(i, COL_…Û∫À◊¥Ã¨) = Val("" & rsTmp!…Û∫À◊¥Ã¨)
                End If
                .TextMatrix(i, COL_”√“©ƒøµƒ) = "" & rsTmp!”√“©ƒøµƒ
                .TextMatrix(i, COL_”√“©¿Ì”…) = "" & rsTmp!”√“©¿Ì”…
                .TextMatrix(i, COL_≈‰∑ΩID) = Nvl(rsTmp!≈‰∑ΩID)
                .TextMatrix(i, COL_¡Ÿ¥≤◊‘π‹“©) = rsTmp!¡Ÿ¥≤◊‘π‹“© & ""
                .TextMatrix(i, COL_∏ﬂŒ£“©∆∑) = Nvl(rsTmp!∏ﬂŒ£“©∆∑, 0)
                .TextMatrix(i, COL_◊È∫œœÓƒøID) = "" & rsTmp!◊È∫œœÓƒøID
                If Format(Nvl(rsTmp!≥∑µµ ±º‰, "3000/1/1"), "yyyy-MM-dd") <> "3000-01-01" Then
                    .TextMatrix(i, COL_ «∑ÒÕ£”√) = 1
                End If
                If InStr(",5,6,7,", .TextMatrix(i, COL_¿‡±)) > 0 Then
                    .TextMatrix(i, COL_º¡¡øœµ ˝) = Nvl(rsTmp!º¡¡øœµ ˝)
                    .TextMatrix(i, COL_√≈’Ô∞¸◊∞) = Nvl(rsTmp!√≈’Ô∞¸◊∞)
                    .TextMatrix(i, COL_√≈’Ôµ•Œª) = Nvl(rsTmp!√≈’Ôµ•Œª)
                    If Not IsNull(rsTmp!º¡¡øœµ ˝) Then
                        .TextMatrix(i, COL_ø…∑Ò∑÷¡„) = Nvl(rsTmp!ø…∑Ò∑÷¡„, 0)
                    End If
                ElseIf .TextMatrix(i, COL_¿‡±) = "4" Then
                    .TextMatrix(i, COL_º¡¡øœµ ˝) = 1
                    .TextMatrix(i, COL_√≈’Ô∞¸◊∞) = 1
                    .TextMatrix(i, COL_√≈’Ôµ•Œª) = Nvl(rsTmp!…¢◊∞µ•Œª)
                    .TextMatrix(i, COL_∏˙◊Ÿ‘⁄”√) = Nvl(rsTmp!∏˙◊Ÿ‘⁄”√, 0)
                End If

                .TextMatrix(i, COL_ø™ º ±º‰) = Format(rsTmp!ø™ º÷¥–– ±º‰, "yyyy-MM-dd HH:mm")
                .Cell(flexcpData, i, COL_ø™ º ±º‰) = Format(rsTmp!ø™ º÷¥–– ±º‰, "yyyy-MM-dd HH:mm")

                .TextMatrix(i, COL_∆µ¬ ) = Nvl(rsTmp!÷¥––∆µ¥Œ)
                .TextMatrix(i, COL_∆µ¬ ¥Œ ˝) = Nvl(rsTmp!∆µ¬ ¥Œ ˝)
                .TextMatrix(i, COL_∆µ¬ º‰∏Ù) = Nvl(rsTmp!∆µ¬ º‰∏Ù)
                .TextMatrix(i, COL_º‰∏Ùµ•Œª) = Nvl(rsTmp!º‰∏Ùµ•Œª)
                .TextMatrix(i, COL_÷¥–– ±º‰) = Nvl(rsTmp!÷¥–– ±º‰∑Ω∞∏)

                .TextMatrix(i, COL_÷¥––ø∆ “ID) = Nvl(rsTmp!÷¥––ø∆ “ID)
                .TextMatrix(i, COL_÷¥–––‘÷ ) = Nvl(rsTmp!÷¥–––‘÷ , 0)
                .TextMatrix(i, COL_√‚ ‘) = IIF(Nvl(rsTmp!∆§ ‘Ω·π˚, "") = "√‚ ‘", "1", "0")
                .Cell(flexcpData, i, COL_√‚ ‘) = .TextMatrix(i, COL_√‚ ‘)
                .TextMatrix(i, COL_ «∑Ò»‹√Ω) = Val(rsTmp!»‹√Ω & "")
                .TextMatrix(i, COL_…Í«Î–Ú∫≈) = rsTmp!…Í«Î–Ú∫≈ & ""
                .TextMatrix(i, COL_¥¶∑Ω…Û≤È◊¥Ã¨) = rsTmp!¥¶∑Ω…Û≤È◊¥Ã¨ & ""
                .TextMatrix(i, COL_¥¶∑Ω…Û≤ÈΩ·π˚) = rsTmp!¥¶∑Ω…Û≤ÈΩ·π˚ & ""
                .TextMatrix(i, COL_¥¶∑Ω–Ú∫≈) = Val("" & rsTmp!¥¶∑Ω–Ú∫≈)
                .TextMatrix(i, COL_Œ£º±÷µID) = Val("" & rsTmp!Œ£º±÷µID)
                
                If rsTmp!’Ô¡∆¿‡± = "E" Then
                    If Nvl(rsTmp!œ‡πÿID, 0) = 0 And Val(.TextMatrix(i - 1, COL_œ‡πÿID)) = rsTmp!ID Then
                        If InStr(",5,6,", .TextMatrix(i - 1, COL_¿‡±)) > 0 Then
                            'µ±«∞º«¬º «≥…“©µƒ∏¯“©Õææ∂,ø…ƒ‹ «“ª≤¢∏¯“©µƒ
                            For j = i - 1 To .FixedRows Step -1
                                If Val(.TextMatrix(j, COL_œ‡πÿID)) = rsTmp!ID Then
                                    'œ‘ æ∏¯“©Õææ∂
                                    .TextMatrix(j, COL_”√∑®) = rsTmp!√˚≥∆ & rsTmp!“Ω…˙÷ˆÕ–
                                Else
                                    Exit For
                                End If
                            Next
                        ElseIf InStr(",E,7,", .TextMatrix(i - 1, COL_¿‡±)) > 0 Then
                            'µ±«∞º«¬º «÷–“©≈‰∑Ωµƒ”√∑®,º¥≈‰∑Ωœ‘ æ––
                            .TextMatrix(i, COL_”√∑®) = rsTmp!√˚≥∆
                            .TextMatrix(i, COL_÷–“©–ŒÃ¨) = Val("" & rsTmp!ºÏ≤È∑Ω∑®)    '÷–“©”√∑®––µƒºÏ≤È∑Ω∑®◊÷∂Œ¥Ê¥¢¡À÷–“©–ŒÃ¨
                            bln≈‰∑Ω = True
                        ElseIf .TextMatrix(i - 1, COL_¿‡±) = "C" Then
                            .TextMatrix(i, COL_”√∑®) = rsTmp!√˚≥∆
                        End If
                    ElseIf Not IsNull(rsTmp!œ‡πÿID) And .TextMatrix(i - 1, COL_¿‡±) = "K" And Nvl(rsTmp!œ‡πÿID, 0) = .RowData(i - 1) Then
                        'µ±«∞º«¬º « ‰—™Õææ∂––
                        .TextMatrix(i - 1, COL_”√∑®) = rsTmp!√˚≥∆
                    ElseIf Not IsNull(rsTmp!œ‡πÿID) Then
                        'µ±«∞º«¬º «÷–“©≈‰∑ΩºÂ∑®––
                        bln≈‰∑Ω = True
                    End If
                ElseIf rsTmp!’Ô¡∆¿‡± = "7" Then
                    bln≈‰∑Ω = True
                End If

                'µ•¡ø
                .TextMatrix(i, COL_µ•¡ø) = FormatEx(Nvl(rsTmp!µ•¥Œ”√¡ø), 5)
                If .TextMatrix(i, COL_¿‡±) = "4" Then
                    .TextMatrix(i, COL_µ•¡øµ•Œª) = Nvl(rsTmp!…¢◊∞µ•Œª)
                ElseIf InStr(",5,6,7,", rsTmp!’Ô¡∆¿‡±) > 0 _
                       Or (Val(.TextMatrix(i, COL_∆µ¬ –‘÷ )) = 0 And InStr(",1,2,", Nvl(rsTmp!º∆À„∑Ω Ω, 0)) > 0) Then
                    .TextMatrix(i, COL_µ•¡øµ•Œª) = Nvl(rsTmp!º∆À„µ•Œª)
                End If

                'ÃÏ ˝
                .TextMatrix(i, COL_ÃÏ ˝) = Nvl(rsTmp!ÃÏ ˝)
                '»°◊ÓΩ¸–¬ø™“Ω÷ˆµƒø™ ˝◊˜Œ™»± °ÃÏ ˝
                If InStr(",1,2,", Nvl(rsTmp!“Ω÷ˆ◊¥Ã¨, 0)) > 0 _
                   And InStr(",5,6,", rsTmp!’Ô¡∆¿‡±) > 0 And Nvl(rsTmp!ÃÏ ˝, 0) <> 0 Then
                    msngÃÏ ˝ = Nvl(rsTmp!ÃÏ ˝, 1)
                End If

                '◊‹¡ø
                If InStr(",5,6,", rsTmp!’Ô¡∆¿‡±) > 0 Then
                    '≥…“©¡Ÿ÷ˆ”–◊‹¡ø,“‘¡„ €µ•Œª¥Ê∑≈,√≈’Ôµ•Œªœ‘ æ
                    If Not IsNull(rsTmp!◊‹∏¯”Ë¡ø) And Not IsNull(rsTmp!√≈’Ô∞¸◊∞) Then
                        .TextMatrix(i, COL_◊‹¡ø) = FormatEx(rsTmp!◊‹∏¯”Ë¡ø / rsTmp!√≈’Ô∞¸◊∞, 5)
                    End If
                    .TextMatrix(i, COL_◊‹¡øµ•Œª) = Nvl(rsTmp!√≈’Ôµ•Œª)

                    Call Set”√“©ÃÏ ˝ «∑Ò≥¨∆⁄(i)

                ElseIf bln≈‰∑Ω Then
                    If Not IsNull(rsTmp!◊‹∏¯”Ë¡ø) Then .TextMatrix(i, COL_◊‹¡ø) = rsTmp!◊‹∏¯”Ë¡ø
                    .TextMatrix(i, COL_◊‹¡øµ•Œª) = "∏∂"    '÷–“©≈‰∑Ω◊‹¡øµ•ŒªŒ™"∏∂"
                    Call Set”√“©ÃÏ ˝ «∑Ò≥¨∆⁄(i)
                Else
                    '∆‰À¸«Èøˆ”–÷–“©∫Õ∆‰À¸¡Ÿ÷ˆ
                    If Not IsNull(rsTmp!◊‹∏¯”Ë¡ø) Then .TextMatrix(i, COL_◊‹¡ø) = rsTmp!◊‹∏¯”Ë¡ø

                    If .TextMatrix(i, COL_¿‡±) = "4" Then
                        .TextMatrix(i, COL_◊‹¡øµ•Œª) = Nvl(rsTmp!…¢◊∞µ•Œª)
                    Else
                        .TextMatrix(i, COL_◊‹¡øµ•Œª) = Nvl(rsTmp!º∆À„µ•Œª)
                    End If
                End If

                .TextMatrix(i, COL_≥¨¡øÀµ√˜) = rsTmp!≥¨¡øÀµ√˜ & ""

                .TextMatrix(i, COL_ø™÷ˆø∆ “ID) = rsTmp!ø™÷ˆø∆ “id
                .TextMatrix(i, COL_ø™÷ˆ“Ω…˙) = rsTmp!ø™÷ˆ“Ω…˙

                .TextMatrix(i, COL_ø™÷ˆ ±º‰) = Format(rsTmp!ø™÷ˆ ±º‰, "yyyy-MM-dd HH:mm")
                .Cell(flexcpData, i, COL_ø™÷ˆ ±º‰) = Format(rsTmp!ø™÷ˆ ±º‰, "yyyy-MM-dd HH:mm")

                .TextMatrix(i, COL_¡„∑—º«’ ) = Val("" & rsTmp!¡„∑—º«’ )

                'œ‘ æΩÙº±±Í÷æ:“ª≤¢∏¯“©÷ªœ‘ æ‘⁄µ⁄“ª––
                .TextMatrix(i, COL_±Í÷æ) = Nvl(rsTmp!ΩÙº±±Í÷æ, 0)
                .TextMatrix(i, COL_«©√˚∑Ò) = Nvl(rsTmp!«©√˚∑Ò)
                Call SetRow±Í÷æÕº±Í(i, 1)


                '∏˘æ›“Ω÷ˆ◊¥Ã¨,“©∆∑∂æ¿Ì…Ë÷√—’…´
                '-------------------------------------------------------------------
                .Cell(flexcpForeColor, i, .FixedCols, i, .Cols - 1) = .ForeColor
                If rsTmp!“Ω÷ˆ◊¥Ã¨ = 8 Then
                    '“—Õ£÷π(“—∑¢ÀÕ)
                    .Cell(flexcpForeColor, i, .FixedCols, i, .Cols - 1) = &HC00000    '…Ó¿∂
                End If

                '∂æ¬Èæ´“©∆∑±Í ∂:÷–“©≈‰∑Ωº∞◊È≥…Œ∂÷–“©≤ª¥¶¿Ì
                If InStr(",5,6,", rsTmp!’Ô¡∆¿‡±) > 0 And Not IsNull(rsTmp!∂æ¿Ì∑÷¿‡) Then
                    If InStr(",¬È◊Ì“©,∂æ–‘“©,æ´…Ò“©,æ´…ÒI¿‡,æ´…ÒII¿‡,", rsTmp!∂æ¿Ì∑÷¿‡) > 0 Then
                        .Cell(flexcpFontBold, i, col_“Ω÷ˆƒ⁄»›) = True
                    End If
                End If

                'Pass∏˘æ›…Û≤ÈΩ·π˚œ‘ ææØ æµ∆
                If mblnPass Then
                    If gobjPass.zlPassCheck(mobjPassMap) And Not IsNull(rsTmp!…Û≤ÈΩ·π˚) Then
                        Call gobjPass.zlPassSetWarnLight(mobjPassMap, i, rsTmp!…Û≤ÈΩ·π˚)
                    End If
                End If

                Call Set“Ω÷ˆ≥¨¡ø(i, i)

                rsTmp.MoveNext
            Next

            'πÃ∂®¡–Õº±Í∂‘∆Î:…Ë÷√Œ™÷–∂‘∆Î,≤ª»ª≤¡±ﬂøÚ ±ø…ƒ‹”–Œ Ã‚
            .Cell(flexcpPictureAlignment, .FixedRows, 0, .Rows - 1, .FixedCols - 1) = 4
            'µÁ◊”«©√˚Õº±Í∂‘∆Î
            .Cell(flexcpPictureAlignment, .FixedRows, col_“Ω÷ˆƒ⁄»›, .Rows - 1, col_“Ω÷ˆƒ⁄»›) = 0

            Call .AutoSize(col_“Ω÷ˆƒ⁄»›)
            .Redraw = flexRDDirect
        End With
        mblnRowChange = True
    Else
        mblnRowChange = False
        vsAdvice.Rows = vsAdvice.FixedRows
        vsAdvice.Rows = vsAdvice.FixedRows + 1
        mblnRowChange = True
    End If

    Screen.MousePointer = 0
    LoadAdvice = True
    Exit Function
errH:
    Screen.MousePointer = 0
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Function Checkø™ º ±º‰(ByVal strStart As String, Optional ByVal blnMsg As Boolean = True, Optional strMsg As String) As Boolean
'π¶ƒ‹£∫ºÏ≤È ‰»Îµƒø™ º ±º‰ «∑Ò∫œ∑®
'Àµ√˜£∫
'1.ø™ º ±º‰≤ªƒ‹–°”⁄≤°»Àµƒπ“∫≈ ±º‰
'2.’˝≥£¬º»Î ±,ø™ º ±º‰≤ªƒ‹–°”⁄µ±«∞ ±º‰÷Æ«∞30∑÷÷”(¥”∂¯ø…ƒ‹‘Ï≥…ø™÷ˆ ±º‰¥Û”⁄ø™ º ±º‰30∑÷÷”)
    If Not IsDate(strStart) Then
        MsgBox " ‰»Îµƒ“Ω÷ˆø™ º÷¥–– ±º‰Œﬁ–ß°£", vbInformation, gstrSysName
        Exit Function
    End If
        
    If Format(strStart, "yyyy-MM-dd HH:mm") < Format(mdatπ“∫≈ ±º‰, "yyyy-MM-dd HH:mm") Then
        strMsg = "“Ω÷ˆµƒø™ º÷¥–– ±º‰≤ªƒ‹–°”⁄≤°»Àµƒπ“∫≈ ±º‰ " & Format(mdatπ“∫≈ ±º‰, "yyyy-MM-dd HH:mm") & " °£"
        If blnMsg Then MsgBox strMsg, vbInformation, gstrSysName
        Exit Function
    End If
    
    Checkø™ º ±º‰ = True
End Function

Private Function Check∞≤≈≈ ±º‰(ByVal strDate As String, ByVal strStart As String, ByVal strType As String, Optional ByVal blnMsg As Boolean = True, Optional strMsg As String) As Boolean
'π¶ƒ‹£∫ºÏ≤È ‰»Îµƒ ÷ ı/ ‰—™ ±º‰ «∑Ò∫œ∑®
'Àµ√˜£∫
'1. ÷ ı/ ‰—™ ±º‰≤ªƒ‹–°”⁄“Ω÷ˆµƒø™ º ±º‰
    Dim strInDate As String, strDateType As String
    
    If strType = "F" Then
        strDateType = " ÷ ı"
    ElseIf strType = "K" Then
        strDateType = " ‰—™"
    End If
    
    If Not IsDate(strDate) Then
        strMsg = " ‰»Îµƒ" & strDateType & " ±º‰Œﬁ–ß°£"
        If blnMsg Then MsgBox strMsg, vbInformation, gstrSysName
        Exit Function
    ElseIf IsDate(strStart) Then
        If Format(strDate, "yyyy-MM-dd HH:mm") < Format(strStart, "yyyy-MM-dd HH:mm") Then
            strMsg = strDateType & " ±º‰≤ªƒ‹–°”⁄“Ω÷ˆø™ º ±º‰°£"
            If blnMsg Then MsgBox strMsg, vbInformation, gstrSysName
            Exit Function
        End If
    End If
    
    Check∞≤≈≈ ±º‰ = True
End Function

Private Function Checkø™÷ˆ ±º‰(ByVal strDate As String, ByVal strStart As String, _
    Optional ByVal blnMsg As Boolean = True, Optional strMsg As String) As Boolean
'π¶ƒ‹£∫ºÏ≤Èø™÷ˆ ±º‰ «∑Ò”––ß
'Àµ√˜£∫≤ª”¶–°”⁄≤°»Àπ“∫≈ ±º‰
    If Not IsDate(strDate) Then
        strMsg = " ‰»Îµƒø™÷ˆ ±º‰Œﬁ–ß°£"
        If blnMsg Then MsgBox strMsg, vbInformation, gstrSysName
        Exit Function
    End If
        
'    If Format(strDate, "yyyy-MM-dd HH:mm") < Format(mdatπ“∫≈ ±º‰, "yyyy-MM-dd HH:mm") Then
'        strMsg = "ø™÷ˆ ±º‰≤ªƒ‹–°”⁄≤°»Àµƒπ“∫≈ ±º‰ " & Format(mdatπ“∫≈ ±º‰, "yyyy-MM-dd HH:mm") & " °£"
'        If blnMsg Then MsgBox strMsg, vbInformation, gstrSysName
'        Exit Function
'    End If
    Checkø™÷ˆ ±º‰ = True
End Function

Private Function Check≈‰ŒÈΩ˚º…(ByVal str“©∆∑IDs As String) As Boolean
'π¶ƒ‹£∫ºÏ≤ÈŒ˜≥…“©,÷–≥…“©µƒ≈‰ŒÈΩ˚º…;÷–“©≈‰∑Ω≤ª‘⁄’‚¿ÔºÏ≤È
'≤Œ ˝£∫str“©∆∑IDs="1,2,3,..."
    Dim rsTmp As New ADODB.Recordset
    Dim rsMain As New ADODB.Recordset
    Dim strSQL As String, i As Long, j As Long, k As Long
    Dim arr…˜”√ As Variant, arrΩ˚”√ As Variant
    Dim arrItems As Variant, strMsg As String, strTmp As String
    Dim lngœÓƒøid As Long, str√˚≥∆ As String, blnŒ¥±‡º≠ As Boolean
    Dim lng◊È±‡∫≈ As Long, lngRow As Long, lngSeekRow As Long
    
    On Error GoTo errH
        
    arr…˜”√ = Array(): arrΩ˚”√ = Array()
        
    strSQL = "Select /*+ rule*/ ◊È±‡∫≈ From ’Ô¡∆ª•≥‚œÓƒø" & _
        " Where œÓƒøID IN(Select Column_Value From Table(f_Num2list([1]))) Group by ◊È±‡∫≈ Having Count(*)>1"
    Set rsMain = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, str“©∆∑IDs)
    For k = 1 To rsMain.RecordCount
        strSQL = "Select /*+ RULE */ A.◊È±‡∫≈,A.¿‡–Õ,A.œÓƒøID,B.√˚≥∆" & _
            " From ’Ô¡∆ª•≥‚œÓƒø A,’Ô¡∆œÓƒøƒø¬º B" & _
            " Where A.œÓƒøID=B.ID And A.◊È±‡∫≈=[2]" & _
            " And A.œÓƒøID IN(Select Column_Value From Table(f_Num2list([1])))" & _
            " Order by A.◊È±‡∫≈,B.±‡¬Î"
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, str“©∆∑IDs, Val(rsMain!◊È±‡∫≈))
        For i = 1 To rsTmp.RecordCount
            If rsTmp!◊È±‡∫≈ <> lng◊È±‡∫≈ Then
                If rsTmp!¿‡–Õ = 1 Then
                    ReDim Preserve arr…˜”√(UBound(arr…˜”√) + 1)
                Else
                    ReDim Preserve arrΩ˚”√(UBound(arrΩ˚”√) + 1)
                End If
                lng◊È±‡∫≈ = rsTmp!◊È±‡∫≈
            End If
            If rsTmp!¿‡–Õ = 1 Then
                arr…˜”√(UBound(arr…˜”√)) = arr…˜”√(UBound(arr…˜”√)) & Chr(234) & rsTmp!œÓƒøID & Chr(8) & rsTmp!√˚≥∆
            Else
                arrΩ˚”√(UBound(arrΩ˚”√)) = arrΩ˚”√(UBound(arrΩ˚”√)) & Chr(234) & rsTmp!œÓƒøID & Chr(8) & rsTmp!√˚≥∆
            End If
            rsTmp.MoveNext
        Next
        rsMain.MoveNext
    Next
    
    'œ»ºÏ≤ÈΩ˚”√≤ø∑›(Ω˚÷πºÃ–¯)
    If UBound(arrΩ˚”√) >= 0 Then
        strMsg = "": lngSeekRow = 0
        For i = 0 To UBound(arrΩ˚”√) '√ø◊È
            strTmp = "": blnŒ¥±‡º≠ = True
            arrItems = Split(Mid(arrΩ˚”√(i), 2), Chr(234))
            For j = 0 To UBound(arrItems) '√øœÓƒø
                lngœÓƒøid = Split(arrItems(j), Chr(8))(0)
                str√˚≥∆ = Split(arrItems(j), Chr(8))(1)
                strTmp = strTmp & "£¨" & str√˚≥∆
                
                'Œ™¡À∂®Œª,‘⁄“Ω÷ˆ÷–≤È’“±æ¥Œ–¬‘ˆªÚ–ﬁ∏ƒµƒ∏√œÓƒø(ø…ƒ‹”–∂‡∏ˆ)À˘‘⁄––
                lngRow = -1
                Do While True
                    lngRow = vsAdvice.FindRow(CStr(lngœÓƒøid), lngRow + 1, COL_’Ô¡∆œÓƒøID)
                    If lngRow = -1 Then
                        Exit Do
                    ElseIf InStr(",1,2,", vsAdvice.TextMatrix(lngRow, COL_EDIT)) > 0 Then
                        If lngSeekRow = 0 Or lngRow < lngSeekRow Then lngSeekRow = lngRow '±‡º≠π˝µƒ◊Ó–°––”≈œ»∂®Œª
                        blnŒ¥±‡º≠ = False: Exit Do
                    End If
                Loop
            Next
            If Not blnŒ¥±‡º≠ Then '»Áπ˚“ª◊È÷–µƒœÓƒø‘⁄±æ¥Œ∂ºŒ¥±‡º≠π˝,‘Ú≤ªπ‹
                strMsg = strMsg & vbCrLf & "°Ò " & Mid(strTmp, 2)
            End If
        Next
        If strMsg <> "" Then
            If lngSeekRow <> 0 Then
                vsAdvice.Col = col_“Ω÷ˆƒ⁄»›: vsAdvice.Row = lngSeekRow
                Call vsAdvice.ShowCell(vsAdvice.Row, vsAdvice.Col)
            End If
            MsgBox "‘⁄≤°»À“Ω÷ˆ÷–∑¢œ÷“‘œ¬“©∆∑ª•œ‡Ω˚”√£∫" & strMsg, vbInformation, gstrSysName
            Exit Function
        End If
    End If
    
    '‘ŸºÏ≤È…˜”√≤ø∑›(Ã·–— «∑ÒºÃ–¯)
    If UBound(arr…˜”√) >= 0 Then
        strMsg = "": lngSeekRow = 0
        For i = 0 To UBound(arr…˜”√) '√ø◊È
            strTmp = "": blnŒ¥±‡º≠ = True
            arrItems = Split(Mid(arr…˜”√(i), 2), Chr(234))
            For j = 0 To UBound(arrItems) '√øœÓƒø
                lngœÓƒøid = Split(arrItems(j), Chr(8))(0)
                str√˚≥∆ = Split(arrItems(j), Chr(8))(1)
                strTmp = strTmp & "£¨" & str√˚≥∆
                
                'Œ™¡À∂®Œª,‘⁄“Ω÷ˆ÷–≤È’“±æ¥Œ–¬‘ˆªÚ–ﬁ∏ƒµƒ∏√œÓƒø(ø…ƒ‹”–∂‡∏ˆ)À˘‘⁄––
                lngRow = -1
                Do While True
                    lngRow = vsAdvice.FindRow(CStr(lngœÓƒøid), lngRow + 1, COL_’Ô¡∆œÓƒøID)
                    If lngRow = -1 Then
                        Exit Do
                    ElseIf InStr(",1,2,", vsAdvice.TextMatrix(lngRow, COL_EDIT)) > 0 Then
                        If lngSeekRow = 0 Or lngRow < lngSeekRow Then lngSeekRow = lngRow '±‡º≠π˝µƒ◊Ó–°––”≈œ»∂®Œª
                        blnŒ¥±‡º≠ = False: Exit Do
                    End If
                Loop
            Next
            If Not blnŒ¥±‡º≠ Then '»Áπ˚“ª◊È÷–µƒœÓƒø‘⁄±æ¥Œ∂ºŒ¥±‡º≠π˝,‘Ú≤ªπ‹
                strMsg = strMsg & vbCrLf & "°Ò " & Mid(strTmp, 2)
            End If
        Next
        If strMsg <> "" Then
            If lngSeekRow <> 0 Then
                vsAdvice.Col = col_“Ω÷ˆƒ⁄»›: vsAdvice.Row = lngSeekRow
                Call vsAdvice.ShowCell(vsAdvice.Row, vsAdvice.Col)
            End If
            If MsgBox("‘⁄≤°»À“Ω÷ˆ÷–∑¢œ÷“‘œ¬“©∆∑ª•œ‡…˜”√£∫" & strMsg & vbCrLf & vbCrLf & "“™ºÃ–¯¬£ø", _
                vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbNo Then
                Exit Function
            End If
        End If
    End If
    
    Check≈‰ŒÈΩ˚º… = True
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Function Check’Ô¡∆ª•≥‚(ByVal str’Ô¡∆IDs As String) As Boolean
'π¶ƒ‹£∫ºÏ≤È∑«“©∆∑(≥…“©,÷–“©)µƒª•≥‚
'≤Œ ˝£∫str’Ô¡∆IDs="1,2,3,..."
    Dim rsTmp As New ADODB.Recordset
    Dim rsMain As New ADODB.Recordset
    Dim strSQL As String, i As Long, j As Long, k As Long
    Dim arrÃ·–— As Variant, arrΩ˚÷π As Variant, arrÕ£÷π As Variant
    Dim arrItems As Variant, strMsg As String, strTmp As String
    Dim lngœÓƒøid As Long, str√˚≥∆ As String, blnŒ¥±‡º≠ As Boolean
    Dim lng◊È±‡∫≈ As Long, lngRow As Long, lngSeekRow As Long
    
    On Error GoTo errH
        
    arrÃ·–— = Array(): arrΩ˚÷π = Array(): arrÕ£÷π = Array()
    
    strSQL = "Select /*+ rule*/ ◊È±‡∫≈ From ’Ô¡∆ª•≥‚œÓƒø" & _
        " Where œÓƒøID IN(Select Column_Value From Table(f_Num2list([1]))) Group by ◊È±‡∫≈ Having Count(*)>1"
    Set rsMain = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, str’Ô¡∆IDs)
    For k = 1 To rsMain.RecordCount
        strSQL = "Select /*+ RULE */ A.◊È±‡∫≈,A.◊È√˚≥∆,A.¿‡–Õ,A.œÓƒøID,B.√˚≥∆" & _
            " From ’Ô¡∆ª•≥‚œÓƒø A,’Ô¡∆œÓƒøƒø¬º B" & _
            " Where A.œÓƒøID=B.ID And A.◊È±‡∫≈=[2]" & _
            " And A.œÓƒøID IN(Select Column_Value From Table(f_Num2list([1])))" & _
            " Order by A.◊È±‡∫≈,B.±‡¬Î"
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, str’Ô¡∆IDs, Val(rsMain!◊È±‡∫≈))
        For i = 1 To rsTmp.RecordCount
            If rsTmp!◊È±‡∫≈ <> lng◊È±‡∫≈ Then
                If rsTmp!¿‡–Õ = 1 Then
                    ReDim Preserve arrÃ·–—(UBound(arrÃ·–—) + 1)
                    arrÃ·–—(UBound(arrÃ·–—)) = rsTmp!◊È√˚≥∆
                ElseIf rsTmp!¿‡–Õ = 2 Then
                    ReDim Preserve arrΩ˚÷π(UBound(arrΩ˚÷π) + 1)
                    arrΩ˚÷π(UBound(arrΩ˚÷π)) = rsTmp!◊È√˚≥∆
                Else
                    ReDim Preserve arrÕ£÷π(UBound(arrÕ£÷π) + 1)
                    arrÕ£÷π(UBound(arrÕ£÷π)) = rsTmp!◊È√˚≥∆
                End If
                lng◊È±‡∫≈ = rsTmp!◊È±‡∫≈
            End If
            If rsTmp!¿‡–Õ = 1 Then
                arrÃ·–—(UBound(arrÃ·–—)) = arrÃ·–—(UBound(arrÃ·–—)) & Chr(234) & rsTmp!œÓƒøID & Chr(8) & rsTmp!√˚≥∆
            ElseIf rsTmp!¿‡–Õ = 2 Then
                arrΩ˚÷π(UBound(arrΩ˚÷π)) = arrΩ˚÷π(UBound(arrΩ˚÷π)) & Chr(234) & rsTmp!œÓƒøID & Chr(8) & rsTmp!√˚≥∆
            Else
                arrÕ£÷π(UBound(arrÕ£÷π)) = arrÕ£÷π(UBound(arrÕ£÷π)) & Chr(234) & rsTmp!œÓƒøID & Chr(8) & rsTmp!√˚≥∆
            End If
            rsTmp.MoveNext
        Next
        rsMain.MoveNext
    Next
    'œ»ºÏ≤ÈΩ˚÷πºÃ–¯≤ø∑›
    If UBound(arrΩ˚÷π) >= 0 Then
        strMsg = "": lngSeekRow = 0
        For i = 0 To UBound(arrΩ˚÷π) '√ø◊È
            strTmp = "": blnŒ¥±‡º≠ = True
            arrItems = Split(arrΩ˚÷π(i), Chr(234))
            For j = 1 To UBound(arrItems) '√øœÓƒø
                lngœÓƒøid = Split(arrItems(j), Chr(8))(0)
                str√˚≥∆ = Split(arrItems(j), Chr(8))(1)
                strTmp = strTmp & vbCrLf & vbTab & str√˚≥∆
                
                'Œ™¡À∂®Œª,‘⁄“Ω÷ˆ÷–≤È’“±æ¥Œ–¬‘ˆªÚ–ﬁ∏ƒµƒ∏√œÓƒø(ø…ƒ‹”–∂‡∏ˆ)À˘‘⁄––
                lngRow = -1
                Do While True
                    lngRow = vsAdvice.FindRow(CStr(lngœÓƒøid), lngRow + 1, COL_’Ô¡∆œÓƒøID)
                    If lngRow = -1 Then
                        Exit Do
                    ElseIf Val(vsAdvice.TextMatrix(lngRow, COL_EDIT)) = 1 Then
                        If lngSeekRow = 0 Or lngRow < lngSeekRow Then lngSeekRow = lngRow '±‡º≠π˝µƒ◊Ó–°––”≈œ»∂®Œª
                        blnŒ¥±‡º≠ = False: Exit Do
                    End If
                Loop
            Next
            If Not blnŒ¥±‡º≠ Then '»Áπ˚“ª◊È÷–µƒœÓƒø‘⁄±æ¥Œ∂ºŒ¥±‡º≠π˝,‘Ú≤ªπ‹
                strMsg = strMsg & vbCrLf & vbCrLf & arrItems(0) & "£∫" & Mid(strTmp, 2)
            End If
        Next
        If strMsg <> "" Then
            If lngSeekRow <> 0 Then
                vsAdvice.Col = col_“Ω÷ˆƒ⁄»›: vsAdvice.Row = lngSeekRow
                Call vsAdvice.ShowCell(vsAdvice.Row, vsAdvice.Col)
            End If
            MsgBox "‘⁄≤°»À“Ω÷ˆ÷–∑¢œ÷“‘œ¬ƒ⁄»›ª•œ‡≈≈≥‚£∫" & strMsg, vbInformation, gstrSysName
            Exit Function
        End If
    End If
    
    '‘ŸºÏ≤È◊‘∂ØÕ£÷π≤ø∑›,√≈’Ô¥¶¿ÌŒ™Ω˚÷π(¡Ÿ÷ˆ)
    If UBound(arrÕ£÷π) >= 0 Then
        strMsg = "": lngSeekRow = 0
        For i = 0 To UBound(arrÕ£÷π) '√ø◊È
            strTmp = "": blnŒ¥±‡º≠ = True
            arrItems = Split(arrÕ£÷π(i), Chr(234))
            For j = 1 To UBound(arrItems) '√øœÓƒø
                lngœÓƒøid = Split(arrItems(j), Chr(8))(0)
                str√˚≥∆ = Split(arrItems(j), Chr(8))(1)
                strTmp = strTmp & vbCrLf & vbTab & str√˚≥∆
                
                'Œ™¡À∂®Œª,‘⁄“Ω÷ˆ÷–≤È’“±æ¥Œ–¬‘ˆªÚ–ﬁ∏ƒµƒ∏√œÓƒø(ø…ƒ‹”–∂‡∏ˆ)À˘‘⁄––
                lngRow = -1
                Do While True
                    lngRow = vsAdvice.FindRow(CStr(lngœÓƒøid), lngRow + 1, COL_’Ô¡∆œÓƒøID)
                    If lngRow = -1 Then
                        Exit Do
                    ElseIf InStr(",1,2,", vsAdvice.TextMatrix(lngRow, COL_EDIT)) > 0 Then
                        If lngSeekRow = 0 Or lngRow < lngSeekRow Then lngSeekRow = lngRow '±‡º≠π˝µƒ◊Ó–°––”≈œ»∂®Œª
                        blnŒ¥±‡º≠ = False ': Exit Do
                    End If
                Loop
            Next
            If Not blnŒ¥±‡º≠ Then '»Áπ˚“ª◊È÷–µƒœÓƒø‘⁄±æ¥Œ∂ºŒ¥±‡º≠π˝,‘Ú≤ªπ‹
                strMsg = strMsg & vbCrLf & vbCrLf & arrItems(0) & "£∫" & Mid(strTmp, 2)
            End If
        Next
        If strMsg <> "" Then
            If lngSeekRow <> 0 Then
                vsAdvice.Col = col_“Ω÷ˆƒ⁄»›: vsAdvice.Row = lngSeekRow
                Call vsAdvice.ShowCell(vsAdvice.Row, vsAdvice.Col)
            End If
            MsgBox "‘⁄≤°»À“Ω÷ˆ÷–∑¢œ÷“‘œ¬ƒ⁄»›ª•œ‡≈≈≥‚£∫" & strMsg, vbInformation, gstrSysName
            Exit Function
        End If
    End If
    
    '‘ŸºÏ≤ÈÃ·–— «∑ÒºÃ–¯≤ø∑›
    If UBound(arrÃ·–—) >= 0 Then
        strMsg = "": lngSeekRow = 0
        For i = 0 To UBound(arrÃ·–—) '√ø◊È
            strTmp = "": blnŒ¥±‡º≠ = True
            arrItems = Split(arrÃ·–—(i), Chr(234))
            For j = 1 To UBound(arrItems) '√øœÓƒø
                lngœÓƒøid = Split(arrItems(j), Chr(8))(0)
                str√˚≥∆ = Split(arrItems(j), Chr(8))(1)
                strTmp = strTmp & vbCrLf & vbTab & str√˚≥∆
                
                'Œ™¡À∂®Œª,‘⁄“Ω÷ˆ÷–≤È’“±æ¥Œ–¬‘ˆªÚ–ﬁ∏ƒµƒ∏√œÓƒø(ø…ƒ‹”–∂‡∏ˆ)À˘‘⁄––
                lngRow = -1
                Do While True
                    lngRow = vsAdvice.FindRow(CStr(lngœÓƒøid), lngRow + 1, COL_’Ô¡∆œÓƒøID)
                    If lngRow = -1 Then
                        Exit Do
                    ElseIf InStr(",1,2,", vsAdvice.TextMatrix(lngRow, COL_EDIT)) > 0 Then
                        If lngSeekRow = 0 Or lngRow < lngSeekRow Then lngSeekRow = lngRow '±‡º≠π˝µƒ◊Ó–°––”≈œ»∂®Œª
                        blnŒ¥±‡º≠ = False: Exit Do
                    End If
                Loop
            Next
            If Not blnŒ¥±‡º≠ Then '»Áπ˚“ª◊È÷–µƒœÓƒø‘⁄±æ¥Œ∂ºŒ¥±‡º≠π˝,‘Ú≤ªπ‹
                strMsg = strMsg & vbCrLf & vbCrLf & arrItems(0) & "£∫" & Mid(strTmp, 2)
            End If
        Next
        If strMsg <> "" Then
            If lngSeekRow <> 0 Then
                vsAdvice.Col = col_“Ω÷ˆƒ⁄»›: vsAdvice.Row = lngSeekRow
                Call vsAdvice.ShowCell(vsAdvice.Row, vsAdvice.Col)
            End If
            If MsgBox("‘⁄≤°»À“Ω÷ˆ÷–∑¢œ÷“‘œ¬ƒ⁄»›ª•œ‡≈≈≥‚£∫" & strMsg & vbCrLf & vbCrLf & "“™ºÃ–¯¬£ø", _
                vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbNo Then
                Exit Function
            End If
        End If
    End If
    
    Check’Ô¡∆ª•≥‚ = True
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Function CheckStock(ByVal lngRow As Long) As String
'π¶ƒ‹£∫ºÏ≤È÷∏∂®“©∆∑––µƒø‚¥Ê«Èøˆ
'∑µªÿ£∫ø’=±Ì æÕ®π˝
    Dim dbl◊‹¡ø As Double, strMsg As String
    Dim lng÷¥––ø∆ “ID As Long, i As Integer
    
    With vsAdvice
        If InStr(",5,6,", .TextMatrix(lngRow, COL_¿‡±)) > 0 Or .TextMatrix(lngRow, COL_¿‡±) = "4" And Val(.TextMatrix(lngRow, COL_∏˙◊Ÿ‘⁄”√)) = 1 Then
            If TheStockCheck(Val(.TextMatrix(lngRow, COL_÷¥––ø∆ “ID)), .TextMatrix(lngRow, COL_¿‡±)) <> 0 Then
                If .TextMatrix(lngRow, COL_ø‚¥Ê) <> "" Then
                    '≥…“©¡Ÿ÷ˆ÷±Ω”ºÏ≤È◊‹¡ø
                    dbl◊‹¡ø = Val(.TextMatrix(lngRow, COL_◊‹¡ø))
                    If dbl◊‹¡ø > 0 Then
                        If dbl◊‹¡ø > Val(.TextMatrix(lngRow, COL_ø‚¥Ê)) Then
                            strMsg = """" & .TextMatrix(lngRow, col_“Ω÷ˆƒ⁄»›) & """ø‚¥ÊÃ·–—£∫" & _
                                vbCrLf & vbCrLf & Get≤ø√≈√˚≥∆(Val(.TextMatrix(lngRow, COL_÷¥––ø∆ “ID))) & _
                                IIF(InStr(GetInsidePrivs(p√≈’Ô“Ω÷ˆœ¬¥Ô), "œ‘ æ“©∆∑ø‚¥Ê") = 0, _
                                "µ±«∞ø…”√ø‚¥Ê≤ª◊„ " & FormatEx(dbl◊‹¡ø, 5) & .TextMatrix(lngRow, COL_√≈’Ôµ•Œª) & "°£", _
                                "µ±«∞ø…”√ø‚¥ÊŒ™ " & FormatEx(Val(.TextMatrix(lngRow, COL_ø‚¥Ê)), 5) & .TextMatrix(lngRow, COL_√≈’Ôµ•Œª) & "£¨≤ª◊„ " & FormatEx(dbl◊‹¡ø, 5) & .TextMatrix(lngRow, COL_√≈’Ôµ•Œª) & "°£")
                        End If
                    End If
                End If
            End If
        ElseIf RowIn≈‰∑Ω––(lngRow) And Val(.TextMatrix(lngRow, COL_◊‹¡ø)) <> 0 Then
            '∏˘æ›∏∂ ˝º∆À„◊‹¡ø
            For i = lngRow - 1 To .FixedRows Step -1
                If Val(.TextMatrix(i, COL_œ‡πÿID)) = .RowData(lngRow) Then
                    If .TextMatrix(i, COL_¿‡±) = "7" And .TextMatrix(i, COL_ø‚¥Ê) <> "" Then
                        '◊‹¡ø=√≈’Ô∞¸◊∞(µ•Œ∂º¡¡ø*∏∂ ˝)
                        '÷–“©“©∑øµ•Œª∞¥≤ªø…∑÷¡„¥¶¿Ì:√ø∏∂
                        If Val(.TextMatrix(i, COL_ø…∑Ò∑÷¡„)) = 0 Then
                            dbl◊‹¡ø = Val(.TextMatrix(i, COL_◊‹¡ø)) * Val(.TextMatrix(i, COL_µ•¡ø)) / Val(.TextMatrix(i, COL_º¡¡øœµ ˝)) / Val(.TextMatrix(i, COL_√≈’Ô∞¸◊∞))
                        Else
                            dbl◊‹¡ø = Val(.TextMatrix(i, COL_◊‹¡ø)) * IntEx(Val(.TextMatrix(i, COL_µ•¡ø)) / Val(.TextMatrix(i, COL_º¡¡øœµ ˝)) / Val(.TextMatrix(i, COL_√≈’Ô∞¸◊∞)))
                        End If
                        If dbl◊‹¡ø > Val(.TextMatrix(i, COL_ø‚¥Ê)) Then
                            lng÷¥––ø∆ “ID = Val(.TextMatrix(i, COL_÷¥––ø∆ “ID))
                            If TheStockCheck(lng÷¥––ø∆ “ID, .TextMatrix(i, COL_¿‡±)) = 0 Then Exit For
                            
                            strMsg = strMsg & vbCrLf & .TextMatrix(i, col_“Ω÷ˆƒ⁄»›) & _
                                "£∫À˘–Ë◊‹¡ø " & FormatEx(dbl◊‹¡ø, 5) & .TextMatrix(i, COL_√≈’Ôµ•Œª) & _
                                "£¨ø…”√ø‚¥Ê" & IIF(InStr(GetInsidePrivs(p√≈’Ô“Ω÷ˆœ¬¥Ô), "œ‘ æ“©∆∑ø‚¥Ê") = 0, _
                                    "≤ª◊„", " " & FormatEx(Val(.TextMatrix(i, COL_ø‚¥Ê)), 5) & .TextMatrix(i, COL_√≈’Ôµ•Œª))
                        End If
                    End If
                Else
                    Exit For
                End If
            Next
            If strMsg <> "" Then
                strMsg = "÷–“©≈‰∑Ωø‚¥ÊÃ·–—£¨" & Get≤ø√≈√˚≥∆(lng÷¥––ø∆ “ID) & "÷–“‘œ¬Œ∂“©ø‚¥Ê≤ª◊„£∫" & vbCrLf & strMsg
            End If
        End If
    End With
    CheckStock = strMsg
End Function

Private Function CheckMoney() As Boolean
'π¶ƒ‹£∫∑—”√±®æØºÏ≤È
'Àµ√˜£∫≤°«¯”–¿€º∆∑—”√±®æØ∑Ω Ω ±,÷ªÃ·–—°£
    Dim rsTmp As New ADODB.Recordset
    Dim str  ”√≤°»À As String, strSQL As String
    Dim cur‘§Ωª As Currency, cur”‡∂Ó As Currency
    Dim curµ£±£∂Ó As Currency
    
    On Error GoTo errH
    '∑—”√”‡∂Ó
    strSQL = "Select ‘§Ωª”‡∂Ó,Nvl(‘§Ωª”‡∂Ó,0)-Nvl(∑—”√”‡∂Ó,0) as ”‡∂Ó From ≤°»À”‡∂Ó Where –‘÷ =1 And ¿‡–Õ = 1 And ≤°»ÀID=[1]"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng≤°»ÀID)
    If Not rsTmp.EOF Then
        cur‘§Ωª = Nvl(rsTmp!‘§Ωª”‡∂Ó, 0)
        cur”‡∂Ó = Nvl(rsTmp!”‡∂Ó, 0)
    End If
    
    'µ£±£∂Ó
    strSQL = "Select µ£±£∂Ó From ≤°»À–≈œ¢ Where ≤°»ÀID=[1]"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng≤°»ÀID)
    If Not rsTmp.EOF Then curµ£±£∂Ó = Nvl(rsTmp!µ£±£∂Ó, 0)
    
    '”–‘§ΩªøÓµƒ≤°»À≤≈≈–∂œ
    If cur‘§Ωª <> 0 Then
        ' «∑Ò“Ω±£
        strSQL = "Select zl_PatiWarnScheme([1]) as   ”√≤°»À From Dual"
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng≤°»ÀID)
        If Not rsTmp.EOF Then str  ”√≤°»À = Nvl(rsTmp!  ”√≤°»À)
            
        '±®æØ÷µ:NULL”Î0µ±◊˜≤ªÕ¨“‚“Â¥¶¿Ì
        strSQL = "Select ±®æØ÷µ From º«’ ±®æØœﬂ Where ±®æØ∑Ω∑®=1 And Nvl(≤°«¯ID,0)=0 And ±®æØ÷µ is Not NULL And   ”√≤°»À=[1]"
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, str  ”√≤°»À)
        If Not rsTmp.EOF Then
            If cur”‡∂Ó + curµ£±£∂Ó < Nvl(rsTmp!±®æØ÷µ, 0) Then
                If MsgBox("≤°»Àµ±«∞ø…”√ £”‡øÓ " & FormatEx(cur”‡∂Ó + curµ£±£∂Ó, 2) & IIF(curµ£±£∂Ó <> 0, "(∫¨µ£±£∂Ó:" & FormatEx(curµ£±£∂Ó, 2) & ")", "") & " µÕ”⁄±®æØ÷µ " & FormatEx(Nvl(rsTmp!±®æØ÷µ, 0), 2) & "£¨“™ºÃ–¯¬£ø", _
                    vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbNo Then
                    Exit Function
                End If
            End If
        End If
    End If
    CheckMoney = True
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Sub GetRowScope(ByVal lngRow As Long, lngBegin As Long, lngEnd As Long)
'π¶ƒ‹£∫ªÒ»°◊ÈIDœ‡Õ¨µƒ“ª◊È“Ω÷ˆ––∫≈∑∂Œß(◊¢“‚øº¬«“ª≤¢∏¯“©÷–µƒø’––)
    Dim lngS◊ÈID As Long, lngO◊ÈID As Long, i As Long
    With vsAdvice
        lngBegin = lngRow: lngEnd = lngRow
        lngS◊ÈID = IIF(Val(.TextMatrix(lngRow, COL_œ‡πÿID)) = 0, .RowData(lngRow), Val(.TextMatrix(lngRow, COL_œ‡πÿID)))
        For i = lngRow - 1 To .FixedRows Step -1
            lngO◊ÈID = IIF(Val(.TextMatrix(i, COL_œ‡πÿID)) = 0, .RowData(i), Val(.TextMatrix(i, COL_œ‡πÿID)))
            If Not (.RowData(i) = 0 And i >= .FixedRows) Then 'Ã¯π˝ø’––
                If lngO◊ÈID = lngS◊ÈID Then
                    lngBegin = i
                Else
                    Exit For
                End If
            End If
        Next
        For i = lngRow + 1 To .Rows - 1
            lngO◊ÈID = IIF(Val(.TextMatrix(i, COL_œ‡πÿID)) = 0, .RowData(i), Val(.TextMatrix(i, COL_œ‡πÿID)))
            If Not (.RowData(i) = 0 And i >= .FixedRows) Then 'Ã¯π˝ø’––
                If lngO◊ÈID = lngS◊ÈID Then
                    lngEnd = i
                Else
                    Exit For
                End If
            End If
        Next
    End With
End Sub

Private Function CheckAdvice() As Boolean
'π¶ƒ‹£∫ºÏ≤Èµ±«∞≤°»À(”§∂˘)µƒ“Ω÷ˆ ‰»Î «∑Ò∫œ∑®
'Àµ√˜£∫»Áπ˚”–≤ª∫œ∑®µƒµÿ∑Ω£¨‘⁄±æ∫Ø ˝÷–Ã· æº∞∂®Œª
    Dim rsTmp As ADODB.Recordset, strSQL As String
    Dim bln≈‰∑Ω–– As Boolean, blnºÏ—È–– As Boolean
    Dim dbl◊‹¡ø As Double, strMsg As String
    Dim str“©∆∑IDs As String, str’Ô¡∆IDs As String
    Dim lngCount As Long, lngRow As Long
    Dim blnSkipStock As Boolean, blnSkipTotal As Boolean
    Dim vMsg As VbMsgBoxResult, sngÃÏ ˝ As Single
    Dim blnValid As Boolean, lngRxCount As Long
    Dim blnAppend As Boolean, i As Long, j As Long, k As Long
    Dim strº≤≤°IDs As String, str’Ô∂œIDs As String
    Dim str÷–“©√˚ As String, strExtra As String, lng÷˜ID As Long
    Dim lng¬È◊Ì’Ô¡∆ID As Long, lng∏¯“©÷¥–––‘÷  As Long, str≤øŒª∑Ω∑® As String
    Dim lngBegin As Long, lngEnd As Long
    Dim blnExists As Boolean
    Dim dblOneDay As Double
    Dim datCur As Date
    Dim blnNo As Boolean, blnCheck≥¨¡ø As Boolean, blnOut As Boolean
    Dim strIDs1 As String, strIDs2 As String, str“Ω÷ˆƒ⁄»› As String
    Dim lngSame As Long
    
    On Error GoTo errH
    If vsAdvice.Enabled = True Then
        If Me.ActiveControl.Name = "txt◊‹¡ø" Then
            Call txt◊‹¡ø_Validate(False)
        ElseIf Me.ActiveControl.Name = "txtµ•¡ø" Then
            Call txtµ•¡ø_Validate(False)
        ElseIf Me.ActiveControl.Name = "txtÃÏ ˝" Then
            Call txtÃÏ ˝_Validate(False)
        End If
        vsAdvice.SetFocus  '¥¶¿Ìπ‚±Í∂®Œª£¨»Áπ˚π‚±Íªπ√ª¿Îø™ ‰»ÎøÚ£¨‘ÚªπŒ¥∏¸–¬ ˝æ›°£
    End If
    If Not CheckApply Then Exit Function
    datCur = zlDatabase.Currentdate
    '’Ô∂œµƒºÏ≤È
    '-----------------------------------------------------------------------------------------
    With vsDiag
        For i = .FixedRows To .Rows - 1
            If Trim(.TextMatrix(i, col’Ô∂œ)) <> "" Then
                If mintœ’¿‡ = 920 Then '±±æ©“Ω±£Œﬁ¿Ì“™«Û
                    If zlCommFun.ActualLen(.TextMatrix(i, col’Ô∂œ)) > 82 Then
                        .Row = i: .Col = col’Ô∂œ
                        MsgBox "’Ô∂œƒ⁄»›Ã´≥§£¨÷ª‘ –Ì82∏ˆ◊÷∑˚ªÚ41∏ˆ∫∫◊÷°£", vbInformation, gstrSysName
                        vsDiag.SetFocus: Exit Function
                    End If
                End If
                If zlCommFun.ActualLen(.TextMatrix(i, col’Ô∂œ)) > 200 Then
                    .Row = i: .Col = col’Ô∂œ
                    MsgBox "’Ô∂œƒ⁄»›Ã´≥§£¨÷ª‘ –Ì200∏ˆ◊÷∑˚ªÚ100∏ˆ∫∫◊÷°£", vbInformation, gstrSysName
                    vsDiag.SetFocus: Exit Function
                End If
                If .TextMatrix(i, col∑¢≤° ±º‰) <> "" Then
                    If Format(datCur, "YYYY-MM-DD HH:mm") < Format(.TextMatrix(i, col∑¢≤° ±º‰), "YYYY-MM-DD HH:mm") Then
                         .Row = i: .Col = col∑¢≤° ±º‰
                        MsgBox "∑¢≤° ±º‰”¶∏√‘Á”⁄µ±«∞ ±º‰°£", vbInformation, gstrSysName
                        vsDiag.SetFocus: Exit Function
                    End If
                End If
                lngSame = 0
                For j = i + 1 To .Rows - 1
                    If Trim(.TextMatrix(j, col’Ô∂œ)) <> "" And .Cell(flexcpData, i, col÷–“Ω) = .Cell(flexcpData, j, col÷–“Ω) Then 'Õ¨¿‡–Õ’Ô∂œ
                        If .TextMatrix(j, col’Ô∂œ) & "|" & .TextMatrix(j, col÷–“Ω÷§∫Ú) = .TextMatrix(i, col’Ô∂œ) & "|" & .TextMatrix(i, col÷–“Ω÷§∫Ú) Then
                            .Row = i: .Col = col’Ô∂œ
                            MsgBox "∑¢œ÷¥Ê‘⁄¡Ω––œ‡Õ¨µƒ’Ô∂œ–≈œ¢°£", vbInformation, gstrSysName
                            vsDiag.SetFocus: Exit Function
                        ElseIf Val(.TextMatrix(i, colº≤≤°ID)) <> 0 Then
                            If Val(.TextMatrix(j, colº≤≤°ID)) & "|" & .TextMatrix(j, col÷–“Ω÷§∫Ú) = Val(.TextMatrix(i, colº≤≤°ID)) & "|" & .TextMatrix(i, col÷–“Ω÷§∫Ú) Then
                                .Row = i: .Col = col’Ô∂œ
                                MsgBox "∑¢œ÷¥Ê‘⁄¡Ω––œ‡Õ¨µƒº≤≤°–≈œ¢°£", vbInformation, gstrSysName
                                vsDiag.SetFocus: Exit Function
                            End If
                        ElseIf Val(.TextMatrix(i, col’Ô∂œID)) <> 0 And .Cell(flexcpData, i, col÷–“Ω) = 0 Then
                            '“Ú÷–“Ω’Ô∂œ¥¯÷§∫Ú,ø…ƒ‹Œﬁ∂‘”¶÷§∫ÚID,’Ô∂œID”÷œ‡Õ¨
                            If Val(.TextMatrix(j, col’Ô∂œID)) = Val(.TextMatrix(i, col’Ô∂œID)) Then
                                .Row = i: .Col = col’Ô∂œ
                                MsgBox "∑¢œ÷¥Ê‘⁄¡Ω––œ‡Õ¨µƒ’Ô∂œ–≈œ¢°£", vbInformation, gstrSysName
                                vsDiag.SetFocus: Exit Function
                            End If
                        End If
                        If .Cell(flexcpData, i, col÷–“Ω) <> 0 Then '÷–“Ω’Ô∂œ
                             If .TextMatrix(j, col’Ô∂œ) = .TextMatrix(i, col’Ô∂œ) Then
                                lngSame = lngSame + 1
                             ElseIf Val(.TextMatrix(i, colº≤≤°ID)) <> 0 Then
                                If Val(.TextMatrix(j, colº≤≤°ID)) = Val(.TextMatrix(i, colº≤≤°ID)) Then
                                    lngSame = lngSame + 1
                                End If
                             End If
                            If lngSame >= 2 Then
                                .Row = i: .Col = col’Ô∂œ
                                MsgBox "¥Ê‘⁄¡ΩÃı“‘…œµƒ’Ô∂œœ‡Õ¨«“÷§∫Ú≤ªÕ¨µƒ’Ô∂œ£¨’Ô∂œ≤ª√˜»∑°£", vbInformation, gstrSysName
                                vsDiag.SetFocus: Exit Function
                            End If
                        End If
                    End If
                Next
                If Val(.TextMatrix(i, colº≤≤°ID)) <> 0 Then strº≤≤°IDs = strº≤≤°IDs & "," & Val(.TextMatrix(i, colº≤≤°ID))
                If Val(.TextMatrix(i, col’Ô∂œID)) <> 0 Then str’Ô∂œIDs = str’Ô∂œIDs & "," & Val(.TextMatrix(i, col’Ô∂œID))
            End If
        Next
    End With
        
    '-----------------------------------------------------
    With vsAdvice
        For i = .FixedRows To .Rows - 1
            bln≈‰∑Ω–– = False: blnºÏ—È–– = False
            '±æ¥Œ–¬‘ˆªÚ–ﬁ∏ƒ“©∆∑––µƒ¥¶∑Ω÷∞ŒÒºÏ≤È
            If .RowData(i) <> 0 And InStr(",5,6,7,", .TextMatrix(i, COL_¿‡±)) > 0 And InStr(",1,2,", .TextMatrix(i, COL_EDIT)) > 0 Then
                strMsg = CheckOneDuty(.TextMatrix(i, col_“Ω÷ˆƒ⁄»›), .TextMatrix(i, COL_¥¶∑Ω÷∞ŒÒ), .TextMatrix(i, COL_ø™÷ˆ“Ω…˙), InStr(",1,2,", mstr∏∂øÓ¬Î) > 0 And mstr∏∂øÓ¬Î <> "")
                If strMsg <> "" Then
                    .Col = col_“Ω÷ˆƒ⁄»›
                    If .TextMatrix(i, COL_¿‡±) = "7" Then
                        lngRow = .FindRow(CLng(.TextMatrix(i, COL_œ‡πÿID)), i + 1)
                        If lngRow <> -1 Then .Row = lngRow
                    Else
                        .Row = i
                    End If
                    Call .ShowCell(.Row, .Col)
                    MsgBox strMsg, vbInformation, gstrSysName
                    .Refresh
                    Call vsAdvice_KeyPress(13)
                    Exit Function
                End If
                
                'øπæ˙”√“©ºÏ≤È
                If gblnKSSStrict Then
                    If Val(.TextMatrix(i, COL_øπæ˙µ»º∂)) > 0 Then
                        If Val(.TextMatrix(i, COL_”√“©ƒøµƒ)) = 0 Then
                            strMsg = ",øπæ˙”√“©“™«Ûµ«º«”√“©ƒøµƒ°£"
                            .Col = COL_”√“©ƒøµƒ: Exit For
                        End If
                        
                        If Val(.TextMatrix(i, COL_øπæ˙µ»º∂)) = 3 And mbytPatiType <> 2 Then
                            strMsg = ",√≈’Ô∑«º±’Ôπ“∫≈≤ªƒ‹ π”√Ãÿ ‚ π”√º∂µƒøπæ˙“©ŒÔ°£"
                            .Col = col_“Ω÷ˆƒ⁄»›: Exit For
                        End If
                        
                        '»Áπ˚≤Ÿ◊˜‘±√ª”–øπæ˙”√“©¥¶∑Ω»®£¨‘ÚΩ˚÷π±£¥Ê
                        If UserInfo.”√“©º∂± = 0 Then
                            strMsg = ",ƒ˙√ª”–øπæ˙”√“©»®œﬁ£¨«Î¡™œµπ‹¿Ì‘±°£"
                            .Col = col_“Ω÷ˆƒ⁄»›: Exit For
                        End If
                        
                        If Val(.TextMatrix(i, COL_EDIT)) = 2 Then
                            If UserInfo.”√“©º∂± < Val(.TextMatrix(i, COL_øπæ˙µ»º∂)) And Val(.TextMatrix(i, COL_±Í÷æ)) <> 1 Then
                                .TextMatrix(i, COL_…Û∫À◊¥Ã¨) = 1
                            End If
                        End If
                        
                        '“ª◊È“©∆∑÷–£¨÷ª“™”–“ª∏ˆŒ™¥˝…Û∫ÀªÚŒ¥…Û∫ÀÕ®π˝£¨‘Ú’˚◊È∏¸∏ƒ(√ª‘⁄ ‰»Î ±¥¶¿Ì£¨ «“ÚŒ™ø…ƒ‹∏¯“©Õææ∂ «∫Û–¯≤≈º”…œµƒ£¨¥¶¿Ìµƒµ„Ωœ∂‡)
                        If Val(.TextMatrix(i, COL_…Û∫À◊¥Ã¨)) > 0 Then
                            Call GetRowScope(i, lngBegin, lngEnd)
                            For j = lngBegin To lngEnd
                                If j <> i Then
                                    .TextMatrix(j, COL_…Û∫À◊¥Ã¨) = .TextMatrix(i, COL_…Û∫À◊¥Ã¨)
                                End If
                            Next
                        End If
                        
                        
                        'ΩÙº±“Ω÷ˆºÏ≤È
                        If Val(.TextMatrix(i, COL_±Í÷æ)) = 1 Then
                            If .TextMatrix(i, COL_”√“©¿Ì”…) = "" Then
                                strMsg = ",ΩÙº± π”√µƒøπæ˙”√“©“™«Û ‰»Î”√“©¿Ì”…°£"
                                .Col = COL_”√“©¿Ì”…: Exit For
                            End If
                            If Val(.TextMatrix(i, COL_ÃÏ ˝)) > 1 Then
                                strMsg = ",ΩÙº± π”√µƒøπæ˙”√“©“™«ÛΩˆœﬁ“ªÃÏ°£"
                                .Col = COL_ÃÏ ˝: Exit For
                            ElseIf Val(.TextMatrix(i, COL_ÃÏ ˝)) = 0 Then
                                'Œ¥ ‰»ÎÃÏ ˝ ±Ω¯––∑¥À„ÃÏ ˝£∫◊‹¡ø/µ•¡ø/∆µ¬ 
                                If .TextMatrix(i, COL_º¡¡øœµ ˝) <> "" And .TextMatrix(i, COL_√≈’Ô∞¸◊∞) <> "" Then
                                    'º∆À„≥ˆ“ªÃÏµƒ◊‹¡ø
                                    dblOneDay = FormatEx(Calc»± °“©∆∑◊‹¡ø( _
                                    Val(.TextMatrix(i, COL_µ•¡ø)), 1, _
                                    Val(.TextMatrix(i, COL_∆µ¬ ¥Œ ˝)), Val(.TextMatrix(i, COL_∆µ¬ º‰∏Ù)), _
                                    .TextMatrix(i, COL_º‰∏Ùµ•Œª), .TextMatrix(i, COL_÷¥–– ±º‰), _
                                    Val(.TextMatrix(i, COL_º¡¡øœµ ˝)), Val(.TextMatrix(i, COL_√≈’Ô∞¸◊∞)), _
                                    Val(.TextMatrix(i, COL_ø…∑Ò∑÷¡„))), 5)
                                    If Val(.TextMatrix(i, COL_◊‹¡ø)) > dblOneDay Then
                                        strMsg = ",ΩÙº± π”√µƒøπæ˙”√“©◊‹¡ø≥¨≥ˆ¡À“ªÃÏµƒ π”√¡ø£∫" & dblOneDay & "°£"
                                        .Col = COL_ÃÏ ˝: Exit For
                                    End If
                                End If
                            End If
                        End If
                    End If
                End If
            End If
            
            
            'µ˜”√◊‘∂®“Âµƒ“Ω÷ˆºÏ≤È∫Ø ˝
            If .RowData(i) <> 0 And InStr(",1,2,", .TextMatrix(i, COL_EDIT)) > 0 And Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID)) <> 0 Then
                
                strExtra = CStr(.Cell(flexcpData, i, COL_“Ω…˙÷ˆÕ–))
                lng¬È◊Ì’Ô¡∆ID = 0
                lng∏¯“©÷¥–––‘÷  = 0
                str≤øŒª∑Ω∑® = ""
                If .TextMatrix(i, COL_¿‡±) = "F" Then
                    lng÷˜ID = Val(.TextMatrix(i, COL_œ‡πÿID))
                    If lng÷˜ID = 0 Then lng÷˜ID = .RowData(i)
                    For k = i + 1 To .Rows - 1
                        If Val(.TextMatrix(k, COL_œ‡πÿID)) <> lng÷˜ID Then Exit For
                        If .TextMatrix(k, COL_¿‡±) = "G" Then
                            lng¬È◊Ì’Ô¡∆ID = .TextMatrix(k, COL_’Ô¡∆œÓƒøID)
                        End If
                    Next
                ElseIf InStr("4,5,6,7", .TextMatrix(i, COL_¿‡±)) > 0 Then
                    k = .FindRow(CLng(Val(.TextMatrix(i, COL_œ‡πÿID))), i + 1)
                    If k > 0 Then lng∏¯“©÷¥–––‘÷  = Val(.TextMatrix(k, COL_÷¥–––‘÷ ))
                
                ElseIf .TextMatrix(i, COL_¿‡±) = "D" And Val(.TextMatrix(i, COL_œ‡πÿID)) = 0 Then
                    lng÷˜ID = .RowData(i)
                    For k = i + 1 To .Rows - 1
                        If Val(.TextMatrix(k, COL_œ‡πÿID)) <> lng÷˜ID Then Exit For
                        str≤øŒª∑Ω∑® = str≤øŒª∑Ω∑® & "," & .TextMatrix(k, COL_±Í±æ≤øŒª) & ":" & .TextMatrix(k, COL_ºÏ≤È∑Ω∑®)
                    Next
                    str≤øŒª∑Ω∑® = Mid(str≤øŒª∑Ω∑®, 2)
                End If
                
                strExtra = strExtra & "||" & lng∏¯“©÷¥–––‘÷  & "||" & lng¬È◊Ì’Ô¡∆ID & "||" & IIF(str≤øŒª∑Ω∑® = "", " ", str≤øŒª∑Ω∑®) & "||" & Val(.TextMatrix(i, COL_ ’∑—œ∏ƒøID))
                
                strSQL = "Select zl_AdviceCheck([1],[2],[3],[4],[5],[6],[7],[8],[9],[10],[11],[12],[13],[14]) as Ω·π˚ From Dual"
                Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, "zl_AdviceCheck", 1, mlng≤°»ÀID, mlngπ“∫≈ID, mintœ’¿‡, 1, _
                     .TextMatrix(i, COL_¿‡±), Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID)), _
                    Val(.TextMatrix(i, COL_ø™÷ˆø∆ “ID)), CStr(.TextMatrix(i, COL_ø™÷ˆ“Ω…˙)), _
                    Val(.TextMatrix(i, COL_÷¥––ø∆ “ID)), Val(.TextMatrix(i, COL_÷¥–––‘÷ )), Val(.TextMatrix(i, COL_÷¥––±Íº«)), _
                    Val(.TextMatrix(i, COL_µ•¡ø)), strExtra)
                
                If Not rsTmp.EOF Then
                    strMsg = Nvl(rsTmp!Ω·π˚)
                    If strMsg <> "" Then
                        Select Case Val(Split(strMsg, "|")(0))
                        Case 1 'Ã· æ
                            If MsgBox(Split(strMsg, "|")(1), vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbNo Then
                                strMsg = "": Exit For
                            End If
                        Case 2 'Ω˚÷π
                            MsgBox Split(strMsg, "|")(1), vbInformation, gstrSysName
                            strMsg = "": Exit For
                        End Select
                        strMsg = ""
                    End If
                End If
            End If
            
            '∆‰À¸ ‰»Î∫œ∑®–‘ºÏ≤È
            If .RowData(i) <> 0 Then
            
                '”––‘±œﬁ÷∆œÓƒøµƒºÏ≤È£®÷ª’Î∂‘£∫ºÏ—È°¢ºÏ≤È°¢ ÷ ı£©
                If InStr(",C,D,F,5,6,7,", .TextMatrix(i, COL_¿‡±)) > 0 And InStr(",1,2,", .TextMatrix(i, COL_EDIT)) > 0 And (mstr–‘± = "ƒ–" Or mstr–‘± = "≈Æ") And Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID)) <> 0 Then
                    If .TextMatrix(i, COL_¿‡±) = "F" Or .TextMatrix(i, COL_¿‡±) = "D" And Not .RowHidden(i) Or .TextMatrix(i, COL_¿‡±) = "C" And .RowHidden(i) Or InStr(",5,6,7,", .TextMatrix(i, COL_¿‡±)) > 0 Then
                        strSQL = "Select Decode(a.  ”√–‘±, 1, 'ƒ–', 2, '≈Æ', 'Œ¥÷™') As –‘± From ’Ô¡∆œÓƒøƒø¬º A Where a.Id = [1]"
                        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID)))
                        
                        If rsTmp!–‘± <> mstr–‘± And rsTmp!–‘± <> "Œ¥÷™" Then
                            If .TextMatrix(i, COL_¿‡±) = "D" Then
                                strMsg = " ÷ ı£¨∂‘–‘±""" & mstr–‘± & """≤ª  ”√°£"
                            Else
                                strMsg = Decode(.TextMatrix(i, COL_¿‡±), "C", "ºÏ—ÈœÓƒø", "F", "∏Ωº” ÷ ı", "D", "ºÏ≤ÈœÓƒø", "“©∆∑") & "£¨∂‘–‘±""" & mstr–‘± & """≤ª  ”√°£"
                            End If
                            .Col = col_“Ω÷ˆƒ⁄»›: Exit For
                        End If
                    End If
                End If
                
                If .RowHidden(i) Then
                    
                    '±æ¥Œ–¬‘ˆªÚ–ﬁ∏ƒµƒ––
                    '---------------------------------------------------
                    If InStr(",1,2,", .TextMatrix(i, COL_EDIT)) > 0 Then
                        If Not Checkµ•∂¿”¶”√(i, strMsg) Then Exit For
                        'ºÏ≤È÷¥––ø∆ “
                        If Val(.TextMatrix(i, COL_÷¥––ø∆ “ID)) = 0 And InStr(",0,5,", Val(.TextMatrix(i, COL_÷¥–––‘÷ ))) = 0 Then
                            strMsg = "√ª”–»∑∂®÷¥––ø∆ “°£"
                            .Col = COL_÷¥––ø∆ “ID: Exit For
                        End If
                    
                        If .TextMatrix(i, COL_¿‡±) = "D" And .TextMatrix(i, COL_±Í±æ≤øŒª) <> "" Then
                            If CheckºÏ≤È≤øŒªEnable(.TextMatrix(i, COL_’Ô¡∆œÓƒøID), .TextMatrix(i, COL_±Í±æ≤øŒª), mstr–‘±, .TextMatrix(i, COL_ºÏ≤È∑Ω∑®), blnExists) = False Then
                                If blnExists = True Then
                                    strMsg = "÷–µƒ≤øŒª£∫" & .TextMatrix(i, COL_±Í±æ≤øŒª) & "£¨∂‘–‘±""" & mstr–‘± & """≤ª  ”√°£"
                                Else
                                    Call cmdExt_Click
                                End If
                                .Col = col_“Ω÷ˆƒ⁄»›: Exit For
                            End If
                        End If
                    End If
                Else
                    bln≈‰∑Ω–– = RowIn≈‰∑Ω––(i)
                    blnºÏ—È–– = RowInºÏ—È––(i)
                    lngRow = i
                    If bln≈‰∑Ω–– Then 'µ√µΩ≈‰∑Ωµƒµ⁄“ª“©∆∑––
                        lngRow = .FindRow(CStr(.RowData(i)), , COL_œ‡πÿID)
                        '◊‘±∏“©≤ªºÏ≤È“©∑ø
                        If Not (Val(.TextMatrix(lngRow, COL_÷¥–––‘÷ )) = 5 And Val(.TextMatrix(i, COL_÷¥–––‘÷ )) <> 5) And InStr(",1,2,", .TextMatrix(i, COL_EDIT)) > 0 Then
                            
                            str÷–“©√˚ = ""
                            If Check÷–“©¥Ê¥¢ø‚∑ø(lngRow, i, str÷–“©√˚, vsAdvice, 1, mlng≤°»Àø∆ “id, COL_¿‡±, col_“Ω÷ˆƒ⁄»›, COL_ ’∑—œ∏ƒøID, COL_÷¥––ø∆ “ID) = False Then
                                strMsg = "÷–µƒ[" & str÷–“©√˚ & "]√ª”–¥Ê¥¢‘⁄µ±«∞—°‘Òµƒ“©∑ø£¨ªÚ∏√“©∑ø≤ª «∑˛ŒÒ”⁄µ±«∞≤°»Àø∆ “µƒ£¨≤ªƒ‹ π”√∏√“©∆∑°£"
                                Exit For
                            End If
                        End If
                    ElseIf blnºÏ—È–– Then 'µ√µΩºÏ—È“Ω÷ˆ––
                        lngRow = .FindRow(CStr(.RowData(i)), , COL_œ‡πÿID)
                    End If
                    
                    'Œ¥∑¢ÀÕµƒ“Ω÷ˆ––
                    '------------------------------------
                    If Val(.TextMatrix(i, COL_◊¥Ã¨)) = 1 Then
                        lngCount = lngCount + 1
                        
                        '±ÿ–Î¬º»Îµ•¡ø:¡Ÿ÷ˆ:≥…“©ªÚø…—°‘Ò∆µ¬ µƒº∆ ±,º∆¡øœÓƒøø…“‘¬º»Î(“≤ø…≤ª¬º)
                        If (Val(.TextMatrix(lngRow, COL_∆µ¬ –‘÷ )) = 0 And InStr(",1,2,", Val(.TextMatrix(lngRow, COL_º∆À„∑Ω Ω))) > 0) _
                            Or InStr(",5,6,", .TextMatrix(lngRow, COL_¿‡±)) > 0 Then
                            '“©∆∑±ÿ–Î¬º»Îµ•¡ø
                            If .TextMatrix(lngRow, COL_µ•¡ø) <> "" Or mblnµ•¡ø And InStr(",5,6,", .TextMatrix(lngRow, COL_¿‡±)) > 0 Then
                                If Not IsNumeric(.TextMatrix(lngRow, COL_µ•¡ø)) Or Val(.TextMatrix(lngRow, COL_µ•¡ø)) <= 0 Then
                                    strMsg = "√ª”–¬º»Î’˝»∑µƒµ•¥Œ”√¡ø°£"
                                    .Col = COL_µ•¡ø: Exit For
                                End If
                            End If
                        End If
                        
                        '±ÿ–Î¬º»ÎÃÏ ˝£∫∂‘¡Ÿ÷ˆ“©∆∑£¨»Áπ˚÷∏∂®¡À“™¬º»Î
                        If mblnÃÏ ˝ And InStr(",5,6,", .TextMatrix(i, COL_¿‡±)) > 0 Then
                            If Val(.TextMatrix(i, COL_ÃÏ ˝)) <= 0 Then
                                strMsg = "«Î¬º»Î’˝»∑µƒ”√“©ÃÏ ˝°£"
                                .Col = COL_ÃÏ ˝: Exit For
                            End If
                        End If
                        
                        '±ÿ–Î¬º»Î◊‹¡ø:≈‰∑Ω,¡Ÿ÷ˆ(“©∆∑ªÚ∆‰À¸)
                        If Not IsNumeric(.TextMatrix(i, COL_◊‹¡ø)) Or Val(.TextMatrix(i, COL_◊‹¡ø)) <= 0 Then
                            ' ‰—™“Ω÷ˆ‘ –Ì≤ª ‰»Î◊‹¡ø
                            If Not (.TextMatrix(i, COL_¿‡±) = "K" And .TextMatrix(i, COL_◊‹¡ø) = "") Then
                                If bln≈‰∑Ω–– Then
                                    strMsg = "√ª”–¬º»Î’˝»∑µƒ÷–“©≈‰∑Ω∏∂ ˝°£"
                                ElseIf InStr(",5,6,", .TextMatrix(i, COL_¿‡±)) > 0 Then
                                    strMsg = "√ª”–¬º»Î’˝»∑µƒ“©∆∑◊‹∏¯”Ë¡ø°£"
                                Else
                                    strMsg = "√ª”–¬º»Î’˝»∑µƒ◊‹¡ø°£"
                                End If
                                .Col = COL_◊‹¡ø: Exit For
                            End If
                        End If
                                            
                        '±ÿ–Î¬º»Î∆µ¬ :¡Ÿ÷ˆ“≤“™ºÏ≤È,”√”⁄÷∏µº π”√,ø…“‘≤ª¬º»Î÷¥–– ±º‰
                        If Val(.TextMatrix(lngRow, COL_∆µ¬ –‘÷ )) = 0 Or InStr(",5,6,", .TextMatrix(lngRow, COL_¿‡±)) > 0 Or bln≈‰∑Ω–– Then
                            If .TextMatrix(lngRow, COL_∆µ¬ ) = "" Then
                                strMsg = "√ª”–»∑∂®÷¥––∆µ¬ °£"
                                .Col = COL_∆µ¬ : Exit For
                            End If
                            
                            '÷¥–– ±º‰≈–∂œ:ø…—°∆µ¬ µƒ±ÿ–Î ‰»Î(∂‘¡Ÿ÷ˆΩ´¿¥ø…ƒ‹‘ –Ì≤ª¬º»Î,“™◊¢“‚∑¢ÀÕµ»µÿ∑Ωµƒ¥¶¿Ì)
                            If .TextMatrix(lngRow, COL_÷¥–– ±º‰) = "" And .TextMatrix(lngRow, COL_º‰∏Ùµ•Œª) <> "∑÷÷”" And .TextMatrix(lngRow, COL_∆µ¬ ) <> "±ÿ“™ ±" And .TextMatrix(lngRow, COL_∆µ¬ ) <> "–Ë“™ ±" Then
                                If Not blnºÏ—È–– Then 'ºÏ—È◊È∫œœ‘ æ––µƒ≤…ºØ∑Ω∑®Œ™ø…—°∆µ¬ ,µ´ºÏ—ÈœÓƒøŒ™“ª¥Œ–‘
                                    If Val(.TextMatrix(lngRow, COL_∆µ¬ –‘÷ )) <> 1 Then
                                        strMsg = "√ª”–¬º»Î÷¥–– ±º‰∑Ω∞∏°£"
                                        .Col = COL_÷¥–– ±º‰: Exit For
                                    End If
                                End If
                            End If
                        End If
                        
                        '±ÿ–Î¬º»Î÷¥––ø∆ “:∑«∂£÷ˆ∫Õ‘∫Õ‚÷¥–– ±(≈‰∑Ω“‘“©∆∑––Ω¯––≈–∂œ)
                        If Val(.TextMatrix(lngRow, COL_÷¥––ø∆ “ID)) = 0 Then
                            If .TextMatrix(lngRow, COL_¿‡±) = "Z" And InStr(",1,2,", Val(.TextMatrix(lngRow, COL_≤Ÿ◊˜¿‡–Õ))) > 0 Then
                                If Val(.TextMatrix(lngRow, COL_≤Ÿ◊˜¿‡–Õ)) = 1 Then
                                    strMsg = "√ª”–»∑∂®¡Ùπ€“Ω÷ˆµƒ¡Ùπ€ø∆ “°£"
                                ElseIf Val(.TextMatrix(lngRow, COL_≤Ÿ◊˜¿‡–Õ)) = 2 Then
                                    strMsg = "√ª”–»∑∂®◊°‘∫“Ω÷ˆµƒ◊°‘∫ø∆ “°£"
                                End If
                                .Col = COL_÷¥––ø∆ “ID: Exit For
                            ElseIf InStr(",0,5,", Val(.TextMatrix(lngRow, COL_÷¥–––‘÷ ))) = 0 Then
                                strMsg = "√ª”–»∑∂®÷¥––ø∆ “°£"
                                .Col = COL_÷¥––ø∆ “ID: Exit For
                            End If
                        End If
                        If lngRow <> i And Val(.TextMatrix(i, COL_÷¥––ø∆ “ID)) = 0 Then
                            If InStr(",0,5,", Val(.TextMatrix(i, COL_÷¥–––‘÷ ))) = 0 Then
                                strMsg = "√ª”–»∑∂®÷¥––ø∆ “°£"
                                .Col = COL_÷¥––ø∆ “ID: Exit For
                            End If
                        End If
                        
                        'ø™÷ˆ ±º‰≈–∂œ
                        If Not Checkø™÷ˆ ±º‰(.Cell(flexcpData, i, COL_ø™÷ˆ ±º‰), .Cell(flexcpData, i, COL_ø™ º ±º‰), False, strMsg) Then
                            .Col = COL_ø™÷ˆ ±º‰: Exit For
                        End If
                        
                        '¥¶∑ΩÃı ˝œﬁ÷∆ºÏ≤È
                        If gintRXCount > 0 And InStr(",5,6,", .TextMatrix(i, COL_¿‡±)) > 0 _
                            And Val(.TextMatrix(i, COL_œ‡πÿID)) <> Val(.TextMatrix(i - 1, COL_œ‡πÿID)) Then
                            lngRxCount = GetMergeCount(vsAdvice, i, COL_œ‡πÿID, COL_ ’∑—œ∏ƒøID)
                            If lngRxCount > gintRXCount Then
                                strMsg = "“ª≤¢∏¯“©µƒ“©∆∑÷÷ ˝ " & lngRxCount & " ÷÷“—¥ÔµΩªÚ≥¨π˝“©∆∑¥¶∑Ω◊Ó∂‡‘ –Ìµƒ÷÷ ˝ " & gintRXCount & " ÷÷°£"
                                .Col = col_“Ω÷ˆƒ⁄»›: Exit For
                            End If
                        End If
                    End If
                    
                    '±æ¥Œ–¬‘ˆªÚ–ﬁ∏ƒµƒ––
                    '---------------------------------------------------
                    If InStr(",1,2,", .TextMatrix(i, COL_EDIT)) > 0 Then
                        If Not Checkµ•∂¿”¶”√(i, strMsg) Then Exit For
                        'ø™ º ±º‰≈–∂œ:÷ª∂‘–¬‘ˆµƒ“Ω÷ˆΩ¯––≈–∂œ,“ÚŒ™∑Ò‘Ú «≤ª◊º–ﬁ∏ƒø™ º ±º‰µƒ(≤ª∫√≈–∂œ±ª–ﬁ∏ƒµƒ“Ω÷ˆø™ º ±º‰µƒœ‡∂‘”––ß–‘)
                        If .TextMatrix(i, COL_EDIT) = "1" Then
                            If Not Checkø™ º ±º‰(.Cell(flexcpData, i, COL_ø™ º ±º‰), False, strMsg) Then
                                .Col = COL_ø™ º ±º‰: Exit For
                            End If
                        End If
                        ' ÷ ı/ ‰—™“Ω÷ˆµƒ ÷ ı/ ‰—™ ±º‰≈–∂œ
                        If .TextMatrix(i, COL_¿‡±) = "F" Or .TextMatrix(i, COL_¿‡±) = "K" Then
                            If Not Check∞≤≈≈ ±º‰(.TextMatrix(i, COL_ ÷ ı ±º‰), .Cell(flexcpData, i, COL_ø™ º ±º‰), .TextMatrix(.Row, COL_¿‡±), False, strMsg) Then
                                .Col = COL_ ÷ ı ±º‰: Exit For
                            End If
                            If .TextMatrix(i, COL_¿‡±) = "K" Then
                                '÷ª”–ΩÙº±“Ω÷ˆ±£¥Ê ‰—™‘≠“Ú
                                If .TextMatrix(i, COL_”√“©¿Ì”…) <> "" And .TextMatrix(i, COL_±Í÷æ) <> "1" Then
                                    .TextMatrix(i, COL_”√“©¿Ì”…) = ""
                                Else
                                    If gbln ‰—™∑÷º∂π‹¿Ì And .TextMatrix(i, COL_±Í÷æ) = "1" And .TextMatrix(i, COL_”√“©¿Ì”…) = "" Then
                                        strMsg = "∆Ù”√¡À ‰—™∑÷º∂π‹¿Ì∫Û£¨ΩÙº± ‰—™“Ω÷ˆ±ÿ–ÎÃÓ–¥ ‰—™‘≠“Ú°£"
                                        .Col = COL_”√“©¿Ì”…: Exit For
                                    End If
                                End If
                            End If
                        End If
                        
                        '∏¯“©Õææ∂£¨÷–“©”√∑®£¨≤…ºØ∑Ω∑®…Ë÷√ºÏ≤È
                        If InStr(",5,6,", .TextMatrix(i, COL_¿‡±)) > 0 Then
                            If Val(.TextMatrix(i, COL_œ‡πÿID)) = .RowData(i + 1) And Val(.TextMatrix(i + 1, COL_’Ô¡∆œÓƒøID)) = 0 Then
                                strMsg = "√ª”–…Ë÷√∂‘”¶µƒ∏¯“©Õææ∂°£"
                                .Col = COL_”√∑®: Exit For
                            End If
                        End If
                        If .TextMatrix(i, COL_¿‡±) = "E" And Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID)) = 0 Then
                            If .RowData(i) = Val(.TextMatrix(i - 1, COL_œ‡πÿID)) Then
                                If InStr(",7,E,", .TextMatrix(i - 1, COL_¿‡±)) > 0 Then
                                    strMsg = "÷–“©≈‰∑Ω√ª”–…Ë÷√∂‘”¶µƒ”√∑®°£"
                                ElseIf .TextMatrix(i - 1, COL_¿‡±) = "C" Then
                                    strMsg = "√ª”–…Ë÷√∂‘”¶µƒ±Í±æ≤…ºØ∑Ω∑®°£"
                                End If
                                .Col = COL_”√∑®: Exit For
                            End If
                        End If
                                                
                        '◊Ó…Ÿ◊‹¡øºÏ≤È:÷¡…Ÿ“™¬˙◊„“ª∏ˆ∆µ¥Œ÷‹∆⁄µƒ”√¡ø
                        If InStr(",4,5,6,", .TextMatrix(i, COL_¿‡±)) > 0 Or bln≈‰∑Ω–– Then
                            If Not blnSkipTotal And .TextMatrix(i, COL_∆µ¬ ) <> "" And Val(.TextMatrix(i, COL_∆µ¬ ¥Œ ˝)) <> 0 And Val(.TextMatrix(i, COL_∆µ¬ º‰∏Ù)) <> 0 Then
                                strMsg = ""
                                If bln≈‰∑Ω–– Then '≈–∂œ
                                    dbl◊‹¡ø = Calc»± °“©∆∑◊‹¡ø(1, 1, Val(.TextMatrix(i, COL_∆µ¬ ¥Œ ˝)), Val(.TextMatrix(i, COL_∆µ¬ º‰∏Ù)), .TextMatrix(i, COL_º‰∏Ùµ•Œª))
                                    If Val(.TextMatrix(i, COL_◊‹¡ø)) < dbl◊‹¡ø Then
                                        strMsg = .TextMatrix(i, col_“Ω÷ˆƒ⁄»›) & vbCrLf & vbCrLf & _
                                            "‘⁄∞¥""" & .TextMatrix(i, COL_∆µ¬ ) & """÷¥–– ±,÷¡…Ÿ–Ë“™ " & dbl◊‹¡ø & "∏∂°£"
                                    End If
                                ElseIf Val(.TextMatrix(i, COL_º¡¡øœµ ˝)) <> 0 And Val(.TextMatrix(i, COL_µ•¡ø)) <> 0 Then
                                    sngÃÏ ˝ = Val(.TextMatrix(i, COL_ÃÏ ˝))
                                    If sngÃÏ ˝ = 0 Then sngÃÏ ˝ = 1
                                    dbl◊‹¡ø = Calc»± °“©∆∑◊‹¡ø(Val(.TextMatrix(i, COL_µ•¡ø)), sngÃÏ ˝, Val(.TextMatrix(i, COL_∆µ¬ ¥Œ ˝)), Val(.TextMatrix(i, COL_∆µ¬ º‰∏Ù)), .TextMatrix(i, COL_º‰∏Ùµ•Œª), .TextMatrix(i, COL_÷¥–– ±º‰), Val(.TextMatrix(i, COL_º¡¡øœµ ˝)), Val(.TextMatrix(i, COL_√≈’Ô∞¸◊∞)), Val(.TextMatrix(i, COL_ø…∑Ò∑÷¡„)))
                                    If Val(.TextMatrix(i, COL_◊‹¡ø)) < dbl◊‹¡ø Then
                                        strMsg = .TextMatrix(i, col_“Ω÷ˆƒ⁄»›) & vbCrLf & vbCrLf & _
                                            "‘⁄∞¥√ø¥Œ " & .TextMatrix(i, COL_µ•¡ø) & .TextMatrix(i, COL_µ•¡øµ•Œª) & "," & _
                                            .TextMatrix(i, COL_∆µ¬ ) & IIF(mblnÃÏ ˝ And .TextMatrix(i, COL_¿‡±) <> "4", ",”√“© " & sngÃÏ ˝ & " ÃÏ", "") & _
                                            "÷¥–– ±,÷¡…Ÿ–Ë“™ " & dbl◊‹¡ø & .TextMatrix(i, COL_◊‹¡øµ•Œª) & "°£"
                                    End If
                                End If
                                If strMsg <> "" And False Then 'Ã· æ
                                    .Row = i: .Col = COL_◊‹¡ø: Call .ShowCell(.Row, .Col)
                                    vMsg = frmMsgBox.ShowMsgBox(strMsg & "^^“™ºÃ–¯¬£ø", Me)
                                    If vMsg = vbNo Or vMsg = vbCancel Then
                                        If txt◊‹¡ø.Enabled And txt◊‹¡ø.Visible Then txt◊‹¡ø.SetFocus
                                        Exit Function
                                    ElseIf vMsg = vbIgnore Then
                                        blnSkipTotal = True
                                    End If
                                End If
                            End If
                        End If
                            
                            'ºÏ≤È“©∆∑ «∑Ò≥¨¡ø∫Õ≥¨∆⁄£¨±È¿˙ ±”¶¥”µ⁄“ªÃı√ª”–ÃÓ–¥≥¨¡øÀµ√˜µƒ––ø™ º
                            If (gbyt≥¨¡ø‘≠“Ú = 1 And InStr(gstr≤ª¬º≥¨¡øø∆ “, "," & mlng≤°»Àø∆ “id & ",") = 0) And Not blnCheck≥¨¡ø _
                                And (.TextMatrix(i, COL_ «∑Ò≥¨¡ø) = "1" Or .TextMatrix(i, COL_ «∑Ò≥¨∆⁄) = "1") And .TextMatrix(i, COL_≥¨¡øÀµ√˜) = "" Then
                                blnCheck≥¨¡ø = SetAll≥¨¡øÀµ√˜(i, blnOut) '≥¨¡øµƒºÏ≤È÷ª“™’‚∏ˆ∑Ω∑®÷¥––¡À“ª¥ŒæÕÀ„ «À˘”–∂º“—æ≠ºÏ≤È¡À≤ª”√‘Ÿ±È¿˙¡À
                                If blnOut Then
                                    strMsg = "Not Null" '’‚¿Ô”¶∏√∏≥÷µ»∑±£ strMsg ≤ªŒ™ø’º¥ø…
                                    .Col = COL_≥¨¡øÀµ√˜: Exit For
                                End If
                            End If
                        
                        
                        '“©∆∑ø‚¥ÊºÏ≤È:÷ªÃ·–—,À˘“‘“≤÷ª∂‘±æ¥Œ±‡º≠µƒ≤≈≈–∂œ
                        If (InStr(",5,6,", .TextMatrix(i, COL_¿‡±)) > 0 Or bln≈‰∑Ω–– _
                            Or .TextMatrix(i, COL_¿‡±) = "4" And Val(.TextMatrix(i, COL_∏˙◊Ÿ‘⁄”√)) = 1) And Not blnSkipStock Then
                            strMsg = CheckStock(i)
                            If strMsg <> "" Then
                                .Row = i: .Col = col_“Ω÷ˆƒ⁄»›: Call .ShowCell(.Row, .Col)
                                vMsg = frmMsgBox.ShowMsgBox(strMsg & "^^“™ºÃ–¯¬£ø", Me)
                                If vMsg = vbNo Or vMsg = vbCancel Then
                                    Exit Function
                                ElseIf vMsg = vbIgnore Then
                                    blnSkipStock = True
                                End If
                            End If
                        End If
                        
                        '÷¥–– ±º‰∫œ∑®–‘ºÏ≤È
                        If .TextMatrix(i, COL_÷¥–– ±º‰) <> "" And .TextMatrix(i, COL_∆µ¬ ) <> "" Then
                            blnValid = ExeTimeValid(.TextMatrix(i, COL_÷¥–– ±º‰), Val(.TextMatrix(i, COL_∆µ¬ ¥Œ ˝)), Val(.TextMatrix(i, COL_∆µ¬ º‰∏Ù)), .TextMatrix(i, COL_º‰∏Ùµ•Œª))
                            If Not blnValid Then
                                If .TextMatrix(i, COL_º‰∏Ùµ•Œª) = "÷‹" Then
                                    strMsg = COL_∞¥÷‹÷¥––
                                ElseIf .TextMatrix(i, COL_º‰∏Ùµ•Œª) = "ÃÏ" Then
                                    strMsg = COL_∞¥ÃÏ÷¥––
                                ElseIf .TextMatrix(i, COL_º‰∏Ùµ•Œª) = "–° ±" Then
                                    strMsg = COL_∞¥ ±÷¥––
                                End If
                                strMsg = "¬º»Îµƒ÷¥–– ±º‰∑Ω∞∏∏Ò Ω≤ª’˝»∑£¨«ÎºÏ≤È°£" & vbCrLf & vbCrLf & "¿˝£∫" & vbCrLf & strMsg
                                .Col = COL_÷¥–– ±º‰: Exit For
                            End If
                        End If
                        
                        '“Ω±£∂‘¬ÎºÏ≤È:“‘“ª◊È“Ω±£µ⁄“ªø…º˚––Œ™◊º
                        If InStr(",5,6,", .TextMatrix(i, COL_¿‡±)) = 0 _
                            Or Val(.TextMatrix(i - 1, COL_œ‡πÿID)) <> Val(.TextMatrix(i, COL_œ‡πÿID)) Then
                            If gint“Ω±£∂‘¬Î = 2 Then mblnÃ·–—∂‘¬Î = True
                            Call GetInsureStr(strIDs1, strIDs2, str“Ω÷ˆƒ⁄»›, i)
                            strMsg = CheckAdviceInsure(mintœ’¿‡, mblnÃ·–—∂‘¬Î, mlng≤°»ÀID, 1, strIDs1, strIDs2, str“Ω÷ˆƒ⁄»›)
                            If strMsg <> "" Then
                                .Row = i: .Col = col_“Ω÷ˆƒ⁄»›: Call .ShowCell(.Row, .Col)
                                If gint“Ω±£∂‘¬Î = 1 Then
                                    vMsg = frmMsgBox.ShowMsgBox(strMsg & vbCrLf & vbCrLf & "“™ºÃ–¯±£¥Ê“Ω÷ˆ¬£ø", Me)
                                    If vMsg = vbNo Or vMsg = vbCancel Then Exit Function
                                    If vMsg = vbIgnore Then mblnÃ·–—∂‘¬Î = False
                                ElseIf gint“Ω±£∂‘¬Î = 2 Then
                                    MsgBox strMsg & vbCrLf & vbCrLf & "«Îœ»∫Õœ‡πÿ»À‘±¡™œµ¥¶¿Ì£¨∑Ò‘Ú“Ω÷ˆΩ´≤ª‘ –Ì±£¥Ê°£", vbInformation, gstrSysName
                                    Exit Function
                                End If
                                strMsg = "" '∑¿÷π∫Û√Ê‘Ÿ◊˜¥¶¿Ì
                            End If
                        End If
                        
                        '“Ω±£π‹øÿ µ ±º‡≤‚£∫ ◊¥Œ ‰»Î(æ≠π˝)ªÚ’ﬂ∏¸∏ƒ ±ºÏ≤È
                        If mintœ’¿‡ <> 0 And .Cell(flexcpData, i, COL_◊¥Ã¨) = 0 Then
                            If gclsInsure.GetCapability(support µ ±º‡øÿ, mlng≤°»ÀID, mintœ’¿‡) Then
                                If MakePriceRecord(i) Then
                                    If Not gclsInsure.CheckItem(mintœ’¿‡, 0, 0, mrsPrice) Then
                                        .Row = i: .Col = col_“Ω÷ˆƒ⁄»›
                                        Call .ShowCell(.Row, .Col)
                                        If txt◊‹¡ø.Enabled Then
                                            txt◊‹¡ø.SetFocus
                                        ElseIf txt“Ω÷ˆƒ⁄»›.Enabled Then
                                            txt“Ω÷ˆƒ⁄»›.SetFocus
                                        End If
                                        Exit Function
                                    End If
                                End If
                                '±Íº«Œ™“—æ≠◊˜¡ÀºÏ≤È
                                .Cell(flexcpData, .Row, COL_◊¥Ã¨) = 1
                            End If
                        End If
                    End If
                                    
                    '“Ω÷ˆ…Í«Î∏ΩœÓÃÓ–¥ºÏ≤È£∫
                    '÷ª’Î∂‘–¬¬º»Îµƒ“Ω÷ˆ£¨–ﬁ∏ƒµƒ“Ω÷ˆ–ﬁ∏ƒ ±“—ºÏ≤È
                    '".Cell(flexcpData, i, COL_∏ΩœÓ) = 1"µƒø…ƒ‹ªπ√ª”–‘⁄ ‰»Îπ˝≥Ã÷–ºÏ≤È£¨÷ª «◊‘∂ØÃÊªª¡À
                    If Val(.TextMatrix(i, COL_EDIT)) = 1 And .TextMatrix(i, COL_∏ΩœÓ) <> "" Then
                        strMsg = CheckAdviceAppend(.TextMatrix(i, COL_∏ΩœÓ))
                        If strMsg <> "" Then
                            strMsg = "…Í«Î∏ΩœÓ""" & strMsg & """√ª”–¬º»Î£¨«Î»∑»œœµÕ≥ƒ¨»œÃÓ–¥µƒ–≈œ¢ «∑Ò’˝»∑°£"
                            .Col = col_“Ω÷ˆƒ⁄»›: blnAppend = True: Exit For
                        End If
                    End If
                                    
                    'ª•≥‚ ˝æ› ’ºØ:‘⁄À˘”–”––ß“Ω÷ˆ÷–,“ÚŒ™ø…ƒ‹“—∑¢ÀÕµƒ”ÎŒ¥∑¢ÀÕµƒª•≥‚
                    If InStr(",5,6,", .TextMatrix(i, COL_¿‡±)) > 0 Then
                        '”√”⁄“©∆∑≈‰ŒÈΩ˚º…ºÏ≤È:≤ª∑÷∆⁄–ß
                        str“©∆∑IDs = str“©∆∑IDs & "," & Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID))
                    ElseIf Not bln≈‰∑Ω–– Then
                        '≤ªπ‹ºÏ≤È◊È∫œ”Î ÷ ı∏Ωº”ƒ⁄≤ø÷Æº‰º∞ƒ⁄≤ø”Î∆‰À¸œÓƒø÷Æº‰
                        str’Ô¡∆IDs = str’Ô¡∆IDs & "," & Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID))
                    End If
                End If
            End If
        Next
        
        '--------------------------------------------------------------------------
        '÷–º‰ÕÀ≥ˆµƒ¥ÌŒÛÃ· æ
        If i <= .Rows - 1 Then
            .Row = i: Call .ShowCell(.Row, .Col)
            If strMsg <> "" Then
                If bln≈‰∑Ω–– Then
                    strMsg = "∏√÷–“©≈‰∑Ω" & strMsg
                Else
                    strMsg = """" & .TextMatrix(i, col_“Ω÷ˆƒ⁄»›) & """" & strMsg
                End If
                If Not blnOut Then '≥¨¡øÀµ√˜Ã· æÃÿ ‚¥¶¿Ì
                    MsgBox strMsg, vbInformation, gstrSysName
                End If
                blnOut = False
                .Refresh
            End If
            Call vsAdvice_KeyPress(13)
            If blnAppend Then ' «∑ÒµØ≥ˆ…Í«Î∏ΩœÓ±‡º≠
                If cmdExt.Enabled And cmdExt.Visible Then Call cmdExt_Click
            End If
            Exit Function
        End If
        
        'ºÏ≤È“©∆∑≈‰ŒÈΩ˚º…
        If str“©∆∑IDs <> "" Then
            If Not Check≈‰ŒÈΩ˚º…(Mid(str“©∆∑IDs, 2)) Then Exit Function
        End If
        'ºÏ≤È’Ô¡∆œÓƒøª•≥‚
        If str’Ô¡∆IDs <> "" Then
            If Not Check’Ô¡∆ª•≥‚(Mid(str’Ô¡∆IDs, 2)) Then Exit Function
        End If
    End With
    
    '∑—”√±®æØ:”–Œ¥∑¢ÀÕ“Ω÷ˆ ±
    If lngCount > 0 Then
        If Not CheckMoney Then Exit Function
    End If
    '∏¥’Ô≤ªµØ≥ˆ¥´»æ≤°±®∏Êø®
    If Not mbln∏¥’Ô Then
        '∏˘æ›’Ô∂œ≈–∂œ «∑Ò”¶∏√ È–¥¥´»æ≤°±®∏Êø®
        RaiseEvent CheckInfectDisease(False, Mid(strº≤≤°IDs, 2), Mid(str’Ô∂œIDs, 2), blnNo)
    End If
        If blnNo Then Exit Function
    '--ºÏ≤È≤°»À «∑ÒÕÀ∫≈£¨ «∑Ò»°œ˚¡ÀΩ”’Ô
    If Not CheckBackNo(mstrπ“∫≈µ•) Then Exit Function
    
    CheckAdvice = True
    
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Function SeekNextControl() As Boolean
'π¶ƒ‹£∫∂®ŒªµΩœ¬“ª∏ˆΩπµ„µƒøÿº˛…œ,≤¢∏˘æ›«Èøˆæˆ∂® «∑Ò◊‘∂Ø–¬‘ˆ“ª––“Ω÷ˆ
'∑µªÿ£∫»Áπ˚Õ®π˝SetFocus«ø÷∆∂®Œªµƒ,‘Ú∑µªÿTrue
    Dim objActive As Object, objNext As Object
    Dim blnDo As Boolean, i As Long
    Dim strSkip As String
    
    Set objActive = Me.ActiveControl
    
    If Not objActive Is Nothing Then
        If TypeName(objActive) = "TextBox" Or TypeName(objActive) = "ComboBox" Then
            If objActive.Container Is fraAdvice Then
                strSkip = GetInputSkip(vsAdvice.Row)
                Set objNext = GetNextControl(objActive.TabIndex, Me, strSkip)
                If Not objNext Is Nothing Then
                    If objNext Is vsAdvice Then
                        For i = vsAdvice.Row + 1 To vsAdvice.Rows - 1
                            If Not vsAdvice.RowHidden(i) Then
                                Call AdviceChange '«ø÷∆∏¸–¬“Ω÷ˆƒ⁄»›
                                vsAdvice.Row = i
                                
                                'ø…ƒ‹“—‘⁄∆‰À˚ ¬º˛÷–±ª∂®Œª¡À£¨≤ª”√÷ÿ∏¥“∆∂Ø∂®Œª±Ì∏Ò
                                If Not Me.ActiveControl Is Nothing Then
                                    If Not Me.ActiveControl Is vsAdvice Then
                                        Call zlCommFun.PressKey(vbKeyTab)
                                    End If
                                End If
                                '±Ì∏Ò––Œﬁƒ⁄»›‘Ú‘Ÿ“∆∂Ø∂®ŒªµΩ“Ω÷ˆ ‰»ÎøÚ
                                blnDo = vsAdvice.RowData(i) <> 0
                                
                                Exit For
                            End If
                        Next
                        If i > vsAdvice.Rows - 1 Then
                            blnDo = True
                            cbsMain.FindControl(, conMenu_New, True, True).Execute
                        End If
                    ElseIf strSkip <> "" And InStr(";" & strSkip & ";", objNext.Name) = 0 Then
                        If objNext.Enabled And objNext.Visible Then
                            blnDo = True
                            objNext.SetFocus
                        End If
                    End If
                End If
            End If
        End If
    End If
    If Not blnDo Then
        Call zlCommFun.PressKey(vbKeyTab) '◊‘»ª∂®Œª
    Else
        SeekNextControl = True
    End If
End Function

Private Function GetInputSkip(ByVal lngRow As Long) As String
'π¶ƒ‹£∫ªÒ»° ‰»Î“Ω÷ˆπ˝≥Ã÷–£¨ªÿ≥µπ‚±Í”¶Ã¯π˝µƒøÿº˛
    Dim strSkip As String, lngFind As Long
    
    With vsAdvice
        '“ª≤¢∏¯“©÷–µƒ“©∆∑ ‰»Î ±”¶Ã¯π˝µƒƒ⁄»›
        If InStr(",5,6,", .TextMatrix(lngRow, COL_¿‡±)) > 0 And .RowData(lngRow) <> 0 Then
            If Val(.TextMatrix(lngRow, COL_œ‡πÿID)) = Val(.TextMatrix(lngRow - 1, COL_œ‡πÿID)) Then
                '∏¯“©Õææ∂,∏Ωº”÷¥––
                If Val(.TextMatrix(lngRow, COL_œ‡πÿID)) <> 0 Then
                    lngFind = .FindRow(CLng(.TextMatrix(lngRow, COL_œ‡πÿID)), lngRow + 1)
                    If lngFind <> -1 Then
                        If Val(.TextMatrix(lngFind, COL_’Ô¡∆œÓƒøID)) <> 0 Then
                            strSkip = strSkip & ";" & Me.txt”√∑®.Name
                        End If
                        If Val(.TextMatrix(lngFind, COL_÷¥––ø∆ “ID)) <> 0 Then
                            strSkip = strSkip & ";" & Me.cbo∏Ωº”÷¥––.Name
                        End If
                    End If
                End If
                '∆µ¬ 
                If .TextMatrix(lngRow, COL_∆µ¬ ) <> "" Then strSkip = strSkip & ";" & Me.txt∆µ¬ .Name
                '÷¥–– ±º‰
                If .TextMatrix(lngRow, COL_÷¥–– ±º‰) <> "" Then strSkip = strSkip & ";" & Me.cbo÷¥–– ±º‰.Name
            End If
        ElseIf InStr(",C,D,F,G,Z", .TextMatrix(lngRow, COL_¿‡±)) > 0 And .RowData(lngRow) <> 0 And .TextMatrix(lngRow, COL_∆µ¬ ) = "“ª¥Œ–‘" Then
            strSkip = strSkip & ";" & Me.txt∆µ¬ .Name
        End If
    End With
    GetInputSkip = Mid(strSkip, 2)
End Function

Private Sub SetBabyVisible(ByVal lngø∆ “id As Long)
'π¶ƒ‹£∫∏˘æ›ø∆ “–‘÷ …Ë÷√”§∂˘“Ω÷ˆ «∑Òø…“‘—°‘Ò
'Àµ√˜£∫≤˙ø∆≤≈”–”§∂˘“Ω÷ˆ
    If DeptIsWoman(lngø∆ “id) Then
        lbl”§∂˘.Visible = True
        cbo”§∂˘.Visible = True
    Else
        Call zlControl.CboSetIndex(cbo”§∂˘.hWnd, 0)
        cbo”§∂˘.Tag = 0
        lbl”§∂˘.Visible = False
        cbo”§∂˘.Visible = False
    End If
End Sub

Private Sub CalcAdviceMoney()
'π¶ƒ‹£∫º∆À„–¬ø™“Ω÷ˆΩ∂Ó
'Àµ√˜£∫÷ªπ‹µ±«∞œ‘ æ≥ˆµƒ≤ø∑›–¬ø™“Ω÷ˆ
    Dim dblMoney As Double, i As Long
    
    With vsAdvice
        For i = .FixedRows To .Rows - 1
            If Not .RowHidden(i) And Val(.TextMatrix(i, COL_◊¥Ã¨)) = 1 Then
                dblMoney = dblMoney + Format(CCur(Val(.TextMatrix(i, COL_◊‹¡ø)) * Val(.TextMatrix(i, COL_µ•º€))), gstrDec)
            End If
        Next
        stbThis.Panels(5).Text = "–¬ø™:" & FormatEx(dblMoney, 5) & "‘™"
    End With
End Sub

Private Sub AdviceSign()
'π¶ƒ‹£∫∂‘“Ω÷ˆΩ¯––µÁ◊”«©√˚
    Dim strSQL As String, strIDs As String, i As Long
    Dim strSource As String, strSign As String
    Dim lng«©√˚id As Long, lng÷§ ÈID As Long
    Dim intRule As Integer, strTimeStamp As String, strTimeStampCode As String
    Dim ColIDs As Collection, ColSource As Collection
    
    If gobjESign Is Nothing Then Exit Sub
    If gobjESign.CertificateStoped(UserInfo.–’√˚) Then
        MsgBox "ƒ˙µƒ«©√˚÷§ È“—±ªÕ£”√£¨«Î¡™œµ–≈œ¢ø∆°£", vbInformation, gstrSysName
        Exit Sub
    End If
    
    '◊‘∂Ø±£¥Ê
    If mblnNoSave Then
        If Not CheckAdvice Then Exit Sub
        If Not SaveAdvice Then vsAdvice.SetFocus: Exit Sub
    End If
    
    'ªÒ»°«©√˚“Ω÷ˆ‘¥Œƒ
    intRule = ReadAdviceSignSource(1, mlng≤°»ÀID, mstrπ“∫≈µ•, strIDs, 0, False, strSource, mstr«∞Ã·IDs, , ColIDs, ColSource)
    If intRule = 0 Then Exit Sub
    If strSource = "" Then
        MsgBox "∏√≤°»Àƒø«∞√ª”–ø…“‘«©√˚µƒ“Ω÷ˆ°£", vbInformation, gstrSysName
        Exit Sub
    End If
    
    For i = 1 To ColIDs.Count
        strSign = gobjESign.Signature(ColSource(i), gstrDBUser, lng÷§ ÈID, strTimeStamp, Nothing, strTimeStampCode)
        If strSign <> "" Then
            If strTimeStamp <> "" Then
                strTimeStamp = "To_Date('" & strTimeStamp & "','YYYY-MM-DD HH24:MI:SS')"
            Else
                strTimeStamp = "NULL"
            End If
            lng«©√˚id = zlDatabase.GetNextID("“Ω÷ˆ«©√˚º«¬º")
            strSQL = "zl_“Ω÷ˆ«©√˚º«¬º_Insert(" & lng«©√˚id & ",1," & intRule & ",'" & Replace(strSign, "'", "''") & "'," & lng÷§ ÈID & ",'" & ColIDs(i) & "'," & strTimeStamp & ",'" & UserInfo.–’√˚ & "','" & strTimeStampCode & "')"
            On Error GoTo errH
            Call zlDatabase.ExecuteProcedure(strSQL, Me.Caption)
            On Error GoTo 0
        End If
    Next
    If strSign <> "" Then
        '÷ÿ–¬∂¡»°œ‘ æ“Ω÷ˆ
        Call ReLoadAdvice(vsAdvice.RowData(vsAdvice.Row))
        mblnOK = True
        If txt“Ω÷ˆƒ⁄»›.Enabled Then
            txt“Ω÷ˆƒ⁄»›.SetFocus
        Else
            vsAdvice.SetFocus
        End If

        MsgBox "“—ÕÍ≥…µÁ◊”«©√˚°£", vbInformation, gstrSysName
    End If
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Function AdviceTextChange(ByVal lngRow As Long) As Boolean
'π¶ƒ‹£∫µ±“Ω÷ˆø®∆¨ ‰»Îƒ⁄»›±‰ªØ ±£¨≈–∂œ“Ω÷ˆƒ⁄»›Œƒ±æ «∑Ò”¶∏√÷ÿ–¬◊È÷Ø
    Dim str¿‡± As String, strText As String, blnDefine As Boolean
    
    With vsAdvice
        '»∑∂®“Ω÷ˆ¿‡±
        str¿‡± = .TextMatrix(lngRow, COL_¿‡±)
        If str¿‡± = "E" And Val(.TextMatrix(lngRow, COL_œ‡πÿID)) = 0 Then '÷–“©≈‰∑ΩªÚ“ª◊ÈºÏ—È
            lngRow = .FindRow(CStr(.RowData(lngRow)), , COL_œ‡πÿID)
            If lngRow <> -1 Then str¿‡± = .TextMatrix(lngRow, COL_¿‡±)
        End If
        If str¿‡± = "7" Then str¿‡± = "8"
                
        '»∑∂® «∑Ò∂®“Â
        blnDefine = Not mrsDefine Is Nothing And Not mobjVBA Is Nothing
        If blnDefine Then
            mrsDefine.Filter = "’Ô¡∆¿‡±='" & str¿‡± & "'"
            If mrsDefine.EOF Then
                blnDefine = False
            ElseIf Trim(Nvl(mrsDefine!“Ω÷ˆƒ⁄»›)) = "" Then
                blnDefine = False
            End If
        End If
        If blnDefine Then strText = mrsDefine!“Ω÷ˆƒ⁄»›
        
        'ºÏ≤Èƒ⁄»›±‰∂Ø
        If blnDefine Then 'π´π≤◊÷∂Œ≤ø∑›ªÚø…“‘π´π≤¥¶¿Ìµƒ≤ø∑›
            If IsDate(txtø™ º ±º‰.Text) And txtø™ º ±º‰.Tag <> "" And InStr(strText, "[ø™ º ±º‰]") > 0 Then
                AdviceTextChange = True: Exit Function
            End If
            If IsDate(txt∞≤≈≈ ±º‰.Text) And txt∞≤≈≈ ±º‰.Tag <> "" Then
                If InStr(strText, "[ ÷ ı ±º‰]") > 0 Or InStr(strText, "[ ‰—™ ±º‰]") > 0 Then
                    AdviceTextChange = True: Exit Function
                End If
            End If
            If cbo“Ω…˙÷ˆÕ–.Tag <> "" And InStr(strText, "[“Ω…˙÷ˆÕ–]") > 0 Then
                AdviceTextChange = True: Exit Function
            End If
            If cmd∆µ¬ .Tag <> "" And txt∆µ¬ .Tag <> "" Then
                If InStr(strText, "[÷–Œƒ∆µ¬ ]") > 0 Or InStr(strText, "[”¢Œƒ∆µ¬ ]") > 0 Then
                    AdviceTextChange = True: Exit Function
                End If
            End If
            If cbo÷¥–– ±º‰.Tag <> "" And InStr(strText, "[÷¥–– ±º‰]") > 0 Then
                AdviceTextChange = True: Exit Function
            End If
            If (IsNumeric(txtµ•¡ø.Text) Or txtµ•¡ø.Text = "") And txtµ•¡ø.Tag <> "" And InStr(strText, "[µ•¡ø]") > 0 Then
                AdviceTextChange = True: Exit Function
            End If
            If IsNumeric(txt◊‹¡ø.Text) And txt◊‹¡ø.Tag <> "" And InStr(strText, "[◊‹¡ø]") > 0 Then
                AdviceTextChange = True: Exit Function
            End If
        End If
        
        Select Case str¿‡± '≤ªÕ¨µƒ¿‡±ºÏ≤È
        Case "5", "6" '÷–Œ˜≥…“©
            If Not blnDefine Then
                
            Else
                '[ ‰»Î√˚][Õ®”√√˚][…Ã∆∑√˚][”¢Œƒ√˚][πÊ∏Ò][≤˙µÿ] « ‰»ÎªÚ–ﬁ∏ƒ’˚∏ˆ“©∆∑ ±±‰ªØ
                If Val(cmd”√∑®.Tag) <> 0 And txt”√∑®.Tag <> "" And InStr(strText, "[∏¯“©Õææ∂]") > 0 Then
                    AdviceTextChange = True: Exit Function
                End If
            End If
        Case "8" '÷–“©≈‰∑Ω
            If Not blnDefine Then
                If IsNumeric(txt◊‹¡ø.Text) And txt◊‹¡ø.Tag <> "" Then AdviceTextChange = True: Exit Function
                If cmd∆µ¬ .Tag <> "" And txt∆µ¬ .Tag <> "" Then AdviceTextChange = True: Exit Function
                If Val(cmd”√∑®.Tag) <> 0 And txt”√∑®.Tag <> "" Then AdviceTextChange = True: Exit Function
            Else
                '[≈‰∑Ω◊È≥…][ºÂ∑®] « ‰»ÎªÚ–ﬁ∏ƒ’˚∏ˆ≈‰∑Ω ±±‰ªØ
                If IsNumeric(txt◊‹¡ø.Text) And txt◊‹¡ø.Tag <> "" And InStr(strText, "[∏∂ ˝]") > 0 Then
                    AdviceTextChange = True: Exit Function
                End If
                If Val(cmd”√∑®.Tag) <> 0 And txt”√∑®.Tag <> "" And InStr(strText, "[”√∑®]") > 0 Then
                    AdviceTextChange = True: Exit Function
                End If
            End If
        Case "C" 'ºÏ—È
            If Not blnDefine Then
                If Val(cmd”√∑®.Tag) <> 0 And txt”√∑®.Tag <> "" Then AdviceTextChange = True: Exit Function
            Else
                '[ºÏ—ÈœÓƒø][ºÏ—È±Í±æ] « ‰»ÎªÚ–ﬁ∏ƒ’˚∏ˆœÓƒø ±±‰ªØ
                If Val(cmd”√∑®.Tag) <> 0 And txt”√∑®.Tag <> "" And InStr(strText, "[≤…ºØ∑Ω∑®]") > 0 Then
                    AdviceTextChange = True: Exit Function
                End If
            End If
        Case "D" 'ºÏ≤È
            If Not blnDefine Then
                
            Else
                '[ºÏ≤ÈœÓƒø][ºÏ≤È≤øŒª] « ‰»ÎªÚ–ﬁ∏ƒ’˚∏ˆœÓƒø ±±‰ªØ
            End If
        Case "F" ' ÷ ı
            If Not blnDefine Then
                If IsDate(txt∞≤≈≈ ±º‰.Text) And txt∞≤≈≈ ±º‰.Tag <> "" Then AdviceTextChange = True: Exit Function
                If IsDate(txtø™ º ±º‰.Text) And txtø™ º ±º‰.Tag <> "" Then AdviceTextChange = True: Exit Function
            Else
                '[÷˜“™ ÷ ı][∏Ωº” ÷ ı][¬È◊Ì∑Ω∑®] « ‰»ÎªÚ–ﬁ∏ƒ’˚∏ˆœÓƒø ±±‰ªØ
            End If
        Case "K" ' ‰—™
            If Not blnDefine Then
                If IsDate(txt∞≤≈≈ ±º‰.Text) And txt∞≤≈≈ ±º‰.Tag <> "" Then AdviceTextChange = True: Exit Function
                If Val(cmd”√∑®.Tag) <> 0 And txt”√∑®.Tag <> "" Then AdviceTextChange = True: Exit Function
            Else
                '[ ‰—™Õææ∂]
                If Val(cmd”√∑®.Tag) <> 0 And txt”√∑®.Tag <> "" And InStr(strText, "[ ‰—™Õææ∂]") > 0 Then
                    AdviceTextChange = True: Exit Function
                End If
            End If
        Case Else '∆‰À˚
            If Not blnDefine Then
                
            Else
                '[’Ô¡∆œÓƒø] « ‰»ÎªÚ–ﬁ∏ƒ’˚∏ˆœÓƒø ±±‰ªØ
            End If
        End Select
    End With
End Function

Private Function AdviceTextMake(ByVal lngRow As Long) As String
'π¶ƒ‹£∫ªÒ»°“Ω÷ˆƒ⁄»›Œƒ±æ
'≤Œ ˝£∫lngRow=“—”–“Ω÷ˆ ˝æ›µƒø…º˚––
    Dim rsTmp As New ADODB.Recordset
    Dim rsCard As New ADODB.Recordset
    Dim blnDefine As Boolean, str¿‡± As String
    Dim strText As String, strSQL As String
    Dim strField As String, int∆µ¬ ∑∂Œß As Integer
    Dim i As Long, k As Long
    Dim blnDo As Boolean
    Dim str÷–“©√˚≥∆ As String
    
    Dim str÷–“© As String, strºÂ∑® As String, str–ŒÃ¨ As String
    Dim str¬È◊Ì As String, str∏Ω ı As String
    Dim strºÏ—È As String, str±Í±æ As String
    Dim str≤øŒª As String, str≤øŒªLast As String, str∑Ω∑® As String
    Dim dbl ˝¡ø As Double
    Dim str÷–“©’Ô¡∆œÓƒøIDS As String, strSame As String
    
    On Error GoTo errH
    
    With vsAdvice
        '»∑∂®“Ω÷ˆ¿‡±
        str¿‡± = .TextMatrix(lngRow, COL_¿‡±)
        If str¿‡± = "E" Then '÷–“©≈‰∑ΩªÚ“ª◊ÈºÏ—È
            k = .FindRow(CStr(.RowData(lngRow)), , COL_œ‡πÿID)
            If k <> -1 Then str¿‡± = .TextMatrix(k, COL_¿‡±)
        End If
        If str¿‡± = "7" Then str¿‡± = "8"
                
        '»∑∂® «∑Ò∂®“Â
        blnDefine = Not mrsDefine Is Nothing And Not mobjVBA Is Nothing
        If blnDefine Then
            mrsDefine.Filter = "’Ô¡∆¿‡±='" & str¿‡± & "'"
            If mrsDefine.EOF Then
                blnDefine = False
            ElseIf Trim(Nvl(mrsDefine!“Ω÷ˆƒ⁄»›)) = "" Then
                blnDefine = False
            End If
        End If
        
ReDoDefault: '”√”⁄∞¥∂®“Âπ´ Ωº∆À„ ß∞‹£¨÷ÿ–¬∞¥»± °πÊ‘ÚΩ¯––◊È÷Ø
        strText = ""
        If blnDefine Then strText = mrsDefine!“Ω÷ˆƒ⁄»›
        
        '≤˙…˙“Ω÷ˆƒ⁄»›
        Select Case str¿‡±
        Case "C" 'ºÏ—È-------------------------------------------------------------
            strºÏ—È = "": str±Í±æ = ""
            For i = lngRow - 1 To .FixedRows Step -1
                If Val(.TextMatrix(i, COL_œ‡πÿID)) = .RowData(lngRow) Then
                    If Val(.TextMatrix(i, COL_◊È∫œœÓƒøID)) = 0 And mblnNewLIS Or Not mblnNewLIS Then
                        strºÏ—È = .TextMatrix(i, col_“Ω÷ˆƒ⁄»›) & "," & strºÏ—È
                    End If
                    str±Í±æ = .TextMatrix(i, COL_±Í±æ≤øŒª)
                Else
                    Exit For
                End If
            Next
            If strºÏ—È = "" Then '¿œµƒ∑Ω Ω
                strºÏ—È = .TextMatrix(lngRow, COL_√˚≥∆)
            Else
                strºÏ—È = Left(strºÏ—È, Len(strºÏ—È) - 1)
            End If
            
            If Not blnDefine Then
                strText = strºÏ—È & IIF(str±Í±æ <> "", "(" & str±Í±æ & ")", "")
            Else
                If InStr(strText, "[ºÏ—ÈœÓƒø]") > 0 Then
                    strField = strºÏ—È
                    strText = Replace(strText, "[ºÏ—ÈœÓƒø]", """" & strField & """")
                End If
                If InStr(strText, "[ºÏ—È±Í±æ]") > 0 Then
                    strField = str±Í±æ
                    strText = Replace(strText, "[ºÏ—È±Í±æ]", """" & strField & """")
                End If
                If InStr(strText, "[≤…ºØ∑Ω∑®]") > 0 Then
                    strField = .TextMatrix(lngRow, COL_”√∑®)
                    strText = Replace(strText, "[≤…ºØ∑Ω∑®]", """" & strField & """")
                End If
            End If
        Case "D" 'ºÏ≤È-------------------------------------------------------------
            str≤øŒª = "": str∑Ω∑® = ""
            For i = lngRow + 1 To .Rows - 1
                If Val(.TextMatrix(i, COL_œ‡πÿID)) = .RowData(lngRow) Then
                    If .TextMatrix(i, COL_±Í±æ≤øŒª) <> "" Then
                        If .TextMatrix(i, COL_±Í±æ≤øŒª) <> str≤øŒªLast And str≤øŒªLast <> "" Then
                            str≤øŒª = str≤øŒª & "," & str≤øŒªLast & IIF(str∑Ω∑® <> "", "(" & Mid(str∑Ω∑®, 2) & ")", "")
                            str∑Ω∑® = ""
                        End If
                        If .TextMatrix(i, COL_ºÏ≤È∑Ω∑®) <> "" Then
                            str∑Ω∑® = str∑Ω∑® & "," & .TextMatrix(i, COL_ºÏ≤È∑Ω∑®)
                        End If
                        
                        str≤øŒªLast = .TextMatrix(i, COL_±Í±æ≤øŒª)
                    End If
                Else
                    Exit For
                End If
            Next
            If str≤øŒªLast <> "" Then
                str≤øŒª = str≤øŒª & "," & str≤øŒªLast & IIF(str∑Ω∑® <> "", "(" & Mid(str∑Ω∑®, 2) & ")", "")
            End If
            str≤øŒª = Mid(str≤øŒª, 2) 'ºÏ≤È◊È∫œœÓƒøµƒ≤øŒª
            
            If Not blnDefine Then
                strText = .TextMatrix(lngRow, COL_√˚≥∆) & _
                    Decode(Val(.TextMatrix(lngRow, COL_÷¥––±Íº«)), 1, ",¥≤≈‘÷¥––", 2, ", ı÷–÷¥––", "") & IIF(str≤øŒª <> "", ":" & str≤øŒª, "")
            Else
                If InStr(strText, "[ºÏ≤ÈœÓƒø]") > 0 Then
                    strField = .TextMatrix(lngRow, COL_√˚≥∆) & _
                        Decode(Val(.TextMatrix(lngRow, COL_÷¥––±Íº«)), 1, ",¥≤≈‘÷¥––", 2, ", ı÷–÷¥––", "")
                    strText = Replace(strText, "[ºÏ≤ÈœÓƒø]", """" & strField & """")
                End If
                If InStr(strText, "[ºÏ≤È≤øŒª]") > 0 Then
                    strField = str≤øŒª
                    strText = Replace(strText, "[ºÏ≤È≤øŒª]", """" & strField & """")
                End If
            End If
        Case "F" ' ÷ ı-------------------------------------------------------------
            str¬È◊Ì = "": str∏Ω ı = ""
            For i = lngRow + 1 To .Rows - 1
                If Val(.TextMatrix(i, COL_œ‡πÿID)) = .RowData(lngRow) Then
                    If .TextMatrix(i, COL_¿‡±) = "G" Then
                        str¬È◊Ì = .TextMatrix(i, col_“Ω÷ˆƒ⁄»›)
                    Else
                        str∏Ω ı = str∏Ω ı & "," & .TextMatrix(i, col_“Ω÷ˆƒ⁄»›)
                    End If
                Else
                    Exit For
                End If
            Next
            str∏Ω ı = Mid(str∏Ω ı, 2)
            
            If Not blnDefine Then
                If IsDate(.TextMatrix(lngRow, COL_±Í±æ≤øŒª)) Then
                    strText = Format(.TextMatrix(lngRow, COL_±Í±æ≤øŒª), "MM‘¬dd»’HH:mm")
                Else
                    strText = Format(.Cell(flexcpData, lngRow, COL_ø™ º ±º‰), "MM‘¬dd»’HH:mm")
                End If
                If str¬È◊Ì <> "" Then
                    strText = strText & IIF(str¬È◊Ì <> "", " ‘⁄ " & str¬È◊Ì & " œ¬–– ", " –– ")
                End If
                strText = strText & .TextMatrix(lngRow, COL_√˚≥∆) & IIF(.Cell(flexcpData, lngRow, COL_±Í±æ≤øŒª) = "", "", "(≤øŒª:" & .Cell(flexcpData, lngRow, COL_±Í±æ≤øŒª) & ")")
                If str∏Ω ı <> "" Then
                    strText = strText & " º∞ " & str∏Ω ı
                End If
            Else
                If InStr(strText, "[ ÷ ı ±º‰]") > 0 Then
                    If IsDate(.TextMatrix(lngRow, COL_ ÷ ı ±º‰)) Then
                        strField = .TextMatrix(lngRow, COL_ ÷ ı ±º‰)
                    Else
                        strField = .Cell(flexcpData, lngRow, COL_ø™ º ±º‰)
                    End If
                    strText = Replace(strText, "[ ÷ ı ±º‰]", """" & strField & """")
                End If
                If InStr(strText, "[÷˜“™ ÷ ı]") > 0 Then
                    strField = .TextMatrix(lngRow, COL_√˚≥∆) & IIF(.Cell(flexcpData, lngRow, COL_±Í±æ≤øŒª) = "", "", "(≤øŒª:" & .Cell(flexcpData, lngRow, COL_±Í±æ≤øŒª) & ")")
                    strText = Replace(strText, "[÷˜“™ ÷ ı]", """" & strField & """")
                End If
                If InStr(strText, "[∏Ωº” ÷ ı]") > 0 Then
                    strField = str∏Ω ı
                    strText = Replace(strText, "[∏Ωº” ÷ ı]", """" & strField & """")
                End If
                If InStr(strText, "[¬È◊Ì∑Ω∑®]") > 0 Then
                    strField = str¬È◊Ì
                    strText = Replace(strText, "[¬È◊Ì∑Ω∑®]", """" & strField & """")
                End If
            End If
        Case "8" '÷–“©≈‰∑Ω---------------------------------------------------------
            str÷–“© = "": strºÂ∑® = "": str÷–“©’Ô¡∆œÓƒøIDS = "": strSame = ""
            For i = lngRow - 1 To .FixedRows Step -1
                If Val(.TextMatrix(i, COL_œ‡πÿID)) = .RowData(lngRow) Then
                    If .TextMatrix(i, COL_¿‡±) = "7" Then
                        If InStr("," & str÷–“©’Ô¡∆œÓƒøIDS & ",", "," & Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID)) & ",") > 0 Then
                            strSame = strSame & "," & Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID))
                        End If
                        str÷–“©’Ô¡∆œÓƒøIDS = str÷–“©’Ô¡∆œÓƒøIDS & "," & Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID))
                    End If
                Else
                    Exit For
                End If
            Next
            strSame = Mid(strSame, 2)
            For i = lngRow - 1 To .FixedRows Step -1
                If Val(.TextMatrix(i, COL_œ‡πÿID)) = .RowData(lngRow) Then
                    If .TextMatrix(i, COL_¿‡±) = "7" Then
                        dbl ˝¡ø = dbl ˝¡ø + Val(.TextMatrix(i, COL_µ•¡ø))
                        
                        If Val(.TextMatrix(lngRow, COL_÷–“©–ŒÃ¨)) = 0 Then
                            blnDo = .TextMatrix(i, COL_ ’∑—œ∏ƒøID) <> .TextMatrix(i - 1, COL_ ’∑—œ∏ƒøID)
                        Else
                            blnDo = .TextMatrix(i, COL_’Ô¡∆œÓƒøID) <> .TextMatrix(i - 1, COL_’Ô¡∆œÓƒøID)
                        End If
                        
                        If blnDo Then
                            str÷–“©√˚≥∆ = .TextMatrix(i, col_“Ω÷ˆƒ⁄»›)
                            
                            If Val(.TextMatrix(lngRow, COL_÷–“©–ŒÃ¨)) = 0 And InStr("," & strSame & ",", "," & Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID)) & ",") > 0 Then
                                strSQL = "Select πÊ∏Ò as √˚≥∆ From  ’∑—œÓƒøƒø¬º Where ID=[1] And Exists(Select 1 From “©∆∑πÊ∏Ò Where “©∆∑ID<>[1] And “©√˚ID=[2])"
                                Set rsTmp = New ADODB.Recordset '«Â≥˝Filter
                                Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(.TextMatrix(i, COL_ ’∑—œ∏ƒøID)), Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID)))
                                If rsTmp.RecordCount > 0 Then
                                    If Not IsNull(rsTmp!√˚≥∆) Then str÷–“©√˚≥∆ = str÷–“©√˚≥∆ & "(" & rsTmp!√˚≥∆ & ")"
                                End If
                            End If
                        
                            str÷–“© = RTrim(str÷–“©√˚≥∆ & _
                                " " & FormatEx(dbl ˝¡ø, 5) & .TextMatrix(i, COL_µ•¡øµ•Œª) & _
                                " " & .TextMatrix(i, COL_“Ω…˙÷ˆÕ–)) & "," & str÷–“©
                            dbl ˝¡ø = 0
                        End If
                    ElseIf .TextMatrix(i, COL_¿‡±) = "E" Then
                        strºÂ∑® = .TextMatrix(i, col_“Ω÷ˆƒ⁄»›) & .TextMatrix(i, COL_±Í±æ≤øŒª)
                    End If
                Else
                    Exit For
                End If
            Next
            If str÷–“© <> "" Then
                str÷–“© = Mid(str÷–“©, 1, Len(str÷–“©) - 1)
            End If
            If Not blnDefine Then
                If .TextMatrix(lngRow, COL_÷–“©–ŒÃ¨) = "1" Then
                    str–ŒÃ¨ = "[“˚∆¨]"
                ElseIf .TextMatrix(lngRow, COL_÷–“©–ŒÃ¨) = "2" Then
                    str–ŒÃ¨ = "[√‚ºÂº¡]"
                End If
                ' ˝◊÷∫Ûº”¡Àø’∏Ò‘⁄Œƒ±æøÚ÷–ª·◊‘∂Øªª––
                strText = "÷–“©" & str–ŒÃ¨ & .TextMatrix(lngRow, COL_◊‹¡ø) & "∏∂," & _
                    .TextMatrix(lngRow, COL_∆µ¬ ) & "," & strºÂ∑® & "," & _
                    .TextMatrix(lngRow, COL_”√∑®) & ":" & str÷–“©
            Else
                If InStr(strText, "[∏∂ ˝]") > 0 Then
                    strField = .TextMatrix(lngRow, COL_◊‹¡ø)
                    strText = Replace(strText, "[∏∂ ˝]", """" & strField & """")
                End If
                If InStr(strText, "[≈‰∑Ω◊È≥…]") > 0 Then
                    strField = str÷–“©
                    strText = Replace(strText, "[≈‰∑Ω◊È≥…]", """" & strField & """")
                End If
                If InStr(strText, "[”√∑®]") > 0 Then
                    strField = .TextMatrix(lngRow, COL_”√∑®)
                    strText = Replace(strText, "[”√∑®]", """" & strField & """")
                End If
                If InStr(strText, "[ºÂ∑®]") > 0 Then
                    strField = strºÂ∑®
                    strText = Replace(strText, "[ºÂ∑®]", """" & strField & """")
                End If
            End If
        Case "4" 'Œ¿≤ƒ------------------------------------------------------------
                strSQL = "Select √˚≥∆,πÊ∏Ò,≤˙µÿ From  ’∑—œÓƒøƒø¬º Where ID=[1]"
                Set rsTmp = New ADODB.Recordset '«Â≥˝Filter
                Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(.TextMatrix(lngRow, COL_ ’∑—œ∏ƒøID)))
                
                If Not blnDefine Then
                    strText = .TextMatrix(lngRow, COL_√˚≥∆)
                    If Not IsNull(rsTmp!πÊ∏Ò) Then
                        strText = strText & " " & rsTmp!πÊ∏Ò
                    End If
                Else
                    If InStr(strText, "[Œ¿…˙≤ƒ¡œ]") > 0 Then
                        strField = rsTmp!√˚≥∆
                        strText = Replace(strText, "[Œ¿…˙≤ƒ¡œ]", """" & strField & """")
                    End If
                    If InStr(strText, "[πÊ∏Ò]") > 0 Then
                        strField = Nvl(rsTmp!πÊ∏Ò)
                        strText = Replace(strText, "[πÊ∏Ò]", """" & strField & """")
                    End If
                    If InStr(strText, "[≤˙µÿ]") > 0 Then
                        strField = Nvl(rsTmp!≤˙µÿ)
                        strText = Replace(strText, "[≤˙µÿ]", """" & strField & """")
                    End If
                End If
        Case "5", "6" 'Œ˜≥…“©£¨÷–≥…“©---------------------------------------------
            If Val(.TextMatrix(lngRow, COL_ ’∑—œ∏ƒøID)) <> 0 Then
                '–‘÷ :0-’˝√˚,1-”¢Œƒ√˚,3-…Ã∆∑√˚
                strSQL = "Select Nvl(B.√˚≥∆,A.√˚≥∆) as √˚≥∆,A.πÊ∏Ò,A.≤˙µÿ,B.–‘÷ " & _
                    " From  ’∑—œÓƒøƒø¬º A, ’∑—œÓƒø±√˚ B Where A.ID=B. ’∑—œ∏ƒøID(+) And A.ID=[1] Order by B.–‘÷ ,B.¬Î¿‡"
                Set rsTmp = New ADODB.Recordset '«Â≥˝Filter
                Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(.TextMatrix(lngRow, COL_ ’∑—œ∏ƒøID)))
            ElseIf blnDefine Then
                '–‘÷ :0-’˝√˚,1-”¢Œƒ√˚
                strSQL = "Select Nvl(B.√˚≥∆,A.√˚≥∆) as √˚≥∆,Null as πÊ∏Ò,Null as ≤˙µÿ,B.–‘÷ " & _
                    " From ’Ô¡∆œÓƒøƒø¬º A,’Ô¡∆œÓƒø±√˚ B Where A.ID=B.’Ô¡∆œÓƒøID(+) And A.ID=[1] Order by B.–‘÷ ,B.¬Î¿‡"
                Set rsTmp = New ADODB.Recordset '«Â≥˝Filter
                Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(.TextMatrix(lngRow, COL_’Ô¡∆œÓƒøID)))
            End If
            If Not blnDefine Then
                strText = .TextMatrix(lngRow, COL_±Í±æ≤øŒª)
                If Val(.TextMatrix(lngRow, COL_ ’∑—œ∏ƒøID)) <> 0 Then
                    If strText = "" Then
                        If gbyt“©∆∑√˚≥∆œ‘ æ <> 0 Then rsTmp.Filter = "–‘÷ =3"
                        If rsTmp.EOF Then rsTmp.Filter = 0
                        strText = rsTmp!√˚≥∆
                    End If
                    If Not IsNull(rsTmp!≤˙µÿ) Then
                        strText = strText & "(" & rsTmp!≤˙µÿ & ")"
                    End If
                    If Not IsNull(rsTmp!πÊ∏Ò) Then
                        strText = strText & " " & rsTmp!πÊ∏Ò
                    End If
                Else
                    If strText = "" Then
                        strText = .TextMatrix(lngRow, COL_√˚≥∆)
                    End If
                End If
            Else
                If InStr(strText, "[ ‰»Î√˚]") > 0 Then
                    strField = .TextMatrix(lngRow, COL_±Í±æ≤øŒª)
                    If strField = "" Then
                        If gbyt“©∆∑√˚≥∆œ‘ æ <> 0 Then rsTmp.Filter = "–‘÷ =3"
                        If rsTmp.EOF Then rsTmp.Filter = 0
                        strField = rsTmp!√˚≥∆
                    End If
                    strText = Replace(strText, "[ ‰»Î√˚]", """" & strField & """")
                End If
                If InStr(strText, "[Õ®”√√˚]") > 0 Then
                    rsTmp.Filter = 0
                    strField = rsTmp!√˚≥∆
                    strText = Replace(strText, "[Õ®”√√˚]", """" & strField & """")
                End If
                If InStr(strText, "[…Ã∆∑√˚]") > 0 Then
                    rsTmp.Filter = "–‘÷ =3"
                    If rsTmp.EOF Then
                        strField = ""
                    Else
                        strField = rsTmp!√˚≥∆
                    End If
                    strText = Replace(strText, "[…Ã∆∑√˚]", """" & strField & """")
                End If
                If InStr(strText, "[”¢Œƒ√˚]") > 0 Then
                    rsTmp.Filter = "–‘÷ =2"
                    If rsTmp.EOF Then
                        strField = ""
                    Else
                        strField = rsTmp!√˚≥∆
                    End If
                    strText = Replace(strText, "[”¢Œƒ√˚]", """" & strField & """")
                End If
                If InStr(strText, "[πÊ∏Ò]") > 0 Then
                    If rsTmp.EOF Then rsTmp.Filter = 0
                    strField = Nvl(rsTmp!πÊ∏Ò)
                    strText = Replace(strText, "[πÊ∏Ò]", """" & strField & """")
                End If
                If InStr(strText, "[≤˙µÿ]") > 0 Then
                    If rsTmp.EOF Then rsTmp.Filter = 0
                    strField = Nvl(rsTmp!≤˙µÿ)
                    strText = Replace(strText, "[≤˙µÿ]", """" & strField & """")
                End If
                If InStr(strText, "[∏¯“©Õææ∂]") > 0 Then
                    strField = .TextMatrix(lngRow, COL_”√∑®)
                    strText = Replace(strText, "[∏¯“©Õææ∂]", """" & strField & """")
                End If
            End If
        Case "K" ' ‰—™“Ω÷ˆ
            If Not blnDefine Then
                If IsDate(.TextMatrix(lngRow, COL_ ‰—™ ±º‰)) Then
                    strText = Format(.TextMatrix(lngRow, COL_ ‰—™ ±º‰), "MM‘¬dd»’HH:mm")
                Else
                    strText = Format(.Cell(flexcpData, lngRow, COL_ø™ º ±º‰), "MM‘¬dd»’HH:mm")
                End If
            
                strText = "”⁄" & strText & " ‰" & .TextMatrix(lngRow, COL_√˚≥∆)
                If .TextMatrix(lngRow, COL_”√∑®) <> "" Then
                    strText = strText & "(" & .TextMatrix(lngRow, COL_”√∑®) & ")"
                End If
            Else
                If InStr(strText, "[ ‰—™ ±º‰]") > 0 Then
                    If IsDate(.TextMatrix(lngRow, COL_ ‰—™ ±º‰)) Then
                        strField = .TextMatrix(lngRow, COL_ ‰—™ ±º‰)
                    Else
                        strField = .Cell(flexcpData, lngRow, COL_ø™ º ±º‰)
                    End If
                    strText = Replace(strText, "[ ‰—™ ±º‰]", """" & strField & """")
                End If
                If InStr(strText, "[’Ô¡∆œÓƒø]") > 0 Then
                    strField = .TextMatrix(lngRow, COL_√˚≥∆)
                    strText = Replace(strText, "[’Ô¡∆œÓƒø]", """" & strField & """")
                End If
                If InStr(strText, "[ ‰—™œÓƒø]") > 0 Then
                    strField = .TextMatrix(lngRow, COL_√˚≥∆)
                    strText = Replace(strText, "[ ‰—™œÓƒø]", """" & strField & """")
                End If
                If InStr(strText, "[ ‰—™Õææ∂]") > 0 Then
                    strField = .TextMatrix(lngRow, COL_”√∑®)
                    strText = Replace(strText, "[ ‰—™Õææ∂]", """" & strField & """")
                End If
                If TypeName(.Cell(flexcpData, lngRow, COL_…Í«Î–Ú∫≈)) = "Recordset" Then
                    Set rsCard = zlDatabase.CopyNewRec(.Cell(flexcpData, lngRow, COL_…Í«Î–Ú∫≈))
                    If InStr(strText, "[—™–Õ]") > 0 Then
                        If rsCard.EOF Then
                            strField = ""
                        Else
                            strField = Decode(Val("" & rsCard!—™–Õ), 1, "A", 2, "B", 3, "O", 4, "AB", "")
                        End If
                        strText = Replace(strText, "[—™–Õ]", """" & strField & """")
                    End If
                    If InStr(strText, "[RH]") > 0 Then
                        If rsCard.EOF Then
                            strField = ""
                        Else
                            strField = Decode(Val("" & rsCard!RHD), 1, "-", 2, "+", "")
                        End If
                        strText = Replace(strText, "[RH]", """" & strField & """")
                    End If
                End If
                If InStr(strText, "[÷¥––∑÷¿‡]") > 0 Then
                    strField = Val(.TextMatrix(lngRow + 1, COL_÷¥––∑÷¿‡))
                    strText = Replace(strText, "[÷¥––∑÷¿‡]", """" & strField & """")
                End If
            End If
        Case Else '∆‰À¸À˘”–¿‡±-----------------------------------------------------
            If Not blnDefine Then
                strText = .TextMatrix(lngRow, COL_√˚≥∆)
            Else
                If InStr(strText, "[’Ô¡∆œÓƒø]") > 0 Then
                    strField = .TextMatrix(lngRow, COL_√˚≥∆)
                    strText = Replace(strText, "[’Ô¡∆œÓƒø]", """" & strField & """")
                End If
            End If
            ' ı∫Û“Ω÷ˆÃÿ ‚œ‘ æ
            If .TextMatrix(lngRow, COL_¿‡±) = "Z" And (Val(.TextMatrix(lngRow, COL_≤Ÿ◊˜¿‡–Õ)) = 4 Or Val(.TextMatrix(lngRow, COL_≤Ÿ◊˜¿‡–Õ)) = 14) Then
                strText = "©•©•©•" & strText & "©•©•©•"
            End If
        End Select
        
        'π´π≤◊÷∂ŒªÚø…“‘π´π≤¥¶¿Ìµƒ◊÷∂Œ-------------------------------------------
        If blnDefine Then
            If InStr(strText, "[ø™ º ±º‰]") > 0 Then
                strField = .Cell(flexcpData, lngRow, COL_ø™ º ±º‰)
                strText = Replace(strText, "[ø™ º ±º‰]", """" & strField & """")
            End If
            If InStr(strText, "[“Ω…˙÷ˆÕ–]") > 0 Then
                strField = .Cell(flexcpData, lngRow, COL_“Ω…˙÷ˆÕ–)
                If .TextMatrix(lngRow, COL_“Ω…˙÷ˆÕ–) <> "" Then
                    If strField <> "" Then
                        strField = strField & "," & .TextMatrix(lngRow, COL_“Ω…˙÷ˆÕ–)
                    Else
                        strField = .TextMatrix(lngRow, COL_“Ω…˙÷ˆÕ–)
                    End If
                End If
                strText = Replace(strText, "[“Ω…˙÷ˆÕ–]", """" & strField & """")
            End If
            If InStr(strText, "[÷–Œƒ∆µ¬ ]") > 0 Then
                strField = .TextMatrix(lngRow, COL_∆µ¬ )
                strText = Replace(strText, "[÷–Œƒ∆µ¬ ]", """" & strField & """")
            End If
            If InStr(strText, "[”¢Œƒ∆µ¬ ]") > 0 Then
                strField = ""
                If .TextMatrix(lngRow, COL_∆µ¬ ) <> "" Then
                    int∆µ¬ ∑∂Œß = Get∆µ¬ ∑∂Œß(lngRow)
                    strSQL = "Select ”¢Œƒ√˚≥∆ From ’Ô¡∆∆µ¬ œÓƒø Where √˚≥∆=[1] And   ”√∑∂Œß=[2]"
                    Set rsTmp = New ADODB.Recordset '«Â≥˝Filter
                    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, .TextMatrix(lngRow, COL_∆µ¬ ), int∆µ¬ ∑∂Œß)
                    If Not rsTmp.EOF Then strField = Nvl(rsTmp!”¢Œƒ√˚≥∆)
                End If
                strText = Replace(strText, "[”¢Œƒ∆µ¬ ]", """" & strField & """")
            End If
            If InStr(strText, "[µ•¡ø]") > 0 Then
                strField = ""
                If .TextMatrix(lngRow, COL_µ•¡ø) <> "" Then
                    strField = .TextMatrix(lngRow, COL_µ•¡ø) & .TextMatrix(lngRow, COL_µ•¡øµ•Œª)
                End If
                strText = Replace(strText, "[µ•¡ø]", """" & strField & """")
            End If
            If InStr(strText, "[◊‹¡ø]") > 0 Then
                strField = ""
                If .TextMatrix(lngRow, COL_◊‹¡ø) <> "" Then
                    strField = .TextMatrix(lngRow, COL_◊‹¡ø) & .TextMatrix(lngRow, COL_◊‹¡øµ•Œª)
                End If
                strText = Replace(strText, "[◊‹¡ø]", """" & strField & """")
            End If
            If InStr(strText, "[÷¥–– ±º‰]") > 0 Then
                strField = .TextMatrix(lngRow, COL_÷¥–– ±º‰)
                strText = Replace(strText, "[÷¥–– ±º‰]", """" & strField & """")
            End If
        End If
                
        'º∆À„“Ω÷ˆƒ⁄»›
        If blnDefine Then
            On Error Resume Next
            strText = mobjVBA.Eval(strText)
            If mobjVBA.Error.Number <> 0 Then
                err.Clear: On Error GoTo errH
                blnDefine = False: GoTo ReDoDefault
            End If
        End If
    End With
    AdviceTextMake = strText
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Function GetAdviceAppendItem() As String
'π¶ƒ‹£∫ªÒ»°Œ¥±£¥Ê“Ω÷ˆ(–¬ø™ªÚ–ﬁ∏ƒµƒ)µƒ◊Ó–¬µ•æ›∏ΩœÓ
'∑µªÿ£∫œÓƒø√˚1<Split2>ƒ⁄»›1<Split1>œÓƒø√˚2<Split2>ƒ⁄»›2<Split1>...
    Dim arrAppend As Variant, i As Long, j As Long
    Dim strName As String, strText As String
    Dim strResult As String
    
    With vsAdvice
        For i = .Rows - 1 To .FixedRows Step -1
            If .RowData(i) <> 0 And .TextMatrix(i, COL_∏ΩœÓ) <> "" And .Cell(flexcpData, i, COL_∏ΩœÓ) = 1 Then
                arrAppend = Split(.TextMatrix(i, COL_∏ΩœÓ), "<Split1>")
                For j = 0 To UBound(arrAppend)
                    strName = Split(arrAppend(j), "<Split2>")(0)
                    strText = Split(arrAppend(j), "<Split2>")(3)
                    
                    If InStr(strResult, "<Split1>" & strName & "<Split2>") = 0 Then
                        strResult = strResult & "<Split1>" & strName & "<Split2>" & strText
                    End If
                Next
            End If
        Next
    End With
    
    GetAdviceAppendItem = Mid(strResult, Len("<Split1>") + 1)
End Function

Private Function GetAdviceDiagnosis() As String
'π¶ƒ‹£∫ªÒ»°µ±«∞“—¬º»ÎµƒŒ¥±£¥Êµƒ’Ô∂œ
'∑µªÿ£∫"1°¢’Ô∂œ√˚“ª 2°¢’Ô∂œ√˚∂˛"
    Dim strText As String, i As Long, j As Long
    
    With vsDiag
        For i = 1 To .Rows - 1
            If Trim(.TextMatrix(i, col’Ô∂œ)) <> "" Then
                j = j + 1
                strText = strText & "  " & j & "°¢" & .TextMatrix(i, col’Ô∂œ) & IIF(Val(.Cell(flexcpData, i, col“…’Ô)) = 1, "(£ø)", "")
            End If
        Next
    End With
    
    strText = Mid(strText, 3)
    If j = 1 Then strText = Mid(strText, 3)
    GetAdviceDiagnosis = strText
End Function

Private Sub vsDiag_AfterEdit(ByVal Row As Long, ByVal Col As Long)
    With vsDiag
        If Col = col’Ô∂œ Then
            ' .EditText = "" ≈≈≥˝µ•‘™∏Ò”–ƒ⁄»›≤¢∞¥ªÿ≥µµƒ◊¥øˆ
            If .EditText = "" And .Cell(flexcpData, Row, Col) <> "" Then
                '‘⁄µ˜”√vsDiagXY_KeyDown(vbKeyDelete, 0)µ„ «ø…“‘…æ≥˝µ±«∞––£¨µ„∑Ò‘Úª÷∏¥‘≠ º ˝æ›
                .TextMatrix(Row, Col) = .Cell(flexcpData, Row, Col)
                Call vsDiag_KeyDown(vbKeyDelete, 0)
            End If
        End If
        If .Col = Col Then Call vsDiag_AfterRowColChange(-1, -1, Row, Col)
  
    End With
End Sub

Private Sub vsDiag_AfterRowColChange(ByVal OldRow As Long, ByVal OldCol As Long, ByVal NewRow As Long, ByVal NewCol As Long)
    Dim i As Long
    
    With vsDiag
        '«Â≥˝Õº∆¨
        For i = .FixedRows To .Rows - 1
            If Not .Cell(flexcpPicture, i, col‘ˆº”) Is Nothing Then
                Set .Cell(flexcpPicture, i, col‘ˆº”) = Nothing
            End If
            If Not .Cell(flexcpPicture, i, COLDEL) Is Nothing Then
               Set .Cell(flexcpPicture, i, COLDEL) = Nothing
            End If
        Next
        '…Ë÷√±‡º≠ø…º˚Ãÿ–‘
        If Not DiagCellEditable(NewRow, NewCol) Then
            .ComboList = ""
            .FocusRect = flexFocusLight
        Else
            .FocusRect = flexFocusSolid
            Set .CellButtonPicture = Nothing
            If NewCol = col’Ô∂œ Then
                .ComboList = "..."
            ElseIf NewCol = col‘ˆº” Then
                .ComboList = "..."
                .FocusRect = flexFocusNone
                Set .CellButtonPicture = imgButtonNew.Picture
            ElseIf NewCol = COLDEL Then
                .ComboList = "..."
                .FocusRect = flexFocusNone
                Set .CellButtonPicture = imgButtonDel.Picture
            ElseIf NewCol = col÷–“Ω÷§∫Ú Then
                If .TextMatrix(NewRow, col’Ô∂œ) = "" Then
                    .ComboList = ""
                    .FocusRect = flexFocusLight
                Else
                    .ComboList = "..."
                End If
            Else
                .ComboList = ""
            End If
        End If
        If NewRow >= .FixedRows Then
            'œ‘ æÕº∆¨
            If NewCol <> col‘ˆº” And .TextMatrix(NewRow, col’Ô∂œ) <> "" Then
                Set .Cell(flexcpPicture, NewRow, col‘ˆº”) = imgButtonNew.Picture
            End If
            'œ‘ æÕº∆¨
            If NewCol <> COLDEL Then
                Set .Cell(flexcpPicture, NewRow, COLDEL) = imgButtonDel.Picture
            End If
        End If
        
        If NewRow <> OldRow Then
            'µ±«∞––±Í÷æœ‘ æ
            Set .Cell(flexcpPicture, 0, col±Í÷æ, .Rows - 1, col±Í÷æ) = Nothing
            Set .Cell(flexcpPicture, NewRow, col±Í÷æ) = img16.ListImages("’Ô∂œ_µ±«∞").Picture
            .Cell(flexcpPictureAlignment, NewRow, col±Í÷æ) = 4
                    
            'œ‘ æπÿ¡™“Ω÷ˆ±Í ∂
            Call ShowDiagFlag(NewRow)
        End If
    End With
End Sub

Private Sub vsDiag_BeforeEdit(ByVal Row As Long, ByVal Col As Long, Cancel As Boolean)
    '‘⁄StartEdit ¬º˛÷–¥¶¿Ìª·œ‘ æ≥ˆ«∞“ª¡–µƒ∞¥≈•
    If Col = col“…’Ô Then Cancel = True
End Sub

Private Sub vsDiag_Click()
    With vsDiag
        If (.MouseCol = col‘ˆº” Or .MouseCol = COLDEL) And .MouseRow >= .FixedRows Then
            If .MouseCol = col‘ˆº” Then
                If .TextMatrix(.MouseRow, col’Ô∂œ) = "" Then Exit Sub
            End If
            
            .Select .MouseRow, .MouseCol
            Call vsDiag_CellButtonClick(.MouseRow, .MouseCol)
        End If
    End With
End Sub

Private Sub vsDiag_BeforeRowColChange(ByVal OldRow As Long, ByVal OldCol As Long, ByVal NewRow As Long, ByVal NewCol As Long, Cancel As Boolean)
    If NewCol = col±Í÷æ Then
        Cancel = True
    ElseIf (NewCol = col÷–“Ω Or NewCol = COLŒ˜“Ω) And vsDiag.TextMatrix(NewRow, col’Ô∂œ) <> "" Then
        Cancel = True
    End If
End Sub

Private Sub vsDiag_CellButtonClick(ByVal Row As Long, ByVal Col As Long)
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String, str–‘± As String
    Dim lngRow As Long, int’Ô∂œ¿‡–Õ As Integer
    Dim blnCancle As Boolean
    Dim str¿‡± As String
    
    With vsDiag
        If Col = col’Ô∂œ Then
            If .Cell(flexcpData, Row, col÷–“Ω) = 1 Then
                If opt’Ô∂œ(0).value Then
                    '∞¥’Ô∂œ ‰»Î:÷–“Ω≤ø∑›£¨“ª∏ˆ’Ô∂œø…ƒ‹ Ù”⁄∂‡∏ˆ∑÷¿‡
                    Set rsTmp = zlDatabase.ShowILLSelect(Me, "2", mlng≤°»Àø∆ “id, , True, False, , , 1)
                    str¿‡± = "2"
                Else
                    'B-÷–“Ωº≤≤°±‡¬Î
                    Set rsTmp = zlDatabase.ShowILLSelect(Me, "B", mlng≤°»Àø∆ “id, mstr–‘±, True, , , , 1)
                    str¿‡± = "B"
                End If
            Else
                If opt’Ô∂œ(0).value Then
                    '∞¥’Ô∂œ ‰»Î:Œ˜“Ω≤ø∑›£¨“ª∏ˆ’Ô∂œø…ƒ‹ Ù”⁄∂‡∏ˆ∑÷¿‡
                    Set rsTmp = zlDatabase.ShowILLSelect(Me, "1", mlng≤°»Àø∆ “id, , True, False, , , 1)
                    str¿‡± = "1"
                Else
                    'D-ICD-10º≤≤°±‡¬Î
                    Set rsTmp = zlDatabase.ShowILLSelect(Me, "D", mlng≤°»Àø∆ “id, mstr–‘±, True, , , , 1)
                    str¿‡± = "D"
                End If
            End If
            If rsTmp Is Nothing Then
                If opt’Ô∂œ(0).value Then
                    MsgBox "√ª”–º≤≤°’Ô∂œ ˝æ›ø…“‘—°‘Ò°£", vbInformation, gstrSysName
                End If
            Else
                Call SetDiagInput(Row, rsTmp, str¿‡±)
                Call DiagEnterNextCell
            End If
        ElseIf Col = col÷–“Ω÷§∫Ú Then
            If opt’Ô∂œ(0).value Then
                '∞¥’Ô∂œ ‰»Î:œ»≤È «∑Ò”–∂‘”¶
                If Not Set÷–“Ω÷§∫Ú(Row, Val(.TextMatrix(Row, col’Ô∂œID))) Then
                    Set rsTmp = zlDatabase.ShowILLSelect(Me, "Z", mlng≤°»Àø∆ “id, mstr–‘±, True, , , , 1)
                Else
                    Exit Sub
                End If
            Else
                'Z-÷–“Ωº≤≤°±‡¬Î
                Set rsTmp = zlDatabase.ShowILLSelect(Me, "Z", mlng≤°»Àø∆ “id, mstr–‘±, True, , , , 1)
            End If
            If Not rsTmp Is Nothing Then
                Call Set÷–“Ω÷§∫Ú(Row, 0, rsTmp)
                Call DiagEnterNextCell
            End If
        ElseIf Col = col‘ˆº” Then
            If .Rows < M_LNG_DIAGCOUNT Then
                lngRow = Row + 1: .AddItem "", lngRow
                .Row = lngRow: .Col = col’Ô∂œ
                
                int’Ô∂œ¿‡–Õ = IIF(mbln÷–“Ω, 11, 1)
                If lngRow - 1 >= .FixedRows Then
                    int’Ô∂œ¿‡–Õ = IIF(.Cell(flexcpData, lngRow - 1, col÷–“Ω) = 1, 11, 1)
                End If
                Call SetDiagType(lngRow, int’Ô∂œ¿‡–Õ)
                
                Call SetDiagHeight
            End If
        ElseIf Col = COLDEL Then
            Call vsDiag_KeyDown(vbKeyDelete, 0)
        End If
    End With
End Sub

Private Sub vsDiag_CellChanged(ByVal Row As Long, ByVal Col As Long)
    With vsDiag
        If Col = col’Ô∂œ Then
            .TextMatrix(Row, col“…’Ô) = IIF(.TextMatrix(Row, Col) <> "", "£ø", "")
        End If
    End With
End Sub

Private Sub vsDiag_DblClick()
    Call vsDiag_KeyPress(32)
End Sub

Private Sub vsDiag_GotFocus()
    If Me.Visible Then vsDiag_AfterRowColChange -1, -1, vsDiag.Row, vsDiag.Col
End Sub

Private Sub vsDiag_KeyDown(KeyCode As Integer, Shift As Integer)
    Dim blnDo As Boolean, i As Long
    Dim int’Ô∂œ¿‡–Õ As Integer
    
    With vsDiag
        If KeyCode = vbKeyF4 Then
            If .Col = col’Ô∂œ Then
                Call zlCommFun.PressKey(vbKeySpace)
            End If
        ElseIf KeyCode = vbKeyDelete Then
            'ºÏ≤È «∑Ò‘ –Ì…æ≥˝
            For i = 1 To vsAdvice.Rows - 1
                If InStr("," & .TextMatrix(.Row, col“Ω÷ˆID) & ",", "," & vsAdvice.RowData(i) & ",") > 0 And vsAdvice.TextMatrix(i, COL_◊¥Ã¨) = "8" Then
                    MsgBox "∏√’Ô∂œ∂‘”¶µƒ¥¶∑Ω“—∑¢ÀÕ£¨≤ªƒ‹…æ≥˝°£", vbInformation, Me.Caption
                    Exit Sub
                End If
                '“Ωººπ§◊˜’æµ˜”√,»Ù’Ô∂œπÿ¡™“Ω÷ˆ,¥Ê‘⁄“Ω÷ˆµƒø™÷ˆ“Ω…˙∑«µ±«∞≤Ÿ◊˜‘±,‘Ú≤ª‘ –Ì…æ≥˝’Ô∂œ
                If mint≥°∫œ = 2 And InStr("," & .TextMatrix(.Row, col“Ω÷ˆID) & ",", "," & vsAdvice.RowData(i) & ",") > 0 And vsAdvice.TextMatrix(i, COL_ø™÷ˆ“Ω…˙) <> UserInfo.–’√˚ Then
                    MsgBox "∏√’Ô∂œ¥Ê‘⁄πÿ¡™“Ω÷ˆ,«“∏√“Ω÷ˆ∑«ƒ˙œ¬¥Ô£¨≤ªƒ‹…æ≥˝°£", vbInformation, Me.Caption
                    Exit Sub
                End If
            Next
            blnDo = True
            If .TextMatrix(.Row, col’Ô∂œ) <> "" Then
                If MsgBox("»∑ µ“™…æ≥˝∏√––’Ô∂œ–≈œ¢¬£ø", vbQuestion + vbYesNo + vbDefaultButton2, gstrSysName) = vbNo Then blnDo = False
            End If
            If blnDo Then
                If .TextMatrix(.Row, col’Ô∂œ) <> "" Then
                    lbl’Ô∂œ.Tag = "1"
                    mblnNoSave = True
                    '…æ≥˝÷˜/¥Œ“™’Ô∂œ∫Ûµ˜”√Õ‚π“Ω”ø⁄
                    If CreatePlugInOK(p√≈’Ô“Ω÷ˆœ¬¥Ô, mint≥°∫œ) Then
                        On Error Resume Next
                        Call gobjPlugIn.DiagnosisDeleted(glngSys, p√≈’Ô“Ω÷ˆœ¬¥Ô, mlng≤°»ÀID, mlngπ“∫≈ID, Val(.TextMatrix(.Row, col’Ô∂œID)), .TextMatrix(.Row, col’Ô∂œ), mint≥°∫œ)
                        Call zlPlugInErrH(err, "DiagnosisDeleted")
                        err.Clear: On Error GoTo 0
                    End If
                    If mblnPass Then
                        zlPassDrags
                    End If
                End If
                
                If .Rows = 2 And .Row = 1 Then
                    int’Ô∂œ¿‡–Õ = IIF(.Cell(flexcpData, .Row, col÷–“Ω) = 1, 11, 1)
                    .Cell(flexcpText, .Row, 0, .Row, .Cols - 1) = ""
                    .Cell(flexcpData, .Row, 0, .Row, .Cols - 1) = Empty
                    Set .Cell(flexcpPicture, .Row, 0, .Row, .Cols - 1) = Nothing
                    Call SetDiagType(.Row, int’Ô∂œ¿‡–Õ)
                Else
                    .RemoveItem .Row
                    Call SetDiagHeight
                End If
            End If
            .SetFocus
        ElseIf KeyCode > 127 Then
            'Ω‚æˆ÷±Ω” ‰»Î∫∫◊÷µƒŒ Ã‚
            Call vsDiag_KeyPress(KeyCode)
        End If
    End With
End Sub

Private Sub vsDiag_KeyPress(KeyAscii As Integer)
    With vsDiag
        If KeyAscii = 13 Then
            KeyAscii = 0
            Call DiagEnterNextCell
        ElseIf KeyAscii = 32 And (.Col = col“…’Ô Or .Col = col÷–“Ω Or .Col = COLŒ˜“Ω) Then
            KeyAscii = 0
            If .Col = col÷–“Ω Then
                If .Cell(flexcpData, .Row, col÷–“Ω) = 0 Then
                    Call SetDiagType(.Row, 11): .Col = col’Ô∂œ
                End If
            ElseIf .Col = COLŒ˜“Ω Then
                If .Cell(flexcpData, .Row, COLŒ˜“Ω) = 0 Then
                    Call SetDiagType(.Row, 1): .Col = col’Ô∂œ
                End If
            ElseIf .Col = col“…’Ô Then
                If DiagCellEditable(.Row, .Col) Then
                    KeyAscii = 0
                    .Cell(flexcpData, .Row, .Col) = IIF(.Cell(flexcpData, .Row, .Col) = 1, 0, 1)
                    .Cell(flexcpForeColor, .Row, .Col) = IIF(.Cell(flexcpData, .Row, .Col) = 1, vbRed, .GridColor)
                    
                    lbl’Ô∂œ.Tag = "1"
                    mblnNoSave = True
                End If
            End If
        Else
            If .Col = col’Ô∂œ Or .Col = col÷–“Ω÷§∫Ú Then
                If KeyAscii = Asc("*") Then
                    KeyAscii = 0
                    Call vsDiag_CellButtonClick(.Row, .Col)
                Else
                    .ComboList = "" ' π∞¥≈•◊¥Ã¨Ω¯»Î ‰»Î◊¥Ã¨
                End If
            End If
        End If
    End With
End Sub

Private Sub vsDiag_KeyPressEdit(ByVal Row As Long, ByVal Col As Long, KeyAscii As Integer)
    If KeyAscii = 13 Then
        mblnReturn = True
    Else
        mblnReturn = False
    End If
End Sub

Private Sub vsDiag_LostFocus()
    If vsDiag.Col <> col∑¢≤° ±º‰ Then vsDiag.Col = IIF(vsDiag.Col = col÷–“Ω÷§∫Ú, col÷–“Ω÷§∫Ú, col’Ô∂œ)
End Sub

Private Sub vsDiag_SetupEditWindow(ByVal Row As Long, ByVal Col As Long, ByVal EditWindow As Long, ByVal IsCombo As Boolean)
    vsDiag.EditSelStart = 0
    vsDiag.EditSelLength = zlCommFun.ActualLen(vsDiag.EditText)
End Sub

Private Sub vsDiag_StartEdit(ByVal Row As Long, ByVal Col As Long, Cancel As Boolean)
    If Not DiagCellEditable(Row, Col) Then
        Cancel = True
    ElseIf Col = col“…’Ô Or Col = col÷–“Ω Or Col = COLŒ˜“Ω Then
        Cancel = True '≤ª÷±Ω”±‡º≠
    End If
End Sub

Private Function GetDiagSQL(ByVal Row As Long, ByRef strInput As String, ByRef strSQL As String, ByRef str–‘± As String, Optional ByVal strType As String) As String
'π¶ƒ‹£∫ªÒµ√≤È—Ø’Ô∂œµƒSQL
'≤Œ ˝£∫strInput-≤È—ØÃıº˛,strsql--∑µªÿµƒSQL£¨str–‘±--≤°»Àµƒ–‘±  ,strTypeº≤≤°±‡¬Î÷÷¿‡°£
'∑µªÿ£∫strsql--≤È—Ø÷–“Ω’Ô∂œµƒSQL
    If vsDiag.Cell(flexcpData, Row, col÷–“Ω) = 1 Then
        If opt’Ô∂œ(0).value And strType <> "Z" Then
            '∞¥’Ô∂œ ‰»Î:÷–“Ω≤ø∑›£¨“ª∏ˆ’Ô∂œø…ƒ‹ Ù”⁄∂‡∏ˆ∑÷¿‡
            If zlCommFun.IsCharChinese(strInput) Then
                strSQL = "B.√˚≥∆ Like [2]" ' ‰»Î∫∫◊÷ ±÷ª∆•≈‰√˚≥∆
            Else
                strSQL = "A.±‡¬Î Like [1] Or B.√˚≥∆ Like [2] Or B.ºÚ¬Î Like [2]"
            End If
           strSQL = _
                " Select Distinct A.ID,A.ID as œÓƒøID,A.±‡¬Î,Null as ¿‡±,A.√˚≥∆,A.Àµ√˜,A.±‡’ﬂ," & vbNewLine & _
                " Decode(b.√˚≥∆, [5], 1, Decode(b.ºÚ¬Î,[5],1,decode(a.±‡¬Î,[5],1,NULL))) As ≈≈–Ú1ID,Decode(d.’Ô∂œid, Null, Decode(c.’Ô∂œid, Null, Null, 2), 1) As ≈≈–Ú2ID," & vbNewLine & _
                " Decode(Substr(b.√˚≥∆, 1, Length([5])), [5], 1, Decode(Substr(b.ºÚ¬Î, 1, Length([5])),[5],1,decode(Substr(a.±‡¬Î, 1, Length([5])),[5],1,NULL))) As ≈≈–Ú3ID" & _
                " From º≤≤°’Ô∂œƒø¬º A,º≤≤°’Ô∂œ±√˚ B, º≤≤°’Ô∂œø∆ “ C, º≤≤°’Ô∂œø∆ “ D" & _
                " Where A.ID=B.’Ô∂œID And c.’Ô∂œid(+) = a.Id And d.’Ô∂œid(+) = a.Id And A.¿‡±=2" & _
                " And B.¬Î¿‡=[4] And d.»À‘±id(+) = [6] And c.ø∆ “id(+)=[7] And (a.≥∑µµ ±º‰ Is Null Or a.≥∑µµ ±º‰ = To_Date('3000-01-01', 'YYYY-MM-DD'))" & _
                " And ( Nvl(A.  ”√∑∂Œß,0) = 0 or  A.  ”√∑∂Œß = 1) " & _
                " And (" & strSQL & ")" & _
                " Order by ≈≈–Ú1ID, ≈≈–Ú2ID, ≈≈–Ú3ID,A.±‡¬Î"
                '≈≈–ÚÀ≥–Ú£∫œ» «ÕÍ»´∆•≈‰(√˚≥∆°¢ºÚ¬Î°¢±‡¬Î£©°¢∏ˆ»À ’≤ÿ°¢∆‰¥Œ «ø∆ “ ’≤ÿ°¢»ª∫Û «◊Û∆•≈‰(√˚≥∆°¢ºÚ¬Î°¢±‡¬Î£©°¢◊Ó∫Û «À´œÚ∆•≈‰
        Else
            'B-÷–“Ωº≤≤°±‡¬Î
            If zlCommFun.IsCharChinese(strInput) Then
                strSQL = "A.√˚≥∆ Like [2]" ' ‰»Î∫∫◊÷ ±÷ª∆•≈‰√˚≥∆
            Else
                strSQL = "A.±‡¬Î Like [1] Or A.√˚≥∆ Like [2] Or " & IIF(mintºÚ¬Î = 0, "A.ºÚ¬Î", "A.ŒÂ± ¬Î") & " Like [2]"
            End If
            strSQL = _
                "Select Distinct a.Id, a.Id As œÓƒøid, a.±‡¬Î, a.¿‡±, a.∏Ω¬Î, a.√˚≥∆," & IIF(mintºÚ¬Î = 0, "A.ºÚ¬Î", "A.ŒÂ± ¬Î as ºÚ¬Î") & ", a.Àµ√˜," & _
                " Decode(a.√˚≥∆, [5], 1, Decode(" & IIF(mintºÚ¬Î = 0, "A.ºÚ¬Î", "A.ŒÂ± ¬Î") & ",[5],1,decode(a.±‡¬Î,[5],1,NULL))) As ≈≈–Ú1ID," & vbNewLine & _
                "                Decode(d.º≤≤°id, Null, Decode(c.º≤≤°id, Null, Null, 2), 1) As ≈≈–Ú2ID," & vbNewLine & _
                "                Decode(Substr(a.√˚≥∆, 1, Length([5])), [5], 1, Decode(Substr(" & IIF(mintºÚ¬Î = 0, "A.ºÚ¬Î", "A.ŒÂ± ¬Î") & ", 1, Length([5])),[5],1,decode(Substr(a.±‡¬Î, 1, Length([5])),[5],1,NULL))) As ≈≈–Ú3ID" & vbNewLine & _
                "From º≤≤°±‡¬Îƒø¬º A, º≤≤°±‡¬Îø∆ “ C, º≤≤°±‡¬Îø∆ “ D" & vbNewLine & _
                "Where a.¿‡± = '" & IIF(strType = "", "B", strType) & "' And (a.≥∑µµ ±º‰ Is Null Or a.≥∑µµ ±º‰ = To_Date('3000-01-01', 'YYYY-MM-DD')) And c.º≤≤°id(+) = a.Id And" & vbNewLine & _
                "      d.º≤≤°id(+) = a.Id And c.ø∆ “id(+)=[7] And d.»À‘±id(+) = [6]" & vbNewLine & _
                IIF(str–‘± <> "", " And (A.–‘±œﬁ÷∆=[3] Or A.–‘±œﬁ÷∆ is NULL)", "") & _
                " And ( Nvl(A.  ”√∑∂Œß,0) = 0 or  A.  ”√∑∂Œß = 1) " & _
                " And (" & strSQL & ")" & _
                "Order By ≈≈–Ú1ID, ≈≈–Ú2ID, ≈≈–Ú3ID, ±‡¬Î"
        End If
    Else
        If opt’Ô∂œ(0).value Then
            '∞¥’Ô∂œ ‰»Î:Œ˜“Ω≤ø∑›£¨“ª∏ˆ’Ô∂œø…ƒ‹ Ù”⁄∂‡∏ˆ∑÷¿‡
            If zlCommFun.IsCharChinese(strInput) Then
                strSQL = "B.√˚≥∆ Like [2]" ' ‰»Î∫∫◊÷ ±,÷ª∆•≈‰√˚≥∆
            Else
                strSQL = "A.±‡¬Î Like [1] Or B.√˚≥∆ Like [2] Or B.ºÚ¬Î Like [2]"
            End If
            strSQL = _
                " Select Distinct A.ID,A.ID as œÓƒøID,A.±‡¬Î,Null as ¿‡±,A.√˚≥∆,A.Àµ√˜,A.±‡’ﬂ," & vbNewLine & _
                " Decode(b.√˚≥∆, [5], 1, Decode(b.ºÚ¬Î,[5],1,decode(a.±‡¬Î,[5],1,NULL))) As ≈≈–Ú1ID,Decode(d.’Ô∂œid, Null, Decode(c.’Ô∂œid, Null, Null, 2), 1) As ≈≈–Ú2ID," & vbNewLine & _
                " Decode(Substr(b.√˚≥∆, 1, Length([5])), [5], 1, Decode(Substr(b.ºÚ¬Î, 1, Length([5])),[5],1,decode(Substr(a.±‡¬Î, 1, Length([5])),[5],1,NULL))) As ≈≈–Ú3ID" & _
                " From º≤≤°’Ô∂œƒø¬º A,º≤≤°’Ô∂œ±√˚ B, º≤≤°’Ô∂œø∆ “ C, º≤≤°’Ô∂œø∆ “ D" & _
                " Where A.ID=B.’Ô∂œID And c.’Ô∂œid(+) = a.Id And d.’Ô∂œid(+) = a.Id And A.¿‡±=1" & _
                " And B.¬Î¿‡=[4] And d.»À‘±id(+) = [6] And c.ø∆ “id(+)=[7] And (a.≥∑µµ ±º‰ Is Null Or a.≥∑µµ ±º‰ = To_Date('3000-01-01', 'YYYY-MM-DD'))" & _
                " And ( Nvl(A.  ”√∑∂Œß,0) = 0 or  A.  ”√∑∂Œß = 1) " & _
                " And (" & strSQL & ")" & _
                " Order by ≈≈–Ú1ID, ≈≈–Ú2ID, ≈≈–Ú3ID,A.±‡¬Î"
                '≈≈–ÚÀ≥–Ú£∫œ» «ÕÍ»´∆•≈‰(√˚≥∆°¢ºÚ¬Î°¢±‡¬Î£©°¢∏ˆ»À ’≤ÿ°¢∆‰¥Œ «ø∆ “ ’≤ÿ°¢»ª∫Û «◊Û∆•≈‰(√˚≥∆°¢ºÚ¬Î°¢±‡¬Î£©°¢◊Ó∫Û «À´œÚ∆•≈‰
        Else
            'D-ICD-10º≤≤°±‡¬Î
            If zlCommFun.IsCharChinese(strInput) Then
                strSQL = "A.√˚≥∆ Like [2]" ' ‰»Î∫∫◊÷ ±,÷ª∆•≈‰√˚≥∆
            Else
                strSQL = "A.±‡¬Î Like [1] Or A.√˚≥∆ Like [2] Or " & IIF(mintºÚ¬Î = 0, "A.ºÚ¬Î", "A.ŒÂ± ¬Î") & " Like [2]"
            End If
            strSQL = _
                "Select Distinct a.Id, a.Id As œÓƒøid, a.±‡¬Î, a.¿‡±, a.∏Ω¬Î, a.√˚≥∆," & IIF(mintºÚ¬Î = 0, "A.ºÚ¬Î", "A.ŒÂ± ¬Î as ºÚ¬Î") & ", a.Àµ√˜," & _
                " Decode(a.√˚≥∆, [5], 1, Decode(" & IIF(mintºÚ¬Î = 0, "A.ºÚ¬Î", "A.ŒÂ± ¬Î") & ",[5],1,decode(a.±‡¬Î,[5],1,NULL))) As ≈≈–Ú1ID," & vbNewLine & _
                "                Decode(d.º≤≤°id, Null, Decode(c.º≤≤°id, Null, Null, 2), 1) As ≈≈–Ú2ID," & vbNewLine & _
                "                Decode(Substr(a.√˚≥∆, 1, Length([5])), [5], 1, Decode(Substr(" & IIF(mintºÚ¬Î = 0, "A.ºÚ¬Î", "A.ŒÂ± ¬Î") & ", 1, Length([5])),[5],1,decode(Substr(a.±‡¬Î, 1, Length([5])),[5],1,NULL))) As ≈≈–Ú3ID" & vbNewLine & _
                "From º≤≤°±‡¬Îƒø¬º A, º≤≤°±‡¬Îø∆ “ C, º≤≤°±‡¬Îø∆ “ D" & vbNewLine & _
                "Where a.¿‡± = 'D' And (a.≥∑µµ ±º‰ Is Null Or a.≥∑µµ ±º‰ = To_Date('3000-01-01', 'YYYY-MM-DD')) And c.º≤≤°id(+) = a.Id And" & vbNewLine & _
                "      d.º≤≤°id(+) = a.Id And c.ø∆ “id(+)=[7] And d.»À‘±id(+) = [6]" & vbNewLine & _
                IIF(str–‘± <> "", " And (A.–‘±œﬁ÷∆=[3] Or A.–‘±œﬁ÷∆ is NULL)", "") & _
                " And ( Nvl(A.  ”√∑∂Œß,0) = 0 or  A.  ”√∑∂Œß = 1) " & _
                " And (" & strSQL & ")" & _
                "Order By ≈≈–Ú1ID, ≈≈–Ú2ID, ≈≈–Ú3ID, ±‡¬Î"

        End If
    End If
    GetDiagSQL = strSQL
End Function

Private Sub vsDiag_ValidateEdit(ByVal Row As Long, ByVal Col As Long, Cancel As Boolean)
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String, blnCancel As Boolean
    Dim strInput As String, vPoint As PointAPI
    Dim str–‘± As String, int’Ô∂œ ‰»Î As Integer
    Dim str¿‡± As String
    
    On Error GoTo errH
    
    With vsDiag
        If Col = col’Ô∂œ Or Col = col÷–“Ω÷§∫Ú Then
            If .EditText = "" Then
                If .TextMatrix(Row, col±‡¬Î) <> "" And Col = col’Ô∂œ Then
                    .EditText = .Cell(flexcpData, Row, Col)
                Else
                    '÷–“Ω÷§∫Ú‘Ú«Â≥˝±∏∑› ˝æ›
                    If Col = col÷–“Ω÷§∫Ú Then
                        .Cell(flexcpData, Row, Col) = ""
                    End If
                End If
                If mblnReturn Then Call DiagEnterNextCell
            ElseIf .EditText = .Cell(flexcpData, Row, Col) Then
                If mblnReturn Then Call DiagEnterNextCell
            ElseIf Col = col’Ô∂œ And .TextMatrix(Row, col±‡¬Î) <> "" And .Cell(flexcpData, Row, Col) <> "" And .EditText Like "*" & .Cell(flexcpData, Row, Col) & "*" Then
                strInput = UCase(.EditText)
                strSQL = GetDiagSQL(Row, strInput, strSQL, str–‘±)
                On Error GoTo errH
                Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, strInput, strInput, str–‘±, mintºÚ¬Î + 1, strInput, UserInfo.ID, mlng≤°»Àø∆ “id)
                If rsTmp.RecordCount = 1 Then
                    Call SetDiagInput(Row, rsTmp, rsTmp!¿‡± & ""): .EditText = .Text
                Else
                    '‘ –Ì‘⁄±Í◊ºµƒ√˚≥∆«∞∫Û ‰»Î∏Ωº”–≈œ¢
                    .TextMatrix(Row, col’Ô∂œ) = .EditText
                    lbl’Ô∂œ.Tag = "1"
                    mblnNoSave = True
                End If
            ElseIf Col = col’Ô∂œ And .TextMatrix(Row, col±‡¬Î) <> "" And .Cell(flexcpData, Row, Col) <> "" And mblnFreeInput Then
                strInput = UCase(.EditText)
                strSQL = GetDiagSQL(Row, strInput, strSQL, str–‘±)
                On Error GoTo errH
                vPoint = GetCoordPos(.hWnd, .CellLeft + 15, .CellTop)
                Set rsTmp = zlDatabase.ShowSQLSelect(Me, strSQL, 0, IIF(opt’Ô∂œ(0).value, "º≤≤°’Ô∂œ", "º≤≤°±‡¬Î"), False, "", "", False, False, True, _
                    vPoint.X, vPoint.Y, .CellHeight, blnCancel, False, True, strInput & "%", mstrLike & strInput & "%", str–‘±, mintºÚ¬Î + 1, strInput, UserInfo.ID, mlng≤°»Àø∆ “id, "ColSet:¡–øÌ…Ë÷√|Àµ√˜,2400|–¸∏°Ã· æ|Àµ√˜")
                If blnCancel Then 'Œﬁ∆•≈‰ ‰»Î ±,∞¥»Œ“‚ ‰»Î¥¶¿Ì,»°œ˚≤ªÕ¨
                    Cancel = True
                Else
                    If rsTmp Is Nothing Then
                        .TextMatrix(Row, col’Ô∂œ) = .EditText
                        lbl’Ô∂œ.Tag = "1"
                        mblnNoSave = True
                    Else
                         Call SetDiagInput(Row, rsTmp, rsTmp!¿‡± & ""): .EditText = .Text
                    End If
                End If
            Else
                int’Ô∂œ ‰»Î = Val(Mid(gstr’Ô∂œ ‰»Î, 1, 1))
                If int’Ô∂œ ‰»Î = 0 Then int’Ô∂œ ‰»Î = 1
                
                If mstr–‘± Like "*ƒ–*" Then
                    str–‘± = "ƒ–"
                ElseIf mstr–‘± Like "*≈Æ*" Then
                    str–‘± = "≈Æ"
                End If
                                
                strInput = UCase(.EditText)
                
                strSQL = GetDiagSQL(Row, strInput, strSQL, str–‘±, IIF(Col = col’Ô∂œ, "B", "Z"))
                If Col = col’Ô∂œ Then
                    If int’Ô∂œ ‰»Î = 1 And zlCommFun.IsCharChinese(strInput) Then
                        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, strInput & "%", mstrLike & strInput & "%", str–‘±, mintºÚ¬Î + 1, strInput, UserInfo.ID, mlng≤°»Àø∆ “id)
                        If rsTmp.EOF Then
                            Set rsTmp = Nothing
                        ElseIf rsTmp.RecordCount > 1 Then
                            Set rsTmp = Nothing '◊‘”…¬º»Î ±”–∂‡∏ˆ∆•≈‰≤ªΩ¯––—°‘Ò
                        End If
                        If Not rsTmp Is Nothing Then str¿‡± = rsTmp!¿‡± & ""
                        Call SetDiagInput(Row, rsTmp, str¿‡±): .EditText = .Text
                        If mblnReturn Then Call DiagEnterNextCell
                    Else
                        vPoint = GetCoordPos(.hWnd, .CellLeft + 15, .CellTop)
                        Set rsTmp = zlDatabase.ShowSQLSelect(Me, strSQL, 0, IIF(opt’Ô∂œ(0).value, "º≤≤°’Ô∂œ", "º≤≤°±‡¬Î"), False, "", "", False, False, True, _
                            vPoint.X, vPoint.Y, .CellHeight, blnCancel, False, True, strInput & "%", mstrLike & strInput & "%", str–‘±, mintºÚ¬Î + 1, strInput, UserInfo.ID, mlng≤°»Àø∆ “id, "ColSet:¡–øÌ…Ë÷√|Àµ√˜,2400|–¸∏°Ã· æ|Àµ√˜")
                        If blnCancel Then 'Œﬁ∆•≈‰ ‰»Î ±,∞¥»Œ“‚ ‰»Î¥¶¿Ì,»°œ˚≤ªÕ¨
                            Cancel = True
                        Else
                            'ºÏ≤È’Ô∂œ ‰»Î∑Ω Ω
                            If rsTmp Is Nothing And (int’Ô∂œ ‰»Î = 2 Or int’Ô∂œ ‰»Î = 3 And mintœ’¿‡ <> 0) Then
                                MsgBox "√ª”–’“µΩ”Î ‰»Î∆•≈‰µƒƒ⁄»›°£", vbInformation, gstrSysName
                                Cancel = True
                            ElseIf Not (rsTmp Is Nothing) Then
                                Call SetDiagInput(Row, rsTmp, rsTmp!¿‡± & ""): .EditText = .Text
                                If mblnReturn Then Call DiagEnterNextCell
                            Else
                                '√ª”–∆•≈‰≥…π¶‘Ÿ¥Œµ±≥…◊‘”…¬º»Î
                                If int’Ô∂œ ‰»Î = 1 Or (int’Ô∂œ ‰»Î = 3 And (rsTmp Is Nothing) And mintœ’¿‡ = 0) Then
                                    Call SetDiagInput(Row, Nothing, str¿‡±): .EditText = .Text
                                    If mblnReturn Then Call DiagEnterNextCell
                                Else
                                    Cancel = True
                                End If
                            End If
                        End If
                    End If
                ElseIf Col = col÷–“Ω÷§∫Ú Then
                    If opt’Ô∂œ(0).value Then
                        '∞¥’Ô∂œ ‰»Î:œ»≤È «∑Ò”–∂‘”¶
                        If Set÷–“Ω÷§∫Ú(Row, Val(.TextMatrix(Row, col’Ô∂œID))) Then
                            mblnReturn = False
                            Exit Sub
                        End If
                    End If
                    vPoint = GetCoordPos(.hWnd, .CellLeft + 15, .CellTop)
                    Set rsTmp = zlDatabase.ShowSQLSelect(Me, strSQL, 0, "÷–“Ω÷§∫Ú", False, "", "", False, False, True, _
                        vPoint.X, vPoint.Y, .CellHeight, blnCancel, False, True, strInput & "%", gstrLike & strInput & "%", str–‘±, mintºÚ¬Î + 1, strInput, UserInfo.ID, mlng≤°»Àø∆ “id, "ColSet:¡–øÌ…Ë÷√|Àµ√˜,2400|–¸∏°Ã· æ|Àµ√˜")
                    If blnCancel Then 'Œﬁ∆•≈‰ ‰»Î ±,∞¥»Œ“‚ ‰»Î¥¶¿Ì,»°œ˚≤ªÕ¨
                        Cancel = True
                    Else
                        'ºÏ≤È’Ô∂œ ‰»Î∑Ω Ω
                        If rsTmp Is Nothing And (int’Ô∂œ ‰»Î = 2 Or int’Ô∂œ ‰»Î = 3 And mintœ’¿‡ <> 0) Then
                            MsgBox "√ª”–’“µΩ”Î ‰»Î∆•≈‰µƒƒ⁄»›°£", vbInformation, gstrSysName
                            Cancel = True
                        Else
                            Call Set÷–“Ω÷§∫Ú(Row, 0, rsTmp, rsTmp Is Nothing)
                        End If
                    End If
                End If
            End If
            mblnReturn = False
        ElseIf Col = col∑¢≤° ±º‰ Then
            If .EditText <> "" Then
                strInput = GetFullDate(.EditText)
                If IsDate(strInput) Then
                    .EditText = Format(strInput, "yyyy-MM-dd HH:mm")
                    mblnCancle = False
                Else
                    MsgBox "«Î ‰»Î’˝»∑µƒ∑¢≤° ±º‰£¨¿˝»Á£∫""2012-12-21 00:00""°£"
                    Cancel = True
                End If
            End If
            If .EditText <> .TextMatrix(Row, Col) Then mblnNoSave = True: lbl’Ô∂œ.Tag = "1"
        End If
        mblnCancle = Cancel
    End With
    Exit Sub
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Sub ShowDiagFlag(ByVal lngDiag As Long)
'π¶ƒ‹£∫œ‘ æ’Ô∂œ––À˘∂‘”¶πÿ¡™µƒ“Ω÷ˆ±Íº«
'≤Œ ˝£∫lngDiag=’Ô∂œ±Ì∏Òµ±«∞––
    Dim strALL As String, strCurr As String
    Dim lng◊ÈID As Long, i As Long
        
    With vsDiag
        For i = 1 To .Rows - 1
            If .TextMatrix(i, col“Ω÷ˆID) <> "" Then
                strALL = strALL & "," & .TextMatrix(i, col“Ω÷ˆID)
                If i = lngDiag Then
                    strCurr = .TextMatrix(i, col“Ω÷ˆID)
                End If
            End If
        Next
        strALL = Mid(strALL, 2)
    End With
    
    With vsAdvice
        .Redraw = flexRDNone
        Set .Cell(flexcpPicture, .FixedRows, COL_’Ô∂œ, .Rows - 1, COL_’Ô∂œ) = Nothing
        
        For i = .FixedRows To .Rows - 1
            If .RowData(i) <> 0 Then
                '√ø––∂º¥¶¿Ì£∫“˛≤ÿ––≤ªª·œ‘ æ£¨“ª≤¢∏¯“©∑« ◊––±ªOwnerDraw
                lng◊ÈID = IIF(Val(.TextMatrix(i, COL_œ‡πÿID)) <> 0, Val(.TextMatrix(i, COL_œ‡πÿID)), .RowData(i))
                If InStr("," & strCurr & ",", "," & lng◊ÈID & ",") > 0 Then
                    Set .Cell(flexcpPicture, i, COL_’Ô∂œ) = img16.ListImages("’Ô∂œ_µ±«∞").Picture
                ElseIf InStr("," & strALL & ",", "," & lng◊ÈID & ",") > 0 Then
                    Set .Cell(flexcpPicture, i, COL_’Ô∂œ) = img16.ListImages("’Ô∂œ_πÿ¡™").Picture
                End If
            End If
        Next
        
        .Cell(flexcpPictureAlignment, .FixedRows, COL_’Ô∂œ, .Rows - 1, COL_’Ô∂œ) = 4
        .Redraw = flexRDDirect
    End With
End Sub

Private Function GetDiagRow(ByVal lng“Ω÷ˆID As Long) As Long
'π¶ƒ‹£∫∑µªÿ÷∏∂®µƒ“Ω÷ˆÀ˘πÿ¡™µΩµƒ’Ô∂œ––
'≤Œ ˝£∫lng“Ω÷ˆID=“Ω÷ˆµƒ◊ÈID
'∑µªÿ£∫»Áπ˚√ª”–πÿ¡™£¨‘Ú∑µªÿ-1
    Dim i As Long
    
    With vsDiag
        For i = .FixedRows To .Rows - 1
            If .TextMatrix(i, col’Ô∂œ) <> "" Then
                If InStr("," & .TextMatrix(i, col“Ω÷ˆID) & ",", "," & lng“Ω÷ˆID & ",") > 0 Then
                    GetDiagRow = i: Exit Function
                End If
            End If
        Next
    End With
    
    GetDiagRow = -1
End Function

Private Sub SetDiagFlag(ByVal lngAdvice As Long, ByVal intFlag As Integer, Optional ByVal lngDiag As Long = -1)
'π¶ƒ‹£∫…Ë÷√÷∏∂®“Ω÷ˆ––”Îµ±«∞’Ô∂œ––πÿ¡™£¨ªÚ’ﬂ»°œ˚”Î’Ô∂œ––µƒπÿ¡™
'≤Œ ˝£∫lngAdvice=“Ω÷ˆ±Ì∏Òµ±«∞––
'      blnFlag=0-«Â≥˝,1-±Íº«
'      lngDiag= «∑Ò…Ë÷√Œ™”Î÷∏∂®’Ô∂œ––πÿ¡™£¨√ª”–÷∏∂® ±Œ™-1±Ì æ”Îµ±«∞’Ô∂œ––πÿ¡™
    Dim lngBegin As Long, lngEnd As Long
    Dim str“Ω÷ˆID As String, lng◊ÈID As Long
    Dim blnDo As Boolean, i As Long
    
    If vsAdvice.RowData(lngAdvice) = 0 Then Exit Sub
    '»Áπ˚ «“—æ≠∑¢ÀÕµƒ“Ω÷ˆ£¨÷ª◊ºπÿ¡™£¨≤ª◊º»°œ˚πÿ¡™
    If (intFlag = 0 Or intFlag = 1 And Not vsAdvice.Cell(flexcpPicture, lngAdvice, COL_’Ô∂œ) Is Nothing) And vsAdvice.TextMatrix(lngAdvice, COL_◊¥Ã¨) = "8" Then Exit Sub
    
    With vsAdvice
        'πÿ¡™ ˝æ›…Ë÷√
        lng◊ÈID = IIF(Val(.TextMatrix(lngAdvice, COL_œ‡πÿID)) <> 0, Val(.TextMatrix(lngAdvice, COL_œ‡πÿID)), .RowData(lngAdvice))
        With vsDiag
            ' ◊œ»»°œ˚µ±«∞“Ω÷ˆ––”Î»Œ∫Œ’Ô∂œ––µƒπÿ¡™
            For i = 1 To .Rows - 1
                str“Ω÷ˆID = .TextMatrix(i, col“Ω÷ˆID)
                If InStr("," & str“Ω÷ˆID & ",", "," & lng◊ÈID & ",") > 0 Then
                    str“Ω÷ˆID = Replace("," & str“Ω÷ˆID & ",", "," & lng◊ÈID & ",", ",")
                    If Left(str“Ω÷ˆID, 1) = "," Then str“Ω÷ˆID = Mid(str“Ω÷ˆID, 2)
                    If Right(str“Ω÷ˆID, 1) = "," Then str“Ω÷ˆID = Mid(str“Ω÷ˆID, 1, Len(str“Ω÷ˆID) - 1)
                    .TextMatrix(i, col“Ω÷ˆID) = str“Ω÷ˆID
                    
                    If intFlag = 0 Then blnDo = True
                End If
            Next
            
            '‘Ÿ…Ë÷√Œ™”Îµ±«∞’Ô∂œ––πÿ¡™
            If intFlag = 1 Then
                If lngDiag = -1 Then lngDiag = .Row
                
                If .TextMatrix(lngDiag, col’Ô∂œ) <> "" Then
                    str“Ω÷ˆID = .TextMatrix(lngDiag, col“Ω÷ˆID)
                    If InStr("," & str“Ω÷ˆID & ",", "," & lng◊ÈID & ",") = 0 Then
                        str“Ω÷ˆID = str“Ω÷ˆID & "," & lng◊ÈID
                        blnDo = True
                    End If
                    If Left(str“Ω÷ˆID, 1) = "," Then str“Ω÷ˆID = Mid(str“Ω÷ˆID, 2)
                    .TextMatrix(lngDiag, col“Ω÷ˆID) = str“Ω÷ˆID
                Else
                    '÷∏∂®“™πÿ¡™µƒ’Ô∂œ––Œﬁ’Ô∂œ ±£¨¥¶¿ÌŒ™Œﬁπÿ¡™µƒ–ßπ˚
                    intFlag = 0
                End If
            End If
        End With
        
        'ΩÁ√Êœ‘ æ«–ªª
        Call GetRowScope(lngAdvice, lngBegin, lngEnd)
        For i = lngBegin To lngEnd
            If .RowData(i) <> 0 And Val(.TextMatrix(i, COL_”§∂˘)) = cbo”§∂˘.ListIndex Then
                If intFlag = 1 Then
                    If lngDiag = vsDiag.Row Then
                        Set .Cell(flexcpPicture, i, COL_’Ô∂œ) = img16.ListImages("’Ô∂œ_µ±«∞").Picture
                    Else
                        Set .Cell(flexcpPicture, i, COL_’Ô∂œ) = img16.ListImages("’Ô∂œ_πÿ¡™").Picture
                    End If
                    .Cell(flexcpPictureAlignment, i, COL_’Ô∂œ) = 4
                ElseIf intFlag = 0 Then
                    Set .Cell(flexcpPicture, i, COL_’Ô∂œ) = Nothing
                End If
            End If
        Next
        
        If blnDo Then
            lbl’Ô∂œ.Tag = "1"
            mblnNoSave = True
        End If
    End With
End Sub

Private Function AdviceHaveDiag(ByVal lngAdvice As Long) As Long
'π¶ƒ‹£∫≈–∂œ÷∏∂®––µƒ“Ω÷ˆ «∑Ò“—πÿ¡™’Ô∂œ––
'≤Œ ˝£∫lngAdvice=“Ω÷ˆ±Ì∏Òµ±«∞––
'∑µªÿ£∫÷∏∂®“Ω÷ˆ––À˘æﬂÃÂπÿ¡™µƒ’Ô∂œ––£¨∑µªÿ-1±Ì æŒﬁπÿ¡™
    Dim lng◊ÈID As Long, i As Long
    
    AdviceHaveDiag = -1
    If vsAdvice.RowData(lngAdvice) = 0 Then Exit Function
    
    With vsAdvice
        lng◊ÈID = IIF(Val(.TextMatrix(lngAdvice, COL_œ‡πÿID)) <> 0, Val(.TextMatrix(lngAdvice, COL_œ‡πÿID)), .RowData(lngAdvice))
    End With
    
    With vsDiag
        For i = 1 To .Rows - 1
            If InStr("," & .TextMatrix(i, col“Ω÷ˆID) & ",", "," & lng◊ÈID & ",") > 0 Then
                AdviceHaveDiag = i: Exit Function
            End If
        Next
    End With
End Function

Private Sub SetDiagInput(ByVal lngRow As Long, rsInput As ADODB.Recordset, ByVal str¿‡± As String)
'π¶ƒ‹£∫¥¶¿Ì’Ô∂œœÓƒøµƒ ‰»Î
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String, blnCancel As Boolean
    Dim vPoint As PointAPI, i As Long
    Dim blnDo As Boolean
    Dim strTmp As String
    Dim lng‘≠’Ô∂œid As Long '0 ±Ì æ–¬ÃÌº”µƒ’Ô∂œ£¨ ≤ªŒ™0±Ì æ–ﬁ∏ƒ’Ô∂œ£¨lng‘≠’Ô∂œid µƒ÷µæÕ «–ﬁ∏ƒ«∞µƒ ’Ô∂œIDªÚº≤≤°ID
    Dim int’Ô∂œ¿‡–Õ As Integer
    
    On Error GoTo errH
    With vsDiag
        'ºÏ≤È «∑Ò‘ –Ì–ﬁ∏ƒ
        For i = 1 To vsAdvice.Rows - 1
            If InStr("," & .TextMatrix(.Row, col“Ω÷ˆID) & ",", "," & vsAdvice.RowData(i) & ",") > 0 And vsAdvice.TextMatrix(i, COL_◊¥Ã¨) = "8" Then
                MsgBox "∏√’Ô∂œ∂‘”¶µƒ¥¶∑Ω“—∑¢ÀÕ£¨≤ªƒ‹–ﬁ∏ƒ°£", vbInformation, Me.Caption
                Exit Sub
            End If
            
            '“Ωººπ§◊˜’æµ˜”√,»Ù’Ô∂œπÿ¡™“Ω÷ˆ,¥Ê‘⁄“Ω÷ˆµƒø™÷ˆ“Ω…˙∑«µ±«∞≤Ÿ◊˜‘±,‘Ú≤ª‘ –Ì–ﬁ∏ƒ’Ô∂œ
            If mint≥°∫œ = 2 And InStr("," & .TextMatrix(.Row, col“Ω÷ˆID) & ",", "," & vsAdvice.RowData(i) & ",") > 0 And vsAdvice.TextMatrix(i, COL_ø™÷ˆ“Ω…˙) <> UserInfo.–’√˚ Then
                MsgBox "∏√’Ô∂œ¥Ê‘⁄πÿ¡™“Ω÷ˆ,«“∏√“Ω÷ˆ∑«ƒ˙œ¬¥Ô£¨≤ªƒ‹–ﬁ∏ƒ°£", vbInformation, Me.Caption
                Exit Sub
            End If
        Next
        If Not rsInput Is Nothing Then
            int’Ô∂œ¿‡–Õ = IIF(.Cell(flexcpFontBold, lngRow, COLŒ˜“Ω), 1, 11)
            For i = 1 To rsInput.RecordCount
                If i > 1 Then
                    If .Rows > M_LNG_DIAGCOUNT Then Exit For
                    .AddItem "", lngRow + 1: lngRow = lngRow + 1
                    lng‘≠’Ô∂œid = 0
                Else
                    lng‘≠’Ô∂œid = Val(.TextMatrix(lngRow, col’Ô∂œID))
                End If
                
                If InStr(.TextMatrix(lngRow, col’Ô∂œ), "(") > 0 And InStr(.TextMatrix(lngRow, col’Ô∂œ), ")") > 0 Then
                    strTmp = Mid(.TextMatrix(lngRow, col’Ô∂œ), InStrRev(.TextMatrix(lngRow, col’Ô∂œ), "("))
                End If
                .TextMatrix(lngRow, col’Ô∂œ) = Nvl(rsInput!√˚≥∆) & strTmp
                
                '∏˘æ›’Ô∂œ»∑∂®º≤≤°,ªÚ∏˘æ›º≤≤°»∑∂®’Ô∂œ
                If opt’Ô∂œ(0).value Then
                    .TextMatrix(lngRow, col’Ô∂œID) = rsInput!œÓƒøID
                    .TextMatrix(lngRow, col’Ô∂œ±‡¬Î) = rsInput!±‡¬Î & ""
                    .TextMatrix(lngRow, colº≤≤°ID) = ""
                    strSQL = "Select º≤≤°ID as ID From º≤≤°’Ô∂œ∂‘’’ Where ’Ô∂œID=[1]"
                Else
                    .TextMatrix(lngRow, colº≤≤°ID) = rsInput!œÓƒøID
                    .TextMatrix(lngRow, colº≤≤°±‡¬Î) = rsInput!±‡¬Î & ""
                    .TextMatrix(lngRow, colº≤≤°¿‡±) = str¿‡±
                    .TextMatrix(lngRow, colº≤≤°∏Ω¬Î) = rsInput!∏Ω¬Î & ""
                    .TextMatrix(lngRow, col’Ô∂œID) = ""
                    strSQL = "Select ’Ô∂œID as ID From º≤≤°’Ô∂œ∂‘’’ Where º≤≤°ID=[1]"
                End If
                Set rsTmp = New ADODB.Recordset
                Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(rsInput!œÓƒøID))
                If Not rsTmp.EOF Then
                    If opt’Ô∂œ(0).value Then
                        .TextMatrix(lngRow, colº≤≤°ID) = Nvl(rsTmp!ID)
                        strSQL = "Select ±‡¬Î,∏Ω¬Î,¿‡± From º≤≤°±‡¬Îƒø¬º where id=[1]"
                        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(Nvl(rsTmp!ID)))
                        If Not rsTmp.EOF Then
                            .TextMatrix(lngRow, colº≤≤°±‡¬Î) = rsTmp!±‡¬Î & ""
                            .TextMatrix(lngRow, colº≤≤°¿‡±) = rsTmp!¿‡± & ""
                            .TextMatrix(lngRow, colº≤≤°∏Ω¬Î) = rsTmp!∏Ω¬Î & ""
                        End If
                    Else
                        .TextMatrix(lngRow, col’Ô∂œID) = Nvl(rsTmp!ID)
                        strSQL = "Select ±‡¬Î From º≤≤°’Ô∂œƒø¬º where id=[1]"
                        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(Nvl(rsTmp!ID)))
                        If Not rsTmp.EOF Then .TextMatrix(lngRow, col’Ô∂œ±‡¬Î) = rsTmp!±‡¬Î & ""
                    End If
                End If
                
                '÷–“Ω∏˘æ›º≤≤°’Ô∂œ≤Œøº»°÷§∫Ú
                If .Cell(flexcpData, lngRow, col÷–“Ω) = 1 Then
                    Call Set÷–“Ω÷§∫Ú(lngRow, Val(.TextMatrix(lngRow, col’Ô∂œID)))
                End If
                
                .TextMatrix(lngRow, col±‡¬Î) = IIF(Not IsNull(rsInput!±‡¬Î), rsInput!±‡¬Î, "")
                .Cell(flexcpData, lngRow, col’Ô∂œ) = .TextMatrix(lngRow, col’Ô∂œ)
                
                .Cell(flexcpData, lngRow, col“…’Ô) = 0
                .Cell(flexcpForeColor, lngRow, col“…’Ô) = .GridColor
                
                .TextMatrix(lngRow, colICD¬Î) = Nvl(rsInput!±‡¬Î)
                
                ' ‰»Î÷˜/¥Œ“™’Ô∂œ∫Ûµ˜”√Õ‚π“Ω”ø⁄
                If CreatePlugInOK(p√≈’Ô“Ω÷ˆœ¬¥Ô, mint≥°∫œ) Then
                    On Error Resume Next
                    If lngRow = .FixedRows Then
                        Call gobjPlugIn.DiagnosisEnter(glngSys, p√≈’Ô“Ω÷ˆœ¬¥Ô, mlng≤°»ÀID, mlngπ“∫≈ID, Val(.TextMatrix(lngRow, col’Ô∂œID)), .TextMatrix(lngRow, col’Ô∂œ), lng‘≠’Ô∂œid, mint≥°∫œ)
                        Call zlPlugInErrH(err, "DiagnosisEnter")
                    Else
                        Call gobjPlugIn.DiagnosisOtherEnter(glngSys, p√≈’Ô“Ω÷ˆœ¬¥Ô, mlng≤°»ÀID, mlngπ“∫≈ID, Val(.TextMatrix(lngRow, col’Ô∂œID)), .TextMatrix(lngRow, col’Ô∂œ), lng‘≠’Ô∂œid, mint≥°∫œ)
                        Call zlPlugInErrH(err, "DiagnosisOtherEnter")
                    End If
                    err.Clear: On Error GoTo 0
                End If
                Call SetDiagType(lngRow, int’Ô∂œ¿‡–Õ)
                rsInput.MoveNext
            Next
            
            Call SetDiagHeight
        Else
            .TextMatrix(lngRow, col’Ô∂œ) = .EditText
            .Cell(flexcpData, lngRow, col’Ô∂œ) = .TextMatrix(lngRow, col’Ô∂œ)
            
            .Cell(flexcpData, lngRow, col“…’Ô) = 0
            .Cell(flexcpForeColor, lngRow, col“…’Ô) = .GridColor
            
            .TextMatrix(lngRow, col±‡¬Î) = ""
            .TextMatrix(lngRow, col’Ô∂œID) = ""
            .TextMatrix(lngRow, colº≤≤°ID) = ""
            .TextMatrix(lngRow, colICD¬Î) = ""
        End If
        
        lbl’Ô∂œ.Tag = "1"
        mblnNoSave = True
    End With
    'PASS ’Ô∂œ¬º»Î
    If mblnPass Then
        zlPassDrags
    End If
    'Ω´±æ¥Œ¬º»Î…–Œ¥πÿ¡™’Ô∂œµƒ“Ω÷ˆ”Îµ±«∞’Ô∂œπÿ¡™
    If vsDiag.TextMatrix(lngRow, col’Ô∂œ) <> "" Then
        blnDo = False
        
        With vsAdvice
            For i = .FixedRows To .Rows - 1
                If .RowData(i) <> 0 And Val(.TextMatrix(i, COL_”§∂˘)) = cbo”§∂˘.ListIndex Then
                    If Val(.TextMatrix(i, COL_◊¥Ã¨)) = 1 And Val(.TextMatrix(i, COL_œ‡πÿID)) = 0 Then
                        If GetDiagRow(.RowData(i)) = -1 Then
                            Call SetDiagFlag(i, 1, lngRow)
                            blnDo = True
                        End If
                    End If
                End If
            Next
        End With
        
        If blnDo Then
            Call ShowDiagFlag(lngRow)
        End If
    End If
    Exit Sub
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Function Set÷–“Ω÷§∫Ú(ByVal lngRow As Long, ByVal lng’Ô∂œID As Long, Optional ByVal rsInput As Recordset, Optional ByVal blnFreeInput As Boolean) As Boolean
'π¶ƒ‹£∫÷–“Ω∏˘æ›º≤≤°’Ô∂œ≤Œøº»°÷§∫Ú
'≤Œ ˝£∫rsInput-»Áπ˚≤ªŒ™ø’£¨‘Ú ‰≥ˆ÷∏∂®µƒ÷–“©÷§∫Úº«¬ººØ
'      blnFreeInput  true - ◊‘”…¬º»Î
'∑µªÿ£∫ «∑Ò”–∂‘”¶πÿœµ
    Dim rsTmp As Recordset
    Dim strSQL As String
    Dim blnCancel As Boolean
    Dim vPoint As PointAPI
    Dim strTmp As String
    
    With vsDiag
        '»•µÙ“—”–µƒ÷§∫Ú
        If InStr(.TextMatrix(lngRow, col’Ô∂œ), "(") > 0 And InStr(.TextMatrix(lngRow, col’Ô∂œ), ")") > 0 Then
            strTmp = Mid(.TextMatrix(lngRow, col’Ô∂œ), 1, InStrRev(.TextMatrix(lngRow, col’Ô∂œ), "(") - 1)
        Else
            strTmp = .TextMatrix(lngRow, col’Ô∂œ)
        End If
        If blnFreeInput Then
            .TextMatrix(lngRow, col÷§∫ÚID) = ""
            .TextMatrix(lngRow, col÷§∫Ú±‡¬Î) = ""
            .TextMatrix(lngRow, col÷–“Ω÷§∫Ú) = .EditText
            .Cell(flexcpData, lngRow, col÷–“Ω÷§∫Ú) = .TextMatrix(lngRow, col÷–“Ω÷§∫Ú)
            mblnNoSave = True
            Exit Function
        Else
            If rsInput Is Nothing Then
                If lng’Ô∂œID <> 0 Then
                    strSQL = "Select Distinct a.÷§∫Ú–Ú∫≈ as ID,a.÷§∫ÚID,a.÷§∫Ú√˚≥∆,b.±‡¬Î as ÷§∫Ú±‡¬Î" & _
                        " From º≤≤°’Ô∂œ≤Œøº A,º≤≤°±‡¬Îƒø¬º B" & _
                        " Where a.÷§∫ÚID=b.ID(+) And a.’Ô∂œID=[1] And a.÷§∫Ú√˚≥∆ is Not NULL" & _
                        " Order by a.÷§∫Ú–Ú∫≈"
                    vPoint = GetCoordPos(.hWnd, .CellLeft + 15, .CellTop)
                    Set rsTmp = Nothing
                    Set rsTmp = zlDatabase.ShowSQLSelect(Me, strSQL, 0, "÷–“Ω÷§∫Ú", False, "", "", False, False, True, _
                        vPoint.X, vPoint.Y, .CellHeight, blnCancel, False, True, lng’Ô∂œID)
                    If Not rsTmp Is Nothing Then
                        .TextMatrix(lngRow, col÷§∫ÚID) = Nvl(rsTmp!÷§∫Úid)
                        .TextMatrix(lngRow, col÷§∫Ú±‡¬Î) = Nvl(rsTmp!÷§∫Ú±‡¬Î)
                        If Not IsNull(rsTmp!÷§∫Ú√˚≥∆) Then
                            .TextMatrix(lngRow, col’Ô∂œ) = strTmp
                            .Cell(flexcpData, lngRow, col’Ô∂œ) = .TextMatrix(lngRow, col’Ô∂œ)
                            .TextMatrix(lngRow, col÷–“Ω÷§∫Ú) = Nvl(rsTmp!÷§∫Ú√˚≥∆)
                            .Cell(flexcpData, lngRow, col÷–“Ω÷§∫Ú) = .TextMatrix(lngRow, col÷–“Ω÷§∫Ú)
                            If .EditText <> "" Then .EditText = .TextMatrix(lngRow, col÷–“Ω÷§∫Ú)
                            mblnNoSave = True
                        End If
                        Set÷–“Ω÷§∫Ú = True
                    Else
                        If blnCancel Then
                            Set÷–“Ω÷§∫Ú = True
                            If .EditText <> "" Then .EditText = .Cell(flexcpData, lngRow, col÷–“Ω÷§∫Ú)
                        Else
                            Set÷–“Ω÷§∫Ú = False
                        End If
                    End If
                Else
                    Set÷–“Ω÷§∫Ú = False
                End If
            Else
                .TextMatrix(lngRow, col÷§∫ÚID) = Nvl(rsInput!œÓƒøID)
                .TextMatrix(lngRow, col÷§∫Ú±‡¬Î) = Nvl(rsInput!±‡¬Î)
                .TextMatrix(lngRow, col’Ô∂œ) = strTmp
                .Cell(flexcpData, lngRow, col’Ô∂œ) = .TextMatrix(lngRow, col’Ô∂œ)
                .TextMatrix(lngRow, col÷–“Ω÷§∫Ú) = Nvl(rsInput!√˚≥∆)
                .Cell(flexcpData, lngRow, col÷–“Ω÷§∫Ú) = .TextMatrix(lngRow, col÷–“Ω÷§∫Ú)
                If .EditText <> "" Then .EditText = .TextMatrix(lngRow, col÷–“Ω÷§∫Ú)
                mblnNoSave = True
            End If
        End If
    End With
End Function

Private Sub DiagEnterNextCell()
    Dim i As Long, j As Long
    
    With vsDiag
        '¥”œ¬“ªµ•‘™ø™ º—≠ª∑À—À˜
        For i = .Row To .Rows - 1
            For j = IIF(i = .Row, .Col + 1, col’Ô∂œ) To col‘ˆº”
                If DiagCellEditable(i, j) And .ColWidth(j) <> 0 Then Exit For
            Next
            If j <= col‘ˆº” Then Exit For
        Next
        If i <= .Rows - 1 Then
            .Row = i: .Col = j
        Else
            If txt“Ω÷ˆƒ⁄»›.Enabled And txt“Ω÷ˆƒ⁄»›.Visible Then
                txt“Ω÷ˆƒ⁄»›.SetFocus
            Else
                Call zlCommFun.PressKey(vbKeyTab)
            End If
        End If
    End With
End Sub

Private Function DiagCellEditable(ByVal lngRow As Long, ByVal lngCol As Long) As Boolean
    Dim i As Long
    
    With vsDiag
        If .ColHidden(lngCol) Then Exit Function
        If .TextMatrix(lngRow, col“Ω÷ˆID) <> "" Then
            If lngCol = col’Ô∂œ Then
                For i = 1 To vsAdvice.Rows - 1
                    If InStr("," & .TextMatrix(lngRow, col“Ω÷ˆID) & ",", "," & vsAdvice.RowData(i) & ",") > 0 And vsAdvice.TextMatrix(i, COL_◊¥Ã¨) = "8" Then
                        Exit Function
                    End If
                    '“Ωººπ§◊˜’æµ˜”√,»Ù’Ô∂œπÿ¡™“Ω÷ˆ,¥Ê‘⁄“Ω÷ˆµƒø™÷ˆ“Ω…˙∑«µ±«∞≤Ÿ◊˜‘±,‘Ú≤ª‘ –Ì…æ≥˝’Ô∂œ
                    If mint≥°∫œ = 2 And InStr("," & .TextMatrix(lngRow, col“Ω÷ˆID) & ",", "," & vsAdvice.RowData(i) & ",") > 0 And vsAdvice.TextMatrix(i, COL_ø™÷ˆ“Ω…˙) <> UserInfo.–’√˚ Then
                        Exit Function
                    End If
                Next
            End If
        End If
        '±ÿ–Îœ» ‰»Î’Ô∂œ
        If .TextMatrix(lngRow, col’Ô∂œ) = "" Then
            If lngCol = col“…’Ô Or lngCol = col‘ˆº” Or lngCol = col∑¢≤° ±º‰ Then
                Exit Function
            End If
        End If
        If lngCol = col±‡¬Î Then Exit Function
        '±ÿ–Îœ» ‰’Ô∂œ‘Ÿ ‰÷§∫Ú
        If lngCol = col÷–“Ω÷§∫Ú Then
            If .TextMatrix(lngRow, col’Ô∂œ) = "" Then Exit Function
            If .Cell(flexcpData, lngRow, col÷–“Ω) <> 1 Then Exit Function
        End If
    End With
    DiagCellEditable = True
End Function

Private Sub GetAgentInfo()
'π¶ƒ‹£∫∂¡»°¥˙∞Ï»À–≈œ¢
    Dim rsTmp As ADODB.Recordset
    
    gstrSQL = "Select c.–≈œ¢√˚, c.–≈œ¢÷µ" & vbNewLine & _
                "  From ≤°»À–≈œ¢¥”±Ì C" & vbNewLine & _
                "  Where c.æÕ’Ôid = [2] And c.≤°»Àid = [1] And Instr(',¥˙∞Ï»À–’√˚,¥˙∞Ï»À…Ì∑›÷§∫≈,≤°»À…Ì∑›÷§∫≈,',','||c.–≈œ¢√˚||',')>0"
    On Error GoTo errH
    Set rsTmp = zlDatabase.OpenSQLRecord(gstrSQL, Me.Caption, mlng≤°»ÀID, mlngπ“∫≈ID)
    
    AgentInfo.±æ¥ŒæÕ’Ô“—¬º»Î = False
    AgentInfo.¥˙∞Ï»À–’√˚ = ""
    AgentInfo.¥˙∞Ï»À…Ì∑›÷§∫≈ = ""
    If rsTmp.EOF Then Exit Sub
    
    AgentInfo.±æ¥ŒæÕ’Ô“—¬º»Î = True
    While Not rsTmp.EOF
        Select Case Nvl(rsTmp!–≈œ¢√˚)
            Case "¥˙∞Ï»À–’√˚"
                AgentInfo.¥˙∞Ï»À–’√˚ = Nvl(rsTmp!–≈œ¢÷µ)
            Case "¥˙∞Ï»À…Ì∑›÷§∫≈"
                AgentInfo.¥˙∞Ï»À…Ì∑›÷§∫≈ = Nvl(rsTmp!–≈œ¢÷µ)
        End Select
        rsTmp.MoveNext
    Wend
    Exit Sub
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Sub

Private Sub SetDiagHeight()
    vsDiag.Height = vsDiag.Rows * vsDiag.RowHeightMin + IIF(mbytSize = 0, 2, 12) * Screen.TwipsPerPixelY
    fra’Ô∂œ.Height = vsDiag.Height + 4 * Screen.TwipsPerPixelY + IIF(mbytSize = 0, 50, 0)
    Call Form_Resize
End Sub



Private Sub vsAdvice_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)
    Dim lngRow As Long
    
    'Pass
    If Button = 2 Then
        With vsAdvice
            lngRow = .MouseRow
            If lngRow >= .FixedRows And lngRow <= .Rows - 1 Then
                If Not .RowHidden(lngRow) Then .Row = lngRow
            End If
        End With
    End If
End Sub

Private Sub vsAdvice_MouseUp(Button As Integer, Shift As Integer, X As Single, Y As Single)
    Dim objPopup As CommandBarPopup
    Dim blnDo As Boolean
    
    If Button = 2 Then
        If cbsMain Is Nothing Then Exit Sub
        Set objPopup = cbsMain.ActiveMenuBar.FindControl(, conMenu_EditPopup)
        If mblnPass = False Then
            blnDo = True
        Else
            blnDo = gobjPass.PassType = 2 Or gobjPass.PassType = 4 Or (gobjPass.PassType = 1 And gobjPass.PassVersion = "4.0")
            '√≈’Ô±‡º≠ΩÁ√Ê≤Àµ•º∂ ˝±»“Ω…˙’æ…Ÿ“ªº∂
            If Not blnDo Then
                If gobjPass.zlPassCheck(mobjPassMap) Then
                    Call gobjPass.zlPASSPopupCommandBars(mobjPassMap, objPopup.CommandBar, conMenu_Edit_MediAudit)
                End If
            End If
        End If
        If gobjPlugIn Is Nothing And blnDo And gobjDrugExplain Is Nothing Then Exit Sub 'µ±µØ≥ˆ√ª”–≤Àµ•œÓƒø ±ª·œ‘ æ“ª∏ˆø’∞◊–°∑ΩøÈ
        If Not objPopup Is Nothing Then
            objPopup.CommandBar.ShowPopup
        End If
    End If
    
End Sub

Private Sub ExePlugIn(ByVal strName As String)
'π¶ƒ‹£∫÷¥––Õ‚π“π¶ƒ‹
    Dim lngID As String
    
    If CreatePlugInOK(p√≈’Ô“Ω÷ˆœ¬¥Ô, mint≥°∫œ) Then
        With vsAdvice
            lngID = .RowData(.Row)
            If InStr(",1,2,", Val(.TextMatrix(.Row, COL_EDIT))) > 0 Then
                If MsgBox("µ±«∞—°÷–µƒ“Ω÷ˆŒ¥±£¥Ê£¨ «∑Òœ»±£¥Ê£ø", vbQuestion + vbYesNo + vbDefaultButton1, gstrSysName) = vbNo Then
                    Exit Sub
                End If
                cbsMain.FindControl(, conMenu_Save, True, True).Execute: Exit Sub
            End If
        End With
        On Error Resume Next
        Call gobjPlugIn.ExecuteFunc(glngSys, p√≈’Ô“Ω÷ˆœ¬¥Ô, strName, mlng≤°»ÀID, mlngπ“∫≈ID, lngID, mlng«∞Ã·ID, mint≥°∫œ)
        Call zlPlugInErrH(err, "ExecuteFunc")
        err.Clear: On Error GoTo 0
    End If
End Sub

Private Function CheckInHosAdvice() As Boolean
'π¶ƒ‹£∫ºÏ≤Èµ±«∞≤°»À «∑Ò¥Ê‘⁄”––ßµƒ¡Ùπ€ªÚ◊°‘∫“Ω÷ˆ
'≤Œ ˝£∫
    Dim strSQL As String, rsTmp As ADODB.Recordset
    Dim i As Long, intDays As Integer
    
    On Error GoTo errH
    With vsAdvice
        For i = .FixedRows To .Rows - 1
            If .RowData(i) <> 0 And Not .RowHidden(i) Then
                If .TextMatrix(i, COL_EDIT) = "1" And i <> .Row Then
                    If .TextMatrix(i, COL_≤Ÿ◊˜¿‡–Õ) = "1" Or .TextMatrix(i, COL_≤Ÿ◊˜¿‡–Õ) = "2" Then
                        CheckInHosAdvice = True
                        Exit Function
                    End If
                End If
            End If
        Next
    End With
     
    strSQL = "Select Trunc(Sysdate - »Î‘∫»’∆⁄) ÃÏ ˝ From ≤°∞∏÷˜“≥ Where ≤°»Àid = [1] And ÷˜“≥id = 0"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng≤°»ÀID)
    If rsTmp.RecordCount > 0 Then
        intDays = IIF(gint∆’Õ®π“∫≈ÃÏ ˝ > gintº±’Ôπ“∫≈ÃÏ ˝, gint∆’Õ®π“∫≈ÃÏ ˝, gintº±’Ôπ“∫≈ÃÏ ˝)
        If intDays = 0 Then intDays = 1
        If rsTmp!ÃÏ ˝ <= intDays Then   '“Ω÷ˆ∑¢ÀÕ ±‘Ÿ…æ≥˝‘§‘ºµ«º«£®71009£©
            If MsgBox("¥Ê‘⁄æ…µƒ‘§‘º…Í«Î£¨≤˙…˙–¬µƒ‘§‘º…Í«Î ±±ÿ–Î“™…æ≥˝æ…µƒ£¨ «∑ÒºÃ–¯£ø", vbQuestion + vbYesNo + vbDefaultButton1, Me.Caption) = vbNo Then
                CheckInHosAdvice = True
                Exit Function
            End If
        End If
    End If
    
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function

Private Sub AdviceRSAddRow(ByRef rsAdvice As ADODB.Recordset, ByVal i As Long)
'π¶ƒ‹£∫∏˘æ›÷∏∂®––µƒ–≈œ¢∏¥÷∆≤˙…˙“Ω÷ˆº«¬ººØµƒ“ª–– ˝æ›
    Dim lng◊ÈID As Long, lngº≤≤°ID As Long, j As Long
    
    'ªÒ»°º≤≤°ID
    With vsDiag
        lng◊ÈID = IIF(Val(vsAdvice.TextMatrix(i, COL_œ‡πÿID)) = 0, vsAdvice.RowData(i), Val(vsAdvice.TextMatrix(i, COL_œ‡πÿID)))
        For j = .FixedRows To .Rows - 1
            If InStr("," & .TextMatrix(j, col“Ω÷ˆID) & ",", "," & lng◊ÈID & ",") > 0 Then
                lngº≤≤°ID = Val(.TextMatrix(j, colº≤≤°ID))
                Exit For
            End If
        Next
    End With
    
    With vsAdvice
        rsAdvice.AddNew
        rsAdvice!ID = .RowData(i)
        rsAdvice!œ‡πÿID = Val("" & .TextMatrix(i, COL_œ‡πÿID))
        rsAdvice!«∞Ã·ID = mlng«∞Ã·ID
        rsAdvice!≤°»À¿¥‘¥ = 1
        rsAdvice!≤°»ÀID = mlng≤°»ÀID
        rsAdvice!π“∫≈µ• = mstrπ“∫≈µ•
        
        rsAdvice!”§∂˘ = Val("" & .TextMatrix(i, COL_”§∂˘))
        rsAdvice!–’√˚ = mstr–’√˚
        rsAdvice!–‘± = mstr–‘±
        rsAdvice!ƒÍ¡‰ = mintƒÍ¡‰
        rsAdvice!≤°»Àø∆ “id = mlng≤°»Àø∆ “id
        
        rsAdvice!–Ú∫≈ = .TextMatrix(i, COL_–Ú∫≈)
        rsAdvice!“Ω÷ˆ◊¥Ã¨ = .TextMatrix(i, COL_◊¥Ã¨)
        rsAdvice!“Ω÷ˆ∆⁄–ß = 1
        rsAdvice!’Ô¡∆¿‡± = .TextMatrix(i, COL_¿‡±)
        rsAdvice!’Ô¡∆œÓƒøID = Val("" & .TextMatrix(i, COL_’Ô¡∆œÓƒøID))
        rsAdvice!±Í±æ≤øŒª = .TextMatrix(i, COL_±Í±æ≤øŒª)
        rsAdvice!ºÏ≤È∑Ω∑® = .TextMatrix(i, COL_ºÏ≤È∑Ω∑®)
        
        rsAdvice! ’∑—œ∏ƒøID = Val("" & .TextMatrix(i, COL_ ’∑—œ∏ƒøID))
        rsAdvice!ÃÏ ˝ = Val("" & .TextMatrix(i, COL_ÃÏ ˝))
        rsAdvice!µ•¥Œ”√¡ø = Val("" & .TextMatrix(i, COL_µ•¡ø))
        rsAdvice!◊‹∏¯”Ë¡ø = Val("" & .TextMatrix(i, COL_◊‹¡ø))
        rsAdvice!“Ω÷ˆƒ⁄»› = .TextMatrix(i, col_“Ω÷ˆƒ⁄»›)
        rsAdvice!“Ω…˙÷ˆÕ– = .TextMatrix(i, COL_“Ω…˙÷ˆÕ–)
        rsAdvice!÷¥––ø∆ “ID = Val("" & .TextMatrix(i, COL_÷¥––ø∆ “ID))
        rsAdvice!÷¥––∆µ¥Œ = .TextMatrix(i, COL_∆µ¬ )
        rsAdvice!∆µ¬ ¥Œ ˝ = Val("" & .TextMatrix(i, COL_∆µ¬ ¥Œ ˝))
        rsAdvice!∆µ¬ º‰∏Ù = Val("" & .TextMatrix(i, COL_∆µ¬ º‰∏Ù))
        rsAdvice!º‰∏Ùµ•Œª = .TextMatrix(i, COL_º‰∏Ùµ•Œª)
        rsAdvice!÷¥–– ±º‰∑Ω∞∏ = .TextMatrix(i, COL_÷¥–– ±º‰)
        rsAdvice!º∆º€Ãÿ–‘ = Val("" & .TextMatrix(i, COL_º∆º€–‘÷ ))
        rsAdvice!÷¥–––‘÷  = Val("" & .TextMatrix(i, COL_÷¥–––‘÷ ))
        rsAdvice!÷¥––±Íº« = Val("" & .TextMatrix(i, COL_÷¥––±Íº«))
                    
        rsAdvice!ø…∑Ò∑÷¡„ = Val("" & .TextMatrix(i, COL_ø…∑Ò∑÷¡„))
        rsAdvice!ΩÙº±±Í÷æ = Val("" & .TextMatrix(i, COL_±Í÷æ))
        rsAdvice!ø™ º÷¥–– ±º‰ = .TextMatrix(i, COL_ø™ º ±º‰)
        rsAdvice!ø™÷ˆø∆ “id = Val("" & .TextMatrix(i, COL_ø™÷ˆø∆ “ID))
        rsAdvice!ø™÷ˆ“Ω…˙ = .TextMatrix(i, COL_ø™÷ˆ“Ω…˙)
        rsAdvice!ø™÷ˆ ±º‰ = CDate(.TextMatrix(i, COL_ø™÷ˆ ±º‰))
        rsAdvice!’™“™ = .Cell(flexcpData, i, COL_“Ω…˙÷ˆÕ–)
        rsAdvice!º≤≤°id = lngº≤≤°ID
        rsAdvice!EditState = Val(.TextMatrix(i, COL_EDIT)) '1-–¬‘ˆ£¨2£≠–ﬁ∏ƒ
        rsAdvice!”√“©ƒøµƒ = Val("" & .TextMatrix(i, COL_”√“©ƒøµƒ))     '1-‘§∑¿,2-÷Œ¡∆
        rsAdvice!”√“©¿Ì”… = .TextMatrix(i, COL_”√“©¿Ì”…)
        rsAdvice.Update
    End With
End Sub

Private Function zlPluginAdviceEnter(ByVal lngRow As Long) As Boolean
'π¶ƒ‹£∫ ‰»Î“Ω÷ˆÕÍ≥…∫Ûµ˜”√Õ‚π“Ω”ø⁄
    Dim lngBegin As Long, lngEnd As Long, i As Long
    Dim rsAdvice As ADODB.Recordset
    
    Set rsAdvice = GetAdviceRs
    
    Call GetRowScope(lngRow, lngBegin, lngEnd)
    For i = lngBegin To lngEnd
        Call AdviceRSAddRow(rsAdvice, i)
    Next
    If rsAdvice.RecordCount > 0 Then rsAdvice.MoveFirst
    Call CreatePlugInOK(p√≈’Ô“Ω÷ˆœ¬¥Ô, mint≥°∫œ)
    On Error Resume Next
    zlPluginAdviceEnter = gobjPlugIn.AdviceEnter(glngSys, p√≈’Ô“Ω÷ˆœ¬¥Ô, mlng≤°»ÀID, mlngπ“∫≈ID, rsAdvice, mint≥°∫œ)
    If err.Number <> 0 And zlPluginAdviceEnter = False Then zlPluginAdviceEnter = True
    Call zlPlugInErrH(err, "AdviceEnter")
    err.Clear: On Error GoTo 0
End Function

Private Function zlPluginAdviceSave() As Boolean
'π¶ƒ‹£∫“Ω÷ˆ±£¥Ê«∞µ˜”√Õ‚π“Ω”ø⁄
    Dim i As Long
    Dim rsAdvice As ADODB.Recordset
    Dim lngBegin As Long, lngEnd As Long
    Dim rsTmp As ADODB.Recordset
    Set rsAdvice = GetAdviceRs
    With vsAdvice
        '“Ω÷ˆ¬º»ÎÕÍ≥…÷Æ∫Û÷±Ω”±£¥Êø…ƒ‹µºµΩµ±«∞’‚––“Ω÷ˆ√ª”–µ˜”√µΩÕ‚π“ AdviceEditAfter¥À¥¶‘Ÿµ˜”√“ª¥Œ°£
        i = .Row
        If .RowData(i) <> 0 And (Val(.TextMatrix(i, COL_EDIT)) = 1 Or Val(.TextMatrix(i, COL_EDIT)) = 2) Then
            Set rsTmp = zlDatabase.zlCopyDataStructure(rsAdvice)
            Call GetRowScope(i, lngBegin, lngEnd)
            For i = lngBegin To lngEnd
                Call AdviceRSAddRow(rsTmp, i)
            Next
            If rsTmp.RecordCount > 0 Then rsTmp.MoveFirst
        End If
        For i = .FixedRows To .Rows - 1
            '–¬‘ˆªÚ–ﬁ∏ƒµƒ”––ß––(∑«ø’––)
            If .RowData(i) <> 0 And (.TextMatrix(i, COL_EDIT) = "2" Or .TextMatrix(i, COL_EDIT) = "1") Then
                Call AdviceRSAddRow(rsAdvice, i)
            End If
        Next
    End With
    If rsAdvice.RecordCount > 0 Then rsAdvice.MoveFirst
    Call CreatePlugInOK(p√≈’Ô“Ω÷ˆœ¬¥Ô, mint≥°∫œ)
    On Error Resume Next
    If Not (rsTmp Is Nothing) Then
        If rsTmp.RecordCount > 0 Then
            Call gobjPlugIn.AdviceEditAfter(glngSys, p√≈’Ô“Ω÷ˆœ¬¥Ô, mlng≤°»ÀID, mlngπ“∫≈ID, rsTmp, mint≥°∫œ)
            Call zlPlugInErrH(err, "AdviceEditAfter")
        End If
    End If
    zlPluginAdviceSave = gobjPlugIn.AdviceSave(glngSys, p√≈’Ô“Ω÷ˆœ¬¥Ô, mlng≤°»ÀID, mlngπ“∫≈ID, rsAdvice, mint≥°∫œ)
    If err.Number <> 0 And zlPluginAdviceSave = False Then zlPluginAdviceSave = True
    Call zlPlugInErrH(err, "AdviceSave")
    err.Clear: On Error GoTo 0
End Function

Private Sub zlPluginAdviceRowChange(ByVal lngRow As Long, Optional ByVal intType As Integer)
'π¶ƒ‹£∫“Ω÷ˆ«–ªª––∫Ûµ˜”√Õ‚π“Ω”ø⁄
    Dim lngBegin As Long, lngEnd As Long, i As Long
    Dim rsAdvice As ADODB.Recordset
    
    If Val(vsAdvice.RowData(lngRow)) = 0 Then Exit Sub
    Set rsAdvice = GetAdviceRs
    
    Call GetRowScope(lngRow, lngBegin, lngEnd)
    For i = lngBegin To lngEnd
        Call AdviceRSAddRow(rsAdvice, i)
    Next
    If rsAdvice.RecordCount > 0 Then rsAdvice.MoveFirst
    Call CreatePlugInOK(p√≈’Ô“Ω÷ˆœ¬¥Ô, mint≥°∫œ)
    On Error Resume Next
    If intType = 0 Then
        Call gobjPlugIn.AdviceRowChange(glngSys, p√≈’Ô“Ω÷ˆœ¬¥Ô, mlng≤°»ÀID, mlngπ“∫≈ID, rsAdvice, mint≥°∫œ)
        Call zlPlugInErrH(err, "AdviceRowChange")
    Else
        Call gobjPlugIn.AdviceEditAfter(glngSys, p√≈’Ô“Ω÷ˆœ¬¥Ô, mlng≤°»ÀID, mlngπ“∫≈ID, rsAdvice, mint≥°∫œ)
        Call zlPlugInErrH(err, "AdviceEditAfter")
    End If
    If err.Number <> 0 Then err.Clear
End Sub

Private Function CheckBackNo(ByVal strπ“∫≈µ• As String) As Boolean
'π¶ƒ‹£∫ºÏ≤È «∑Ò“—æ≠ÕÀ∫≈£¨ªÚ’ﬂ «∑Ò“—æ≠»°œ˚Ω”’Ô
    Dim rsTmp As ADODB.Recordset
    Dim strSQL As String
    
    strSQL = "Select ID From ≤°»Àπ“∫≈º«¬º Where ÷¥––◊¥Ã¨ In (0, -1) And NO = [1] And º«¬º–‘÷ =1 And º«¬º◊¥Ã¨=1"
    On Error GoTo errH
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, "zl_AdviceSendCheck", strπ“∫≈µ•)
    If rsTmp.RecordCount > 0 Then
        MsgBox "≤ªƒ‹≤Ÿ◊˜√ª”–æÕ’Ôµƒ≤°»À°£", vbInformation, "√≈’Ô“Ω÷ˆ±‡º≠"
        Exit Function
    End If
    
    strSQL = "Select ID From √≈’Ô∑—”√º«¬º Where º«¬º–‘÷ =4 And º«¬º◊¥Ã¨=2 And NO = [1]"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, "zl_AdviceSendCheck", strπ“∫≈µ•)
    If rsTmp.RecordCount > 0 Then
        MsgBox "≤ªƒ‹≤Ÿ◊˜“—æ≠ÕÀ∫≈µƒ≤°»À°£", vbInformation, "√≈’Ô“Ω÷ˆ±‡º≠"
        Exit Function
    End If
    CheckBackNo = True
    
    Exit Function
errH:
    If ErrCenter() = 1 Then Resume
    Call SaveErrLog
End Function


Private Sub Set∞≤≈≈ ±º‰(ByVal strType As String)
'π¶ƒ‹£∫…Ë÷√ ÷ ıªÚ ‰—™“Ω÷ˆµƒ∞≤≈≈ ±º‰Œª÷√
'≤Œ ˝£∫strType=F- ÷ ı,K- ‰—™

    If strType = "F" Then
        lbl∞≤≈≈ ±º‰.Caption = " ÷ ı ±º‰"
        lbl∞≤≈≈ ±º‰.Top = lbl”√∑®.Top
        txt∞≤≈≈ ±º‰.Top = txt”√∑®.Top
    
        lbl∞≤≈≈ ±º‰.Left = lbl“Ω÷ˆƒ⁄»›.Left
        txt∞≤≈≈ ±º‰.Left = txt”√∑®.Left
    Else
        lbl∞≤≈≈ ±º‰.Caption = " ‰—™ ±º‰"
        lbl∞≤≈≈ ±º‰.Top = lblø™ º ±º‰.Top
        txt∞≤≈≈ ±º‰.Top = txtø™ º ±º‰.Top
    
        lbl∞≤≈≈ ±º‰.Left = lbl“Ω…˙÷ˆÕ–.Left
        txt∞≤≈≈ ±º‰.Left = cbo“Ω…˙÷ˆÕ–.Left
        
        'SetItemEditable÷–…Ë÷√¡Àœ‘ æ°∞∞≤≈≈ ±º‰°±æÕ≤ªœ‘ æ°∞”√∑®°±
        lbl”√∑®.Visible = True
        txt”√∑®.Visible = True
        cmd”√∑®.Visible = True
    End If
    
    cmd∞≤≈≈ ±º‰.Top = txt∞≤≈≈ ±º‰.Top + 30
    cmd∞≤≈≈ ±º‰.Left = txt∞≤≈≈ ±º‰.Left + txt∞≤≈≈ ±º‰.Width - cmd∞≤≈≈ ±º‰.Width - 30
End Sub


Private Sub SetCbo÷¥–––‘÷ (ByVal bln∫¨◊‘±∏“© As Boolean, ByVal bln¡Ÿ¥≤◊‘π‹“© As Boolean)
    cbo÷¥–––‘÷ .Clear
    
    If bln¡Ÿ¥≤◊‘π‹“© Then
        cbo÷¥–––‘÷ .AddItem "1-◊‘±∏“©"
    Else
        cbo÷¥–––‘÷ .AddItem "0-’˝≥£"
        If bln∫¨◊‘±∏“© Then cbo÷¥–––‘÷ .AddItem "1-◊‘±∏“©"
        cbo÷¥–––‘÷ .AddItem "2-¿Î‘∫¥¯“©"
    End If
End Sub


Private Sub txt”√“©¿Ì”…_GotFocus()
    zlControl.TxtSelAll txt”√“©¿Ì”…
    Call zlCommFun.OpenIme(True)
End Sub

Private Sub txt”√“©¿Ì”…_LostFocus()
    Call zlCommFun.OpenIme(False)
End Sub

Private Sub txt”√“©¿Ì”…_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        KeyAscii = 0
        If txt”√“©¿Ì”….Text <> "" And vsAdvice.TextMatrix(vsAdvice.Row, COL_¿‡±) <> "K" Then
            If ReasonSelect(txt”√“©¿Ì”….Text, 1) Then Exit Sub
        End If
        If SeekNextControl Then Call txt”√“©¿Ì”…_Validate(False)
    End If
End Sub

Private Sub txt”√“©¿Ì”…_Change()
    txt”√“©¿Ì”….Tag = "1"
End Sub

Private Sub txt”√“©¿Ì”…_Validate(Cancel As Boolean)
    If zlCommFun.ActualLen(txt”√“©¿Ì”….Text) > 1000 Then
        MsgBox " ‰»Îƒ⁄»›≤ªπ˝≥¨π˝ 500 ∏ˆ∫∫◊÷ªÚ 1000 ∏ˆ◊÷∑˚°£", vbInformation, gstrSysName
        txt”√“©¿Ì”…_GotFocus
        Cancel = True: Exit Sub
    End If
    
    '∏¸–¬ ˝æ›
    Call AdviceChange
End Sub

Private Sub cboDruPur_Click()
    lbl”√“©ƒøµƒ.Tag = "1"
    Call AdviceChange
End Sub

Private Sub cboDruPur_KeyPress(KeyAscii As Integer)
    If KeyAscii = 13 Then
        KeyAscii = 0
        SeekNextControl
    End If
End Sub

Private Sub SetRow±Í÷æÕº±Í(ByVal i As Long, Optional ByVal bytMode As Byte)
'π¶ƒ‹£∫∏˘æ›µ±«∞––µƒ◊¥Ã¨£¨…Ë÷√±Í÷æ¡–µƒÕº±Íœ‘ æ
'≤Œ ˝£∫i=µ±«∞––
'      bytMode=“ª≤¢∏¯“© ±¥´»Î£¨0-∏˘æ›¥´»Î––µƒ◊¥Ã¨¥¶¿Ì◊Èƒ⁄ ◊––£¨1-¥´»Î–– «◊Èƒ⁄ ◊–– ±≤≈¥¶¿Ì,2-÷ª¥¶¿Ì¥´»Î––
    Dim blnFirst As Boolean, lngRow As Long
    Dim intÕº±Í ˝ As Integer '“Ω÷ˆƒ⁄»›…œ√ÊµƒÕº±Í∏ˆ ˝
    
    With vsAdvice
        '◊‘”…¬º»Î
        If Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID)) = 0 Then
             Set .Cell(flexcpPicture, i, COL_F±Í÷æ) = frmIcons.imgFlag.ListImages("◊‘”…").Picture
             .Cell(flexcpPictureAlignment, i, COL_F±Í÷æ) = 4
        Else
            blnFirst = True
            lngRow = i
            '“ª≤¢∏¯“©µƒÕº±Í÷ªœ‘ æ‘⁄µ⁄“ª––(…Û∫À◊¥Ã¨≥˝Õ‚)
            If InStr(",5,6,", .TextMatrix(i, COL_¿‡±)) > 0 Then
                If bytMode > 0 Then
                    If bytMode = 1 Then
                        '≈–∂œ¥´»Î–– «◊Èƒ⁄ ◊–– ±≤≈¥¶¿Ì(ø…ƒ‹ªπ√ª”–…Ë÷√∏¯“©Õææ∂)
                        If Val(.TextMatrix(i, COL_œ‡πÿID)) = Val(.TextMatrix(i - 1, COL_œ‡πÿID)) And Val(.TextMatrix(i, COL_œ‡πÿID)) <> 0 Then blnFirst = False
                    Else
                        '÷ª¥¶¿Ì¥´»Îµƒ––(»°œ˚“ª≤¢ ±)
                    End If
                Else
                    '∏˘æ›¥´»Î––µƒ◊¥Ã¨¥¶¿Ì◊Èƒ⁄ ◊––
                    lngRow = .FindRow(.TextMatrix(i, COL_œ‡πÿID), , COL_œ‡πÿID)
                End If
            End If
        
            If blnFirst Then
                If .TextMatrix(i, COL_±Í÷æ) = "2" Then
                    Set .Cell(flexcpPicture, lngRow, COL_F±Í÷æ) = frmIcons.imgFlag.ListImages("≤π¬º").Picture
                ElseIf .TextMatrix(i, COL_±Í÷æ) = "1" Then
                    Set .Cell(flexcpPicture, lngRow, COL_F±Í÷æ) = frmIcons.imgFlag.ListImages("ΩÙº±").Picture
                Else
                    Set .Cell(flexcpPicture, lngRow, COL_F±Í÷æ) = Nothing
                End If
            
                '“ª≤¢∏¯“©œ‘ æ‘⁄µ⁄“ª––
                If Val(.TextMatrix(i, COL_◊¥Ã¨)) < 2 Then   '–¬ø™ªÚ‘›¥Êµƒ“Ω÷ˆ
                    Select Case Val(.TextMatrix(i, COL_…Û∫À◊¥Ã¨))
                    '0-Œﬁ–Ë…Û∫À£¨1-¥˝…Û∫À£¨2-…Û∫ÀÕ®π˝£¨3-…Û∫ÀŒ¥Õ®π˝
                        Case 1
                            If .TextMatrix(i, COL_¿‡±) = "K" And Val(.TextMatrix(i, COL_ºÏ≤È∑Ω∑®)) = 1 Then
                                '”√—™“Ω÷ˆ…Û∫ÀÕº±Íµ•∂¿œ‘ æ(±Ì√˜ «”–“Ω…˙∫À∂‘)
                                Set .Cell(flexcpPicture, lngRow, COL_F±Í÷æ) = frmIcons.imgFlag.ListImages("∫À∂‘").Picture
                            Else
                                Set .Cell(flexcpPicture, lngRow, COL_F±Í÷æ) = frmIcons.imgFlag.ListImages("¥˝…Û∫À").Picture
                            End If
                        Case 2
                            If Not (.TextMatrix(i, COL_¿‡±) = "K" And Val(.TextMatrix(i, COL_ºÏ≤È∑Ω∑®)) = 1) Then
                                Set .Cell(flexcpPicture, lngRow, COL_F±Í÷æ) = frmIcons.imgFlag.ListImages("…Û∫ÀÕ®π˝").Picture
                            End If
                        Case 3
                            Set .Cell(flexcpPicture, lngRow, COL_F±Í÷æ) = frmIcons.imgFlag.ListImages("…Û∫ÀŒ¥Õ®π˝").Picture
                        Case 4, 5
                            If gbln—™ø‚œµÕ≥ = False Then Set .Cell(flexcpPicture, lngRow, COL_F±Í÷æ) = frmIcons.imgFlag.ListImages("¥˝…Û∫À").Picture
                        Case 7
                            Set .Cell(flexcpPicture, lngRow, COL_F±Í÷æ) = frmIcons.imgFlag.ListImages("¥˝«©∑¢").Picture
                    End Select
                End If
                                '¥¶∑Ω…Û≤ÈœµÕ≥
                If .TextMatrix(i, COL_¥¶∑Ω…Û≤È◊¥Ã¨) = "0" Then
                    Set .Cell(flexcpPicture, lngRow, COL_F±Í÷æ) = frmIcons.imgFlag.ListImages("¥˝…Û∫À").Picture
                ElseIf .TextMatrix(i, COL_¥¶∑Ω…Û≤È◊¥Ã¨) = "2" Or .TextMatrix(i, COL_¥¶∑Ω…Û≤ÈΩ·π˚) = "1" Then
                    '≥¨ ±√‚…Ûµ±◊˜∫œ∏Ò¥¶¿Ì
                    Set .Cell(flexcpPicture, lngRow, COL_F±Í÷æ) = frmIcons.imgFlag.ListImages("…Û∫ÀÕ®π˝").Picture
                ElseIf .TextMatrix(i, COL_¥¶∑Ω…Û≤ÈΩ·π˚) = "2" Then
                    ' ≤ª∫œ∏Ò
                    Set .Cell(flexcpPicture, lngRow, COL_F±Í÷æ) = frmIcons.imgFlag.ListImages("…Û∫ÀŒ¥Õ®π˝").Picture
                End If
                .Cell(flexcpPictureAlignment, lngRow, COL_F±Í÷æ) = 4
            End If
            If Val(.TextMatrix(i, COL_«©√˚∑Ò)) = 1 Then
                Set .Cell(flexcpPicture, i, col_“Ω÷ˆƒ⁄»›) = frmIcons.imgSign.ListImages("«©√˚").Picture
                intÕº±Í ˝ = 1
            End If
            
            If Val(.TextMatrix(i, COL_∏ﬂŒ£“©∆∑)) > 0 Then
                If .Cell(flexcpPicture, i, col_“Ω÷ˆƒ⁄»›) Is Nothing Then
                    Set .Cell(flexcpPicture, i, col_“Ω÷ˆƒ⁄»›) = frmIcons.imgQuestion.ListImages("∏ﬂŒ£“©∆∑").Picture
                    intÕº±Í ˝ = 1
                Else
                    If .Cell(flexcpPicture, i, col_“Ω÷ˆƒ⁄»›) <> frmIcons.imgQuestion.ListImages("∏ﬂŒ£“©∆∑").Picture Then
                        pictmp.PaintPicture vsAdvice.Cell(flexcpPicture, i, col_“Ω÷ˆƒ⁄»›), 0, 0, pictmp.Width / 2, pictmp.Height
                        pictmp.PaintPicture frmIcons.imgQuestion.ListImages("∏ﬂŒ£“©∆∑").Picture, pictmp.Width / 2, 0, pictmp.Width / 2, pictmp.Height
                        Set .Cell(flexcpPicture, i, col_“Ω÷ˆƒ⁄»›) = pictmp.Image
                        intÕº±Í ˝ = 2
                    End If
                End If
            End If
            'Œ£º±÷µÕº±Í
            If mlngŒ£º±÷µID > 0 And Val(.TextMatrix(i, COL_EDIT)) = 1 Or Val(.TextMatrix(i, COL_Œ£º±÷µID)) > 0 Then
                If intÕº±Í ˝ = 0 Then
                    Set .Cell(flexcpPicture, i, col_“Ω÷ˆƒ⁄»›) = frmIcons.imgQuestion.ListImages("Œ£º±÷µ").Picture
                ElseIf intÕº±Í ˝ = 1 Then
                    pictmp.Cls
                    pictmp.PaintPicture .Cell(flexcpPicture, i, col_“Ω÷ˆƒ⁄»›), 0, 0, pictmp.Width / 2, pictmp.Height
                    pictmp.PaintPicture frmIcons.imgQuestion.ListImages("Œ£º±÷µ").Picture, pictmp.Width / 2, 0, pictmp.Width / 2, pictmp.Height
                    Set .Cell(flexcpPicture, i, col_“Ω÷ˆƒ⁄»›) = pictmp.Image
                    intÕº±Í ˝ = 2
                ElseIf intÕº±Í ˝ = 2 Then
                    pictmp.Cls
                    pictmp.Width = 720
                    pictmp.PaintPicture .Cell(flexcpPicture, i, col_“Ω÷ˆƒ⁄»›), 0, 0, 480, pictmp.Height
                    pictmp.PaintPicture frmIcons.imgQuestion.ListImages("Œ£º±÷µ").Picture, 480, 0, 240, pictmp.Height
                    Set .Cell(flexcpPicture, i, col_“Ω÷ˆƒ⁄»›) = pictmp.Image
                    pictmp.Width = 480
                    intÕº±Í ˝ = 3
                End If
            End If
        End If
    End With
End Sub

Private Sub ShowOrHideQuestion()
'π¶ƒ‹£∫œ‘ æªÚ“˛≤ÿøπæ˙”√“©…Û∫ÀŒ¥Õ®π˝µƒÀµ√˜
    Dim strMsg As String
    
    If lbl“…Œ .Caption <> "" Then lbl“…Œ .Caption = ""
    
    If Val(vsAdvice.TextMatrix(vsAdvice.Row, COL_…Û∫À◊¥Ã¨)) = 3 Then
        strMsg = GetKSSAuditQuestion(Val(vsAdvice.RowData(vsAdvice.Row)))
        If strMsg <> "" Then lbl“…Œ .Caption = "…Û∫À∑¥¿°£∫" & strMsg
        
    End If
    pic“…Œ .Visible = lbl“…Œ .Caption <> ""
    
    Call Form_Resize
End Sub

Private Sub ReSet…Û∫À◊¥Ã¨Õº±Í(ByVal lngRow As Long)
'π¶ƒ‹£∫…æ≥˝ªÚ–ﬁ∏ƒ“ª≤¢∏¯“©÷–µƒ“ª––“Ω÷ˆ∫Û£¨÷ÿ…Ë◊È÷– ◊––µƒÕº±Í∫Õøπæ˙“©÷ˆ––µƒ…Û∫À◊¥Ã¨
    Dim lngBegin As Long, lngEnd As Long, i As Long
    Dim blnDo As Boolean
    
    Call GetRowScope(lngRow, lngBegin, lngEnd)
    
    '»Áπ˚”–…Û∫ÀŒ¥Õ®π˝µƒ£¨…æ≥˝∫Û±‰Œ™¥˝…Û∫À
    With vsAdvice
        For i = lngBegin To lngEnd
            If gblnKSSStrict And UserInfo.”√“©º∂± < Val(.TextMatrix(i, COL_øπæ˙µ»º∂)) And .TextMatrix(i, COL_±Í÷æ) <> "1" Then
                .TextMatrix(i, COL_…Û∫À◊¥Ã¨) = 1
            Else
                .TextMatrix(i, COL_…Û∫À◊¥Ã¨) = ""   'CheckAdvice÷–ª·Ω´“ª◊Èµƒ…Ë÷√Œ™œ‡Õ¨
            End If
            If .TextMatrix(i, COL_…Û∫À◊¥Ã¨) <> "" Then
                Set .Cell(flexcpPicture, lngBegin, COL_F±Í÷æ) = frmIcons.imgFlag.ListImages("¥˝…Û∫À").Picture
                .Cell(flexcpPictureAlignment, lngBegin, COL_F±Í÷æ) = 4
                blnDo = True
            End If
        Next
        If blnDo = False Then Set .Cell(flexcpPicture, lngBegin, COL_F±Í÷æ) = Nothing
    End With
End Sub


Private Sub SetMediInfoItem(ByVal blnœ‘ æµ•¡ø As Boolean, ByVal blnœ‘ æøπæ˙“©ŒÔ As Boolean)
'π¶ƒ‹£∫“˛≤ÿªÚœ‘ æ“©∆∑œ‡πÿµƒ–≈œ¢œÓƒø£∫ ◊¥Œ”√¡ø£¨≥¨¡øÀµ√˜£¨”√“©ƒøµƒ£¨”√“©¿Ì”…
    Dim lngHeight As Long, lngHeightOld As Long
    Dim bytHideType As Byte
        
    lngHeightOld = fraAdvice.Height
    lngHeight = cbo∏Ωº”÷¥––.Top + cbo∏Ωº”÷¥––.Height + 60
    
    If blnœ‘ æµ•¡ø Or blnœ‘ æøπæ˙“©ŒÔ Then
        If blnœ‘ æøπæ˙“©ŒÔ = False Then
            lngHeight = lngHeight + txt≥¨¡øÀµ√˜.Height + 90
        Else
            lngHeight = lngHeight + txt≥¨¡øÀµ√˜.Height + 90 + txt”√“©¿Ì”….Height + 90
        End If
    End If
    
    If lngHeightOld <> lngHeight Then
        fraAdvice.Height = lngHeight
        '¥¶¿Ìπˆ∂ØÃıbug
        fraAdvice.Tag = "≤ªπˆ∂Ø"
        Call cbsMain_Resize
        '–Ë“™µ˜”√¡Ω¥Œ≤≈ƒ‹…˙–ß
        fraAdvice.Tag = ""
        Call vsAdvice.ShowCell(vsAdvice.Row, vsAdvice.Col)
        Call vsAdvice.ShowCell(vsAdvice.Row, vsAdvice.Col)
    End If
End Sub

Private Sub SetFontSize(ByVal bytSize As Byte)
'π¶ƒ‹£∫Ω¯––ΩÁ√Ê◊÷ÃÂµƒÕ≥“ª…Ë÷√
'≤Œ ˝£∫bytSize  0-9∫≈◊÷ÃÂ£¨1-12∫≈◊÷ÃÂ
    Call SetPublicFontSize(Me, bytSize)
    Call zlControl.VSFSetFontSize(vsAdvice, IIF(bytSize = 0, 9, 12))
    Call zlControl.VSFSetFontSize(vsDiag, IIF(bytSize = 0, 9, 12))
    Call SetCtrlPos
End Sub

Private Sub SetCtrlPos()
'π¶ƒ‹£∫…Ë÷√øÿº˛Œª÷√,«Î◊¢“‚À˘”–øÿº˛Œª÷√µƒ…Ë÷√æ°ø…ƒ‹‘⁄¥À∫Ø ˝÷–…Ë÷√
    Dim lngDistance1 As Long, lngDistance2 As Long
    Dim lngHeight As Long
    
    lngDistance1 = 30: lngDistance2 = 180
    cmdLastDiag.Top = lbl’Ô∂œ.Top + lbl’Ô∂œ.Height + 60
    Call SetCtrlPosOnLine(True, -1, lbl’Ô∂œ, 60, cmdLastDiag)
    vsDiag.Left = cmdLastDiag.Left + cmdLastDiag.Width + lngDistance1
    opt’Ô∂œ(0).Left = vsDiag.Left + vsDiag.Width + lngDistance1 * 2
    opt’Ô∂œ(1).Left = opt’Ô∂œ(0).Left
    fra’Ô∂œ.Height = vsDiag.Top + vsDiag.Height + 120
    
    '¥π÷±…Ë÷√øÿº˛Œª÷√
    lblø™ º ±º‰.Left = 120
    'œ»…Ë÷√◊Û±ﬂµ⁄“ª––øÿº˛£¨∆‰¥Œ…Ë÷√”“±ﬂøÿº˛Œª÷√£¨◊Ó∫Û…Ë÷√◊Û±ﬂøÿº˛Œª÷√£¨ƒøµƒŒ™¡À…Ë÷√“Ω÷ˆƒ⁄»›∏ﬂ∂»
    '◊Û±ﬂµ⁄“ª≈≈£¨Œ™¡ÀµÿŒªµ⁄“ª≈≈”“±ﬂøÿº˛Œª÷√
    Call SetCtrlPosOnLine(False, 0, lblø™ º ±º‰, lngDistance1, txtø™ º ±º‰, -1 * cmdø™ º ±º‰.Width, cmdø™ º ±º‰, lngDistance2, chkΩÙº±, lngDistance2, chk√‚ ‘)
    lblµŒÀŸ.Left = chk√‚ ‘.Left + chk√‚ ‘.Width + 5 * lngDistance2
    
    '…Ë÷√”“±ﬂøÿº˛Œª÷√
    Call SetCtrlPosOnLine(True, 1, lblµŒÀŸ, lngDistance2, lbl“Ω…˙÷ˆÕ–, lngDistance2, lbl÷¥–– ±º‰, lngDistance2, lbl÷¥––ø∆ “, lngDistance2, lbl∏Ωº”÷¥––, lngDistance2, lbl≥¨¡øÀµ√˜)
    Call SetCtrlPosOnLine(False, 0, lblµŒÀŸ, lngDistance1, cboµŒÀŸ, lngDistance1, lblµŒÀŸµ•Œª, lngDistance2, chkZeroBilling)
    Call SetCtrlPosOnLine(False, 0, lbl“Ω…˙÷ˆÕ–, lngDistance1, cbo“Ω…˙÷ˆÕ–, -1 * cmd“Ω…˙÷ˆÕ–.Width, cmd“Ω…˙÷ˆÕ–, lngDistance1, cmd≥£”√÷ˆÕ–)
    Call SetCtrlPosOnLine(False, 0, lbl÷¥–– ±º‰, lngDistance1, cbo÷¥–– ±º‰)
    Call SetCtrlPosOnLine(False, 0, lbl÷¥––ø∆ “, lngDistance1, cbo÷¥––ø∆ “, lngDistance2, lbl÷¥–––‘÷ , lngDistance1, cbo÷¥–––‘÷ )
    Call SetCtrlPosOnLine(False, 0, lbl∏Ωº”÷¥––, lngDistance1, cbo∏Ωº”÷¥––)
    Call SetCtrlPosOnLine(False, 0, lbl≥¨¡øÀµ√˜, lngDistance1, txt≥¨¡øÀµ√˜, -1 * cmdExcReason.Width, cmdExcReason, lngDistance1, cmdComExcReason)
    cbo÷¥–– ±º‰.Width = cmd≥£”√÷ˆÕ–.Left + cmd≥£”√÷ˆÕ–.Width - cbo÷¥–– ±º‰.Left
    cbo÷¥–––‘÷ .Width = cmd≥£”√÷ˆÕ–.Left + cmd≥£”√÷ˆÕ–.Width - cbo÷¥–––‘÷ .Left
    txt≥¨¡øÀµ√˜.Width = cmd“Ω…˙÷ˆÕ–.Left + cmd“Ω…˙÷ˆÕ–.Width - txt≥¨¡øÀµ√˜.Left - 80
    
    '…Ë÷√◊Û±ﬂøÿº˛Œª÷√
    txt“Ω÷ˆƒ⁄»›.Height = txtø™ º ±º‰.Height 'Œ™¡À÷–≤ø∂‘∆Î
    Call SetCtrlPosOnLine(True, 1, lblø™ º ±º‰, lngDistance2, lbl“Ω÷ˆƒ⁄»›, lbl÷¥––ø∆ “.Top - lbl“Ω…˙÷ˆÕ–.Top - lbl“Ω…˙÷ˆÕ–.Height, lbl∑÷¡„, lngDistance2, lbl”√∑®, -1 * lbl∞≤≈≈ ±º‰.Height, lbl∞≤≈≈ ±º‰, lngDistance2, lbl◊‹¡ø, lngDistance2 + 10, lbl”√“©ƒøµƒ)
    Call SetCtrlPosOnLine(False, 0, lbl“Ω÷ˆƒ⁄»›, lngDistance1, txt“Ω÷ˆƒ⁄»›, lngDistance1, cmdExt)
    cmdSel.Top = cmdExt.Top + cmdExt.Height + 120
    cmdSel.Left = cmdExt.Left
    Call SetCtrlPosOnLine(False, 0, cmdSel, lngDistance1, picHelp)
    txt“Ω÷ˆƒ⁄»›.Height = cbo÷¥––ø∆ “.Top + cbo÷¥––ø∆ “.Height - txt“Ω÷ˆƒ⁄»›.Top
    Call SetCtrlPosOnLine(False, 0, lbl∑÷¡„, lngDistance1, cbo∑÷¡„)
    Call SetCtrlPosOnLine(False, 0, lbl∞≤≈≈ ±º‰, -1 * lbl”√∑®.Width, lbl”√∑®, lngDistance1, txt∞≤≈≈ ±º‰, -1 * cmd∞≤≈≈ ±º‰.Width, cmd∞≤≈≈ ±º‰, -1 * txt”√∑®.Width, txt”√∑®, -1 * cmd”√∑®.Width, cmd”√∑®, lngDistance2, lbl∆µ¬ , lngDistance1, txt∆µ¬ , -1 * cmd∆µ¬ .Width, cmd∆µ¬ )
    txt∆µ¬ .Width = txt“Ω÷ˆƒ⁄»›.Width + txt“Ω÷ˆƒ⁄»›.Left - txt∆µ¬ .Left
    cmd∆µ¬ .Left = txt“Ω÷ˆƒ⁄»›.Width + txt“Ω÷ˆƒ⁄»›.Left - cmd∆µ¬ .Width
    Call SetCtrlPosOnLine(False, 0, lbl◊‹¡ø, lngDistance1, txt◊‹¡ø, lngDistance1, lbl◊‹¡øµ•Œª, -1 * lblÃÏ ˝.Width, lblÃÏ ˝, -1 * (txtÃÏ ˝.Width + Me.TextWidth("◊÷")), txtÃÏ ˝, lngDistance2, lblµ•¡ø, lngDistance1, txtµ•¡ø, lngDistance1, lblµ•¡øµ•Œª)
    lbl”√“©ƒøµƒ.Top = IIF(mbytSize = 0, lbl”√“©ƒøµƒ.Top - 50, lbl”√“©ƒøµƒ.Top)
    Call SetCtrlPosOnLine(False, 0, lbl”√“©ƒøµƒ, lngDistance1, cboDruPur, lngDistance2, lbl”√“©¿Ì”…, lngDistance1, txt”√“©¿Ì”…, -1 * cmdReason.Width, cmdReason, 0.5 * lngDistance1, cmd ’≤ÿ”√“©¿Ì”…)
    lblµ•¡øµ•Œª.Left = txt“Ω÷ˆƒ⁄»›.Width + txt“Ω÷ˆƒ⁄»›.Left - lblµ•¡øµ•Œª.Width
    txtµ•¡ø.Width = lblµ•¡øµ•Œª.Left - lngDistance1 - txtµ•¡ø.Left
    
    If Me.WindowState <> vbMaximized And Me.WindowState <> vbMinimized Then
        fraAdvice.Width = cmd≥£”√÷ˆÕ–.Left + cmd≥£”√÷ˆÕ–.Width + 500
        Me.Width = fraAdvice.Width + fraAdvice.Left
    End If
End Sub

Private Sub CheckDrugOutOfRange(ByVal lngRow As Long, ByVal sngDays As Single)
'π¶ƒ‹£∫ºÏ≤È“©∆∑”√¡øªÚÃÏ ˝ «∑Ò≥¨π˝‘ –Ìµƒ∑∂Œß,≤¢«“µØ≥ˆ—°‘ÒÃ· æ
'∑µªÿ£∫—°‘Ò «∑ÒºÃ–¯
    Dim blnReturn As Boolean
    Dim strOld As String
    
    strOld = vsAdvice.TextMatrix(lngRow, COL_ «∑Ò≥¨∆⁄)

    If sngDays > IIF(mbytPatiType = 1, conOrdinary, conEmergency) And vsAdvice.TextMatrix(lngRow, COL_≥¨¡øÀµ√˜) = "" Then
        vsAdvice.TextMatrix(lngRow, COL_ «∑Ò≥¨∆⁄) = "1"
    Else
        vsAdvice.TextMatrix(lngRow, COL_ «∑Ò≥¨∆⁄) = ""
    End If
    If strOld <> vsAdvice.TextMatrix(lngRow, COL_ «∑Ò≥¨∆⁄) Then
        lbl≥¨¡øÀµ√˜.Tag = "1"
    End If
End Sub


Private Sub Set”√“©ÃÏ ˝ «∑Ò≥¨∆⁄(ByVal lngRow As Long)
'π¶ƒ‹£∫∏˘æ›∏¯∂®“Ω÷ˆ––µƒ◊‹¡ø°¢µ•¡ø∫Õ∆µ¬ –≈œ¢º∆À„ÃÏ ˝£¨≤¢«“…Ë÷√°∞ «∑Ò≥¨∆⁄°±¡–µƒ÷µ
    Dim sngÃÏ ˝ As Single
    
    With vsAdvice
        If RowIn≈‰∑Ω––(lngRow) And Val(.TextMatrix(lngRow, COL_◊‹¡ø)) > 0 Then
            sngÃÏ ˝ = Val(.TextMatrix(lngRow, COL_◊‹¡ø))
        Else
            If mblnÃÏ ˝ Then
                sngÃÏ ˝ = Val(.TextMatrix(lngRow, COL_ÃÏ ˝))
            ElseIf Val(.TextMatrix(lngRow, COL_◊‹¡ø)) <> 0 And Val(.TextMatrix(lngRow, COL_µ•¡ø)) <> 0 _
                And .TextMatrix(lngRow, COL_∆µ¬ ) <> "" And Val(.TextMatrix(lngRow, COL_∆µ¬ ¥Œ ˝)) <> 0 And Val(.TextMatrix(lngRow, COL_∆µ¬ º‰∏Ù)) <> 0 _
                And Val(.TextMatrix(lngRow, COL_º¡¡øœµ ˝)) <> 0 And Val(.TextMatrix(lngRow, COL_√≈’Ô∞¸◊∞)) <> 0 Then
                
                sngÃÏ ˝ = Calc»± °“©∆∑ÃÏ ˝(Val(.TextMatrix(lngRow, COL_◊‹¡ø)), Val(.TextMatrix(lngRow, COL_µ•¡ø)), _
                    Val(.TextMatrix(lngRow, COL_∆µ¬ ¥Œ ˝)), Val(.TextMatrix(lngRow, COL_∆µ¬ º‰∏Ù)), .TextMatrix(lngRow, COL_º‰∏Ùµ•Œª), _
                    Val(.TextMatrix(lngRow, COL_º¡¡øœµ ˝)), Val(.TextMatrix(lngRow, COL_√≈’Ô∞¸◊∞)), _
                    Val(.TextMatrix(lngRow, COL_ø…∑Ò∑÷¡„)))
            End If
        End If
        
        If sngÃÏ ˝ > IIF(mbytPatiType = 1, conOrdinary, conEmergency) Then
            .TextMatrix(lngRow, COL_ «∑Ò≥¨∆⁄) = "1"
        Else
            .TextMatrix(lngRow, COL_ «∑Ò≥¨∆⁄) = ""
        End If
        
    End With
End Sub

Private Function ReGet“©∆∑◊‹¡ø(ByVal dbl‘≠◊‹¡ø As Double, ByVal dblµ•¡ø As Double, ByVal sngÃÏ ˝ As Long, ByVal lngRow As Long) As Double
'π¶ƒ‹£∫÷ÿ–¬∏˘æ›µ•¡ø°¢ÃÏ ˝º∞µ±«∞––µƒ∆µ¬ –≈œ¢µ»º∆À„◊‹¡ø
'∑µªÿ£∫º∆À„µƒ◊‹¡ø
    Dim dbl◊‹¡ø As Double
    
    ReGet“©∆∑◊‹¡ø = dbl‘≠◊‹¡ø
    
    With vsAdvice
        If .TextMatrix(lngRow, COL_∆µ¬ ) <> "" And Val(.TextMatrix(lngRow, COL_∆µ¬ ¥Œ ˝)) <> 0 And Val(.TextMatrix(lngRow, COL_∆µ¬ º‰∏Ù)) <> 0 _
            And dblµ•¡ø <> 0 And Val(.TextMatrix(lngRow, COL_º¡¡øœµ ˝)) <> 0 And Val(.TextMatrix(lngRow, COL_√≈’Ô∞¸◊∞)) <> 0 Then
            
            dbl◊‹¡ø = FormatEx(Calc»± °“©∆∑◊‹¡ø(dblµ•¡ø, sngÃÏ ˝, _
                Val(.TextMatrix(lngRow, COL_∆µ¬ ¥Œ ˝)), Val(.TextMatrix(lngRow, COL_∆µ¬ º‰∏Ù)), _
                .TextMatrix(lngRow, COL_º‰∏Ùµ•Œª), .TextMatrix(lngRow, COL_÷¥–– ±º‰), _
                Val(.TextMatrix(lngRow, COL_º¡¡øœµ ˝)), Val(.TextMatrix(lngRow, COL_√≈’Ô∞¸◊∞)), _
                Val(.TextMatrix(lngRow, COL_ø…∑Ò∑÷¡„))), 5)
                
            
            If InStr(GetInsidePrivs(p√≈’Ô“Ω÷ˆœ¬¥Ô), "“©∆∑–° ˝ ‰»Î") = 0 Then
                dbl◊‹¡ø = IntEx(dbl◊‹¡ø)
            ElseIf Val(.TextMatrix(lngRow, COL_ø…∑Ò∑÷¡„)) <> 0 Then
                dbl◊‹¡ø = IntEx(dbl◊‹¡ø)
            End If
        End If
    End With
    ReGet“©∆∑◊‹¡ø = dbl◊‹¡ø
End Function

Private Sub Set“Ω÷ˆ≥¨¡ø(ByVal lngBegin As Long, ByVal lngEnd As Long)
'π¶ƒ‹£∫Œ™÷∏∂®∑∂Œßƒ⁄µƒ“Ω÷ˆ…Ë÷√≥¨±Íº« .TextMatrix(i, COL_ «∑Ò≥¨¡ø) .TextMatrix(i, COL_≥¨¡øÀµ√˜)
    Dim dbl◊‹¡ø As Double
    Dim lngœ‡πÿID As Long
    Dim i As Long
    Dim j As Long
    
    With vsAdvice
        For i = lngBegin To lngEnd
            If .RowData(i) = 0 Then Exit Sub
            .TextMatrix(i, COL_ «∑Ò≥¨¡ø) = ""
            If InStr(",5,6,", .TextMatrix(i, COL_¿‡±)) > 0 And Val(.TextMatrix(i, COL_¥¶∑Ωœﬁ¡ø)) > 0 Then
                dbl◊‹¡ø = Val(.TextMatrix(i, COL_◊‹¡ø)) * Val(.TextMatrix(i, COL_√≈’Ô∞¸◊∞)) * Val(.TextMatrix(i, COL_º¡¡øœµ ˝))
                If dbl◊‹¡ø > Val(.TextMatrix(i, COL_¥¶∑Ωœﬁ¡ø)) Then .TextMatrix(i, COL_ «∑Ò≥¨¡ø) = "1"
                If .TextMatrix(i, COL_ «∑Ò≥¨¡ø) = "" And .TextMatrix(i, COL_ «∑Ò≥¨∆⁄) = "" Then .TextMatrix(i, COL_≥¨¡øÀµ√˜) = ""
            ElseIf Val(.TextMatrix(i, COL_¿‡±)) = 7 And Val(.TextMatrix(i, COL_¥¶∑Ωœﬁ¡ø)) > 0 Then  '÷–“©
                dbl◊‹¡ø = Val(.TextMatrix(i, COL_µ•¡ø)) * Val(.TextMatrix(i, COL_◊‹¡ø))
                If dbl◊‹¡ø > Val(.TextMatrix(i, COL_¥¶∑Ωœﬁ¡ø)) Then .TextMatrix(i, COL_ «∑Ò≥¨¡ø) = "1"
            ElseIf .TextMatrix(i, COL_¿‡±) = "E" And .TextMatrix(i, COL_≤Ÿ◊˜¿‡–Õ) = "4" Then
                lngœ‡πÿID = .RowData(i)
                For j = i - 1 To .FixedRows Step -1
                    If Val(.TextMatrix(j, COL_œ‡πÿID)) = lngœ‡πÿID Then
                        If .TextMatrix(j, COL_ «∑Ò≥¨¡ø) = "1" Then
                            .TextMatrix(i, COL_ «∑Ò≥¨¡ø) = "1"
                            .TextMatrix(j, COL_ «∑Ò≥¨¡ø) = ""
                        End If
                    Else
                        Exit For
                    End If
                Next
            ElseIf Val(.TextMatrix(i, COL_¥¶∑Ωœﬁ¡ø)) > 0 Then '∆‰À˚’Ô¡∆œÓƒø
                If Val(.TextMatrix(i, COL_◊‹¡ø)) > Val(.TextMatrix(i, COL_¥¶∑Ωœﬁ¡ø)) Then .TextMatrix(i, COL_ «∑Ò≥¨¡ø) = "1"
            End If
            If .TextMatrix(i, COL_ «∑Ò≥¨¡ø) = "" And .TextMatrix(i, COL_ «∑Ò≥¨∆⁄) = "" Then .TextMatrix(i, COL_≥¨¡øÀµ√˜) = ""
        Next
    End With
End Sub

Private Function GetInsureStr(ByRef strIDs1 As String, ByRef strIDs2 As String, ByRef str“Ω÷ˆƒ⁄»› As String, ByVal lngRow As Long) As Boolean
'π¶ƒ‹£∫ªÒ»°“Ω±£∂‘¬Îµƒ◊÷∑˚¥Æ
'   strIDs1:“©∆∑Œ¿≤ƒµƒ ’∑—œ∏ƒøID◊÷∑˚¥Æ£¨strIDs2 £∫∆‰À˚’Ô¡∆œÓƒøµƒ’Ô¡∆œÓƒøID:÷¥––ø∆ “◊÷∑˚¥Æ
    Dim lngBegin As Long, lngEnd As Long, i As Long
    Call GetRowScope(lngRow, lngBegin, lngEnd)
    With vsAdvice
        'Œ™¿˚”√À˜“˝,”√Union∑Ω Ω
        For i = lngBegin To lngEnd
            If Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID)) <> 0 Then
                If InStr(",4,5,6,7,", .TextMatrix(i, COL_¿‡±)) > 0 Then
                    '“©∆∑°¢Œ¿≤ƒŒﬁ∂‘”¶πÿœµ,“©∆∑÷ª¥¶¿Ì∞¥πÊ∏Òœ¬¥Ô ±
                    If Val(.TextMatrix(i, COL_ ’∑—œ∏ƒøID)) <> 0 And InStr("," & strIDs1 & ",", "," & Val(.TextMatrix(i, COL_ ’∑—œ∏ƒøID)) & ",") = 0 Then
                        strIDs1 = strIDs1 & "," & .TextMatrix(i, COL_ ’∑—œ∏ƒøID)
                    End If
                ElseIf InStr("," & strIDs2 & ",", "," & Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID)) & ",") = 0 Then
                    '∞¸∫¨¡À ’∑— ˝¡øŒ™0µƒ
                    strIDs2 = strIDs2 & "," & Val(.TextMatrix(i, COL_’Ô¡∆œÓƒøID)) & ":" & Val(.TextMatrix(i, COL_÷¥––ø∆ “ID))
                End If
            End If
        Next
        str“Ω÷ˆƒ⁄»› = Left(vsAdvice.TextMatrix(lngRow, col_“Ω÷ˆƒ⁄»›), 50)
    End With
End Function

Private Function SetAll≥¨¡øÀµ√˜(ByVal lngRow As Long, ByRef blnOut As Boolean) As Boolean
'π¶ƒ‹£∫ºÏ≤È√ª”––¥≥¨¡øÀµ√˜µƒ“Ω÷ˆ»ª∫ÛŒ™∆‰ÃÌº”≥¨¡øÀµ√˜
'≤Œ ˝£∫lngRowø™ º––∫≈
'      blnOut ±Ì æµØ≥ˆ¡À ‰»ÎΩÁ√Êµ´√ªÃÓ–¥»Œ∫Œƒ⁄»›
    Dim i As Long
    Dim strTmp As String
    Dim str≈‰∑Ω As String
    Dim str––IDs As String '–Ë“™ÃÓ–¥≥¨¡øÀµ√˜µƒ“Ω÷ˆ––∫≈
    Dim str≥¨¡øÀµ√˜ As String
    Dim strMsg As String
    Dim varArr As Variant
    
    With vsAdvice
        For i = lngRow To .Rows - 1
            If (.TextMatrix(i, COL_ «∑Ò≥¨¡ø) = "1" Or .TextMatrix(i, COL_ «∑Ò≥¨∆⁄) = "1") And .TextMatrix(i, COL_≥¨¡øÀµ√˜) = "" Then
                Select Case (Val(.TextMatrix(i, COL_ «∑Ò≥¨¡ø)) - Val(.TextMatrix(i, COL_ «∑Ò≥¨∆⁄)))
                    Case 1
                        strTmp = "≥¨≥ˆ¡À¥¶∑Ωœﬁ¡ø£¨«ÎÃÓ–¥≥¨¡øÀµ√˜°£"
                    Case -1
                        strTmp = "≥¨≥ˆ¡À”√“©¡∆≥Ã(" & IIF(mbytPatiType = 1, conOrdinary, conEmergency) & "ÃÏ)£¨«ÎÃÓ–¥≥¨¡øÀµ√˜°£"
                    Case 0
                        strTmp = "≥¨≥ˆ¡À¥¶∑Ωœﬁ¡ø∫Õ”√“©¡∆≥Ã(" & IIF(mbytPatiType = 1, conOrdinary, conEmergency) & "ÃÏ)£¨«ÎÃÓ–¥≥¨¡øÀµ√˜°£"
                End Select
                If .TextMatrix(i, COL_¿‡±) = "E" And .TextMatrix(i, COL_≤Ÿ◊˜¿‡–Õ) = "4" Then '÷–≤›“©µƒ≥¨¡ø±Í÷æ∑≈µΩ¡Àœ‘ æ––£¨÷ªƒ‹¥Û∏≈Ã· æ
                    str≈‰∑Ω = .TextMatrix(i, col_“Ω÷ˆƒ⁄»›)
                    str≈‰∑Ω = "÷–≤›“©≈‰∑Ω£∫" & Mid(str≈‰∑Ω, InStr(str≈‰∑Ω, ":") + 1)
                    strMsg = strMsg & """" & str≈‰∑Ω & """" & strTmp
                Else
                    strMsg = strMsg & """" & .TextMatrix(i, col_“Ω÷ˆƒ⁄»›) & """" & strTmp
                End If
                str––IDs = str––IDs & "," & i
            End If
        Next
    End With
    str––IDs = Mid(str––IDs, 2)
    
    If strMsg <> "" And str––IDs <> "" Then
        Call frmMsgDruExcess.ShowMe(Me, strMsg, str≥¨¡øÀµ√˜)
    Else
        SetAll≥¨¡øÀµ√˜ = True
        Exit Function
    End If
    
    If str≥¨¡øÀµ√˜ = "*NULL*" Then 'str≥¨¡øÀµ√˜ = "*NULL*" ±Ì æ√ª”–ÃÓ–¥»Œ∫Œ∂´Œ˜
        blnOut = True
    ElseIf str≥¨¡øÀµ√˜ <> "" Then  'str≥¨¡øÀµ√˜ = "" ±Ì æ√ª”–÷¥–– frmMsgDruExcess.ShowMe(Me, strMsg, str≥¨¡øÀµ√˜)
        varArr = Split(str––IDs, ",")
        For i = 0 To UBound(varArr)
            vsAdvice.TextMatrix(Val(varArr(i)), COL_≥¨¡øÀµ√˜) = str≥¨¡øÀµ√˜
        Next
    End If
    SetAll≥¨¡øÀµ√˜ = True
End Function

Private Function CheckAutoMerge(ByVal lngRow As Long) As Integer
'π¶ƒ‹£∫◊‘∂Ø≈–∂œ»‹√ΩΩ¯––◊‘∂Ø“ª≤¢∏¯“©∫Õ»°œ˚“ª≤¢
        '≈–∂œ»‹√Ω£¨◊‘∂Ø“ª≤¢/»°œ˚“ª≤¢
        '»Áπ˚…œ“ª––“Ω÷ˆ « ‰“∫“©∆∑£¨µ±«∞ ‰»Îµƒ“≤ « ‰“∫“©∆∑ ±£∫
        '1°¢»Áπ˚µ±«∞¬º»Îµƒ «“©∆∑£¨»Áπ˚«∞√Ê“ª◊È“∫ÃÂ÷–£¨»‹√Ω «µ⁄“ª∏ˆ£¨ƒ«√¥◊‘∂ØŒ™°∞“ª≤¢°±◊¥Ã¨°£
        '2°¢»Áπ˚µ±«∞¬º»Îµƒ «“©∆∑£¨»Áπ˚«∞√Ê“ª◊È“∫ÃÂ÷–£¨»‹√Ω «◊Ó∫Û“ª∏ˆ£®…œ“ªÃı“Ω÷ˆ£©£¨ƒ«√¥◊‘∂Ø»°œ˚°∞“ª≤¢°±◊¥Ã¨£®∫Û ‰»Î»‹√Ωµƒ«Èøˆ£©°£
        '3°¢»Áπ˚µ±«∞––¬º»Îµƒ»‹√Ω£®“©∆∑Ãÿ–‘.»‹√Ω£©£¨‘Ú≈–∂œ»Áπ˚“ª◊È“∫ÃÂ÷–“—æ≠¥Ê‘⁄“ª∏ˆ»‹√Ω ±£¨‘Ú◊‘∂Ø»°œ˚°∞“ª≤¢°±◊¥Ã¨£®œ» ‰»Î»‹√Ωµƒ«Èøˆ£©°£
'≤Œ ˝£∫lngRow=µ±«∞––
'∑µªÿ£∫0-≤ª◊ˆ¥¶¿Ì£¨1-“ª≤¢∏¯“©£¨2-»°œ˚“ª≤¢∏¯“©
    Dim i As Long, j As Long
    Dim lngBegin As Long, lngEnd As Long
    Dim lngPreRow As Long
    
    With vsAdvice
        lngPreRow = GetPreRow(lngRow) '»°…œ“ª”––ß––,ƒ≥–©ƒ⁄»›»± °”Î…œ“ª––œ‡Õ¨
        If lngPreRow <> -1 Then
            If InStr(",5,6,", .TextMatrix(lngPreRow, COL_¿‡±)) > 0 Then
                i = .FindRow(CLng(.TextMatrix(lngPreRow, COL_œ‡πÿID)), lngPreRow + 1)
                If .TextMatrix(i, COL_¿‡±) = "E" And .TextMatrix(i, COL_≤Ÿ◊˜¿‡–Õ) = "2" And .TextMatrix(i, COL_÷¥––∑÷¿‡) = "1" Then
                    j = .FindRow(CLng(.TextMatrix(lngRow, COL_œ‡πÿID)), lngRow + 1)
                    If .TextMatrix(j, COL_¿‡±) = "E" And .TextMatrix(j, COL_≤Ÿ◊˜¿‡–Õ) = "2" And .TextMatrix(j, COL_÷¥––∑÷¿‡) = "1" Then
                        If RowCanMerge(lngPreRow, lngRow) Then
                            'ªÒ»°…œ“ªÃı“Ω÷ˆµƒø™ º––∫≈
                            Call GetRowScope(i, lngBegin, lngEnd)
                            If mblnRowMerge = False Then
                                'µ⁄“ª–– «»‹√Ω(1)
                                If Val(.TextMatrix(lngBegin, COL_ «∑Ò»‹√Ω)) = 1 And Val(.TextMatrix(lngRow, COL_ «∑Ò»‹√Ω)) <> 1 Then
                                    CheckAutoMerge = 1
                                End If
                            Else
                                'µ±«∞–– «»‹√Ω£¨«∞√Ê“—æ≠¥Ê‘⁄»‹√Ω¡À(3)
                                If Val(.TextMatrix(lngRow, COL_ «∑Ò»‹√Ω)) = 1 Then
                                    For i = lngBegin To lngEnd
                                        If Val(.TextMatrix(i, COL_ «∑Ò»‹√Ω)) = 1 Then
                                            CheckAutoMerge = 2
                                            Exit For
                                        End If
                                    Next
                                Else
                                    'µ±«∞ «“©∆∑£¨…œ“ª–– «»‹√Ω£¨µ´”÷≤ª «µ⁄“ª–– ±(2)
                                    If Val(.TextMatrix(lngPreRow, COL_ «∑Ò»‹√Ω)) = 1 And lngPreRow <> lngBegin Then
                                        CheckAutoMerge = 2
                                    End If
                                End If
                            End If
                        End If
                    End If
                End If
            End If
        End If
    End With
End Function

Private Sub tbcSub_SelectedChanged(ByVal Item As XtremeSuiteControls.ITabControlItem)
'
    If mblnNoRefresh Then Exit Sub
    If mblnNoSave Then
        mblnNoRefresh = True
        tbcSub.Item(0).Selected = True
        MsgBox "µ±«∞“Ω÷ˆƒ⁄»›±‡º≠∫Û…–Œ¥±£¥Ê£¨«Îœ»±£¥Ê°£", vbInformation, gstrSysName
        mblnNoRefresh = False
        Exit Sub
    End If
    Call SubWinRefreshData(Item)
End Sub

Private Sub SubWinRefreshData(ByVal objItem As TabControlItem)
'π¶ƒ‹£∫À¢–¬ ˝æ›
    If objItem.Tag = "“Ω÷ˆ±‡º≠" Then
        Call ReLoadAdvice(vsAdvice.RowData(vsAdvice.Row))
    Else
        If objItem.Tag <> "" Then
            If Not gobjPlugIn Is Nothing Then
                On Error Resume Next
                Call gobjPlugIn.RefreshForm(glngSys, p◊°‘∫“Ω÷ˆœ¬¥Ô, mcolSubForm("_" & objItem.Tag), objItem.Tag, mlng≤°»ÀID, mstrπ“∫≈µ•, 0, False, _
                    0, 0, 0, mlng≤°»Àø∆ “id)
                Call zlPlugInErrH(err, "RefreshForm")
                err.Clear: On Error GoTo 0
            End If
        End If
    End If
End Sub

Private Function CanUseApply(ByVal str¿‡± As String, Optional ByVal lngœÓƒøid As Long, Optional ByVal strœÓƒø±‡¬Î As String) As Boolean
'π¶ƒ‹£∫ «∑Òø…“‘ π”√œ‡”¶µƒ…Í«Îµ•
    '÷ª”√‘⁄“Ω…˙π§◊˜’æ
    Dim strSQL As String
    Dim rsTmp As ADODB.Recordset
    Dim blnTmp As Boolean
        Dim str±‡¬Î As String
    Dim strEx As String
 
    If mint≥°∫œ <> 0 Then Exit Function
    
    If str¿‡± = "D" And Val(Mid(gstrOutUseApp, 1, 1)) = 1 Or _
        str¿‡± = "C" And Val(Mid(gstrOutUseApp, 2, 1)) = 1 Or _
        str¿‡± = "K" And Val(Mid(gstrOutUseApp, 3, 1)) = 1 Then
        blnTmp = True
    End If
    
    If lngœÓƒøid <> 0 And blnTmp Then
        If str¿‡± = "D" Then
            strSQL = "select 1 from ≤°¿˙µ•æ›”¶”√ where ’Ô¡∆œÓƒøID=[1] and ”¶”√≥°∫œ = [2]"
            Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lngœÓƒøid, 1)
            If rsTmp.EOF Then blnTmp = False
        ElseIf str¿‡± = "C" Then
            blnTmp = False
            If Not gobjLIS Is Nothing Then
                If strœÓƒø±‡¬Î <> "" Then
                    str±‡¬Î = strœÓƒø±‡¬Î
                Else
                    strSQL = "select b.±‡¬Î from ’Ô¡∆œÓƒøƒø¬º b where b.id=[1]"
                    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lngœÓƒøid)
                    str±‡¬Î = rsTmp!±‡¬Î & ""
                End If
                On Error Resume Next
                blnTmp = gobjLIS.CanUseLISApp(str±‡¬Î, strEx)
                err.Clear: On Error GoTo 0
            End If
        End If
    End If
    CanUseApply = blnTmp
End Function

Private Function CheckApply() As Boolean
'π¶ƒ‹£∫≈–∂œ…Í«Îµ•µƒÃÓ–¥«Èøˆ
    Dim i As Long
    If Val(gstrOutUseApp) > 0 Then
        With vsAdvice
            For i = .FixedRows To .Rows - 1
                If Not .RowHidden(i) Then
                    If Val(.TextMatrix(i, COL_…Í«Î–Ú∫≈)) < 0 And Val(.TextMatrix(i, COL_EDIT)) = 1 Then
                        .Row = i
                        Call cmdExt_Click
                    End If
                End If
            Next
            For i = .FixedRows To .Rows - 1
                If Not .RowHidden(i) Then
                    If Val(.TextMatrix(i, COL_…Í«Î–Ú∫≈)) < 0 And Val(.TextMatrix(i, COL_EDIT)) = 1 Then
                        Exit Function
                    End If
                End If
            Next
        End With
    End If
    CheckApply = True
End Function

Private Function ApplySelect() As Integer
'π¶ƒ‹£∫µØ≥ˆ…Í«Îµ•—°‘Ò∆˜
    Dim strSQL As String, rsTmp As ADODB.Recordset
    Dim intTmp As Integer, blnCancel As Boolean
    Dim vRect As RECT
    
    If mint≥°∫œ <> 0 Then Exit Function
 
    intTmp = Val(Mid(gstrOutUseApp, 1, 1))
    If intTmp = 1 Then strSQL = "select 1 as id,'ºÏ≤È…Í«Îµ•' as …Í«Îµ• from dual"
    intTmp = Val(Mid(gstrOutUseApp, 2, 1))
    If intTmp = 1 And Not gobjLIS Is Nothing Then strSQL = IIF(strSQL = "", "", strSQL & " union all ") & "select 2 as id,'ºÏ—È…Í«Îµ•' as …Í«Îµ• from dual"
    intTmp = Val(Mid(gstrOutUseApp, 3, 1))
    If intTmp = 1 Then strSQL = IIF(strSQL = "", "", strSQL & " union all ") & "select 3 as id,' ‰—™…Í«Îµ•' as …Í«Îµ• from dual"
    
    If strSQL = "" Then Exit Function
    
    strSQL = strSQL & " order by id"

    On Error GoTo errH
    vRect = GetControlRect(txt“Ω÷ˆƒ⁄»›.hWnd)
    Set rsTmp = zlDatabase.ShowSelect(Me, strSQL, 0, Me.Caption, , , , , , True, vRect.Left, vRect.Top, txt“Ω÷ˆƒ⁄»›.Height, blnCancel, , True)
    If Not rsTmp Is Nothing Then ApplySelect = Val(rsTmp!ID & "")
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Sub AdviceInput…Í«Îµ•(ByVal intType As Integer)
'π¶ƒ‹£∫ ‰»Î’Ô¡∆œÓƒø∫ÛµØ≥ˆ…Í«Îµ•
    Dim str¿‡± As String
    Dim lngRow As Long
    Dim blnOK As Boolean
    Dim objAppPages() As clsApplicationData
    Dim rsCard As ADODB.Recordset
 
    On Error Resume Next
'    '–¬‘ˆ
    cbsMain.FindControl(, conMenu_New, True, True).Execute
    lngRow = vsAdvice.Row
    Select Case intType
    Case 1 'ºÏ≤È…Í«Î
        blnOK = ApplyNewºÏ≤È…Í«Î(0, "", objAppPages())
    Case 2 'ºÏ—È…Í«Î
        blnOK = ApplyNewºÏ—È…Í«Î(0, "", rsCard)
    Case 3 ' ‰—™…Í«Î
        blnOK = ApplyNew ‰—™…Í«Î(0, "", rsCard)
    End Select
    err.Clear

    On Error GoTo errH
    '∏˘æ›—°‘ÒœÓƒø…Ë÷√»± °“Ω÷ˆ–≈œ¢
    If blnOK Then
        Select Case intType
        Case 1 'ºÏ≤È…Í«Î
            Call AdviceSetºÏ≤È…Í«Î(lngRow, objAppPages())
        Case 2 'ºÏ—È…Í«Î
            Call AdviceSetºÏ—È…Í«Î(lngRow, rsCard)
        Case 3 ' ‰—™…Í«Î
            Call AdviceSet ‰—™…Í«Î(lngRow, rsCard)
        End Select

        'œ‘ æ“—»± °…Ë÷√µƒ÷µ
        Call vsAdvice_AfterRowColChange(-1, vsAdvice.Col, vsAdvice.Row, vsAdvice.Col)
        Call CalcAdviceMoney 'œ‘ æ–¬ø™“Ω÷ˆΩ∂Ó
        '“Ω±£π‹øÿ µ ±º‡≤‚
        If mintœ’¿‡ <> 0 And Val(vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_EDIT)) = 0 Then
            '◊‹¡ø≤ªø… ‰»Î£∫»± °≤¢πÃ∂®◊‹¡øµƒ“Ω÷ˆ£¨“‘º∞≥§÷ˆ
            '≥…Ã◊“Ω÷ˆ≤ª‘⁄’‚¿ÔºÏ≤È
            If gclsInsure.GetCapability(support µ ±º‡øÿ, mlng≤°»ÀID, mintœ’¿‡) And Not txt◊‹¡ø.Enabled Then
                If MakePriceRecord(vsAdvice.Row) Then
                    If Not gclsInsure.CheckItem(mintœ’¿‡, 0, 0, mrsPrice) Then
                        Call AdviceCurRowClear: Exit Sub
                    End If
                End If
                '±Íº«Œ™“—æ≠◊˜¡ÀºÏ≤È
                vsAdvice.Cell(flexcpData, vsAdvice.Row, COL_◊¥Ã¨) = 1
            End If
        End If
        txt“Ω÷ˆƒ⁄»›.SetFocus: Call SeekNextControl '±ÿ–Îœ»∂®Œª
        mblnNoSave = True
    Else
        'ª÷∏¥‘≠÷µ(AdviceInput∫Ø ˝÷–ø…ƒ‹¥¶¿Ì¡À“ªœ¬)
        txt“Ω÷ˆƒ⁄»›.Text = vsAdvice.TextMatrix(vsAdvice.Row, col_“Ω÷ˆƒ⁄»›)
        txt“Ω÷ˆƒ⁄»›.SetFocus
    End If
    Exit Sub
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Sub GetDataºÏ≤È…Í«Î(ByVal lngRow As Long, ByRef objAppPages() As clsApplicationData)
'π¶ƒ‹£∫¥”“Ω÷ˆ±Ì∏Ò÷–ªÒ»° ˝æ›…˙≥…∂‘œÛ÷ª¥´–¬ø™◊¥Ã¨µƒ“Ω÷ˆ∫ÕŒ¥±£¥Êµƒ“Ω÷ˆ ˝æ›
    Dim strSQL As String
    Dim rsTmp As ADODB.Recordset
    Dim strAppend As String, strExtData As String
    Dim lng…Í«Î–Ú∫≈ As Long
    Dim lngœ‡πÿID As Long
    Dim i As Long, j As Long
    Dim lngBegin As Long, lngEnd As Long
    Dim objTmp As clsApplicationData
    Dim varArr As Variant
    Dim strTmp As String
    Dim lngObjIndex As Long
    Dim str’Ô∂œ As String, str’Ô∂œIDs As String
 
    On Error GoTo errH
    With vsAdvice
        lngEnd = -1
        lngObjIndex = -1
        lng…Í«Î–Ú∫≈ = Val(.TextMatrix(lngRow, COL_…Í«Î–Ú∫≈))
        For i = .FixedRows To .Rows - 1
            If Val(.TextMatrix(i, COL_…Í«Î–Ú∫≈)) = lng…Í«Î–Ú∫≈ And i > lngEnd Then
                lngœ‡πÿID = Val(.RowData(i))
                lngBegin = i
                lngRow = i
                Set objTmp = New clsApplicationData
                objTmp.blnIsModify = True
                objTmp.blnAllowUpdate = True
                objTmp.blnIsAdditionalRec = False
                objTmp.lngProjectId = Val(.TextMatrix(lngRow, COL_’Ô¡∆œÓƒøID))
                objTmp.blnIsPriority = Val(.TextMatrix(lngRow, COL_±Í÷æ)) = 1
                objTmp.strStartExeTime = .TextMatrix(lngRow, COL_ø™ º ±º‰)
                objTmp.lngExeRoomId = Val(.TextMatrix(lngRow, COL_÷¥––ø∆ “ID))
                objTmp.strExeRoomName = Get≤ø√≈√˚≥∆(objTmp.lngExeRoomId)
                objTmp.lngExeRoomType = Val(.TextMatrix(lngRow, COL_÷¥–––‘÷ ))
                objTmp.strRequestTime = .TextMatrix(lngRow, COL_ø™÷ˆ ±º‰)
                objTmp.lngRequestRoomId = Val(.TextMatrix(lngRow, COL_ø™÷ˆø∆ “ID))
                
                If Val(.TextMatrix(lngRow, COL_EDIT)) <> 1 Then
                    str’Ô∂œIDs = GetAdviceDiag(.RowData(lngRow), str’Ô∂œ)
                    objTmp.strDiagnoseId = str’Ô∂œIDs
                End If
                
                strTmp = objTmp.Get…Í«Îµ•–≈œ¢(objTmp.lngProjectId, 1)
                If strTmp <> "" Then
                    objTmp.lngApplicationPageId = Val(Split(strTmp, "<Split>")(0))
                    objTmp.strApplicationPageName = Split(strTmp, "<Split>")(1)
                    objTmp.strRequestAffixCfg = objTmp.Get…Í«Î∏ΩœÓƒø≈‰÷√(objTmp.lngApplicationPageId)
                End If
                
                strExtData = GetºÏ≤È≤øŒª∑Ω∑®(lngRow)
                If InStr(strExtData, vbTab) > 0 Then
                    objTmp.strPartMethod = Split(strExtData, vbTab)(0)
                    objTmp.lngExeType = Val(Split(strExtData, vbTab)(1))
                End If
                
                strAppend = .TextMatrix(lngRow, COL_∏ΩœÓ)
                If strAppend <> "" Then
                    varArr = Split(strAppend, "<Split1>")
                    strAppend = ""
                    For j = 0 To UBound(varArr)
                        strTmp = varArr(j)
                        If strTmp <> "" Then
                            strAppend = strAppend & "|" & Split(strTmp, "<Split2>")(0) & ":" & Split(strTmp, "<Split2>")(3)
                        End If
                    Next
                    objTmp.strRequestAffix = Mid(strAppend, 2)
                End If
                
                For j = i + 1 To .Rows - 1
                    If Val(.TextMatrix(j, COL_œ‡πÿID)) = lngœ‡πÿID Then
                        lngEnd = j
                    Else
                        Exit For
                    End If
                Next
                lngObjIndex = lngObjIndex + 1
                ReDim Preserve objAppPages(lngObjIndex)
                Set objAppPages(lngObjIndex) = objTmp
            End If
        Next
    End With
    Exit Sub
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Function ApplyNewºÏ≤È…Í«Î(ByVal intType As Integer, ByVal strœÓƒøIDs As String, ByRef objAppPages() As clsApplicationData) As Boolean
'π¶ƒ‹£∫µ˜”√…Í«Îµ•
'≤Œ ˝£∫intType 0-–¬‘ˆ,1-–ﬁ∏ƒ
    Dim objPacspplication As New clsPacsApplication
    Dim lngœÓƒøid As Long
    Dim strSQL As String
    Dim rsPati As ADODB.Recordset
    On Error GoTo errH
    lngœÓƒøid = Val(strœÓƒøIDs)
    '≥ı ºªØºÏ≤È…Í«Îµ•∂‘œÛ
    Call objPacspplication.InitComponents(mlng≤°»Àø∆ “id, Me)
    ApplyNewºÏ≤È…Í«Î = objPacspplication.ShowApplicationForm(mlng≤°»ÀID, 1, mlngπ“∫≈ID, 0, intType, objAppPages(), , , lngœÓƒøid)
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Function AdviceSetºÏ≤È…Í«Î(ByVal lngRow As Long, ByRef objAppPages() As clsApplicationData) As Long
'π¶ƒ‹£∫∞—ºÏ≤È…Í«Îµ• ˝æ›º”‘ÿµΩ±Ì∏Ò÷–
    Dim objTmp As clsApplicationData
    Dim i As Long, j As Long, k As Long
    Dim lngCnt As Long, lng…Í«Î–Ú∫≈ As Long, lngCurRow As Long
    Dim strSQL As String, strAppend As String
    Dim varTmp As Variant, strTmp As String
    Dim rsInput As ADODB.Recordset
    Dim rsAppend As ADODB.Recordset
    Dim lngBegin As Long, lngEnd As Long
    Dim str’Ô∂œIDs As String
    Dim str∏ΩœÓƒ⁄»› As String
    
    On Error GoTo errH
    lng…Í«Î–Ú∫≈ = Get…Í«Î–Ú∫≈
    mblnRowChange = False
    For i = 0 To UBound(objAppPages)
        Set objTmp = objAppPages(i)
        strSQL = "Select a.√˚≥∆,a.Id As ’Ô¡∆œÓƒøid, Null As  ’∑—œ∏ƒøid,a.¿‡± As ¿‡±ID From ’Ô¡∆œÓƒøƒø¬º A where a.id=[1]"
        Set rsInput = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, objTmp.lngProjectId)
        strAppend = ""
        If objTmp.strRequestAffix <> "" Then
            strSQL = "Select C.œÓƒø,C.ƒ⁄»›,C.“™ÀÿID,C.±ÿÃÓ,d.÷–Œƒ√˚,decode(D.±Ì æ∑®,4,D. ˝÷µ”Ú,NULL) as  ˝÷µ”Ú" & _
                " From ≤°¿˙µ•æ›”¶”√ A,≤°¿˙Œƒº˛¡–±Ì B,≤°¿˙µ•æ›∏ΩœÓ C,’Ô÷ŒÀ˘º˚œÓƒø D" & _
                " Where A.’Ô¡∆œÓƒøID=[1] And A.”¶”√≥°∫œ=[2]" & _
                " And A.≤°¿˙Œƒº˛ID=B.ID And B.÷÷¿‡=7 And B.ID=C.Œƒº˛ID And c.“™Àÿid=d.id(+)" & _
                " Order by C.≈≈¡–"
            Set rsAppend = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, objTmp.lngProjectId, 1)
            varTmp = Split(objTmp.strRequestAffix, "|")
            For j = 0 To UBound(varTmp)
                If InStr(varTmp(j), ":") > 0 Then
                    rsAppend.Filter = "œÓƒø='" & Split(varTmp(j), ":")(0) & "'"
                    If Not rsAppend.EOF Then
                        strSQL = varTmp(j)
                        str∏ΩœÓƒ⁄»› = Replace(strSQL, Mid(strSQL, 1, InStr(strSQL, ":")), "")
                        strAppend = IIF(strAppend = "", "", strAppend & "<Split1>") & rsAppend!œÓƒø & "<Split2>" & Val(rsAppend!±ÿÃÓ & "") & _
                            "<Split2>" & rsAppend!“™ÀÿID & "<Split2>" & str∏ΩœÓƒ⁄»›
                    End If
                End If
            Next
        End If
        If i <> 0 Then
            vsAdvice.AddItem "", lngEnd + 1
            lngRow = lngEnd + 1
        End If
        str’Ô∂œIDs = objTmp.strDiagnoseId
        strTmp = objTmp.strPartMethod & vbTab & objTmp.lngExeType
        Call AdviceSet’Ô¡∆œÓƒø(rsInput, lngRow, 0, 0, strTmp, "")
        lngBegin = lngRow
        With vsAdvice
            For j = lngRow + 1 To .Rows - 1
                If Val(.TextMatrix(j, COL_œ‡πÿID)) = Val(.RowData(lngRow)) Then
                    lngEnd = j
                Else
                    Exit For
                End If
            Next
            If lngEnd < lngBegin Then lngEnd = lngBegin
            For j = lngBegin To lngEnd
                '∏¸–¬“ª–©œÓƒø
                .TextMatrix(j, COL_±Í÷æ) = IIF(objTmp.blnIsPriority, 1, 0) '√≈’ÔŒﬁ≤π¬º
                .TextMatrix(j, COL_ø™ º ±º‰) = Format(objTmp.strStartExeTime, "yyyy-MM-dd HH:mm")
                    .Cell(flexcpData, j, COL_ø™ º ±º‰) = .TextMatrix(j, COL_ø™ º ±º‰)
                .TextMatrix(j, COL_÷¥––ø∆ “ID) = IIF(objTmp.lngExeRoomId <= 0, 0, objTmp.lngExeRoomId)
                .TextMatrix(j, COL_÷¥–––‘÷ ) = objTmp.lngExeRoomType
                .TextMatrix(j, COL_ø™÷ˆ ±º‰) = Format(objTmp.strRequestTime, "yyyy-MM-dd HH:mm")
                    .Cell(flexcpData, j, COL_ø™÷ˆ ±º‰) = .TextMatrix(j, COL_ø™÷ˆ ±º‰)
                .TextMatrix(j, COL_ø™÷ˆø∆ “ID) = objTmp.lngRequestRoomId
                .TextMatrix(j, COL_…Í«Î–Ú∫≈) = lng…Í«Î–Ú∫≈
            Next
            .Cell(flexcpData, lngRow, COL_…Í«Î–Ú∫≈) = str’Ô∂œIDs
            '–¬‘ˆ∫Ûπÿ¡™’Ô∂œµƒ±Íº«¥¶¿Ì
            Call SetDiagFlag(lngRow, 1)
            '∏¸–¬∏Ωº˛ƒ⁄»›:“‘µ±«∞ø…º˚––Œ™◊º
            If strAppend <> "" Then
                .TextMatrix(lngRow, COL_∏ΩœÓ) = strAppend
                .Cell(flexcpData, lngRow, COL_∏ΩœÓ) = 1 '±Ì√˜–Ë“™÷ÿ–¬–¥»Î(–¬‘ˆªÚ–ﬁ∏ƒ)
                Call ReplaceAdviceAppend(lngRow) '»± °ÃÊªª∆‰À˚“Ω÷ˆµƒ…Í«Î∏ΩœÓ
            End If
            '÷ÿ–¬◊‘∂Øµ˜’˚––∏ﬂ
            Call .AutoSize(col_“Ω÷ˆƒ⁄»›)
            Call SetRow±Í÷æÕº±Í(lngRow, 0)
        End With
    Next
    vsAdvice.Row = lngRow
    mblnRowChange = True
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Sub GetData ‰—™…Í«Î(ByVal lngRow As Long, ByRef rsCard As ADODB.Recordset)
'π¶ƒ‹£∫¥”“Ω÷ˆ±Ì∏Ò÷–ªÒ»° ˝æ›…˙≥…∂‘œÛ÷ª¥´–¬ø™◊¥Ã¨µƒ“Ω÷ˆ∫ÕŒ¥±£¥Êµƒ“Ω÷ˆ ˝æ›
    Dim rsCardBak As ADODB.Recordset
    Dim rsTmp As ADODB.Recordset
    Dim rsTmpOther As New ADODB.Recordset
    Dim blnTmp As Boolean
    Dim lng“Ω÷ˆID As Long
    Dim strSQL As String
    Dim str’Ô∂œ As String
    Dim str’Ô∂œIDs As String
    Dim strTmp As String
    Dim var1 As Variant
    Dim var2 As Variant
    Dim i As Long, j As Long
    Dim str…Í«ÎœÓƒø As String, str ‰—™ƒøµƒ As String
    
    On Error GoTo errH
    With vsAdvice
        If TypeName(.Cell(flexcpData, lngRow, COL_…Í«Î–Ú∫≈)) = "Recordset" Then
            Set rsCard = zlDatabase.CopyNewRec(.Cell(flexcpData, lngRow, COL_…Í«Î–Ú∫≈))
        Else
            Call InitCardRsBlood(rsCard)
            rsCard.AddNew
        End If
        If Val(.TextMatrix(lngRow, COL_EDIT)) <> 1 Then
            lng“Ω÷ˆID = Val(.RowData(lngRow))
            
            strSQL = "Select ’Ô¡∆œÓƒøid, …Í«Î¡ø, …Í«Î—™–Õ, …Í«Îrh,—™“∫–≈œ¢ From  ‰—™…Í«ÎœÓƒø Where “Ω÷ˆid = [1]"
            Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, " ‰—™…Í«ÎœÓƒø", lng“Ω÷ˆID)
            Do While Not rsTmp.EOF
                str…Í«ÎœÓƒø = str…Í«ÎœÓƒø & ";" & rsTmp!’Ô¡∆œÓƒøID & "," & rsTmp!…Í«Î¡ø & "," & rsTmp!…Í«Î—™–Õ & "," & rsTmp!…Í«Îrh & IIF(rsTmp!—™“∫–≈œ¢ & "" <> "", "," & rsTmp!—™“∫–≈œ¢, "")
            rsTmp.MoveNext
            Loop
            If Left(str…Í«ÎœÓƒø, 1) = ";" Then str…Í«ÎœÓƒø = Mid(str…Í«ÎœÓƒø, 2)
            
            strSQL = "Select  «∑Ò¥˝’Ô as ¥˝’Ô, ‰—™¿‡–Õ, ‰—™ƒøµƒ,  ‰—™–‘÷ , º¥Õ˘ ‰—™ ∑, º»Õ˘ ‰—™∑¥”¶ ∑,  ‰—™Ω˚º…º∞π˝√Ù ∑, ‘–≤˙«Èøˆ,  ‹—™’ﬂ Ùµÿ,  ‰—™—™–Õ as —™–Õ, RHD" & vbNewLine & _
                " From  ‰—™…Í«Îº«¬º" & vbNewLine & _
                " Where “Ω÷ˆid = [1]"
            
            Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng“Ω÷ˆID)
            If Not rsTmp.EOF Then
                If Val(rsTmp!¥˝’Ô & "") = 0 Then
                   str’Ô∂œIDs = GetAdviceDiag(lng“Ω÷ˆID, str’Ô∂œ)
                    '¥”∏ΩœÓ÷–ªÒ»°’Ô∂œ»Áπ˚∏ΩœÓ÷–”–“‘∏ΩœÓŒ™◊º
                    strSQL = "select ƒ⁄»› from ≤°»À“Ω÷ˆ∏Ωº˛ where “Ω÷ˆID=[1] and œÓƒø='…Í«Îµ•’Ô∂œ'"
                    Set rsTmpOther = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng“Ω÷ˆID)
                    If Not rsTmpOther.EOF Then str’Ô∂œ = rsTmpOther!ƒ⁄»› & ""
                End If
                rsCard!¡Ÿ¥≤’Ô∂œIDs = str’Ô∂œIDs
                rsCard!¡Ÿ¥≤’Ô∂œ√Ë ˆ = str’Ô∂œ
                rsCard!—™–Õ = Val(rsTmp!—™–Õ & "")
                rsCard!RHD = Val(rsTmp!RHD & "")
                rsCard!¥˝’Ô = Val(rsTmp!¥˝’Ô & "")
                rsCard! ‰—™–‘÷  = Val(rsTmp! ‰—™–‘÷  & "")
                rsCard!º¥Õ˘ ‰—™ ∑ = Val(rsTmp!º¥Õ˘ ‰—™ ∑ & "")
                rsCard!º»Õ˘ ‰—™∑¥”¶ ∑ = Val(rsTmp!º»Õ˘ ‰—™∑¥”¶ ∑ & "")
                rsCard! ‰—™Ω˚º…º∞π˝√Ù ∑ = Val(rsTmp! ‰—™Ω˚º…º∞π˝√Ù ∑ & "")
                rsCard! ‰—™¿‡–Õ = rsTmp! ‰—™¿‡–Õ & ""
                rsCard! ‰—™ƒøµƒ = rsTmp! ‰—™ƒøµƒ & ""
                str ‰—™ƒøµƒ = rsTmp! ‰—™ƒøµƒ & ""
                rsCard!‘–≤˙«Èøˆ = Val(rsTmp!‘–≤˙«Èøˆ & "")
                rsCard! ‹—™’ﬂ Ùµÿ = Val(rsTmp! ‹—™’ﬂ Ùµÿ & "")
            End If
            var2 = Array()
            strSQL = "select –Ú∫≈,ºÏ—ÈœÓƒøID,÷∏±Í¥˙¬Î,÷∏±Í÷–Œƒ√˚,÷∏±Í”¢Œƒ√˚,÷∏±ÍΩ·π˚,Ω·π˚µ•Œª,Ω·π˚±Í÷æ,Ω·π˚≤Œøº,»°÷µ–Ú¡–, «∑Ò»Àπ§ÃÓ–¥ from  ‰—™ºÏ—ÈΩ·π˚ Where “Ω÷ˆID=[1] order by –Ú∫≈"
            Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, lng“Ω÷ˆID)
            For i = 1 To rsTmp.RecordCount
                var1 = Array()
                For j = 0 To rsTmp.Fields.Count - 1
                    ReDim Preserve var1(j)
                    var1(j) = rsTmp.Fields(j).value & ""
                Next
                strTmp = Join(var1, "<SplitCol>")
                ReDim Preserve var2(UBound(var2) + 1)
                var2(UBound(var2)) = strTmp
                rsTmp.MoveNext
            Next
            rsCard!ºÏ≤ÈΩ·π˚ = Join(var2, "<SplitRow>")
        End If
        
        rsCard!…Í«ÎœÓƒø = str…Í«ÎœÓƒø
        If str ‰—™ƒøµƒ = "" Then rsCard! ‰—™ƒøµƒ = .TextMatrix(lngRow, COL_”√“©¿Ì”…)
        rsCard!”√—™∞≤≈≈ = Val(.TextMatrix(lngRow, COL_±Í÷æ))
        rsCard!‘§∂® ‰—™»’∆⁄ = .TextMatrix(lngRow, COL_ ‰—™ ±º‰)
        rsCard! ‰—™œÓƒøID = Val(.TextMatrix(lngRow, COL_’Ô¡∆œÓƒøID))
        rsCard! ‰—™÷¥––ø∆ “ID = Val(.TextMatrix(lngRow, COL_÷¥––ø∆ “ID))
        rsCard!‘§∂® ‰—™¡ø = Val(.TextMatrix(lngRow, COL_◊‹¡ø))
        rsCard! ‰—™Õææ∂œÓƒøID = Val(.TextMatrix(lngRow + 1, COL_’Ô¡∆œÓƒøID))
        rsCard! ‰—™Õææ∂÷¥––ø∆ “ID = Val(.TextMatrix(lngRow + 1, COL_÷¥––ø∆ “ID))
        rsCard!±∏◊¢ = .TextMatrix(lngRow, COL_“Ω…˙÷ˆÕ–)
        rsCard! ‰—™…Í«Î»’∆⁄ = .TextMatrix(lngRow, COL_ø™ º ±º‰)
        rsCard!…Í«Îø∆ “ID = .TextMatrix(lngRow, COL_ø™÷ˆø∆ “ID)
        rsCard!µŒÀŸ = .TextMatrix(lngRow + 1, COL_“Ω…˙÷ˆÕ–)
        rsCard.Update
    End With
    
    Exit Sub
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Function ApplyNew ‰—™…Í«Î(ByVal intType As Integer, ByVal strœÓƒøIDs As String, ByRef rsCard As ADODB.Recordset, Optional ByVal bln±∏—™ As Boolean = True) As Boolean
'π¶ƒ‹£∫µ˜”√…Í«Îµ•
'≤Œ ˝£∫intType 0-–¬‘ˆ,1-–ﬁ∏ƒ
    Dim lngœÓƒøid As Long
    Dim lngø™÷ˆø∆ “ID As Long
    
    On Error GoTo errH
    lngœÓƒøid = Val(strœÓƒøIDs)
 
    ' ‰—™“Ω÷ˆºÏ≤È£¨±ÿ–Î÷–º∂º∞“‘…œ◊®“µºº ı÷∞ŒÒµƒ“Ω ¶≤≈‘ –Ìœ¬¥Ô
    If gbln ‰—™…Í«Î÷–º∂“‘…œ Then
        If UserInfo.◊®“µºº ı÷∞ŒÒ <> "÷˜÷Œ“Ω ¶" And UserInfo.◊®“µºº ı÷∞ŒÒ <> "÷˜»Œ“Ω ¶" And UserInfo.◊®“µºº ı÷∞ŒÒ <> "∏±÷˜»Œ“Ω ¶" Then
            MsgBox "∆Ù”√¡À ‰—™∑÷º∂π‹¿Ì∫Û£¨ ‰—™“Ω÷ˆ÷ª”–÷–º∂º∞“‘…œ◊®“µºº ı÷∞ŒÒ“Ω ¶≤≈ƒ‹œ¬¥Ô°£", vbInformation, Me.Caption
            Exit Function
        End If
    End If
    
    lngø™÷ˆø∆ “ID = Getø™÷ˆø∆ “ID(UserInfo.ID, mlng“Ωººø∆ “ID, mlng≤°»Àø∆ “id, 2)
    
    If Not rsCard Is Nothing Then
        If Not rsCard.EOF Then
            If Val(rsCard!…Í«Îø∆ “ID & "") <> 0 Then
                lngø™÷ˆø∆ “ID = Val(rsCard!…Í«Îø∆ “ID & "")
            End If
        End If
    End If
    
    If gbln—™ø‚œµÕ≥ = True Then
        ApplyNew ‰—™…Í«Î = frmBloodApplyNew.ShowMe(Me, mlng≤°»ÀID, 0, 1, intType, 0, mlng≤°»Àø∆ “id, _
             , lngø™÷ˆø∆ “ID, , , mrsDefine, , 1, mstrπ“∫≈µ•, , lngœÓƒøid, rsCard, mint”§∂˘, 1, IIF(bln±∏—™ = True, 0, 1))
    Else
        ApplyNew ‰—™…Í«Î = frmBloodApply.ShowMe(Me, mlng≤°»ÀID, 0, 1, intType, 0, mlng≤°»Àø∆ “id, _
             , lngø™÷ˆø∆ “ID, , , mrsDefine, , 1, mstrπ“∫≈µ•, , lngœÓƒøid, rsCard, mint”§∂˘, 1)
    End If
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Function AdviceSet ‰—™…Í«Î(ByVal lngRow As Long, ByRef rsCard As ADODB.Recordset) As Long
'π¶ƒ‹£∫∞—ºÏ≤È…Í«Îµ• ˝æ›º”‘ÿµΩ±Ì∏Ò÷–
    Dim objTmp As clsApplicationData
    Dim i As Long, j As Long, k As Long
    Dim lngCnt As Long, lng…Í«Î–Ú∫≈ As Long, lngCurRow As Long
    Dim strSQL As String, strAppend As String
    Dim varTmp As Variant, strTmp As String
    Dim rsInput As ADODB.Recordset
    Dim rsAppend As ADODB.Recordset
    Dim lngBegin As Long, lngEnd As Long
    Dim arrItem, strIDs As String
    
    On Error GoTo errH
    lng…Í«Î–Ú∫≈ = Get…Í«Î–Ú∫≈
    mblnRowChange = False
    
    strSQL = "Select a.√˚≥∆,a.Id As ’Ô¡∆œÓƒøid, Null As  ’∑—œ∏ƒøid,a.¿‡± As ¿‡±ID From ’Ô¡∆œÓƒøƒø¬º A where a.id=[1]"
    Set rsInput = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, Val(rsCard! ‰—™œÓƒøID & ""))
    Call AdviceSet’Ô¡∆œÓƒø(rsInput, lngRow, Val(rsCard! ‰—™Õææ∂œÓƒøID & ""), 0, "", "")
    
    '±∏—™…Í«Îø…ƒ‹…Í«Î∂‡∏ˆ∆∑÷÷£¨¥À¥¶÷ÿ–¬…Ë÷√√˚≥∆¡–
    arrItem = Split(rsCard!…Í«ÎœÓƒø & "", ";")
    strIDs = ""
    If UBound(arrItem) > 0 Then
        For i = 0 To UBound(arrItem)
            strIDs = strIDs & "," & Val(arrItem(i))
        Next
        strIDs = Mid(strIDs, 2)
        strSQL = "Select /*+ CARDINALITY(C 10) */" & vbNewLine & _
            "  f_List2str(Cast(Collect(a.√˚≥∆) As t_Strlist)) √˚≥∆" & vbNewLine & _
            " From ’Ô¡∆œÓƒøƒø¬º a, Table(f_Num2list([1])) b" & vbNewLine & _
            " Where a.Id = b.Column_Value"
        Set rsInput = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, strIDs)
        If rsInput.EOF = False Then
            vsAdvice.TextMatrix(lngRow, COL_√˚≥∆) = rsInput!√˚≥∆
        End If
    End If
    
    With vsAdvice
        For j = lngRow To lngRow + 1
            '∏¸–¬“ª–©œÓƒø
            .TextMatrix(j, COL_±Í÷æ) = rsCard!”√—™∞≤≈≈
            .TextMatrix(j, COL_ø™÷ˆ ±º‰) = rsCard! ‰—™…Í«Î»’∆⁄ '", adVarChar, 500
            .TextMatrix(j, COL_ø™ º ±º‰) = rsCard! ‰—™…Í«Î»’∆⁄
            .Cell(flexcpData, j, COL_ø™ º ±º‰) = .TextMatrix(j, COL_ø™ º ±º‰)
            .Cell(flexcpData, j, COL_ø™÷ˆ ±º‰) = .TextMatrix(j, COL_ø™÷ˆ ±º‰)
            .TextMatrix(j, COL_ø™÷ˆø∆ “ID) = Val(rsCard!…Í«Îø∆ “ID & "")
            .TextMatrix(j, COL_…Í«Î–Ú∫≈) = lng…Í«Î–Ú∫≈
        Next
        .TextMatrix(lngRow, COL_ ‰—™ ±º‰) = rsCard!‘§∂® ‰—™»’∆⁄
        .TextMatrix(lngRow, COL_◊‹¡ø) = rsCard!‘§∂® ‰—™¡ø
        .TextMatrix(lngRow, COL_“Ω…˙÷ˆÕ–) = rsCard!±∏◊¢
        .TextMatrix(lngRow, COL_”√“©¿Ì”…) = rsCard! ‰—™ƒøµƒ
        .TextMatrix(lngRow, COL_÷¥––ø∆ “ID) = Val(rsCard! ‰—™÷¥––ø∆ “ID & "")
        .TextMatrix(lngRow + 1, COL_÷¥––ø∆ “ID) = Val(rsCard! ‰—™Õææ∂÷¥––ø∆ “ID & "")
        .TextMatrix(lngRow + 1, COL_“Ω…˙÷ˆÕ–) = rsCard!µŒÀŸ & ""
        '–¬‘ˆ∫Ûπÿ¡™’Ô∂œµƒ±Íº«¥¶¿Ì
        Call SetDiagFlag(lngRow, 1)
        Set .Cell(flexcpData, lngRow, COL_…Í«Î–Ú∫≈) = zlDatabase.CopyNewRec(rsCard)
        .TextMatrix(lngRow, col_“Ω÷ˆƒ⁄»›) = AdviceTextMake(lngRow)
        '÷ÿ–¬◊‘∂Øµ˜’˚––∏ﬂ
        Call .AutoSize(col_“Ω÷ˆƒ⁄»›)
    End With
    vsAdvice.Row = lngRow
    mblnRowChange = True
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Sub GetDataºÏ—È…Í«Î(ByVal lngRow As Long, ByRef rsCard As ADODB.Recordset)
'π¶ƒ‹£∫¥”“Ω÷ˆ±Ì∏Ò÷–ªÒ»° ˝æ›…˙≥…∂‘œÛ÷ª¥´–¬ø™◊¥Ã¨µƒ“Ω÷ˆ∫ÕŒ¥±£¥Êµƒ“Ω÷ˆ ˝æ›
    Dim rsCardBak As ADODB.Recordset
    Dim rsTmp As ADODB.Recordset
    Dim blnTmp As Boolean
    Dim strSQL As String
    Dim str’Ô∂œ As String
    Dim str’Ô∂œIDs As String
    Dim strTmp As String
    Dim var1 As Variant
    Dim var2 As Variant
    Dim i As Long, j As Long
    Dim strLIS As String
    Dim strResult As String
    Dim lng…Í«Î–Ú∫≈ As Long
    Dim strAppend As String
    
    On Error GoTo errH
    With vsAdvice
    
        If TypeName(.Cell(flexcpData, lngRow, COL_…Í«Î–Ú∫≈)) = "Recordset" Then
            Set rsCard = zlDatabase.CopyNewRec(.Cell(flexcpData, lngRow, COL_…Í«Î–Ú∫≈))
        Else
            Call InitCardRsLIS(rsCard)
            rsCard.AddNew
        End If
        If Val(.TextMatrix(lngRow, COL_EDIT)) <> 1 Then
            str’Ô∂œIDs = GetAdviceDiag(Val(.RowData(lngRow)), str’Ô∂œ)
            rsCard!¡Ÿ¥≤’Ô∂œIDs = str’Ô∂œIDs
        End If
     
        lng…Í«Î–Ú∫≈ = Val(.TextMatrix(lngRow, COL_…Í«Î–Ú∫≈))
        For i = .FixedRows To .Rows - 1
            'ºÏ—È“Ω÷ˆœ‘ æ–– «≤…ºØ∑Ω Ω
            If Val(.TextMatrix(i, COL_…Í«Î–Ú∫≈)) = lng…Í«Î–Ú∫≈ And Not .RowHidden(i) Then
         
                lngRow = i
                '≤…’Ôø∆ “id , ÷¥––ø∆ “id, …Í«Î ±º‰1, ±Í±æ1, ∏ΩœÓ, ÷ˆÕ–,  «∑Òº±÷¢, ≤…ºØid, ’Ô¡∆œÓƒøid1
                strLIS = .TextMatrix(lngRow, COL_÷¥––ø∆ “ID) & "<Split A>" & .TextMatrix(lngRow - 1, COL_÷¥––ø∆ “ID) & "<Split A>" & .TextMatrix(lngRow, COL_ø™ º ±º‰) & _
                      "<Split A>" & .TextMatrix(lngRow, COL_±Í±æ≤øŒª)
                strAppend = .TextMatrix(lngRow, COL_∏ΩœÓ)
                If strAppend = "" And Val(.TextMatrix(lngRow, COL_EDIT)) <> 1 Then
                     strAppend = Get≤°»À“Ω÷ˆ∏Ωº˛(.RowData(lngRow))
                End If
                strLIS = strLIS & "<Split A>" & strAppend & "<Split A>" & .TextMatrix(lngRow, COL_“Ω…˙÷ˆÕ–) & "<Split A>" & Val(.TextMatrix(lngRow, COL_±Í÷æ)) & "<Split A>" & .TextMatrix(lngRow, COL_’Ô¡∆œÓƒøID) & "<Split A>" & .TextMatrix(lngRow - 1, COL_’Ô¡∆œÓƒøID)
                If strLIS <> "" Then
                    strResult = strLIS & IIF(strResult = "", "", "<Split B>" & strResult)
                End If
            End If
        Next
        rsCard!…Í«Î–≈œ¢ = strResult
        rsCard.Update
    End With
    
    Exit Sub
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub

Private Function ApplyNewºÏ—È…Í«Î(ByVal intType As Integer, ByVal strœÓƒø±‡¬Î As String, ByRef rsCard As ADODB.Recordset) As Boolean
'π¶ƒ‹£∫µ˜”√…Í«Îµ•
'≤Œ ˝£∫intType 0-–¬‘ˆ,1-–ﬁ∏ƒ
    Dim lngø™÷ˆø∆ “ID As Long
    Dim strSQL As String
    Dim rsPati As ADODB.Recordset
    Dim strResult As String
    Dim strDept As String
    Dim lng…Í«Î–Ú∫≈ As String
    Dim strDiag As String
    Dim blnCancel As Boolean
    Dim strErr As String
    Dim strLIS As String

    On Error GoTo errH
    
    '÷¥––≤ø√≈(∫≈±ø∆ “)º¥≤°»Àø∆ “
    strSQL = "Select A.–’√˚,A.–‘±,A.ƒÍ¡‰,B.√≈’Ô∫≈,B.◊°‘∫∫≈,B.Ω°øµ∫≈,a.ID as π“∫≈ID," & _
        " B.œ’¿‡,B.æÕ’Ô’Ô “,C.√˚≥∆ as ÷¥––≤ø√≈,A.µ«º« ±º‰" & _
        " From ≤°»Àπ“∫≈º«¬º A,≤°»À–≈œ¢ B,≤ø√≈±Ì C" & _
        " Where A.NO(+)=[2] And a.º«¬º–‘÷ (+)=1 And a.º«¬º◊¥Ã¨(+)=1 And B.≤°»ÀID=[1]" & _
        " And A.≤°»ÀID(+)=B.≤°»ÀID And A.÷¥––≤ø√≈ID=C.ID(+)"
 
    Set rsPati = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng≤°»ÀID, mstrπ“∫≈µ•)
    
    If rsPati.RecordCount = 0 Then
        MsgBox "Œ¥ƒ‹’˝»∑∂¡»°≤°»À–≈œ¢£°", vbInformation, gstrSysName
        Exit Function
    End If
    
    strDept = Get≤ø√≈√˚≥∆(mlng≤°»Àø∆ “id)
    Call InitObjLis(p√≈’Ô“Ω÷ˆœ¬¥Ô)
    If gobjLIS Is Nothing Then Exit Function
    Call CreatePlugInOK(p√≈’Ô“Ω÷ˆœ¬¥Ô, mint≥°∫œ)
    On Error GoTo errH
    If Not rsCard Is Nothing Then
        If Not rsCard.EOF Then
            strLIS = rsCard!…Í«Î–≈œ¢ & ""
            strDiag = rsCard!¡Ÿ¥≤’Ô∂œIDs & ""
        End If
    End If
    strResult = gobjLIS.ShowLisApplicationForm(mfrmParent, 0, mlng≤°»ÀID, 0, Val("" & rsPati!π“∫≈ID), rsPati!–’√˚, "" & rsPati!–‘±, "" & rsPati!ƒÍ¡‰, 1, _
        Val("" & rsPati!√≈’Ô∫≈), Val("" & rsPati!◊°‘∫∫≈), Val("" & rsPati!Ω°øµ∫≈), strDiag, UserInfo.–’√˚, UserInfo.≤ø√≈ID, UserInfo.≤ø√≈√˚, mlng≤°»Àø∆ “id, strDept, blnCancel, strErr, strLIS, strœÓƒø±‡¬Î)
    
    If strErr <> "" Then
        MsgBox "ºÏ—ÈΩ”ø⁄ƒ⁄≤ø¥ÌŒÛ£∫" & strErr, vbInformation, gstrSysName
        Exit Function
    ElseIf blnCancel Then
        Exit Function
    End If
    
    Call InitCardRsLIS(rsCard)
    rsCard.AddNew Array("¡Ÿ¥≤’Ô∂œIDs", "…Í«Î–≈œ¢"), Array(strDiag, strResult)
    ApplyNewºÏ—È…Í«Î = True
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Function AdviceSetºÏ—È…Í«Î(ByVal lngRow As Long, ByRef rsCard As ADODB.Recordset) As Long
'π¶ƒ‹£∫∞—ºÏ≤È…Í«Îµ• ˝æ›º”‘ÿµΩ±Ì∏Ò÷–
    Dim i As Long, j As Long
    Dim varTmp As Variant, strTmp As String
    Dim varArr As Variant
    Dim lng…Í«Î–Ú∫≈ As Long
    Dim strLIS As String
    Dim str’Ô∂œ As String
    Dim str∏ΩœÓ As String
    
    On Error GoTo errH
    mblnRowChange = False
    strLIS = rsCard!…Í«Î–≈œ¢ & ""
    str’Ô∂œ = rsCard!¡Ÿ¥≤’Ô∂œIDs & ""
    If str’Ô∂œ <> "" Then
        str’Ô∂œ = GetDiag’Ô∂œ√Ë ˆ(str’Ô∂œ)
        If str’Ô∂œ <> "" Then
            str’Ô∂œ = "…Í«Îµ•’Ô∂œ<Split2>0<Split2><Split2>" & str’Ô∂œ
        End If
    End If
    varTmp = Split(strLIS, "<Split B>")
    For i = 0 To UBound(varTmp)
        If i <> 0 Then
            vsAdvice.AddItem "", lngRow + 1
            lngRow = lngRow + 1
        End If
        lng…Í«Î–Ú∫≈ = Get…Í«Î–Ú∫≈
        varArr = Split(varTmp(i), "<Split A>")
        Call AdviceSetºÏ—È◊È∫œ(lngRow, Val(varArr(7)), varArr(8) & ";" & varArr(3), , , True)
        lngRow = lngRow + 1
        With vsAdvice
            For j = lngRow - 1 To lngRow
                .TextMatrix(j, COL_±Í÷æ) = Val(varArr(6))
                .TextMatrix(j, COL_ø™÷ˆ ±º‰) = varArr(2)
                    .Cell(flexcpData, j, COL_ø™÷ˆ ±º‰) = .TextMatrix(j, COL_ø™÷ˆ ±º‰)
                .TextMatrix(j, COL_…Í«Î–Ú∫≈) = lng…Í«Î–Ú∫≈
            Next
            .TextMatrix(lngRow, COL_÷¥––ø∆ “ID) = Val(varArr(0))
            .TextMatrix(lngRow, COL_“Ω…˙÷ˆÕ–) = varArr(5)
            .TextMatrix(lngRow, COL_’Ô¡∆œÓƒøID) = Val(varArr(7))
            .TextMatrix(lngRow - 1, COL_÷¥––ø∆ “ID) = Val(varArr(1))
            
            str∏ΩœÓ = varArr(4)
            If str∏ΩœÓ <> "" And str’Ô∂œ <> "" Then
                str∏ΩœÓ = str∏ΩœÓ & "<Split1>" & str’Ô∂œ
            ElseIf str∏ΩœÓ = "" And str’Ô∂œ <> "" Then
                str∏ΩœÓ = str’Ô∂œ
            End If
            If str∏ΩœÓ <> "" Then
                .TextMatrix(lngRow, COL_∏ΩœÓ) = str∏ΩœÓ
                .Cell(flexcpData, lngRow, COL_∏ΩœÓ) = 1
            End If
            
            Set .Cell(flexcpData, lngRow, COL_…Í«Î–Ú∫≈) = zlDatabase.CopyNewRec(rsCard)
            Call .AutoSize(col_“Ω÷ˆƒ⁄»›)
        End With
        Call SetDiagFlag(lngRow, 1)
        Call SetRow±Í÷æÕº±Í(lngRow, 0)
    Next
    vsAdvice.Row = lngRow
    mblnRowChange = True
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Function Checkµ•∂¿”¶”√(ByVal lngRow As Long, ByRef strMsg As String) As Boolean
    'ºÏ≤È «∑Ò”–“Ω÷ˆµƒ’Ô¡∆œÓƒøŒ¥π¥—°°∞ø…“‘µ•∂¿”¶”√°±°£
    With vsAdvice
        If Not (InStr(",4,5,6,7,G,", .TextMatrix(lngRow, COL_¿‡±)) > 0) Then
            If Not (.TextMatrix(lngRow, COL_¿‡±) = "E" And InStr(",2,3,4,6,7,8,9,", .TextMatrix(lngRow, COL_≤Ÿ◊˜¿‡–Õ)) > 0) Then
                If Val(.TextMatrix(lngRow, COL_µ•∂¿”¶”√)) = 0 And Val(.TextMatrix(lngRow, COL_’Ô¡∆œÓƒøID)) <> 0 Then
                        strMsg = "°±∂‘”¶µƒ’Ô¡∆œÓƒø≤ªƒ‹µ•∂¿”¶”√£°"
                        Checkµ•∂¿”¶”√ = False
                        Exit Function
                End If
            End If
        End If
    End With
    Checkµ•∂¿”¶”√ = True
End Function

Private Sub MakeAppNo(ByVal intType As Integer, ByVal lngBegin As Long, ByVal lngEnd As Long)
'π¶ƒ‹£∫∏¯±Ì∏Ò…œµƒ“Ω÷ˆ ˝æ›≤˙…˙…Í«Î–Ú∫≈
'≤Œ ˝£∫lngBegin - lngEnd ±Ì∏Ò––µƒ∑∂Œß£¨intType £≠1 µ•◊È“Ω÷ˆ£¨2£≠∂‡◊È“Ω÷ˆ
    Dim str¿‡± As String
    Dim lngNo As Long
    Dim lngœÓƒøid As Long
    Dim i As Long, j As Long
    Dim lng◊ÈID As Long
    Dim lngPre◊ÈID As Long
    Dim lngStart As Long
    Dim lngStop As Long
    
    On Error GoTo errH
    With vsAdvice
        If intType = 1 Then
            str¿‡± = .TextMatrix(lngBegin, COL_¿‡±)
            lngœÓƒøid = Val(.TextMatrix(lngBegin, COL_’Ô¡∆œÓƒøID))
            Select Case str¿‡±
            Case "D", "C"
                If CanUseApply(str¿‡±, lngœÓƒøid) Then
                    lngNo = -1 * Get…Í«Î–Ú∫≈
                End If
            Case "K"
                If CanUseApply("K", lngœÓƒøid) Then
                    lngNo = -1 * Get…Í«Î–Ú∫≈
                End If
            End Select
            If lngNo <> 0 Then
                For i = lngBegin To lngEnd
                    .TextMatrix(i, COL_…Í«Î–Ú∫≈) = lngNo
                Next
            End If
        Else
            For i = lngBegin To lngEnd
                If Val(.TextMatrix(i, COL_œ‡πÿID)) = 0 Then
                    lng◊ÈID = .RowData(i)
                Else
                    lng◊ÈID = Val(.TextMatrix(i, COL_œ‡πÿID))
                End If
                
                lngStop = -1
                lngStart = i
                For j = i + 1 To lngEnd
                    If lng◊ÈID = IIF(Val(.TextMatrix(j, COL_œ‡πÿID)) = 0, Val(.RowData(j)), Val(.TextMatrix(j, COL_œ‡πÿID))) Then
                        lngStop = j
                    Else
                        Exit For
                    End If
                Next
                If lngStop = -1 Then lngStop = lngStart
                
                Call MakeAppNo(1, lngStart, lngStop)
                
                If lngStop = lngEnd Then
                    Exit Sub
                Else
                    i = lngStop
                End If
            Next
        End If
    End With
    Exit Sub
errH:
    If ErrCenter = 1 Then
        Resume
    End If
End Sub

Private Sub Make’Ô∂œ“Ω÷ˆ∂‘”¶(ByRef arrSQL As Variant, ByVal str“Ω÷ˆIDs As String, ByVal lng’Ô∂œID As Long)
'π¶ƒ‹£∫…˙≥…’Ô∂œ“Ω÷ˆ∂‘”¶µƒø…÷¥––SQLŒ Ã‚∫≈102666
    Dim varTmp As Variant
    Dim i As Long
    Dim strTmp As String
    Dim strIDs As String
    varTmp = Array()
    strIDs = str“Ω÷ˆIDs
    
    Do While Len(strIDs) > 4000
        strTmp = Mid(strIDs, 1, 3980)
        strTmp = Mid(strTmp, 1, InStrRev(strTmp, ",") - 1)
        ReDim Preserve varTmp(UBound(varTmp) + 1)
        varTmp(UBound(varTmp)) = strTmp
        strIDs = Replace(strIDs, strTmp & ",", "")
    Loop
    If strIDs <> "" Then
        ReDim Preserve varTmp(UBound(varTmp) + 1)
        varTmp(UBound(varTmp)) = strIDs
    End If
    For i = 0 To UBound(varTmp)
        ReDim Preserve arrSQL(UBound(arrSQL) + 1)
        arrSQL(UBound(arrSQL)) = "Zl_≤°»À’Ô∂œ“Ω÷ˆ_Insert(NULL,NULL," & lng’Ô∂œID & ",'" & varTmp(i) & "')"
    Next
End Sub

Private Function GetNext“Ω÷ˆID() As Long
'π¶ƒ‹£∫…˙≥…¡Ÿ ±µƒ“Ω÷ˆID
    mlngID–Ú¡– = mlngID–Ú¡– - 1
    GetNext“Ω÷ˆID = mlngID–Ú¡–
End Function

Private Function GetID÷∏∂®÷µ(ByRef colIn As Collection, ByVal strKey As String) As Long
'π¶ƒ‹£∫ªÒ»°÷∏∂®µƒ’Ê µ“Ω÷ˆID£¨”√ºØ∫œ∑Ω Ω…˙≥…º¸÷µ∂‘
    Dim strID As String
    
    On Error Resume Next
    
    strID = colIn(strKey)
    If err.Number <> 0 Then
        strID = zlDatabase.GetNextID("≤°»À“Ω÷ˆº«¬º")
        colIn.Add strID, strKey
    End If
    err.Clear
    
    GetID÷∏∂®÷µ = Val(strID)
End Function

Private Sub MakeRealID()
'π¶ƒ‹£∫Ω´“Ω÷ˆ±Ì∏Ò÷–µƒ“Ω÷ˆID…˙≥…Œ™’Ê µµƒ“Ω÷ˆID£¨∞¸∫¨’Ô∂œ“Ω÷ˆ∂‘”¶÷–µƒ“Ω÷ˆID
'Àµ√˜£∫Ã·Ωª ˝æ› ±ø…ƒ‹ ß∞‹£¨ø…ƒ‹ª·±ª÷ÿ∏¥÷¥––£¨ø…“‘”√µ±«∞÷µ «∑Ò¥Û”⁄0Ω¯––≈–∂œ£¨÷ª”–±æ¥Œ–¬µƒ“Ω÷ˆ≤≈–Ë“™÷ÿ–¬≤˙…˙
    Dim i As Long, j As Long
    Dim colID As New Collection
    Dim varTmp As Variant
    Dim str“Ω÷ˆIDs As String
    Screen.MousePointer = 11
    With vsAdvice
        For i = .FixedRows To .Rows - 1
            If InStr("1,2", Val(.TextMatrix(i, COL_EDIT))) > 0 Then   'À˘”–“Ω÷ˆº«¬º
                If Val(.RowData(i)) < 0 Then
                    .RowData(i) = GetID÷∏∂®÷µ(colID, CStr(.RowData(i)))
                End If
                If Val(.TextMatrix(i, COL_œ‡πÿID)) < 0 Then
                    .TextMatrix(i, COL_œ‡πÿID) = GetID÷∏∂®÷µ(colID, CStr(Val(.TextMatrix(i, COL_œ‡πÿID))))
                End If
            End If
        Next
    End With
    
    With vsDiag
        For i = .FixedRows To .Rows - 1
            If Trim(.TextMatrix(i, col’Ô∂œ)) <> "" Then
                If "" <> .TextMatrix(i, col“Ω÷ˆID) Then
                    varTmp = Split(.TextMatrix(i, col“Ω÷ˆID), ",")
                    str“Ω÷ˆIDs = ""
                    For j = 0 To UBound(varTmp)
                        If Val(varTmp(j)) < 0 Then
                            str“Ω÷ˆIDs = str“Ω÷ˆIDs & "," & GetID÷∏∂®÷µ(colID, CStr(Val(varTmp(j))))
                        Else
                            str“Ω÷ˆIDs = str“Ω÷ˆIDs & "," & Val(varTmp(j))
                        End If
                    Next
                    .TextMatrix(i, col“Ω÷ˆID) = Mid(str“Ω÷ˆIDs, 2)
                End If
            End If
        Next
    End With
    Screen.MousePointer = 0
End Sub


Private Sub UpdateRecipeNo()
'π¶ƒ‹:ªÒ»°¥¶∑Ω–Ú∫≈
'Àµ√˜:¥¶∑Ω–Ú∫≈…˙≥…πÊ‘Ú
'1-Œ˜“©∫Õ÷–≥…“©≤˙…˙“ª∏ˆ¥¶∑Ω–Ú∫≈£¨÷–“©“˚∆¨”¶µ±µ•∂¿≤˙…˙¥¶∑Ω–Ú∫≈°£
'2-Œ˜“©∫Õ÷–≥…“©√ø’≈¥¶∑Ω≤ªµ√≥¨π˝5÷÷“©∆∑£®“ª≤¢∏¯“©À„“ª÷÷“©∆∑£©°£
'
    Dim i               As Long
    Dim j               As Long
    Dim rsRecipe        As ADODB.Recordset
    Dim lng“Ω÷ˆID       As Long
    Dim lngSumCount     As Long
    Dim lngCount        As Long
    Dim lngNo           As Long
    Dim lngTemp         As Long
    Dim lngRecipeCount  As Long    '¥¶∑ΩÃı ˝ =5
    
    lngRecipeCount = 5
    'ππ‘Ïª∫¥Ê“Ω÷ˆID”Î¥¶∑Ω–Ú∫≈µƒº«¬ººØª∫¥Ê
    Set rsRecipe = New ADODB.Recordset
    With rsRecipe
        .Fields.Append "“Ω÷ˆID", adBigInt '“ª◊È“Ω÷ˆµƒID
        .Fields.Append "RecipeNo", adBigInt
        .Fields.Append "Type", adInteger    '1-Œ˜“©∫Õ÷–≥…“©;2-÷–“©“˚∆¨
        .Fields.Append "Tag", adInteger    '1-“—æ≠≤˙…˙¥¶∑Ω–Ú∫≈;2-–Ë“™–¬‘ˆ¥¶∑Ω–Ú∫≈
        .CursorLocation = adUseClient
        .LockType = adLockOptimistic
        .CursorType = adOpenStatic
        .Open
    End With
    
    With vsAdvice
        For i = .FixedRows To .Rows - 1
            If Val(.TextMatrix(i, COL_◊¥Ã¨)) = 1 And InStr(",5,6,7,", "," & .TextMatrix(i, COL_¿‡±) & ",") > 0 And lng“Ω÷ˆID <> Val(.TextMatrix(i, COL_œ‡πÿID)) Then
                lng“Ω÷ˆID = Val(.TextMatrix(i, COL_œ‡πÿID))
                rsRecipe.AddNew
                rsRecipe!“Ω÷ˆID = Val(.TextMatrix(i, COL_œ‡πÿID))
                rsRecipe!RecipeNo = Val(.TextMatrix(i, COL_¥¶∑Ω–Ú∫≈))
                rsRecipe!Tag = IIF(Val(.TextMatrix(i, COL_¥¶∑Ω–Ú∫≈)) = 0, 2, 1)
                rsRecipe!Type = IIF(InStr(",5,6,", "," & .TextMatrix(i, COL_¿‡±) & ",") > 0, 1, 2)
            End If
        Next
        If rsRecipe.RecordCount > 0 Then rsRecipe.UpdateBatch
        'Œ˜“©÷–≥…“©¥¶∑Ω–Ú∫≈
        rsRecipe.Filter = "Type = 1"
        lngSumCount = rsRecipe.RecordCount
        If lngSumCount > 0 Then
            rsRecipe.Filter = "Type = 1 And RecipeNo = 0"
            lngCount = rsRecipe.RecordCount
        End If
        If lngSumCount = lngCount And lngCount > 0 Then
            For i = 1 To rsRecipe.RecordCount
                If i Mod lngRecipeCount = 1 Then
                    lngNo = GetRecipeNo()
                End If
                rsRecipe!RecipeNo = lngNo
                rsRecipe.MoveNext
            Next
        ElseIf lngCount > 0 And lngSumCount - lngCount > 0 Then
            rsRecipe.Filter = "Type = 1 And RecipeNo > 0"
            rsRecipe.Sort = "RecipeNo"
            '±È¿˙ªÒ»°¥¶∑Ω–Ú∫≈º∞–Ë“™–¬ÃÌº”µΩ∏√¥¶∑Ω–Ú∫≈µƒ“Ω÷ˆÃı ˝
            lngTemp = 0: lngNo = 0
            For i = 1 To rsRecipe.RecordCount
                If lngNo <> rsRecipe!RecipeNo Then
                    If lngTemp > 0 Then Exit For
                    lngNo = rsRecipe!RecipeNo
                    lngTemp = lngRecipeCount
                End If
                If lngNo = rsRecipe!RecipeNo Then lngTemp = lngTemp - 1
                rsRecipe.MoveNext
            Next
            rsRecipe.Filter = "Type = 1 And RecipeNo = 0"
            rsRecipe.Sort = ""
            For i = 1 To rsRecipe.RecordCount
                If i <= lngTemp Then
                    rsRecipe!RecipeNo = lngNo
                Else
                    Exit For
                End If
                rsRecipe.MoveNext
            Next
            '–Ë“™–¬≤˙…˙¥¶∑Ω–Ú∫≈
            rsRecipe.Filter = "Type = 1 And RecipeNo = 0"
            For i = 1 To rsRecipe.RecordCount
                If i Mod lngRecipeCount = 1 Then lngNo = GetRecipeNo()
                rsRecipe!RecipeNo = lngNo
                rsRecipe.MoveNext
            Next
        End If
        
        '÷–“©“˚∆¨…˙≥…¥¶∑Ω–Ú∫≈
        rsRecipe.Filter = "Type = 2"
        lngSumCount = rsRecipe.RecordCount
        If lngSumCount > 0 Then
            rsRecipe.Filter = "Type = 2 And RecipeNo = 0"
            lngCount = rsRecipe.RecordCount
        End If
        If lngSumCount = lngCount And lngCount > 0 Then
            lngNo = GetRecipeNo()
            For i = 1 To rsRecipe.RecordCount
                rsRecipe!RecipeNo = lngNo
                rsRecipe.MoveNext
            Next
        ElseIf lngCount > 0 And lngSumCount - lngCount > 0 Then
            rsRecipe.Filter = "Type = 2 And RecipeNo > 0"
            If Not rsRecipe.EOF Then lngNo = rsRecipe!RecipeNo
            rsRecipe.Filter = "Type = 2 And RecipeNo = 0"
            For i = 1 To rsRecipe.RecordCount
                rsRecipe!RecipeNo = lngNo
                rsRecipe.MoveNext
            Next
        End If
        rsRecipe.Filter = "Tag=2"
        rsRecipe.Sort = ""
        'Ω´¥¶∑Ω–Ú∫≈◊∑º”µΩ±Ì∏Ò
        For i = 1 To rsRecipe.RecordCount
            lng“Ω÷ˆID = rsRecipe!“Ω÷ˆID
            lngCount = .FindRow(lng“Ω÷ˆID, , COL_œ‡πÿID)
            If lngCount <> -1 Then
                For j = lngCount To .Rows - 1
                    If Val(.TextMatrix(j, COL_œ‡πÿID)) = lng“Ω÷ˆID Or CLng(.RowData(j)) = lng“Ω÷ˆID Then
                        .TextMatrix(j, COL_¥¶∑Ω–Ú∫≈) = rsRecipe!RecipeNo & ""
                    Else
                        Exit For
                    End If
                Next
            End If
            rsRecipe.MoveNext
        Next
    End With
End Sub

Private Function GetRecipeNo() As Long
'π¶ƒ‹:ªÒ»°¥¶∑Ω–Ú∫≈
    Dim strSQL As String
    Dim rsTmp As ADODB.Recordset
    
    On Error GoTo errH
    
    strSQL = "Select ≤°»À“Ω÷ˆº«¬º_¥¶∑Ω–Ú∫≈.Nextval as ¥¶∑Ω–Ú∫≈ From Dual"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption)
    GetRecipeNo = Val(rsTmp!¥¶∑Ω–Ú∫≈)
    Exit Function
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Function

Private Sub ReadMsg()
'π¶ƒ‹£∫œ˚œ¢‘ƒ∂¡ ƒø«∞‘› ±¥¶¿ÌZLHIS_BLOOD_004œ˚œ¢
    Dim strSQL As String
    Dim rsTmp As ADODB.Recordset
    On Error GoTo errH
        
    strSQL = "select 1 from ≤°»À“Ω÷ˆº«¬º a where a.π“∫≈µ•=[1] and a.“Ω÷ˆ◊¥Ã¨=1 and a.’Ô¡∆¿‡±='K' and a.ºÏ≤È∑Ω∑®='1' and a.…Û∫À◊¥Ã¨=1 and rownum<2"
    Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mstrπ“∫≈µ•)
    
    If rsTmp.EOF Then '√ª”–’‚¿‡ ˝æ›¡À£¨Ω´œ˚œ¢…ËŒ™“—‘ƒ
        strSQL = "select 1 from “µŒÒœ˚œ¢«Âµ• a where a.≤°»Àid=[1] and a.æÕ’Ôid=[2] and a.¿‡–Õ±‡¬Î='ZLHIS_BLOOD_004' and nvl(a. «∑Ò“—‘ƒ,0)=0"
        Set rsTmp = zlDatabase.OpenSQLRecord(strSQL, Me.Caption, mlng≤°»ÀID, mlngπ“∫≈ID)
        If Not rsTmp.EOF Then
            strSQL = "Zl_“µŒÒœ˚œ¢«Âµ•_Read(" & mlng≤°»ÀID & "," & mlngπ“∫≈ID & ",'ZLHIS_BLOOD_004',1,'" & UserInfo.–’√˚ & "'," & mlng≤°»Àø∆ “id & ")"
            Call zlDatabase.ExecuteProcedure(strSQL, Me.Caption)
        End If
    End If
        
    Exit Sub
errH:
    If ErrCenter() = 1 Then
        Resume
    End If
    Call SaveErrLog
End Sub
